<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent SEO v3 - Digital Synlighedsanalyse</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f7;
      min-height: 100vh;
    }
    @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes scanVertical { 0% { top: 10%; } 50% { top: 80%; } 100% { top: 10%; } }
    @keyframes scanHorizontal { 0% { left: 5%; } 50% { left: 90%; } 100% { left: 5%; } }
    @keyframes floatUp { 0% { opacity: 0.8; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(0.5); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes pulseGlow { 0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); } 50% { box-shadow: 0 0 15px 3px rgba(102, 126, 234, 0.3); } }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

    /* Findings Feed Styles */
    .findings-feed { display: flex; flex-direction: column; gap: 16px; }
    .module-status-bar { display: flex; flex-wrap: wrap; gap: 6px; padding: 12px 16px; background: #f9fafb; border-radius: 8px; margin-bottom: 16px; }
    .module-indicator { display: flex; align-items: center; gap: 5px; padding: 5px 10px; border-radius: 6px; font-size: 12px; background: white; border: 1px solid #e5e7eb; transition: all 0.2s; color: #6b7280; }
    .module-indicator--running { border-color: #015bf8; color: #015bf8; background: #f0f7ff; }
    .module-indicator--completed { border-color: #d1fae5; color: #059669; background: white; }
    .module-indicator--error { border-color: #fecaca; color: #dc2626; background: white; }
    .module-indicator__count { background: #f3f4f6; padding: 1px 5px; border-radius: 4px; font-size: 10px; font-weight: 500; margin-left: 2px; }
    .findings-stream { max-height: 450px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding-right: 8px; }
    .findings-stream::-webkit-scrollbar { width: 6px; }
    .findings-stream::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
    .findings-stream::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
    .finding-card { padding: 16px; border-radius: 8px; background: white; border: 1px solid #e5e7eb; transition: all 0.2s; }
    .finding-card:hover { border-color: #d1d5db; }
    .finding-card--highlighted { animation: slideInRight 0.3s ease; }
    .finding-card__header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .finding-card__module { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; font-weight: 500; }
    .finding-card__title { font-weight: 500; color: #1a1a1a; margin-bottom: 4px; font-size: 14px; }
    .finding-card__description { font-size: 13px; color: #6b7280; line-height: 1.5; }
    .finding-card__footer { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; font-size: 11px; padding-top: 12px; border-top: 1px solid #f3f4f6; }
    .finding-card__source { color: #9ca3af; }
    .confidence-badge { font-size: 11px; font-weight: 400; color: #6b7280; }
    .confidence-confirmed { color: #059669; }
    .confidence-indicator { color: #6b7280; }
    .confidence-not_found { color: #9ca3af; }

    /* Search Page Styles */
    .search-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .search-box {
      width: 100%;
      max-width: 600px;
      background: white;
      border-radius: 20px;
      padding: 48px;
      box-shadow: 0 25px 80px rgba(0,0,0,0.2);
    }
    .search-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
      color: #1a1a1a;
      text-align: center;
    }
    .search-subtitle {
      font-size: 16px;
      color: #6b7280;
      margin-bottom: 32px;
      text-align: center;
    }
    .search-input-wrapper {
      position: relative;
      margin-bottom: 16px;
    }
    .search-input {
      width: 100%;
      padding: 18px 24px;
      font-size: 16px;
      border: 2px solid #e5e5e5;
      border-radius: 12px;
      outline: none;
      transition: all 0.2s;
    }
    .search-input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }
    .search-button {
      width: 100%;
      padding: 18px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .search-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    .search-button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .search-results {
      margin-top: 16px;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      overflow: hidden;
      max-height: 300px;
      overflow-y: auto;
    }
    .search-result-item {
      padding: 16px 20px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.15s;
    }
    .search-result-item:last-child {
      border-bottom: none;
    }
    .search-result-item:hover {
      background: #f9fafb;
    }
    .search-result-name {
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 4px;
    }
    .search-result-address {
      font-size: 14px;
      color: #6b7280;
    }
    .search-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      gap: 8px;
      color: #6b7280;
    }
    .search-error {
      padding: 16px;
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 12px;
      color: #dc2626;
      font-size: 14px;
      margin-top: 16px;
    }

    /* Signal Status Colors */
    .status-excellent { color: #059669; background: #d1fae5; }
    .status-good { color: #2563eb; background: #dbeafe; }
    .status-warning { color: #d97706; background: #fef3c7; }
    .status-critical { color: #dc2626; background: #fee2e2; }

    /* Report Styles */
    .report-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    .report-header {
      text-align: center;
      margin-bottom: 48px;
    }
    .report-card {
      background: white;
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.06);
      animation: slideIn 0.4s ease;
    }
    .report-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #f0f0f0;
    }
    .signal-item {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 12px;
      margin-bottom: 12px;
    }
    .signal-icon {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }
    .signal-content {
      flex: 1;
    }
    .signal-title {
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 4px;
    }
    .signal-description {
      font-size: 14px;
      color: #6b7280;
      line-height: 1.5;
    }
    .signal-impact {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 20px;
      margin-top: 8px;
      display: inline-block;
    }
    .action-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: linear-gradient(135deg, #667eea08 0%, #764ba208 100%);
      border: 1px solid #667eea20;
      border-radius: 10px;
      margin-bottom: 8px;
    }
    .action-priority {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: white;
    }
    .priority-high { background: #dc2626; }
    .priority-medium { background: #d97706; }
    .priority-low { background: #059669; }

    .competitor-row {
      display: grid;
      grid-template-columns: 1fr repeat(4, 100px);
      gap: 16px;
      padding: 16px;
      border-bottom: 1px solid #f0f0f0;
      align-items: center;
    }
    .competitor-row:last-child {
      border-bottom: none;
    }
    .competitor-row.header {
      font-weight: 600;
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .competitor-highlight {
      background: linear-gradient(135deg, #667eea08 0%, #764ba208 100%);
      border-radius: 8px;
    }

    .metric-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    .metric-card {
      padding: 20px;
      background: #f9fafb;
      border-radius: 12px;
      text-align: center;
    }
    .metric-value {
      font-size: 32px;
      font-weight: 700;
      color: #1a1a1a;
    }
    .metric-label {
      font-size: 14px;
      color: #6b7280;
      margin-top: 4px;
    }
    .metric-change {
      font-size: 12px;
      margin-top: 8px;
      padding: 4px 8px;
      border-radius: 12px;
      display: inline-block;
    }
    .metric-positive { background: #d1fae5; color: #059669; }
    .metric-negative { background: #fee2e2; color: #dc2626; }
    .metric-neutral { background: #f3f4f6; color: #6b7280; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef, useMemo } = React;

    // =============================================================================
    // CONFIGURATION
    // =============================================================================
    const API_CONFIG = {
      retryAttempts: 3,
      retryDelay: 1000,
      timeout: 30000,
    };

    // =============================================================================
    // UTILITY FUNCTIONS
    // =============================================================================
    const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    const calculateSignalStrength = (value, thresholds) => {
      if (value >= thresholds.excellent) return 'excellent';
      if (value >= thresholds.good) return 'good';
      if (value >= thresholds.warning) return 'warning';
      return 'critical';
    };

    const formatNumber = (num) => {
      if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
      return num.toString();
    };

    // =============================================================================
    // V3 BACKEND SCAN API (server-side, no API keys exposed)
    // =============================================================================
    const scanWithV3Backend = async (business) => {
      const response = await fetch('/api/seo/scan-v3', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          business: {
            name: business.name || '',
            place_id: business.place_id || '',
            address: business.address || '',
            website: business.website || ''
          },
          locale: 'da-DK',
          country: 'dk'
        })
      });
      if (!response.ok) {
        const text = await response.text();
        throw new Error(text || 'Scan endpoint fejl (' + response.status + ')');
      }
      return response.json();
    };

    // Stub: old client-side Serper calls removed – v3 backend handles everything server-side
    const fetchSerperAPI = async () => ({ places: [], organic: [], images: [] });

    // Transform v3 API response to the display format expected by report components
    const transformV3ToDisplayFormat = (v3) => {
      const raw = v3.rawData || {};
      const gbp = raw.gbp || {};
      const rev = raw.reviews || {};
      const comp = raw.competitors || {};
      const web = raw.website || {};
      const sn = raw.socialNap || {};

      return {
        googleProfile: {
          name: gbp.name || v3.business?.name || '',
          placeId: gbp.place_id || v3.business?.place_id || '',
          rating: gbp.rating || 0,
          totalReviews: gbp.review_count || gbp.totalReviews || 0,
          address: { full: gbp.address || v3.business?.address || '' },
          phone: gbp.phone || '',
          website: gbp.website || v3.business?.website || '',
          openingHours: gbp.opening_hours ? { isOpen: true, hoursComplete: true } : null,
          photos: { total: gbp.photo_count || 0, ownerPhotos: 0, userPhotos: gbp.photo_count || 0 },
          profileCompleteness: { score: gbp.completeness_score || (v3.score?.breakdown?.gbp || 50), missing: gbp.missing_fields || [] },
          lastUpdated: gbp.last_updated || new Date().toISOString(),
          claimed: gbp.claimed !== false,
          types: gbp.types || ['restaurant'],
          attributes: gbp.attributes || {},
        },
        reviews: {
          totalReviews: rev.total_reviews || gbp.review_count || 0,
          averageRating: rev.average_rating || gbp.rating || 0,
          sentiment: {
            positive: rev.sentiment?.positive || 70,
            neutral: rev.sentiment?.neutral || 20,
            negative: rev.sentiment?.negative || 10,
          },
          velocity: {
            monthlyAverage: rev.velocity?.monthly_avg || 3,
            trend: rev.velocity?.trend || 'stable',
          },
          responseMetrics: {
            responseRate: rev.response_rate || 0,
            avgResponseTime: rev.avg_response_time || 'N/A',
          },
          topics: rev.topics || [],
          recentReviews: rev.recent_reviews || [],
          dataSource: 'v3_backend',
          confidence: 'confirmed',
        },
        competitors: {
          ranking: { overall: comp.ranking || comp.position || 0 },
          competitors: (comp.top_competitors || comp.competitors || []).map(c => ({
            name: c.name || '',
            rating: c.rating || 0,
            reviews: c.review_count || c.reviews || 0,
            distance: c.distance || '',
          })),
          insights: (comp.insights || []).map(i => ({
            title: i.title || '',
            description: i.description || '',
            type: i.type || 'info',
            impact: i.impact || '',
          })),
        },
        napConsistency: {
          consistencyScore: sn.nap_score || sn.consistency_score || 50,
          sources: (sn.sources || []).map(s => ({
            name: s.name || s.platform || '',
            found: s.found !== false,
            nameMatch: s.name_match !== false,
            addressMatch: s.address_match !== false,
            phoneMatch: s.phone_match !== false,
          })),
          issues: (sn.issues || []).map(i => ({
            platform: i.platform || '',
            issue: i.issue || i.description || '',
            severity: i.severity || 'medium',
          })),
        },
        website: {
          hasWebsite: !!(web.url || gbp.website || v3.business?.website),
          url: web.url || gbp.website || v3.business?.website || '',
          scores: {
            mobile: web.mobile_score || 0,
            desktop: web.desktop_score || 0,
            seo: web.seo_score || 0,
            performance: web.performance_score || 0,
          },
          coreWebVitals: web.core_web_vitals || {
            LCP: { value: web.lcp || 'N/A', rating: 'needs-improvement', target: '< 2.5s' },
            FID: { value: web.fid || 'N/A', rating: 'good', target: '< 100ms' },
            CLS: { value: web.cls || 'N/A', rating: 'good', target: '< 0.1' },
          },
          localSEO: {
            hasSchemaMarkup: web.has_schema || false,
            hasLocalBusinessSchema: web.has_local_business_schema || false,
            hasOpenGraph: web.has_open_graph || false,
            hasContactPage: web.has_contact || false,
            hasEmbeddedMap: web.has_map || false,
            mobileResponsive: web.mobile_responsive || false,
          },
          issues: (web.issues || []).map(i => ({
            issue: i.issue || i.title || '',
            impact: i.impact || i.description || '',
            severity: i.severity || 'medium',
          })),
          recommendation: web.recommendation || 'Opret en hjemmeside for at forbedre din online synlighed.',
        },
        social: {
          overallScore: sn.social_score || 30,
          platforms: (sn.social_platforms || []).map(p => ({
            name: p.name || '',
            found: p.found !== false,
            followers: p.followers || 0,
            posts30Days: p.posts_30d || 0,
            engagement: p.engagement || 0,
            status: p.status || (p.found ? 'active' : 'not_found'),
          })),
          insights: (sn.social_insights || []).map(i => ({
            text: i.text || i.description || '',
            type: i.type || 'info',
          })),
        },
        images: {
          totalPhotos: gbp.photo_count || 0,
          googleMapsPhotos: gbp.photo_count || 0,
        },
        // Pass through v3-specific data
        _v3score: v3.score,
        _v3findings: v3.findings || [],
        _v3actionPlan: v3.actionPlan || {},
        _v3moduleStatuses: v3.moduleStatuses || [],
      };
    };

    // =============================================================================
    // ENHANCED API SERVICE - Faktisk Datahentning
    // =============================================================================
    const AnalysisService = {
      // Søg efter virksomheder via backend API
      async searchBusiness(query) {
        try {
          const response = await fetch(`/api/places/search?query=${encodeURIComponent(query)}`);
          if (!response.ok) throw new Error('Search failed');
          const data = await response.json();
          return data.results || [];
        } catch (error) {
          console.error('Search error:', error);
          throw error;
        }
      },

      // Hent Google Business Profile data
      async getGoogleBusinessProfile(placeId, businessName) {
        try {
          // Forsøg at hente fra backend API
          const response = await fetch(`/api/places/details?place_id=${encodeURIComponent(placeId)}`);
          if (response.ok) {
            const data = await response.json();
            return this.parseGoogleBusinessData(data);
          }
        } catch (error) {
          console.log('Using enhanced mock data for demo');
        }

        // Demo data med realistiske signaler
        await delay(2000);
        return {
          name: businessName,
          placeId: placeId,
          rating: 4.2,
          totalReviews: 127,
          priceLevel: 2,
          types: ['restaurant', 'food', 'point_of_interest', 'establishment'],
          address: {
            full: 'Vestergade 12, 8000 Aarhus C',
            street: 'Vestergade 12',
            city: 'Aarhus C',
            postalCode: '8000',
          },
          phone: '+45 86 12 34 56',
          website: 'https://example-restaurant.dk',
          openingHours: {
            isOpen: true,
            periods: [
              { day: 'Mandag', hours: '11:00 - 22:00' },
              { day: 'Tirsdag', hours: '11:00 - 22:00' },
              { day: 'Onsdag', hours: '11:00 - 22:00' },
              { day: 'Torsdag', hours: '11:00 - 22:00' },
              { day: 'Fredag', hours: '11:00 - 23:00' },
              { day: 'Lørdag', hours: '11:00 - 23:00' },
              { day: 'Søndag', hours: '12:00 - 21:00' },
            ],
            hoursComplete: true,
          },
          photos: {
            total: 45,
            ownerPhotos: 12,
            userPhotos: 33,
            hasLogo: true,
            hasCoverPhoto: true,
            hasMenuPhotos: false,
            hasInteriorPhotos: true,
            hasExteriorPhotos: true,
            hasFoodPhotos: true,
          },
          attributes: {
            hasReservations: true,
            hasDelivery: false,
            hasTakeout: true,
            hasWifi: true,
            hasParking: false,
            wheelchairAccessible: true,
          },
          profileCompleteness: {
            score: 72,
            missing: ['Menu link', 'Udvidet beskrivelse', 'Specialtilbud', 'COVID-info opdateret'],
          },
          lastUpdated: new Date(Date.now() - 45 * 24 * 60 * 60 * 1000).toISOString(),
          postsActivity: {
            lastPost: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
            postsLast90Days: 2,
          },
          qAndA: {
            totalQuestions: 8,
            answeredByOwner: 3,
            unanswered: 2,
          },
        };
      },

      parseGoogleBusinessData(data) {
        // Parse faktiske Google Places API data
        return {
          name: data.name,
          placeId: data.place_id,
          rating: data.rating || 0,
          totalReviews: data.user_ratings_total || 0,
          priceLevel: data.price_level,
          types: data.types || [],
          address: {
            full: data.formatted_address,
            street: data.address_components?.find(c => c.types.includes('route'))?.long_name,
            city: data.address_components?.find(c => c.types.includes('locality'))?.long_name,
            postalCode: data.address_components?.find(c => c.types.includes('postal_code'))?.long_name,
          },
          phone: data.formatted_phone_number,
          website: data.website,
          openingHours: data.opening_hours ? {
            isOpen: data.opening_hours.open_now,
            periods: data.opening_hours.weekday_text?.map((text, i) => ({
              day: ['Søndag', 'Mandag', 'Tirsdag', 'Onsdag', 'Torsdag', 'Fredag', 'Lørdag'][i],
              hours: text.split(': ')[1] || 'Lukket',
            })),
            hoursComplete: !!data.opening_hours.weekday_text,
          } : null,
          photos: {
            total: data.photos?.length || 0,
            ownerPhotos: 0,
            userPhotos: data.photos?.length || 0,
          },
        };
      },

      // Hent og analyser anmeldelser
      async getReviewAnalysis(placeId, businessName) {
        // Try Serper Reviews API first
        try {
          console.log('Fetching reviews from Serper API for:', businessName);
          const serperData = await fetchSerperAPI('reviews', businessName);

          if (serperData?.reviews && serperData.reviews.length > 0) {
            console.log('Serper Reviews API returned', serperData.reviews.length, 'reviews');
            const parsedReviews = this.parseSerperReviews(serperData.reviews);
            const analysis = this.analyzeReviews(parsedReviews);
            analysis.dataSource = 'serper_reviews';
            analysis.confidence = 'confirmed';
            return analysis;
          }
        } catch (error) {
          console.log('Serper Reviews API failed, trying backend API:', error.message);
        }

        // Fallback to backend API
        try {
          const response = await fetch(`/api/places/reviews?place_id=${encodeURIComponent(placeId)}`);
          if (response.ok) {
            const data = await response.json();
            return this.analyzeReviews(data.reviews);
          }
        } catch (error) {
          console.log('Backend API failed, using mock data:', error.message);
        }

        // Final fallback to mock data
        await delay(3000);
        const reviews = this.generateRealisticReviewData(businessName);
        const analysis = this.analyzeReviews(reviews);
        analysis.dataSource = 'demo_data';
        analysis.confidence = 'indicator';
        return analysis;
      },

      // Parse Serper reviews to our format
      parseSerperReviews(serperReviews) {
        return serperReviews.map((review, index) => {
          const parsedDate = this.parseRelativeDate(review.date);
          return {
            rating: review.rating || 5,
            time: parsedDate.toISOString(),
            text: review.snippet || review.title || '',
            authorName: review.source || `Bruger ${index + 1}`,
            hasOwnerResponse: false,
            responseTime: null,
            source: review.source,
            link: review.link
          };
        });
      },

      // Parse relative dates like "2 months ago"
      parseRelativeDate(dateString) {
        if (!dateString) return new Date();

        const now = new Date();
        const lower = dateString.toLowerCase();

        const match = lower.match(/(\d+)\s*(day|week|month|year)s?\s*ago/i);
        if (match) {
          const amount = parseInt(match[1], 10);
          const unit = match[2].toLowerCase();

          switch (unit) {
            case 'day':
              now.setDate(now.getDate() - amount);
              break;
            case 'week':
              now.setDate(now.getDate() - amount * 7);
              break;
            case 'month':
              now.setMonth(now.getMonth() - amount);
              break;
            case 'year':
              now.setFullYear(now.getFullYear() - amount);
              break;
          }
          return now;
        }

        const parsed = new Date(dateString);
        return isNaN(parsed.getTime()) ? new Date() : parsed;
      },

      generateRealisticReviewData(businessName) {
        // Generer realistiske anmeldelsesdata til demo
        const now = Date.now();
        const reviews = [];

        // Simuler 127 anmeldelser over 2 år
        for (let i = 0; i < 127; i++) {
          const daysAgo = Math.floor(Math.random() * 730);
          const rating = this.weightedRandom([
            { value: 5, weight: 45 },
            { value: 4, weight: 28 },
            { value: 3, weight: 15 },
            { value: 2, weight: 7 },
            { value: 1, weight: 5 },
          ]);

          reviews.push({
            rating,
            time: new Date(now - daysAgo * 24 * 60 * 60 * 1000).toISOString(),
            text: this.generateReviewText(rating),
            authorName: `Bruger ${i + 1}`,
            hasOwnerResponse: Math.random() < 0.35,
            responseTime: Math.random() < 0.5 ? Math.floor(Math.random() * 72) : null,
          });
        }

        return reviews.sort((a, b) => new Date(b.time) - new Date(a.time));
      },

      weightedRandom(options) {
        const totalWeight = options.reduce((sum, opt) => sum + opt.weight, 0);
        let random = Math.random() * totalWeight;
        for (const option of options) {
          random -= option.weight;
          if (random <= 0) return option.value;
        }
        return options[0].value;
      },

      generateReviewText(rating) {
        const positiveKeywords = ['god mad', 'fantastisk service', 'hyggelig atmosfære', 'lækker', 'anbefales', 'dejligt sted', 'venligt personale'];
        const negativeKeywords = ['lang ventetid', 'for dyrt', 'skuffende', 'kedelig', 'støjende', 'koldt'];
        const neutralKeywords = ['ok', 'fint nok', 'almindeligt', 'standard'];

        if (rating >= 4) return positiveKeywords[Math.floor(Math.random() * positiveKeywords.length)];
        if (rating <= 2) return negativeKeywords[Math.floor(Math.random() * negativeKeywords.length)];
        return neutralKeywords[Math.floor(Math.random() * neutralKeywords.length)];
      },

      analyzeReviews(reviews) {
        const now = Date.now();
        const thirtyDaysAgo = now - 30 * 24 * 60 * 60 * 1000;
        const ninetyDaysAgo = now - 90 * 24 * 60 * 60 * 1000;
        const oneYearAgo = now - 365 * 24 * 60 * 60 * 1000;

        // Rating distribution
        const distribution = [0, 0, 0, 0, 0];
        reviews.forEach(r => distribution[r.rating - 1]++);

        // Tidsmæssig analyse
        const last30Days = reviews.filter(r => new Date(r.time) > thirtyDaysAgo);
        const last90Days = reviews.filter(r => new Date(r.time) > ninetyDaysAgo);
        const lastYear = reviews.filter(r => new Date(r.time) > oneYearAgo);

        // Beregn velocity (anmeldelser per måned)
        const monthlyVelocity = last90Days.length / 3;

        // Gennemsnit over tid
        const avgLast30 = last30Days.length > 0
          ? last30Days.reduce((sum, r) => sum + r.rating, 0) / last30Days.length
          : null;
        const avgLast90 = last90Days.length > 0
          ? last90Days.reduce((sum, r) => sum + r.rating, 0) / last90Days.length
          : null;
        const avgOverall = reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length;

        // Trend beregning
        const trend = avgLast30 && avgLast90
          ? ((avgLast30 - avgLast90) / avgLast90 * 100).toFixed(1)
          : 0;

        // Svarrate
        const reviewsWithText = reviews.filter(r => r.text && r.text.length > 10);
        const respondedReviews = reviews.filter(r => r.hasOwnerResponse);
        const responseRate = reviewsWithText.length > 0
          ? (respondedReviews.length / reviewsWithText.length * 100)
          : 0;

        // Gennemsnitlig svartid
        const avgResponseTime = respondedReviews.filter(r => r.responseTime !== null)
          .reduce((sum, r) => sum + r.responseTime, 0) / respondedReviews.length || 0;

        // Sentiment analyse baseret på nøgleord
        const sentimentKeywords = {
          positive: ['fantastisk', 'god', 'lækker', 'anbefales', 'dejlig', 'venlig', 'hyggelig', 'perfekt'],
          negative: ['skuffende', 'dårlig', 'lang ventetid', 'kedelig', 'for dyrt', 'koldt', 'uhøflig'],
        };

        let positiveCount = 0;
        let negativeCount = 0;
        const keywordCounts = {};

        reviews.forEach(r => {
          if (!r.text) return;
          const text = r.text.toLowerCase();

          sentimentKeywords.positive.forEach(kw => {
            if (text.includes(kw)) {
              positiveCount++;
              keywordCounts[kw] = (keywordCounts[kw] || 0) + 1;
            }
          });
          sentimentKeywords.negative.forEach(kw => {
            if (text.includes(kw)) {
              negativeCount++;
              keywordCounts[kw] = (keywordCounts[kw] || 0) + 1;
            }
          });
        });

        // Top keywords
        const topKeywords = Object.entries(keywordCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 8)
          .map(([term, count]) => ({
            term,
            count,
            sentiment: sentimentKeywords.positive.includes(term) ? 'positive' : 'negative',
          }));

        // Nyeste anmeldelser til visning
        const recentReviews = reviews.slice(0, 5).map(r => ({
          rating: r.rating,
          text: r.text,
          date: new Date(r.time).toLocaleDateString('da-DK'),
          hasResponse: r.hasOwnerResponse,
        }));

        return {
          totalReviews: reviews.length,
          averageRating: avgOverall.toFixed(1),
          distribution: distribution.map((count, i) => ({
            stars: i + 1,
            count,
            percentage: Math.round(count / reviews.length * 100),
          })).reverse(),
          velocity: {
            last30Days: last30Days.length,
            last90Days: last90Days.length,
            monthlyAverage: monthlyVelocity.toFixed(1),
            trend: parseFloat(trend),
          },
          ratingTrend: {
            last30Days: avgLast30?.toFixed(2) || 'N/A',
            last90Days: avgLast90?.toFixed(2) || 'N/A',
            overall: avgOverall.toFixed(2),
            direction: trend > 0 ? 'up' : trend < 0 ? 'down' : 'stable',
          },
          responseMetrics: {
            responseRate: responseRate.toFixed(0),
            avgResponseTimeHours: avgResponseTime.toFixed(0),
            totalResponded: respondedReviews.length,
          },
          sentiment: {
            positive: Math.round(positiveCount / (positiveCount + negativeCount + 1) * 100) || 0,
            negative: Math.round(negativeCount / (positiveCount + negativeCount + 1) * 100) || 0,
            neutral: 100 - Math.round(positiveCount / (positiveCount + negativeCount + 1) * 100) - Math.round(negativeCount / (positiveCount + negativeCount + 1) * 100),
          },
          topKeywords,
          recentReviews,
          signals: {
            velocityStatus: calculateSignalStrength(monthlyVelocity, { excellent: 8, good: 4, warning: 2 }),
            responseRateStatus: calculateSignalStrength(responseRate, { excellent: 80, good: 50, warning: 25 }),
            ratingStatus: calculateSignalStrength(avgOverall, { excellent: 4.5, good: 4.0, warning: 3.5 }),
          },
        };
      },

      // Konkurrentanalyse
      async getCompetitorAnalysis(businessName, address, category) {
        await delay(2500);

        // Find virksomhedens lokation for at søge konkurrenter
        const searchArea = address?.city || 'Aarhus';

        return {
          searchRadius: '1 km',
          totalCompetitors: 12,
          directCompetitors: 5,
          competitors: [
            {
              name: businessName,
              isTarget: true,
              rating: 4.2,
              reviews: 127,
              responseRate: 35,
              recentActivity: 'Moderat',
              strengths: ['God rating', 'Mange anmeldelser'],
              weaknesses: ['Lav svarrate', 'Få nye anmeldelser'],
            },
            {
              name: 'Café Smagløs',
              isTarget: false,
              rating: 4.5,
              reviews: 289,
              responseRate: 78,
              recentActivity: 'Høj',
              distance: '120m',
            },
            {
              name: 'Bistro Midtby',
              isTarget: false,
              rating: 4.3,
              reviews: 567,
              responseRate: 92,
              recentActivity: 'Meget høj',
              distance: '350m',
            },
            {
              name: 'Den Grønne Gaffel',
              isTarget: false,
              rating: 4.0,
              reviews: 89,
              responseRate: 45,
              recentActivity: 'Lav',
              distance: '500m',
            },
            {
              name: 'Restaurant Aroma',
              isTarget: false,
              rating: 4.6,
              reviews: 412,
              responseRate: 85,
              recentActivity: 'Høj',
              distance: '650m',
            },
          ],
          ranking: {
            byRating: 3,
            byReviews: 3,
            byResponseRate: 5,
            overall: 4,
          },
          insights: [
            {
              type: 'warning',
              title: 'Lavere svarrate end konkurrenter',
              description: 'Din svarrate på 35% ligger under gennemsnittet på 75% for de nærmeste konkurrenter. Dette påvirker din troværdighed negativt.',
              impact: 'Moderat negativ påvirkning på ranking',
            },
            {
              type: 'opportunity',
              title: 'Potentiale for flere anmeldelser',
              description: 'Konkurrenter med lignende størrelse har 2-4x flere anmeldelser. Aktiv opfordring til anmeldelser kan forbedre synligheden.',
              impact: 'Høj positiv påvirkning på ranking',
            },
            {
              type: 'strength',
              title: 'Konkurrencedygtig rating',
              description: 'Din rating på 4.2 er tæt på områdets gennemsnit på 4.3. Vedligehold kvaliteten for at bevare positionen.',
              impact: 'Neutral',
            },
          ],
        };
      },

      // NAP Konsistens Check
      async checkNAPConsistency(businessName, address, phone) {
        await delay(2000);

        return {
          sources: [
            { name: 'Google Business', found: true, nameMatch: true, addressMatch: true, phoneMatch: true },
            { name: 'Facebook', found: true, nameMatch: true, addressMatch: true, phoneMatch: false },
            { name: 'Krak.dk', found: true, nameMatch: true, addressMatch: false, phoneMatch: true },
            { name: 'De Gule Sider', found: true, nameMatch: false, addressMatch: true, phoneMatch: true },
            { name: 'Yelp', found: false, nameMatch: false, addressMatch: false, phoneMatch: false },
            { name: 'TripAdvisor', found: true, nameMatch: true, addressMatch: true, phoneMatch: true },
            { name: 'Trustpilot', found: false, nameMatch: false, addressMatch: false, phoneMatch: false },
          ],
          consistencyScore: 68,
          issues: [
            { platform: 'Facebook', issue: 'Telefonnummer mangler eller er forkert', severity: 'medium' },
            { platform: 'Krak.dk', issue: 'Adresse er ikke opdateret', severity: 'high' },
            { platform: 'De Gule Sider', issue: 'Virksomhedsnavn staves forskelligt', severity: 'medium' },
            { platform: 'Yelp', issue: 'Ingen profil oprettet', severity: 'low' },
            { platform: 'Trustpilot', issue: 'Ingen profil oprettet', severity: 'low' },
          ],
          recommendations: [
            'Opdater telefonnummer på Facebook til det officielle nummer',
            'Ret adressen på Krak.dk til den aktuelle adresse',
            'Ensret virksomhedsnavnet på alle platforme',
            'Overvej at oprette profiler på Yelp og Trustpilot for bredere synlighed',
          ],
        };
      },

      // Website & Mobil Analyse
      async analyzeWebsite(websiteUrl) {
        await delay(3500);

        if (!websiteUrl) {
          return {
            hasWebsite: false,
            recommendation: 'Ingen hjemmeside registreret. En hjemmeside styrker din troværdighed og giver Google flere signaler om din virksomhed.',
          };
        }

        return {
          hasWebsite: true,
          url: websiteUrl,
          scores: {
            mobile: 67,
            desktop: 82,
            performance: 58,
            accessibility: 74,
            bestPractices: 81,
            seo: 69,
          },
          coreWebVitals: {
            LCP: { value: '2.8s', rating: 'needs-improvement', target: '< 2.5s' },
            FID: { value: '120ms', rating: 'good', target: '< 100ms' },
            CLS: { value: '0.18', rating: 'needs-improvement', target: '< 0.1' },
          },
          localSEO: {
            hasSchemaMarkup: false,
            hasLocalBusinessSchema: false,
            hasOpenGraph: true,
            hasContactPage: true,
            hasEmbeddedMap: false,
            mobileResponsive: true,
          },
          issues: [
            { severity: 'high', issue: 'Manglende LocalBusiness Schema markup', impact: 'Reducerer synlighed i lokale søgeresultater' },
            { severity: 'high', issue: 'Langsom indlæsning på mobil (LCP > 2.5s)', impact: 'Påvirker brugeroplevelse og ranking negativt' },
            { severity: 'medium', issue: 'Højt Cumulative Layout Shift', impact: 'Dårlig brugeroplevelse under indlæsning' },
            { severity: 'medium', issue: 'Ingen indlejret Google Maps', impact: 'Gør det sværere for kunder at finde jer' },
          ],
        };
      },

      // Social Media Analyse
      async analyzeSocialPresence(businessName) {
        await delay(2500);

        return {
          platforms: [
            {
              name: 'Facebook',
              found: true,
              followers: 2340,
              posts30Days: 4,
              engagement: 2.8,
              lastPost: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
              rating: 4.4,
              reviews: 89,
              status: 'active',
            },
            {
              name: 'Instagram',
              found: true,
              followers: 1890,
              posts30Days: 8,
              engagement: 4.2,
              lastPost: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
              status: 'very_active',
            },
            {
              name: 'TikTok',
              found: false,
              status: 'not_found',
            },
            {
              name: 'LinkedIn',
              found: false,
              status: 'not_found',
            },
          ],
          overallScore: 58,
          insights: [
            {
              type: 'positive',
              text: 'Aktiv på Instagram med god engagement rate (4.2%)',
            },
            {
              type: 'warning',
              text: 'Facebook engagement er under gennemsnittet (2.8% vs 3.5% benchmark)',
            },
            {
              type: 'opportunity',
              text: 'TikTok er ikke opsat - stor mulighed for at nå yngre målgrupper',
            },
          ],
          recommendations: [
            'Øg postfrekvensen på Facebook til mindst 3 gange om ugen',
            'Overvej TikTok for at nå et yngre publikum',
            'Brug konsistent branding på tværs af alle platforme',
          ],
        };
      },

      // SERP Synlighedsanalyse
      async getSERPVisibility(businessName, address, category) {
        const searchArea = address?.city || 'Aarhus';

        try {
          console.log('Fetching SERP visibility from Serper Maps API for:', businessName);

          // Perform three searches in parallel using Serper Maps API
          const [directSearchData, categorySearchData, localSearchData] = await Promise.all([
            fetchSerperAPI('maps', `${businessName} ${searchArea}`),
            fetchSerperAPI('maps', `${category} ${searchArea}`),
            fetchSerperAPI('maps', `${category} i nærheden af ${searchArea}`)
          ]);

          // Parse direct search results
          const directSearch = this.parseMapSearchResult(directSearchData, businessName, 'direct');

          // Parse category search results
          const categorySearch = this.parseMapSearchResult(categorySearchData, businessName, 'category');

          // Parse local intent search results
          const localIntentSearch = this.parseMapSearchResult(localSearchData, businessName, 'local');

          // Calculate visibility score
          const visibilityScore = this.calculateVisibilityScore(directSearch, categorySearch, localIntentSearch);

          // Generate findings based on real data
          const findings = this.generateSERPFindings(directSearch, categorySearch, localIntentSearch, businessName);

          console.log('Serper Maps API returned visibility score:', visibilityScore);

          return {
            directSearch: {
              query: `${businessName} ${searchArea}`,
              rank: directSearch.rank,
              inLocalPack: directSearch.inLocalPack,
              knowledgePanel: directSearch.rank === 1,
              confidence: directSearch.found ? 'confirmed' : 'not_found',
            },
            categorySearch: {
              query: `${category} ${searchArea}`,
              rank: categorySearch.rank,
              inLocalPack: categorySearch.inLocalPack,
              totalResults: categorySearchData?.places?.length || 0,
              confidence: categorySearch.found ? 'confirmed' : 'indicator',
            },
            localIntentSearch: {
              query: `${category} i nærheden`,
              rank: localIntentSearch.rank,
              inLocalPack: localIntentSearch.inLocalPack,
              confidence: localIntentSearch.found ? 'confirmed' : 'indicator',
            },
            searchFeatures: this.extractSearchFeatures(directSearchData),
            missingFeatures: this.identifyMissingFeatures(directSearchData),
            estimatedMonthlySearches: {
              brandTerms: 320,
              categoryTerms: 4800,
            },
            visibility: {
              score: visibilityScore,
              status: calculateSignalStrength(visibilityScore, { excellent: 80, good: 60, warning: 40 }),
            },
            findings,
            dataSource: 'serper_maps',
            confidence: 'confirmed',
          };
        } catch (error) {
          console.log('Serper Maps API failed, using mock data:', error.message);

          // Fallback to mock data
          await delay(2500);
          return {
            directSearch: {
              query: `${businessName} ${searchArea}`,
              rank: 1,
              inLocalPack: true,
              knowledgePanel: true,
              confidence: 'indicator',
            },
            categorySearch: {
              query: `${category} ${searchArea}`,
              rank: 8,
              inLocalPack: false,
              totalResults: 47,
              confidence: 'indicator',
            },
            localIntentSearch: {
              query: `${category} i nærheden`,
              rank: 12,
              inLocalPack: false,
              confidence: 'indicator',
            },
            searchFeatures: ['reviews', 'hours', 'phone', 'website', 'directions'],
            missingFeatures: ['menu', 'booking', 'popular_times'],
            estimatedMonthlySearches: {
              brandTerms: 320,
              categoryTerms: 4800,
            },
            visibility: {
              score: 62,
              status: calculateSignalStrength(62, { excellent: 80, good: 60, warning: 40 }),
            },
            findings: [
              { type: 'positive', title: 'God synlighed på brand-søgninger', description: 'Rangerer #1 på direkte søgninger efter virksomhedsnavnet.' },
              { type: 'warning', title: 'Lav synlighed på kategori-søgninger', description: 'Rangerer kun #8 på "restaurant Aarhus" søgninger.' },
              { type: 'opportunity', title: 'Mangler i Local Pack', description: 'Vises ikke i top 3 lokale resultater for kategori-søgninger.' },
            ],
            dataSource: 'demo_data',
            confidence: 'indicator',
          };
        }
      },

      // Helper: Parse Serper Maps search result
      parseMapSearchResult(mapData, businessName, searchType) {
        if (!mapData?.places || mapData.places.length === 0) {
          return { rank: 99, inLocalPack: false, found: false, data: null };
        }

        const normalizedTarget = businessName.toLowerCase().trim();
        let rank = 99;
        let found = false;
        let matchedPlace = null;

        for (let i = 0; i < mapData.places.length; i++) {
          const place = mapData.places[i];
          const normalizedTitle = (place.title || '').toLowerCase().trim();

          if (normalizedTitle === normalizedTarget ||
              normalizedTitle.includes(normalizedTarget) ||
              normalizedTarget.includes(normalizedTitle)) {
            rank = i + 1;
            found = true;
            matchedPlace = place;
            break;
          }
        }

        return {
          rank,
          inLocalPack: rank <= 3,
          found,
          data: matchedPlace,
          totalResults: mapData.places.length
        };
      },

      // Helper: Calculate visibility score
      calculateVisibilityScore(directSearch, categorySearch, localIntentSearch) {
        let score = 0;

        // Direct search (40 points max)
        if (directSearch.found) {
          if (directSearch.rank === 1) score += 40;
          else if (directSearch.rank <= 3) score += 30;
          else if (directSearch.rank <= 5) score += 20;
          else score += 10;
        }

        // Category search (35 points max)
        if (categorySearch.found) {
          if (categorySearch.inLocalPack) score += 35;
          else if (categorySearch.rank <= 5) score += 25;
          else if (categorySearch.rank <= 10) score += 15;
          else score += 5;
        }

        // Local intent search (25 points max)
        if (localIntentSearch.found) {
          if (localIntentSearch.inLocalPack) score += 25;
          else if (localIntentSearch.rank <= 5) score += 18;
          else if (localIntentSearch.rank <= 10) score += 10;
          else score += 5;
        }

        return score;
      },

      // Helper: Extract search features from map data
      extractSearchFeatures(mapData) {
        const features = [];
        if (!mapData?.places?.[0]) return features;

        const firstPlace = mapData.places[0];
        if (firstPlace.rating) features.push('reviews');
        if (firstPlace.phoneNumber) features.push('phone');
        if (firstPlace.website) features.push('website');
        if (firstPlace.address) features.push('directions');
        features.push('hours');

        return features;
      },

      // Helper: Identify missing features
      identifyMissingFeatures(mapData) {
        const missing = [];
        if (!mapData?.places?.[0]) {
          return ['menu', 'booking', 'popular_times', 'reviews', 'phone', 'website'];
        }

        const firstPlace = mapData.places[0];
        if (!firstPlace.rating) missing.push('reviews');
        if (!firstPlace.phoneNumber) missing.push('phone');
        if (!firstPlace.website) missing.push('website');

        missing.push('menu', 'booking', 'popular_times');
        return missing;
      },

      // Helper: Generate SERP findings
      generateSERPFindings(directSearch, categorySearch, localIntentSearch, businessName) {
        const findings = [];

        // Direct search findings
        if (directSearch.found && directSearch.rank === 1) {
          findings.push({
            type: 'positive',
            title: 'Fremragende synlighed på brand-søgninger',
            description: `"${businessName}" rangerer #1 på direkte søgninger. Kunder finder jer nemt.`
          });
        } else if (directSearch.found) {
          findings.push({
            type: 'warning',
            title: 'Kan forbedre brand-synlighed',
            description: `Rangerer #${directSearch.rank} på direkte søgninger. Overvej at optimere Google Business Profile.`
          });
        } else {
          findings.push({
            type: 'critical',
            title: 'Ikke fundet på brand-søgninger',
            description: 'Virksomheden vises ikke i top-resultater for direkte navnesøgninger.'
          });
        }

        // Category search findings
        if (categorySearch.inLocalPack) {
          findings.push({
            type: 'positive',
            title: 'Vises i Local Pack',
            description: `Rangerer #${categorySearch.rank} på kategori-søgninger og vises i top 3 lokale resultater.`
          });
        } else if (categorySearch.found) {
          findings.push({
            type: 'opportunity',
            title: 'Potentiale for Local Pack',
            description: `Rangerer #${categorySearch.rank} på kategori-søgninger. Fokuser på flere anmeldelser for top 3 placering.`
          });
        } else {
          findings.push({
            type: 'warning',
            title: 'Lav kategori-synlighed',
            description: 'Vises ikke i top-resultater for kategori-søgninger i området.'
          });
        }

        // Local intent findings
        if (localIntentSearch.inLocalPack) {
          findings.push({
            type: 'positive',
            title: 'Stærk lokal tilstedeværelse',
            description: 'Vises i top 3 for "i nærheden" søgninger - vigtig for mobil trafik.'
          });
        }

        return findings;
      },

      // Billede Analyse via Serper Images API
      async getBusinessImages(businessName) {
        try {
          console.log('Fetching images from Serper API for:', businessName);
          const serperData = await fetchSerperAPI('images', businessName);

          if (serperData?.images && serperData.images.length > 0) {
            console.log('Serper Images API returned', serperData.images.length, 'images');

            return {
              totalImages: serperData.images.length,
              images: serperData.images.slice(0, 12).map((img, index) => ({
                id: index,
                url: img.imageUrl,
                thumbnailUrl: img.thumbnailUrl,
                title: img.title,
                width: img.imageWidth,
                height: img.imageHeight,
                source: img.source || img.domain,
                sourceUrl: img.link,
                isOwnerImage: false
              })),
              sources: this.categorizeImageSources(serperData.images),
              hasLogo: serperData.images.some(img =>
                (img.title || '').toLowerCase().includes('logo')
              ),
              hasExteriorPhotos: serperData.images.some(img =>
                (img.title || '').toLowerCase().match(/exterior|facade|building|outside|bygning|facade/)
              ),
              hasInteriorPhotos: serperData.images.some(img =>
                (img.title || '').toLowerCase().match(/interior|inside|indendørs/)
              ),
              hasFoodPhotos: serperData.images.some(img =>
                (img.title || '').toLowerCase().match(/food|mad|dish|ret|menu/)
              ),
              dataSource: 'serper_images',
              confidence: 'confirmed',
              findings: this.generateImageFindings(serperData.images, businessName)
            };
          }
        } catch (error) {
          console.log('Serper Images API failed:', error.message);
        }

        // Fallback to mock data
        await delay(1500);
        return {
          totalImages: 0,
          images: [],
          sources: {},
          hasLogo: false,
          hasExteriorPhotos: false,
          hasInteriorPhotos: false,
          hasFoodPhotos: false,
          dataSource: 'demo_data',
          confidence: 'not_found',
          findings: [{
            type: 'warning',
            title: 'Ingen billeder fundet',
            description: 'Kunne ikke hente billeder for denne virksomhed.'
          }]
        };
      },

      // Helper: Categorize image sources
      categorizeImageSources(images) {
        const sources = {};
        images.forEach(img => {
          const domain = img.domain || img.source || 'unknown';
          sources[domain] = (sources[domain] || 0) + 1;
        });
        return sources;
      },

      // Helper: Generate image findings
      generateImageFindings(images, businessName) {
        const findings = [];

        if (images.length >= 10) {
          findings.push({
            type: 'positive',
            title: 'God billedtilstedeværelse online',
            description: `Fundet ${images.length} billeder relateret til "${businessName}" på tværs af forskellige kilder.`
          });
        } else if (images.length > 0) {
          findings.push({
            type: 'opportunity',
            title: 'Potentiale for flere billeder',
            description: `Kun ${images.length} billeder fundet. Overvej at uploade flere billeder til Google Business Profile.`
          });
        } else {
          findings.push({
            type: 'warning',
            title: 'Manglende billedtilstedeværelse',
            description: 'Ingen billeder fundet online. Upload billeder for at øge synlighed og engagement.'
          });
        }

        return findings;
      },

      // Citation Presence Analyse
      async getCitationPresence(businessName, address, phone) {
        await delay(2000);

        const citationSources = [
          { name: 'Krak.dk', priority: 'high', found: true, complete: true, lastUpdated: '2024-11-15' },
          { name: 'De Gule Sider', priority: 'high', found: true, complete: false, issues: ['Mangler åbningstider'] },
          { name: 'Eniro', priority: 'medium', found: true, complete: true, lastUpdated: '2024-09-20' },
          { name: 'Yelp', priority: 'medium', found: false, complete: false },
          { name: 'TripAdvisor', priority: 'high', found: true, complete: true, rating: 4.0, reviews: 45 },
          { name: 'Trustpilot', priority: 'high', found: false, complete: false },
          { name: 'Apple Maps', priority: 'medium', found: true, complete: true },
          { name: 'Bing Places', priority: 'low', found: true, complete: false, issues: ['Forældet adresse'] },
          { name: 'Foursquare', priority: 'low', found: false, complete: false },
        ];

        const foundCount = citationSources.filter(s => s.found).length;
        const completeCount = citationSources.filter(s => s.complete).length;
        const highPriorityMissing = citationSources.filter(s => s.priority === 'high' && !s.found).map(s => s.name);

        return {
          sources: citationSources,
          totalChecked: citationSources.length,
          totalFound: foundCount,
          totalComplete: completeCount,
          coverageScore: Math.round((foundCount / citationSources.length) * 100),
          completenessScore: Math.round((completeCount / foundCount) * 100),
          highPriorityMissing,
          findings: [
            foundCount >= 6
              ? { type: 'positive', title: 'God citation-dækning', description: `Fundet på ${foundCount} af ${citationSources.length} platforme.` }
              : { type: 'warning', title: 'Lav citation-dækning', description: `Kun fundet på ${foundCount} af ${citationSources.length} platforme.` },
            highPriorityMissing.length > 0
              ? { type: 'critical', title: 'Mangler vigtige citations', description: `Ikke registreret på: ${highPriorityMissing.join(', ')}` }
              : { type: 'positive', title: 'Alle vigtige citations på plads', description: 'Registreret på alle high-priority platforme.' },
          ],
          recommendations: highPriorityMissing.map(name => `Opret profil på ${name}`),
          dataSource: 'demo_data',
          confidence: 'indicator',
        };
      },

      // Schema Markup Detection
      async detectSchemaMarkup(websiteUrl) {
        await delay(1500);

        if (!websiteUrl) {
          return {
            hasWebsite: false,
            schemaFound: false,
            findings: [
              { type: 'critical', title: 'Ingen hjemmeside', description: 'Kan ikke analysere schema markup uden hjemmeside.' }
            ],
            dataSource: 'demo_data',
            confidence: 'not_found',
          };
        }

        return {
          hasWebsite: true,
          url: websiteUrl,
          schemaTypes: {
            LocalBusiness: { found: false, fields: [] },
            Restaurant: { found: false, fields: [] },
            Organization: { found: true, fields: ['name', 'url'] },
            WebSite: { found: true, fields: ['name', 'url', 'potentialAction'] },
          },
          openGraph: {
            found: true,
            tags: ['og:title', 'og:description', 'og:image', 'og:url'],
            missingTags: ['og:type', 'og:locale'],
          },
          twitterCards: {
            found: false,
            tags: [],
          },
          structuredDataScore: 35,
          recommendations: [
            'Tilføj LocalBusiness schema markup',
            'Tilføj Restaurant schema med menu og åbningstider',
            'Tilføj Twitter Card meta tags',
            'Udfyld manglende Open Graph tags',
          ],
          findings: [
            { type: 'critical', title: 'Mangler LocalBusiness schema', description: 'Ingen lokal virksomheds-markup fundet. Dette reducerer synlighed i lokale søgeresultater.' },
            { type: 'warning', title: 'Ufuldstændige Open Graph tags', description: 'Mangler og:type og og:locale tags.' },
            { type: 'positive', title: 'Basis schema på plads', description: 'Organization og WebSite schema er implementeret.' },
          ],
          dataSource: 'demo_data',
          confidence: 'indicator',
        };
      },

      // Samlet Score Beregning
      calculateOverallScore(analysisResults) {
        const weights = {
          googleProfile: 25,
          reviews: 30,
          napConsistency: 15,
          website: 15,
          social: 15,
        };

        let totalScore = 0;
        let totalWeight = 0;

        if (analysisResults.googleProfile) {
          const profileScore = analysisResults.googleProfile.profileCompleteness?.score || 70;
          totalScore += profileScore * (weights.googleProfile / 100);
          totalWeight += weights.googleProfile;
        }

        if (analysisResults.reviews) {
          const reviewScore = Math.min(100, (analysisResults.reviews.averageRating / 5) * 80 +
            (analysisResults.reviews.responseMetrics.responseRate / 100) * 20);
          totalScore += reviewScore * (weights.reviews / 100);
          totalWeight += weights.reviews;
        }

        if (analysisResults.napConsistency) {
          totalScore += analysisResults.napConsistency.consistencyScore * (weights.napConsistency / 100);
          totalWeight += weights.napConsistency;
        }

        if (analysisResults.website?.hasWebsite) {
          const webScore = (analysisResults.website.scores.mobile + analysisResults.website.scores.seo) / 2;
          totalScore += webScore * (weights.website / 100);
          totalWeight += weights.website;
        }

        if (analysisResults.social) {
          totalScore += analysisResults.social.overallScore * (weights.social / 100);
          totalWeight += weights.social;
        }

        return Math.round((totalScore / totalWeight) * 100);
      },
    };

    // =============================================================================
    // UI COMPONENTS
    // =============================================================================

    const CheckIcon = ({ size = 14 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    );

    const AlertIcon = ({ size = 14 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
    );

    const TrendUpIcon = () => (
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
        <polyline points="17 6 23 6 23 12"></polyline>
      </svg>
    );

    const TrendDownIcon = () => (
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
        <polyline points="17 18 23 18 23 12"></polyline>
      </svg>
    );

    // =============================================================================
    // SVG ICON LIBRARY
    // =============================================================================
    const Icons = {
      MapPin: (props) => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
          <circle cx="12" cy="10" r="3"/>
        </svg>
      ),
      Star: (props) => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
        </svg>
      ),
      Target: (props) => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>
        </svg>
      ),
      Link: (props) => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
          <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
        </svg>
      ),
      Globe: (props) => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/>
          <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
        </svg>
      ),
      Share: (props) => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
          <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
        </svg>
      ),
      Search: (props) => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
      ),
      Code: (props) => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>
        </svg>
      ),
      CheckCircle: (props) => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
      ),
      AlertTriangle: (props) => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
      ),
      XCircle: (props) => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
      ),
      Lightbulb: (props) => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M9 18h6"/><path d="M10 22h4"/>
          <path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/>
        </svg>
      ),
      Download: (props) => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
      ),
      FileText: (props) => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>
        </svg>
      ),
      Users: (props) => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
      ),
      BarChart: (props) => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/>
        </svg>
      ),
      Check: (props) => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <polyline points="20 6 9 17 4 12"/>
        </svg>
      ),
      X: (props) => (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      ),
    };

    const Icon = ({ name, size = 24, color = 'currentColor', className = '', ...props }) => {
      const IconComponent = Icons[name];
      if (!IconComponent) {
        console.warn(`Icon "${name}" not found`);
        return <span className={className} style={{ fontSize: size * 0.6 }}>[{name}]</span>;
      }
      return <IconComponent width={size} height={size} style={{ color }} className={className} {...props} />;
    };

    // Module icon mapping
    const moduleIconMap = {
      googleProfile: 'MapPin',
      reviews: 'Star',
      serpVisibility: 'Search',
      citations: 'Link',
      competitors: 'Target',
      napConsistency: 'CheckCircle',
      website: 'Globe',
      schemaMarkup: 'Code',
      social: 'Share',
    };

    const Spinner = ({ size = 'small' }) => {
      const dotSize = size === 'small' ? 4 : 6;
      return (
        <div style={{ display: 'flex', gap: 2 }}>
          {[0, 1, 2].map(i => (
            <div key={i} style={{
              width: dotSize,
              height: dotSize,
              borderRadius: '50%',
              background: '#666',
              animation: `pulse 1s ease-in-out ${i * 0.15}s infinite`
            }} />
          ))}
        </div>
      );
    };

    const StatusBadge = ({ status, text }) => {
      const colors = {
        excellent: { bg: '#d1fae5', color: '#059669' },
        good: { bg: '#dbeafe', color: '#2563eb' },
        warning: { bg: '#fef3c7', color: '#d97706' },
        critical: { bg: '#fee2e2', color: '#dc2626' },
      };
      const { bg, color } = colors[status] || colors.warning;

      return (
        <span style={{
          display: 'inline-flex',
          alignItems: 'center',
          gap: 4,
          padding: '4px 10px',
          borderRadius: 20,
          fontSize: 12,
          fontWeight: 500,
          background: bg,
          color: color,
        }}>
          {status === 'excellent' || status === 'good' ? <CheckIcon size={12} /> : <AlertIcon size={12} />}
          {text}
        </span>
      );
    };

    const ProgressRing = ({ progress, size = 100, strokeWidth = 8, color = '#667eea' }) => {
      const radius = (size - strokeWidth) / 2;
      const circumference = radius * 2 * Math.PI;
      const offset = circumference - (progress / 100) * circumference;

      return (
        <svg width={size} height={size} style={{ transform: 'rotate(-90deg)' }}>
          <circle
            cx={size / 2}
            cy={size / 2}
            r={radius}
            fill="none"
            stroke="#e5e5e5"
            strokeWidth={strokeWidth}
          />
          <circle
            cx={size / 2}
            cy={size / 2}
            r={radius}
            fill="none"
            stroke={color}
            strokeWidth={strokeWidth}
            strokeDasharray={circumference}
            strokeDashoffset={offset}
            strokeLinecap="round"
            style={{ transition: 'stroke-dashoffset 0.5s ease' }}
          />
        </svg>
      );
    };

    // =============================================================================
    // SCANNING COMPONENTS
    // =============================================================================

    const ScanningBeam = ({ isScanning, currentStep }) => {
      const [particles, setParticles] = useState([]);

      useEffect(() => {
        if (!isScanning) return;
        const interval = setInterval(() => {
          setParticles(prev => [...prev, {
            id: Date.now(),
            x: Math.random() * 100,
            y: Math.random() * 100,
            size: Math.random() * 6 + 2,
          }].slice(-12));
        }, 400);
        return () => clearInterval(interval);
      }, [isScanning]);

      return (
        <div style={{ position: 'absolute', inset: 0, overflow: 'hidden', pointerEvents: 'none' }}>
          <div style={{
            position: 'absolute',
            left: 0,
            right: 0,
            height: 2,
            background: 'linear-gradient(90deg, transparent, #667eea, #764ba2, #667eea, transparent)',
            animation: isScanning ? 'scanVertical 3s ease-in-out infinite' : 'none',
            boxShadow: '0 0 20px rgba(102, 126, 234, 0.5)'
          }} />
          <div style={{
            position: 'absolute',
            top: 0,
            bottom: 0,
            width: 2,
            background: 'linear-gradient(180deg, transparent, #667eea, #764ba2, #667eea, transparent)',
            animation: isScanning ? 'scanHorizontal 4s ease-in-out infinite' : 'none',
            boxShadow: '0 0 20px rgba(102, 126, 234, 0.5)'
          }} />
          {particles.map(p => (
            <div key={p.id} style={{
              position: 'absolute',
              left: `${p.x}%`,
              top: `${p.y}%`,
              width: p.size,
              height: p.size,
              borderRadius: '50%',
              background: '#667eea',
              boxShadow: '0 0 10px rgba(102, 126, 234, 0.8)',
              animation: 'floatUp 2s ease-out forwards',
            }} />
          ))}
          {currentStep && isScanning && (
            <div style={{
              position: 'absolute',
              top: 20,
              right: 20,
              background: 'rgba(0,0,0,0.8)',
              padding: '12px 16px',
              borderRadius: 10,
              fontSize: 12,
              fontFamily: 'monospace',
            }}>
              <div style={{ color: '#9ca3af', marginBottom: 4 }}>ANALYSERER</div>
              <div style={{ color: '#a78bfa' }}>{currentStep}</div>
            </div>
          )}
        </div>
      );
    };

    // =============================================================================
    // BROWSER WINDOW PREVIEW COMPONENTS
    // =============================================================================

    const BrowserWindow = ({ children, url }) => (
      <div style={{
        background: 'white',
        borderRadius: 12,
        boxShadow: '0 25px 80px rgba(0,0,0,0.15)',
        overflow: 'hidden',
        maxWidth: 600,
        width: '100%',
        animation: 'slideIn 0.6s ease',
      }}>
        <div style={{
          background: '#f6f6f6',
          padding: '12px 16px',
          display: 'flex',
          alignItems: 'center',
          gap: 8,
          borderBottom: '1px solid #e5e5e5'
        }}>
          <div style={{ display: 'flex', gap: 6 }}>
            <div style={{ width: 12, height: 12, borderRadius: '50%', background: '#ff5f57' }} />
            <div style={{ width: 12, height: 12, borderRadius: '50%', background: '#ffbd2e' }} />
            <div style={{ width: 12, height: 12, borderRadius: '50%', background: '#28ca41' }} />
          </div>
          {url && (
            <div style={{
              flex: 1,
              background: 'white',
              borderRadius: 6,
              padding: '6px 12px',
              fontSize: 12,
              color: '#666',
              marginLeft: 8,
              border: '1px solid #e5e5e5',
              overflow: 'hidden',
              textOverflow: 'ellipsis',
              whiteSpace: 'nowrap',
              display: 'flex',
              alignItems: 'center',
              gap: 6,
            }}>
              <Icon name="Search" size={12} color="#9ca3af" />
              {url}
            </div>
          )}
        </div>
        <div style={{ minHeight: 280 }}>{children}</div>
      </div>
    );

    // Map preview with embedded Google Maps
    const MapPreview = ({ business }) => {
      const query = encodeURIComponent((business?.name || '') + ' ' + (business?.address || ''));
      return (
        <div style={{ height: 280, position: 'relative', background: '#f0f0f0' }}>
          <iframe
            src={`https://www.google.com/maps/embed/v1/place?key=AIzaSyBMJxtAMiQBrCLPGmZhVB8b7tj7dTMzfKE&q=${query}&zoom=15`}
            style={{ width: '100%', height: '100%', border: 0 }}
            allowFullScreen
            loading="lazy"
            referrerPolicy="no-referrer-when-downgrade"
          />
        </div>
      );
    };

    // Business card preview
    const BusinessCardPreview = ({ business, data }) => {
      const query = encodeURIComponent((business?.name || '') + ' ' + (business?.address || ''));
      return (
        <div style={{ padding: 24 }}>
          <div style={{ borderRadius: 12, overflow: 'hidden', boxShadow: '0 4px 12px rgba(0,0,0,0.1)', background: 'white' }}>
            <div style={{ height: 140, position: 'relative' }}>
              <iframe
                src={`https://www.google.com/maps/embed/v1/place?key=AIzaSyBMJxtAMiQBrCLPGmZhVB8b7tj7dTMzfKE&q=${query}&zoom=16`}
                style={{ width: '100%', height: '100%', border: 0 }}
                loading="lazy"
              />
            </div>
            <div style={{ padding: 16 }}>
              <h3 style={{ margin: '0 0 8px', fontSize: 18, fontWeight: 600 }}>{business?.name}</h3>
              <div style={{ display: 'flex', alignItems: 'center', gap: 8, fontSize: 14, color: '#666' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: 2 }}>
                  {[1,2,3,4,5].map(i => (
                    <span key={i} style={{ color: i <= Math.round(data?.rating || 0) ? '#fbbf24' : '#e5e5e5', fontSize: 14 }}>★</span>
                  ))}
                </div>
                <span>{data?.rating || '...'}</span>
                <span style={{ color: '#d1d5db' }}>|</span>
                <span>{data?.types?.[0] || 'Restaurant'}</span>
              </div>
              {!data?.description && (
                <div style={{ marginTop: 12, color: '#d97706', fontSize: 13, display: 'flex', alignItems: 'center', gap: 6 }}>
                  <Icon name="AlertTriangle" size={14} color="#d97706" />
                  No description found
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // Review preview
    const ReviewPreview = ({ reviews }) => {
      const review = reviews?.[0];
      return (
        <div style={{ padding: 24 }}>
          <div style={{ background: 'white', borderRadius: 12, padding: 20, boxShadow: '0 2px 8px rgba(0,0,0,0.06)' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
              <div style={{
                width: 48,
                height: 48,
                borderRadius: '50%',
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                color: 'white',
                fontWeight: 600,
                fontSize: 18,
              }}>
                {review?.author?.charAt(0) || 'U'}
              </div>
              <div style={{ flex: 1 }}>
                <div style={{ fontWeight: 500 }}>{review?.author || 'Loading...'}</div>
                <div style={{ fontSize: 12, color: '#6b7280' }}>{review?.time || '3 months ago'}</div>
              </div>
              <div style={{ display: 'flex', gap: 2 }}>
                {[1,2,3,4,5].map(i => (
                  <span key={i} style={{ color: i <= (review?.rating || 4) ? '#fbbf24' : '#e5e5e5', fontSize: 16 }}>★</span>
                ))}
              </div>
            </div>
            {review?.text && (
              <p style={{ margin: '16px 0 0', fontSize: 14, color: '#374151', lineHeight: 1.5 }}>
                {review.text}
              </p>
            )}
          </div>
        </div>
      );
    };

    // Photo gallery preview
    const PhotoPreview = ({ photos }) => (
      <div style={{ padding: 24 }}>
        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 8 }}>
          {(photos || [1,2,3,4,5,6]).slice(0, 6).map((_, i) => (
            <div key={i} style={{
              aspectRatio: '1',
              background: `linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%)`,
              borderRadius: 8,
              animation: 'pulse 2s ease-in-out infinite',
              animationDelay: `${i * 0.1}s`,
            }} />
          ))}
        </div>
      </div>
    );

    // =============================================================================
    // LIVE FINDINGS FEED COMPONENTS
    // =============================================================================

    const ConfidenceBadge = ({ confidence }) => {
      const labels = { confirmed: 'Bekræftet', indicator: 'Indikator', not_found: 'Ikke fundet' };
      return (
        <span className={`confidence-badge confidence-${confidence}`}>
          {labels[confidence] || confidence}
        </span>
      );
    };

    const ImpactBadge = ({ impact }) => {
      const labels = { high: 'Høj', medium: 'Medium', low: 'Lav' };
      return (
        <span style={{
          fontSize: 11,
          fontWeight: 400,
          color: '#9ca3af',
        }}>
          {labels[impact]} effekt
        </span>
      );
    };

    const FindingCard = ({ finding, isHighlighted }) => {
      const categoryIcons = {
        positive: { icon: 'CheckCircle', color: '#059669' },
        warning: { icon: 'AlertCircle', color: '#6b7280' },
        critical: { icon: 'AlertCircle', color: '#6b7280' },
        opportunity: { icon: 'Lightbulb', color: '#6b7280' },
      };
      const iconStyle = categoryIcons[finding.category] || categoryIcons.warning;

      return (
        <div className={`finding-card ${isHighlighted ? 'finding-card--highlighted' : ''}`}>
          <div className="finding-card__header">
            <span className="finding-card__module">{finding.moduleName}</span>
            <span style={{ marginLeft: 'auto' }}>
              <ConfidenceBadge confidence={finding.confidence} />
            </span>
          </div>
          <div className="finding-card__title">{finding.title}</div>
          <div className="finding-card__description">{finding.description}</div>
          <div className="finding-card__footer">
            <span className="finding-card__source">Kilde: {finding.dataSource}</span>
            {finding.impact && <ImpactBadge impact={finding.impact} />}
          </div>
        </div>
      );
    };

    const ModuleStatusIndicator = ({ module }) => {
      const statusClasses = {
        pending: '',
        running: 'module-indicator--running',
        completed: 'module-indicator--completed',
        error: 'module-indicator--error',
      };

      return (
        <div className={`module-indicator ${statusClasses[module.status]}`}>
          {module.status === 'running' ? (
            <Spinner size="small" />
          ) : module.status === 'completed' ? (
            <Icon name="Check" size={12} color="#059669" />
          ) : module.status === 'error' ? (
            <Icon name="X" size={12} color="#dc2626" />
          ) : null}
          <span>{module.name}</span>
          {module.findingsCount > 0 && (
            <span className="module-indicator__count">{module.findingsCount}</span>
          )}
        </div>
      );
    };

    const LiveFindingsFeed = ({ findings, highlightedId, moduleStatuses }) => {
      const feedRef = useRef(null);

      useEffect(() => {
        if (feedRef.current && highlightedId) {
          feedRef.current.scrollTo({ top: 0, behavior: 'smooth' });
        }
      }, [highlightedId]);

      return (
        <div className="findings-feed">
          <div className="module-status-bar">
            {moduleStatuses.map(module => (
              <ModuleStatusIndicator key={module.id} module={module} />
            ))}
          </div>
          <div className="findings-stream" ref={feedRef}>
            {findings.length === 0 ? (
              <div style={{ textAlign: 'center', padding: 40, color: '#6b7280' }}>
                <Icon name="Search" size={32} color="#d1d5db" />
                <p style={{ marginTop: 12, fontSize: 14 }}>Venter på fund...</p>
              </div>
            ) : (
              findings.map(finding => (
                <FindingCard
                  key={finding.id}
                  finding={finding}
                  isHighlighted={finding.id === highlightedId}
                />
              ))
            )}
          </div>
        </div>
      );
    };

    // Helper function to extract findings from module results
    const extractFindings = (moduleId, moduleName, result) => {
      const findings = [];

      // Extract findings based on module type
      if (result?.findings) {
        result.findings.forEach((f, i) => {
          findings.push({
            id: `${moduleId}_${i}_${Date.now()}`,
            module: moduleId,
            moduleName: moduleName,
            category: f.type || 'warning',
            title: f.title,
            description: f.description,
            impact: f.impact || 'medium',
            confidence: result.confidence || 'indicator',
            dataSource: result.dataSource || 'demo_data',
          });
        });
      }

      // Module-specific finding extraction
      if (moduleId === 'googleProfile' && result) {
        if (result.rating >= 4.0) {
          findings.push({
            id: `${moduleId}_rating_${Date.now()}`,
            module: moduleId,
            moduleName,
            category: 'positive',
            title: 'God Google rating',
            description: `Rating på ${result.rating} stjerner baseret på ${result.totalReviews} anmeldelser.`,
            impact: 'high',
            confidence: 'confirmed',
            dataSource: 'Google Places API',
          });
        }
        if (result.profileCompleteness?.score < 80) {
          findings.push({
            id: `${moduleId}_incomplete_${Date.now()}`,
            module: moduleId,
            moduleName,
            category: 'warning',
            title: 'Ufuldstændig profil',
            description: `Profilen er kun ${result.profileCompleteness.score}% komplet. Mangler: ${result.profileCompleteness.missing?.slice(0,2).join(', ')}.`,
            impact: 'medium',
            confidence: 'confirmed',
            dataSource: 'Google Places API',
          });
        }
      }

      if (moduleId === 'reviews' && result) {
        if (result.responseMetrics?.responseRate < 50) {
          findings.push({
            id: `${moduleId}_response_${Date.now()}`,
            module: moduleId,
            moduleName,
            category: 'warning',
            title: 'Lav svarrate på anmeldelser',
            description: `Kun ${result.responseMetrics.responseRate}% af anmeldelser besvaret. Anbefalet: > 50%.`,
            impact: 'high',
            confidence: 'confirmed',
            dataSource: 'Google Reviews',
          });
        }
        if (result.velocity?.monthlyAverage < 4) {
          findings.push({
            id: `${moduleId}_velocity_${Date.now()}`,
            module: moduleId,
            moduleName,
            category: 'opportunity',
            title: 'Potentiale for flere anmeldelser',
            description: `Gennemsnit på ${result.velocity.monthlyAverage} anmeldelser/måned. Overvej aktiv opfordring.`,
            impact: 'medium',
            confidence: 'indicator',
            dataSource: 'Google Reviews',
          });
        }
      }

      if (moduleId === 'images' && result) {
        if (result.totalImages === 0) {
          findings.push({
            id: `${moduleId}_missing_${Date.now()}`,
            module: moduleId,
            moduleName,
            category: 'warning',
            title: 'Ingen online billeder',
            description: 'Virksomheden har ingen synlige billeder på nettet. Dette påvirker troværdighed.',
            impact: 'medium',
            confidence: result.confidence || 'indicator',
            dataSource: 'Serper Images API',
          });
        }
        if (result.totalImages > 0 && !result.hasFoodPhotos && !result.hasInteriorPhotos) {
          findings.push({
            id: `${moduleId}_variety_${Date.now()}`,
            module: moduleId,
            moduleName,
            category: 'opportunity',
            title: 'Mangler varierede billeder',
            description: 'Overvej at tilføje billeder af mad/produkter og interiør for bedre engagement.',
            impact: 'low',
            confidence: result.confidence || 'indicator',
            dataSource: 'Serper Images API',
          });
        }
      }

      if (moduleId === 'napConsistency' && result) {
        const issues = result.issues?.filter(i => i.severity === 'high') || [];
        if (issues.length > 0) {
          findings.push({
            id: `${moduleId}_issues_${Date.now()}`,
            module: moduleId,
            moduleName,
            category: 'critical',
            title: 'Inkonsistente virksomhedsoplysninger',
            description: `${issues.length} kritiske problemer fundet: ${issues.map(i => i.platform).join(', ')}.`,
            impact: 'high',
            confidence: 'indicator',
            dataSource: 'Multi-platform check',
          });
        }
      }

      return findings;
    };

    // =============================================================================
    // SEARCH COMPONENT
    // =============================================================================
    const BusinessSearch = ({ onBusinessSelect }) => {
      const [query, setQuery] = useState('');
      const [results, setResults] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [showResults, setShowResults] = useState(false);
      const debounceRef = useRef(null);

      useEffect(() => {
        if (query.length < 2) {
          setResults([]);
          setShowResults(false);
          return;
        }

        if (debounceRef.current) {
          clearTimeout(debounceRef.current);
        }

        debounceRef.current = setTimeout(async () => {
          setLoading(true);
          setError(null);
          try {
            const searchResults = await AnalysisService.searchBusiness(query);
            setResults(searchResults);
            setShowResults(true);
          } catch (err) {
            setError('Kunne ikke søge. Prøv igen.');
            setResults([]);
          } finally {
            setLoading(false);
          }
        }, 300);

        return () => {
          if (debounceRef.current) {
            clearTimeout(debounceRef.current);
          }
        };
      }, [query]);

      const handleSelect = (business) => {
        onBusinessSelect(business);
        setQuery(business.name);
        setShowResults(false);
      };

      return (
        <div className="search-container">
          <div className="search-box">
            <h1 className="search-title">Digital Synlighedsanalyse</h1>
            <p className="search-subtitle">Få indsigt i din virksomheds digitale tilstedeværelse og lokale søgesynlighed</p>

            <div className="search-input-wrapper">
              <input
                type="text"
                className="search-input"
                placeholder="Søg efter din virksomhed..."
                value={query}
                onChange={(e) => setQuery(e.target.value)}
              />
            </div>

            {loading && (
              <div className="search-loading">
                <Spinner />
                <span>Søger...</span>
              </div>
            )}

            {error && <div className="search-error">{error}</div>}

            {showResults && results.length > 0 && (
              <div className="search-results">
                {results.map((result, index) => (
                  <div
                    key={result.place_id || index}
                    className="search-result-item"
                    onClick={() => handleSelect(result)}
                  >
                    <div className="search-result-name">{result.name}</div>
                    <div className="search-result-address">{result.address}</div>
                  </div>
                ))}
              </div>
            )}

            {showResults && results.length === 0 && query.length >= 2 && !loading && (
              <div className="search-results">
                <div className="search-result-item" style={{ textAlign: 'center', color: '#6b7280' }}>
                  Ingen resultater fundet
                </div>
              </div>
            )}

            <button
              className="search-button"
              onClick={() => {
                if (results.length > 0) {
                  handleSelect(results[0]);
                }
              }}
              disabled={results.length === 0}
            >
              Start analyse
            </button>
          </div>
        </div>
      );
    };

    // =============================================================================
    // SCANNER COMPONENT
    // =============================================================================
    const AnalysisScanner = ({ business, onBack }) => {
      const [currentStep, setCurrentStep] = useState(0);
      const [completedSteps, setCompletedSteps] = useState([]);
      const [analysisResults, setAnalysisResults] = useState({});
      const [isComplete, setIsComplete] = useState(false);
      const [showReport, setShowReport] = useState(false);
      const [findings, setFindings] = useState([]);
      const [highlightedFindingId, setHighlightedFindingId] = useState(null);
      const [secondsRemaining, setSecondsRemaining] = useState(45);

      // Countdown timer
      useEffect(() => {
        if (isComplete) return;
        const interval = setInterval(() => {
          setSecondsRemaining(prev => Math.max(prev - 1, 0));
        }, 1000);
        return () => clearInterval(interval);
      }, [isComplete]);

      const addFindings = useCallback((newFindings) => {
        if (newFindings.length === 0) return;
        setFindings(prev => [...newFindings, ...prev]);
        setHighlightedFindingId(newFindings[0]?.id);
        setTimeout(() => setHighlightedFindingId(null), 2000);
      }, []);

      const analysisSteps = useMemo(() => [
        { id: 'googleProfile', name: 'Google Business Profile', icon: 'MapPin' },
        { id: 'reviews', name: 'Anmeldelsesanalyse', icon: 'Star' },
        { id: 'images', name: 'Billeder & Medier', icon: 'Image' },
        { id: 'serpVisibility', name: 'SERP Synlighed', icon: 'Search' },
        { id: 'citations', name: 'Citationer', icon: 'Link' },
        { id: 'competitors', name: 'Konkurrentanalyse', icon: 'Target' },
        { id: 'napConsistency', name: 'NAP Konsistens', icon: 'CheckCircle' },
        { id: 'website', name: 'Website & Mobil', icon: 'Globe' },
        { id: 'schemaMarkup', name: 'Schema Markup', icon: 'Code' },
        { id: 'social', name: 'Social Media', icon: 'Share' },
      ], []);

      useEffect(() => {
        const runAnalysis = async () => {
          try {
            // Start the v3 backend scan (single API call)
            const v3Promise = scanWithV3Backend(business);

            // Simulate step progression while API processes
            for (let i = 0; i < analysisSteps.length; i++) {
              setCurrentStep(i);
              await delay(800 + Math.random() * 400);
              setCompletedSteps(prev => [...prev, analysisSteps[i].id]);
            }

            // Wait for v3 API to complete
            const v3Response = await v3Promise;

            // Transform v3 response to display format
            const displayData = transformV3ToDisplayFormat(v3Response);
            setAnalysisResults(displayData);

            // Convert v3 findings to the findings feed format
            const v3Findings = (v3Response.findings || []).map((f, i) => ({
              id: f.id || `v3_finding_${i}`,
              module: f.module || 'general',
              moduleName: f.module || 'Generelt',
              category: f.type === 'positive' ? 'positive' : f.type === 'critical' ? 'critical' : 'warning',
              title: f.title || 'Finding',
              description: f.description || '',
              confidence: f.confidence || 'indicator',
              dataSource: 'Agent SEO v3',
            }));
            setFindings(v3Findings);

            setIsComplete(true);
          } catch (error) {
            console.error('V3 scan failed:', error);
            // Complete all steps visually even on error
            analysisSteps.forEach(step => {
              setCompletedSteps(prev => prev.includes(step.id) ? prev : [...prev, step.id]);
            });
            addFindings([{
              id: `v3_error_${Date.now()}`,
              module: 'system',
              moduleName: 'System',
              category: 'critical',
              title: 'Scan fejlede',
              description: error.message || 'Kunne ikke gennemføre analysen. Prøv igen om lidt.',
              confidence: 'not_found',
              dataSource: 'System',
            }]);
            setIsComplete(true);
          }
        };

        runAnalysis();
      }, [business, analysisSteps, addFindings]);

      const progress = (completedSteps.length / analysisSteps.length) * 100;

      if (showReport) {
        return (
          <AnalysisReport
            results={analysisResults}
            business={business}
            onNewScan={onBack}
            findings={findings}
          />
        );
      }

      return (
        <div style={{ minHeight: '100vh', background: '#f5f5f7' }}>
          <div style={{ display: 'grid', gridTemplateColumns: '360px 1fr', minHeight: '100vh' }}>
            {/* Sidebar */}
            <div style={{
              background: 'white',
              borderRight: '1px solid #e5e5e5',
              padding: '40px 32px',
              display: 'flex',
              flexDirection: 'column'
            }}>
              <div style={{ marginBottom: 8 }}>
                <span style={{
                  fontSize: 12,
                  fontWeight: 600,
                  color: '#667eea',
                  textTransform: 'uppercase',
                  letterSpacing: 1
                }}>
                  Digital Analyse
                </span>
              </div>
              <h1 style={{ margin: '0 0 8px', fontSize: 24, fontWeight: 700 }}>{business.name}</h1>
              <p style={{ margin: '0 0 32px', fontSize: 14, color: '#6b7280' }}>{business.address}</p>

              <div style={{ flex: 1 }}>
                {analysisSteps.map((step, index) => {
                  const isCompleted = completedSteps.includes(step.id);
                  const isCurrent = index === currentStep && !isComplete;

                  return (
                    <div key={step.id} style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: 12,
                      padding: '12px 0',
                      borderBottom: '1px solid #f0f0f0',
                    }}>
                      <div style={{
                        width: 20,
                        height: 20,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                      }}>
                        {isCompleted ? (
                          <Icon name="Check" size={16} color="#059669" />
                        ) : (
                          <div style={{
                            width: 8,
                            height: 8,
                            borderRadius: '50%',
                            background: isCurrent ? '#015bf8' : '#d1d5db',
                          }} />
                        )}
                      </div>
                      <div style={{ flex: 1 }}>
                        <span style={{
                          fontSize: 14,
                          color: isCompleted ? '#059669' : isCurrent ? '#1a1a1a' : '#9ca3af',
                          fontWeight: isCurrent ? 500 : 400
                        }}>
                          {step.name}
                        </span>
                        {isCurrent && (
                          <div style={{ marginTop: 4 }}>
                            <Spinner />
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>

              <div style={{ paddingTop: 24, borderTop: '1px solid #f0f0f0' }}>
                <div style={{ height: 6, background: '#e5e5e5', borderRadius: 3, marginBottom: 16, overflow: 'hidden' }}>
                  <div style={{
                    height: '100%',
                    width: `${progress}%`,
                    background: isComplete ? '#059669' : 'linear-gradient(90deg, #667eea, #764ba2)',
                    borderRadius: 3,
                    transition: 'width 0.3s ease'
                  }} />
                </div>
                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                  {!isComplete && <Spinner />}
                  <div>
                    <div style={{ fontSize: 14, fontWeight: 500 }}>
                      {isComplete ? 'Analyse færdig!' : 'Running...'}
                    </div>
                    {!isComplete && (
                      <div style={{ fontSize: 13, color: '#6b7280' }}>
                        {secondsRemaining} seconds remaining
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>

            {/* Main Content */}
            <div style={{
              padding: 32,
              display: 'flex',
              flexDirection: 'column',
              position: 'relative',
              background: 'linear-gradient(135deg, #f5f5f7 0%, #e5e5ea 100%)',
              overflow: 'hidden',
            }}>
              <ScanningBeam
                isScanning={!isComplete}
                currentStep={!isComplete && currentStep < analysisSteps.length ? analysisSteps[currentStep].name : null}
              />

              {!isComplete ? (
                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  height: '100%',
                  zIndex: 10,
                  padding: 40,
                }}>
                  <BrowserWindow url={
                    currentStep === 0 ? `${business.name} in ${business.address?.split(',').pop()?.trim() || 'Denmark'}` :
                    currentStep === 1 ? `google.com/business/${business.name}` :
                    currentStep === 2 ? `google.com/reviews/${business.name}` :
                    currentStep === 3 ? `google.com/photos/${business.name}` :
                    currentStep === 4 ? `facebook.com/${business.name?.toLowerCase().replace(/\s/g, '')}` :
                    `pagespeed.web.dev/${business.name}`
                  }>
                    {currentStep === 0 && <MapPreview business={business} />}
                    {currentStep === 1 && <BusinessCardPreview business={business} data={analysisResults.googleProfile} />}
                    {currentStep === 2 && <ReviewPreview reviews={analysisResults.reviews?.topReviews} />}
                    {currentStep === 3 && <PhotoPreview photos={analysisResults.photos} />}
                    {currentStep === 4 && <BusinessCardPreview business={business} data={analysisResults.googleProfile} />}
                    {currentStep >= 5 && <MapPreview business={business} />}
                  </BrowserWindow>
                </div>
              ) : (
                <div style={{ display: 'flex', gap: 24, height: '100%', zIndex: 10 }}>
                  {/* Completion Card */}
                  <div style={{
                    background: 'white',
                    borderRadius: 20,
                    padding: 32,
                    textAlign: 'center',
                    boxShadow: '0 15px 50px rgba(0,0,0,0.08)',
                    width: 320,
                    flexShrink: 0,
                    animation: 'slideIn 0.4s ease',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                  }}>
                    <div style={{ margin: '0 auto 16px' }}>
                      <Icon name="Check" size={32} color="#059669" />
                    </div>
                    <h2 style={{ margin: '0 0 8px', fontSize: 20, fontWeight: 600 }}>Analyse færdig!</h2>
                    <p style={{ margin: '0 0 8px', color: '#6b7280', fontSize: 14 }}>
                      {analysisSteps.length} områder analyseret
                    </p>

                    {/* Summary Stats - Inline */}
                    <p style={{ fontSize: 14, color: '#6b7280', marginBottom: 24 }}>
                      <span style={{ color: '#059669', fontWeight: 500 }}>{findings.filter(f => f.category === 'positive').length} positive</span>
                      <span style={{ margin: '0 8px', color: '#d1d5db' }}>·</span>
                      <span style={{ color: '#d97706', fontWeight: 500 }}>{findings.filter(f => f.category === 'warning').length} advarsler</span>
                      <span style={{ margin: '0 8px', color: '#d1d5db' }}>·</span>
                      <span style={{ color: '#dc2626', fontWeight: 500 }}>{findings.filter(f => f.category === 'critical').length} kritiske</span>
                    </p>

                    <button
                      onClick={() => setShowReport(true)}
                      style={{
                        padding: '14px 32px',
                        background: '#015bf8',
                        color: 'white',
                        border: 'none',
                        borderRadius: 8,
                        fontSize: 15,
                        fontWeight: 500,
                        cursor: 'pointer',
                        transition: 'all 0.2s',
                        width: '100%',
                      }}
                      onMouseOver={(e) => { e.target.style.background = '#0047cc'; }}
                      onMouseOut={(e) => { e.target.style.background = '#015bf8'; }}
                    >
                      Se fuld rapport
                    </button>
                  </div>

                  {/* Final Findings Overview */}
                  <div style={{ flex: 1, minWidth: 0 }}>
                    <div style={{ background: 'white', borderRadius: 20, padding: 24, boxShadow: '0 15px 50px rgba(0,0,0,0.08)', height: '100%', maxHeight: 'calc(100vh - 120px)', overflow: 'hidden', display: 'flex', flexDirection: 'column' }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16 }}>
                        <Icon name="FileText" size={20} color="#667eea" />
                        <h3 style={{ margin: 0, fontSize: 16, fontWeight: 600 }}>Alle fund</h3>
                        <span style={{ marginLeft: 'auto', fontSize: 12, color: '#6b7280' }}>{findings.length} fund</span>
                      </div>
                      <LiveFindingsFeed
                        findings={findings}
                        highlightedId={null}
                        moduleStatuses={analysisSteps.map(step => ({
                          id: step.id,
                          name: step.name,
                          status: 'completed',
                          findingsCount: findings.filter(f => f.module === step.id).length,
                        }))}
                      />
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // =============================================================================
    // PDF REPORT GENERATOR
    // =============================================================================
    class ScannerReportGenerator {
      constructor() {
        this.primaryColor = [1, 91, 248];  // #015bf8 - primary blue
        this.secondaryColor = [1, 91, 248]; // Same blue for consistency
        this.darkColor = [26, 26, 46];
        this.successColor = [5, 150, 105];
        this.warningColor = [217, 119, 6];
        this.dangerColor = [220, 38, 38];
        this.textColor = [51, 51, 51];
        this.mutedColor = [107, 114, 128];
        this.lightGray = [249, 250, 251];
        this.pageWidth = 210;
        this.pageHeight = 297;
        this.margin = 20;
        this.contentWidth = this.pageWidth - 2 * this.margin;
      }

      formatDate(date) {
        return new Date(date).toLocaleDateString('da-DK', { day: 'numeric', month: 'long', year: 'numeric' });
      }

      getScoreColor(score) {
        if (score >= 75) return this.successColor;
        if (score >= 50) return this.warningColor;
        return this.dangerColor;
      }

      generate(reportData) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        this.addCoverPage(doc, reportData);
        this.addExecutiveSummary(doc, reportData);
        this.addScorecards(doc, reportData);
        this.addActionPlan(doc, reportData);

        return doc;
      }

      addCoverPage(doc, data) {
        // Clean header bar
        doc.setFillColor(this.primaryColor[0], this.primaryColor[1], this.primaryColor[2]);
        doc.rect(0, 0, this.pageWidth, 8, 'F');

        // Title
        doc.setTextColor(this.textColor[0], this.textColor[1], this.textColor[2]);
        doc.setFontSize(32);
        doc.setFont('helvetica', 'bold');
        doc.text('Digital Synlighedsrapport', this.pageWidth / 2, 45, { align: 'center' });

        // Subtitle
        doc.setFontSize(12);
        doc.setTextColor(this.mutedColor[0], this.mutedColor[1], this.mutedColor[2]);
        doc.setFont('helvetica', 'normal');
        doc.text('Komplet analyse af din digitale tilstedeværelse', this.pageWidth / 2, 58, { align: 'center' });

        // Business name
        doc.setTextColor(this.primaryColor[0], this.primaryColor[1], this.primaryColor[2]);
        doc.setFontSize(20);
        doc.setFont('helvetica', 'bold');
        doc.text(data.business.name, this.pageWidth / 2, 85, { align: 'center' });

        // Date and location
        doc.setTextColor(this.mutedColor[0], this.mutedColor[1], this.mutedColor[2]);
        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');
        doc.text(data.business.address || '', this.pageWidth / 2, 98, { align: 'center' });
        doc.text(`Genereret: ${this.formatDate(data.scanDate)}`, this.pageWidth / 2, 108, { align: 'center' });

        // Overall Score - Clean horizontal bar style
        const centerX = this.pageWidth / 2;
        const centerY = 150;

        // Score circle with ring
        const radius = 32;
        const scoreColor = this.getScoreColor(data.overallScore);

        // Outer ring
        doc.setDrawColor(240, 240, 240);
        doc.setLineWidth(4);
        doc.circle(centerX, centerY, radius, 'S');

        // Colored arc (approximated with circle for simplicity)
        doc.setDrawColor(scoreColor[0], scoreColor[1], scoreColor[2]);
        doc.setLineWidth(4);
        doc.circle(centerX, centerY, radius, 'S');

        // Score number
        doc.setTextColor(this.textColor[0], this.textColor[1], this.textColor[2]);
        doc.setFontSize(32);
        doc.setFont('helvetica', 'bold');
        doc.text(String(data.overallScore), centerX, centerY + 4, { align: 'center' });
        doc.setFontSize(10);
        doc.setTextColor(this.mutedColor[0], this.mutedColor[1], this.mutedColor[2]);
        doc.setFont('helvetica', 'normal');
        doc.text('af 100', centerX, centerY + 14, { align: 'center' });

        // Score Label
        doc.setTextColor(scoreColor[0], scoreColor[1], scoreColor[2]);
        doc.setFontSize(13);
        doc.setFont('helvetica', 'bold');
        const label = data.overallScore >= 75 ? 'God digital tilstedeværelse' :
                     data.overallScore >= 50 ? 'Forbedringspotentiale' : 'Kritiske mangler';
        doc.text(label, centerX, centerY + 48, { align: 'center' });

        // Key Stats
        let yPos = 220;
        doc.setFontSize(11);
        doc.setFont('helvetica', 'normal');

        const stats = [
          { label: 'Rating', value: data.results.googleProfile?.rating || 'N/A' },
          { label: 'Anmeldelser', value: data.results.reviews?.totalReviews || 0 },
          { label: 'Fund', value: data.findingsCount || 0 },
        ];

        const statWidth = this.contentWidth / 3;
        stats.forEach((stat, i) => {
          const x = this.margin + statWidth * i + statWidth / 2;
          doc.setTextColor(this.mutedColor[0], this.mutedColor[1], this.mutedColor[2]);
          doc.text(stat.label, x, yPos, { align: 'center' });
          doc.setTextColor(this.textColor[0], this.textColor[1], this.textColor[2]);
          doc.setFont('helvetica', 'bold');
          doc.text(String(stat.value), x, yPos + 8, { align: 'center' });
          doc.setFont('helvetica', 'normal');
        });

        // Footer
        doc.setFontSize(9);
        doc.setTextColor(this.mutedColor[0], this.mutedColor[1], this.mutedColor[2]);
        doc.text('Powered by OrderFlow Business Scanner', centerX, 280, { align: 'center' });
      }

      addExecutiveSummary(doc, data) {
        doc.addPage();
        let yPos = this.margin;

        // Clean section header
        doc.setTextColor(this.textColor[0], this.textColor[1], this.textColor[2]);
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('Top 5 Vigtigste Fund', this.margin, yPos + 5);
        yPos += 10;

        // Accent line
        doc.setFillColor(this.primaryColor[0], this.primaryColor[1], this.primaryColor[2]);
        doc.rect(this.margin, yPos, 40, 2, 'F');
        yPos += 15;

        // Top findings
        const topFindings = (data.findings || [])
          .filter(f => f.category === 'critical' || f.category === 'warning')
          .slice(0, 5);

        if (topFindings.length === 0) {
          doc.setTextColor(this.mutedColor[0], this.mutedColor[1], this.mutedColor[2]);
          doc.setFont('helvetica', 'normal');
          doc.text('Ingen kritiske fund.', this.margin, yPos + 10);
          yPos += 30;
        } else {
          topFindings.forEach((finding, i) => {
            const color = finding.category === 'critical' ? this.dangerColor : this.warningColor;

            // Number badge
            doc.setFillColor(color[0], color[1], color[2]);
            doc.circle(this.margin + 8, yPos + 5, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(String(i + 1), this.margin + 8, yPos + 8, { align: 'center' });

            // Finding text
            doc.setTextColor(this.textColor[0], this.textColor[1], this.textColor[2]);
            doc.setFontSize(11);
            doc.text(finding.title, this.margin + 22, yPos + 6);

            doc.setTextColor(this.mutedColor[0], this.mutedColor[1], this.mutedColor[2]);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            const desc = finding.description?.substring(0, 100) + (finding.description?.length > 100 ? '...' : '');
            doc.text(desc, this.margin + 22, yPos + 14);

            yPos += 28;
          });
        }
      }

      addScorecards(doc, data) {
        doc.addPage();
        let yPos = this.margin;

        // Clean section header
        doc.setTextColor(this.textColor[0], this.textColor[1], this.textColor[2]);
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('Scorekort', this.margin, yPos + 5);
        yPos += 10;

        // Accent line
        doc.setFillColor(this.primaryColor[0], this.primaryColor[1], this.primaryColor[2]);
        doc.rect(this.margin, yPos, 40, 2, 'F');
        yPos += 20;

        const bd = data.results._v3score?.breakdown || {};
        const scores = [
          { name: 'Google Business Profile', score: bd.gbp || data.results.googleProfile?.profileCompleteness?.score || 0 },
          { name: 'Anmeldelser', score: bd.reviews || Math.round((data.results.reviews?.averageRating / 5) * 100) || 0 },
          { name: 'NAP Konsistens', score: bd.socialNap || data.results.napConsistency?.consistencyScore || 0 },
          { name: 'Website', score: bd.website || data.results.website?.scores?.mobile || 0 },
          { name: 'Konkurrenter', score: bd.competitors || 0 },
        ];

        const cardWidth = (this.contentWidth - 10) / 2;
        const cardHeight = 35;

        scores.forEach((card, i) => {
          const col = i % 2;
          const row = Math.floor(i / 2);
          const x = this.margin + col * (cardWidth + 10);
          const y = yPos + row * (cardHeight + 10);

          // Card background
          doc.setFillColor(this.lightGray[0], this.lightGray[1], this.lightGray[2]);
          doc.roundedRect(x, y, cardWidth, cardHeight, 3, 3, 'F');

          // Score
          const scoreColor = this.getScoreColor(card.score);
          doc.setTextColor(scoreColor[0], scoreColor[1], scoreColor[2]);
          doc.setFontSize(22);
          doc.setFont('helvetica', 'bold');
          doc.text(String(card.score), x + 12, y + 22);

          // Label
          doc.setTextColor(this.textColor[0], this.textColor[1], this.textColor[2]);
          doc.setFontSize(10);
          doc.setFont('helvetica', 'normal');
          doc.text(card.name, x + 35, y + 15);

          // Score bar
          const barWidth = cardWidth - 50;
          const barX = x + 35;
          const barY = y + 22;

          doc.setFillColor(224, 224, 224);
          doc.roundedRect(barX, barY, barWidth, 5, 2, 2, 'F');

          doc.setFillColor(scoreColor[0], scoreColor[1], scoreColor[2]);
          doc.roundedRect(barX, barY, barWidth * (card.score / 100), 5, 2, 2, 'F');
        });
      }

      addActionPlan(doc, data) {
        doc.addPage();
        let yPos = this.margin;

        // Clean section header
        doc.setTextColor(this.textColor[0], this.textColor[1], this.textColor[2]);
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('Prioriteret Handlingsplan', this.margin, yPos + 5);
        yPos += 10;

        // Accent line
        doc.setFillColor(this.primaryColor[0], this.primaryColor[1], this.primaryColor[2]);
        doc.rect(this.margin, yPos, 40, 2, 'F');
        yPos += 15;

        const actions = [
          { title: 'Svar på flere anmeldelser', priority: 'high', impact: 'Høj', effort: 'Lav' },
          { title: 'Opdater Google Business profil', priority: 'high', impact: 'Høj', effort: 'Lav' },
          { title: 'Tilføj LocalBusiness schema markup', priority: 'high', impact: 'Høj', effort: 'Medium' },
          { title: 'Opret manglende citationer', priority: 'medium', impact: 'Medium', effort: 'Medium' },
          { title: 'Optimer mobil hastighed', priority: 'medium', impact: 'Medium', effort: 'Høj' },
          { title: 'Øg social media aktivitet', priority: 'low', impact: 'Lav', effort: 'Medium' },
        ];

        actions.forEach((action, i) => {
          const color = action.priority === 'high' ? this.dangerColor :
                       action.priority === 'medium' ? this.warningColor : this.successColor;

          // Priority badge
          doc.setFillColor(color[0], color[1], color[2]);
          doc.roundedRect(this.margin, yPos, 18, 18, 3, 3, 'F');
          doc.setTextColor(255, 255, 255);
          doc.setFontSize(10);
          doc.setFont('helvetica', 'bold');
          doc.text(String(i + 1), this.margin + 9, yPos + 12, { align: 'center' });

          // Action text
          doc.setTextColor(this.textColor[0], this.textColor[1], this.textColor[2]);
          doc.setFontSize(11);
          doc.text(action.title, this.margin + 25, yPos + 8);

          // Impact/Effort
          doc.setTextColor(this.mutedColor[0], this.mutedColor[1], this.mutedColor[2]);
          doc.setFontSize(9);
          doc.setFont('helvetica', 'normal');
          doc.text(`Effekt: ${action.impact} | Indsats: ${action.effort}`, this.margin + 25, yPos + 16);

          yPos += 25;
        });

        // Call-to-action box
        yPos += 25;
        doc.setDrawColor(this.primaryColor[0], this.primaryColor[1], this.primaryColor[2]);
        doc.setLineWidth(0.5);
        doc.roundedRect(this.margin, yPos, this.contentWidth, 35, 3, 3, 'S');
        doc.setTextColor(this.primaryColor[0], this.primaryColor[1], this.primaryColor[2]);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('Næste skridt', this.margin + 10, yPos + 14);
        doc.setTextColor(this.textColor[0], this.textColor[1], this.textColor[2]);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('Start med de 3 højprioriterede handlinger for at opnå størst effekt hurtigt.', this.margin + 10, yPos + 26);
      }
    }

    // Global PDF generator instance
    const pdfGenerator = new ScannerReportGenerator();

    // =============================================================================
    // ANALYSIS REPORT COMPONENT
    // =============================================================================
    const AnalysisReport = ({ results, business, onNewScan, findings = [] }) => {
      // Use v3 backend score if available, otherwise calculate locally
      const overallScore = results._v3score
        ? Math.round(results._v3score.overall || 0)
        : AnalysisService.calculateOverallScore(results);

      const getScoreColor = (score) => {
        if (score >= 75) return '#059669';
        if (score >= 50) return '#d97706';
        return '#dc2626';
      };

      const getScoreLabel = (score) => {
        if (score >= 75) return 'God digital tilstedeværelse';
        if (score >= 50) return 'Forbedringspotentiale';
        return 'Kritiske mangler';
      };

      return (
        <div style={{ minHeight: '100vh', background: '#fafafa' }}>
          <div className="report-container">
            {/* Header - Minimalist */}
            <div className="report-header" style={{ textAlign: 'center', paddingBottom: 24 }}>
              <p style={{ margin: '0 0 8px', color: '#9ca3af', fontSize: 12, textTransform: 'uppercase', letterSpacing: 1 }}>
                Digital Analyse
              </p>
              <h1 style={{ margin: '0 0 4px', fontSize: 28, fontWeight: 600, color: '#1a1a1a' }}>
                {business.name}
              </h1>
              <p style={{ margin: 0, color: '#6b7280', fontSize: 14 }}>
                {new Date().toLocaleDateString('da-DK', { day: 'numeric', month: 'long', year: 'numeric' })}
              </p>
            </div>

            {/* Overall Score - Clean Design */}
            <div className="report-card" style={{
              background: 'white',
              border: '1px solid #e5e7eb',
              textAlign: 'center',
              padding: '48px 32px',
            }}>
              <div style={{ position: 'relative', display: 'inline-block', marginBottom: 24 }}>
                <ProgressRing progress={overallScore} size={160} strokeWidth={8} color={getScoreColor(overallScore)} />
                <div style={{
                  position: 'absolute',
                  inset: 0,
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                }}>
                  <span style={{ fontSize: 48, fontWeight: 700, color: '#1a1a1a' }}>{overallScore}</span>
                  <span style={{ fontSize: 14, color: '#9ca3af' }}>af 100</span>
                </div>
              </div>
              <h2 style={{ margin: '0 0 8px', fontSize: 20, fontWeight: 500, color: '#1a1a1a' }}>
                {getScoreLabel(overallScore)}
              </h2>
              <p style={{ margin: 0, color: '#6b7280', fontSize: 14 }}>
                Baseret på {(results._v3moduleStatuses || []).length || 5} analysemoduler
              </p>

              {/* Inline stats */}
              <div style={{
                display: 'flex',
                justifyContent: 'center',
                gap: 32,
                marginTop: 24,
                paddingTop: 24,
                borderTop: '1px solid #f3f4f6'
              }}>
                <div>
                  <div style={{ fontSize: 24, fontWeight: 600, color: '#1a1a1a' }}>
                    {results.googleProfile?.rating || '-'}
                  </div>
                  <div style={{ fontSize: 12, color: '#9ca3af' }}>Rating</div>
                </div>
                <div>
                  <div style={{ fontSize: 24, fontWeight: 600, color: '#1a1a1a' }}>
                    {results.reviews?.totalReviews || 0}
                  </div>
                  <div style={{ fontSize: 12, color: '#9ca3af' }}>Anmeldelser</div>
                </div>
                <div>
                  <div style={{ fontSize: 24, fontWeight: 600, color: '#1a1a1a' }}>
                    #{results.competitors?.ranking?.overall || '-'}
                  </div>
                  <div style={{ fontSize: 12, color: '#9ca3af' }}>Lokal Ranking</div>
                </div>
              </div>

              {/* V3 Score Breakdown */}
              {results._v3score?.breakdown && (
                <div style={{
                  marginTop: 24,
                  paddingTop: 24,
                  borderTop: '1px solid #f3f4f6',
                  textAlign: 'left'
                }}>
                  {[
                    { label: 'Google Business', score: results._v3score.breakdown.gbp, weight: '30%' },
                    { label: 'Anmeldelser', score: results._v3score.breakdown.reviews, weight: '25%' },
                    { label: 'Website & SEO', score: results._v3score.breakdown.website, weight: '25%' },
                    { label: 'Konkurrenter', score: results._v3score.breakdown.competitors, weight: '15%' },
                    { label: 'Social & NAP', score: results._v3score.breakdown.socialNap, weight: '5%' },
                  ].map((cat, i) => (
                    <div key={i} style={{ marginBottom: i < 4 ? 12 : 0 }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                        <span style={{ fontSize: 13, color: '#374151' }}>{cat.label} <span style={{ color: '#9ca3af', fontSize: 11 }}>({cat.weight})</span></span>
                        <span style={{ fontSize: 13, fontWeight: 600, color: getScoreColor(cat.score) }}>{Math.round(cat.score || 0)}</span>
                      </div>
                      <div style={{ height: 6, background: '#f3f4f6', borderRadius: 3 }}>
                        <div style={{
                          height: '100%',
                          width: `${Math.min(100, cat.score || 0)}%`,
                          background: getScoreColor(cat.score),
                          borderRadius: 3,
                          transition: 'width 0.6s ease'
                        }} />
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Google Business Profile */}
            {results.googleProfile && (
              <div className="report-card" style={{ background: 'white', border: '1px solid #e5e7eb' }}>
                <div className="report-card-header" style={{ borderBottom: '1px solid #f3f4f6', paddingBottom: 16, marginBottom: 24 }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                    <div style={{ width: 40, height: 40, borderRadius: 10, background: '#f3f4f6', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                      <Icon name="MapPin" size={20} color="#6b7280" />
                    </div>
                    <div>
                      <h3 style={{ margin: 0, fontSize: 16, fontWeight: 600 }}>Google Business Profile</h3>
                      <p style={{ margin: '2px 0 0', color: '#9ca3af', fontSize: 13 }}>
                        Synlighed i Google søgning og Maps
                      </p>
                    </div>
                  </div>
                  <StatusBadge
                    status={calculateSignalStrength(results.googleProfile.profileCompleteness?.score || 0, { excellent: 85, good: 70, warning: 50 })}
                    text={`${results.googleProfile.profileCompleteness?.score || 0}%`}
                  />
                </div>

                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 16, marginBottom: 24 }}>
                  <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: 28, fontWeight: 600, color: '#1a1a1a' }}>{results.googleProfile.rating}</div>
                    <div style={{ fontSize: 12, color: '#9ca3af' }}>Rating</div>
                  </div>
                  <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: 28, fontWeight: 600, color: '#1a1a1a' }}>{results.googleProfile.totalReviews}</div>
                    <div style={{ fontSize: 12, color: '#9ca3af' }}>Anmeldelser</div>
                  </div>
                  <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: 28, fontWeight: 600, color: '#1a1a1a' }}>{results.googleProfile.photos?.total || 0}</div>
                    <div style={{ fontSize: 12, color: '#9ca3af' }}>Billeder</div>
                  </div>
                  <div style={{ textAlign: 'center' }}>
                    <div style={{ fontSize: 28, fontWeight: 600, color: '#1a1a1a' }}>{results.googleProfile.postsActivity?.postsLast90Days || 0}</div>
                    <div style={{ fontSize: 12, color: '#9ca3af' }}>Opslag</div>
                  </div>
                </div>

                {results.googleProfile.profileCompleteness?.missing?.length > 0 && (
                  <div style={{ borderTop: '1px solid #f3f4f6', paddingTop: 20 }}>
                    <h4 style={{ margin: '0 0 12px', fontSize: 13, color: '#9ca3af', fontWeight: 500 }}>
                      Manglende elementer
                    </h4>
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: 8 }}>
                      {results.googleProfile.profileCompleteness.missing.map((item, i) => (
                        <span key={i} style={{
                          padding: '6px 12px',
                          background: '#fef3c7',
                          color: '#92400e',
                          fontSize: 13,
                          borderRadius: 6,
                        }}>
                          {item}
                        </span>
                      ))}
                    </div>
                  </div>
                )}

                <div style={{
                  marginTop: 20,
                  padding: 16,
                  background: '#f9fafb',
                  borderRadius: 8,
                }}>
                  <p style={{ margin: 0, color: '#6b7280', fontSize: 13, lineHeight: 1.6 }}>
                    <strong style={{ color: '#374151' }}>Tip:</strong> En komplet profil har op til 70% større chance for at vises i Google's "Local Pack" (top 3 resultater).
                  </p>
                </div>
              </div>
            )}

            {/* Review Analysis */}
            {results.reviews && (
              <div className="report-card">
                <div className="report-card-header">
                  <div>
                    <h3 style={{ margin: 0, fontSize: 16, fontWeight: 600, display: 'flex', alignItems: 'center', gap: 12 }}>
                      <div style={{ width: 40, height: 40, borderRadius: 10, background: '#f3f4f6', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                        <Icon name="Star" size={20} color="#6b7280" />
                      </div>
                      Anmeldelsesanalyse
                    </h3>
                    <p style={{ margin: '4px 0 0', color: '#6b7280', fontSize: 14 }}>
                      Detaljeret analyse af dine Google anmeldelser
                    </p>
                  </div>
                  <div style={{ display: 'flex', gap: 8 }}>
                    <StatusBadge
                      status={results.reviews.signals.ratingStatus}
                      text={`${results.reviews.averageRating} rating`}
                    />
                    <StatusBadge
                      status={results.reviews.signals.velocityStatus}
                      text={`${results.reviews.velocity.monthlyAverage}/måned`}
                    />
                  </div>
                </div>

                {/* Rating Distribution */}
                <div style={{ marginBottom: 32 }}>
                  <h4 style={{ margin: '0 0 16px', fontSize: 16 }}>Rating Fordeling</h4>
                  <div style={{ display: 'flex', gap: 8 }}>
                    {results.reviews.distribution.map(d => (
                      <div key={d.stars} style={{ flex: 1, textAlign: 'center' }}>
                        <div style={{
                          height: 80,
                          background: '#f5f5f5',
                          borderRadius: 6,
                          display: 'flex',
                          flexDirection: 'column',
                          justifyContent: 'flex-end',
                          overflow: 'hidden',
                          marginBottom: 8,
                        }}>
                          <div style={{
                            height: `${d.percentage}%`,
                            background: d.stars >= 4 ? '#22c55e' : d.stars === 3 ? '#fbbf24' : '#ef4444',
                            transition: 'height 0.5s ease',
                          }} />
                        </div>
                        <div style={{ fontSize: 14, fontWeight: 600 }}>{d.stars}★</div>
                        <div style={{ fontSize: 12, color: '#6b7280' }}>{d.percentage}%</div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Key Metrics */}
                <div className="metric-grid" style={{ marginBottom: 24 }}>
                  <div className="metric-card">
                    <div className="metric-value">{results.reviews.velocity.last30Days}</div>
                    <div className="metric-label">Nye anmeldelser (30 dage)</div>
                    <span className={`metric-change ${results.reviews.velocity.trend > 0 ? 'metric-positive' : results.reviews.velocity.trend < 0 ? 'metric-negative' : 'metric-neutral'}`}>
                      {results.reviews.velocity.trend > 0 ? <TrendUpIcon /> : results.reviews.velocity.trend < 0 ? <TrendDownIcon /> : null}
                      {results.reviews.velocity.trend > 0 ? '+' : ''}{results.reviews.velocity.trend}% vs forrige
                    </span>
                  </div>
                  <div className="metric-card">
                    <div className="metric-value">{results.reviews.responseMetrics.responseRate}%</div>
                    <div className="metric-label">Svarrate på anmeldelser</div>
                    <StatusBadge
                      status={results.reviews.signals.responseRateStatus}
                      text={results.reviews.signals.responseRateStatus === 'critical' ? 'For lav' : results.reviews.signals.responseRateStatus === 'warning' ? 'Kan forbedres' : 'God'}
                    />
                  </div>
                  <div className="metric-card">
                    <div className="metric-value">{results.reviews.responseMetrics.avgResponseTimeHours}t</div>
                    <div className="metric-label">Gns. svartid</div>
                    <span className={`metric-change ${parseInt(results.reviews.responseMetrics.avgResponseTimeHours) <= 24 ? 'metric-positive' : 'metric-warning'}`}>
                      {parseInt(results.reviews.responseMetrics.avgResponseTimeHours) <= 24 ? 'Inden for 24 timer' : 'Over 24 timer'}
                    </span>
                  </div>
                </div>

                {/* Top Keywords */}
                {results.reviews.topKeywords?.length > 0 && (
                  <div style={{ marginBottom: 24 }}>
                    <h4 style={{ margin: '0 0 12px', fontSize: 16 }}>Hyppigste Nøgleord i Anmeldelser</h4>
                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: 8 }}>
                      {results.reviews.topKeywords.map((kw, i) => (
                        <span key={i} style={{
                          padding: '6px 14px',
                          borderRadius: 20,
                          fontSize: 13,
                          background: kw.sentiment === 'positive' ? '#d1fae5' : '#fee2e2',
                          color: kw.sentiment === 'positive' ? '#059669' : '#dc2626',
                        }}>
                          {kw.term} ({kw.count})
                        </span>
                      ))}
                    </div>
                  </div>
                )}

                {/* Signals */}
                <div className="signal-item" style={{ background: results.reviews.signals.responseRateStatus === 'critical' || results.reviews.signals.responseRateStatus === 'warning' ? '#fef2f2' : '#f0fdf4' }}>
                  <div className="signal-icon" style={{ background: results.reviews.signals.responseRateStatus === 'critical' ? '#fee2e2' : '#d1fae5' }}>
                    {results.reviews.signals.responseRateStatus === 'critical' || results.reviews.signals.responseRateStatus === 'warning' ? '⚠️' : '✅'}
                  </div>
                  <div className="signal-content">
                    <div className="signal-title">
                      {parseInt(results.reviews.responseMetrics.responseRate) < 50
                        ? 'Lav svarrate på anmeldelser'
                        : 'God håndtering af anmeldelser'}
                    </div>
                    <div className="signal-description">
                      {parseInt(results.reviews.responseMetrics.responseRate) < 50
                        ? `Du svarer kun på ${results.reviews.responseMetrics.responseRate}% af anmeldelserne. Virksomheder der svarer på mere end 50% af anmeldelser ses som mere troværdige og rangerer højere.`
                        : `Du svarer på ${results.reviews.responseMetrics.responseRate}% af anmeldelserne. Dette sender et positivt signal til Google om aktiv kundeengagement.`}
                    </div>
                    <span className={`signal-impact ${parseInt(results.reviews.responseMetrics.responseRate) < 50 ? 'status-warning' : 'status-good'}`}>
                      {parseInt(results.reviews.responseMetrics.responseRate) < 50 ? 'Negativ påvirkning på ranking' : 'Positiv påvirkning på ranking'}
                    </span>
                  </div>
                </div>
              </div>
            )}

            {/* Competitor Analysis */}
            {results.competitors && (
              <div className="report-card">
                <div className="report-card-header">
                  <div>
                    <h3 style={{ margin: 0, fontSize: 16, fontWeight: 600, display: 'flex', alignItems: 'center', gap: 12 }}>
                      <div style={{ width: 40, height: 40, borderRadius: 10, background: '#f3f4f6', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                        <Icon name="Target" size={20} color="#6b7280" />
                      </div>
                      Konkurrentanalyse
                    </h3>
                    <p style={{ margin: '4px 0 0', color: '#6b7280', fontSize: 14 }}>
                      Din position sammenlignet med {results.competitors.directCompetitors} nærmeste konkurrenter inden for {results.competitors.searchRadius}
                    </p>
                  </div>
                  <StatusBadge
                    status={results.competitors.ranking.overall <= 2 ? 'good' : results.competitors.ranking.overall <= 4 ? 'warning' : 'critical'}
                    text={`#${results.competitors.ranking.overall} i området`}
                  />
                </div>

                {/* Competitor Table */}
                <div style={{ marginBottom: 24, border: '1px solid #e5e5e5', borderRadius: 12, overflow: 'hidden' }}>
                  <div className="competitor-row header" style={{ background: '#f9fafb' }}>
                    <div>Virksomhed</div>
                    <div style={{ textAlign: 'center' }}>Rating</div>
                    <div style={{ textAlign: 'center' }}>Anmeldelser</div>
                    <div style={{ textAlign: 'center' }}>Svarrate</div>
                    <div style={{ textAlign: 'center' }}>Aktivitet</div>
                  </div>
                  {results.competitors.competitors.map((comp, i) => (
                    <div key={i} className={`competitor-row ${comp.isTarget ? 'competitor-highlight' : ''}`}>
                      <div>
                        <div style={{ fontWeight: comp.isTarget ? 600 : 400 }}>
                          {comp.name} {comp.isTarget && <span style={{ color: '#667eea' }}>(Din)</span>}
                        </div>
                        {comp.distance && <div style={{ fontSize: 12, color: '#6b7280' }}>{comp.distance}</div>}
                      </div>
                      <div style={{ textAlign: 'center', fontWeight: 500 }}>
                        <span style={{ color: comp.rating >= 4.5 ? '#059669' : comp.rating >= 4.0 ? '#2563eb' : '#d97706' }}>
                          {comp.rating} ⭐
                        </span>
                      </div>
                      <div style={{ textAlign: 'center' }}>{comp.reviews}</div>
                      <div style={{ textAlign: 'center' }}>{comp.responseRate}%</div>
                      <div style={{ textAlign: 'center', fontSize: 13 }}>{comp.recentActivity}</div>
                    </div>
                  ))}
                </div>

                {/* Insights */}
                <h4 style={{ margin: '0 0 12px', fontSize: 14, color: '#6b7280', textTransform: 'uppercase', letterSpacing: 0.5 }}>
                  Konkurrencemæssige Indsigter
                </h4>
                {results.competitors.insights.map((insight, i) => (
                  <div key={i} className="signal-item" style={{
                    background: insight.type === 'warning' ? '#fef2f2' : insight.type === 'opportunity' ? '#eff6ff' : '#f0fdf4'
                  }}>
                    <div className="signal-icon" style={{
                      background: insight.type === 'warning' ? '#fee2e2' : insight.type === 'opportunity' ? '#dbeafe' : '#d1fae5'
                    }}>
                      {insight.type === 'warning' ? '⚠️' : insight.type === 'opportunity' ? '💡' : '✅'}
                    </div>
                    <div className="signal-content">
                      <div className="signal-title">{insight.title}</div>
                      <div className="signal-description">{insight.description}</div>
                      <span className={`signal-impact ${insight.type === 'warning' ? 'status-warning' : insight.type === 'opportunity' ? 'status-good' : 'status-excellent'}`}>
                        {insight.impact}
                      </span>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* NAP Consistency */}
            {results.napConsistency && (
              <div className="report-card">
                <div className="report-card-header">
                  <div>
                    <h3 style={{ margin: 0, fontSize: 16, fontWeight: 600, display: 'flex', alignItems: 'center', gap: 12 }}>
                      <div style={{ width: 40, height: 40, borderRadius: 10, background: '#f3f4f6', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                        <Icon name="Link" size={20} color="#6b7280" />
                      </div>
                      NAP Konsistens
                    </h3>
                    <p style={{ margin: '4px 0 0', color: '#6b7280', fontSize: 14 }}>
                      Navn, Adresse og Telefon på tværs af online platforme
                    </p>
                  </div>
                  <StatusBadge
                    status={calculateSignalStrength(results.napConsistency.consistencyScore, { excellent: 90, good: 75, warning: 50 })}
                    text={`${results.napConsistency.consistencyScore}% konsistent`}
                  />
                </div>

                <div style={{ marginBottom: 24 }}>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: 12 }}>
                    {results.napConsistency.sources.map((source, i) => (
                      <div key={i} style={{
                        padding: 16,
                        borderRadius: 10,
                        border: '1px solid #e5e5e5',
                        background: !source.found ? '#f9fafb' : source.nameMatch && source.addressMatch && source.phoneMatch ? '#f0fdf4' : '#fef3c7',
                      }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8 }}>
                          <span style={{ fontWeight: 600, fontSize: 14 }}>{source.name}</span>
                          {!source.found ? (
                            <span style={{ fontSize: 12, color: '#6b7280' }}>Ikke fundet</span>
                          ) : source.nameMatch && source.addressMatch && source.phoneMatch ? (
                            <span style={{ color: '#059669' }}>✓</span>
                          ) : (
                            <span style={{ color: '#d97706' }}>⚠</span>
                          )}
                        </div>
                        {source.found && (
                          <div style={{ display: 'flex', gap: 8, fontSize: 11 }}>
                            <span style={{ color: source.nameMatch ? '#059669' : '#dc2626' }}>Navn {source.nameMatch ? '✓' : '✗'}</span>
                            <span style={{ color: source.addressMatch ? '#059669' : '#dc2626' }}>Adresse {source.addressMatch ? '✓' : '✗'}</span>
                            <span style={{ color: source.phoneMatch ? '#059669' : '#dc2626' }}>Tlf {source.phoneMatch ? '✓' : '✗'}</span>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>

                {results.napConsistency.issues.length > 0 && (
                  <>
                    <h4 style={{ margin: '0 0 12px', fontSize: 14, color: '#6b7280', textTransform: 'uppercase', letterSpacing: 0.5 }}>
                      Fundne Problemer
                    </h4>
                    {results.napConsistency.issues.filter(i => i.severity === 'high').map((issue, i) => (
                      <div key={i} className="signal-item" style={{ background: '#fef2f2' }}>
                        <div className="signal-icon" style={{ background: '#fee2e2' }}>⚠️</div>
                        <div className="signal-content">
                          <div className="signal-title">{issue.platform}</div>
                          <div className="signal-description">{issue.issue}</div>
                          <span className="signal-impact status-critical">Høj prioritet - påvirker lokal SEO</span>
                        </div>
                      </div>
                    ))}
                  </>
                )}

                <div style={{
                  marginTop: 24,
                  padding: 16,
                  background: '#f0f9ff',
                  borderRadius: 12,
                  border: '1px solid #bae6fd'
                }}>
                  <strong style={{ color: '#0369a1' }}>Hvorfor NAP konsistens er vigtigt:</strong>
                  <p style={{ margin: '8px 0 0', color: '#0369a1', fontSize: 14 }}>
                    Google bruger NAP-data fra mange kilder til at verificere din virksomhed. Inkonsistente oplysninger
                    skaber forvirring og kan reducere din troværdighed, hvilket direkte påvirker din placering i lokale søgeresultater.
                  </p>
                </div>
              </div>
            )}

            {/* Website Analysis */}
            {results.website && (
              <div className="report-card">
                <div className="report-card-header">
                  <div>
                    <h3 style={{ margin: 0, fontSize: 16, fontWeight: 600, display: 'flex', alignItems: 'center', gap: 12 }}>
                      <div style={{ width: 40, height: 40, borderRadius: 10, background: '#f3f4f6', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                        <Icon name="Globe" size={20} color="#6b7280" />
                      </div>
                      Website & Mobil Oplevelse
                    </h3>
                    <p style={{ margin: '4px 0 0', color: '#6b7280', fontSize: 14 }}>
                      {results.website.hasWebsite ? results.website.url : 'Ingen hjemmeside registreret'}
                    </p>
                  </div>
                  {results.website.hasWebsite && (
                    <StatusBadge
                      status={calculateSignalStrength(results.website.scores.mobile, { excellent: 80, good: 60, warning: 40 })}
                      text={`Mobil: ${results.website.scores.mobile}/100`}
                    />
                  )}
                </div>

                {results.website.hasWebsite ? (
                  <>
                    <div className="metric-grid" style={{ marginBottom: 24 }}>
                      <div className="metric-card">
                        <div className="metric-value" style={{ color: results.website.scores.mobile >= 70 ? '#059669' : '#d97706' }}>
                          {results.website.scores.mobile}
                        </div>
                        <div className="metric-label">Mobil Score</div>
                      </div>
                      <div className="metric-card">
                        <div className="metric-value">{results.website.scores.desktop}</div>
                        <div className="metric-label">Desktop Score</div>
                      </div>
                      <div className="metric-card">
                        <div className="metric-value">{results.website.scores.seo}</div>
                        <div className="metric-label">SEO Score</div>
                      </div>
                      <div className="metric-card">
                        <div className="metric-value">{results.website.scores.performance}</div>
                        <div className="metric-label">Performance</div>
                      </div>
                    </div>

                    {/* Core Web Vitals */}
                    <h4 style={{ margin: '0 0 12px', fontSize: 16 }}>Core Web Vitals</h4>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 16, marginBottom: 24 }}>
                      {Object.entries(results.website.coreWebVitals).map(([key, data]) => (
                        <div key={key} style={{
                          padding: 16,
                          borderRadius: 10,
                          background: data.rating === 'good' ? '#f0fdf4' : data.rating === 'needs-improvement' ? '#fef3c7' : '#fef2f2',
                          border: `1px solid ${data.rating === 'good' ? '#bbf7d0' : data.rating === 'needs-improvement' ? '#fde68a' : '#fecaca'}`,
                        }}>
                          <div style={{ fontSize: 12, color: '#6b7280', marginBottom: 4 }}>{key}</div>
                          <div style={{ fontSize: 24, fontWeight: 700 }}>{data.value}</div>
                          <div style={{ fontSize: 11, color: '#6b7280' }}>Mål: {data.target}</div>
                        </div>
                      ))}
                    </div>

                    {/* Local SEO Checklist */}
                    <h4 style={{ margin: '0 0 12px', fontSize: 16 }}>Lokal SEO Tjekliste</h4>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 8, marginBottom: 24 }}>
                      {Object.entries(results.website.localSEO).map(([key, value]) => (
                        <div key={key} style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: 8,
                          padding: '8px 12px',
                          background: value ? '#f0fdf4' : '#fef2f2',
                          borderRadius: 8,
                        }}>
                          <span style={{ color: value ? '#059669' : '#dc2626' }}>{value ? '✓' : '✗'}</span>
                          <span style={{ fontSize: 13 }}>
                            {key === 'hasSchemaMarkup' && 'Schema Markup'}
                            {key === 'hasLocalBusinessSchema' && 'LocalBusiness Schema'}
                            {key === 'hasOpenGraph' && 'Open Graph Tags'}
                            {key === 'hasContactPage' && 'Kontaktside'}
                            {key === 'hasEmbeddedMap' && 'Indlejret Google Maps'}
                            {key === 'mobileResponsive' && 'Mobil Responsiv'}
                          </span>
                        </div>
                      ))}
                    </div>

                    {/* Issues */}
                    {results.website.issues.length > 0 && (
                      <>
                        <h4 style={{ margin: '0 0 12px', fontSize: 14, color: '#6b7280', textTransform: 'uppercase', letterSpacing: 0.5 }}>
                          Kritiske Problemer
                        </h4>
                        {results.website.issues.filter(i => i.severity === 'high').map((issue, i) => (
                          <div key={i} className="signal-item" style={{ background: '#fef2f2' }}>
                            <div className="signal-icon" style={{ background: '#fee2e2' }}>⚠️</div>
                            <div className="signal-content">
                              <div className="signal-title">{issue.issue}</div>
                              <div className="signal-description">{issue.impact}</div>
                              <span className="signal-impact status-critical">Høj prioritet</span>
                            </div>
                          </div>
                        ))}
                      </>
                    )}
                  </>
                ) : (
                  <div className="signal-item" style={{ background: '#fef2f2' }}>
                    <div className="signal-icon" style={{ background: '#fee2e2' }}>⚠️</div>
                    <div className="signal-content">
                      <div className="signal-title">Ingen hjemmeside registreret</div>
                      <div className="signal-description">
                        {results.website.recommendation}
                      </div>
                      <span className="signal-impact status-critical">Kritisk - mistes potentielle kunder</span>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Social Media */}
            {results.social && (
              <div className="report-card">
                <div className="report-card-header">
                  <div>
                    <h3 style={{ margin: 0, fontSize: 20 }}>📣 Social Media Tilstedeværelse</h3>
                    <p style={{ margin: '4px 0 0', color: '#6b7280', fontSize: 14 }}>
                      Din synlighed på sociale platforme
                    </p>
                  </div>
                  <StatusBadge
                    status={calculateSignalStrength(results.social.overallScore, { excellent: 70, good: 50, warning: 30 })}
                    text={`${results.social.overallScore}% score`}
                  />
                </div>

                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: 16, marginBottom: 24 }}>
                  {results.social.platforms.map((platform, i) => (
                    <div key={i} style={{
                      padding: 20,
                      borderRadius: 12,
                      background: platform.found ? '#f9fafb' : '#fef2f2',
                      border: `1px solid ${platform.found ? '#e5e5e5' : '#fecaca'}`,
                    }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                        <span style={{ fontWeight: 600 }}>{platform.name}</span>
                        {platform.found ? (
                          <span style={{
                            fontSize: 11,
                            padding: '2px 8px',
                            borderRadius: 10,
                            background: platform.status === 'very_active' ? '#d1fae5' : platform.status === 'active' ? '#dbeafe' : '#fef3c7',
                            color: platform.status === 'very_active' ? '#059669' : platform.status === 'active' ? '#2563eb' : '#d97706',
                          }}>
                            {platform.status === 'very_active' ? 'Meget aktiv' : platform.status === 'active' ? 'Aktiv' : 'Lav aktivitet'}
                          </span>
                        ) : (
                          <span style={{ fontSize: 11, color: '#dc2626' }}>Ikke fundet</span>
                        )}
                      </div>
                      {platform.found ? (
                        <>
                          <div style={{ fontSize: 28, fontWeight: 700 }}>{formatNumber(platform.followers)}</div>
                          <div style={{ fontSize: 13, color: '#6b7280' }}>følgere</div>
                          <div style={{ marginTop: 8, fontSize: 12, color: '#6b7280' }}>
                            {platform.posts30Days} opslag (30 dage) • {platform.engagement}% engagement
                          </div>
                        </>
                      ) : (
                        <div style={{ color: '#dc2626', fontSize: 13 }}>
                          Opret profil for at nå flere kunder
                        </div>
                      )}
                    </div>
                  ))}
                </div>

                {/* Insights */}
                {results.social.insights.map((insight, i) => (
                  <div key={i} className="signal-item" style={{
                    background: insight.type === 'positive' ? '#f0fdf4' : insight.type === 'warning' ? '#fef3c7' : '#eff6ff'
                  }}>
                    <div className="signal-icon" style={{
                      background: insight.type === 'positive' ? '#d1fae5' : insight.type === 'warning' ? '#fde68a' : '#dbeafe'
                    }}>
                      {insight.type === 'positive' ? '✅' : insight.type === 'warning' ? '⚠️' : '💡'}
                    </div>
                    <div className="signal-content">
                      <div className="signal-description">{insight.text}</div>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* FUTURE VISION - Preview af forbedret tilstedeværelse */}
            <div className="report-card" style={{
              background: 'linear-gradient(135deg, #0f172a 0%, #1e293b 100%)',
              color: 'white',
              overflow: 'hidden',
              position: 'relative'
            }}>
              <div style={{
                position: 'absolute',
                top: -50,
                right: -50,
                width: 200,
                height: 200,
                background: 'radial-gradient(circle, rgba(102, 126, 234, 0.3) 0%, transparent 70%)',
                borderRadius: '50%',
              }} />
              <div className="report-card-header" style={{ borderColor: 'rgba(255,255,255,0.1)' }}>
                <div>
                  <span style={{
                    display: 'inline-block',
                    padding: '4px 12px',
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    borderRadius: 20,
                    fontSize: 11,
                    fontWeight: 600,
                    marginBottom: 8,
                  }}>
                    PREVIEW AF DIN FREMTID
                  </span>
                  <h3 style={{ margin: 0, fontSize: 24 }}>🚀 Sådan vil din digitale tilstedeværelse se ud</h3>
                  <p style={{ margin: '8px 0 0', color: 'rgba(255,255,255,0.7)', fontSize: 14 }}>
                    Med vores optimering kan du forvente disse forbedringer inden for 3-6 måneder
                  </p>
                </div>
              </div>

              {/* Before/After Score Comparison */}
              <div style={{
                display: 'grid',
                gridTemplateColumns: '1fr auto 1fr',
                gap: 32,
                marginBottom: 32,
                alignItems: 'center'
              }}>
                <div style={{ textAlign: 'center', padding: 24, background: 'rgba(255,255,255,0.05)', borderRadius: 16 }}>
                  <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.5)', marginBottom: 8, textTransform: 'uppercase', letterSpacing: 1 }}>I dag</div>
                  <div style={{ fontSize: 56, fontWeight: 700, color: '#fbbf24' }}>{overallScore}</div>
                  <div style={{ fontSize: 14, color: 'rgba(255,255,255,0.6)' }}>Digital Score</div>
                </div>
                <div style={{
                  width: 60,
                  height: 60,
                  background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                  borderRadius: '50%',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontSize: 24,
                }}>
                  →
                </div>
                <div style={{ textAlign: 'center', padding: 24, background: 'rgba(34, 197, 94, 0.1)', borderRadius: 16, border: '2px solid rgba(34, 197, 94, 0.3)' }}>
                  <div style={{ fontSize: 12, color: '#4ade80', marginBottom: 8, textTransform: 'uppercase', letterSpacing: 1 }}>Potentiale</div>
                  <div style={{ fontSize: 56, fontWeight: 700, color: '#22c55e' }}>{Math.min(95, overallScore + 28)}</div>
                  <div style={{ fontSize: 14, color: 'rgba(255,255,255,0.6)' }}>Digital Score</div>
                  <div style={{ fontSize: 12, color: '#4ade80', marginTop: 4 }}>+{Math.min(95, overallScore + 28) - overallScore} point</div>
                </div>
              </div>

              {/* Projected Improvements */}
              <div style={{ marginBottom: 32 }}>
                <h4 style={{ margin: '0 0 16px', fontSize: 16, color: 'rgba(255,255,255,0.9)' }}>Forventede Forbedringer</h4>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: 12 }}>
                  {[
                    { label: 'Google Ranking', current: `#${results.competitors?.ranking?.overall || 4}`, future: '#1-2', icon: '📍' },
                    { label: 'Anmeldelser/md', current: results.reviews?.velocity?.monthlyAverage || '3', future: '8-12', icon: '⭐' },
                    { label: 'Svarrate', current: `${results.reviews?.responseMetrics?.responseRate || 35}%`, future: '95%+', icon: '💬' },
                    { label: 'Mobil Score', current: results.website?.scores?.mobile || 67, future: '90+', icon: '📱' },
                  ].map((item, i) => (
                    <div key={i} style={{
                      padding: 16,
                      background: 'rgba(255,255,255,0.05)',
                      borderRadius: 12,
                      display: 'flex',
                      alignItems: 'center',
                      gap: 12,
                    }}>
                      <div style={{ fontSize: 24 }}>{item.icon}</div>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.5)' }}>{item.label}</div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginTop: 4 }}>
                          <span style={{ color: '#fbbf24', fontWeight: 600 }}>{item.current}</span>
                          <span style={{ color: 'rgba(255,255,255,0.3)' }}>→</span>
                          <span style={{ color: '#4ade80', fontWeight: 600 }}>{item.future}</span>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Visual Mockups */}
              <div style={{ marginBottom: 24 }}>
                <h4 style={{ margin: '0 0 16px', fontSize: 16, color: 'rgba(255,255,255,0.9)' }}>Preview: Din Optimerede Google Business Profil</h4>
                <div style={{
                  background: 'white',
                  borderRadius: 12,
                  padding: 24,
                  color: '#1a1a1a',
                }}>
                  {/* Google Business Card Mockup */}
                  <div style={{ display: 'flex', gap: 20 }}>
                    <div style={{
                      width: 120,
                      height: 120,
                      background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                      borderRadius: 8,
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      color: 'white',
                      fontSize: 36,
                      fontWeight: 700,
                    }}>
                      {business.name.charAt(0)}
                    </div>
                    <div style={{ flex: 1 }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                        <h3 style={{ margin: 0, fontSize: 20 }}>{business.name}</h3>
                        <span style={{
                          background: '#1a73e8',
                          color: 'white',
                          fontSize: 10,
                          padding: '2px 6px',
                          borderRadius: 4,
                          fontWeight: 600
                        }}>
                          ✓ Verificeret
                        </span>
                      </div>
                      <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8 }}>
                        <span style={{ color: '#fbbf24', fontSize: 16 }}>★★★★★</span>
                        <span style={{ fontWeight: 600 }}>4.8</span>
                        <span style={{ color: '#6b7280' }}>(250+ anmeldelser)</span>
                      </div>
                      <div style={{ fontSize: 14, color: '#6b7280', marginBottom: 4 }}>Restaurant • €€ • {business.address || 'Aarhus'}</div>
                      <div style={{ display: 'flex', gap: 8, marginTop: 12 }}>
                        <span style={{
                          padding: '6px 12px',
                          background: '#e8f0fe',
                          color: '#1a73e8',
                          borderRadius: 20,
                          fontSize: 12,
                          fontWeight: 500
                        }}>
                          📞 Ring op
                        </span>
                        <span style={{
                          padding: '6px 12px',
                          background: '#e8f0fe',
                          color: '#1a73e8',
                          borderRadius: 20,
                          fontSize: 12,
                          fontWeight: 500
                        }}>
                          🗺️ Rutevejledning
                        </span>
                        <span style={{
                          padding: '6px 12px',
                          background: '#e8f0fe',
                          color: '#1a73e8',
                          borderRadius: 20,
                          fontSize: 12,
                          fontWeight: 500
                        }}>
                          🌐 Website
                        </span>
                      </div>
                    </div>
                  </div>

                  {/* Features row */}
                  <div style={{
                    display: 'flex',
                    gap: 16,
                    marginTop: 20,
                    paddingTop: 16,
                    borderTop: '1px solid #e5e5e5',
                    flexWrap: 'wrap'
                  }}>
                    {['Menu tilgængelig', 'Online bestilling', 'Bordreservation', 'Takeaway', 'Udendørs siddepladser'].map((feature, i) => (
                      <span key={i} style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: 4,
                        fontSize: 12,
                        color: '#059669'
                      }}>
                        <span style={{ color: '#22c55e' }}>✓</span> {feature}
                      </span>
                    ))}
                  </div>
                </div>
              </div>

              {/* Website Preview */}
              <div style={{ marginBottom: 24 }}>
                <h4 style={{ margin: '0 0 16px', fontSize: 16, color: 'rgba(255,255,255,0.9)' }}>Preview: Din Optimerede Hjemmeside</h4>
                <div style={{
                  background: '#f8fafc',
                  borderRadius: 12,
                  overflow: 'hidden',
                }}>
                  {/* Browser Chrome */}
                  <div style={{
                    background: '#e2e8f0',
                    padding: '8px 12px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: 8
                  }}>
                    <div style={{ display: 'flex', gap: 4 }}>
                      <div style={{ width: 10, height: 10, borderRadius: '50%', background: '#ef4444' }} />
                      <div style={{ width: 10, height: 10, borderRadius: '50%', background: '#fbbf24' }} />
                      <div style={{ width: 10, height: 10, borderRadius: '50%', background: '#22c55e' }} />
                    </div>
                    <div style={{
                      flex: 1,
                      background: 'white',
                      padding: '4px 12px',
                      borderRadius: 4,
                      fontSize: 11,
                      color: '#64748b'
                    }}>
                      {results.website?.url || `${business.name.toLowerCase().replace(/\s+/g, '')}.dk`}
                    </div>
                  </div>

                  {/* Website Content */}
                  <div style={{ padding: 20, color: '#1a1a1a' }}>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
                      <div>
                        <div style={{
                          background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                          height: 100,
                          borderRadius: 8,
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          color: 'white',
                          fontWeight: 700,
                          fontSize: 18,
                          marginBottom: 12
                        }}>
                          {business.name}
                        </div>
                        <div style={{ fontSize: 11, color: '#64748b', marginBottom: 8 }}>
                          <span style={{ color: '#22c55e', fontWeight: 600 }}>✓ Schema Markup</span> • Struktureret data
                        </div>
                        <div style={{ fontSize: 11, color: '#64748b' }}>
                          <span style={{ color: '#22c55e', fontWeight: 600 }}>✓ Core Web Vitals</span> • LCP 1.8s
                        </div>
                      </div>
                      <div>
                        <div style={{
                          background: '#f1f5f9',
                          padding: 12,
                          borderRadius: 8,
                          fontSize: 11,
                          marginBottom: 8
                        }}>
                          <div style={{ fontWeight: 600, marginBottom: 4, color: '#334155' }}>📍 Kontakt</div>
                          <div style={{ color: '#64748b' }}>{business.address || 'Vestergade 12, 8000 Aarhus'}</div>
                        </div>
                        <div style={{
                          background: '#f1f5f9',
                          padding: 12,
                          borderRadius: 8,
                          fontSize: 11
                        }}>
                          <div style={{ fontWeight: 600, marginBottom: 4, color: '#334155' }}>🗺️ Indlejret Google Maps</div>
                          <div style={{ color: '#64748b' }}>Find os nemt</div>
                        </div>
                      </div>
                    </div>

                    <div style={{
                      marginTop: 16,
                      padding: 12,
                      background: '#f0fdf4',
                      borderRadius: 8,
                      border: '1px solid #bbf7d0',
                      display: 'flex',
                      alignItems: 'center',
                      gap: 12
                    }}>
                      <span style={{ fontSize: 20 }}>📱</span>
                      <div>
                        <div style={{ fontSize: 12, fontWeight: 600, color: '#166534' }}>100% Mobil-optimeret</div>
                        <div style={{ fontSize: 11, color: '#16a34a' }}>Hurtig indlæsning på alle enheder</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* What You Get */}
              <div style={{
                background: 'rgba(255,255,255,0.05)',
                borderRadius: 12,
                padding: 24,
                border: '1px solid rgba(255,255,255,0.1)'
              }}>
                <h4 style={{ margin: '0 0 16px', fontSize: 16 }}>Dette får du med vores samarbejde:</h4>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: 12 }}>
                  {[
                    { icon: '📍', title: 'Google Business Optimering', desc: 'Komplet profil med alle signaler aktiveret' },
                    { icon: '⭐', title: 'Anmeldelsesstrategi', desc: 'System til at generere flere positive anmeldelser' },
                    { icon: '🔗', title: 'NAP Konsistens', desc: 'Ensrettede oplysninger på alle platforme' },
                    { icon: '📱', title: 'Website Optimering', desc: 'Hurtig, mobil-venlig side med lokal SEO' },
                    { icon: '📊', title: 'Løbende Rapportering', desc: 'Månedlige opdateringer på dine fremskridt' },
                    { icon: '🎯', title: 'Konkurrentovervågning', desc: 'Hold øje med hvad konkurrenterne gør' },
                  ].map((item, i) => (
                    <div key={i} style={{ display: 'flex', alignItems: 'flex-start', gap: 12 }}>
                      <span style={{ fontSize: 20 }}>{item.icon}</span>
                      <div>
                        <div style={{ fontWeight: 600, fontSize: 14, marginBottom: 2 }}>{item.title}</div>
                        <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.6)' }}>{item.desc}</div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* Action Plan - Dynamic from v3 */}
            {(() => {
              const ap = results._v3actionPlan || {};
              const week1 = ap.week1 || [];
              const days30 = ap.days30 || [];
              const days90 = ap.days90 || [];
              const allActions = [
                ...week1.map(a => ({ ...a, phase: 'Uge 1', phaseBg: '#fef2f2', phaseColor: '#dc2626', priority: 'high' })),
                ...days30.map(a => ({ ...a, phase: '30 dage', phaseBg: '#fffbeb', phaseColor: '#d97706', priority: 'medium' })),
                ...days90.map(a => ({ ...a, phase: '90 dage', phaseBg: '#f0fdf4', phaseColor: '#059669', priority: 'low' })),
              ];
              if (allActions.length === 0) return null;

              return (
                <div className="report-card" style={{ background: 'linear-gradient(135deg, #667eea08 0%, #764ba208 100%)' }}>
                  <div className="report-card-header">
                    <div>
                      <h3 style={{ margin: 0, fontSize: 16, fontWeight: 600 }}>Prioriteret Handlingsplan</h3>
                      <p style={{ margin: '4px 0 0', color: '#6b7280', fontSize: 14 }}>
                        Konkrete tiltag baseret på din analyse
                      </p>
                    </div>
                  </div>

                  <div style={{ marginBottom: 24 }}>
                    {allActions.map((item, i) => (
                      <div key={i} className="action-item">
                        <div className={`action-priority priority-${item.priority}`}>
                          {i + 1}
                        </div>
                        <div style={{ flex: 1 }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 2 }}>
                            <span style={{ fontWeight: 600 }}>{item.task}</span>
                            <span style={{
                              fontSize: 10,
                              padding: '2px 6px',
                              borderRadius: 4,
                              background: item.phaseBg,
                              color: item.phaseColor,
                              fontWeight: 600
                            }}>{item.phase}</span>
                          </div>
                          <div style={{ fontSize: 13, color: '#6b7280' }}>{item.detail}</div>
                          {item.kpi && (
                            <span style={{
                              fontSize: 11,
                              color: item.phaseColor,
                              marginTop: 4,
                              display: 'inline-block',
                            }}>
                              KPI: {item.kpi}
                            </span>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              );
            })()}

            {/* CTA */}
            <div style={{ textAlign: 'center', marginTop: 48 }}>
              <button
                onClick={onNewScan}
                style={{
                  padding: '16px 40px',
                  background: 'white',
                  color: '#667eea',
                  border: '2px solid #667eea',
                  borderRadius: 12,
                  fontSize: 16,
                  fontWeight: 600,
                  cursor: 'pointer',
                  marginRight: 16,
                  display: 'inline-flex',
                  alignItems: 'center',
                  gap: 8,
                }}
              >
                <Icon name="Search" size={18} color="#667eea" />
                Ny analyse
              </button>
              <button
                onClick={() => {
                  const doc = pdfGenerator.generate({
                    business: business,
                    scanDate: new Date(),
                    overallScore: overallScore,
                    results: results,
                    findings: findings || [],
                    findingsCount: findings?.length || 0,
                  });
                  doc.save(`synlighedsrapport_${business.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
                }}
                style={{
                  padding: '16px 40px',
                  background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                  color: 'white',
                  border: 'none',
                  borderRadius: 12,
                  fontSize: 16,
                  fontWeight: 600,
                  cursor: 'pointer',
                  display: 'inline-flex',
                  alignItems: 'center',
                  gap: 8,
                }}
              >
                <Icon name="Download" size={18} color="white" />
                Download PDF
              </button>
            </div>
          </div>
        </div>
      );
    };

    // =============================================================================
    // MAIN APP
    // =============================================================================
    function App() {
      const [selectedBusiness, setSelectedBusiness] = useState(null);

      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const name = params.get('name');
        const placeId = params.get('place_id') || '';
        const address = params.get('address') || '';
        const website = params.get('website') || '';

        if (name) {
          setSelectedBusiness({
            name: name,
            place_id: placeId,
            address: address,
            website: website
          });
        }
      }, []);

      const handleBusinessSelect = (business) => {
        // Update URL with business params
        const params = new URLSearchParams();
        params.set('name', business.name || '');
        if (business.place_id) params.set('place_id', business.place_id);
        if (business.address) params.set('address', business.address);
        if (business.website) params.set('website', business.website);
        window.history.replaceState({}, '', '/search-engine?' + params.toString());
        setSelectedBusiness(business);
      };

      const handleBack = () => {
        setSelectedBusiness(null);
        window.history.replaceState({}, '', '/search-engine');
      };

      return (
        <div>
          {/* Top navigation bar */}
          <div style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            padding: '12px 24px',
            borderBottom: '1px solid #e5e7eb',
            background: 'white',
            position: 'sticky',
            top: 0,
            zIndex: 50,
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
              <span style={{ fontWeight: 700, fontSize: 15 }}>Agent SEO Scanner</span>
              <span style={{
                fontSize: 11,
                padding: '3px 8px',
                borderRadius: 999,
                background: 'linear-gradient(135deg, #667eea20, #764ba220)',
                border: '1px solid #667eea40',
                color: '#667eea',
                fontWeight: 600,
              }}>v3</span>
            </div>
            <a href="/how-it-works" style={{
              color: '#667eea',
              textDecoration: 'none',
              fontSize: 14,
              fontWeight: 500,
              display: 'flex',
              alignItems: 'center',
              gap: 6,
            }}>
              ← Tilbage til Sådan virker det
            </a>
          </div>

          {selectedBusiness ? (
            <AnalysisScanner business={selectedBusiness} onBack={handleBack} />
          ) : (
            <BusinessSearch onBusinessSelect={handleBusinessSelect} />
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
