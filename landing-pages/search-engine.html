<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent SEO v3 - Public Scanner</title>
  <meta name="description" content="Public SEO scanner drevet af Agent SEO v3.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1020;
      --bg-soft: #121a31;
      --card: #111827;
      --card-2: #1f2937;
      --text: #f3f4f6;
      --muted: #9ca3af;
      --border: rgba(255, 255, 255, 0.14);
      --primary: #7c3aed;
      --primary-2: #4f46e5;
      --ok: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --radius: 14px;
      --shadow: 0 20px 48px rgba(0, 0, 0, 0.35);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(124, 58, 237, 0.3), transparent 50%),
        radial-gradient(1000px 600px at 100% 0%, rgba(79, 70, 229, 0.25), transparent 48%),
        var(--bg);
      min-height: 100vh;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 28px;
      border-bottom: 1px solid var(--border);
      background: rgba(11, 16, 32, 0.72);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .topbar a {
      color: #dbeafe;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
    }

    .topbar-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .topbar-badge {
      font-size: 11px;
      border-radius: 999px;
      padding: 3px 8px;
      background: rgba(124, 58, 237, 0.2);
      border: 1px solid rgba(124, 58, 237, 0.55);
      color: #ddd6fe;
    }

    .container {
      width: min(1120px, 92vw);
      margin: 34px auto 60px;
      display: grid;
      gap: 18px;
    }

    .panel {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(17, 24, 39, 0.9);
      box-shadow: var(--shadow);
    }

    .panel-head {
      padding: 20px 22px 0;
    }

    .panel-title {
      margin: 0;
      font-size: 24px;
      font-weight: 800;
      letter-spacing: -0.01em;
    }

    .panel-subtitle {
      margin: 8px 0 0;
      color: var(--muted);
      font-size: 14px;
    }

    .panel-body {
      padding: 20px 22px 24px;
    }

    .search-wrap {
      position: relative;
      display: grid;
      gap: 12px;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .input {
      flex: 1;
      min-width: 220px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(31, 41, 55, 0.7);
      color: var(--text);
      font-size: 15px;
      padding: 12px 14px;
      outline: none;
    }

    .input:focus {
      border-color: rgba(124, 58, 237, 0.9);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
    }

    .btn {
      border: 1px solid transparent;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      color: white;
      font-size: 14px;
      font-weight: 700;
      padding: 12px 16px;
      cursor: pointer;
      min-width: 150px;
    }

    .btn:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }

    .btn-secondary {
      background: transparent;
      color: #e5e7eb;
      border-color: var(--border);
      min-width: auto;
    }

    .results {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.95);
      max-height: 260px;
      overflow-y: auto;
      display: none;
    }

    .result-item {
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.07);
      cursor: pointer;
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .result-item:hover,
    .result-item.active {
      background: rgba(124, 58, 237, 0.18);
    }

    .result-name {
      font-size: 14px;
      font-weight: 600;
    }

    .result-address {
      margin-top: 3px;
      font-size: 12px;
      color: var(--muted);
    }

    .hint {
      color: var(--muted);
      font-size: 13px;
    }

    .error {
      color: #fecaca;
      font-size: 13px;
      display: none;
    }

    .scan-panel {
      display: none;
    }

    .progress-wrap {
      display: grid;
      gap: 8px;
    }

    .progress-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      color: #d1d5db;
    }

    .bar {
      height: 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      overflow: hidden;
    }

    .bar-fill {
      width: 0;
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, #8b5cf6, #6366f1);
      transition: width 240ms linear;
    }

    .scan-log {
      margin-top: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: rgba(2, 6, 23, 0.55);
      font-size: 13px;
      color: #cbd5e1;
      min-height: 44px;
    }

    .report-panel {
      display: none;
      gap: 16px;
    }

    .report-grid {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 14px;
    }

    .score-box {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(17, 24, 39, 0.72);
      padding: 18px;
    }

    .score-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .score-label {
      font-size: 13px;
      color: var(--muted);
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .score-value {
      font-size: 42px;
      font-weight: 800;
      line-height: 1;
    }

    .score-tag {
      font-size: 12px;
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid rgba(255, 255, 255, 0.22);
      font-weight: 700;
      text-transform: uppercase;
    }

    .breakdown {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 8px;
      margin-top: 12px;
    }

    .breakdown-card {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      background: rgba(31, 41, 55, 0.55);
    }

    .breakdown-name {
      display: block;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .breakdown-value {
      display: block;
      font-size: 18px;
      font-weight: 700;
    }

    .list-box {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(17, 24, 39, 0.72);
      padding: 14px;
    }

    .list-title {
      margin: 0 0 10px;
      font-size: 14px;
      font-weight: 700;
      color: #e5e7eb;
    }

    .findings {
      display: grid;
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }

    .finding {
      border: 1px solid var(--border);
      border-left-width: 4px;
      border-radius: 10px;
      padding: 10px 11px;
      background: rgba(15, 23, 42, 0.75);
    }

    .finding-title {
      margin: 0;
      font-size: 13px;
      font-weight: 700;
    }

    .finding-desc {
      margin: 5px 0 0;
      font-size: 12px;
      color: #cbd5e1;
      line-height: 1.45;
    }

    .finding-meta {
      margin-top: 6px;
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .plans {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    .plan-col {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 11px;
      background: rgba(2, 6, 23, 0.58);
      min-height: 140px;
    }

    .plan-col h4 {
      margin: 0 0 8px;
      font-size: 13px;
      font-weight: 700;
      color: #e2e8f0;
    }

    .plan-col ul {
      margin: 0;
      padding-left: 16px;
      display: grid;
      gap: 7px;
      font-size: 12px;
      color: #cbd5e1;
    }

    .module-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .module-table th,
    .module-table td {
      border-bottom: 1px solid rgba(255, 255, 255, 0.09);
      padding: 9px 8px;
      text-align: left;
      vertical-align: top;
    }

    .module-table th {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 0.05em;
      font-weight: 700;
    }

    .status-chip {
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      padding: 4px 8px;
      display: inline-block;
    }

    @media (max-width: 980px) {
      .report-grid {
        grid-template-columns: 1fr;
      }

      .breakdown {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      .plans {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 620px) {
      .topbar {
        padding: 14px 16px;
      }

      .container {
        width: min(1120px, 95vw);
      }

      .panel-head,
      .panel-body {
        padding-left: 14px;
        padding-right: 14px;
      }

      .breakdown {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-title">
      <span>Agent SEO Scanner</span>
      <span class="topbar-badge">v3 Public</span>
    </div>
    <a href="/how-it-works">Tilbage til Sådan virker det</a>
  </header>

  <main class="container">
    <section class="panel" id="searchPanel">
      <div class="panel-head">
        <h1 class="panel-title">Digital Synlighedsanalyse</h1>
        <p class="panel-subtitle">Public scanner kører Agent SEO v3 via server-side endpoint. Ingen redirect til hovedapp.</p>
      </div>
      <div class="panel-body">
        <div class="search-wrap">
          <div class="row">
            <input id="searchInput" class="input" type="text" placeholder="Søg efter din virksomhed..." autocomplete="off">
            <button id="startBtn" class="btn" disabled>Start analyse</button>
          </div>
          <div id="searchResults" class="results" aria-live="polite"></div>
          <div id="searchHint" class="hint">Vælg en virksomhed fra listen for at starte analysen.</div>
          <div id="searchError" class="error"></div>
        </div>
      </div>
    </section>

    <section class="panel scan-panel" id="scanPanel">
      <div class="panel-head">
        <h2 class="panel-title" style="font-size:20px">Scanner i gang</h2>
        <p class="panel-subtitle" id="scanBusinessLabel"></p>
      </div>
      <div class="panel-body">
        <div class="progress-wrap">
          <div class="progress-meta">
            <span id="scanStepLabel">Initialiserer...</span>
            <span id="scanProgressPct">0%</span>
          </div>
          <div class="bar"><div class="bar-fill" id="scanProgressBar"></div></div>
        </div>
        <div class="scan-log" id="scanLog">Forbereder kald til /api/seo/scan-v3 ...</div>
      </div>
    </section>

    <section class="panel report-panel" id="reportPanel">
      <div class="panel-head">
        <h2 class="panel-title" style="font-size:22px">Analyse resultat</h2>
        <p class="panel-subtitle" id="reportBusinessLabel"></p>
      </div>
      <div class="panel-body" style="display:grid;gap:14px;">
        <div class="report-grid">
          <div class="score-box">
            <div class="score-top">
              <span class="score-label">Samlet score</span>
              <span class="score-tag" id="scoreTag">-</span>
            </div>
            <div class="score-value" id="scoreValue">0</div>
            <div class="breakdown" id="breakdownGrid"></div>
          </div>

          <div class="list-box">
            <h3 class="list-title">Modulstatus</h3>
            <table class="module-table">
              <thead>
                <tr>
                  <th>Modul</th>
                  <th>Status</th>
                  <th>Resumé</th>
                  <th>ms</th>
                </tr>
              </thead>
              <tbody id="moduleStatusBody"></tbody>
            </table>
          </div>
        </div>

        <div class="list-box">
          <h3 class="list-title">Findings</h3>
          <div id="findingsList" class="findings"></div>
        </div>

        <div class="list-box">
          <h3 class="list-title">7-30-90 Dages Handlingsplan</h3>
          <div class="plans">
            <div class="plan-col">
              <h4>0-7 dage</h4>
              <ul id="planWeek1"></ul>
            </div>
            <div class="plan-col">
              <h4>0-30 dage</h4>
              <ul id="plan30"></ul>
            </div>
            <div class="plan-col">
              <h4>0-90 dage</h4>
              <ul id="plan90"></ul>
            </div>
          </div>
        </div>

        <div class="row" style="justify-content:flex-end;">
          <button id="newScanBtn" class="btn btn-secondary">Ny analyse</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    const scanStepNames = [
      'Google Business Profile',
      'Reviews & Momentum',
      'Competitor Gap',
      'Website & Schema',
      'Social & NAP'
    ];

    const state = {
      query: '',
      searchResults: [],
      selectedBusiness: null,
      searchDebounce: null,
      scanTicker: null,
      scanProgress: 0,
      isScanning: false,
      lastResult: null
    };

    const searchInput = document.getElementById('searchInput');
    const startBtn = document.getElementById('startBtn');
    const searchResultsEl = document.getElementById('searchResults');
    const searchHintEl = document.getElementById('searchHint');
    const searchErrorEl = document.getElementById('searchError');

    const scanPanel = document.getElementById('scanPanel');
    const scanBusinessLabel = document.getElementById('scanBusinessLabel');
    const scanStepLabel = document.getElementById('scanStepLabel');
    const scanProgressBar = document.getElementById('scanProgressBar');
    const scanProgressPct = document.getElementById('scanProgressPct');
    const scanLog = document.getElementById('scanLog');

    const reportPanel = document.getElementById('reportPanel');
    const reportBusinessLabel = document.getElementById('reportBusinessLabel');
    const scoreTag = document.getElementById('scoreTag');
    const scoreValue = document.getElementById('scoreValue');
    const breakdownGrid = document.getElementById('breakdownGrid');
    const moduleStatusBody = document.getElementById('moduleStatusBody');
    const findingsList = document.getElementById('findingsList');
    const planWeek1 = document.getElementById('planWeek1');
    const plan30 = document.getElementById('plan30');
    const plan90 = document.getElementById('plan90');
    const newScanBtn = document.getElementById('newScanBtn');

    function escapeHtml(value) {
      return String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function hideError() {
      searchErrorEl.style.display = 'none';
      searchErrorEl.textContent = '';
    }

    function showError(text) {
      searchErrorEl.textContent = text;
      searchErrorEl.style.display = 'block';
    }

    function updateStartButton() {
      startBtn.disabled = !state.selectedBusiness || state.isScanning;
      searchHintEl.textContent = state.selectedBusiness
        ? 'Valgt: ' + state.selectedBusiness.name
        : 'Vælg en virksomhed fra listen for at starte analysen.';
    }

    function renderSearchResults() {
      if (!Array.isArray(state.searchResults) || state.searchResults.length === 0) {
        searchResultsEl.style.display = 'none';
        searchResultsEl.innerHTML = '';
        return;
      }

      searchResultsEl.innerHTML = state.searchResults.map((entry, index) => {
        return '<div class="result-item" data-index="' + index + '">' +
          '<div class="result-name">' + escapeHtml(entry.name || 'Ukendt') + '</div>' +
          '<div class="result-address">' + escapeHtml(entry.address || '') + '</div>' +
        '</div>';
      }).join('');

      searchResultsEl.style.display = 'block';

      searchResultsEl.querySelectorAll('.result-item').forEach((item) => {
        item.addEventListener('click', function () {
          const idx = parseInt(item.dataset.index, 10);
          if (!Number.isFinite(idx) || !state.searchResults[idx]) return;
          selectBusiness(state.searchResults[idx]);
        });
      });
    }

    function selectBusiness(entry) {
      state.selectedBusiness = {
        name: entry.name || '',
        place_id: entry.place_id || '',
        address: entry.address || '',
        website: entry.website || ''
      };

      searchInput.value = state.selectedBusiness.name;
      searchResultsEl.style.display = 'none';
      updateStartButton();
      hideError();
    }

    async function searchBusinesses(query) {
      const response = await fetch('/api/places/search?query=' + encodeURIComponent(query));
      if (!response.ok) {
        throw new Error('Søgning fejlede (' + response.status + ')');
      }
      const data = await response.json();
      return Array.isArray(data.results) ? data.results : [];
    }

    function handleSearchInput() {
      const value = searchInput.value.trim();
      state.query = value;
      state.selectedBusiness = null;
      updateStartButton();
      hideError();

      if (state.searchDebounce) {
        clearTimeout(state.searchDebounce);
      }

      if (value.length < 2) {
        state.searchResults = [];
        renderSearchResults();
        return;
      }

      state.searchDebounce = setTimeout(async function () {
        try {
          state.searchResults = await searchBusinesses(value);
          renderSearchResults();
          if (state.searchResults.length === 0) {
            showError('Ingen resultater fundet for søgningen.');
          }
        } catch (error) {
          state.searchResults = [];
          renderSearchResults();
          showError('Kunne ikke søge virksomheder lige nu. Prøv igen.');
        }
      }, 280);
    }

    function parseBusinessFromQuery() {
      const params = new URLSearchParams(window.location.search);
      const name = (params.get('name') || '').trim();
      if (!name) return null;

      return {
        name: name,
        place_id: (params.get('place_id') || '').trim(),
        address: (params.get('address') || '').trim(),
        website: (params.get('website') || '').trim()
      };
    }

    function syncQueryParams(business) {
      const params = new URLSearchParams();
      params.set('name', business.name || '');
      if (business.place_id) params.set('place_id', business.place_id);
      if (business.address) params.set('address', business.address);
      if (business.website) params.set('website', business.website);
      window.history.replaceState({}, '', '/search-engine?' + params.toString());
    }

    function startScanTicker() {
      stopScanTicker();
      state.scanProgress = 4;
      let step = 0;

      scanStepLabel.textContent = scanStepNames[step] + ' ...';
      scanProgressBar.style.width = state.scanProgress + '%';
      scanProgressPct.textContent = state.scanProgress + '%';

      state.scanTicker = setInterval(function () {
        if (state.scanProgress < 92) {
          state.scanProgress += 3;
        }
        step = (step + 1) % scanStepNames.length;
        scanStepLabel.textContent = scanStepNames[step] + ' ...';
        scanProgressBar.style.width = Math.min(state.scanProgress, 92) + '%';
        scanProgressPct.textContent = Math.min(state.scanProgress, 92) + '%';
      }, 750);
    }

    function stopScanTicker() {
      if (state.scanTicker) {
        clearInterval(state.scanTicker);
        state.scanTicker = null;
      }
    }

    async function runScanRequest(business) {
      const response = await fetch('/api/seo/scan-v3', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          business: business,
          locale: 'da-DK',
          country: 'dk'
        })
      });

      if (!response.ok) {
        const text = await response.text();
        throw new Error(text || 'Scan endpoint fejl (' + response.status + ')');
      }

      return response.json();
    }

    function statusColor(status) {
      if (status === 'completed') return 'var(--ok)';
      if (status === 'warning') return 'var(--warn)';
      return 'var(--bad)';
    }

    function statusLabel(status) {
      if (status === 'completed') return 'OK';
      if (status === 'warning') return 'Warning';
      return 'Error';
    }

    function renderBreakdown(score) {
      const breakdown = score && score.breakdown ? score.breakdown : {};
      const labels = [
        ['gbp', 'GBP'],
        ['reviews', 'Reviews'],
        ['website', 'Website'],
        ['competitors', 'Konkurrent'],
        ['socialNap', 'Social/NAP']
      ];

      breakdownGrid.innerHTML = labels.map(function (entry) {
        const key = entry[0];
        const label = entry[1];
        const value = Math.round(Number(breakdown[key] || 0));
        return '<div class="breakdown-card">' +
          '<span class="breakdown-name">' + label + '</span>' +
          '<span class="breakdown-value">' + value + '</span>' +
        '</div>';
      }).join('');
    }

    function renderModuleStatuses(items) {
      const statuses = Array.isArray(items) ? items : [];
      moduleStatusBody.innerHTML = statuses.map(function (item) {
        const color = statusColor(item.status);
        return '<tr>' +
          '<td>' + escapeHtml(item.name || item.id || '-') + '</td>' +
          '<td><span class="status-chip" style="color:' + color + ';border:1px solid ' + color + ';">' + statusLabel(item.status) + '</span></td>' +
          '<td>' + escapeHtml(item.summary || '-') + '</td>' +
          '<td>' + escapeHtml(item.durationMs != null ? String(item.durationMs) : '-') + '</td>' +
        '</tr>';
      }).join('');
    }

    function findingColor(type) {
      if (type === 'positive') return 'var(--ok)';
      if (type === 'warning') return 'var(--warn)';
      if (type === 'critical') return 'var(--bad)';
      return '#60a5fa';
    }

    function renderFindings(items) {
      const findings = Array.isArray(items) ? items : [];
      if (findings.length === 0) {
        findingsList.innerHTML = '<div class="hint">Ingen findings returneret.</div>';
        return;
      }

      findingsList.innerHTML = findings.map(function (item) {
        const color = findingColor(item.type);
        return '<article class="finding" style="border-left-color:' + color + ';">' +
          '<p class="finding-title">' + escapeHtml(item.title || 'Finding') + '</p>' +
          '<p class="finding-desc">' + escapeHtml(item.description || '-') + '</p>' +
          '<div class="finding-meta">' + escapeHtml(item.module || '-') + ' · ' + escapeHtml(item.confidence || 'indicator') + '</div>' +
        '</article>';
      }).join('');
    }

    function renderPlanList(targetEl, items) {
      const list = Array.isArray(items) ? items : [];
      if (list.length === 0) {
        targetEl.innerHTML = '<li>Ingen handlinger i denne periode.</li>';
        return;
      }

      targetEl.innerHTML = list.map(function (item) {
        const title = item.task || 'Handling';
        const detail = item.detail || '';
        return '<li><strong>' + escapeHtml(title) + '</strong><br>' + escapeHtml(detail) + '</li>';
      }).join('');
    }

    function renderReport(data) {
      state.lastResult = data;
      const score = data && data.score ? data.score : { overall: 0, label: 'Ukendt', color: '#9ca3af', breakdown: {} };
      const business = data && data.business ? data.business : { name: '-', address: '' };

      reportBusinessLabel.textContent = [business.name, business.address].filter(Boolean).join(' — ');
      scoreValue.textContent = Math.round(Number(score.overall || 0));
      scoreTag.textContent = score.label || 'Ukendt';
      scoreTag.style.borderColor = score.color || '#9ca3af';
      scoreTag.style.color = score.color || '#9ca3af';

      renderBreakdown(score);
      renderModuleStatuses(data.moduleStatuses || []);
      renderFindings(data.findings || []);
      renderPlanList(planWeek1, data.actionPlan && data.actionPlan.week1);
      renderPlanList(plan30, data.actionPlan && data.actionPlan.days30);
      renderPlanList(plan90, data.actionPlan && data.actionPlan.days90);

      reportPanel.style.display = 'grid';
    }

    async function startAnalysis(opts) {
      const auto = opts && opts.auto === true;
      hideError();

      if (!state.selectedBusiness) {
        if (state.searchResults.length > 0) {
          selectBusiness(state.searchResults[0]);
        } else {
          showError('Vælg en virksomhed fra listen før du starter analysen.');
          return;
        }
      }

      state.isScanning = true;
      updateStartButton();
      syncQueryParams(state.selectedBusiness);

      scanBusinessLabel.textContent = [state.selectedBusiness.name, state.selectedBusiness.address].filter(Boolean).join(' — ');
      scanPanel.style.display = 'block';
      reportPanel.style.display = 'none';

      scanLog.textContent = 'Kører server-side scan med Agent SEO v3 ...';
      startScanTicker();

      try {
        const data = await runScanRequest(state.selectedBusiness);
        stopScanTicker();
        state.scanProgress = 100;
        scanProgressBar.style.width = '100%';
        scanProgressPct.textContent = '100%';
        scanStepLabel.textContent = 'Færdig';
        scanLog.textContent = 'Scan gennemført. Viser rapport.';
        renderReport(data);
      } catch (error) {
        stopScanTicker();
        scanStepLabel.textContent = 'Fejl';
        scanProgressPct.textContent = '0%';
        scanProgressBar.style.width = '0%';
        scanLog.textContent = 'Scan fejlede: ' + (error && error.message ? error.message : 'Ukendt fejl');
        showError('Kunne ikke gennemføre analysen. Prøv igen om lidt.');
      } finally {
        state.isScanning = false;
        updateStartButton();
      }

      if (auto) {
        searchResultsEl.style.display = 'none';
      }
    }

    function resetForNewScan() {
      state.selectedBusiness = null;
      state.searchResults = [];
      searchInput.value = '';
      searchResultsEl.style.display = 'none';
      scanPanel.style.display = 'none';
      reportPanel.style.display = 'none';
      hideError();
      updateStartButton();
      searchInput.focus();
      window.history.replaceState({}, '', '/search-engine');
    }

    searchInput.addEventListener('input', handleSearchInput);
    startBtn.addEventListener('click', function () { startAnalysis({ auto: false }); });
    newScanBtn.addEventListener('click', resetForNewScan);

    document.addEventListener('click', function (event) {
      if (!event.target.closest('.search-wrap')) {
        searchResultsEl.style.display = 'none';
      }
    });

    const pendingBusiness = parseBusinessFromQuery();
    if (pendingBusiness && pendingBusiness.name) {
      state.selectedBusiness = pendingBusiness;
      searchInput.value = pendingBusiness.name;
      updateStartButton();
      startAnalysis({ auto: true });
    } else {
      updateStartButton();
    }
  </script>
</body>
</html>
