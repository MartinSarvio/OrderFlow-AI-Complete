// =====================================================
// ORDERFLOW AI - APP.JS (v137)
// =====================================================

// =====================================================
// THEME TOGGLE
// =====================================================
function toggleTheme() {
  const html = document.documentElement;
  const currentTheme = html.getAttribute('data-theme');
  const newTheme = currentTheme === 'light' ? 'dark' : 'light';

  html.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  updateThemeToggleTooltip(newTheme);

  // Update meta theme-color for mobile browsers
  const metaTheme = document.querySelector('meta[name="theme-color"]');
  if (metaTheme) {
    metaTheme.setAttribute('content', newTheme === 'light' ? '#ffffff' : '#0a0a0a');
  }

  // Update logos based on theme
  updateLogos(newTheme);

  console.log('Theme changed to:', newTheme);
}

// Update logo images based on theme
function updateLogos(theme) {
  const logoSrc = theme === 'light'
    ? 'images/FLOW-logo-sort-4K.png'
    : 'images/FLOW-logo-hvid-4K.png';

  // Update all logo images
  document.querySelectorAll('.logo img, .app-logo img, .auth-logo img').forEach(img => {
    img.src = logoSrc;
  });
}

// Update theme toggle button tooltip
function updateThemeToggleTooltip(theme) {
  const themeBtn = document.querySelector('.theme-toggle-btn');
  if (themeBtn) {
    themeBtn.title = theme === 'light'
      ? 'Skift til m√∏rk tilstand'
      : 'Skift til lys tilstand';
  }
}

// Initialize theme on page load
function initTheme() {
  const savedTheme = localStorage.getItem('theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const theme = savedTheme || (prefersDark ? 'dark' : 'light');

  document.documentElement.setAttribute('data-theme', theme);

  // Update meta theme-color
  const metaTheme = document.querySelector('meta[name="theme-color"]');
  if (metaTheme) {
    metaTheme.setAttribute('content', theme === 'light' ? '#ffffff' : '#0a0a0a');
  }

  // Update logos and tooltip when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      updateLogos(theme);
      updateThemeToggleTooltip(theme);
    });
  } else {
    updateLogos(theme);
    updateThemeToggleTooltip(theme);
  }

  console.log('Theme initialized:', theme);
}

// Initialize theme immediately (before DOMContentLoaded)
initTheme();

// Clean up old SMS provider localStorage keys (removed providers: Twilio, GatewayAPI)
(function cleanupOldSmsProviders() {
  const oldKeys = [
    'twilio_account_sid',
    'twilio_auth_token',
    'twilio_phone_number',
    'api_twilio_enabled',
    'gatewayapi_token',
    'gatewayapi_sender',
    'api_gatewayapi_enabled',
    'api_inmobile_enabled' // Not needed anymore since InMobile is the only provider
  ];

  oldKeys.forEach(key => localStorage.removeItem(key));
})();

// =====================================================
// DEVICE DETECTION & TRUSTED DEVICES
// =====================================================

/**
 * Detect device type from User-Agent
 * @returns {Object} Device type and icon identifier
 */
function detectDeviceType() {
  const ua = navigator.userAgent;

  if (/iPhone/i.test(ua)) return { type: 'iPhone', icon: 'phone' };
  if (/iPad/i.test(ua)) return { type: 'iPad', icon: 'tablet' };
  if (/Android/i.test(ua) && /Mobile/i.test(ua)) return { type: 'Android', icon: 'phone' };
  if (/Android/i.test(ua)) return { type: 'Android Tablet', icon: 'tablet' };
  if (/Macintosh|Mac OS/i.test(ua)) return { type: 'macOS', icon: 'laptop' };
  if (/Windows/i.test(ua)) return { type: 'Windows', icon: 'laptop' };
  if (/Linux/i.test(ua)) return { type: 'Linux', icon: 'laptop' };

  return { type: 'Ukendt enhed', icon: 'unknown' };
}

/**
 * Register current device in Supabase
 */
async function registerDevice() {
  const client = window.supabaseClient;
  if (!client) {
    console.warn('‚ö†Ô∏è Cannot register device: Supabase not available');
    return;
  }

  try {
    const { data: { user } } = await client.auth.getUser();
    if (!user) return;

    const device = detectDeviceType();

    const { error } = await client.from('trusted_devices').upsert({
      user_id: user.id,
      device_type: device.type,
      device_icon: device.icon,
      user_agent: navigator.userAgent,
      last_seen: new Date().toISOString()
    }, {
      onConflict: 'user_id,user_agent',
      ignoreDuplicates: false
    });

    if (error) {
      console.warn('‚ö†Ô∏è Could not register device:', error.message);
    } else {
      console.log('‚úÖ Device registered:', device.type);
    }
  } catch (err) {
    console.warn('‚ö†Ô∏è Device registration error:', err);
  }
}

/**
 * Load trusted devices from Supabase
 */
async function loadTrustedDevices() {
  const client = window.supabaseClient;
  if (!client) {
    console.warn('‚ö†Ô∏è Cannot load devices: Supabase not available');
    return;
  }

  try {
    const { data: { user } } = await client.auth.getUser();
    if (!user) return;

    const { data: devices, error } = await client
      .from('trusted_devices')
      .select('*')
      .eq('user_id', user.id)
      .order('last_seen', { ascending: false });

    if (error) {
      console.warn('‚ö†Ô∏è Could not load devices:', error.message);
      return;
    }

    renderTrustedDevices(devices || []);
    console.log('‚úÖ Loaded trusted devices:', devices?.length || 0);
  } catch (err) {
    console.warn('‚ö†Ô∏è Load devices error:', err);
  }
}

/**
 * Render trusted devices in the UI
 * @param {Array} devices - Array of device objects
 */
function renderTrustedDevices(devices) {
  const container = document.getElementById('trusted-devices-list');
  if (!container) return;

  if (!devices || devices.length === 0) {
    container.innerHTML = `
      <div style="text-align:center;padding:var(--space-6);color:var(--muted)">
        <p>Ingen betroede enheder registreret endnu.</p>
      </div>
    `;
    return;
  }

  container.innerHTML = devices.map((device, index) => {
    const iconSvg = getDeviceIcon(device.device_icon);
    const gradientColors = getDeviceGradient(device.device_icon);
    const lastSeen = formatDeviceDate(device.last_seen);

    return `
      <div style="display:flex;align-items:center;gap:var(--space-4);padding:var(--space-4);background:var(--bg3);border-radius:var(--radius-sm)">
        <div style="width:56px;height:56px;background:${gradientColors};border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;flex-shrink:0">
          ${iconSvg}
        </div>
        <div style="flex:1">
          <div style="font-weight:var(--font-weight-semibold);font-size:var(--font-size-base);margin-bottom:var(--space-1)">${escapeHtml(device.device_type)}</div>
          <div style="font-size:var(--font-size-sm);color:var(--muted)">Sidst set ${lastSeen}</div>
        </div>
        <button class="btn btn-secondary" onclick="removeTrustedDevice('${device.id}')">Fjern</button>
      </div>
    `;
  }).join('');
}

/**
 * Get SVG icon for device type
 */
function getDeviceIcon(iconType) {
  switch (iconType) {
    case 'phone':
      return '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>';
    case 'tablet':
      return '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>';
    case 'laptop':
      return '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="2" y1="20" x2="22" y2="20"/></svg>';
    default:
      return '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>';
  }
}

/**
 * Get gradient colors for device type
 */
function getDeviceGradient(iconType) {
  switch (iconType) {
    case 'phone':
      return 'linear-gradient(135deg,#667eea 0%,#764ba2 100%)';
    case 'tablet':
      return 'linear-gradient(135deg,#f093fb 0%,#f5576c 100%)';
    case 'laptop':
      return 'linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)';
    default:
      return 'var(--bg2)';
  }
}

/**
 * Format device last seen date
 */
function formatDeviceDate(isoDate) {
  const date = new Date(isoDate);
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${day}.${month}.${year}, ${hours}.${minutes}`;
}

/**
 * Remove a trusted device
 */
async function removeTrustedDevice(deviceId) {
  if (!confirm('Er du sikker p√•, at du vil fjerne denne enhed fra dine betroede enheder?')) {
    return;
  }

  const client = window.supabaseClient;
  if (!client) {
    console.warn('‚ö†Ô∏è Cannot remove device: Supabase not available');
    return;
  }

  try {
    const { error } = await client
      .from('trusted_devices')
      .delete()
      .eq('id', deviceId);

    if (error) {
      console.error('‚ùå Could not remove device:', error.message);
      alert('Kunne ikke fjerne enheden. Pr√∏v igen.');
      return;
    }

    // Reload the devices list
    await loadTrustedDevices();
    console.log('‚úÖ Device removed:', deviceId);
  } catch (err) {
    console.error('‚ùå Remove device error:', err);
    alert('Kunne ikke fjerne enheden. Pr√∏v igen.');
  }
}

// Library Shims (jsPDF mock only - Chart.js loaded from CDN)
window.jspdf={jsPDF:function(){var s={setFontSize:function(){return s},setTextColor:function(){return s},text:function(){return s},setDrawColor:function(){return s},setFillColor:function(){return s},rect:function(){return s},line:function(){return s},addImage:function(){return s},save:function(){alert("PDF kr√¶ver download");return s},internal:{pageSize:{getWidth:function(){return 210},getHeight:function(){return 297}}}};return s}};

// =====================================================
// ORDERFLOW AI - APP.JS (v133)
// =====================================================
// 
// ‚ö†Ô∏è  SIKKERHEDSADVARSEL: 
// API-n√∏gler herunder er EKSPONEREDE i frontend-kode.
// I produktion b√∏r disse flyttes til:
// - Environment variables p√• serveren
// - En backend/serverless function der h√•ndterer API-kald
// - Supabase Edge Functions eller lignende
//
// CHANGELOG v133:
// - Tilf√∏jet Support/Dokumentation sektion
// - Integreret alle guides fra dokumentationen
// - S√∏gefunktion i dokumentation
// - Responsivt design for dokumentation
//
// =====================================================

// =====================================================
// CONFIG - YOUR SETTINGS
// =====================================================
const CONFIG = {
  // Supabase
  SUPABASE_URL: 'https://qymtjhzgtcittohutmay.supabase.co',
  SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5bXRqaHpndGNpdHRvaHV0bWF5Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MTcyMzM2NiwiZXhwIjoyMDY3Mjk5MzY2fQ.th8EBi8r6JtR4nP0Q1FZoLiLT5-COohX4HvJ15Xd7G8',
  
  // OpenAI (indtastes i Indstillinger ‚Üí API Adgang)
  OPENAI_API_KEY: '',
  
  // Demo mode (DEAKTIVERET - Produktionsklar)
  DEMO_MODE: false
};

// =====================================================
// DEMO MENU DATA (Used when no API endpoint is configured)
// =====================================================
const DEMO_MENUS = {
  'd1': { // Bella Italia
    restaurantId: 'd1',
    restaurantName: 'Bella Italia',
    currency: 'DKK',
    items: [
      { id: 1, number: '1', name: 'Pizza Margherita', description: 'Tomat, mozzarella, basilikum', price: 89, category: 'Pizza' },
      { id: 2, number: '2', name: 'Pizza Pepperoni', description: 'Tomat, mozzarella, pepperoni', price: 99, category: 'Pizza' },
      { id: 3, number: '3', name: 'Pizza Hawaii', description: 'Tomat, mozzarella, skinke, ananas', price: 99, category: 'Pizza' },
      { id: 4, number: '4', name: 'Pizza Quattro Stagioni', description: 'Tomat, mozzarella, skinke, champignon, artiskok, oliven', price: 109, category: 'Pizza' },
      { id: 5, number: '5', name: 'Pizza Diavola', description: 'Tomat, mozzarella, spicy salami, chili', price: 105, category: 'Pizza' },
      { id: 6, number: '6', name: 'Calzone', description: 'Foldet pizza med skinke og ost', price: 99, category: 'Pizza' },
      { id: 7, number: '7', name: 'Spaghetti Bolognese', description: 'Klassisk k√∏dsauce', price: 95, category: 'Pasta' },
      { id: 8, number: '8', name: 'Spaghetti Carbonara', description: '√Üg, bacon, parmesan', price: 99, category: 'Pasta' },
      { id: 9, number: '9', name: 'Lasagne', description: 'Hjemmelavet med k√∏dsauce og bechamel', price: 109, category: 'Pasta' },
      { id: 10, number: '10', name: 'Tiramisu', description: 'Klassisk italiensk dessert', price: 59, category: 'Dessert' },
      { id: 11, number: '11', name: 'Panna Cotta', description: 'Med b√¶rcompot', price: 55, category: 'Dessert' },
      { id: 12, number: '12', name: 'Coca-Cola', description: '33cl', price: 25, category: 'Drikkevarer' },
      { id: 13, number: '13', name: 'Fanta', description: '33cl', price: 25, category: 'Drikkevarer' },
      { id: 14, number: '14', name: 'Vand', description: '50cl', price: 20, category: 'Drikkevarer' }
    ]
  },
  'd2': { // Sushi House
    restaurantId: 'd2',
    restaurantName: 'Sushi House',
    currency: 'DKK',
    items: [
      { id: 1, number: '1', name: 'Salmon Nigiri (2 stk)', description: 'Frisk laks p√• ris', price: 45, category: 'Nigiri' },
      { id: 2, number: '2', name: 'Tuna Nigiri (2 stk)', description: 'Frisk tun p√• ris', price: 55, category: 'Nigiri' },
      { id: 3, number: '3', name: 'California Roll (8 stk)', description: 'Krabbe, avocado, agurk', price: 89, category: 'Maki' },
      { id: 4, number: '4', name: 'Spicy Tuna Roll (8 stk)', description: 'Krydret tun, avocado', price: 99, category: 'Maki' },
      { id: 5, number: '5', name: 'Dragon Roll (8 stk)', description: 'Tempura rejer, √•l, avocado', price: 129, category: 'Special Rolls' },
      { id: 6, number: '6', name: 'Rainbow Roll (8 stk)', description: 'Assorteret fisk ovenp√• California roll', price: 139, category: 'Special Rolls' },
      { id: 7, number: '7', name: 'Sashimi Mix (12 stk)', description: 'Laks, tun, hamachi', price: 159, category: 'Sashimi' },
      { id: 8, number: '8', name: 'Edamame', description: 'Dampede sojab√∏nner med salt', price: 35, category: 'Sides' },
      { id: 9, number: '9', name: 'Miso Suppe', description: 'Traditionel japansk suppe', price: 29, category: 'Sides' },
      { id: 10, number: '10', name: 'Gr√∏n Te', description: 'Varm japansk gr√∏n te', price: 25, category: 'Drikkevarer' }
    ]
  },
  'd3': { // Burger Joint
    restaurantId: 'd3',
    restaurantName: 'Burger Joint',
    currency: 'DKK',
    items: [
      { id: 1, number: '1', name: 'Classic Burger', description: '180g b√∏f, salat, tomat, l√∏g, dressing', price: 89, category: 'Burgere' },
      { id: 2, number: '2', name: 'Cheese Burger', description: '180g b√∏f, cheddar, salat, tomat, dressing', price: 99, category: 'Burgere' },
      { id: 3, number: '3', name: 'Bacon Burger', description: '180g b√∏f, bacon, cheddar, BBQ sauce', price: 109, category: 'Burgere' },
      { id: 4, number: '4', name: 'Double Burger', description: '2x180g b√∏f, dobbelt ost, special sauce', price: 139, category: 'Burgere' },
      { id: 5, number: '5', name: 'Chicken Burger', description: 'Spr√∏d kylling, coleslaw, mayo', price: 99, category: 'Burgere' },
      { id: 6, number: '6', name: 'Pommes Frites', description: 'Stor portion', price: 35, category: 'Sides' },
      { id: 7, number: '7', name: 'Sweet Potato Fries', description: 'S√∏de kartofler', price: 45, category: 'Sides' },
      { id: 8, number: '8', name: 'Onion Rings', description: '8 stk med dip', price: 45, category: 'Sides' },
      { id: 9, number: '9', name: 'Milkshake', description: 'Vanilje, chokolade eller jordb√¶r', price: 49, category: 'Drikkevarer' },
      { id: 10, number: '10', name: 'Coca-Cola', description: '50cl', price: 30, category: 'Drikkevarer' }
    ]
  }
};

// =====================================================
// INITIALIZE
// =====================================================
// NOTE: supabase/supabaseClient is initialized in supabase-client.js
let currentUser = null;
let restaurants = [];
let liveMode = false;
let testRunning = false;
let replyResolver = null;

// Global resolver for workflow replies - bruges af RealtimeSync
window.resolveWorkflowReply = null;

// Refresh data fra database - kaldes ved navigation for at sikre frisk data
async function refreshRestaurantsFromDB() {
  if (!currentUser?.id || typeof SupabaseDB === 'undefined') return;

  try {
    const freshData = await SupabaseDB.getRestaurants(currentUser.id);
    if (freshData && freshData.length > 0) {
      restaurants = freshData;
      persistRestaurants();
      console.log('‚úÖ Data refreshed from database:', freshData.length, 'restaurants');
    }
  } catch (err) {
    console.warn('‚ö†Ô∏è Could not refresh data:', err.message);
  }
}

// Normalize phone numbers for consistent matching (inbound/outbound)
function normalizePhoneNumber(raw) {
  const digitsOnly = String(raw || '').replace(/[^0-9]/g, '');
  if (!digitsOnly) {
    return { digits: '', e164: '' };
  }
  let digits = digitsOnly;
  if (digits.startsWith('00')) {
    digits = digits.slice(2);
  }
  if (digits.length === 8) {
    digits = '45' + digits;
  }
  return { digits, e164: `+${digits}` };
}

// =====================================================
// SESSION MANAGEMENT - Rolle-baseret timeout med inaktivitets-prompt
// =====================================================
const SESSION_KEY = 'orderflow_session';
const SESSION_DURATION_ADMIN = 2 * 60 * 1000;      // 2 minutter for admin/employee
const SESSION_DURATION_CUSTOMER = 10 * 60 * 1000;  // 10 minutter for customer/demo
const INACTIVITY_WARNING_TIME = 30 * 1000;         // 30 sek warning f√∏r logout
let sessionTimeoutId = null;
let warningTimeoutId = null;
let countdownInterval = null;

// Hent session duration baseret p√• brugerindstilling eller rolle
function getSessionDuration() {
  // Check for user-saved timeout setting
  const savedTimeout = localStorage.getItem('orderflow_session_timeout');
  if (savedTimeout) {
    const timeout = parseInt(savedTimeout, 10);
    if (timeout > 0) return timeout;
  }
  // Fallback to role-based defaults
  const role = currentUser?.role;
  if (role === 'admin' || role === 'employee') {
    return SESSION_DURATION_ADMIN;
  }
  return SESSION_DURATION_CUSTOMER;
}

// Save session timeout setting
function saveSessionTimeoutSetting() {
  const select = document.getElementById('session-timeout-setting');
  if (select) {
    const value = select.value;
    localStorage.setItem('orderflow_session_timeout', value);
    resetSessionTimeout();
    showToast('Session timeout gemt', 'success');
  }
}

// Load session timeout setting into select element
function loadSessionTimeoutSetting() {
  const select = document.getElementById('session-timeout-setting');
  const saved = localStorage.getItem('orderflow_session_timeout');
  if (select && saved) {
    select.value = saved;
  }
}

function persistSession(user) {
  const duration = (user?.role === 'admin' || user?.role === 'employee')
    ? SESSION_DURATION_ADMIN
    : SESSION_DURATION_CUSTOMER;
  const sessionData = {
    user: user,
    expiresAt: Date.now() + duration
  };
  localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
  console.log('üíæ Session saved, expires:', new Date(sessionData.expiresAt).toLocaleString());
  startSessionTimeout();
}

function restoreSession() {
  try {
    const stored = localStorage.getItem(SESSION_KEY);
    if (!stored) return null;

    const session = JSON.parse(stored);
    if (Date.now() > session.expiresAt) {
      console.log('‚è∞ Session expired, clearing...');
      localStorage.removeItem(SESSION_KEY);
      return null;
    }

    console.log('üîÑ Restoring session for:', session.user.email);
    // Delay startSessionTimeout until after currentUser is set
    setTimeout(() => startSessionTimeout(), 100);
    return session.user;
  } catch (err) {
    console.warn('‚ö†Ô∏è Could not restore session:', err);
    localStorage.removeItem(SESSION_KEY);
    return null;
  }
}

function clearSession() {
  localStorage.removeItem(SESSION_KEY);
  if (sessionTimeoutId) {
    clearTimeout(sessionTimeoutId);
    sessionTimeoutId = null;
  }
  if (warningTimeoutId) {
    clearTimeout(warningTimeoutId);
    warningTimeoutId = null;
  }
  hideInactivityWarning();
  console.log('üóëÔ∏è Session cleared');
}

function startSessionTimeout() {
  // Clear existing timeouts
  if (sessionTimeoutId) clearTimeout(sessionTimeoutId);
  if (warningTimeoutId) clearTimeout(warningTimeoutId);

  const duration = getSessionDuration();
  const warningTime = Math.max(0, duration - INACTIVITY_WARNING_TIME);

  console.log(`‚è±Ô∏è Session timeout set: ${duration/1000}s (warning at ${warningTime/1000}s)`);

  // Vis warning 30 sek f√∏r logout
  warningTimeoutId = setTimeout(() => {
    showInactivityWarning();
  }, warningTime);

  // Logout efter fuld duration
  sessionTimeoutId = setTimeout(() => {
    hideInactivityWarning();
    console.log('‚è∞ Session timeout - logging out due to inactivity');
    showToast('Session udl√∏bet - log venligst ind igen', 'warning');
    logout();
  }, duration);
}

function resetSessionTimeout() {
  // Skjul warning hvis den vises
  hideInactivityWarning();

  const stored = localStorage.getItem(SESSION_KEY);
  if (stored) {
    try {
      const session = JSON.parse(stored);
      const duration = getSessionDuration();
      session.expiresAt = Date.now() + duration;
      localStorage.setItem(SESSION_KEY, JSON.stringify(session));
      startSessionTimeout();
    } catch (err) {
      console.warn('‚ö†Ô∏è Could not reset session:', err);
    }
  }
}

// Inaktivitets-warning modal
function showInactivityWarning() {
  let modal = document.getElementById('inactivity-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'inactivity-modal';
    modal.innerHTML = `
      <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);z-index:99999;display:flex;align-items:center;justify-content:center;">
        <div style="background:var(--card-bg, #1a1a2e);padding:2rem;border-radius:16px;text-align:center;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,0.4);">
          <h3 style="margin-bottom:1rem;color:var(--text-primary, #fff);font-size:1.25rem;">Er du stadig der?</h3>
          <p style="margin-bottom:1.5rem;color:var(--text-secondary, #aaa);">Du vil blive logget ud om <span id="inactivity-countdown" style="font-weight:bold;color:var(--accent, #2dd4bf);">30</span> sekunder.</p>
          <button onclick="dismissInactivityWarning()" style="padding:0.75rem 2rem;background:var(--accent, #2dd4bf);color:#000;border:none;border-radius:8px;cursor:pointer;font-size:1rem;font-weight:500;transition:transform 0.2s;">Ja, jeg er her</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  modal.style.display = 'block';
  startInactivityCountdown();
}

function hideInactivityWarning() {
  const modal = document.getElementById('inactivity-modal');
  if (modal) modal.style.display = 'none';
  if (countdownInterval) {
    clearInterval(countdownInterval);
    countdownInterval = null;
  }
}

function dismissInactivityWarning() {
  hideInactivityWarning();
  resetSessionTimeout();
  console.log('‚úÖ User confirmed activity, session extended');
}

function startInactivityCountdown() {
  let seconds = 30;
  const el = document.getElementById('inactivity-countdown');
  if (countdownInterval) clearInterval(countdownInterval);
  if (el) el.textContent = seconds;

  countdownInterval = setInterval(() => {
    seconds--;
    if (el) el.textContent = seconds;
    if (seconds <= 0) {
      clearInterval(countdownInterval);
      countdownInterval = null;
      // Auto-logout when countdown reaches 0
      hideInactivityWarning();
      console.log('‚è∞ Session expired - logging out');
      handleLogout();
    }
  }, 1000);
}

// Track user activity to reset session timeout
function initActivityTracking() {
  const activityEvents = ['mousedown', 'keydown', 'scroll', 'touchstart', 'click'];
  let lastActivity = Date.now();

  activityEvents.forEach(event => {
    document.addEventListener(event, () => {
      // Throttle: only reset if more than 30 seconds since last reset
      if (Date.now() - lastActivity > 30000) {
        lastActivity = Date.now();
        resetSessionTimeout();
      }
    }, { passive: true });
  });
}

// Initialize activity tracking when DOM is ready
document.addEventListener('DOMContentLoaded', initActivityTracking);

// =====================================================
// MODULE SYSTEM - Baseret p√• abonnement og branche
// =====================================================
const USER_MODULES = {
  subscription: 'professional', // basic, professional, enterprise
  industry: 'restaurant',
  enabledModules: ['core', 'crm', 'workflow', 'pos', 'reports', 'inventory', 'accounting']
};

// Module definitions
const MODULE_DEFINITIONS = {
  core: { name: 'Core', features: ['dashboard', 'settings'] },
  crm: { name: 'CRM', features: ['kunder', 'leads'] },
  workflow: { name: 'Workflow', features: ['workflow', 'workflow-kontrol'] },
  pos: { name: 'Salg', features: ['salg', 'korttransaktioner'] },
  reports: { name: 'Rapporter', features: ['rapporter'] },
  inventory: { name: 'Produkter', features: ['produktbibliotek'] },
  accounting: { name: 'Bogholderi', features: ['bogholderi', 'betaling'] }
};

function applyModuleBasedUI() {
  const modules = USER_MODULES.enabledModules;

  // Skjul/vis sidebar elementer baseret p√• moduler
  document.querySelectorAll('[data-module]').forEach(el => {
    const requiredModule = el.dataset.module;
    el.style.display = modules.includes(requiredModule) ? '' : 'none';
  });

  console.log('üì¶ Module-based UI applied. Enabled modules:', modules.join(', '));
}

function setUserModules(subscription, industry, modules) {
  USER_MODULES.subscription = subscription;
  USER_MODULES.industry = industry;
  USER_MODULES.enabledModules = modules;
  localStorage.setItem('orderflow_modules', JSON.stringify(USER_MODULES));
  applyModuleBasedUI();
}

function loadUserModules() {
  const stored = localStorage.getItem('orderflow_modules');
  if (stored) {
    const data = JSON.parse(stored);
    USER_MODULES.subscription = data.subscription || 'professional';
    USER_MODULES.industry = data.industry || 'restaurant';
    USER_MODULES.enabledModules = data.enabledModules || ['core', 'crm', 'workflow', 'pos', 'reports', 'inventory', 'accounting'];
  }
}

// =====================================================
// ROLE MANAGEMENT
// =====================================================
const ROLES = {
  ADMIN: 'admin',
  EMPLOYEE: 'employee',
  CUSTOMER: 'customer',
  DEMO: 'demo'
};

// Menu visibility per role - admin/employee only items
const ADMIN_ONLY_MENUS = {
  'kunder': [ROLES.ADMIN, ROLES.EMPLOYEE],
  'alle-kunder': [ROLES.ADMIN, ROLES.EMPLOYEE],
  'nav-salg': [ROLES.ADMIN, ROLES.EMPLOYEE],
  'nav-rapporter': [ROLES.ADMIN, ROLES.EMPLOYEE],
  'nav-integrationer': [ROLES.ADMIN, ROLES.EMPLOYEE],
  'workflow-test': [ROLES.ADMIN, ROLES.EMPLOYEE], // Real test only for admin
  'settings-api': [ROLES.ADMIN, ROLES.EMPLOYEE],
  'settings-ailearning': [ROLES.ADMIN, ROLES.EMPLOYEE],
  'settings-billing': [ROLES.ADMIN, ROLES.EMPLOYEE],
  'settings-users': [ROLES.ADMIN, ROLES.EMPLOYEE],
  'settings-roles': [ROLES.ADMIN, ROLES.EMPLOYEE]
};

// Customer/Demo only menus (hidden for admin/employee)
const CUSTOMER_ONLY_MENUS = {
  'nav-butikindstillinger': [ROLES.CUSTOMER, ROLES.DEMO],
  'nav-indsigt': [ROLES.CUSTOMER, ROLES.DEMO]
};

function hasRoleAccess(menuItem) {
  const role = currentUser?.role || ROLES.CUSTOMER;

  // Check admin-only menus
  if (ADMIN_ONLY_MENUS[menuItem]) {
    return ADMIN_ONLY_MENUS[menuItem].includes(role);
  }

  // Check customer-only menus
  if (CUSTOMER_ONLY_MENUS[menuItem]) {
    return CUSTOMER_ONLY_MENUS[menuItem].includes(role);
  }

  // Default: visible to all
  return true;
}

function applyRoleBasedSidebar() {
  const role = currentUser?.role || ROLES.CUSTOMER;
  const isCustomerView = [ROLES.CUSTOMER, ROLES.DEMO].includes(role);
  const isDemoView = role === ROLES.DEMO;
  const isRegularCustomer = role === ROLES.CUSTOMER;
  console.log('üîê Applying role-based sidebar for role:', role, '(Customer view:', isCustomerView, ', Demo view:', isDemoView, ')');

  // Helper function for konsistent display manipulation med !important
  const setDisplay = (el, show) => {
    if (el) el.style.setProperty('display', show ? '' : 'none', 'important');
  };

  // === APP BUILDER ADMIN ONLY ===
  const templateBtn = document.getElementById('app-preview-template-btn');
  setDisplay(templateBtn, role === ROLES.ADMIN);

  // === SKJUL KUNDER KNAP FOR KUNDE/DEMO ===
  const kunderBtn = document.querySelector('[data-role-menu="kunder"]');
  setDisplay(kunderBtn, !isCustomerView);
  if (kunderBtn) console.log(`  - Kunder knap: ${isCustomerView ? '‚úó hidden' : '‚úì visible'}`);

  // === INDSTILLINGER BEGR√ÜNSNINGER ===
  // Kunde/Demo har IKKE adgang til: API adgang, AI l√¶ring, Abonnement (billing)
  // Kunde/Demo HAR adgang til: Brugere, Roller, Sprog, Notifikationer, Adgangskoder, Support
  const adminOnlySettings = ['settings-api', 'settings-ailearning', 'settings-billing'];
  adminOnlySettings.forEach(menuId => {
    const el = document.querySelector(`[data-role-menu="${menuId}"]`);
    setDisplay(el, !isCustomerView);
  });

  // Vis bruger/rolle settings for alle
  ['settings-users', 'settings-roles'].forEach(menuId => {
    const el = document.querySelector(`[data-role-menu="${menuId}"]`);
    setDisplay(el, true);
  });

  // === ADMIN ELEMENTER ===
  if (isCustomerView) {
    document.querySelectorAll('.admin-customer-search').forEach(el => setDisplay(el, false));
    document.querySelectorAll('.admin-quick-actions').forEach(el => setDisplay(el, false));
  } else {
    document.querySelectorAll('.admin-customer-search').forEach(el => setDisplay(el, true));
    document.querySelectorAll('.admin-quick-actions').forEach(el => setDisplay(el, true));
  }

  // === KUNDE-SPECIFIKKE MENUPUNKTER ===
  // Butikindstillinger, Indsigt: Vis kun for kunde/demo
  ['nav-butikindstillinger', 'nav-indsigt'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.style.setProperty('display', isCustomerView ? 'block' : 'none', 'important');
      console.log(`  - ${id}: ${isCustomerView ? '‚úì visible' : '‚úó hidden'}`);
    }
  });

  // Workflow Kontrol og Produktbibliotek: Kun for demo/kunde (admin bruger kunde-kontekst menu)
  ['nav-workflow-kontrol', 'nav-produktbibliotek'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.style.setProperty('display', isCustomerView ? '' : 'none', 'important');
      console.log(`  - ${id}: ${isCustomerView ? '‚úì visible' : '‚úó hidden'}`);
    }
  });

  // === SALG, RAPPORTER, INTEGRATIONER: Synlige for ALLE ===
  ['nav-salg', 'nav-rapporter', 'nav-integrationer'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.style.setProperty('display', '', 'important');
      console.log(`  - ${id}: ‚úì visible`);
    }
  });

  // === SYSTEM SEKTION ===
  // Workflow: Synlig for Admin + Demo (IKKE for almindelige kunder)
  // Indstillinger: Synlig for ALLE (men med begr√¶nsede items)
  const systemSection = document.querySelector('.nav-section:has(#nav-indstillinger)');
  if (systemSection) {
    // Vis system sektion for alle
    systemSection.style.setProperty('display', '', 'important');
  }

  // Workflow knap: Kun for admin + demo (ikke almindelige kunder)
  const workflowBtn = document.querySelector('.nav-btn[onclick="showPage(\'workflow\')"]');
  if (workflowBtn) {
    // Admin: fuld adgang, Demo: kun test workflow, Kunde: ingen adgang
    setDisplay(workflowBtn, !isRegularCustomer);
    console.log(`  - Workflow: ${isRegularCustomer ? '‚úó hidden' : '‚úì visible'}`);
  }

  // Indstillinger dropdown: Synlig for alle
  const indstillingerDropdown = document.getElementById('nav-indstillinger');
  if (indstillingerDropdown) {
    indstillingerDropdown.style.setProperty('display', '', 'important');
    console.log('  - Indstillinger: ‚úì visible');
  }

  // === WORKFLOW TEST PANEL ===
  // Demo brugere ser demo overlay i stedet for test panel
  const workflowTestPanel = document.querySelector('.test-panel');
  if (workflowTestPanel) {
    setDisplay(workflowTestPanel, !isCustomerView);
  }

  // === DASHBOARD TYPE ===
  const adminDash = document.getElementById('admin-dashboard');
  const customerDash = document.getElementById('customer-dashboard');

  if (isCustomerView) {
    // VIGTIGT: Brug style.setProperty med !important for at sikre admin elementer forbliver skjulte
    if (adminDash) {
      adminDash.classList.add('hidden');
      adminDash.style.setProperty('display', 'none', 'important');
    }
    if (customerDash) {
      customerDash.classList.remove('hidden');
      customerDash.style.setProperty('display', '', 'important');
    }
    // Skjul ALLE admin dashboard elementer med !important
    document.querySelectorAll('.admin-dashboard-content').forEach(el => {
      el.classList.add('hidden');
      el.style.setProperty('display', 'none', 'important');
    });
    console.log('  - Dashboard: customer view activated');
  } else {
    if (adminDash) {
      adminDash.classList.remove('hidden');
      adminDash.style.removeProperty('display');
    }
    if (customerDash) {
      customerDash.classList.add('hidden');
      customerDash.style.setProperty('display', 'none', 'important');
    }
    document.querySelectorAll('.admin-dashboard-content').forEach(el => {
      el.classList.remove('hidden');
      el.style.removeProperty('display');
    });
    console.log('  - Dashboard: admin view activated');
  }

  // === SKJUL ADMIN-ELEMENTER FOR DEMO/KUNDE ===
  if (isCustomerView) {
    // Skjul admin-knapper i kunde profil
    const terminateBtn = document.getElementById('btn-terminate-customer');
    const profileStatus = document.getElementById('profile-status');
    const backToCustomers = document.querySelector('.crm-back-btn');

    if (terminateBtn) terminateBtn.style.setProperty('display', 'none', 'important');
    if (profileStatus) profileStatus.style.setProperty('display', 'none', 'important');
    if (backToCustomers) backToCustomers.style.setProperty('display', 'none', 'important');

    // Skjul "Vis alle" og "+ Tilf√∏j kunde" knapper
    document.querySelectorAll('.btn[onclick*="showPage(\'alle-kunder\')"]').forEach(el => {
      el.style.setProperty('display', 'none', 'important');
    });
    document.querySelectorAll('.btn[onclick*="showPage(\'add-restaurant\')"]').forEach(el => {
      el.style.setProperty('display', 'none', 'important');
    });

    console.log('  - Admin buttons hidden for customer/demo');
  }

  // === DROPDOWN MANAGEMENT FOR DEMO/KUNDE ===
  // Alle dropdowns forbliver lukkede som standard - pr√¶cis som for admin
  // Brugeren klikker selv for at √•bne dem

  console.log('‚úÖ Sidebar updated for', isCustomerView ? 'customer/demo' : 'admin/employee', 'view');
}

// Make role functions globally available
window.ROLES = ROLES;
window.hasRoleAccess = hasRoleAccess;
window.applyRoleBasedSidebar = applyRoleBasedSidebar;

// =====================================================
// WORKFLOW DEMO MODE
// Interactive demo for demo users
// =====================================================
const DEMO_SCRIPT = [
  {
    step: 1,
    title: 'Kunden ringer',
    desc: 'Systemet registrerer et mistet opkald automatisk',
    outgoing: null,
    expectedReply: null
  },
  {
    step: 2,
    title: 'Automatisk SMS sendes',
    desc: 'AI sender en venlig besked til kunden',
    outgoing: 'Hej! Vi missede dit opkald. Vil du bestille? Svar JA for at starte.',
    expectedReply: 'ja'
  },
  {
    step: 3,
    title: 'Levering eller afhentning?',
    desc: 'Systemet sp√∏rger efter leveringstype',
    outgoing: 'Super! Skal det leveres eller afhentes?',
    expectedReply: 'levering'
  },
  {
    step: 4,
    title: 'Indhent adresse',
    desc: 'AI beder om leveringsadresse',
    outgoing: 'Hvad er din adresse?',
    expectedReply: 'Vestergade 10, 2100 K√∏benhavn'
  },
  {
    step: 5,
    title: 'Modtag bestilling',
    desc: 'Kunden sender sin bestilling',
    outgoing: 'Perfekt! Hvad vil du gerne bestille?',
    expectedReply: '2 margherita og 1 cola'
  },
  {
    step: 6,
    title: 'Bekr√¶ft ordre',
    desc: 'AI opsummerer og bekr√¶fter ordren',
    outgoing: 'Din ordre: 2x Margherita (198 kr) + 1x Cola (25 kr) = 223 kr. Bekr√¶ft med JA',
    expectedReply: 'ja'
  },
  {
    step: 7,
    title: 'Ordre gennemf√∏rt!',
    desc: 'Ordren gemmes automatisk i systemet',
    outgoing: 'Tak! Din ordre er registreret. Levering om ca. 45 min.',
    expectedReply: null
  }
];

let currentDemoStep = 0;

function initWorkflowDemo() {
  const overlay = document.getElementById('workflow-demo-overlay');
  if (!overlay) return;

  const isCustomerView = [ROLES.DEMO, ROLES.CUSTOMER].includes(currentUser?.role);

  if (isCustomerView) {
    // Show demo overlay for customer/demo users
    overlay.style.display = 'block';
    currentDemoStep = 0;
    document.getElementById('demo-messages').innerHTML = '';
    renderDemoStep();

    // Hide the test panel completely for customer view
    const testPanel = document.querySelector('.test-panel');
    if (testPanel) testPanel.style.display = 'none';
  } else {
    // Hide demo overlay for admin/employee
    overlay.style.display = 'none';

    // Show test panel for admin/employee
    const testPanel = document.querySelector('.test-panel');
    if (testPanel) testPanel.style.display = '';
  }
}

function renderDemoStep() {
  const step = DEMO_SCRIPT[currentDemoStep];
  if (!step) return;

  document.getElementById('demo-step-title').textContent = `Trin ${step.step}: ${step.title}`;
  document.getElementById('demo-step-desc').textContent = step.desc;

  if (step.outgoing) {
    addDemoMessage(step.outgoing, 'out');
  }
}

function addDemoMessage(text, dir) {
  const container = document.getElementById('demo-messages');
  if (!container) return;
  container.innerHTML += `<div class="demo-msg ${dir}">${text}</div>`;
  container.scrollTop = container.scrollHeight;
}

function sendDemoReply() {
  const input = document.getElementById('demo-reply');
  const text = input.value.trim();
  if (!text) return;

  addDemoMessage(text, 'in');
  input.value = '';

  // Auto-advance if reply matches expected
  const step = DEMO_SCRIPT[currentDemoStep];
  if (step?.expectedReply && text.toLowerCase().includes(step.expectedReply.toLowerCase())) {
    setTimeout(() => nextDemoStep(), 1000);
  }
}

function nextDemoStep() {
  currentDemoStep++;
  if (currentDemoStep < DEMO_SCRIPT.length) {
    renderDemoStep();
  } else {
    // Demo complete
    document.getElementById('demo-step-title').textContent = 'Demo fuldf√∏rt!';
    document.getElementById('demo-step-desc').textContent = 'Du har nu set hele workflow-processen. Opgrader til fuld adgang for at aktivere denne funktion.';
  }
}

function resetWorkflowDemo() {
  currentDemoStep = 0;
  document.getElementById('demo-messages').innerHTML = '';
  renderDemoStep();
}

function showDemoTab(tab) {
  document.querySelectorAll('.demo-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.demo-tab[onclick*="${tab}"]`)?.classList.add('active');

  const interactive = document.getElementById('demo-interactive');
  const video = document.getElementById('demo-video');
  if (interactive) interactive.classList.toggle('hidden', tab !== 'interactive');
  if (video) video.classList.toggle('hidden', tab !== 'video');
}

// Make demo functions globally available
window.initWorkflowDemo = initWorkflowDemo;
window.sendDemoReply = sendDemoReply;
window.nextDemoStep = nextDemoStep;
window.resetWorkflowDemo = resetWorkflowDemo;
window.showDemoTab = showDemoTab;

// =====================================================
// AKTIVITETSLOG & OPDATERINGSSYSTEM
// Viser diskret lysebl√• prik ved nye funktioner/opdateringer
// =====================================================
const UPDATE_STORAGE_KEY = 'orderflow_seen_updates';
const ACTIVITY_LOG_KEY = 'orderflow_activity_log';

// Aktivitetstyper med farver og ikoner
const ACTIVITY_TYPES = {
  'update': { color: 'purple', label: 'Opdatering', icon: 'edit' },
  'create': { color: 'green', label: 'Oprettet', icon: 'plus' },
  'delete': { color: 'red', label: 'Slettet', icon: 'trash' },
  'order': { color: 'green', label: 'Ordre', icon: 'cart' },
  'workflow': { color: 'blue', label: 'Workflow', icon: 'zap' },
  'ai': { color: 'yellow', label: 'AI', icon: 'cpu' },
  'system': { color: 'cyan', label: 'System', icon: 'settings' },
  'login': { color: 'blue', label: 'Login', icon: 'user' },
  // NYE TYPER - FASE 7
  'page_create': { color: 'green', label: 'Side oprettet', icon: 'file-plus' },
  'page_rename': { color: 'purple', label: 'Side omd√∏bt', icon: 'edit' },
  'page_reorder': { color: 'blue', label: 'R√¶kkef√∏lge √¶ndret', icon: 'move' },
  'employee': { color: 'cyan', label: 'Medarbejder', icon: 'users' },
  'user': { color: 'blue', label: 'Bruger', icon: 'user' }
};

// Hent aktivitetslog
// SYNC version for backwards compatibility (loads from localStorage)
function getActivityLog() {
  try {
    const log = JSON.parse(localStorage.getItem(ACTIVITY_LOG_KEY) || '[]');
    // Filtrer aktiviteter √¶ldre end 2 m√•neder
    const twoMonthsAgo = Date.now() - (60 * 24 * 60 * 60 * 1000);
    return log.filter(a => a.timestamp > twoMonthsAgo);
  } catch (e) {
    return [];
  }
}

// ASYNC version - loads from Supabase
async function getActivityLogAsync() {
  if (typeof SupabaseDB !== 'undefined' && currentUser) {
    try {
      const activities = await SupabaseDB.getActivities(currentUser.id, 100);
      // Transform timestamp from ISO string to milliseconds for UI compatibility
      return activities.map(a => ({
        ...a,
        timestamp: new Date(a.timestamp).getTime()
      }));
    } catch (err) {
      console.error('‚ùå Error loading activities from Supabase:', err);
      // Fallback to localStorage
      return getActivityLog();
    }
  } else {
    return getActivityLog();
  }
}

// Gem aktivitetslog (for localStorage fallback)
function saveActivityLog(log) {
  // Behold kun de seneste 100 aktiviteter
  const trimmed = log.slice(0, 100);
  localStorage.setItem(ACTIVITY_LOG_KEY, JSON.stringify(trimmed));
}

// Log en aktivitet
async function logActivity(type, description, details = {}) {
  // Save to Supabase if available
  let activity;
  if (typeof SupabaseDB !== 'undefined' && currentUser) {
    try {
      activity = await SupabaseDB.logActivity(currentUser.id, type, description, details);
      console.log('‚úÖ Activity logged to Supabase:', activity.id);
    } catch (err) {
      console.error('‚ùå Error logging to Supabase:', err);
      // Fallback to localStorage
      activity = {
        id: 'act_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
        type: type,
        description: description,
        details: details,
        timestamp: Date.now(),
        seen: false
      };
    }
  } else {
    // Fallback to localStorage
    activity = {
      id: 'act_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
      type: type,
      description: description,
      details: details,
      timestamp: Date.now(),
      seen: false
    };
    const log = getActivityLog();
    log.unshift(activity);
    saveActivityLog(log);
  }

  // Opdater UI
  updateRecentActivityUI();
  updateActivityIndicators();

  // REAL-TIME INTEGRATION: Tilf√∏j automatisk bl√• prik via NotificationSystem
  if (typeof NotificationSystem !== 'undefined' && details.category) {
    const notificationPath = buildNotificationPath(details.category, details.subCategory);
    NotificationSystem.add(notificationPath, {
      title: 'Ny aktivitet',
      message: description,
      timestamp: Date.now(),
      activityId: activity.id
    });
    console.log(`üîµ Auto-notification added: ${notificationPath} -> "${description}"`);
  }

  return activity;
}

/**
 * Build notification path from category and subcategory
 * Used for NotificationSystem integration
 */
function buildNotificationPath(category, subCategory) {
  // Special handling for integrationer
  if (category === 'integrationer' && subCategory) {
    return `${category}.${subCategory}`;
  }
  // For other categories with subcategories
  if (subCategory) {
    return `${category}.${subCategory}`;
  }
  // Just category
  return category;
}

// Mark√©r aktivitet som set
function markActivitySeen(activityId) {
  const log = getActivityLog();
  const activity = log.find(a => a.id === activityId);
  if (activity) {
    activity.seen = true;
    saveActivityLog(log);
    updateActivityIndicators();
  }
}

// Mark√©r alle aktiviteter i en kategori som set
function markCategoryActivitiesSeen(category, subCategory = null) {
  const log = getActivityLog();
  let changed = false;
  log.forEach(a => {
    if (a.details?.category === category && !a.seen) {
      if (!subCategory || a.details?.subCategory === subCategory) {
        a.seen = true;
        changed = true;
      }
    }
  });
  if (changed) {
    saveActivityLog(log);
    updateActivityIndicators();
  }
}

// F√• usete aktiviteter for en kategori
function getUnseenActivities(category = null, subCategory = null) {
  const log = getActivityLog();
  return log.filter(a => {
    if (a.seen) return false;
    if (category && a.details?.category !== category) return false;
    if (subCategory && a.details?.subCategory !== subCategory) return false;
    return true;
  });
}

// Formater tidspunkt relativt
function formatRelativeTime(timestamp) {
  const now = Date.now();
  const diff = now - timestamp;
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);
  
  if (minutes < 1) return 'Lige nu';
  if (minutes < 60) return `${minutes} minut${minutes !== 1 ? 'ter' : ''} siden`;
  if (hours < 24) return `${hours} time${hours !== 1 ? 'r' : ''} siden`;
  if (days < 7) return `${days} dag${days !== 1 ? 'e' : ''} siden`;
  
  const date = new Date(timestamp);
  return date.toLocaleDateString('da-DK', { day: 'numeric', month: 'short' });
}

// Opdater Seneste Aktivitet UI p√• dashboard
function updateRecentActivityUI() {
  const container = document.getElementById('recent-activity');
  if (!container) return;
  
  const log = getActivityLog().slice(0, 5); // Vis kun de 5 seneste
  
  if (log.length === 0) {
    container.innerHTML = `
      <div style="text-align:center;padding:20px;color:var(--muted)">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom:8px"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        <div>Ingen aktivitet endnu</div>
      </div>
    `;
    return;
  }
  
  container.innerHTML = log.map(activity => {
    const typeInfo = ACTIVITY_TYPES[activity.type] || ACTIVITY_TYPES.system;
    const details = activity.details || {};
    
    // Byg detalje-tekst
    let detailText = '';
    if (details.field) {
      detailText = ` -> ${details.field}`;
      if (details.newValue) {
        detailText += `: "${details.newValue}"`;
      }
    }
    
    return `
      <div class="activity-item ${activity.seen ? '' : 'unseen'}" data-activity-id="${activity.id}" onclick="showActivityDetail('${activity.id}')">
        <div class="activity-dot ${typeInfo.color}"></div>
        <div class="activity-content">
          <div class="activity-text">${activity.description}${detailText}</div>
          <div class="activity-time">${formatRelativeTime(activity.timestamp)}</div>
        </div>
        ${!activity.seen ? '<span class="activity-new-badge">NY</span>' : ''}
      </div>
    `;
  }).join('');
}

// DEAKTIVERET: Bruger NotificationSystem til bl√• prikker i stedet
// Activity Logging System bruges stadig til "Seneste Aktiviteter" sektionen
function updateActivityIndicators() {
  // NO-OP: NotificationSystem h√•ndterer bl√• prikker nu
  return;
  // Ryd alle eksisterende indikatorer
  document.querySelectorAll('.activity-indicator').forEach(el => el.remove());

  const log = getActivityLog();
  const unseenByCategory = {};
  
  // Grupp√©r usete aktiviteter efter PRIM√ÜR kategori (details.category)
  // Ignorer aktiviteter uden gyldig kategori
  log.filter(a => !a.seen && a.details?.category).forEach(a => {
    const cat = a.details.category;
    const subCat = a.details?.subCategory || null;
    
    if (!unseenByCategory[cat]) {
      unseenByCategory[cat] = { count: 0, subCategories: {} };
    }
    unseenByCategory[cat].count++;
    
    if (subCat) {
      if (!unseenByCategory[cat].subCategories[subCat]) {
        unseenByCategory[cat].subCategories[subCat] = 0;
      }
      unseenByCategory[cat].subCategories[subCat]++;
    }
  });
  
  // Mapping fra nav-element til hvilke prim√¶re kategorier der skal matche
  // VIGTIGT: Kun match p√• prim√¶r category, IKKE subCategory
  const categoryMappings = {
    'kunder': ['kunder'],           // Kun aktiviteter med category:'kunder'
    'workflow': ['workflow'],       // Kun aktiviteter med category:'workflow'
    'dagsrapport': ['dagsrapport'],
    'ordrer': ['ordrer'],
    'indstillinger': ['indstillinger', 'settings'],
    'integrationer': ['integrationer'],
    'pages': ['pages'],             // FASE 7: Side-aktiviteter (omd\u00f8bning, nye sider, etc.)
    'dashboard': ['pages']          // FASE 7: Dashboard viser ogs\u00e5 'pages' aktiviteter
  };
  
  Object.entries(categoryMappings).forEach(([navId, categories]) => {
    const totalUnseen = categories.reduce((sum, cat) => sum + (unseenByCategory[cat]?.count || 0), 0);
    if (totalUnseen > 0) {
      // Find nav-item
      const navItem = document.querySelector(`#nav-${navId}`) || 
                      document.querySelector(`[onclick*="showPage('${navId}')"]`) ||
                      document.querySelector(`[onclick*="toggleNavDropdown('${navId}')"]`);
      if (navItem) {
        addActivityIndicator(navItem, totalUnseen);
      }
    }
  });
  
  // Tilf√∏j indikatorer til underkategorier i kunde-dropdown (baseret p√• subCategory)
  if (unseenByCategory['kunder']) {
    Object.entries(unseenByCategory['kunder'].subCategories).forEach(([subCat, count]) => {
      if (count > 0) {
        const subNavItem = document.querySelector(`[onclick*="showCustomerSubpage('${subCat}')"]`);
        if (subNavItem) {
          addActivityIndicator(subNavItem, count, true);
        }
      }
    });
  }
  
  // Tilf√∏j indikatorer til indstillinger-dropdown
  if (unseenByCategory['indstillinger']) {
    Object.entries(unseenByCategory['indstillinger'].subCategories).forEach(([subCat, count]) => {
      if (count > 0) {
        const subNavItem = document.querySelector(`[onclick*="showSettingsPage('${subCat}')"]`);
        if (subNavItem) {
          addActivityIndicator(subNavItem, count, true);
        }
      }
    });
  }

  // Tilf√∏j indikatorer til integrationer-dropdown
  if (unseenByCategory['integrationer']) {
    Object.entries(unseenByCategory['integrationer'].subCategories).forEach(([subCat, count]) => {
      if (count > 0) {
        const subNavItem = document.querySelector(`[onclick*="showPage('${subCat}')"]`);
        if (subNavItem) {
          addActivityIndicator(subNavItem, count, true);
        }
      }
    });
  }
}

// DEAKTIVERET: Bruger NotificationSystem til bl√• prikker i stedet
function addActivityIndicator(element, count, isSubItem = false) {
  // NO-OP: NotificationSystem h√•ndterer bl√• prikker nu
  return;
  if (!element) return;

  // Fjern eksisterende
  const existing = element.querySelector('.activity-indicator');
  if (existing) existing.remove();

  const indicator = document.createElement('span');
  indicator.className = 'activity-indicator' + (isSubItem ? ' sub-item' : '');
  indicator.title = `${count} nye opdatering${count !== 1 ? 'er' : ''}`;
  indicator.onclick = (e) => {
    e.stopPropagation();
    showAllActivities();
  };
  element.style.position = 'relative';

  // Add hover event handlers if in hover mode
  const settings = getActivityIndicatorSettings();
  if (settings.dismissType === 'hover') {
    // Extract category from element's onclick attribute
    const onclickAttr = element.getAttribute('onclick');
    let category = null;

    // Try to match showPage('category') or showSettingsPage('category')
    const pageMatch = onclickAttr?.match(/showPage\('(.+?)'\)/);
    const settingsMatch = onclickAttr?.match(/showSettingsPage\('(.+?)'\)/);

    if (pageMatch) {
      category = pageMatch[1];
    } else if (settingsMatch) {
      category = settingsMatch[1];
    }

    // For dropdown toggles, extract from toggleNavDropdown('category')
    const dropdownMatch = onclickAttr?.match(/toggleNavDropdown\('(.+?)'\)/);
    if (dropdownMatch) {
      category = dropdownMatch[1];
    }

    if (category) {
      // Store hover handler to avoid duplicates
      if (!element._activityHoverAdded) {
        element._activityHoverAdded = true;

        element.addEventListener('mouseenter', function() {
          // Mark activities as seen when hovering
          markCategoryActivitiesSeen(category);

          // For integrationer category, also mark subcategories
          if (category === 'bogholderi' || category === 'betaling') {
            markCategoryActivitiesSeen('integrationer', category);
          }
        });

        element.addEventListener('mouseleave', function() {
          // Remove indicator when mouse leaves
          const ind = element.querySelector('.activity-indicator');
          if (ind) {
            ind.remove();
          }
        });
      }
    }
  }

  element.appendChild(indicator);
}

// Vis aktivitetsdetalje (mark√©r som set)
function showActivityDetail(activityId) {
  const activity = getActivityLog().find(a => a.id === activityId);
  if (!activity) return;

  // Mark as seen
  markActivitySeen(activityId);

  // Populate detail page
  const typeInfo = ACTIVITY_TYPES[activity.type] || ACTIVITY_TYPES.system;

  document.getElementById('detail-activity-dot').className = `activity-dot ${typeInfo.color}`;
  document.getElementById('detail-activity-title').textContent = activity.description;
  document.getElementById('detail-activity-time').textContent = formatRelativeTime(activity.timestamp);

  // Show real username instead of "System"
  const details = activity.details || {};
  const userName = details.user || (currentUser ? currentUser.email : 'System');
  document.getElementById('detail-activity-user').textContent = userName;

  // Build detailed "what changed" text
  let whatChanged = activity.description;

  if (details.field) {
    whatChanged += `\n\nFelt: ${details.field}`;
  }
  if (details.category) {
    whatChanged += `\n\nKategori: ${details.category}`;
  }
  if (details.subCategory) {
    whatChanged += ` > ${details.subCategory}`;
  }
  if (details.restaurantName) {
    whatChanged += `\n\nRestaurant: ${details.restaurantName}`;
  }

  document.getElementById('detail-what-changed').textContent = whatChanged;

  // Update subtitle with activity type
  const subtitle = document.getElementById('activity-detail-subtitle');
  if (subtitle) {
    subtitle.textContent = `${typeInfo.label} ‚Ä¢ ${formatRelativeTime(activity.timestamp)}`;
  }

  // Before/After section
  if (details.oldValue && details.newValue) {
    document.getElementById('detail-before-after').style.display = 'block';
    document.getElementById('detail-old-value').textContent = details.oldValue;
    document.getElementById('detail-new-value').textContent = details.newValue;
  } else if (details.oldName && details.newName) {
    // For page renames
    document.getElementById('detail-before-after').style.display = 'block';
    document.getElementById('detail-old-value').textContent = details.oldName;
    document.getElementById('detail-new-value').textContent = details.newName;
  } else {
    document.getElementById('detail-before-after').style.display = 'none';
  }

  // Location section
  const locationText = getActivityLocationText(activity);
  document.getElementById('detail-location-text').textContent = locationText;

  // "G√• til √¶ndringen" button
  const goToBtn = document.getElementById('detail-go-to-location');
  goToBtn.onclick = () => navigateToActivity(activity);

  // Show page (NOTE: showPage adds 'page-' prefix automatically!)
  showPage('activity-detail');
}

// Hent lokationstekst for aktivitet
function getActivityLocationText(activity) {
  const details = activity.details || {};

  if (details.category === 'pages') {
    return `Navigation -> ${details.pageName || details.oldName || 'Ukendt side'}`;
  } else if (details.category === 'kunder') {
    if (details.subCategory && details.restaurantName) {
      const subCategoryLabels = {
        'stamdata': 'Stamdata',
        'produkter': 'Produkter',
        'kategorier': 'Kategorier',
        'faktura': 'Faktura',
        'workflow-kontrol': 'Workflow Kontrol',
        'beskeder': 'Beskeder',
        'review': 'Review Links'
      };
      const subLabel = subCategoryLabels[details.subCategory] || details.subCategory;
      return `Kunder -> ${details.restaurantName} -> ${subLabel}`;
    } else if (details.restaurantName) {
      return `Kunder -> ${details.restaurantName}`;
    }
    return 'Kunder';
  } else if (details.category === 'workflow') {
    return details.restaurantName ? `Workflow -> ${details.restaurantName}` : 'Workflow';
  } else if (details.category === 'indstillinger') {
    return 'Indstillinger';
  } else if (details.category === 'integrationer') {
    return 'Integrationer';
  } else if (details.category === 'ordrer') {
    return 'Ordrer';
  }

  return details.category || 'System';
}

// Naviger til aktivitets lokation
function navigateToActivity(activity) {
  const details = activity.details || {};

  // === ROLLE-CHECK: Blok√©r navigation til kunde-aktiviteter for demo/kunde ===
  const isCustomerView = currentUser?.role && [ROLES.CUSTOMER, ROLES.DEMO].includes(currentUser.role);

  // Navigate to the page based on category
  if (details.category === 'pages') {
    // Navigate to specific page if pageId is provided
    if (details.pageId) {
      showPage(details.pageId);
    } else {
      showPage('dashboard');
    }
  } else if (details.category === 'kunder') {
    // Blok√©r for demo/kunde brugere
    if (isCustomerView) {
      console.warn('üö´ Blocked activity navigation to kunder for demo/kunde user');
      return;
    }
    showPage('kunder');
    const customerId = details.customerId || details.restaurantId;
    if (customerId) {
      // Load specific customer profile
      setTimeout(() => {
        showCrmProfileView(customerId);
        if (details.subCategory) {
          setTimeout(() => {
            showCustomerSubpage(details.subCategory);
            // Highlight changed field if specified
            if (details.field) {
              setTimeout(() => highlightChangedField(details.field), 300);
            }
          }, 300);
        } else if (details.field) {
          // If no subCategory but field is specified, still highlight
          setTimeout(() => highlightChangedField(details.field), 300);
        }
      }, 200);
    }
  } else if (details.category === 'workflow') {
    showPage('workflow');
    const customerId = details.customerId || details.restaurantId;
    if (customerId) {
      setTimeout(() => {
        showCrmProfileView(customerId);
        // Highlight changed field if specified
        if (details.field) {
          setTimeout(() => highlightChangedField(details.field), 300);
        }
      }, 200);
    }
  } else if (details.category === 'indstillinger') {
    showPage('settings');
  } else if (details.category === 'ordrer') {
    showPage('orders');
  } else {
    // Default to dashboard
    showPage('dashboard');
  }

  // Add in-page indicator with delay to ensure page is loaded
  if (details.targetElementSelector) {
    setTimeout(() => {
      addInPageIndicator(details.targetElementSelector, activity.id);
    }, 500);
  }
}

// Tilf√∏j in-page aktivitetsindikator (pr√¶cis blue dot)
function addInPageIndicator(elementSelector, activityId) {
  // Remove existing in-page indicators
  document.querySelectorAll('.in-page-activity-indicator').forEach(el => el.remove());

  // Find target element
  const targetElement = document.querySelector(elementSelector);
  if (!targetElement) {
    console.warn(`Target element not found: ${elementSelector}`);
    return;
  }

  // Create indicator
  const indicator = document.createElement('span');
  indicator.className = 'in-page-activity-indicator';
  indicator.dataset.activityId = activityId;
  indicator.title = 'Denne √¶ndring er ny';

  // Position next to element
  if (targetElement.tagName === 'H1' || targetElement.tagName === 'H2') {
    // For headers, insert after
    targetElement.insertAdjacentElement('afterend', indicator);
  } else {
    // For other elements, position absolutely
    indicator.style.position = 'absolute';
    targetElement.style.position = 'relative';
    targetElement.appendChild(indicator);
  }

  // Highlight target element
  targetElement.classList.add('has-activity-indicator');

  // Auto-remove when user interacts with the element
  const markSeenOnInteraction = () => {
    indicator.remove();
    targetElement.classList.remove('has-activity-indicator');
    markActivitySeen(activityId);
  };

  targetElement.addEventListener('click', markSeenOnInteraction, { once: true });

  // Auto-remove after 30 seconds on page
  setTimeout(() => {
    if (indicator.parentElement) {
      indicator.remove();
      targetElement.classList.remove('has-activity-indicator');
      markActivitySeen(activityId);
    }
  }, 30000);
}

// Highlight changed field when navigating to activity
function highlightChangedField(fieldName) {
  // Find input/element by name, ID, or data-field attribute
  const input = document.querySelector(`[name="${fieldName}"], #${fieldName}, [data-field="${fieldName}"]`);

  if (input) {
    // Scroll into view
    input.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // Add highlight animation
    input.classList.add('field-highlight');
    setTimeout(() => input.classList.remove('field-highlight'), 3000);

    // Focus if it's an input
    if (input.tagName === 'INPUT' || input.tagName === 'TEXTAREA' || input.tagName === 'SELECT') {
      setTimeout(() => input.focus(), 500);
    }
  } else {
    console.warn(`Field not found for highlighting: ${fieldName}`);
  }
}

// Vis alle aktiviteter (ny side)
function showAllActivities() {
  showPage('activities');
  loadActivitiesPage();
}

// Load aktiviteter side
function loadActivitiesPage() {
  const container = document.getElementById('activities-list');
  if (!container) return;
  
  const log = getActivityLog().slice(0, 30); // De seneste 30
  
  if (log.length === 0) {
    container.innerHTML = `
      <div style="text-align:center;padding:40px;color:var(--muted)">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom:16px;opacity:0.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        <div style="font-size:16px;margin-bottom:8px">Ingen aktiviteter</div>
        <div style="font-size:13px">Aktiviteter vil blive vist her n√•r der sker √¶ndringer i systemet</div>
      </div>
    `;
    return;
  }
  
  // Grupp√©r efter dato
  const grouped = {};
  log.forEach(activity => {
    const date = new Date(activity.timestamp);
    const dateKey = date.toLocaleDateString('da-DK', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    if (!grouped[dateKey]) grouped[dateKey] = [];
    grouped[dateKey].push(activity);
  });
  
  container.innerHTML = Object.entries(grouped).map(([dateStr, activities]) => `
    <div class="activity-date-group">
      <div class="activity-date-header">${dateStr}</div>
      ${activities.map(activity => {
        const typeInfo = ACTIVITY_TYPES[activity.type] || ACTIVITY_TYPES.system;
        const details = activity.details || {};
        const time = new Date(activity.timestamp).toLocaleTimeString('da-DK', { hour: '2-digit', minute: '2-digit' });
        
        let detailPath = '';
        if (details.category) {
          detailPath = details.category;
          if (details.subCategory) detailPath += ' -> ' + details.subCategory;
          if (details.field) detailPath += ' -> ' + details.field;
        }
        
        return `
          <div class="activity-item-full ${activity.seen ? '' : 'unseen'}" onclick="showActivityDetail('${activity.id}')">
            <div class="activity-time-col">${time}</div>
            <div class="activity-dot-col"><div class="activity-dot ${typeInfo.color}"></div></div>
            <div class="activity-main-col">
              <div class="activity-description">${activity.description}</div>
              ${detailPath ? `<div class="activity-path">${detailPath}</div>` : ''}
              ${details.oldValue && details.newValue ? `
                <div class="activity-change">
                  <span class="old-value">${details.oldValue}</span>
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
                  <span class="new-value">${details.newValue}</span>
                </div>
              ` : ''}
              ${details.restaurantName ? `<div class="activity-restaurant">${details.restaurantName}</div>` : ''}
            </div>
            <div class="activity-type-col">
              <span class="activity-type-badge ${typeInfo.color}">${typeInfo.label}</span>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `).join('');
  
  // Mark√©r alle viste som set
  log.forEach(a => markActivitySeen(a.id));
}

// Generer demo aktiviteter
function generateDemoActivities() {
  const existingLog = getActivityLog();
  
  // Rens eventuelle korrupte/gamle aktiviteter - mark√©r alle demo aktiviteter som set
  if (existingLog.length > 0) {
    let needsSave = false;
    existingLog.forEach(a => {
      // Mark√©r demo aktiviteter som set
      if (a.id && a.id.startsWith('demo_') && !a.seen) {
        a.seen = true;
        needsSave = true;
      }
      // Mark√©r aktiviteter uden gyldig kategori som set (korrupte data)
      if (!a.details?.category && !a.seen) {
        a.seen = true;
        needsSave = true;
      }
    });
    if (needsSave) {
      saveActivityLog(existingLog);
    }
    return; // Allerede genereret
  }
  
  const now = Date.now();
  const demoActivities = [
    { type: 'order', description: 'Ny ordre modtaget: 2x Margharita', details: { category: 'ordrer' }, offset: 2 * 60000 },
    { type: 'workflow', description: 'Workflow test gennemf√∏rt', details: { category: 'workflow' }, offset: 5 * 60000 },
    { type: 'update', description: 'Restaurant opdateret', details: { category: 'kunder', subCategory: 'stamdata', field: 'Navn', oldValue: 'Bella Italia', newValue: 'Bella Italia Ristorante', restaurantName: 'Bella Italia' }, offset: 12 * 60000 },
    { type: 'ai', description: 'AI klassificering: GREETING', details: { category: 'workflow' }, offset: 18 * 60000 },
    { type: 'update', description: '√Öbningstider √¶ndret', details: { category: 'kunder', subCategory: 'stamdata', field: '√Öbningstider', restaurantName: 'Sushi House' }, offset: 45 * 60000 },
    { type: 'create', description: 'Nyt produkt oprettet', details: { category: 'kunder', subCategory: 'produkter', field: 'Pizza Diavola', restaurantName: 'Bella Italia' }, offset: 2 * 3600000 },
    { type: 'update', description: 'Kontaktperson opdateret', details: { category: 'kunder', subCategory: 'stamdata', field: 'Kontaktperson', oldValue: 'Marco Rossi', newValue: 'Giulia Bianchi', restaurantName: 'Bella Italia' }, offset: 5 * 3600000 },
    { type: 'system', description: 'Faktura genereret', details: { category: 'kunder', subCategory: 'faktura', restaurantName: 'Thai Orchid' }, offset: 24 * 3600000 },
    { type: 'workflow', description: 'SMS sendt til kunde', details: { category: 'workflow' }, offset: 26 * 3600000 },
    { type: 'update', description: 'Priser opdateret', details: { category: 'kunder', subCategory: 'produkter', field: 'Priser', restaurantName: 'Sushi House' }, offset: 48 * 3600000 },
    { type: 'login', description: 'Bruger logget ind', details: { category: 'system' }, offset: 72 * 3600000 },
    { type: 'create', description: 'Ny restaurant oprettet', details: { category: 'kunder', subCategory: 'stamdata', field: 'Restaurant', restaurantName: 'New Restaurant' }, offset: 96 * 3600000 }
  ];
  
  const log = demoActivities.map((a, i) => ({
    id: 'demo_' + i,
    type: a.type,
    description: a.description,
    details: a.details,
    timestamp: now - a.offset,
    seen: true // Demo-aktiviteter er altid set - kun rigtige aktiviteter trigger indikatorer
  }));
  
  saveActivityLog(log);
}

// Wrapper funktion til at logge felt√¶ndringer
function logFieldChange(restaurantName, category, subCategory, field, oldValue, newValue) {
  const description = `${field} opdateret`;
  logActivity('update', description, {
    category: category,
    subCategory: subCategory,
    field: field,
    oldValue: oldValue,
    newValue: newValue,
    restaurantName: restaurantName
  });
}

// TEST FUNCTION - FASE 7: Test activity tracking med demo data
// Fjern senere n√•r side-management UI er bygget
function testActivityTracking() {
  console.log('üß™ Tester aktivitets-tracking system...');

  // Test 1: Side omd√∏bning
  logActivity('page_rename', 'Side omd√∏bt: Indstillinger -> Ops√¶tning', {
    category: 'pages',
    subCategory: 'navigation',
    pageId: 'page-settings',
    oldName: 'Indstillinger',
    newName: 'Ops√¶tning',
    targetElementSelector: '#page-settings .page-header h1'
  });
  console.log('‚úì Test 1: Side omd√∏bning logged');

  // Test 2: Ny side oprettet
  logActivity('page_create', 'Ny side oprettet: Analyser', {
    category: 'pages',
    subCategory: 'navigation',
    pageId: 'page-analyser',
    pageName: 'Analyser',
    targetElementSelector: '.nav-item[data-page="analyser"]'
  });
  console.log('‚úì Test 2: Ny side oprettet logged');

  // Test 3: Side-r√¶kkef√∏lge √¶ndret
  logActivity('page_reorder', 'Side flyttet: Produktrapport til position 3', {
    category: 'pages',
    subCategory: 'navigation',
    movedPage: 'Produktrapport',
    oldPosition: 5,
    newPosition: 3,
    targetElementSelector: '.nav-item[data-page="produktrapport"]'
  });
  console.log('‚úì Test 3: Side-r√¶kkef√∏lge √¶ndring logged');

  // Test 4: Medarbejder aktivitet
  logActivity('employee', 'Medarbejder "John Doe" tilf√∏jet til restaurant', {
    category: 'kunder',
    subCategory: 'stamdata',
    restaurantName: 'Demo Restaurant',
    employeeName: 'John Doe'
  });
  console.log('‚úì Test 4: Medarbejder aktivitet logged');

  // Test 5: Bruger aktivitet
  logActivity('user', 'Bruger opdateret restaurant stamdata', {
    category: 'kunder',
    subCategory: 'stamdata',
    restaurantName: 'Test Restaurant',
    field: 'Adresse',
    oldValue: 'Gl. Adresse 123',
    newValue: 'Ny Adresse 456'
  });
  console.log('‚úì Test 5: Bruger aktivitet logged');

  console.log('‚úÖ Alle test aktiviteter oprettet!');
  console.log('üí° Klik p√• en aktivitet i "Seneste Aktivitet" sektionen for at se detaljer');
  console.log('üí° Klik "G√• til √¶ndringen" for at se in-page blue dot (hvis targetElementSelector findes)');

  return 'Test completed! Check the Recent Activity section on the dashboard.';
}

// Filtrer aktiviteter p√• aktivitetssiden
function filterActivities() {
  const typeFilter = document.getElementById('activity-filter-type')?.value || '';
  const categoryFilter = document.getElementById('activity-filter-category')?.value || '';
  
  const container = document.getElementById('activities-list');
  if (!container) return;
  
  let log = getActivityLog().slice(0, 30);
  
  // Anvend filtre
  if (typeFilter) {
    log = log.filter(a => a.type === typeFilter);
  }
  if (categoryFilter) {
    log = log.filter(a => a.details?.category === categoryFilter || a.details?.subCategory === categoryFilter);
  }
  
  if (log.length === 0) {
    container.innerHTML = `
      <div style="text-align:center;padding:40px;color:var(--muted)">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom:16px;opacity:0.5"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
        <div style="font-size:16px;margin-bottom:8px">Ingen aktiviteter matcher filteret</div>
        <div style="font-size:13px">Pr√∏v at √¶ndre filtreringen</div>
      </div>
    `;
    return;
  }
  
  // Render filtrerede aktiviteter
  const grouped = {};
  log.forEach(activity => {
    const date = new Date(activity.timestamp);
    const dateKey = date.toLocaleDateString('da-DK', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    if (!grouped[dateKey]) grouped[dateKey] = [];
    grouped[dateKey].push(activity);
  });
  
  container.innerHTML = Object.entries(grouped).map(([dateStr, activities]) => `
    <div class="activity-date-group">
      <div class="activity-date-header">${dateStr}</div>
      ${activities.map(activity => {
        const typeInfo = ACTIVITY_TYPES[activity.type] || ACTIVITY_TYPES.system;
        const details = activity.details || {};
        const time = new Date(activity.timestamp).toLocaleTimeString('da-DK', { hour: '2-digit', minute: '2-digit' });
        
        let detailPath = '';
        if (details.category) {
          detailPath = details.category;
          if (details.subCategory) detailPath += ' -> ' + details.subCategory;
          if (details.field) detailPath += ' -> ' + details.field;
        }
        
        return `
          <div class="activity-item-full ${activity.seen ? '' : 'unseen'}"
               data-activity-id="${activity.id}"
               onclick="showActivityDetail('${activity.id}')"
               style="cursor:pointer">
            <div class="activity-time-col">${time}</div>
            <div class="activity-dot-col"><div class="activity-dot ${typeInfo.color}"></div></div>
            <div class="activity-main-col">
              <div class="activity-description">${activity.description}</div>
              ${detailPath ? `<div class="activity-path">${detailPath}</div>` : ''}
              ${details.oldValue && details.newValue ? `
                <div class="activity-change">
                  <span class="old-value">${details.oldValue}</span>
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
                  <span class="new-value">${details.newValue}</span>
                </div>
              ` : ''}
              ${details.restaurantName ? `<div class="activity-restaurant">${details.restaurantName}</div>` : ''}
            </div>
            <div class="activity-type-col">
              <span class="activity-type-badge ${typeInfo.color}">${typeInfo.label}</span>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `).join('');
}

// Ryd aktivitetslog
function clearActivityLog() {
  if (confirm('Er du sikker p√• du vil rydde hele aktivitetsloggen?')) {
    localStorage.removeItem(ACTIVITY_LOG_KEY);
    loadActivitiesPage();
    updateRecentActivityUI();
    updateActivityIndicators();
    toast('Aktivitetslog ryddet', 'success');
  }
}

// Legacy support - gamle funktioner
const CURRENT_UPDATES = {};

function getSeenUpdates() {
  try {
    return JSON.parse(localStorage.getItem(UPDATE_STORAGE_KEY) || '[]');
  } catch (e) {
    return [];
  }
}

function markUpdateSeen(updateId) {
  const seen = getSeenUpdates();
  if (!seen.includes(updateId)) {
    seen.push(updateId);
    localStorage.setItem(UPDATE_STORAGE_KEY, JSON.stringify(seen));
  }
}

function hasUnseenUpdates(elementId) {
  return getUnseenActivities(elementId).length > 0;
}

function addUpdateIndicator(element, updateId) {
  addActivityIndicator(element, 1);
}

function initUpdateIndicators() {
  // DEAKTIVERET: Demo aktiviteter fjernet i produktion
  // generateDemoActivities();

  updateActivityIndicators();
  updateRecentActivityUI();
}

function markPageUpdatesAsSeen(pageName) {
  const settings = getActivityIndicatorSettings();

  // Only auto-mark as seen if NOT in hover mode
  if (settings.dismissType !== 'hover') {
    // Marker aktiviteter i prim√¶r kategori
    markCategoryActivitiesSeen(pageName);

    // For integrationer undersider (bogholderi, betaling), marker ogs√•:
    // 1. Aktiviteter med category 'integrationer' og matching subCategory
    // 2. ALLE aktiviteter med category 'integrationer' UDEN subCategory (legacy/fejl)
    if (pageName === 'bogholderi' || pageName === 'betaling') {
      markCategoryActivitiesSeen('integrationer', pageName);

      // Marker ogs√• integrationer aktiviteter UDEN subCategory
      const log = getActivityLog();
      let changed = false;
      log.forEach(a => {
        if (a.details?.category === 'integrationer' && !a.details?.subCategory && !a.seen) {
          a.seen = true;
          changed = true;
        }
      });
      if (changed) {
        saveActivityLog(log);
        updateActivityIndicators();
      }
    }

    // INTEGRATION MED NOTIFICATIONSYSTEM: Fjern notifikationer for denne side
    if (typeof NotificationSystem !== 'undefined') {
      // Konverter pageName til notification path
      let notificationPath = pageName;

      // Special handling for integrationer undersider
      if (pageName === 'bogholderi') {
        notificationPath = 'integrationer.bogholderi';
      } else if (pageName === 'betaling') {
        notificationPath = 'integrationer.betaling';
      }

      // Fjern alle notifikationer under denne path (og alle child paths)
      NotificationSystem.clearPath(notificationPath);

      // Ogs√• fjern parent path hvis det er en underside
      if (pageName === 'bogholderi' || pageName === 'betaling') {
        // Tjek om der er flere notifikationer under integrationer, ellers fjern parent ogs√•
        // FIXED: Brug notifications.keys() i stedet for getAll()
        let hasOtherIntegrationNotifications = false;
        NotificationSystem.notifications.forEach((notif, path) => {
          if (path.startsWith('integrationer.') && path !== notificationPath) {
            hasOtherIntegrationNotifications = true;
          }
        });

        if (!hasOtherIntegrationNotifications) {
          NotificationSystem.clearPath('integrationer');
        }
      }

      console.log(`üîµ Cleared notifications for path: ${notificationPath}`);
    }
  }
  // In hover mode, don't auto-mark as seen - wait for hover interaction
}

// Activity Indicator Settings Management
function getActivityIndicatorSettings() {
  const stored = localStorage.getItem('orderflow_activity_indicator_settings');
  if (stored) {
    try {
      return JSON.parse(stored);
    } catch(e) {
      console.error('Error parsing activity indicator settings:', e);
    }
  }
  // Default to hover mode
  return { dismissType: 'hover', dismissValue: 1 };
}

// Check and auto-dismiss activities based on time settings
function checkTimedDismissal() {
  const settings = getActivityIndicatorSettings();

  if (settings.dismissType !== 'hover') {
    const log = getActivityLog();
    const now = Date.now();
    let changed = false;

    log.forEach(activity => {
      if (!activity.seen) {
        const ageMs = now - activity.timestamp;
        let thresholdMs = 0;

        switch(settings.dismissType) {
          case 'minutes':
            thresholdMs = settings.dismissValue * 60 * 1000;
            break;
          case 'hours':
            thresholdMs = settings.dismissValue * 60 * 60 * 1000;
            break;
          case 'days':
            thresholdMs = settings.dismissValue * 24 * 60 * 60 * 1000;
            break;
        }

        if (thresholdMs > 0 && ageMs >= thresholdMs) {
          activity.seen = true;
          changed = true;
        }
      }
    });

    if (changed) {
      saveActivityLog(log);
      updateActivityIndicators();
    }
  }
}

// Start interval timer for timed dismissal (check every 30 seconds)
setInterval(checkTimedDismissal, 30000);

// Demo data
const DEMO_RESTAURANTS = [
  { 
    id: 'd1', 
    name: 'Bella Italia', 
    logo: 'pizza', 
    phone: '+4570123456', 
    status: 'active', 
    orders: 234, 
    recovered: 38, 
    features: { ai: true, sms: true },
    // CRM Data
    cvr: '12345678',
    email: 'info@bellaitalia.dk',
    owner: 'Marco Rossi',
    contactPerson: 'Giulia Bianchi',
    address: 'Vesterbrogade 45, 1620 K√∏benhavn V',
    createdAt: '2024-06-15',
    // Links
    menuUrl: 'https://bellaitalia.dk/menu',
    website: 'https://bellaitalia.dk',
    googleReviewUrl: 'https://g.page/r/bellaitalia/review',
    trustpilotUrl: 'https://trustpilot.com/review/bellaitalia.dk',
    reviewDelay: 60,
    timeFormat: '24h',
    deliveryEnabled: true,
    // Workflow Sync
    reviewRequestEnabled: true,
    // KPI Data
    kpiEnabled: true,
    kpi: {
      totalRevenue: 187450,
      recoveredRevenue: 28350,
      avgOrderValue: 285,
      reviews: {
        total: 127,
        avgRating: 4.6,
        google: { count: 89, avgRating: 4.7 },
        trustpilot: { count: 38, avgRating: 4.4 }
      },
      conversionRate: 68,
      responseTime: 2.3,
      // Extended KPIs
      aiAutomationRate: 94,
      clv: 1245,
      reviewCTR: 18.5,
      missedCalls: 56,
      completedOrders: 38,
      // Heatmap data (hour of day -> order count)
      orderHeatmap: {
        monday: [0,0,0,0,0,0,0,0,0,0,2,4,8,5,3,2,1,6,12,15,8,4,1,0],
        tuesday: [0,0,0,0,0,0,0,0,0,1,3,5,7,4,2,1,2,5,10,14,9,5,2,0],
        wednesday: [0,0,0,0,0,0,0,0,0,0,2,4,6,5,3,2,3,7,11,16,10,4,1,0],
        thursday: [0,0,0,0,0,0,0,0,0,1,2,5,8,6,4,2,2,8,14,18,12,6,2,0],
        friday: [0,0,0,0,0,0,0,0,0,0,3,6,10,7,5,3,4,10,18,22,16,8,3,0],
        saturday: [0,0,0,0,0,0,0,0,0,0,2,5,12,9,6,4,5,12,20,25,18,10,4,0],
        sunday: [0,0,0,0,0,0,0,0,0,0,1,3,8,6,4,3,4,8,14,16,10,5,2,0]
      },
      // Sentiment data
      sentiment: { positive: 78, neutral: 18, negative: 4 }
    },
    openingHours: {
      mon: { enabled: true, open: '10:00', close: '22:00' },
      tue: { enabled: true, open: '10:00', close: '22:00' },
      wed: { enabled: true, open: '10:00', close: '22:00' },
      thu: { enabled: true, open: '10:00', close: '22:00' },
      fri: { enabled: true, open: '10:00', close: '23:00' },
      sat: { enabled: true, open: '11:00', close: '23:00' },
      sun: { enabled: true, open: '12:00', close: '21:00' }
    }
  },
  { 
    id: 'd2', 
    name: 'Sushi House', 
    logo: 'sushi', 
    phone: '+4570234567', 
    status: 'active', 
    orders: 156, 
    recovered: 24, 
    features: { ai: true, sms: true },
    // CRM Data
    cvr: '87654321',
    email: 'contact@sushihouse.dk',
    owner: 'Takeshi Yamamoto',
    contactPerson: 'Lisa Hansen',
    address: 'N√∏rrebrogade 123, 2200 K√∏benhavn N',
    createdAt: '2024-08-22',
    // Links
    menuUrl: 'https://sushihouse.dk/menu',
    website: 'https://sushihouse.dk',
    googleReviewUrl: 'https://g.page/r/sushihouse/review',
    trustpilotUrl: 'https://trustpilot.com/review/sushihouse.dk',
    reviewDelay: 45,
    timeFormat: '24h',
    deliveryEnabled: true,
    // Workflow Sync
    reviewRequestEnabled: true,
    // KPI Data
    kpiEnabled: true,
    kpi: {
      totalRevenue: 142800,
      recoveredRevenue: 19200,
      avgOrderValue: 345,
      reviews: {
        total: 94,
        avgRating: 4.8,
        google: { count: 62, avgRating: 4.9 },
        trustpilot: { count: 32, avgRating: 4.6 }
      },
      conversionRate: 72,
      responseTime: 1.8,
      // Extended KPIs
      aiAutomationRate: 91,
      clv: 1580,
      reviewCTR: 22.3,
      missedCalls: 33,
      completedOrders: 24,
      // Heatmap data
      orderHeatmap: {
        monday: [0,0,0,0,0,0,0,0,0,0,1,2,4,3,2,1,1,4,8,10,6,3,1,0],
        tuesday: [0,0,0,0,0,0,0,0,0,0,1,3,5,4,2,1,2,5,9,12,7,4,1,0],
        wednesday: [0,0,0,0,0,0,0,0,0,0,2,3,5,4,3,1,2,5,10,13,8,4,2,0],
        thursday: [0,0,0,0,0,0,0,0,0,1,2,4,6,5,3,2,3,6,11,14,9,5,2,0],
        friday: [0,0,0,0,0,0,0,0,0,0,2,5,8,6,4,3,4,8,15,19,14,7,3,0],
        saturday: [0,0,0,0,0,0,0,0,0,0,2,4,9,7,5,4,5,10,17,21,15,8,3,0],
        sunday: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
      },
      sentiment: { positive: 82, neutral: 15, negative: 3 }
    },
    openingHours: {
      mon: { enabled: true, open: '11:00', close: '21:00' },
      tue: { enabled: true, open: '11:00', close: '21:00' },
      wed: { enabled: true, open: '11:00', close: '21:00' },
      thu: { enabled: true, open: '11:00', close: '21:00' },
      fri: { enabled: true, open: '11:00', close: '22:00' },
      sat: { enabled: true, open: '12:00', close: '22:00' },
      sun: { enabled: false, open: '00:00', close: '00:00' }
    }
  },
  { 
    id: 'd3', 
    name: 'Burger Joint', 
    logo: 'burger', 
    phone: null, 
    status: 'pending', 
    orders: 0, 
    recovered: 0, 
    features: { ai: true },
    // CRM Data
    cvr: '55667788',
    email: 'hello@burgerjoint.dk',
    owner: 'Anders Jensen',
    contactPerson: 'Mette Andersen',
    address: 'Amagerbrogade 78, 2300 K√∏benhavn S',
    createdAt: '2024-12-01',
    // Links
    menuUrl: 'https://burgerjoint.dk/menu',
    website: 'https://burgerjoint.dk',
    googleReviewUrl: 'https://g.page/r/burgerjoint/review',
    trustpilotUrl: 'https://trustpilot.com/review/burgerjoint.dk',
    reviewDelay: 30,
    timeFormat: '24h',
    deliveryEnabled: false,
    // Workflow Sync
    reviewRequestEnabled: true,
    // KPI Data
    kpiEnabled: false,
    kpi: {
      totalRevenue: 0,
      recoveredRevenue: 0,
      avgOrderValue: 0,
      reviews: {
        total: 0,
        avgRating: 0,
        google: { count: 0, avgRating: 0 },
        trustpilot: { count: 0, avgRating: 0 }
      },
      conversionRate: 0,
      responseTime: 0,
      // Extended KPIs
      aiAutomationRate: 0,
      clv: 0,
      reviewCTR: 0,
      missedCalls: 0,
      completedOrders: 0,
      orderHeatmap: {
        monday: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        tuesday: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        wednesday: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        thursday: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        friday: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        saturday: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        sunday: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
      },
      sentiment: { positive: 0, neutral: 0, negative: 0 }
    },
    openingHours: {
      mon: { enabled: true, open: '11:00', close: '22:00' },
      tue: { enabled: true, open: '11:00', close: '22:00' },
      wed: { enabled: true, open: '11:00', close: '22:00' },
      thu: { enabled: true, open: '11:00', close: '22:00' },
      fri: { enabled: true, open: '11:00', close: '23:00' },
      sat: { enabled: true, open: '11:00', close: '23:00' },
      sun: { enabled: true, open: '12:00', close: '21:00' }
    }
  },
  { 
    id: 'd4', 
    name: 'Caf√© Hygge', 
    logo: 'cafe', 
    phone: '+4533445566', 
    status: 'inactive', 
    orders: 0, 
    recovered: 0, 
    features: { ai: false, sms: false },
    cvr: '99887766',
    email: 'info@cafehygge.dk',
    owner: 'Louise Nielsen',
    contactPerson: 'Louise Nielsen',
    address: 'Gothersgade 55, 1123 K√∏benhavn K',
    createdAt: '2024-11-15',
    kpiEnabled: false,
    kpi: { totalRevenue: 0, recoveredRevenue: 0, avgOrderValue: 0, reviews: { total: 0, avgRating: 0, google: { count: 0, avgRating: 0 }, trustpilot: { count: 0, avgRating: 0 } }, conversionRate: 0, responseTime: 0 }
  },
  { 
    id: 'd5', 
    name: 'Pizza Express', 
    logo: 'pizza', 
    phone: '+4577889900', 
    status: 'churned', 
    orders: 156, 
    recovered: 12, 
    features: { ai: true, sms: true },
    cvr: '11223344',
    email: 'kontakt@pizzaexpress.dk',
    owner: 'Roberto Mancini',
    contactPerson: 'Roberto Mancini',
    address: '√òsterbrogade 102, 2100 K√∏benhavn √ò',
    createdAt: '2024-03-10',
    churnedAt: '2024-10-15',
    churnReason: 'Skiftede til konkurrent',
    kpiEnabled: false,
    kpi: { totalRevenue: 89500, recoveredRevenue: 8400, avgOrderValue: 245, reviews: { total: 45, avgRating: 4.1, google: { count: 30, avgRating: 4.0 }, trustpilot: { count: 15, avgRating: 4.3 } }, conversionRate: 52, responseTime: 3.8 }
  },
  // Demo Customer - Example of trial customer
  { 
    id: 'demo_example', 
    name: 'Taste of Thailand', 
    logo: 'ramen', 
    phone: '+4520304050', 
    status: 'demo',
    isDemo: true,
    demoLicense: {
      startDate: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(), // Started 5 days ago
      expiryDate: new Date(Date.now() + 9 * 24 * 60 * 60 * 1000).toISOString(), // 9 days remaining
      daysRemaining: 9,
      messagesUsed: 12,
      messagesLimit: 50,
      status: 'active'
    },
    contact: {
      firstName: 'Somchai',
      lastName: 'Patel',
      email: 'somchai@tasteofthailand.dk',
      phone: '+4520304050'
    },
    orders: 8, 
    recovered: 2, 
    features: { ai: true, sms: true, billing: false, export: false },
    cvr: '55667788',
    email: 'somchai@tasteofthailand.dk',
    owner: 'Somchai Patel',
    contactPerson: 'Somchai Patel',
    address: {
      street: 'Istedgade 78',
      zip: '1650',
      city: 'K√∏benhavn V',
      country: 'DK'
    },
    createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
    createdBy: 'demo@orderflow.ai',
    kpiEnabled: true,
    kpi: { totalRevenue: 4200, recoveredRevenue: 850, avgOrderValue: 185, reviews: { total: 3, avgRating: 4.7, google: { count: 2, avgRating: 4.5 }, trustpilot: { count: 1, avgRating: 5.0 } }, conversionRate: 68, responseTime: 1.2 },
    openingHours: {
      mon: { enabled: true, open: '16:00', close: '22:00' },
      tue: { enabled: true, open: '16:00', close: '22:00' },
      wed: { enabled: true, open: '16:00', close: '22:00' },
      thu: { enabled: true, open: '16:00', close: '22:00' },
      fri: { enabled: true, open: '16:00', close: '23:00' },
      sat: { enabled: true, open: '12:00', close: '23:00' },
      sun: { enabled: true, open: '12:00', close: '21:00' }
    }
  }
];

// Supabase is optional - demo mode works without it
supabase = null;

// =====================================================
// AUTH
// =====================================================
function showAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.auth-tab:${tab === 'login' ? 'first-child' : 'last-child'}`).classList.add('active');
  document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
  document.getElementById('signup-form').style.display = tab === 'signup' ? 'block' : 'none';
  document.getElementById('auth-error').style.display = 'none';
}

async function handleLogin(e) {
  e.preventDefault();
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;

  // Wait for Supabase to initialize (max 5 seconds)
  if (typeof window.waitForSupabase === 'function') {
    try {
      await Promise.race([
        window.waitForSupabase(),
        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 5000))
      ]);
      console.log('‚úÖ Supabase client ready for user login');
    } catch (err) {
      console.warn('‚ö†Ô∏è Supabase initialization timeout for user login');
      showAuthError('Kunne ikke forbinde til server. Pr√∏v igen om et √∏jeblik.');
      return;
    }
  }

  // Check if Supabase is available
  if (typeof supabaseClient === 'undefined' || !supabaseClient) {
    console.error('‚ùå Supabase not available after waiting');

    // Fallback for admin users
    const ADMIN_EMAILS = ['martinsarvio@hotmail.com'];
    if (ADMIN_EMAILS.includes(email.toLowerCase())) {
      console.log('üîë Using local admin fallback...');
      loginAdminLocal();
      return;
    }

    showAuthError('Kunne ikke forbinde til server. Pr√∏v igen.');
    return;
  }

  try {
    console.log('üîë Attempting login with email:', email);
    const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
    if (error) {
      console.error('‚ùå Login error:', error);
      throw error;
    }
    console.log('‚úÖ Login successful:', data.user.email);

    // Admin emails list - these users always get admin role
    const ADMIN_EMAILS = ['martinsarvio@hotmail.com'];
    const isAdmin = ADMIN_EMAILS.includes(email.toLowerCase());

    // Determine user role
    let userRole = isAdmin ? 'admin' : 'user';

    // Try to get role from database
    if (typeof SupabaseDB !== 'undefined' && SupabaseDB.getUserRole) {
      try {
        const dbRole = await SupabaseDB.getUserRole(data.user.id);
        if (dbRole && ['admin', 'employee', 'customer'].includes(dbRole)) {
          userRole = dbRole;
        }
      } catch (err) {
        console.warn('‚ö†Ô∏è Could not get user role from database:', err);
      }
    }

    // Build temporary user object for 2FA check
    const tempUser = {
      ...data.user,
      role: userRole
    };

    console.log(`üë§ User role: ${tempUser.role}${isAdmin ? ' (admin)' : ''}`);

    // =====================================================
    // 2FA CHECK - Only for admin and employee roles
    // =====================================================
    if (typeof check2FARequired === 'function' && (userRole === 'admin' || userRole === 'employee')) {
      console.log('üîê Checking 2FA requirements...');

      const twoFACheck = await check2FARequired(tempUser);

      if (twoFACheck.required) {
        if (twoFACheck.settings || twoFACheck.methods) {
          // User has 2FA set up - show challenge
          console.log('üîê 2FA required - showing challenge');

          // Store pending login data
          window._pending2FALogin = {
            user: tempUser,
            settings: twoFACheck.settings,
            isAdmin: isAdmin
          };

          // Hide login form and show 2FA challenge
          show2FAChallenge(tempUser, twoFACheck.settings);
          return; // Wait for 2FA verification

        } else if (userRole === 'employee') {
          // Employee without 2FA - force setup
          console.log('üîê Employee requires 2FA setup');

          // Store pending login data
          window._pending2FALogin = {
            user: tempUser,
            settings: null,
            isAdmin: isAdmin
          };

          // Show 2FA setup required screen
          show2FASetupRequired(tempUser);
          return; // Wait for 2FA setup
        }
        // Admin without 2FA can proceed (they can opt-out)
      }
    }

    // =====================================================
    // COMPLETE LOGIN (no 2FA required or admin opt-out)
    // =====================================================
    await finishLogin(tempUser, isAdmin);

  } catch (err) {
    showAuthError(err.message);
  }
}

/**
 * Play premium login transition animation
 * Logo zoom effect with form blur
 * @returns {Promise} Resolves when animation completes
 */
function playLoginTransition() {
  return new Promise((resolve) => {
    console.log('‚ú® Starting login transition...');

    const authCard = document.querySelector('.auth-card');
    const authLogo = document.querySelector('.auth-logo');
    const authScreen = document.getElementById('auth-screen');

    // Step 1: Blur and fade out the login form (0.8s)
    if (authCard) {
      authCard.style.transition = 'all 0.8s ease';
      authCard.style.filter = 'blur(20px)';
      authCard.style.opacity = '0';
    }

    // Step 2: Center the logo and zoom (2s) - reduceret zoom fra 3.5 til 2
    if (authLogo) {
      const logoRect = authLogo.getBoundingClientRect();
      const screenCenterY = window.innerHeight / 2;
      const logoCenterY = logoRect.top + logoRect.height / 2;
      const offsetY = screenCenterY - logoCenterY;

      authLogo.style.transition = 'all 2s ease-in-out';
      authLogo.style.transform = `translateY(${offsetY}px) scale(2)`;
    }

    // Wait for zoom animation (2s), then blur entire screen (0.5s)
    setTimeout(() => {
      // Blur hele auth-screen (baggrund + logo)
      if (authScreen) {
        authScreen.style.transition = 'all 0.5s ease';
        authScreen.style.filter = 'blur(20px)';
        authScreen.style.opacity = '0';
      }

      setTimeout(() => {
        // Reset styles
        if (authCard) {
          authCard.style.filter = '';
          authCard.style.opacity = '';
        }
        if (authLogo) {
          authLogo.style.transform = '';
          authLogo.style.filter = '';
          authLogo.style.opacity = '';
        }
        if (authScreen) {
          authScreen.style.filter = '';
          authScreen.style.opacity = '';
        }
        console.log('‚ú® Login transition complete');
        resolve();
      }, 500);
    }, 2000);
  });
}

/**
 * Complete the login process after authentication (and optional 2FA)
 */
async function finishLogin(user, isAdmin) {
  currentUser = user;

  // Persist session for "remember me" functionality
  persistSession(user);

  // Load restaurants from Supabase
  if (typeof SupabaseDB !== 'undefined') {
    try {
      const dbRestaurants = await SupabaseDB.getRestaurants(currentUser.id);
      restaurants = dbRestaurants || [];
      console.log('‚úÖ Loaded restaurants from Supabase:', restaurants.length);

      // Also merge any locally persisted restaurants (created while offline)
      loadPersistedRestaurants();
      console.log('üì¶ Total restaurants after merge:', restaurants.length);
    } catch (err) {
      console.warn('‚ö†Ô∏è Could not load restaurants from Supabase:', err);
      restaurants = [];
      // Fall back to localStorage
      loadPersistedRestaurants();
      console.log('üì¶ Loaded restaurants from localStorage:', restaurants.length);
    }

    // Initialize real-time sync
    if (typeof RealtimeSync !== 'undefined') {
      await RealtimeSync.init(currentUser.id);
    }

    // Load API settings from Supabase
    if (typeof loadAllApiSettings === 'function') {
      await loadAllApiSettings();
    }
  } else {
    // Supabase not available, use localStorage
    restaurants = [];
    loadPersistedRestaurants();
    console.log('üì¶ Loaded restaurants from localStorage (no Supabase):', restaurants.length);
  }

  // Play login transition animation
  await playLoginTransition();

  showApp();

  // Log user login activity
  logActivity('login', 'Bruger login', {
    category: 'system',
    user: currentUser.email,
    role: currentUser.role
  });

  // Register device for trusted devices tracking
  registerDevice();
}

// =====================================================
// SIGNUP FLOW (3 STEPS)
// =====================================================

let signupInviteCount = 1;
let selectedIntegrations = [];

// Signup step navigation
function nextSignupStep(step) {
  // Validate step 1 before going to step 2
  if (step === 2) {
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    const confirm = document.getElementById('signup-password-confirm')?.value || '';

    if (!email || !password) {
      showAuthError('Udfyld email og password');
      return;
    }
    if (password.length < 6) {
      showAuthError('Password skal v√¶re mindst 6 tegn');
      return;
    }
    if (password !== confirm) {
      showAuthError('Passwords matcher ikke');
      return;
    }
  }

  // Validate step 2 before going to step 3
  if (step === 3) {
    const company = document.getElementById('signup-company').value;
    if (!company) {
      showAuthError('Virksomhedsnavn er p√•kr√¶vet');
      return;
    }
  }

  // Hide all steps
  document.querySelectorAll('.signup-step').forEach(s => s.style.display = 'none');
  document.getElementById(`signup-step-${step}`).style.display = 'block';

  // Update step dots (now 3 steps)
  document.querySelectorAll('.step-dot').forEach((dot, i) => {
    dot.style.background = (i + 1) <= step ? 'var(--accent)' : 'var(--border)';
  });

  // Clear any error
  document.getElementById('auth-error').style.display = 'none';
}

function prevSignupStep(step) {
  document.querySelectorAll('.signup-step').forEach(s => s.style.display = 'none');
  document.getElementById(`signup-step-${step}`).style.display = 'block';

  // Update step dots
  document.querySelectorAll('.step-dot').forEach((dot, i) => {
    dot.style.background = (i + 1) <= step ? 'var(--accent)' : 'var(--border)';
  });
}

// Team invite field management
function addInviteField() {
  signupInviteCount++;
  const container = document.getElementById('team-invite-list');
  const newRow = document.createElement('div');
  newRow.className = 'invite-row';
  newRow.innerHTML = `
    <input type="email" class="input invite-email" placeholder="kollega@email.dk">
    <select class="input invite-role">
      <option value="staff">Medarbejder</option>
      <option value="manager">Manager</option>
    </select>
    <button type="button" class="btn-icon-remove" onclick="this.parentElement.remove()">√ó</button>
  `;
  container.appendChild(newRow);
}

// Integration toggle
function toggleIntegration(integration) {
  const btn = document.querySelector(`[data-integration="${integration}"]`);
  const index = selectedIntegrations.indexOf(integration);

  if (index > -1) {
    selectedIntegrations.splice(index, 1);
    btn.classList.remove('selected');
  } else {
    selectedIntegrations.push(integration);
    btn.classList.add('selected');
  }
}

function getSelectedIntegrations() {
  return selectedIntegrations;
}

// CSV Import
let currentImportType = null;

function showImportDialog(type) {
  currentImportType = type;
  document.getElementById('csv-import-input').click();
}

async function handleCsvImport(event) {
  const file = event.target.files[0];
  if (!file) return;

  try {
    const text = await file.text();
    const rows = text.split('\n').map(row => row.split(','));
    const headers = rows[0].map(h => h.trim().toLowerCase());
    const data = rows.slice(1).filter(row => row.length > 1);

    if (currentImportType === 'customers') {
      const customers = data.map(row => ({
        name: row[headers.indexOf('name')] || row[0],
        phone: row[headers.indexOf('phone')] || row[headers.indexOf('telefon')] || row[1],
        email: row[headers.indexOf('email')] || row[2],
        address: row[headers.indexOf('address')] || row[headers.indexOf('adresse')] || row[3]
      }));
      window.pendingImportData = { type: 'customers', data: customers };
      toast(`${customers.length} kunder klar til import`, 'success');
    } else if (currentImportType === 'products') {
      const products = data.map(row => ({
        name: row[headers.indexOf('name')] || row[headers.indexOf('navn')] || row[0],
        price: parseFloat(row[headers.indexOf('price')] || row[headers.indexOf('pris')] || row[1]) || 0,
        category: row[headers.indexOf('category')] || row[headers.indexOf('kategori')] || row[2]
      }));
      window.pendingImportData = { type: 'products', data: products };
      toast(`${products.length} produkter klar til import`, 'success');
    }
  } catch (err) {
    toast('Fejl ved l√¶sning af CSV fil', 'error');
    console.error('CSV import error:', err);
  }

  event.target.value = '';
}

async function sendTeamInvitations(userId, restaurantId) {
  const inviteRows = document.querySelectorAll('.invite-row');
  const invitations = [];

  inviteRows.forEach(row => {
    const emailEl = row.querySelector('.invite-email');
    const roleEl = row.querySelector('.invite-role');
    const email = emailEl ? emailEl.value.trim() : '';
    const role = roleEl ? roleEl.value : 'staff';
    if (email) {
      invitations.push({ email, role });
    }
  });

  if (invitations.length === 0) return;

  try {
    for (const invite of invitations) {
      await supabaseClient.from('pending_invitations').insert({
        inviter_id: userId,
        restaurant_id: restaurantId,
        email: invite.email,
        role: invite.role,
        status: 'pending',
        created_at: new Date().toISOString()
      });
      console.log(`üìß Invitation gemt til ${invite.email} som ${invite.role}`);
    }
    toast(`${invitations.length} invitationer sendt`, 'success');
  } catch (err) {
    console.warn('‚ö†Ô∏è Kunne ikke gemme invitationer:', err.message);
  }
}

async function processPendingImports(userId, restaurantId) {
  if (!window.pendingImportData) return;

  const { type, data } = window.pendingImportData;

  try {
    if (type === 'customers') {
      for (const customer of data) {
        await supabaseClient.from('customer_contacts').insert({
          restaurant_id: restaurantId,
          name: customer.name,
          phone: customer.phone,
          email: customer.email,
          address: customer.address,
          created_at: new Date().toISOString()
        });
      }
      toast(`${data.length} kunder importeret`, 'success');
    } else if (type === 'products') {
      for (const product of data) {
        await supabaseClient.from('products').insert({
          user_id: userId,
          restaurant_id: restaurantId,
          name: product.name,
          price: product.price,
          category: product.category,
          created_at: new Date().toISOString()
        });
      }
      toast(`${data.length} produkter importeret`, 'success');
    }
  } catch (err) {
    console.warn('‚ö†Ô∏è Kunne ikke importere data:', err.message);
  }

  window.pendingImportData = null;
}

function resetSignupForm() {
  // Reset til step 1
  document.querySelectorAll('.signup-step').forEach(s => s.style.display = 'none');
  const step1 = document.getElementById('signup-step-1');
  if (step1) step1.style.display = 'block';
  document.querySelectorAll('.step-dot').forEach((dot, i) => {
    dot.style.background = i === 0 ? 'var(--accent)' : 'var(--border)';
  });

  // Clear all fields
  const fields = ['signup-email', 'signup-password', 'signup-password-confirm', 'signup-company',
    'signup-cvr', 'signup-owner', 'signup-contact-name', 'signup-contact-email',
    'signup-phone', 'signup-address', 'signup-website'];
  fields.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });

  // Reset team invites
  const teamList = document.getElementById('team-invite-list');
  if (teamList) {
    teamList.innerHTML = `
      <div class="invite-row">
        <input type="email" class="input invite-email" placeholder="kollega@email.dk">
        <select class="input invite-role">
          <option value="staff">Medarbejder</option>
          <option value="manager">Manager</option>
        </select>
      </div>
    `;
  }
  signupInviteCount = 1;

  // Reset integrations
  selectedIntegrations = [];
  document.querySelectorAll('.integration-btn').forEach(btn => btn.classList.remove('selected'));

  // Reset import data
  window.pendingImportData = null;
}

async function handleSignup(e) {
  e.preventDefault();

  // Step 1 data
  const email = document.getElementById('signup-email').value;
  const password = document.getElementById('signup-password').value;

  // Step 2 data
  const company = document.getElementById('signup-company').value;
  const cvr = document.getElementById('signup-cvr')?.value || '';
  const owner = document.getElementById('signup-owner')?.value || '';
  const contactName = document.getElementById('signup-contact-name')?.value || '';
  const contactEmail = document.getElementById('signup-contact-email')?.value || '';
  const phone = document.getElementById('signup-phone')?.value || '';
  const address = document.getElementById('signup-address')?.value || '';
  const website = document.getElementById('signup-website')?.value || '';
  const industry = document.getElementById('signup-industry')?.value || 'restaurant';
  const role = document.getElementById('signup-role')?.value || 'owner';

  // Step 3 data
  const notifications = document.getElementById('setting-notifications')?.checked ?? true;
  const aiEnabled = document.getElementById('setting-ai')?.checked ?? true;
  const smsEnabled = document.getElementById('setting-sms')?.checked ?? true;
  const integrations = getSelectedIntegrations();

  if (CONFIG.DEMO_MODE || !supabase) {
    loginDemo();
    return;
  }

  try {
    // 1. Opret bruger i Supabase Auth
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: {
          company, cvr, owner, contact_name: contactName,
          contact_email: contactEmail, phone, address, website,
          industry, user_role: role,
          settings: { notifications, ai_enabled: aiEnabled, sms_enabled: smsEnabled }
        }
      }
    });

    if (error) throw error;

    // 2. Opret automatisk f√∏rste restaurant
    let restaurantId = null;
    if (data.user && company && typeof SupabaseDB !== 'undefined') {
      try {
        const restaurant = await SupabaseDB.createRestaurant(data.user.id, {
          name: company,
          cvr: cvr,
          contact_name: contactName || owner,
          contact_email: contactEmail || email,
          contact_phone: phone,
          address: address,
          status: 'pending',
          ai_enabled: aiEnabled,
          integration_status: integrations.length > 0 ? 'pending' : 'none',
          metadata: {
            owner: owner,
            website: website,
            industry: industry,
            integrations: integrations,
            features: {
              ai: aiEnabled,
              sms: smsEnabled,
              notifications: notifications
            }
          }
        });
        restaurantId = restaurant?.id;
        console.log('‚úÖ Restaurant oprettet:', restaurantId);
      } catch (restErr) {
        console.warn('‚ö†Ô∏è Kunne ikke oprette restaurant:', restErr.message);
      }
    }

    // 3. Send team invitationer (fra Trin 3)
    if (data.user && restaurantId) {
      await sendTeamInvitations(data.user.id, restaurantId);
    }

    // 4. Process pending CSV imports (fra Trin 3)
    if (data.user && restaurantId) {
      await processPendingImports(data.user.id, restaurantId);
    }

    // 5. Success
    toast('Konto oprettet! Tjek din email for bekr√¶ftelse.', 'success');
    resetSignupForm();
    showAuthTab('login');
  } catch (err) {
    showAuthError(err.message);
  }
}

async function loginDemo() {
  console.log('üéØ Demo login...');

  // Demo bruger med begr√¶nset adgang
  currentUser = {
    id: 'demo-user-' + Date.now(),
    email: 'demo@orderflow.dk',
    user_metadata: { full_name: 'Demo Bruger' },
    role: ROLES.DEMO
  };

  // Load demo restaurant data
  restaurants = getDemoRestaurants();

  // S√¶t demo restaurant som aktiv (for subpages)
  currentProfileRestaurantId = restaurants[0]?.id || 'demo-restaurant-1';
  console.log('üìç Demo restaurant ID sat:', currentProfileRestaurantId);

  // Play login transition animation
  await playLoginTransition();

  showApp();

  // VIGTIGT: Brug requestAnimationFrame for at sikre at DOM er f√¶rdig
  // Dette l√∏ser race condition hvor applyRoleBasedSidebar() blev kaldt f√∏r DOM var opdateret
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      applyRoleBasedSidebar();
      console.log('‚úÖ Role-based sidebar applied after showApp() completed');

    });
  });

  toast('Demo mode aktiveret', 'info');
  console.log('üë§ Logget ind som Demo bruger');
}

function getDemoRestaurants() {
  return [{
    id: 'demo-restaurant-1',
    name: 'Demo Pizzeria',
    status: 'demo',
    isDemo: true,
    cvr: '12345678',
    contact_phone: '+4512345678',
    contact_email: 'demo@pizzeria.dk',
    contact_name: 'Demo Kontakt',
    owner: 'Demo Ejer',
    phone: '+4512345678',
    email: 'demo@pizzeria.dk',
    address: 'Demovej 123, 2100 K√∏benhavn',
    country: 'DK',
    industry: 'pizzeria',
    website: 'https://demo.orderflow.dk',
    created_at: new Date().toISOString(),
    orders_total: 127,
    revenue_total: 45890,
    ai_enabled: true,
    integration_status: 'active',
    // Workflow settings
    googleReviewUrl: 'https://g.page/demo-pizzeria/review',
    trustpilotUrl: 'https://trustpilot.com/review/demo-pizzeria',
    reorderEnabled: true,
    receiptEnabled: true,
    deliveryEnabled: true,
    // Opening hours
    openingHours: {
      mon: { enabled: true, open: '10:00', close: '22:00' },
      tue: { enabled: true, open: '10:00', close: '22:00' },
      wed: { enabled: true, open: '10:00', close: '22:00' },
      thu: { enabled: true, open: '10:00', close: '22:00' },
      fri: { enabled: true, open: '10:00', close: '23:00' },
      sat: { enabled: true, open: '11:00', close: '23:00' },
      sun: { enabled: true, open: '12:00', close: '21:00' }
    },
    // SMS messages
    messages: {
      'msg-welcome-text': 'Hej {{kunde}}! Tak for din interesse i Demo Pizzeria.',
      'msg-pending-text': 'Vi har modtaget din ordre og arbejder p√• den.',
      'msg-accepted-text': 'Din ordre er accepteret! Forventet ventetid: {{ventetid}} min.',
      'msg-preparing-text': 'Din ordre er nu under tilberedning.',
      'msg-ready-text': 'Din ordre er klar til afhentning/levering!',
      'msg-picked-up-text': 'Tak for din ordre hos Demo Pizzeria!',
      'msg-closed-text': 'Vi har desv√¶rre lukket. √Öbningstider: {{√•bningstider}}',
      'msg-error-text': 'Beklager, der opstod en fejl. Pr√∏v igen eller ring til os.'
    },
    metadata: {
      industry: 'pizzeria',
      website: 'https://demo.orderflow.dk'
    }
  }];
}

/**
 * Admin Login Function
 * Logs in with hardcoded admin credentials via Supabase Auth
 */
async function loginAdmin() {
  const adminEmail = 'martinsarvio@hotmail.com';
  const adminPassword = 'Ma_93rtin';

  try {
    console.log('üîë Attempting admin login...');

    // Wait for Supabase to initialize (max 5 seconds)
    if (typeof window.waitForSupabase === 'function') {
      try {
        await Promise.race([
          window.waitForSupabase(),
          new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 5000))
        ]);
        console.log('‚úÖ Supabase client ready for admin login');
      } catch (err) {
        console.warn('‚ö†Ô∏è Supabase initialization timeout, using local admin login');
        loginAdminLocal();
        return;
      }
    }

    // Check if Supabase is available
    if (typeof supabaseClient === 'undefined' || !supabaseClient) {
      console.warn('‚ö†Ô∏è Supabase not available, using local admin login');
      loginAdminLocal();
      return;
    }

    // Login via Supabase Auth
    const { data, error } = await supabaseClient.auth.signInWithPassword({
      email: adminEmail,
      password: adminPassword
    });

    if (error) {
      console.error('‚ùå Admin login error:', error);
      throw error;
    }

    console.log('‚úÖ Admin login successful:', data.user.email);

    // Set current user
    currentUser = {
      ...data.user,
      role: 'admin' // Add admin role
    };

    // Load restaurants from Supabase
    if (typeof SupabaseDB !== 'undefined') {
      try {
        const dbRestaurants = await SupabaseDB.getRestaurants(currentUser.id);
        restaurants = dbRestaurants || [];
        console.log('‚úÖ Loaded restaurants:', restaurants.length);
      } catch (err) {
        console.warn('‚ö†Ô∏è Could not load restaurants:', err);
        restaurants = [];
      }

      // Initialize real-time sync
      if (typeof RealtimeSync !== 'undefined') {
        await RealtimeSync.init(currentUser.id);
      }
    }

    // Play login transition animation
    await playLoginTransition();

    // Show app
    showApp();
    applyRoleBasedSidebar();

    // Log admin login activity
    logActivity('login', 'Administrator login', {
      category: 'system',
      user: currentUser.email,
      role: currentUser.role
    });

    console.log('‚úÖ Admin logged in successfully!');

  } catch (err) {
    console.error('‚ùå Admin login failed:', err);
    showAuthError('Admin login fejlede: ' + err.message);
  }
}

/**
 * Local Admin Login Fallback
 * Used when Supabase is not available
 */
async function loginAdminLocal() {
  console.log('üîë Local admin login (fallback)...');

  const tempUser = {
    id: 'admin-martin',
    email: 'martinsarvio@hotmail.com',
    user_metadata: {
      full_name: 'Martin Sarvio'
    },
    role: 'admin'
  };

  // Check 2FA from localStorage
  try {
    const localSettings = JSON.parse(localStorage.getItem('orderflow_2fa_settings') || '{}');
    const hasTOTP = localSettings.totp_enabled && localSettings.totp_confirmed;
    const hasEmail = localSettings.email_otp_enabled;

    console.log('üîê Local 2FA Check:', { hasTOTP, hasEmail, localSettings });

    if (hasTOTP || hasEmail) {
      // Store pending login
      pending2FAUser = tempUser;
      pending2FASettings = localSettings;

      // Show 2FA challenge
      show2FAChallenge(tempUser, localSettings);
      return; // Wait for 2FA verification
    }
  } catch (e) {
    console.warn('Could not check local 2FA settings:', e);
  }

  // No 2FA - proceed with login
  currentUser = tempUser;
  restaurants = [];

  // Load locally persisted restaurants from localStorage
  loadPersistedRestaurants();
  console.log('üì¶ Loaded persisted restaurants:', restaurants.length);

  // Play login transition animation
  await playLoginTransition();

  showApp();
  applyRoleBasedSidebar();

  // Log admin login activity
  logActivity('login', 'Administrator login (local)', {
    category: 'system',
    user: currentUser.email,
    role: currentUser.role
  });

  console.log('‚úÖ Local admin logged in!');
}

function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg;
  el.style.display = 'block';
}

function logout() {
  if (supabase) supabase.auth.signOut();
  clearSession(); // Clear persisted session
  resetAuthUI();
}

function resetAuthUI() {
  // KRITISK: Kun clear session hvis vi IKKE har en gyldig lokal session
  // Dette forhindrer Supabase auth events i at slette vores lokale session
  const hasLocalSession = localStorage.getItem(SESSION_KEY);
  if (!hasLocalSession) {
    currentUser = null;
    clearSession();
  } else {
    console.log('üõ°Ô∏è resetAuthUI: Bevarer lokal session');
    return; // Stop her - bevar session
  }
  pending2FAUser = null;
  pending2FASettings = null;
  window._pending2FALogin = null;
  document.getElementById('app').classList.remove('active');
  document.getElementById('auth-screen').style.display = 'flex';
  const loginForm = document.getElementById('login-form');
  const challengeForm = document.getElementById('2fa-challenge-form');
  const setupRequired = document.getElementById('2fa-setup-required');
  const authTabs = document.querySelector('.auth-tabs');
  const demoButtons = document.getElementById('auth-demo-buttons');

  if (loginForm) loginForm.style.display = 'block';
  if (challengeForm) challengeForm.style.display = 'none';
  if (setupRequired) setupRequired.style.display = 'none';
  if (authTabs) authTabs.style.display = 'flex';
  if (demoButtons) demoButtons.style.display = 'block';

  const codeInput = document.getElementById('2fa-code-input');
  const emailCodeInput = document.getElementById('2fa-email-code-input');
  const backupCodeInput = document.getElementById('2fa-backup-code-input');
  if (codeInput) codeInput.value = '';
  if (emailCodeInput) emailCodeInput.value = '';
  if (backupCodeInput) backupCodeInput.value = '';
}

document.addEventListener('DOMContentLoaded', () => {
  renderHeaderNotifications();
});

async function initAuthStateListener() {
  if (typeof window.waitForSupabase === 'function') {
    try {
      await window.waitForSupabase();
    } catch (err) {
      console.warn('Supabase not ready for auth listener:', err);
    }
  }

  if (typeof supabaseClient !== 'undefined' && supabaseClient?.auth?.onAuthStateChange) {
    supabaseClient.auth.onAuthStateChange((event) => {
      if (event === 'SIGNED_OUT' || event === 'TOKEN_REFRESH_FAILED') {
        resetAuthUI();
      }
    });
  }
}

document.addEventListener('DOMContentLoaded', () => {
  // KRITISK: Restore session F√òRST, F√òR Supabase auth listener
  // Ellers vil Supabase's SIGNED_OUT event slette vores lokale session
  const savedUser = restoreSession();

  if (savedUser) {
    currentUser = savedUser;
    console.log('üîÑ Session restored, showing app...');

    // Immediately show app to prevent flash of login screen
    showApp();
    applyRoleBasedSidebar();

    // Load restaurants in background
    (async () => {
      if (typeof SupabaseDB !== 'undefined') {
        try {
          const dbRestaurants = await SupabaseDB.getRestaurants(currentUser.id);
          restaurants = dbRestaurants || [];
          loadPersistedRestaurants();
          console.log('‚úÖ Restaurants loaded from restored session:', restaurants.length);

          // Initialize real-time sync
          if (typeof RealtimeSync !== 'undefined') {
            await RealtimeSync.init(currentUser.id);
          }

          // Refresh dashboard if visible
          if (typeof loadDashboard === 'function') {
            loadDashboard();
          }
        } catch (err) {
          console.warn('‚ö†Ô∏è Could not load restaurants:', err);
          loadPersistedRestaurants();
        }
      } else {
        loadPersistedRestaurants();
      }
      console.log('‚úÖ App restored from saved session');
    })();
  } else {
    // Kun init Supabase auth listener hvis INGEN lokal session
    // Dette forhindrer at Supabase sletter vores session
    initAuthStateListener();
  }
});

// =====================================================
// HEADER DROPDOWN FUNKTIONER
// =====================================================
let activeDropdown = null;

function toggleDropdown(type) {
  const dropdowns = {
    'help': 'help-dropdown-wrap',
    'news': 'news-dropdown-wrap',
    'notif': 'notif-dropdown-wrap',
    'profile': null // Profile uses different system
  };
  
  // Handle profile separately
  if (type === 'profile') {
    const profile = document.querySelector('.topbar-profile');
    const wasOpen = profile.classList.contains('open');
    
    // Close all other dropdowns
    closeAllDropdowns();
    
    if (!wasOpen) {
      profile.classList.add('open');
      activeDropdown = 'profile';
    }
    return;
  }
  
  const wrapId = dropdowns[type];
  if (!wrapId) return;
  
  const wrap = document.getElementById(wrapId);
  const wasOpen = wrap.classList.contains('open');
  
  // Close all dropdowns first
  closeAllDropdowns();
  
  // Toggle this one if it was closed
  if (!wasOpen) {
    wrap.classList.add('open');
    activeDropdown = type;
  }
}

function closeAllDropdowns() {
  document.querySelectorAll('.topbar-dropdown-wrap').forEach(el => {
    el.classList.remove('open');
  });
  document.querySelector('.topbar-profile')?.classList.remove('open');
  activeDropdown = null;
}

// Close dropdowns when clicking outside
document.addEventListener('click', (e) => {
  const isDropdownClick = e.target.closest('.topbar-dropdown-wrap') || 
                          e.target.closest('.topbar-profile');
  
  if (!isDropdownClick) {
    closeAllDropdowns();
  }
});

// Close dropdowns on Escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeAllDropdowns();
  }
});

// =====================================================
// APP
// =====================================================
function showApp() {
  try {
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('app').classList.add('active');
    
    // Set user info - sidebar (with null checks)
    const name = currentUser?.user_metadata?.full_name || currentUser?.email?.split('@')[0] || 'Bruger';
    
    const userNameEl = document.getElementById('user-name');
    const userEmailEl = document.getElementById('user-email');
    const userAvatarEl = document.getElementById('user-avatar');
    
    if (userNameEl) userNameEl.textContent = name;
    if (userEmailEl) userEmailEl.textContent = currentUser?.email || '';
    if (userAvatarEl) userAvatarEl.textContent = name.charAt(0).toUpperCase();
    
    // Set user info - topbar
    const topbarAvatar = document.getElementById('topbar-avatar');
    const dropdownName = document.getElementById('dropdown-name');
    const dropdownEmail = document.getElementById('dropdown-email');
    
    if (topbarAvatar) topbarAvatar.textContent = name.charAt(0).toUpperCase();
    if (dropdownName) dropdownName.textContent = name;
    if (dropdownEmail) dropdownEmail.textContent = currentUser?.email || '';

    // Set tooltip on profile element with user's full name
    const topbarProfile = document.querySelector('.topbar-profile');
    if (topbarProfile) topbarProfile.title = name;

    // Load data with error handling
    // VIGTIGT: Kun load admin dashboard for admin/employee - ikke for demo/kunde
    const isCustomerOrDemo = currentUser?.role && [ROLES.DEMO, ROLES.CUSTOMER].includes(currentUser.role);
    if (!isCustomerOrDemo) {
      try { loadDashboard(); } catch(e) { console.error('loadDashboard:', e); }
    }
    try { loadRestaurants(); } catch(e) { console.error('loadRestaurants:', e); }
    try { renderWorkflowNodes(); } catch(e) { console.error('renderWorkflowNodes:', e); }
    try { loadConfig(); } catch(e) { console.error('loadConfig:', e); }
    
    // Initialiser update indikatorer efter kort delay
    setTimeout(() => {
      try { initUpdateIndicators(); } catch(e) { console.error('initUpdateIndicators:', e); }
    }, 100);

    // Clear stale notifications hvis ingen kunder eksisterer
    if (restaurants.length === 0 && typeof NotificationSystem !== 'undefined') {
      NotificationSystem.clearPath('kunder');
      NotificationSystem.clearPath('alle-kunder');
      console.log('üßπ Cleared stale customer notifications (no customers exist)');
    }

    // ALTID start p√• dashboard efter login
    // (ignorer URL hash s√• brugeren ikke ender p√• den sidst bes√∏gte side)
    history.replaceState({ page: 'dashboard' }, '', '#dashboard');
    showPage('dashboard');

    console.log('App loaded successfully');
  } catch (err) {
    console.error('showApp error:', err);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üîí SIDEBAR TEMPLATE FUNCTIONS - AUTHORIZATION REQUIRED
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Template Version: 1.6.6 (build 166)
//
// ‚ö†Ô∏è  PROTECTED FUNCTIONS - DO NOT MODIFY WITHOUT AUTHORIZATION
//
// Protected sidebar functions:
// - toggleSidebar()
// - initSidebarState()
// - toggleNavDropdown()
// - applyRoleBasedSidebar()
//
// See SIDEBAR-TEMPLATE.md for complete specification.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// =====================================================
// SMART SIDEBAR - Toggle collapsed state
// =====================================================
let sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';

function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const workflowPage = document.getElementById('page-workflow');

  sidebarCollapsed = !sidebarCollapsed;

  if (sidebarCollapsed) {
    sidebar.classList.add('collapsed');
    // Close all open dropdowns when collapsing
    document.querySelectorAll('.nav-dropdown.open').forEach(d => d.classList.remove('open'));
    // Update workflow page position
    if (workflowPage) workflowPage.classList.add('sidebar-collapsed');
  } else {
    sidebar.classList.remove('collapsed');
    if (workflowPage) workflowPage.classList.remove('sidebar-collapsed');
  }

  // Save preference
  localStorage.setItem('sidebarCollapsed', sidebarCollapsed);
}

// Initialize sidebar state on load
function initSidebarState() {
  const sidebar = document.getElementById('sidebar');
  const workflowPage = document.getElementById('page-workflow');
  if (sidebar && sidebarCollapsed) {
    sidebar.classList.add('collapsed');
    if (workflowPage) workflowPage.classList.add('sidebar-collapsed');
  }
}

// Call on page load
document.addEventListener('DOMContentLoaded', initSidebarState);

// =====================================================
// MOBILE MENU FUNCTIONS
// =====================================================

function toggleMobileMenu() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');

  if (sidebar.classList.contains('mobile-open')) {
    closeMobileMenu();
  } else {
    sidebar.classList.add('mobile-open');
    overlay.classList.add('active');
    document.body.style.overflow = 'hidden'; // Prevent scroll when menu open
  }
}

function closeMobileMenu() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');

  sidebar.classList.remove('mobile-open');
  overlay.classList.remove('active');
  document.body.style.overflow = '';
}

// Close mobile menu when clicking a nav item
function handleMobileNavClick() {
  if (window.innerWidth <= 640) {
    closeMobileMenu();
  }
}

// Add click handlers to all nav buttons for mobile
document.addEventListener('DOMContentLoaded', function() {
  // Close mobile menu when navigating
  document.querySelectorAll('.sidebar .nav-btn, .sidebar .nav-dropdown-menu button').forEach(btn => {
    btn.addEventListener('click', handleMobileNavClick);
  });

  // Handle window resize
  window.addEventListener('resize', function() {
    if (window.innerWidth > 640) {
      closeMobileMenu();
    }
  });
});

// Browser history navigation flag
let isNavigatingFromHistory = false;

function showPage(page) {
  // Luk kunde-kontekst menu n√•r man navigerer til en anden side (kun for admin)
  if (page !== 'kunder') {
    const customerContext = document.getElementById('nav-customer-context');
    if (customerContext) {
      customerContext.style.display = 'none';
    }
    currentProfileRestaurantId = null;
  }

  // === ROLLE-GUARDS: Blok√©r admin-sider for kunde/demo ===
  const adminOnlyPages = ['kunder', 'alle-kunder', 'add-restaurant'];
  if (currentUser?.role && [ROLES.CUSTOMER, ROLES.DEMO].includes(currentUser.role) && adminOnlyPages.includes(page)) {
    console.warn('üö´ Blocked navigation to admin page:', page);
    page = 'dashboard'; // Redirect til dashboard i stedet
  }

  // === DEMO/KUNDE: Dashboard skal bruge kundens profil-dashboard ===
  const isCustomerView = currentUser?.role && [ROLES.CUSTOMER, ROLES.DEMO].includes(currentUser.role);
  if (isCustomerView && page === 'dashboard') {
    if (!isNavigatingFromHistory) {
      history.pushState({ page: page }, '', `#${page}`);
    }
    isNavigatingFromHistory = false;

    const mainContent = document.querySelector('.main-content');
    if (mainContent) mainContent.scrollTop = 0;

    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    const dashBtn = document.querySelector('.nav-btn[onclick="showPage(\'dashboard\')"]');
    if (dashBtn) dashBtn.classList.add('active');

    if (currentUser?.role) {
      applyRoleBasedSidebar();
    }

    showCustomerSubpage('dashboard');
    return;
  }

  // Push til browser history (undg√• ved popstate navigation)
  if (!isNavigatingFromHistory) {
    history.pushState({ page: page }, '', `#${page}`);
  }
  isNavigatingFromHistory = false;
  // Reset scroll position to top when leaving page
  const mainContent = document.querySelector('.main-content');
  if (mainContent) {
    mainContent.scrollTop = 0;
  }

  document.querySelectorAll('.page, .workflow-page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.nav-dropdown-item').forEach(i => i.classList.remove('active'));
  document.querySelectorAll('.nav-dropdown-toggle').forEach(t => t.classList.remove('active'));

  // Mark√©r opdateringer som set for denne side
  markPageUpdatesAsSeen(page);
  
  // KRITISK: Kontroller body overflow baseret p√• side
  if (page === 'workflow') {
    document.body.classList.add('workflow-active');
  } else {
    document.body.classList.remove('workflow-active');
  }
  
  const pageEl = document.getElementById('page-' + page);
  if (pageEl) {
    pageEl.classList.add('active');
  }
  
  // Reset CRM til search view n√•r man g√•r til kunder-siden
  if (page === 'kunder') {
    refreshRestaurantsFromDB().then(() => loadRestaurants());
    showCrmSearchView();
  }
  
  // Load ordrer n√•r orders-siden vises
  if (page === 'orders') {
    loadOrdersPage();
  }

  // Load leads n√•r lead-siderne vises
  if (page === 'leads') {
    loadLeadsPage();
  }
  if (page === 'leads-pipeline') {
    loadPipelinePage();
  }

  // Set dagsrapport dato til i dag
  if (page === 'dagsrapport') {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dagsrapport-dato').value = today;
  }
  
  // Load aktiviteter n√•r activities-siden vises
  if (page === 'activities') {
    loadActivitiesPage();
  }
  
  // Reset demo onboarding when page is shown
  if (page === 'demo-onboarding') {
    resetDemoOnboarding();
  }
  
  // Clear add-restaurant form when page is shown
  if (page === 'add-restaurant') {
    clearAddRestaurantForm();
  }

  // Load alle-kunder grid when page is shown
  if (page === 'alle-kunder') {
    refreshRestaurantsFromDB().then(() => loadAlleKunderGrid());
  }

  // Load loyalty page
  if (page === 'loyalty') {
    renderLoyaltyPage();
  }

  // Load campaigns page (new Marketing Editor)
  if (page === 'campaigns') {
    initMarketingPage();
  }

  // Load segments page (redirects to marketing segments tab)
  if (page === 'segments') {
    showPage('campaigns');
    setTimeout(() => switchMarketingTab('segments'), 50);
    return;
  }

  // Load udsendelser page (redirects to marketing broadcasts tab)
  if (page === 'udsendelser') {
    showPage('campaigns');
    setTimeout(() => switchMarketingTab('broadcasts'), 50);
    return;
  }

  // Load App Builder page
  if (page === 'appbuilder') {
    showAppBuilderPage('design');
    return;
  }

  // Refresh dashboard data
  if (page === 'dashboard') {
    refreshRestaurantsFromDB().then(() => loadDashboard());
  }

  // Centrer workflow n√•r workflow-siden vises
  if (page === 'workflow') {
    // Initialize demo mode for demo users
    initWorkflowDemo();

    // Populate test restaurant dropdown
    populateTestRestaurants();

    // Reset transform to ensure clean state
    canvasTransform = { x: 0, y: 0, scale: 0.6 };

    // Initialize canvas and render nodes first
    setTimeout(() => {
      initCanvasPanning();
      renderWorkflowNodes();

      // Then center after nodes are rendered
      setTimeout(() => {
        fitWorkflowToView();
      }, 100);

      // Final check
      setTimeout(() => {
        fitWorkflowToView();
      }, 300);
    }, 50);
  }
  
  // Highlight correct nav item
  document.querySelectorAll('.nav-btn').forEach(b => {
    const btnPage = b.getAttribute('onclick')?.match(/showPage\('(.+?)'\)/)?.[1];
    if (btnPage === page || btnPage === 'page-' + page || page === 'page-' + btnPage) {
      b.classList.add('active');
    }
  });
  
  // Highlight dropdown items
  const activeDropdowns = new Set();
  document.querySelectorAll('.nav-dropdown-item').forEach(item => {
    const onclick = item.getAttribute('onclick');
    if (onclick && onclick.includes(`'${page}'`)) {
      item.classList.add('active');
      // Open parent dropdown
      const dropdown = item.closest('.nav-dropdown');
      if (dropdown) {
        dropdown.classList.add('open');
        activeDropdowns.add(dropdown);
      }
    }
  });
  
  if (activeDropdowns.size > 0) {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    activeDropdowns.forEach(dropdown => {
      dropdown.querySelector('.nav-dropdown-toggle')?.classList.add('active');
    });
  }

  // === ROLE-BASED SIDEBAR: Lad applyRoleBasedSidebar() h√•ndtere ALT visibility ===
  // Fjernet duplicate style manipulation - applyRoleBasedSidebar() er single source of truth
  if (currentUser?.role) {
    // Brug synkront kald for at sikre sidebar er korrekt INDEN siden vises
    applyRoleBasedSidebar();
  }
}

// Browser back/forward navigation handler
window.addEventListener('popstate', (event) => {
  if (event.state && event.state.page) {
    isNavigatingFromHistory = true;
    showPage(event.state.page);
  }
});

// Toggle sidebar dropdown menus - auto-expand sidebar if collapsed
function toggleNavDropdown(name) {
  const dropdown = document.getElementById('nav-' + name);
  const sidebar = document.getElementById('sidebar');
  const wasOpen = dropdown && dropdown.classList.contains('open');
  
  // Luk alle √•bne dropdowns (accordion logik)
  document.querySelectorAll('.nav-dropdown.open').forEach(d => d.classList.remove('open'));
  
  // Luk kunde-kontekst menu n√•r andre dropdowns √•bnes (medmindre vi er i kunde-profil)
  if (name !== 'kunder' && currentProfileRestaurantId) {
    // Vis kun kort besked, luk ikke profilen helt
  }
  
  if (sidebar && sidebar.classList.contains('collapsed')) {
    sidebarCollapsed = false;
    sidebar.classList.remove('collapsed');
    localStorage.setItem('sidebarCollapsed', 'false');
    setTimeout(() => { if (dropdown) dropdown.classList.add('open'); }, 100);
  } else if (dropdown && !wasOpen) {
    dropdown.classList.add('open');
  }
}

// =====================================================
// FAQ ACCORDION FUNCTIONS
// =====================================================
function toggleFAQ(id) {
  const items = document.querySelectorAll('.faq-item');
  const clickedItem = document.querySelector(`.faq-item[data-faq="${id}"]`);
  
  if (!clickedItem) return;
  
  // If clicking on already open item, close it
  if (clickedItem.classList.contains('open')) {
    clickedItem.classList.remove('open');
    return;
  }
  
  // Close all other items
  items.forEach(item => item.classList.remove('open'));
  
  // Open clicked item
  clickedItem.classList.add('open');
}

function filterFAQ(searchTerm) {
  const items = document.querySelectorAll('.faq-item');
  const term = searchTerm.toLowerCase().trim();
  
  items.forEach(item => {
    const question = item.querySelector('.faq-question span')?.textContent.toLowerCase() || '';
    const answer = item.querySelector('.faq-answer p')?.textContent.toLowerCase() || '';
    
    if (term === '' || question.includes(term) || answer.includes(term)) {
      item.classList.remove('hidden');
    } else {
      item.classList.add('hidden');
    }
  });
}

// Filter both docs and FAQ on support page
function filterSupportContent(searchTerm) {
  const term = searchTerm.toLowerCase().trim();
  
  // Filter documentation cards
  const docCards = document.querySelectorAll('.support-doc-card');
  docCards.forEach(card => {
    const title = card.querySelector('h4')?.textContent.toLowerCase() || '';
    const desc = card.querySelector('p')?.textContent.toLowerCase() || '';
    const searchData = card.getAttribute('data-search')?.toLowerCase() || '';
    
    if (term === '' || title.includes(term) || desc.includes(term) || searchData.includes(term)) {
      card.classList.remove('hidden');
    } else {
      card.classList.add('hidden');
    }
  });
  
  // Filter FAQ items
  const faqItems = document.querySelectorAll('#faq-accordion .faq-item');
  faqItems.forEach(item => {
    const question = item.querySelector('.faq-question span')?.textContent.toLowerCase() || '';
    const answer = item.querySelector('.faq-answer p')?.textContent.toLowerCase() || '';
    const searchData = item.getAttribute('data-search')?.toLowerCase() || '';
    
    if (term === '' || question.includes(term) || answer.includes(term) || searchData.includes(term)) {
      item.classList.remove('hidden');
    } else {
      item.classList.add('hidden');
    }
  });
  
  // Show/hide section titles based on visible items
  const docsSection = document.querySelector('.support-docs-section');
  const faqSection = document.querySelector('.faq-section');
  
  if (docsSection) {
    const visibleDocs = docsSection.querySelectorAll('.support-doc-card:not(.hidden)');
    docsSection.style.display = visibleDocs.length > 0 ? 'block' : 'none';
  }
  
  if (faqSection) {
    const visibleFaq = faqSection.querySelectorAll('.faq-item:not(.hidden)');
    faqSection.style.display = visibleFaq.length > 0 ? 'block' : 'none';
  }
}

// Show support documentation - opens external docs site
// Dokumentation data
const DOCS_DATA = {
  'ai-order-handling': {
    section: 'Kom godt i gang',
    title: 'Ops√¶tning af AI-ordreh√•ndtering',
    desc: 'L√¶r hvordan OrderFlows AI automatisk fortolker og h√•ndterer indkommende ordrer.',
    time: '10 min',
    prev: null,
    next: 'sms-configuration',
    content: `
      <h2>S√•dan virker AI-ordreh√•ndtering</h2>
      <p>N√•r en kunde sender en SMS eller besked, sker f√∏lgende:</p>
      <div class="docs-flow">
        <div class="docs-flow-step">üì± Kunde sender besked</div>
        <span class="docs-flow-arrow">-></span>
        <div class="docs-flow-step">ü§ñ AI analyserer teksten</div>
        <span class="docs-flow-arrow">-></span>
        <div class="docs-flow-step">üìã Ordre oprettes</div>
        <span class="docs-flow-arrow">-></span>
        <div class="docs-flow-step">‚úÖ Bekr√¶ftelse sendes</div>
      </div>
      
      <h2>Aktiver AI-ordreh√•ndtering</h2>
      <h3>Trin 1: G√• til Workflow</h3>
      <ol>
        <li>Klik p√• <strong>Workflow</strong> i sidemenuen</li>
        <li>V√¶lg din restaurant i dropdown'en</li>
      </ol>
      
      <h3>Trin 2: Aktiver Standard Workflow</h3>
      <ol>
        <li>Find <strong>"AI Ordreh√•ndtering"</strong> workflow</li>
        <li>Klik p√• toggle-knappen for at aktivere</li>
        <li>Workflowet er nu aktivt!</li>
      </ol>
      
      <h2>AI Konfidens-niveauer</h2>
      <p>AI'en vurderer hvor sikker den er p√• sin fortolkning:</p>
      <table>
        <thead>
          <tr><th>Konfidens</th><th>Handling</th><th>Eksempel</th></tr>
        </thead>
        <tbody>
          <tr><td><span class="docs-badge green">90-100%</span></td><td>Auto-bekr√¶ft ordre</td><td>"2 pepperoni pizzaer til Vestergade 10"</td></tr>
          <tr><td><span class="docs-badge yellow">70-89%</span></td><td>Ordre oprettes, markeres til gennemgang</td><td>"2 store pizzaer med skinke"</td></tr>
          <tr><td><span class="docs-badge red">&lt; 70%</span></td><td>Manuel h√•ndtering p√•kr√¶vet</td><td>"det s√¶dvanlige tak"</td></tr>
        </tbody>
      </table>
      
      <div class="docs-callout tip">
        <svg class="docs-callout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
        <div><strong>üí° Pro-tip:</strong> Start med 90% og s√¶nk gradvist n√•r AI'en l√¶rer dine produkter.</div>
      </div>
    `
  },
  'sms-configuration': {
    section: 'Kom godt i gang',
    title: 'Konfigurer SMS-beskeder',
    desc: 'Tilpas automatiske SMS-beskeder til dine kunder og optimer din kommunikation.',
    time: '8 min',
    prev: 'ai-order-handling',
    next: 'missed-calls',
    content: `
      <h2>Oversigt</h2>
      <p>OrderFlow sender automatisk SMS'er ved forskellige h√¶ndelser. Du kan tilpasse alle skabeloner til at matche din tone og brand.</p>
      
      <h2>Adgang til SMS-indstillinger</h2>
      <ol>
        <li>G√• til <strong>Indstillinger</strong> i sidemenuen</li>
        <li>Klik p√• <strong>SMS & Beskeder</strong> tab</li>
        <li>V√¶lg den restaurant du vil konfigurere</li>
      </ol>
      
      <h2>Tilg√¶ngelige variabler</h2>
      <p>Du kan bruge disse variabler i dine SMS-skabeloner:</p>
      <table>
        <thead>
          <tr><th>Variabel</th><th>Beskrivelse</th><th>Eksempel</th></tr>
        </thead>
        <tbody>
          <tr><td><code>{kundenavn}</code></td><td>Kundens navn</td><td>Anders</td></tr>
          <tr><td><code>{restaurant}</code></td><td>Restaurant navn</td><td>Bella Italia</td></tr>
          <tr><td><code>{ordrenummer}</code></td><td>Ordre ID</td><td>1234</td></tr>
          <tr><td><code>{total}</code></td><td>Total bel√∏b</td><td>259,00 kr</td></tr>
          <tr><td><code>{leveringstid}</code></td><td>Estimeret leveringstid</td><td>kl. 18:30</td></tr>
        </tbody>
      </table>
      
      <div class="docs-callout tip">
        <svg class="docs-callout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
        <div><strong>üí° Pro-tip:</strong> Hold SMS'er korte og informative. Brug emojis sparsomt.</div>
      </div>
    `
  },
  'missed-calls': {
    section: 'Kom godt i gang',
    title: 'Missed Calls Auto-SMS',
    desc: 'Konverter mistede opkald til ordrer med automatisk SMS-opf√∏lgning.',
    time: '6 min',
    prev: 'sms-configuration',
    next: 'train-ai-orders',
    content: `
      <h2>Oversigt</h2>
      <p>Konverter mistede opkald til ordrer ved automatisk at sende en SMS til kunden inden for 30 sekunder.</p>
      
      <h2>S√•dan virker det</h2>
      <div class="docs-flow">
        <div class="docs-flow-step">üìû Kunde ringer</div>
        <span class="docs-flow-arrow">-></span>
        <div class="docs-flow-step">‚è∞ Ubesvaret efter 15 sek</div>
        <span class="docs-flow-arrow">-></span>
        <div class="docs-flow-step">üì± Auto-SMS sendes</div>
        <span class="docs-flow-arrow">-></span>
        <div class="docs-flow-step">üõí Kunde bestiller via SMS</div>
      </div>
      
      <h2>Ops√¶tning</h2>
      <ol>
        <li>G√• til <strong>Workflow</strong></li>
        <li>Find <strong>"Missed Call Handler"</strong></li>
        <li>Aktiver workflowet</li>
        <li>Tilpas SMS-skabelonen</li>
      </ol>
      
      <div class="docs-callout tip">
        <svg class="docs-callout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
        <div><strong>üí° Pro-tip:</strong> Inkluder link til online-menu i SMS'en for h√∏jere konvertering.</div>
      </div>
    `
  },
  'train-ai-orders': {
    section: 'Tutorials',
    title: 'Tr√¶n din AI til ordrer',
    desc: 'L√¶r AI\'en at forst√• dine produkter, kundem√∏nstre og s√¶rlige √∏nsker.',
    time: '20 min',
    prev: 'missed-calls',
    next: 'custom-workflow',
    content: `
      <h2>Oversigt</h2>
      <p>Jo mere du tr√¶ner AI'en, jo bedre bliver den til at forst√• dine kunders ordrer.</p>
      
      <h2>Upload din menu</h2>
      <ol>
        <li>G√• til <strong>Kunder</strong> -> v√¶lg restaurant</li>
        <li>Klik p√• <strong>Produkter</strong> tab</li>
        <li>Tilf√∏j alle produkter med navn, pris og kategori</li>
      </ol>
      
      <h2>Godkend/afvis ordrer</h2>
      <p>Hver gang du godkender eller afviser en AI-fortolkning, l√¶rer systemet:</p>
      <ul>
        <li><strong>Godkend:</strong> AI'en l√¶rer at denne fortolkning var korrekt</li>
        <li><strong>Afvis:</strong> AI'en l√¶rer at undg√• denne fejl fremover</li>
        <li><strong>Rediger:</strong> AI'en l√¶rer den korrekte fortolkning</li>
      </ul>
      
      <h2>Tilf√∏j produktvarianter</h2>
      <p>Hj√¶lp AI'en med at forst√• varianter og synonymer:</p>
      <table>
        <thead>
          <tr><th>Produkt</th><th>Varianter/Synonymer</th></tr>
        </thead>
        <tbody>
          <tr><td>Margherita</td><td>margarita, den klassiske, den simple</td></tr>
          <tr><td>Coca-Cola</td><td>cola, coke, sodavand</td></tr>
          <tr><td>Pommes frites</td><td>fritter, pomfrit, fries</td></tr>
        </tbody>
      </table>
      
      <div class="docs-callout tip">
        <svg class="docs-callout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
        <div><strong>üí° Pro-tip:</strong> Brug de f√∏rste 50-100 ordrer aktivt til at tr√¶ne AI'en.</div>
      </div>
    `
  },
  'custom-workflow': {
    section: 'Tutorials',
    title: 'Byg custom workflows',
    desc: 'Opret avancerede automatiseringsflows tilpasset din virksomhed.',
    time: '30 min',
    prev: 'train-ai-orders',
    next: 'vat-configuration',
    content: `
      <h2>Oversigt</h2>
      <p>Workflow-builderen lader dig skabe avancerede automatiseringer uden at skrive kode.</p>
      
      <h2>Workflow-komponenter</h2>
      <ul>
        <li><strong>Triggers:</strong> Hvad starter workflowet (SMS modtaget, ordre oprettet, etc.)</li>
        <li><strong>Conditions:</strong> Hvorn√•r skal handlingen udf√∏res</li>
        <li><strong>Actions:</strong> Hvad skal der ske (send SMS, opret ordre, etc.)</li>
      </ul>
      
      <h2>Opret nyt workflow</h2>
      <ol>
        <li>G√• til <strong>Workflow</strong></li>
        <li>Klik <strong>+ Nyt Workflow</strong></li>
        <li>V√¶lg trigger type</li>
        <li>Tilf√∏j conditions og actions</li>
        <li>Test og aktiver</li>
      </ol>
      
      <h2>Eksempel: Automatisk opf√∏lgning</h2>
      <p>Et workflow der sender opf√∏lgning 24 timer efter levering:</p>
      <div class="docs-flow">
        <div class="docs-flow-step">üöö Ordre leveret</div>
        <span class="docs-flow-arrow">-></span>
        <div class="docs-flow-step">‚è∞ Vent 24 timer</div>
        <span class="docs-flow-arrow">-></span>
        <div class="docs-flow-step">üì± Send feedback SMS</div>
      </div>
      
      <div class="docs-callout tip">
        <svg class="docs-callout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
        <div><strong>üí° Pro-tip:</strong> Start med simple workflows og byg gradvist kompleksitet.</div>
      </div>
    `
  },
  'vat-configuration': {
    section: 'Tutorials',
    title: 'Moms-ops√¶tning',
    desc: 'Konfigurer korrekt momsberegning for din virksomhed.',
    time: '5 min',
    prev: 'custom-workflow',
    next: 'user-management',
    content: `
      <h2>Dansk moms (25%)</h2>
      <p>OrderFlow er konfigureret til dansk moms som standard.</p>
      
      <h2>Indstillinger</h2>
      <ol>
        <li>G√• til <strong>Indstillinger</strong> -> <strong>Moms</strong></li>
        <li>V√¶lg momssats (25% for Danmark)</li>
        <li>Angiv om priser vises inkl. eller ekskl. moms</li>
      </ol>
      
      <h2>Momsberegning p√• kvitteringer</h2>
      <p>Alle kvitteringer og rapporter viser:</p>
      <ul>
        <li>Subtotal (ekskl. moms)</li>
        <li>Moms (25%)</li>
        <li>Total (inkl. moms)</li>
      </ul>
      
      <h2>Eksempel</h2>
      <table>
        <thead>
          <tr><th>Beskrivelse</th><th>Bel√∏b</th></tr>
        </thead>
        <tbody>
          <tr><td>Subtotal (ekskl. moms)</td><td>200,00 kr</td></tr>
          <tr><td>Moms (25%)</td><td>50,00 kr</td></tr>
          <tr><td><strong>Total (inkl. moms)</strong></td><td><strong>250,00 kr</strong></td></tr>
        </tbody>
      </table>
    `
  },
  'user-management': {
    section: 'Administration',
    title: 'Brugere & Roller',
    desc: 'Administrer brugere og tildel roller med forskellige adgangsniveauer.',
    time: '8 min',
    prev: 'vat-configuration',
    next: 'reports-export',
    content: `
      <h2>Roller i OrderFlow</h2>
      <table>
        <thead>
          <tr><th>Rolle</th><th>Beskrivelse</th><th>Adgang</th></tr>
        </thead>
        <tbody>
          <tr><td><strong>Admin</strong></td><td>Fuld kontrol</td><td>Alt inkl. API, fakturering og brugere</td></tr>
          <tr><td><strong>Manager</strong></td><td>Daglig drift</td><td>Kunder, rapporter, workflows</td></tr>
          <tr><td><strong>Support</strong></td><td>Kundesupport</td><td>Kunder, ordrer (kun l√¶se)</td></tr>
          <tr><td><strong>Medarbejder</strong></td><td>Basalt</td><td>Kun egne opgaver</td></tr>
        </tbody>
      </table>
      
      <h2>Opret ny bruger</h2>
      <ol>
        <li>G√• til <strong>Indstillinger</strong> -> <strong>Brugerindstillinger</strong></li>
        <li>Klik <strong>+ Tilf√∏j bruger</strong></li>
        <li>Indtast email og v√¶lg rolle</li>
        <li>Bruger modtager invitation p√• email</li>
      </ol>
      
      <div class="docs-callout warning">
        <svg class="docs-callout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        <div><strong>Vigtigt:</strong> Admin-rollen giver fuld adgang til alle data og indstillinger. Tildel den kun til betroede brugere.</div>
      </div>
    `
  },
  'reports-export': {
    section: 'Administration',
    title: 'Rapporter & Eksport',
    desc: 'Generer detaljerede rapporter og eksporter data til PDF eller CSV.',
    time: '12 min',
    prev: 'user-management',
    next: null,
    content: `
      <h2>Tilg√¶ngelige rapporter</h2>
      <ul>
        <li><strong>Dagsrapport:</strong> Dagens oms√¶tning og ordrer</li>
        <li><strong>Z-rapport:</strong> Kasseafstemning</li>
        <li><strong>Produktrapport:</strong> Salg pr. produkt</li>
        <li><strong>Konverteringsrapport:</strong> SMS -> ordre konvertering</li>
        <li><strong>Genbestillingsrapport:</strong> Tilbagevendende kunder</li>
      </ul>
      
      <h2>Eksport√©r data</h2>
      <ol>
        <li>G√• til <strong>Rapporter</strong></li>
        <li>V√¶lg rapporttype og datointerval</li>
        <li>Klik <strong>Generer</strong></li>
        <li>V√¶lg <strong>Download PDF</strong> eller <strong>Eksport√©r CSV</strong></li>
      </ol>
      
      <h2>Eksportformater</h2>
      <table>
        <thead>
          <tr><th>Format</th><th>Brug</th></tr>
        </thead>
        <tbody>
          <tr><td><strong>PDF</strong></td><td>Print, arkivering, deling med bogholder</td></tr>
          <tr><td><strong>CSV</strong></td><td>Import i Excel, videre analyse</td></tr>
          <tr><td><strong>Excel</strong></td><td>Direkte redigering i regneark</td></tr>
        </tbody>
      </table>
      
      <div class="docs-callout tip">
        <svg class="docs-callout-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
        <div><strong>üí° Pro-tip:</strong> CSV-filer kan √•bnes direkte i Excel for videre analyse.</div>
      </div>
    `
  }
};

// Vis support dokumentation - √•bner docs page
function showSupportDoc(docId) {
  window.location.href = 'docs.html?doc=' + docId;
}

// Load dokumentation i docs-page
function loadDoc(docId) {
  const doc = DOCS_DATA[docId];
  if (!doc) {
    toast('Dokumentation ikke fundet', 'error');
    return;
  }
  
  // Vis docs page
  showPage('docs');
  
  // Opdater sidebar active state
  document.querySelectorAll('.docs-nav-link').forEach(link => {
    link.classList.remove('active');
    if (link.dataset.doc === docId) {
      link.classList.add('active');
    }
  });
  
  // Opdater breadcrumb
  document.getElementById('docs-breadcrumb-section').textContent = doc.section;
  
  // Opdater artikel header
  document.getElementById('docs-article-title').textContent = doc.title;
  document.getElementById('docs-article-desc').textContent = doc.desc;
  document.getElementById('docs-article-time').textContent = doc.time;
  
  // Opdater indhold
  document.getElementById('docs-article-content').innerHTML = doc.content;
  
  // Opdater footer navigation
  const prevLink = document.getElementById('docs-prev-link');
  const nextLink = document.getElementById('docs-next-link');
  
  if (doc.prev && DOCS_DATA[doc.prev]) {
    prevLink.style.display = 'flex';
    prevLink.dataset.doc = doc.prev;
    document.getElementById('docs-prev-title').textContent = DOCS_DATA[doc.prev].title;
  } else {
    prevLink.style.display = 'none';
  }
  
  if (doc.next && DOCS_DATA[doc.next]) {
    nextLink.style.display = 'flex';
    nextLink.dataset.doc = doc.next;
    document.getElementById('docs-next-title').textContent = DOCS_DATA[doc.next].title;
  } else {
    nextLink.style.display = 'none';
  }
  
  // Scroll to top
  document.querySelector('.docs-main')?.scrollTo(0, 0);
}

// Filtrer docs navigation
function filterDocsNav(query) {
  const searchTerm = query.toLowerCase().trim();
  const navLinks = document.querySelectorAll('.docs-nav-link');
  
  if (!searchTerm) {
    navLinks.forEach(link => link.style.display = 'flex');
    document.querySelectorAll('.docs-nav-group').forEach(group => group.style.display = 'block');
    return;
  }
  
  navLinks.forEach(link => {
    const docId = link.dataset.doc;
    const doc = DOCS_DATA[docId];
    if (doc) {
      const searchText = `${doc.title} ${doc.desc} ${doc.section}`.toLowerCase();
      link.style.display = searchText.includes(searchTerm) ? 'flex' : 'none';
    }
  });
  
  // Skjul tomme grupper
  document.querySelectorAll('.docs-nav-group').forEach(group => {
    const visibleLinks = group.querySelectorAll('.docs-nav-link[style="display: flex;"], .docs-nav-link:not([style*="display: none"])');
    let hasVisible = false;
    group.querySelectorAll('.docs-nav-link').forEach(link => {
      if (link.style.display !== 'none') hasVisible = true;
    });
    group.style.display = hasVisible ? 'block' : 'none';
  });
}

// Navigate to settings sub-page
function showSettingsPage(tab) {
  showPage('settings');
  setTimeout(() => switchSettingsTab(tab), 50);
  
  // Open indstillinger dropdown
  document.getElementById('nav-indstillinger')?.classList.add('open');
}

// =====================================================
// DAGSRAPPORT FUNKTIONER
// =====================================================
let dagsrapportData = null;

function generateDagsrapport() {
  const dato = document.getElementById('dagsrapport-dato').value;
  if (!dato) {
    toast('V√¶lg venligst en dato', 'error');
    return;
  }
  
  // Generate demo data based on date
  const dateObj = new Date(dato);
  const seed = dateObj.getDate() + dateObj.getMonth() * 31;
  
  // Format date to Danish (DD.MM.YYYY)
  const formatDateDK = (d) => {
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    return `${day}.${month}.${year}`;
  };
  
  const datoDK = formatDateDK(dateObj);
  
  // Pseudo-random but consistent for same date
  const random = (min, max) => {
    const x = Math.sin(seed * 9999 + min) * 10000;
    return Math.floor((x - Math.floor(x)) * (max - min + 1)) + min;
  };
  
  const brutto = random(150000, 550000) + random(0, 99) / 100;
  const rabatter = random(0, 5000) + random(0, 99) / 100;
  const kontantSalg = random(20000, 80000) + random(0, 99) / 100;
  const kortSalg = brutto - kontantSalg - rabatter;
  const surcharge = random(200, 800) + random(0, 99) / 100;
  const drikkepenge = random(0, 500) + random(0, 99) / 100;
  const momsRate = 0.25;
  
  dagsrapportData = {
    dato: dato, // Keep ISO for filename
    datoDK: datoDK, // Danish format for display
    aabnet: datoDK + ', ' + String(random(4, 10)).padStart(2, '0') + ':' + String(random(0, 59)).padStart(2, '0'),
    lukket: datoDK + ', ' + String(random(20, 23)).padStart(2, '0') + ':' + String(random(0, 59)).padStart(2, '0'),
    medarbejder: 'Medarbejder / Medarbejder',
    dokumentNummer: 'DOC-' + new Date().getFullYear() + '-' + String(random(1, 999999)).padStart(6, '0'),
    bruttoomsaetning: brutto,
    rabatter: rabatter,
    totalomsaetning: brutto - rabatter,
    momsOpkraevet: (brutto - rabatter) * momsRate / (1 + momsRate),
    salgEksMoms: (brutto - rabatter) / (1 + momsRate),
    kontant: {
      salg: kontantSalg,
      omsaetning: kontantSalg,
      total: kontantSalg
    },
    kort: {
      salg: kortSalg,
      omsaetning: kortSalg,
      surcharge: surcharge,
      drikkepenge: drikkepenge,
      total: kortSalg + surcharge + drikkepenge
    },
    moms: {
      rate: 25,
      netto: (brutto - rabatter) / (1 + momsRate),
      moms: (brutto - rabatter) * momsRate / (1 + momsRate),
      brutto: brutto - rabatter
    }
  };
  
  renderDagsrapport();
  toast('Dagsrapport genereret', 'success');
}

function renderDagsrapport() {
  if (!dagsrapportData) return;
  
  const d = dagsrapportData;
  const fmt = (n) => n.toLocaleString('da-DK', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' DKK';
  
  document.getElementById('dagsrapport-content').innerHTML = `
    <div class="report-section">
      <div class="report-header">
        <h2>Detaljer</h2>
        <span class="report-subheader">Oversigt</span>
      </div>
      <div class="report-grid">
        <div class="report-row"><span class="report-label">√Öbnet</span><span class="report-value">${d.aabnet}</span></div>
        <div class="report-row"><span class="report-label">Lukket</span><span class="report-value">${d.lukket}</span></div>
        <div class="report-row"><span class="report-label">√Öbnet af</span><span class="report-value">${d.medarbejder}</span></div>
        <div class="report-row"><span class="report-label">Dokumentnummer</span><span class="report-value" style="font-family:monospace">${d.dokumentNummer}</span></div>
      </div>
    </div>
    
    <div class="report-section">
      <div class="report-header">
        <h2>Salgsoversigt</h2>
        <span class="report-subheader">Oversigt</span>
      </div>
      <div class="report-grid">
        <div class="report-row"><span class="report-label">Bruttooms√¶tning</span><span class="report-value">${fmt(d.bruttoomsaetning)}</span></div>
        <div class="report-row"><span class="report-label">Rabatter</span><span class="report-value">${fmt(d.rabatter)}</span></div>
        <div class="report-row highlight"><span class="report-label">Totaloms√¶tning</span><span class="report-value">${fmt(d.totalomsaetning)}</span></div>
        <div class="report-row"><span class="report-label">Moms opkr√¶vet</span><span class="report-value">${fmt(d.momsOpkraevet)}</span></div>
        <div class="report-row"><span class="report-label">Salg ekskl. moms</span><span class="report-value">${fmt(d.salgEksMoms)}</span></div>
      </div>
    </div>
    
    <div class="report-section">
      <div class="report-header">
        <h2>Betalingsfordeling</h2>
      </div>
      
      <div class="report-subsection">
        <h3>Kontant</h3>
        <div class="report-grid">
          <div class="report-row"><span class="report-label">Salg</span><span class="report-value">${fmt(d.kontant.salg)}</span></div>
          <div class="report-row"><span class="report-label">Oms√¶tning</span><span class="report-value">${fmt(d.kontant.omsaetning)}</span></div>
          <div class="report-row highlight"><span class="report-label">Total</span><span class="report-value">${fmt(d.kontant.total)}</span></div>
        </div>
        <p class="report-note">Alle salg som er afhentning og ikke betales via kort i forbindelse med levering anses som kontant salg.</p>
      </div>
      
      <div class="report-subsection">
        <h3>Kort</h3>
        <div class="report-grid">
          <div class="report-row"><span class="report-label">Salg</span><span class="report-value">${fmt(d.kort.salg)}</span></div>
          <div class="report-row"><span class="report-label">Oms√¶tning</span><span class="report-value">${fmt(d.kort.omsaetning)}</span></div>
          <div class="report-row"><span class="report-label">Surcharge</span><span class="report-value">${fmt(d.kort.surcharge)}</span></div>
          <div class="report-row"><span class="report-label">Drikkepenge</span><span class="report-value">${fmt(d.kort.drikkepenge)}</span></div>
          <div class="report-row highlight"><span class="report-label">Total</span><span class="report-value">${fmt(d.kort.total)}</span></div>
        </div>
      </div>
    </div>
    
    <div class="report-section">
      <div class="report-header">
        <h2>Momsspecifikation</h2>
      </div>
      
      <div class="report-subsection">
        <h3>Rate: ${d.moms.rate}%</h3>
        <div class="report-grid">
          <div class="report-row"><span class="report-label">Net</span><span class="report-value">${fmt(d.moms.netto)}</span></div>
          <div class="report-row"><span class="report-label">Moms</span><span class="report-value">${fmt(d.moms.moms)}</span></div>
          <div class="report-row"><span class="report-label">Brutto</span><span class="report-value">${fmt(d.moms.brutto)}</span></div>
        </div>
      </div>
      
      <div class="report-subsection">
        <h3>Total</h3>
        <div class="report-grid total-grid">
          <div class="report-row"><span class="report-label">Nettobel√∏b</span><span class="report-value">${fmt(d.moms.netto)}</span></div>
          <div class="report-row"><span class="report-label">Momsbel√∏b</span><span class="report-value">${fmt(d.moms.moms)}</span></div>
          <div class="report-row highlight"><span class="report-label">Bruttobel√∏b</span><span class="report-value">${fmt(d.moms.brutto)}</span></div>
        </div>
      </div>
    </div>
  `;
}

function exportDagsrapportPDF() {
  if (!dagsrapportData) {
    toast('Generer f√∏rst en rapport', 'error');
    return;
  }
  
  const d = dagsrapportData;
  const fmt = (n) => n.toLocaleString('da-DK', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' DKK';
  
  // Wait for jsPDF to load
  if (typeof window.jspdf === 'undefined') {
    toast('PDF bibliotek indl√¶ses...', 'info');
    setTimeout(exportDagsrapportPDF, 500);
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({
    orientation: 'portrait',
    unit: 'mm',
    format: 'a4'
  });
  
  // PDF Konfiguration - Matcher Python script farver
  const PRIMARY_COLOR = [26, 26, 46];      // #1a1a2e
  const ACCENT_COLOR = [15, 52, 96];       // #0f3460
  const TEXT_COLOR = [51, 51, 51];         // #333333
  const MEDIUM_GRAY = [224, 224, 224];     // #e0e0e0
  const MUTED_COLOR = [128, 128, 128];     // gray
  
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const margin = 25;
  const contentWidth = pageWidth - (margin * 2);
  
  // Platform info
  const platformInfo = {
    name: 'Ordreflow SaaS',
    address: 'Vestergade 12',
    postalCity: '2100 K√∏benhavn √ò',
    cvr: '12345678'
  };
  
  // Get restaurant info - try selected restaurant or use demo data
  const selectedRestaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  const restaurant = {
    name: selectedRestaurant?.name || 'Restaurant Bella Vista ApS',
    cvr: selectedRestaurant?.cvr || '87654321',
    address: selectedRestaurant?.address || 'N√∏rrebrogade 45',
    postalCity: '2200 K√∏benhavn N'
  };
  
  // Format date to Danish format (DD.MM.YYYY)
  const formatDateDanish = (dateStr) => {
    if (!dateStr) return '';
    // Handle both ISO and already formatted dates
    if (dateStr.includes('.')) return dateStr;
    const parts = dateStr.split('-');
    if (parts.length === 3) {
      return `${parts[2]}.${parts[1]}.${parts[0]}`;
    }
    return dateStr;
  };
  
  // Format datetime to Danish format
  const formatDateTimeDanish = (dateTimeStr) => {
    if (!dateTimeStr) return '';
    const [datePart, timePart] = dateTimeStr.split(', ');
    if (timePart) {
      return `${formatDateDanish(datePart)}, ${timePart}`;
    }
    // If format is "YYYY-MM-DD, HH:MM"
    const match = dateTimeStr.match(/(\d{4}-\d{2}-\d{2}),?\s*(\d{2}:\d{2})/);
    if (match) {
      return `${formatDateDanish(match[1])}, ${match[2]}`;
    }
    return dateTimeStr;
  };
  
  let currentPage = 1;
  const totalPages = 2;
  
  // === HELPER FUNCTIONS ===
  function drawFooter() {
    const footerY = pageHeight - 15;
    
    // Linje over footer
    doc.setDrawColor(...MEDIUM_GRAY);
    doc.setLineWidth(0.5);
    doc.line(margin, footerY - 5, pageWidth - margin, footerY - 5);
    
    // Side nummer
    doc.setFontSize(9);
    doc.setTextColor(...TEXT_COLOR);
    doc.setFont('helvetica', 'normal');
    doc.text(`Side ${currentPage} af ${totalPages}`, pageWidth / 2, footerY, { align: 'center' });
    
    // Platform info
    doc.setFontSize(8);
    doc.setTextColor(...MUTED_COLOR);
    const footerText = `${platformInfo.name}  ‚Ä¢  ${platformInfo.address}, ${platformInfo.postalCity}  ‚Ä¢  CVR: ${platformInfo.cvr}`;
    doc.text(footerText, pageWidth / 2, footerY + 4, { align: 'center' });
  }
  
  function drawHeader() {
    let y = 20;
    
    // Titel
    doc.setFontSize(22);
    doc.setTextColor(...PRIMARY_COLOR);
    doc.setFont('helvetica', 'bold');
    doc.text('DAGSRAPPORT', margin, y);
    
    // Platform navn
    y += 7;
    doc.setFontSize(10);
    doc.setTextColor(...ACCENT_COLOR);
    doc.setFont('helvetica', 'normal');
    doc.text(platformInfo.name, margin, y);
    
    // H√∏jre side: Dato
    const todayFormatted = new Date().toLocaleDateString('da-DK', { 
      day: '2-digit', 
      month: '2-digit', 
      year: 'numeric' 
    });
    doc.setFontSize(10);
    doc.setTextColor(...TEXT_COLOR);
    doc.setFont('helvetica', 'normal');
    doc.text(todayFormatted, pageWidth - margin, y - 7, { align: 'right' });
    
    // Restaurant info til h√∏jre
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text(restaurant.name, pageWidth - margin, y - 1, { align: 'right' });
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.text(restaurant.address, pageWidth - margin, y + 5, { align: 'right' });
    doc.text(restaurant.postalCity, pageWidth - margin, y + 10, { align: 'right' });
    doc.text('CVR: ' + restaurant.cvr, pageWidth - margin, y + 15, { align: 'right' });
    
    // Header linje
    y += 18;
    doc.setDrawColor(...PRIMARY_COLOR);
    doc.setLineWidth(2);
    doc.line(margin, y, pageWidth - margin, y);
    
    return y + 8;
  }
  
  let y = drawHeader();
  
  function drawSectionHeader(title) {
    // Check for page break
    if (y > pageHeight - 60) {
      drawFooter();
      doc.addPage();
      currentPage++;
      y = 25;
    }
    
    doc.setFontSize(14);
    doc.setTextColor(...PRIMARY_COLOR);
    doc.setFont('helvetica', 'bold');
    doc.text(title, margin, y);
    y += 2;
  }
  
  function drawSubsectionHeader(title) {
    doc.setFontSize(11);
    doc.setTextColor(...ACCENT_COLOR);
    doc.setFont('helvetica', 'bold');
    doc.text(title, margin, y + 6);
    y += 10;
  }
  
  function drawDataRow(label, value, isLast = false) {
    // Check for page break
    if (y > pageHeight - 40) {
      drawFooter();
      doc.addPage();
      currentPage++;
      y = 25;
    }
    
    // Background for row
    y += 4;
    
    // Label
    doc.setFontSize(10);
    doc.setTextColor(...TEXT_COLOR);
    doc.setFont('helvetica', 'normal');
    doc.text(label, margin, y);
    
    // Value
    doc.setTextColor(...PRIMARY_COLOR);
    doc.setFont('helvetica', 'bold');
    doc.text(value, pageWidth - margin, y, { align: 'right' });
    
    y += 4;
    
    // Linje under
    if (isLast) {
      doc.setDrawColor(...PRIMARY_COLOR);
      doc.setLineWidth(1);
    } else {
      doc.setDrawColor(...MEDIUM_GRAY);
      doc.setLineWidth(0.5);
    }
    doc.line(margin, y, pageWidth - margin, y);
    
    y += 4;
  }
  
  // === PAGE 1: DETALJER + SALGSOVERSIGT ===
  
  // Detaljer sektion
  drawSectionHeader('Detaljer');
  drawSubsectionHeader('Oversigt');
  
  drawDataRow('√Öbnet', d.aabnet);
  drawDataRow('Lukket', d.lukket);
  drawDataRow('√Öbnet af', d.medarbejder);
  drawDataRow('Dokumentnummer', d.dokumentNummer, true);
  
  y += 8;
  
  // Salgsoversigt sektion
  drawSectionHeader('Salgsoversigt');
  drawSubsectionHeader('Oversigt');
  
  drawDataRow('Bruttooms√¶tning', fmt(d.bruttoomsaetning));
  drawDataRow('Rabatter', fmt(d.rabatter));
  drawDataRow('Totaloms√¶tning', fmt(d.totalomsaetning));
  drawDataRow('Moms opkr√¶vet', fmt(d.momsOpkraevet));
  drawDataRow('Salg ekskl. moms', fmt(d.salgEksMoms), true);
  
  // Draw footer for page 1
  drawFooter();
  
  // === PAGE 2: BETALINGSFORDELING + MOMSSPECIFIKATION ===
  doc.addPage();
  currentPage++;
  y = 25;
  
  // Betalingsfordeling sektion
  drawSectionHeader('Betalingsfordeling');
  
  // Kontant
  drawSubsectionHeader('Kontant');
  drawDataRow('Salg', fmt(d.kontant.salg));
  drawDataRow('Oms√¶tning', fmt(d.kontant.omsaetning));
  drawDataRow('Total', fmt(d.kontant.total), true);
  
  y += 6;
  
  // Kort
  drawSubsectionHeader('Kort');
  drawDataRow('Salg', fmt(d.kort.salg));
  drawDataRow('Oms√¶tning', fmt(d.kort.omsaetning));
  drawDataRow('Surcharge', fmt(d.kort.surcharge));
  drawDataRow('Drikkepenge', fmt(d.kort.drikkepenge));
  drawDataRow('Total', fmt(d.kort.total), true);
  
  y += 8;
  
  // Momsspecifikation sektion
  drawSectionHeader('Momsspecifikation');
  
  drawSubsectionHeader('Rate: ' + d.moms.rate + '%');
  drawDataRow('Net', fmt(d.moms.netto));
  drawDataRow('Moms', fmt(d.moms.moms));
  drawDataRow('Brutto', fmt(d.moms.brutto), true);
  
  y += 6;
  
  drawSubsectionHeader('Total');
  drawDataRow('Nettobel√∏b', fmt(d.moms.netto));
  drawDataRow('Momsbel√∏b', fmt(d.moms.moms));
  drawDataRow('Bruttobel√∏b', fmt(d.moms.brutto), true);
  
  // Draw footer for page 2
  drawFooter();
  
  // === DOWNLOAD ===
  // Use Danish date format for filename (DDMMYYYY)
  const dateForFile = d.datoDK ? d.datoDK.replace(/\./g, '') : d.dato.replace(/-/g, '');
  const fileName = `Dagsrapport_${dateForFile}.pdf`;
  doc.save(fileName);
  
  // toast('PDF downloadet', 'success'); // Removed - unnecessary
}

function exportDagsrapportExcel() {
  // Redirect to new ExportService
  ExportService.toExcel('dagsrapport');
}

// =====================================================
// =====================================================
// EXPORT SERVICE - Enhanced with Logo & Professional Wrapper
// =====================================================
const ExportService = {
  // Logo as base64 (FLOW logo sort)
  logo: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAADwAAAAPaCAYAAAAqPq0AAAB+wElEQVR4nOzd15IjuREAwObE/v8vUw97ox3HIdsAKJMZsSGFzB2vDVCoQjVuG8Bx99U/AADYbqt/AAAAAAAAAAAAAAAAcC3NAsARGn8BIBZxPQAAAAAAAAAAAAAAFPJn9Q8AUtH4CwAAAAAAAAAAAAAAAACDOSkMeIXGXwCIT2wPAAAAAAAAAAAAAABFvK3+AUB4mn8BIAdzNgAAAAAAAAAAAAAAFPFn9Q8AwtE8BAAAAAAAAAAAAAAAAAAL3Vb/AGApzb4AUI8YHwAAAAAAAAAAAAAAktMcAP1o+gWA+sT5AAAAAAAAAAAAAACQmMYAqE/DLwD0JNYHAAAAAAAAAAAAAICk/qz+AcAQmn4BAAAAAAAAAAAAAAAAICmngkENGn4BgJ+I9wEAAACgpvv2N/83o04ozwgAAAAAAAALKNRBPpp9AYA9xPwAAAAA8NxPNbhHuTX1uu/kIQEAAAAAAOBiinAQk00DAMBVxPwAAAAAdKXmtp78JAAAAAAAAByk2AZx2IAAAIwi7gcAAACgAvW0GuQrAQAAAAAA4AUKa7CWTQoAwAzifgAAAACyUD/rSQ4TAAAAAAAAvlBEgzVsXAAAZhL3AwAAABCFOhl7yW8CAAAAAADQkkIZzGMzAwCwktgfAAAAgBnUxJhFzhMAAAAAAIDSFMRgPJscAIAIxP4AAAAAXEX9i+jkQwEAAAAAAEhP0QvGsfEBAIhE7A8AAADAUepeVCBHCgAAAAAAQCoKXHAtmx8AgKjE/gAAAAC8Qr2LTuRNAQAAAAAACEsxC65hIwQAEJ3YHwAAAICfqHPBP/KoAAAAAAAAhKF4BefYEAEAZCH2BwAAAOhLTQuOk1sFAAAAAABgCYUq2M8GCQAgI7E/AAAAQA9qWTCHnCsAAAAAAABDKUjB62yWAAAyE/sDAAAA1KWOBWvJvwIAAAAAAHA5RSj4nc0SAEAVYn8AAACAetSyIB65WAAAAAAAAC6h8AQ/s1kCAKhG7A8AAABQh1oW5CI/CwAAAAAAwG6KTPCPjRIAQGVifwAAAIC81LGgPjlcAAAAAAAAPlFAAhsmAIAexP4AAAAAOahdAe/kdQEAAAAAABpTLKIzmycAgE7E/gAAAADxqFcBe8jzAgAAAAAANKI4REc2UgAAHYn9Aa73bH1p7AUAAB5RrwKuIPcAAAAAAABQmGIQ3dhMAQB0JfYHOOfsetI4DAAAqFMBo8k/AAAAAAAAFKL4Qxc2VAAA3Yn963sl5vUcwHOj14/eQwAA6EedClhFHgIA6EbNFAAA4Hf3zboIZnmUp9j1Dnph6cCmCgAAsX9lTiWls6zrPe8dAADUl3W9AtQlHwEwTrXY75U545LNi3CBM++f5xUAAOjgyLrpTG7gyr8HZDLsnfCyUFm15DoAwBli/5pmxLwfnx1ffqvDemk97xIAANRkvQVkIj8BcJy4Ly/z3z4dnnXPBAAAUFGH9Rx0cJO4oCoTFQDAZ2L/msS9kJdxGQAAarFGB7KTqwB4ndgP6hELAQAAlchdQCGSFlRjkgIA+JnYvx6xL+RnbAYAgNyszYHK5C0AfiYGhLrEPwAAQAVyF1DMn9U/AC5iggIAAAAAAGAGdSmgg49jnWYYgL/EgVDbfRP3AAAAAMFIVpCZpDoAwGvE/fWIhaEG4zMAAORhLQ7wl3wG0JmYEHoQ7wAAAFnJXUBBEhVkZEICANhH3F+PmBjqMEYDAEBs1uAAz8lvAF2IDaEP8Q0AAJCNvAUU9Wf1D4AdTEYAAAAAAACMpiYFsM9P46amGQAAAAAAgJMUXMjAJgsAgOPE/PWIj6EW4zQAAMRhzQ0wjhwIkJ1YEfoRvwAAAFnIW0BhTgAmMhMQAMA5CpIAAAAAz6lJAYz3PtbKWwMAWdw3sQsAAACwmAZgorLRAgDgHIVIAAAAgMfUogDW0EgDAAAAAHAdNS8oTgMw0Zh4AADOs3kKAAAA4Dt1KIAYNAEDAAAAAAC84G31D4APbLoAADjPpikAAACAf+4f/gAQh3EZAMhAzAIAAAAs5QRgIpAkAwA4T+MvAAAAwD/qTwDxvY/V8ttABrdNjAkAAAAATKYBmNUkxjlKYQUAbIrqSPwDAAAAv7N2Bsjn49gt7w0AAAAAAPAfDcCsZAMGZ4u3ir9EZozjJ88+XtBtXOvynrzf9273FwAAAGCWLnkmgA6+july6wAAAAAAQFsKJaxgE0YPxhcAgOuJpaEm6ycAADjGOhmgH3kUYCXxJ/Qk/gAAAKKSq4AGnADMTCaW2iQ6AQAA9rOWAgCAfdSbAHp7nwfkVAAAAAAAgPI0ADOLzRi1KKYCAAAAAAAzqTUB8JFGYAAAAAAAoDyFEEazGaMGYwUAQAzia6jHegsAAB6zDgbgVXIswCxiVOhJrAEAAEQkTwENOAGYkUwkeUlYAgAAAAAAK6kzAbDHfVPnBgAAAAAAitEAzAg2ZMSn8AkAAAAAAESkzgTAUe9ziHo4AAAAAABQggZgrmZTRkwKnAAAAAAAQGRqTABcRSMwMNJtE7sCAAAA68lPQBMagLmKiSMmBU0AgFpsKgEAAKAa61wARtEIDAAAAAAApKYBmCvYmBGPAiYAAAAAABCZ+hIAs3ycc9TSAQAAAIDs1NmgEQ3AnGHCiEexEgAAAAAAiEptCYDVnAoMXOG2iW0BAAAAgAk0AHOUJHYMipIAAAAAAEB06koARKMRGAAAAADISN0NmtEAzBEmi7UUIAEAAAAAgAzUlACITiMwAPCK+yZeAAAAABbQAMxeNmqsIXkIAAAAAABkoZ4EQDYagQEAAAAAgGhuGoDZw2aNuRQWAQAAAACATNSSAMhOIzDwqtsm/gUAAADmkouAXm7b5gRgXmOCmEshEQAAAAAAyEY9CYBKNAIDAAAAAACr/L8+oQGYZ2zWmEfhEAAAAAAAyEYtCYDKNAIDAAAAAAAzfapJvK36FaRgw8Y8ioUAAAAAAEAm900tCYA+zHvAT+z3AQAAAGaRn4SmnADMT0wKcykGAAAAAAAAWagjAdCZE4EBoK/7JgYAAAAAxvqWe9AAzFc2bcwjGQgAAAAAAGSgfgQAn32cG9X+AQAAAACAs36sN2gA5p2NG/Mo/gEAAAAAABmoHwHAc04Fht5um7gZAAAAADjnYY1BAzAS0PMo9gEAAAAAANGpHQHAMRqBAQAAAACAS2kA7s0GjjkU9wAAAAAAgMjUjADgOhqBAQAAAIArqeVBbb/WE95m/QrCMfiPdfvwBwAAAAAAICo1IwAYwxwLfdgfBAAAAAAM4QTgnhSZxpHQBwAAAAAAMlAvAoDxnAYMALXcN/M6AAAAMJEG4F5s5BhHUg8AAAAAAMhAvQgA5tMIDAAAAAAAfPW0bvA241cQgs0c4yjQAQAwi7geAACAM6wrAWCt+2Y+hqrsHwIAAAAALucE4B4Uj8aQuM/hp+f/9t9/7h4CAAAAAFCdOhEAxONEYAAAAAAA6O2lGoEG4Pps6rieAtxaVzzT9y//Cpx39dj47P28PfnfPPvvszMXXWPUM+JDEwAAAEAUlXNkAFDBx7laXQEAAAAA+Eq9D5pTPKjLAH8978tcnmEA3h2dg7PPJWIPfpL9uQa+M94DADCC9SMA5CZnBHmJxaEHczUAADCLXAPU9HJuwQnANRncrydhN57nFoBHus4Rj/65xSUAAADAI13zKABQzfucriYAAAAAAACNaQCuxaaO6ymmjeFZBYDjvs6j4hUAAADoTc4dAOrSCAwAAAAAALXsyvkrENRhc8e1vBvX84wCwFjilx7EVFCP8RsAgKOsEQGgF3kkyEOsDj2YmwEAgNHkGKCmXTkFJwDXYEC/lsTceZ5JAJjvvoljAAAAoAM5eADoyWnAAAAAAACQ2+4cvwbg3GzwuJYi2XGeRQCIQRMwAAAA1CYfDwCoBQAAAAAAQBMKAnnZ4HEd78F+nj8AiE18U5c4DOoxZgMA8ArrQQDgEfkliEkMDz2YhwEAgJHkF6AeJwA3YQC/huTbPp47AMjD1/8BAACgBrl5AOCZj/GC2gAAAAAA1KBOCGzbJvGfkQH8PM/96zxvAJCbuKce8RnUY6wGAOARa0AA4Ax5J1hPTA89mHMBAIAR5BWgnkM5BCcA52LwPk+y7XeeMQCoxUnAAAAAkI9cPQBwhfeYQp0AAAAAAACS0gCch80e5ylqfeaZAgAAAACAOOTtAYARNALDOrdNnA8AAADsJ58A/J8G4BwM3OcoYv3lOQIAAAAAgJjk8AGA0TQCA8AY9838CgAAAAyiATg+Gz7O6ZxY8+wAANum2AgAAACRyeUDALOpG8BcTgEGAAAAAA7n5TUAxyb5e07XgpXnBgAAAAAAYpPLBwBWchowAAAAAAAkoAE4Lhs/jutaoPLMAAAAAABAbHL5AEAkTgMGAAAAAIDANADHZPPHcd0KU54VAAAAAADIQU4fAIjIacAAAAAAABCUBuBYbPw4rlshyrMCAOzhC/4AAACwjpw+AJCBRmAY57ZZFwAAAABAV6fy7hqA45DkPaZT4ckzAgAAAAAAAACM5KOiAAAAALCO3iHgEw3AMRic9+tSbPJsAAAAAABAXvL8AEBGTgMGAAAAAIAA3lb/AGz82Om29Sgw3TfPBgAAAAAAZCbPDwBkJ54BgNeYMwEAAICfnO6DdAIwWXRo+t02iUAAAAAAAKhAvh8AqMJpwAAAAAAAsIgTgNey+eM1HYpITvwFAAAAAIAa5PsBgIrsa4BzOux/AgAAAAD+uSQn6ATgdRRFnuuQ+PYcAAAAAABADXL+AEAH963Hfg4AAAAAAFjOCcBEVb1Y5Mu4AAAAAABQh5w/ANCJ2AcAAAAArifvBnzjBOA1DMi/q9z8694DAAAAAEAd8v4AQFfvcVDlPR4AAAAAAHDEZblzJwDPZyPI76oWhpz4CwAAAAAAdcj7AwD8JSaC11XdFwUAAAAADOIE4LkUPR6rmOB2vwEAAAAAoBa5fwCA75wGDAB/50NzIQAAAHBpfkAD8Bw2g/yuWtLL/QYAAAAAgFrk/gEAntMIDAAAAADHqEcCP3pb/QMaMAA/dttqFX3um/sNAAAAAADVyP0DAOwjfoLHKu2VAgAAAAAGcwLwOIoZv6uUzHavAQAAAACgHvl/AIDj7lutvSEA8ArzHwAAAPR2eV5AA/AYNoQ8Vim55T4DAFlUisG6u23iUAAAgBmsvQAAznuPqdQpAAAAAADggLfVP6AgG0J+dttqFXTcZwAAAAAAqOe+qQEAAFxNfAWfVdpDBXxn3gMAAPayjoAahuT9NAAzQ6WktY0/AAAAAABQk/w/AMA4Yi0AAAAAANjpz+ofUIxixWfVGn8BAAAAAIB61AAAAOa4b7X2kgAAAAAAwFAagK9jc8hnVQo27isAAAAAANSlDgAAMNd7/FVlXwkAAAAAAAyjAfgaNod8VqFI454CAFVUiM0AAADgauoAAABrOQ0YAAAAAIAqhuW730b9hWkrc3Hm/uEPAAAAAABQkzoAAEAM9mjQWeY9VsBz5jcAAADgEk4APk+i5q/MSWn3EACoKnOMBgAAACOoCQAAxOM0YAAAAAAA+IEG4ONsEPknaxHGPQQAKssaowEAAMAIagIAALG9x2vqGwAAAAB0oo4J+Q3Na7+N/IvTQsbCy30zQQIAtWWM0QAAAGAUNQEAgDzEbgAAAAAA8B8nAO+n0PBX1qYS9w8AqC5rnAYAAAAjqAsAAORz39Q7AAAAAABAA/BONon8lbXI4v4BAJVljdEAAABgBDUBAIDcNAEDAAAAABDd8Dy2BuDX2SjyV9biivsHAFSUNTYDAACAkdQEAABq0AQMAAAAAEBrGoBfY6PIX1mLKu4fvObrO+7dAdgna6wEAAAAlchrAgDUogkYgKzMYQAAwDNqm8BTGoB5VdZElMmQM7I+91cZ+c/v3Txv1vPpXvUy47nK8Ex1H/8BAAAgqwx5BwAA9tNABQAAAABANFPy1pLjz9kskvc5ce94RdbnGwDoS5wLtViTAABcw1oJAKA+uTQqspaB2sxdAADAb+QFILcp634nAP/OQJo3AeXe9ZH1GQUAAAAA4BpqAgAAPTgJGAAAgCO+1hGsLQGANDQAP2azSN7A1r2LLetzBQAAAABAPGoCAAC9vMd/9h4AkIGPVwBRyKPCZxqCAYCzpsUPGoB5JGsQa4G6XtZnBwAAAACAPNQDAAB60whMFbfN+gYAGEOMAa/z0Q5gBXM18BINwD/rPohmDF6737OVMj4vAAAAAADkpSYAAMA7m7QBAOAz+VM4xoemAIBXTY0XNAB/13nRkzVY7XzPVsj6nAAAAAAAkJ+aAAAAX9mkDUBkPlYBzCR/CueZuwGAUDQA8y5jkGqROk/G5wMAAAAAgFrUBQAA+I1N2mR126x3AIDzxBMAAFDQ2+ofEEzXhU/G4kfXezXT7cMfAAAAAABYSV0AAIBXiBsBAOhIHAzX8k4BAI9M77NzAnBvGRs7BdNjZHwWAAAAAADoQW0AAAAAAOBn8qcAkI/5G3iZBuB/ug2eGRs+u92jkTLefwAAAAAA+lEbAABgr/tmXwQAAADnWFsCACG8rf4BQXTbPJIxEO12j0a4ffgDAAAAAADRqQ0AAHCUWJJs7OeB2sxLwCjGFxjLOwYAfLQkh+cE4F5BWdZEcad7NELW+w4AAAAAQE/qAgAAXMFpTQAAAAAApNb9BGAbSOJzj45z2i8AAAAAANmoCwAAAF3Z5wMAAPGoWwBXM64Au3Q+AbjbgJktQdzt/lwp270GAAAAAIBtUxsAAOB6TgEGAKAq+VQAAJhnWZ656wnA3RY82QoZ3e7PVZz4CwAAAABARvdNbQAAgHHEmgAAAJxhXQkALNO1AbiTbA2hguPX3b78AQAAAACAbNQFAACYQdxJFvYAQV3mIgAAAMhpac6uYwNwpyRKtoRwp3tzhoZfAAAAAAAqUBcAAGAm8ScAAABHWVMCAEt0awDuFHRlaxDtdG+O0vgLAAAAAEAV6gIAAKwgDgUAAABgFbkpYLc/q3/ARJ0GyUxNop3uy1GZ7icAAAAAADyjNgAAwEr3zV4MAAByk2MFAIAmup0A3EGmAoXF5++c+AsAAAAAQDVqAwAARCAuJTL7hQAAICZrSQDoZ3murssJwF0CreUP1Iu63I+jstxHAAAAAADYQ30AAIBI3uNT+zQAmMUp9AAAAMAuHRqAu2wmyZAU6nIvjspwDwEAAAAA4Ag1AgAAotKMBQAAAABASG+rfwCXyFCEsLHndxnuIQAAAAAAHKFGAABAdGJWorGXCAAAAGqRfwIOqd4A3GFwzJDs7XAfjrptOe4hAAAAAAAcoUYAAEAWYlcAAACesXYEgD5C9PxVbgCuHlhlaRytfh/OyHD/AAAAAADgKDUCAACyEcMCABCdmBUAABr5s/oHDFJ9YZOlcbT6fTgjyz2sovOz6FkDAAAAAAAAgNfdN7V2AMYxzwAAAAAvq9oAzHqdGy5/I3E3lufuuxnXxHMNAAAAAHwlXwsAQGaas4jgtllbAQBARNaMwF7W98BhFRuAqw+KGQLF6vfgqAz3LgPPVzzuSV1XFBNfGfskQgAAAABqkTMEAKACdUwAAAAAgJ7C5IarNQBX31AS5sFhN/dun+rvMmRxxbv46l/De3+eueaYq5491x8AAAD+kucBAKASTcAAAEQi/woAAM1UagCuvqDJUkyofh+OyHLvVvC8AFzHmLrWs+t/NB746a8rtgAAACAiuQkAAKrSBAwAAAAAwBKVktPVN5ZkuFfV78FeGe7ZTJ4PABhL7NGHuApqMX4DABVYpwAA0IFcHqtYc0FN5hXgCHEBxGI+B15h/oZ8Qs3xVU4Arj4YhnpoHqh+D/bKcM9G8jwAwHzv82/3OAQAAIC55IMBAOjCScAAAKwkFwsAAA1VaAC2mFnL9f+sa6HHcwAAcWgEBgAAYBa5YQAAutEEDAAAAADANG+rfwBPRS4a2Njzz22Lfa9GuH/4AwDEY44GAABgJOtOAAC6EgszW7c9SQDAd2JQiMm7CQD1hMvFZW8Arh4whXtgPqh+7feIfJ+upukXAAAAAAA5YgAAuhMTA3CWuQQAAOoT9wOnZW4Arj4IRm4qrX7tX9Xp1F9NvwCQk/kbAACAq1lrAgDAX2JjAABmEHcCAEBjmRuAK4vcVGoR+Vfke3QVp/0CQA3mcgAAAK5ijQkAAJ+JkZmlw14lAADIyLoQAOoImYP7s/oHHFQ5SAr5oGy1r/leUe/RVdxrAAAAAAAAAIDX3Lf6e0kAAAAAAFggYwNw5ebEqMWAytd8j6j35yz3FwAAAACAZ+SSAQDgMU3AABxh/gCekZcFAIDm3lb/AP4vahLHwvGvqPfnqPuHPwBAfeZ8AAAAzrCuBACA58TNAAAAPVkPAj8xNkAuYXsHszUAVx38oj4gVa/3XlHvz16afgEAAAAA2EtOGQAAXid+ZqQqe5gAAAAAgBdlawBmHgWJvyokzjX9AgAAAABwhNwyAADsJ44GAOAK4koAAJgjdP9gpgbgqouY0A9IcxXuTdX3BgAAAACAseSXAQDgOPE0o1TYzwR8Zs4AgBrM6QDAEFkagAVDc7neNZLl7iMAAAAAAHvdN/llAAC4grgaAAAAoCd5IeAyWRqAq4rYZGqSiXlf9nIfAYCvxAcAAAA8Y+0IAADXEmMDAHCEOBIAAOYI30eYoQG46gIm/MPRVIX7UvWdAQAAAABgHLllAAAYQ6wNAADQg/UfAHC56A3AAqC5ul9vzb8AAAAAAAAAAFzNfg4AAAAAAHaL3gBcVYVG02qy35P7plgEAAAAAMAx8ssAAAB5ZN/nBHwnNwMAAADzpcizRW4AltCYq+v1vm1JXtZfdL13AAAAAACcJ8cMAABziL0BAHiFuBEAAPi/P6t/wAOVFy4Rm00rX+/fRLwXr+p6zwAAAAAAAAAAsrpvuferAAAAAAAwUdQG4KoiJvA7NpJGvA+v6ni/AAAAAAAAAAAAAAAgOh9+AgAu9bb6B/ygaoNjxCCu6rX+TcT78KqO9wsAAAAAgHHknQEAYD5xOAAAj4gVAQBgjjQ9htEagC1a5ul4rdO8mD/oeL8AAAAAABhH3hkAANYRj3NW5n1QAAAAUJm8D3CpSA3AlQe4aAnXytf6kWj34FX3ref9AgAAAAAAAACozH4QAD4yLwAAAADfRGoAripa42nHJFG0e/CqjvcKAAAAAIDx5J8BACAGsTkAAO/EhlCH9xkAuEyUBmABzhwdr7PmXwAAAAAA+Ef+GQAAAAAAAOB6arGQQ6p+wygNwIzXcRJJ9TL+5771vFcAAAAAAIwn/wwAAPHYK8JRGfdGAQAAAAA7RGgArpzAlmRdJ9u1V8wBAAAAAGAkOWgAAIhNzA6AuQD68v5DPd5r6Md7DwwRoQGY8TpNIrctZ/MvAAAAAACMIg8NAAA5iN0BAAAAAMbJ1ne4/Vn896+ctI7yMFS+xl9Fueav6nRvAAAAAABYQy4aAAAAACAuOVwAyM98Dgyz8gRgg9t4na6x5l8AgN9li5cAAAA4Ty4aAADyEcezhxog1GMeAIA6zOsAEEvKXNrqE4CrivAwdAkWI1zrPbrcFwAAAAAA1pKPBgCAvO5bvj0xAADsJ48LAPmZz4GhVp4ADGdlK3SY1AEAAAAAmEE+GgAA8hPXAwAAAAA0t6oBuHKCOkJTauXru21/r3GE67xH9XsCAAAAAEAM8tEAAFCH+B4AoC6xHvTgXQcATnECMNlka/wFAIhADAUAAAAAAAA1qQUCAADAGpr8IY+0OTQNwNeK8CBUnjwiXN+97lvtewIAAAAAQBzy0QAAUI84H6AfYz8AAACwbduaBmCJCY7I2vwLALBaxjgKAAAAAACAf+xBAQCoRXwHAAC8xAnAtVRdDGZsWql6LwCAXDLGUQAAABwjLw0AAAAAABCPGg4AcJgG4Ousbq6oGhSuvq573be69wIAyCVbHAUAAMBx8tIAAFCfuB8AAAAAoJnZDcAS0VTm+QYAIrhtmn8BAAA6kZsGAIA+xP8AAPmJ6QCgBnM65JF6b70TgK+x+iGoOmmsvq57VL0HAEAeGn8BAAD6kZsGAIB+rAP4iTohAAAAABT0Z+LfS/J5DNd1PfcAAFhFIR8AAKAvuWkAAAAAAAAAgMJmNgBXtbLpovLmnizNLJXvAQAQR5bYCAAAgDnkpgEAoLf3NYEaEkBd9804DwCVmNsBgEM0ABNRlsDWBqvxrnoWHt2rLM8aRGQMhPPMQwAAAAAAAAAA0Id9dwAAwC6zGoCrLlac/nu9LI0wVa//aqPuf5bnCjLxXpHByvnaOwIAAMAo8tMAAMA7J0gBAAAAADyWPn/qBOCcqm7uyfJCVb3+q2S57wDkY44BAACgGvlpAADgK03AvLtt1o0AAAAwg/U3MM3bhL9H1UFtVeLc9Vyr6vWf7fbhDwAAAAAAz8lPAwAAj1gvAAAAxGftBgDs5gTgXKoGfBmaQKte+5ky3GcAAAAAAAAAgIycBAxQj7EdarEXGQAA5iqxph7dAFx1oVLi5geQ5TpWfY5nyHKPAQAAAAAik6cGAAAAAAAAWE/tFpjqbfUPSGhVQ2O1CSJLY2i16z7D7cMfAAAAAADOkacGAABeZf2A/ToAAAAAUChPNrIBWEKZR7K8QJ7h12n6BQAAAAC4njw1AAAAQG/yQ1CDdxl4ZzwAAHZxAvA+Tv89L0uDaKVrPoqmXwAAAACAceSpAQCAI6wlsJcHAAAAgM5K5cf+DPrrVkwkl7rxi2S5hhWf3ytluY8AAAAAAAAAAAAAAABwBf1GwHROAI7P5DCX6/2Y034BAAAAAOaQqwYAAM6wpgCoxbgOuXmHga+MCwDAyzQAM0uGxlGB9M80/gIAAAAAzCNXDQAAXMHaAgAAAADoplwP3IgG4IrJ41U3vuK1jMq1/lm5QQ8AAAAAIDC5agAAAK5gzw8AAABcSy0XWMIJwM9Jhp4X/RqahL9z6i8AAAAAAAAAQG72xADUYUwHAACA35Xshbu6AViC4Tqu5Ryu83clBzsAAAAAgODkqwEAgBGsNQAA1hGLAY8YHwCAlzgB+HcaIc+LfA0FzZ859RcAAAAAYA35agAAYCRrjp7sAwIAAACA5K5sAJYohpw0/gIAAAAAAAAA1GZvF0B+xnIAAFhDLA7xle2N+7P6BwS28qZXmRiivjhVru9ZUe8PAAAAAEAnctYAAAAAAPXI/QIAAKddeQIwZGAx/ZfmXwAAAACA9eSsAQCAmaxB+rFHCAAAAAASu6oBuFpy2Om/50VMHle5tmfctpj3BgAAAAAAAACA8eyfAQAAiMH6DHLwrgJLOQGYLrpPuBp/AQAAAABi6Z63BgAA1rEeAcjLGA45eFcBAIBLaACOpcpiL1qjaZXrelS0+wEAAAAAAAAAAAAAAAAA/OKKBuBqzZWrmiWrXccoOl9Xp/4CAAAAAMTUOXcNAADEYF3Sh/1DAAAAAFRWOv/lBODPSt/sSSJdw86Fikj3AQAAAAAAAACAeDrvrQEAGEWMBQAAXEYDcAxVFnqRmk6rXNO9nPoLAAAAABBb1/w1AAAAANeQXwKAOszrEJt3FFjubANwpYFM02QdlZ7LV2n8BTLoOD4DAAAAfCQ/AgAARGOdAgAAAAAQ1J/VP4AySfQozadVruerolz3iLo9C7N0eOY8O2O5vud1eA9nOvpM3j78f9/vyf3Df+4+AQAAAAAAkIX6Vn0f65sAwDjmWwAA4FIagP+SwD7H9ZvPNf9LomQ+1xzW8x7GcH/y76++T+Z+AACA/KzpAQAAAAAAAHJQ3wVC0AC8lsngWh2uZ+fmnw73FwAeeTQPdo4NAAAAMpHfBAAAonMKMEAuxm0AqMO8DgDHlZ9DzzQA26zCtjV4SYLodp2NLwDwmo9zZrd4AQAAIAv5TgAAIAubzgEAjpMLBgAALucEYEnrMyJdu8qL5kjX+WqV7xsAzPY+r1aOHQAAAAAAABhLE3Bdt81eHQAAAABIRQMwxFatoKKIAADjaQQGAACIQ04UAAAAAACAZ3yMCWJR5wXCeFv9AxZbGSBlnwwiBZfZr+Ujka7xGfcPfwCAecy9AAAAa1mXAQAAWVnPAADsI34CAACGONoAbJFCFFWfxezNv5p+ASAG8zEAAMAa1mIAAEB21jU1Zd+TBHxmrAYAAIDiOp8ALJl5XJRrVzV5FeX6HqHJCABiMj8DAAAAAACwlxoTAADAPNZgALBP5h68l3VuAF4pc2AW5cXIfA1/E+X6HlH1ngBAFeZqAACAOay/AAAAAAD6kBMGgFrM7UAoGoDJyGQai1N/AQAAAAAAAABqsieknswHFADfGacBAACgsCMNwBWSBZKYeVV4/h7J9lxq/AWAfMzdAAAAY1l3AQAAFVnrAAAAzGH9BQB88mf1D2goc0CWrUE1k0zXNvMzDAAAAAAAAAAAAABXsKcWAAAY6sgJwLBK1UWy5l8AAAAAgPzkTwEAgMqseWrJtF8JAAAAZpH/gDza5Lc6ngDc5uZebPV1qzqJrr6ur6p6/QEAAAAAACC6V2qK6nkAAAAAUMN9y9NnAAAMtrcBWNHwHNfvmKrXLUNQXvXaAwAAAABcSS4VgN/MqAuO+nuY4wD4yCb0Wm6buR6qMD7DGuZRAABguI4nAEMEGZJtEhMAAAAAAM/JpQLwLkMNcC+nDwPwlSYzAACA8ay9YD65biCkbg3AAqBjVl63ihNo9Oew4jUHAAAAAACAq0Sv98326HqoOwJAfE4BBoBjzJ8AALBOq1rdngZgC5VzXD+2Lf4A4zkFAAAAAHidnCpALdFredn8dD3NnQA1OIkKIB5jMwDUY34HANqdAMx+Tv+9TvTgu9r1BgC+ix6PAAAAZCKnCpCbXNkaX6+7+RQgLxvRAQAAgCrkqoGw3lb/gIk0srJS9IKHZxQAAAAA4HVyqgB53bb4tbtObpt7ApCZtVEN5mEA2EcMBAAA67TLZb16ArCFSk+apq8RfWCpdK0BAAAAAADgJ9Frdny+R2qYAAAAAAAAtPdqAzDHKUz2Fn0jgecTAAAAAGAfeVWAPKLX6njs670z/wLEdd/MuQAAAKNYcwFAc10agAU8uSjezuE6A0AvYmIAAAAAKpP/qk1DMACMddvMrwAAAAAQTpcGYPZTID8v8jWUsAcAAAAA2E9uFWCtyPU35vr4LJifAdZzIhVADMZjAAAAKmu55tUAPJZCY1+RBxTPJQAAAAAAABlErrkRh9OBAWLQdAYAAABkJKcMhPZKA7CBjJk8b2O5vgAAAAAAx8ivAoynaYgrOB0YYB1NwABAddaZAADAVB1OAJZU3s81Oyfq9ZN0AIC+osYnAAAAACB3xUjvz5daKQA8d9vMmQAAAAAQytvqH1CYZOh+Fa5Z1A0KFa4tAAAAAMAqcqwA17ttcWtr1ON5A5jH+gkAAOBa1lkA0FiHE4ChOwE/AAAAAAAAEWjAZDUnAgPMcd/M+wAAAADAddrmG5+dAKzo1U/bl+ECEa+ddxgAiBijAAAAZCLPCnCe01eJxjMJAEBVclkwjvcLAOoxvwPhPWsAzk7BLg+T5vVcUwAAAAAAAFbSZEl0nk+AcexbAQAAAAA4qXoD8CoS2P1EKwx7BgEAAAAAzpNrBTguWv0MHtGoDgD/mBMB4GdyxcBqxiEAaOrPL/+dAIFZsj9r0RLf2a8nAHCdaHEKAABAJnKtAMfISZHVx2dXHABwjfsmNgAAAABikgcGUvitATg7yeP9XLP8BCAAwDuxHQAAAACzyEVRzddnWh0W4DhNwADzGXvhWtaEAACwVus17qMGYAuV41y7XiINIJ49AAAAAIBryLcCPBepTgajOR0YgE5um/kOAAAi8pEPuI51L5BG1ROABTV5ZJ40Iz1nma8jAHC9SHEKAABANvKtAI/JO4FmYIAjbFIHmM/YC9ew7gMAAJZ6++E/s1A5LvO1W5Hocb2ukfk6AgDXixSnAAAAZCPfCvDd7cMf4DPvB8DrrLdyMbcBAEBM1lZwnvcISOXrCcAVBjHJRzqp8M4CANcRCwMAABwn3wrwmVwT7PP+zogpAAAAarC+AwAAlvt4ArBFCjNlft6ibHbIfA0BgOtFiVEAAAAAyMtppnCedwjgMXtdAOYy7gJATeZ4ADppX3N5e/4/SaX9DQUAoCVxMAAAwDk2SgDIMcHVNAIDkJ15DAAAgGrUhYF03huADWDnZb6GkrWvi3KtMj9vAMC1osQnAAAAAOSkSRHG8o4BfGbPCwAAAADAi/6s/gG0JJHPCs+K6p5LALKxYQwAAACAs+SYYJ7bpiYJAACQhfUbAAAQwp/NAgWy8c7u8+rGlZ/+d641ABHZlAkAAHAteUCgIzkmWEMTMMBf9008AgAAcIZ1FQA04QRgZstczBQg53LF/XJqMABRiEMAAAAAuII8E6z3/h6qNQKQgY9XQH6agwAAACAxDcBI7FDNzGd69fujwAJQ2+p5BgAAAIA65JogHg1VQHca0gAAAAAAntAADLkoAP+sa0Go6z93Fl/f11c3ccza7OH5oYqP78tVpyZ4PwAAAPqQcwWqk+uC2D6+o+ISAACAGKzPAACAMCo1ACteM5LnKxb3gwx+ek5ffXY94/C6M+8aAAAAAFQlRwb5XPWRS4BMnAIMAABwnDUV7CP3CqRUqQEYqusebFicAAAAAABX6p5zBWpST4H8NAIDAAAAAACwbdu2va3+AbSiQMkRt81mFQAAAADgWvLVQDXqKVCP9xrowvoMYDxjLQAAABmpk2xOAO7OS5BHxwSc5xMAAAAAAOB36ilQnxOBAVjttpmHAAAAAGAJJwBDfB0T6DarAAAAAACjdMy5AjWpp0AvTgQGKrNOAwCiEJcAAAChaAC+hsVebYqoc7neAAAAAMAo8vlAFeop0Jf3HwAAAIB3al8AUJwGYGYRWB7T7bopVgMAAAAAADzmBFBg24wFAMxn3gGgg257dgEAgAQ0AENc3RIJCgUAAAAAwEjdcq5APWopwFfGBaASazaAsYyzAFCXeR6e855APmog/9EA3JeX4DWu03i+Tg0AAAAAAPA7tRTgEeMDAAAAAABAURqAmcGXMvbrcs0UowEAAACAGbrkXIGa1FOAZ3x0GajC2i02cw0AlYlDAACAkKo0AK9MLlrw1SVpPZbrCwAAAAAA8Dv1FGAPjcAAAPzGflcAqMs8DwBFVWkAhko6BN+KzgAAAADALB1yrkBN6inAURqBgcys4QCA2cQfAAAQixrHBxqAgdkMwgAAAAAAAI9p3AOuYjwB4GrmFQAAiMsHDeBn3g0gNQ3APc1MxGadKFclq7Ner1cpAgAAAAAAADymlgKMoBEYAIB31fcoAgAAQCkagIFZFJQBAAAAgNlsaAQyUUsBRtMIDGRhLQcAzCLuAACAWNQxvtAADHFUTiIYfAEAAAAAAB5TSwFmMuYAcIZ5BAAAAAAm0QAM30lSX8v1BAAA+Jn1EgAA4DROYBXjDxBd5Q/pA6xmjAWAuszz8Jl3AkhPAzAwkoIxAAAAALCKYi4QnToKEIGxCIAjzB8AAAAAXE3O6QcagM+xeeh3rs/rKl4rgy4AAAAAAMDP1FGASIxJAABARxX37gJsm/ENAErRAAyfKWyed9tcRwAAAABgLRsbgMjUUYCIjE1ARNZ2AAAAAEBrFRqAFaEAAAAAAACADNQ2gciMUQDsYd6A3HxkAQCA6sS8kItc0wMVGoDZx8sQT6WgwvMFAAAAAKxWKecK1KKOAmRgrAKiscYDAAAAANrSAAz/KGSe4/oBAAAAAAD8TB0FyMSYBQAAVOcjI0B1xjkAKEIDMAAAAAAAUIXNDEBEGumAjG6b8QuIw1oPYAzjKwAAABGoR/xCAzBwBQMtAAAAAADAd2ooQHbGMQB+Y54AAAAgIh+7AcrQAAycJZEPAAAAAESgiAtEo4YCVGE8AyKw5gMAANjHOgoACtAAzCiCxde4TgAAAAAAAPVolgOquW3GNgAAAAAAgKk0AMNfCpXHuG4AAAAAQAQ+tghEon4CVGaMA1ay9ovJ3AC5GVvpyHMPALWZ6yEXuaUnNAADAADkITEFAADfiZOBSBSogQ6MdQAAAAA5qKMBQHIagI8TCNGdoi4AAAAAAMA/aidAJ8Y8AAAAAACAwTQAAwAAAAAAWflYJxCFRjigo9tm/APmsw4EAADYxzqKTjzvQDkagGEdgQUAAAAAAEB+mt+A7oyDAJgLIDd7GenE8w4AAHHIKb3gz+ofwFReCq7iWQIAAAAAVrNRC1hNvQQAAAAAAACAYZwADDZnAAAAAAAAsI/6EsBnxkUAAAAAAICLaQAG9lK4BQAAAAAAOlMrAfiZ8RGY5b76B/Aj8wAAAMRlHUUHnnOgJA3AAAAAedg4AQAAfyneAqtYmwP8zjgJAJCTfBsdeM4BACAO9YQXaQAG9jC4AgCspRgFAAAA66iTALzGeAkAAAAQj71nAJBQ9gZgRSOyEjwDAAAAAADkoS4JsI9xE6An4z8AAAAr6NEBysreAAwAAACQlcQzABxjDgVm08QAcIzxExjJ2hAA2EPsAAAApKQBGHiV4iwAAAAAANCN+ggAAABdaJAEgPrM91TkuYZ81GB30ADchxcDAAAAAAAAXqe+BnCesRSgH2M/ANFoCgIAANLSAAwAAAAAAGRhoxYwi6YFgOsYUwEAAAAAgG1TM9hNAzAAAAAAAADAP4rOANcztgIj+EgUAPCMeAHgO2MjlXiegfI0AAOvUIwFAAAAAAA6UBMBGMcYCwAQnwYKAAAACEQDMAAAAAAAkIHNh8BoGtMAxjPWAvRgvAcgAjllgMeMkQCQhAZgAAAAAAAAoDsNCgAAOdm0DnA9YysAABmIWyEfNdkDNAADAAAAAADRKd4CIyk0A8xl3AXowXgPAAAAACdpAO5BMvWxFdfGRjUAAAAAAIAY1NEA1jD+AgAAI9mrC/CcsRKAmdQFDtIADDxjgAUAAAAAACpSAwFYyzgMXMWmdYDrGVsBAIhMvAq0oQEYAAAAAACITPEWAKAuTcAAAAAAAFCbWsAJGoDpzsYxAAAAAACAfhSZAeIwJgPUZYwHYAV7gwFeZ8wEgOA0AAMAAAAAAFHZdACMoAkBIB5jM3CW9SMAAAAAUI4GYAAAAAAAAKALDWYAcRmjAQAAAIBnfAQMaEUDMAAAAAAAANCBxjKA+IzVwBk2AANcy7gKAADAWfL+J2kABn5jkAUAAAAAACpQ8wAAAAAAAAAgFQ3AAAAAAABARE4YAa5w2zT/AmRj3AaoxbgOwEzyygD7GTsBIDANwAAAAAAAAEBFGg0A8jKGA0fZuA4AAAAAMcj1X0ADMAAAAAAAAFCNYjIAAAAAAAAAqWkABgAAAAAAonFiE3CG5l+AGoznAAAAAMBH6shAOxqAjzFhAAAAAAAAAAAAxGNvVzw+6gB5GVMBoAdzPgAEpQEYeETiHQAAAABYwQYD4Az1DYBajOsAAAAAAJCP/P5FNAADAAAAAAAAFSgiAwAAAPTl45IA5xhHic4zCrSkAZjubAQBAAAAAAAAgLjU9YEjbAqOx3gOAAAAADtpAAYAAAAAAKKwQRs4SjMBAAAAjCFnBwB9mPeJyrMJuajdXkgDMAAAAAAAAJCZAjJAfcZ64Aibg+MxngMAAADADhqAAQAAAACACGzMBo7QQADQhzEfAAB4RH4Z4DrGVKLxTEIucvkX0wAM/MRgCwAAAAAAAEA0atkA+RnLISdNFwAAALCABmCYSxIMAAAAAADgGhoHAHq6beYA4HX26gAAAOxnLUUUnkXIRe5+AA3AAAAAAADAagq3wF6KxwAAkJd4HoAryS8DAABlZW8AtmADAAAAAACAXjQLALBt5gMAAACAkfTrALCHnP0g2RuAAQAAAAAAgD4UjgH4yLwAAAAAAACUpQEYAAAAAABYydfDAQAAACA+eTwi8lwCQF3meYBNAzAAAAAAAACQg1MeAQA4wobhmMT3AAAAAPCEBmAAAAAAAAAgOs0BADxijgAAAAAAgHXk6QfSAAwAAAAAAABEpmAMAAAAAADz3Vf/AADoTgMwAAAAAACwik0DAAAAAAAcIb8MAHWZ5wH+owEYAAAAAAAAiMrpvwC8wnwBADCHRgwAAACYKHsDsAIOAAAAAAAA1KQWCAAAAMBPNKMDAAAtZG8ABgAAAAAAcrJBCwCAK/lwBAAAAADkp44M8IEGYAAAAAAAACAaTVwAAFzJ5uGYxP0AABCf9RQALKQBGAAAAAAAAIhEEwAAR5lDAACgPo1oAAAQh7z8YBqAAQAAAACA2WzQAgAAAICc5PYAABhFrAnwhQbg+nTRAwAAAAAAkIXaFgBnmUsAAAAArqUpEwAW0QAMAAAAAAAARKBhC4CrmFOAn9iwHpMxG4A9zOcAUJd5HuAHGoABAAAAAICZFG6Bn9j0D8DVzC0AAOPI8QEAACAPP4EGYAAAAAAAAAAAADrQsAYAAHCM9RQALKABGAAAAAAAAFjJl6EBGMUcA5CD8RqAV2g8A4C6zPOQj3zOJBqAAQAAAACAWRRuga8UhgEYzVwDAAAAAACkpAEYAAAAAAAAAACALnycKiYfbIB8jKcA0I/5HwAm0wAMAAAAAAAArGCDPwCzmHMAAAAAAIB0NAADAAAAAAAAs2nEAgAAAOBVTpwEgLrM85CPWu9EGoABAAAAAIAZFG4BAFjJhiTgI2vUmIzVkI/xFAD6Mf8DwEQagAEAAAAAAICZbOoHAAAAAAAAgCc0AAMAAAAAAAAA0IGPUADEZ6wG4CsnTQLEY2zmKp4lyEfuZjINwAAAAAAAAMAsCsIAAERhkzEAAAAAEJoGYAAAAAAAYDSbqgEAAIBX+XAQ5CL3BwAAAINoAAYAAAAAAABmsIkfgAjMRwAAkIcGc4C4jNEAMIEGYAAAAAAAAAAAAAAAAAAAHvGBzQU0AAMAAAAAAACjKQYDEIl5CXjnxCoAAABYw5oc4AUagAEAAAAAgJEUbgEAAIC9fKwBcpEDZATPFUB8xmoAGEwDMAAAAAAAADCSjfsARGR+AgAAAAAAQtMADAAAAAAAAAAAAABAFE6UBAAA2DQAAwAAAAAAAOM4XRGAyMxTwLZpMIrMOA0AAFCTtTjAizQAA19JnAMAAAAAV1G4BQAAAIAe5AK5imcJIBfjNkAP+s0W0QAMAAAAAAAAjKAIDEAG5isAAAAAACAkDcDAV77AAwAAAAAAAAAAROBDDQC92MMKAADwgQZg4CtJcwAAAAAA4Cz1BgAyMW8BAAAAAADhaAAGAAAAAAAAAACgM6cNAgAAwBzW4AA7aAAGAAAAAABGULiFvpyiCEBG5i+AuIzRkIecIGd4fgDyMoYDwCAagAEAAAAAAAAAAAAAAAAA+MrH2RbSAAwAAAAAAABcRfEXAAAAAAAAAC6gARgAAAAAAAAAAHzIArq7r/4BANCYeRgAejDnA+ykARgAAAAAAAC4gqYpAABgFOsNyENTBwAAAFxEAzAAAAAAAHA1m/wAAMhKgxkAAADAfuqDPOMZAThAAzAAAAAAAABwlmYpAAAAAI7QDAQAAHGpAy+mARgAAAAAAAAAAAA0IEVnwykAAAAArWgABgAAAAAAAM6wCR+AasxtAADn+KACAAAAXEADMAAAAAAAAAAAAAAAAHCGj4DwiGcDcvKxzAA0AAMAAAAAAAAAAAAZ2HgKUItmIAAAgF9oAAYAAAAAAK5kwxb0YvM9AFWZ46Av61oAAAAAIAQNwAAAAAAAAAAAAADAlXxQgWc8IwA1Gd/5yjMBcIIGYAAAAAAAAAAA+M4pwAAxGZ8BAAAAxpJ/CUIDMAAAAAAAAHCEoi8AAFU5nQgAxjLXAgAAvEADMAAAAAAAAAAAAABwNU2eANCTGIB3ngXIyYegA9EADAAAAAAAXEUBF/pQ9AWgC3MeQEzGZ4C85JEBAABepAEYAAAAAAAAAAAAAAAAAAAC0QAMAAAAAAAA7OGkLQAAOnA6IQAAAACwlAZgAAAAAAAAAAB4zMcvAADgGj6wAdCHMR8gJ/nwYDQAAwAAAAAAAAAAAAAjaP4BAOhJHAhwAQ3AAAAAAAAAwKt88RmArsyBAPEYmwFy0QQEAACwkwZgAAAAAAAAAAAAAAAAAAAIRAMwAAAAAABwBac3QH1O1wIAAAAAAACoST04IA3AAAAAAAAAAADwnM1PAAAAAADANBqAAQAAAAAAAAAA4Lv76h8AUITxFM8AQE/GfwA4SQNwbb48CwAAAAAAwBXUnQAAgIisVQAAAAAoSwMw8JWv7AAAAAAAAADAzzSaAQAAAAAAU2gABgAAAAAAAAAAAABgBAfTAPRmHujJfQe4iAZgAAAAAADgLAVcAAAAAOA3cogAAABx3Vb/AH6mAXg/CQg68JwDAAAAAADvFHsBAOjMPpr4rFkAACA26yoAOEgDMAAAAAAAAAAAvE6jGQAAAAAAMJwGYOARX9kBAAAAAAAAAAAArmJfYj/uOQDvzAl9uNeQj49eBqYBmBFM1nW4lwAAAADAM/KIUJtiLwAAkIG1CwAAxKeuCAA7aQAGnhFkAwAAAAAAAMBnGs2gF/tnAGA/8ycAAMBJGoDpTnLhNa4TAAAAAAAAAAAAcJb9iADQm1gAIBYfuwwucwOwhwvmum+CbQAAAAAAAAAAICZ7CgEAANbScwJwsT+rfwCQzntAtiJhLhjkN4o49XjnGcFYAQAAAPA6uRQA+N1tU9MCAAAAAAAG0QAMHPWxiLlnA5DiJ6N4toBXjB4rbIoFAAC6kZMBAAAAAOAruWMAAIjP3vcENAADV5CoAYC/3udEiyEAAAAAAACo5b6pAwJcxZgKAL2JBQDgRW+rfwAAABR033wgAwAAAAAAAGA2TQQAAAAAlKEBGAAAxtEEDAAAAGRl0zwAvMacCQAAAAD2zAIMoQEYAADGktAAAAAAAAAAAKALe2UAeIX5AgBeoAEYAAAAAAAAAAAAAAAAAAAC0QAMAADj+VIdAAAAAAAAAMA/9lIAAOIBAHhCAzAAAMwhUQUAAABkcVv9AwAgGXMnQCzGZYB17I8BgJ7EAACDaAAGAAAAAAAAAAAAAAAAZtM4CrCGD6gloQEYAAAAAAAAAAAAAAAAAAAC0QAMAADz+FIdAAAAAAAAAMBf9lEAANsmJsjO/QMYSAMwAAAAAAAAAACcc1v9AwD4xLgMMJ/mHwAAgItpAGYEyVMAAAAAAICc1HkAAAAAAAAA6lITTkQDMAAAAAAAcITTHAAAAOjGWjgXm1khB2NrDe4jAGeZS3Jy3wAG0wAMAAAAAAAAAADnaTQDAAAAAAAuowEYAAAAAAAA2DZNSwAAAAAAwDpOk83F/YKc1IST0QAMAAAAAAAAAAAAVGRTK+SgeSQ39w8AAGAQDcAAAAAAAAAAAHANjWYAAAAAVOcDIJCT/HVCGoABAAAAAAAAAAAAgJU0kQAA2yYmAIBPNADTnS8XAAAAAAAAqJkAAAAAAAAAQCgagAEAAAAAAAAAAOA1TqPKxwePAMYxLwJAP+Z/yEl+JCkNwAAAAAAAwF6KugAA8JiNVAAAx8g7AgDbJiYAgP/TAAwAAAAAAAAAAAAAAAAAAIFoAAYAAAAAAIDenFIIAAAAAAAAUJN6cGIagAEAAAAAAAAAAAAA2OO++gcAANOZ/wEm0wAMAAAAAAAAAADXcqICQCzGZchDUwkAsG1iAgDYtk0DMAAAAAAAAAAAAAAAAABANT6KlpwGYAAAAAAAAAAAAHidk6gAAAAAgOE0AAMAAAAAAEBfvvgMAAAAAADAMz6GBbCABmAAAAAAAGAPhV0AAAAAYCQ5yPjcIwBmMN8AnONj0AVoAIa5DJwAAAAAAAAA0IM9AgAAAAAAwGEagAEAAAAAAAAAAAAAAAAAIBANwAAAAAAAAAAAAAAAAEA099U/ACCp2+ofwDU0AAMAAAAAAEBPir4AAEAn1kCQi2afuNwbAOjH/A+wiAZgmE8iGQAAAAAAAAAAcrP5GQAAYA7rLwDa0gAMAAAAAAAAAABj+Eg4AAAAAABwiAZgWEOBDwAAAAAAAAAAAAAAAAD4kQZgWEcTMAAAAAAAAAAAwDz2bEEu99U/gG/cEwBWMQet49pDPvIfhWgABgCAeSymAAAAAAAAAAAAAACApzQAw1qagAAAAACATHzdGQAAAAAAAAAAJtAADOtpAgaAHsz5AAAAQCRyFQAwj3kXAAAA4DwfKwagHQ3AEINiHwDUZq4HAAAAAAAAANhPo08c7gUA9GP+h3zsWy9GAzDEYYAFgJrM8QAAAAAAAFCTjdA5qeECAAAAkIIGYIjltkkwA0Al5nUAAAAAAAAAgHN8cGE99wCAKMxJ87jWAAH8Wf0DgB99bBb6LWh61FQk0AKA9TT/AgAAAAAAAAAAAAAwg/3rBWkAhviODL5HB+z7f/9fDcQAXK3T/GLhBAAAAAAAABBbpxo2AAAAAElpAAY+un3519X2JNmj/ObfKBoAV8sw9n00+/fuHXezXU8AAAAAACAPjWYAAOe8H3DCfOJYAKIRF4xn/gcIQgMwEFm1oLzaPw9AdMZdAAAAAAAAAAAAAACqs3e+qLfVPwAAAAAAAAAAAABgMhtjAQAAAAhNAzAAAAAAAAAAAAAAEN199Q9oyDUHICpz1DiuLUAgGoABAAAAAACgF6dcAQAAAAAAANSg/luYBmAAAAAAAAAAAACgIxtkAR5z+h8A9GP+BwhGAzAAAAAAAAAAAAAAkIGmFADgnbgAwMfNytMADAAAAAAAAAAA49mIBRCT8RngOw1VAAAAAWgABgAAAAAAAAAAgGM0SAEAAFCB9S1AQBqAAQAAAAAAAAAAAIAsNKeM5foCkIl5C4DSNAADAAAAAAAAAAAAAAAAAORxW/0DGE8DMJ0Z5AAAAAAAAAAAAAAAAACAcP6s/gEAAAAAAAAAAAAAC922bbuv/hEAQDlfD6wSbwAAsIsTgOtyui0AAAAAAAAAAAAAAMz3035+e/xhDM3157mGAEFpAAYAAAAAAAAAAAAAQPMPXOO3Rl9NwAAAvEwDMAAAAAAAAAAAAAAAwHmvNPhqAgYAzhJPNKEBGAAAAAAAAAAAAADIxEm1QEQacWAdsQEAJWkABgAAAAAAAAAAAAAAmEezMAAAT2kABgAAAAAAAAAAALrThAN05+REmE/8AQDArzQAAwAAAAAAAAAAAAAAAPTjIyAAgWkApjNBCgAAAAAAAAAAAAAAZznNF9bTIwJ0Ie5oRAMwAABAHhbsAACspGAONVhbAgAAAFXIWV7HtQQAAAhIAzDdSVgAAAAAAAAAAACwbT6aBAAA2ekRAaAUDcAAAAAAAAAAAAAAAD1plIK1fIAEWEkcABCcBmD4G7AIWgAAAAAAAAAAAADoxP5ZuIYmXgBgFnFHMxqA67Ig308jMAAAAAAAAAAAQG820kIu9n0CAF+JD17jOgEk8Gf1D4CAPgYxkrnAFSyOIK4zc/3Xd1vcAAAAAAAAAABAFva1AQBALvarN6QBGH73KLmRbcCUpAGAn105R/qICAAAAAAAAEANt82eK6A2Yxxcx14xiOm+eT9/IxYASEIDMBwj2AEAfvMeK0geAQAAAAAAAACMpcEHyM7HRwAA+NHb6h8AAACFScoCAAAAAAAAAAAAAAC7aQAGAICxNAED8IivkAOQibUNAAAAAEAN8r0A0JtYAHKy37ApDcB1eakBAOKQLAEAAAAAAADIxR48AAAAAJbSAAwAAAAAAAAAAAAAZObj7MAKPhgCsYkPAEgvcwOwiRgAgEzErwAAQGY2sAAAAAAAAIyjFgMAwDeZG4BXBLiaNgAAAAAAAAAAAACAjOyFBoDexAIAyWRuAAYAgGwkTgAAAAAAAAAAAAAAeNWKg1QJQgMwI2hsAQAAAAAAAAAAIDsbbAGAmcQeAAB8ogGYESw8AAAA4Dkf0AIAAAAAAACAnOyZBwBgOA3AjGADMwDAY2IlAAAAAAAAAIDr2ZPxO9cHAHoTCwAkpAEYAAAAAAAAAAAAAABgPScLw7U0vQKQmgZgAAAAAAAAAAAAgJ9pwgEAAABWkZdoTgMwAAAAAAAAAAAAAEBdTj8EAABISAMwAAAAAAAAAAAAAFCBRldghtEn8TnpD64lPnANANLSAAwAAAAAAAAAAADwmCYcIDMNPwAAAElpAAYAAAAAAAAAAAAAAIjDB0gAAPEAGoAZwuACAAAAAAAAAAAAwApOvAVGslceyEZsBJCYBmAAAAAAAAAAAACA32n2ATLS8AMAf5kTAUhJAzAAAAAAAAAAAAAAAAAAQAw+RMa2bRqAAQBgNosxAAAAAAAAAICxnPIHVGCvGQBAcxqA65K4AAAAAADgSjaZAAAAwHfWy72430Am9hLD9cQCkFvHubHjPzNAKRqAAQAAAAAAAAAAAAAAAAAgEA3Adfm6EAAAAAAAAAAAAAAA5KUvAAD6Mf/zfxqA67qv/gEAAAAAAAAAAABQjE24kEfnvbSd/9kB4Ded5shO/6wAZWkABgAAAAAAAAAAAAAAeMxHQAAAmE4DMAAAAAAAAAAAAAAAQEyajwGgD/M+n2gABuB/7d3ZkvM4jgZQ+Y98/1d2X2S5c/MiyVwA8JyIieiLnhlVlkWCJD4RAAAAAAAAAADYTzMu5HGd/QATrPjPDAAAUJIAMAAAAAAAAAAAAAAAwH0+/gG1+FgGAGkIAAMAAAAAAAAAAAAAAMQlhAwcIeQMUIQAMAAAAAAAAAAAAAAAAADAPD74wR8CwAAAAAAAALAOX3wHAABoQ1MuEJG9H2jPnA8AwDQCwAAAAAAAwF6aXAAA4DxhDACAOdRhQBXOaaAd9QEAKQgAAwAAAAAAAAAAAAAA/CRwC2Qk3Aw5qTu4SwCYXgw6AAAAAAAAAAAAVKZPDohE2AfWoP4AAFiIADAAAAAAAAAAAAAAAAAAAAQiAAwAAOP4+iIAAAAAAAAAwHhuxwWO0usF9VWsDyr+M8EK1B08JAAMAAAAAAAAa9H8AQAAAFCL/R5Yi5AQAMAiBIDrilDUR3gGAIAo1EYAAAAAAABQizNAts3vAAAqMr8DABCCAHBdvuQFABCHDWEAAAAAAAAAAAAAAGA3AeC6ooRMojwHAMAs6iEAAAAAAAAAgPlcrgNUoi8N+E2tAzmZ03nqY/YDAADww+8C3mI8NwsyAAAAAAAAAAB60l8Eben5grVcN+89AIEJADPCZbO5QHu3Ivvsb0uRDmRhvGprRE3i3xkAAFCdPV8AAACAn+yXAAAAANCcADCjRNzgzBTOefS3y/TP0Iu/AQBHmDcAAAAAPvmiPQCMFa1nAgBgVfZEAACAKKxNeClzANgCPJ93b2x99H9vBSv9swIAAAAAAAAAAADwmg/NQFvZerYjXtIFGVXIJxkLAIrKHAAmrzNB4OzFFAAAAAAAAAAAAHUJ4EAeFUI+AAAALEAAmJlsngAAAAAAAAAAAAAAAACwErk6dvk3+wEAAAAAAACAKdxMBQAAAJCXvR0AaCfzvJr52QF4QQAYAAAAAAAAAAAAAFiJoAxQhdsDAQAKEwAGAAAAAAAAAIB+hEsA1iGAA4yixoT2zOMAAIQjAAwAAAAAAAAAAAAArEaIFgAAmMGHR9hNABgAAAAAAAAAAAAAIAfBZQDoI+Mcm/GZAThAABgAAAAAAADWpTEEAAAAACA3twgCABQlAAwAAAAAAAAAAADQhgAO5OLjaMC2mb+BL2oDoDd1B4cIAAMAAAAAAEc5kAIAgH00jQIA0JL6EgC4URcALEAAGAAAAAAAAAAAAAAAIC8fbwUAKEgAGAAAAAAAANbmC/EAAABtCeBALln2RrI8JwBkZ84FIAwBYAAAAAAAAAAAAAAAYEU+3AEAjKLu4DABYAAAAAAAAAAAAAAAAIAc3FIMsAgBYAAAAAAAAAAAAIC23OoDAAAAwFsEgAEAAAAAAAAAAAAAAHLzARJoxw27AIQgAAwAAAAAAAAAAAAArEzIB9YkMAsAQGgCwAAAAAAAAAAAAAAAcQkoAwBAbj48wikCwAAAAAAAAAAAAADtae4FAAAA4DQBYAAAAAAAAMAtMgAAAAAA+fkACdTnTAdgIQLAAAAAAAAAAADQnmZMAACAuARlgVfs7QAwnQAwAAAAAAAAAAAAAEBMwkcAAACLEgAGAAAAAAAAAACAY9wYx15+K5CHoC0AANCDvQFOEwCuyyYEAAAAAAAAAAAAAACsRcgI2omWzYn2PAB09jH7AehG0Z7D9+LrsinGYEW3d//VuL3nv0MOe8b6PXOCeWM/7w4AAAAAADCacxwAAIC49JQBAJBC9uDI6MI7298q68Ik298ZAGDb8tZe5KNehlrMHwBkpz6FWtSnANCOWhnqUz9zlLkB8og0xhs7oI9I73lPxhBoI8qY4Z2GnKKMISTlBmBmU4AAAFU8qmss2gAAAAAAAAAAAGLQzwUcdd2MHQBM8m/2A7Cs6yb8CwCsQd0DAAAAZGEPAwDaMKcCANCCuhIAuFEXACxKAJjRBGAAgFWpgwAAAAAAAADW5cYwyEN/B1CF+gPaUR8AZ5iLeZsAMAAAjGUTCAAAAAAAAACAZ/SXQB9COEBG6gKAhQkAM5KiAwDgk7oIAACoQqMMAAD85AwAgGfspUAe6joAAACmEwBmFBshAAAAAAAA8TnTAQAAAJjL/gzQkg+QAMAc5mCaEAAGAIA5HNYAAAAAAAAArEcDMAAAAAC7CAAzgnALAAAAAAAAAAAAAJnof4VafIQDeNeM2kA9AjmpO2hGABgAAAAAAAAAAAD208QJAAAAAHQnAAwAAAAAAAB852vyAAAAAHPYlwF68AEbAICkBIABAGAehzYAAEAFmkYAAOCTfX8AAAAAAKAZAWB6c7gFAAAAAAAAAAAAQEb6YKEGHzMFMlKHACAADAAAAAAAAAAAADCQEBIAAADUZM1PUwLAAAAAAAAAwG++Kg8AAAAAUIcwErTh/ASAoQSAAQAAAAAAAAAAAACAigRfAQBISwAYAAAAAAAAAADe4/YXAIC6RtV6akoAAAB+EAAGAAAAAAAAAAAAGMtthADAaOoPyMOHQQDYtk0AGAAAAAAAeJ+GEQAAAAAAIBrnF0APwrnAI2oPmhMApidFDQAAAAAAQF7OegBgH3MmAAAAAADQnAAwAAAAAAAAAAAAAMBjPvoCVOFmQgCARASAAQBgHpupAAAAAAAAkIszPlryewJuBIyhPfMs0FPPuVtdAMD/CQADAAAAAAAtaKQBAGBFGjIBANah9gMAAB7RM0EXAsAAAAAAAADAIxpbAQAAAIBsBHCe8/eBNpyhANCdADAAAAAAAAAAABynyROAFgRwAHUlAHCjLgDgBwFgAAAAAAAAAAAAAACgAh/XAABGU3/QjQAwAAAAAAAAAAAAAMBrbuUDqhBUgjbUBgB0JQAMAAAAAAC0olkEatK8AgAAn6x76cVvCwAAAIA/BIABAAAAAAAAAOAYH8gAAKAFdSW05aMaQGbqAgD+EAAGAAAAAAAAAAAAAABYi8A0ALzPfEpXAsAAAAAAAADAK746DwAA0JeGYcjDPgkA8J3aAIBuBIABAAAAAICWNKsCAFCdpk4AAIB4nE+c4+8GABCYADAAAAAAAACwh7ATAAArE4wAoDV7LQDAjboAgLsEgAEAAAAAAAAAAADmEzQHAICcBHhhTdbxdCcADAAAAAAAAAAAAAAAZCV88x5/PwCAoASAAQAAAAAAgL18wR6A1ZkLAQDYNnUhAAAAAwgAAwDAHL6aCAAAVGbNAwAAAHCOfRVYgwAxAHCjLoCcrN8ZQgAYAAAAAAAAOEIjCgAAAAAAAAB0JgAMAAAAAAAAAACv+QgGrMuNLgAAcanV2vB3hPfZOwKgOQFgAAAYz2YpAAAAkJ0mFgAAgH6cKUMOZ/dH7KsAAEBu1u0MIwAMAAAAAAAAAAAAAAAAMJYPgwDwlAAwAACM5YtPAADAKqx/oD5NKQAAAAAAdTjbAQAIRgAYAADGsUEKAAAAAAA5+fAFAAAtqCuhLf1YQDTmeqhP/cFQAsAAADCGxR4AAAAAAADk45yPWfz2IAchHwDgLHUEAC8JAAMAQH8OZgEAAICqNKcAAAAA7GMfBQAAgEM+Zj8ALOJZ6MeGDgDUJfgLAAAAAAD5OdcHAOCZ66ZHBGbw3vVx2ayD4V17agPvGeSk/mA4AWA4r9WgnX3wV3gCnPNskyz73HCz8hxR5d8hAAAAAAAAAAAAAAAwgQAwHCPM85e/CeS2akAzytgV5Tl6ifTPt/e3HumZAQAAKvCVeFiDW24AqEw9C8BM9lYgj1f7I95lAFjLs9pAXQDAbgLA8JqGFaAyYxyr8FsHAAAAAAAAjnLOCMARj4I+Qj5ANj5CAm3cqw28WwAcIgAMz9nEBwAAAAAAeM0twAAAAABfoR7hOejLXiSQhXoA6lB/MMW/2Q8AgRmYAQAAAAAAAGBdGjQBiEAfG+SklgQAAOBtAsBwn01TAAAAAAAAAABYl/4hAICY1GkAACxDABgAAAAAAOhJIw6sw802AFRiXgMAAGBlzncA4It5kWkEgOEvgzIAAAAAAAAAAAAAAAAAMI0AMAAAAAAAANCK2xIBqMB8BkA0LrUAgE/mRAAAliIADD9ZFAIAAAAAAAAAwNr0EAEAgLoYAGA6AWAAAAAAAKA3DSKwFrcmApCZeQwAAAAAgBv9DkwlAAwAAAAAAAAAAAAAAEQmfAMAwHIEgOGLRSEAAAAAAEAbbk8EICPzF7BteoiIy28TAJhBDQIAMJEAMAAAAAAAANCDEBUAAAAAAAAAnCQADAAAAAAAjOAL8QAARObDFQAAAHE5Y5jL3x+AVZkDmU4AGD4ZkAEAAAAAANoTpgIAAGhHnxsAAADAQgSAAQAAAAAAgJ6EgAEAyEK4EgAgHjUaAADLEgAGAAAAAAAAAAAAAADgEUFsAFZj7iMEAWAAAAAAAGAUB2SwLrcAAwAAAAAAAMABAsAAAAAAAAAAAKzMhyoAyMQH1gAAAAAWIQAMAAAAAAAAjCBcBQBAZEKVAADwnJoZAGAwAWAAAAAAAAAAAAAAAAAAAB+9IBABYAAAAAAAAAAAAAAAAAAACEQAGHyVAQAAAAAAYJTr7AcAAAAAANLQ5x2PfycAAAMJAAMAAAAAACNpDAEAAAB4j/0VAAAA6MOam1AEgAEAAAAAAICR3AIMQCTmJWDbNHYCAAAAAAF9zH4AynJABqwu+jjo8BIAAAAAAAAAAAAAAOCTnAXhCABDHrcwocmkreghTejFbz+nUXPA9zln9m/l1T/z9+fr+fd59ncwNwMAAAAcd93sqwAAAAAAZBShtxAAYAkCwBDTswWRxRLAukbPARHmnCPPMOt5H/3/1cAKAAAA8JwQMAAAwHmCNwBUZ+8QAIDlCQBDLDZkAaCOUbcTAwAAZKRBFQCACNSkAAAAAABsm35vgvo3+wGA/3OwCAB1XTdzPQAAAMA99kwAAJhNcyeZ+f0CALOoQwAABhAAhhg0twDAGgSBAQAAAP6yXwLADOYfAACAuIRLAYCR1B6EJQBMLwa+/RwqAsB6zP8AAAD2kYGf7JcAMJJ5B4BK7LEAALOoQwAAOhMABgAAAAAAACIQxgIAYDSBBQCAeNRoAADwHwHgYywmaE0jCwCsSx3AGX43AABUY98dAIDR7LMCUJE9FgBgFnUIANmZywhNABgAAAAAAACIQigLgJ7MMwAAALEJ4AAAwDcCwAAAMI9GIwAAAAAAAAAAADIT3AYgK3MY4QkAAwAAAAAAMzlQA37z0TQAejC/AL9Zj1KN3zQAAABAMQLAMO+Qz+EiAAAAAAAAAPTnfB4AACA+H7MAAIBfBIABAAAAAACAaAS1AAAAAADyEOAGAOhAABgAAAAAAJhNUwgAAL34qAQAAAAAAL/pUyAFAWAAAAAAAAAgIoEtAAB60eAJAAAAAIQnAAwAAAAAAAAAQEU+JgEAAAAAAKQlAAwAAAAAAABEJbgFwFnmEAAAAAAA7rnMfgDYSwAYAAAAAAAAiEyACwCAljR4AgBAH2ptAIDGBIABAGAuDawAAACfNIUAANCKvXcAVmV/BYCszGEAAHCHADAAAAAAAAAQnSAXAHuZMwAAAAAAgBIEgAEAAAAAAIAMBLoAAHiXm+UAAAAA1mZ/iFQEgAEAAAAAgCgctAGvCAED8Ix5AgAAAOZy1gMA0JAAMMzh0BEAAAAAAOAc5ywAAJwhiAAAAACwNvtDpCMATC8aLwAAAAAAAOjFWRQAv5kbAAAAchLEAQCABwSAwaIRAAAAACASe7YAABwl/Au8Yq3JSvzeAYDZ1CMARGR+IiUBYAAAAAAAACAjYS8AAAAAyE0QBwAAnhAArk3TAwAAAAAAGWn4AfZyHgaAuQB4xRoTAADGU4cDEIl5ibQEgAEAAAAAAAAAyEj4FwDu09gMAAAAUIAAMAAAAAAAEJFGVWAv4S8AAAAAyMc5AAAAvCAADAAAAAAAAGQnBAywHmM/sIdQCSvz+wcAZlOPABCB+YjUBIABAAAAAICoHMQBRwiCAazDmA8AAJCb/X8AANhBABgAAAAAAACoQiAMoD5jPQAAAAAAsAQBYAAAAAAAIDK3AAAAcCP8CxxhPQneAwBgPvUIAMAbBIABAGAuG5wAAAAAbQmHAQAAAEBc+qUAgFHUHaQnAAwAAAAAAETnUA44SggYoB5jO3CEdSR88T4AALOpRwAAThIAPsZhEgAAAAAAAORw3ZzvAVRhPAcAAKhBEBQAAA4QAAYHhQAAAAAAGWgKAs5yFgSQm3EcOMr6Ef7yXgAAAAAkJAAMAAAAAAAAVCc8BpCT8RsAAABq8EESAEYz91CCADAAAAAAAJCFAzrgHUJkALkYtwEAAGqxxw8AAAcJAAMAwDw2tQEAAAAAAKAd52/wmPcDAAAAIBkB4Nps2AEAAAAAAMAXt0kC5GC8BgAAgHrkGwAADhIAPiZbwelADAAgrmy1JQAAQBTWU8C7nKEBxGacBs6yXgQAiEutBgAAJwgAH+OQCQAAAAAAAPJz7gcQk/EZAAAAAADgPwLAAAAwni9aAgAAAMwnZAYQi3EZeIfzN9jHuwIAzKYeAWAE8w1lCADTi4ESAOA+dRIAAMD7rK0AAGoR/gUAAKjLnj4AAJz0MfsBgDJmL84dCAOQwez5EgAAAICfrps9G4DZnPUC71LPAQAAAAAlCQAD74h0gLL3WRweAzBDpDkTAACgistmvw9oQwgYYB71HAAAAAAAwAMCwMAZmZtgMj/7GQ7MqWS19zczY88nv1kAAACAPISAAcZzngC0oIaD43xUDYCR1Gvcox4BANhJABg4ykI8F/++gBkijz23TcMzG4iR/7kAAAAAAAAAAAAAAFan55tSBICBI0yCAGR3efCfAQAAAMAtwADjuOUHAAAAAADghX+zHwBIQ8MLAAAAABCNfUugNYE0gP6MtUAr1oQAALGp1wAA4E0CwAAAAAAAAABfrptwGkAvxlcAiEEgCwAAACABAWBgDxu+AAAAAADAaoTUANoyrgIt6WUBAIDc1PQAADsIAAMAAAAAAJlpEAF6ElYDAAAAgOPs3QMAM6hBKEcAGAAAAAAAAOAxIWCA9xlLgZY0cgIAAAAASxAABgAAAAAAAHhOcA3gnOtmDAWAqITpAYDZ1CMAAC8IAAMAAAAAANlpEAFGEGADOMa4CQAAsCZ79gAA0IgAMPCKRTgAAAAAAMAnYTaA19z6C/SkjwUAAACAe+wbUZIAMAAAAAAAAMB+Qm0AjxkjAQAAAAAAGhEABgAAAAAAKvA1X2AkATeAn9z6CwA52U8BoDVzC0f5zQAAPCEADAAAAAAAAHCcoBvAJ+MhMIpgAAAAAAD32DeiLAFgAAAAAACgCod6wGhCb8DqjIMAAADc2KMHAIDGBIABAAAAAAAAzhN+A1Zl/ANGEiaBfrxfAMBs6hEAgAcEgAEAAAAAgEo0iQAzCMEBqzHuASNZ5wEAxKdmAwBmUYdQmgAw8IxJEAAAAAAAYB9hOGAVxjsAAAAAAIABBIABAAAAAIBqfNwQmEUoDqjOOAeMZn0HAABrUPsDANwhAAwAAAAAAADQjnAcUJXxDQDqErgB4B3mEQAA6EQAGAAAAAAAqEjDETDTdROUA2oxpgEzWNcBAAAA8Iz9I8oTAAYAAAAAAADoQ2AOqMBYBgAAAAAAMIEAMAAAAAAAAEA/gnNAZsYwYBa3twAA5KBuAwCAjgSAAQAAAACAqjQeAVEI0AEZGbsAAACAkZzrAAD8IgAMnxxcAgAAAAAA0JPzKCATYxYwk6Z/mMO7BwAAQCbWsSxBABgAAAAAAKjMoR8QiUAdEN11M1YBAACwj/13AADoTAAYAAAAAAAAYBzBOiAq4xMAAAAAAEAgAsAAAAAAAEB1biEAohGyA6IxLgFRWL8BAMDarAkAAL4RAAYAAAAAAAAYT9gOiMJ4BAAAAABAJj4YwTIEgAEAAAAAAADmELoDZjMOAZFo3IT5vIcA7GXOAACAAQSAAQAAAACAFWhGAqISvgNmMf4AAAAAAAAEJgAMAAAAAAAAMJcQHjDSdTPuAAAAcJ4PbtKb3xgAwH8yB4AVdQAAAAAAwBHOFoDIBPKAEYwzQFTWaxCH9xEAAIDIrFtZSuYAMAAAAAAAwFEOA4HoBIGBHowtAAAAtGCPnVH81gAAtm37mP0AAAAAAAAAAPzxPain2Q14h+AvEJ1aBwAAAADgDjcAAwAAAAAAq9FcDmTj5k7gLGMHEJ31GcTk3QTgHvMDADCbeoTlCAADAAAAAAArcjAIZCQIDOxlvAAAAACyc5YDACxPABgAAAAAAAAgF6E+4BljBJCFZn4AgDzUbgAAMIEAMAAAAAAAsCoNS0BmAn7APcYGAAAAAAAqcr7PkgSAAQAAAAAAAHIS9AO+MyYAmWjYhPi8pwDcmBMAAGCSj9kPAAAAAAAAAADAaYK/AAAAAAAABbkBGAAAAAAAWJmbC4DsBP9gbcYAICPrMAAAYC/rBwC2zXzAwgSAAQAAAAAAAHITAIQ1efcBAAAAAAAKEwAGAAAAAABW52vBQAXXTRgQVuJ9BwAAYAT75wAAMJEAMAAAAAAAAEAdgsBQn3ccyEyABHLxzgIAAABM9DH7AQAAAAAAAABo7ntAUNM+1CD4CwAAAAAAsBA3AAMAAAAAAAjHAbW5FRjy8w4DFVh3AQAAAAAc4AZgAAAAAAAAgDXcAoTCN5CH4C8AAAAAACtzrsXS3AAMAAAAAADwycEhsAo3AkMO3lMAAAAA5zcAwMIEgAEAAAAAAADWJFwIMQnpAxVp2AcAyEcNBwAAkwkAAwAAAAAAfNHQBKxG0BBi8T4CFVlnQW7eYQAAAIBJBIABAAAA5tAwAwBxmaeBFQkdwnzeQwAAAAAA+OLsnuUJAAMAAAAAAPzlIBFYkduAYQ7vHlCZtRUAANCCtQUAsCQBYAAAAAAAAAC+E0aEMbxrQHUa9KEO7zPAeoz9AAAQgAAwAAAAAADAfRqcgNUJJ0I/3i2gOuspAAAAAN5hfwk2AWAAAAAAAIBnHCoCCAJDS94nAAAAorMvTlR+mwDAcgSAAQAAAObQ7AsAeWgoAfgkuAjv8f4Aq7CGgpq82wAAAACDfcx+AAAAAAAAAABSuYUYBQBgH8FfAAAAsrDfAwBEoCaB/7gBGAAAAAAA4DUHjAB/uREYnvOOACuydgIAAHqy5gAAliIADAAAAAAAAMA7hBzhL+8EsCKN+FCf9xwAAABgIAFgAAAAgHk0AwNALppcAZ4TBAbvAQAAAHnZAwcAgGAEgAEAAADm0hQMAABUIwDJqvzugZUJiwAAAKNYfwDUZpyHbwSAgWccUAMAAIxh/QUAeThsBNjvugkDsw6/cwBgFfZGAGoyvgMAQEAfsx8AAAAAgG3bPhuFHaoCAABVfQ9HWvtQieAvgLkdAAAAAKALAWAAAACAOG5NwxrmANa2N0Rivpjnsgn7ALxDGJgq1AMA5nIAAGAOZzUANdlrgl8EgAEAAADicUgF63BwMV+rMXdGk8Ge/39+YwBEJwxMVtbuAMDKBG4AarEnAwAAQQkAAwAAAADMo0mujqj/Lt0u349GV4D2hIGJztwP8JP5GgAAAACgo3+zHwAAAAAAAOhOWAWAbK6b+YsYrpvfIwAAAEBEPkoEAJTnBmAAAAAAAFjDddMI0ZpbgAH6cyswo5jTAY4xLwMA1KCuAwCAwASA6cXhKAAAAAAAANDS7QxSYyqtONcGAAAAAIAYnP/AHf9mPwBlGXQBAAAAAOIRcmnPfjjAeNdv/wNn+P0AvMc6CNg2YwEAAABAd24ApheHpQAAAAAArOKy2RcHmOX7+CuAwDPmaoA2zLcAAHWo7ajAGQ0AUJoAMAAAAAAArOW6aerpQYMJwHzCwPxmbgYAAAAAACAtAWAAAAAAAAAAqhEGXpvgL0Af5lQAAAAAerDvBA8IAAMAAAAAALThFmCAmG5js+aR2szBAH2ZRwEAalHfAQBAAgLAAAAAAAAA7QgBA8TlVuBazLcAAAAAAACUJgAMAAAAAAAAwGoehUcFg+MS+AWYx/wIPOJDaABABGoSAKAsAWAAAAAAAIC2NJoA5LVn/BaC6sscChCLeQ8AAACAnuw/wRMCwAAAAAAAAO0JAQPU9Xt815jymjkRAAAAAAAADhIABgAAAAAAAIDz7oVbVwoFC/cC1LXSfAYAsBJ1HgAAJCEADAAAAAAA0IdbgAHW9Wj8z9Zgax4DWFe2OQsAAACAfOxBwQsCwAAAAAAAAP0IAQPw3as5YWSji/kJgEc0XgJH2PsAACJQkwAAJQkAwycHFwAAAAAAAMBsmhQBmE0PDQAAAABAEP9mPwAAAAAAAEBxGugBAAAAAIjAfjUAEIW6BHYQAAYAAAAAAAAAAEDTJQAAkJk1DQBQjgAwAAAAAABAf5pOAACAyKxZAAAAAACCEQAGAAAAAAAYQ0M9AAAAUJE9DwAAAI6wjoSdBIABAAAAAGAtDtIAAAD4zjoRAGAN6j5W4HcOAJQiAAwAAAAAADCOxhMAAAAAAAAAAF4SAAYAAAAAAAAAAFiTjxQBrRhPAAAA2MP6EQ4QAAYAAAAAABjLgSYAAAAAACPZl2Ylfu8AQBkCwAAAAAAAAONpPgEAAGazLgEAAAAACEwAGAAAAAAAAAAAAIB3+bAAABCFugQgJuMzHCQADAAAAAAA63CYFot/HwAAwCzWIwAA61D7AQBAUgLAAAAAAAAA82i8AgAAACqx1wEARKEuAQDSEwAGAAAAAACYSwMKAAAwkjUIAAAAAKPZk4ITBIABAAAAAADmc9gJAACMYO0BAAAAAJCEADAAAAAAAAAAAEB9wr8AAMBqrIMAgNQEgAEAAAAAAGLQhAIAAPRivQGMZMwBiMOYDAAAiQkAAwAAAAAAxKEZCwAAaM06AwAAAAAgIQFgAAAAAACAWDTnAwAArVhfAAAAADCbPSo4SQAYAAAAAADW4EANAABgLdaBAAAA1kYAQGICwAAAAAAAAPFoRgEAAAAAAAAAWJgAcG2agwAAAAAAAAAAYD36hoDZjEMA8xmLAQAgOQFgAAAAAACAmDRnAQAAZ1hLAAAAAAAUIAAMAAAAAAAQl8Z9AAAAAAAAAIAFCQADAAAAAAAAAADU4CNCAABsm7oQfvNOAMxjDIY3CADDp+vsBwAAAAAAgAcciAIAAHtYOwAAAAAAFCIADAAAAAAAEJ9GfgAAACAb+xkAAAAAbxAABgAAAAAAyEHTLAAA8Ij1AgAAN2pDuM+7AQCkIwAMAAAAAACQh+YUAADgN+sEAAAAAICCBIABAAAAAABy0dwPAABs2+fawPoAAIDv1IfwnHcEYCzjLrxJABgAAAAAACAfB6UAALA2awIgC+MVAAAAwEkCwAAAAAAAADlpoAUAAAAAADjG+QoAkIYAMAAAAAAAAAAAQB6a1QEAuEedCAAAxQgAAwAAAAAA5KWhCwAA1mINAAAAAEAG9rGgAQFgerjOfgAAAAAAAAAAAAAgBE3fAEA06hMAIAUBYAAAAAAAgNw0qQAAwBrU/gAAAAAACxEApgeHDQAAAAAAMJa9eQAAAAAAAACAQgSA6eE6+wEAAAAAAAAAAKAQH/0BAOAZ9SIAABQkAAwAAAAAAFCDBi8AAKhJrQ8AAABAJvazoBEBYAAAAAAAAAAAgJg0SwIAAAAALEoAGAAAAAAAoA7hAAAAqEN9D1RiTAMAolGfAADhCQADAAAAAADUomEFAAAAAAAAACA5AWAAAAAAAAAAAIBYfNgHAAAAAGBxAsAAAAAAAAD1CAsAAEBOl009DwDAMepHAAAoSgAYAAAAAACgJsEBAAAAAAAAAEZyRg0NCQADAAAAAAAAAADMpzkSqM44BwBEoz4BAEITAAYAAAAAAKhN8woAAMR22dTtAACco44EAIDCBIABAAAAAADq0wQGAAAAAADwlzMUgHaMqdCYADAAAAAAAMAaHLYCAEA86nRgNcY9AAAAgJ0EgAEAAAAAANahyRYAAOJQnwMA8A71JLTjfQIAQhIABgAAAAAAWIsmFgAAmE9dDgAAAEAl9rugAwFgAAAAAAAAAAAAAEbRFA7wPmMptOe9AgDCEQAGAAAAAABYjyYWAACYRz0OAAAAAMBLAsAAAAAAAFCf5nLu8bsAAIDx1OEAAAAAAOwiAAwAAAAAALAu4QMAABhH/Q3wxZgIcJ4xFAAAFiEADAAAAAAAAAAAAAAAwOoE7AHOMX5CJwLAMN519gMAAAAAAMA3DmMBAKA/dTcAAAAAAIcIAAMAAAAAACCMAAAA/ai3Ae4zPgIcZ+wEAICFCADDeBbeAAAAAABEZP8aAADaU2cDAADkYh0HAIQhAAzjXWc/AAAAAAAAPKCpBQAAAAAgJvu3AACwGAFgAAAAAAAAvtNEBgAAbaitAQAAAKjOHhh0JAAMAAAAAADAbw5pAQDgPWpqgH2MlwAAAAAPCAADAAAAAABwjwZcAAA4Ry0NAEBrakwAAFiQADAAAAAAAACPaCoDAIBj1NAAAAD5WdsBACEIAAMAAAAAAPCMJhcAANhH7QwAAAAAQDMCwAAAAAAAALwiyAAAAM+pmQEA6EWtCQBEpU6BzgSAAQAAAAAA2MPhLQAA3KdWBniPcRQAAADgDgFgAAAAAAAA9tKQCwAAP6mRAQAAarLeAwCmEwAGAAAAAAAAAAA4TjM4AAC9qTkBAGBhAsAAAAAAAAAcoeEMAADUxQAAAACszf4YDCAADAAAAAAAwFEOcwEAAICW7DUAAAAA/CIADAAAAAAAwBkacwEAWJVaGAAAAACA7gSAAQAAAAAAAAAA9hH+BQBgFLUnzOc9BLjP+AiDCAADAAAAAABw1mVzuAsAwDrUvgAAAAAADCMADAAAAAAAwLsEIQAAqE7NCwAAAADAUALAAAAAAAAAtCAQAQBAVWpdgDGMtwBfjIkQh/cR4CfjIgwkAAwAAAAAAEArDnsBAKhGjQsAAAAAwBQCwAAAAAAAALQkIAEAQBVqWwAAZlCHAgBRqVNgMAFgAAAAAAAAWnPwCwBAdmpaAAAAbqwRAYApBIABAAAAAAAAAAC+aOwGmMcYDAAAEJP1GkwgAAwAAAAAAEAPDoABAMhIHQsAwEzqUYjL+wkADCcADAAAAAAAQC+aYQAAyET9CgAAAAB/2TeDSQSAAQAAAAAA6MlhMAAAGahbAeIwJgMAAMRhjQYTCQADAAAAAAAAAAAr08QIAEAE6lKIz3sKAAwlAAwAAAAAAEBvGmIAAIjosqlVAQAAAOARe2cwmQAwAAAAAAAAIzgcBgAAAPayjwCsxrgHeXhfAYBhBIABAAAAAAAYRVMMAABRqE0BAAAA4DH7ZxCAADAAAAAAAAAjOSgGAGA2NSkAAJGoTyEf7y1QnXEOghAABgAAAAAAYDQHxgAAzKIWBcjDmA0AAAAsTQAYAAAAAACAGTTxAgAwmhoUAIBo1KgAAMBDAsAAAAAAAADMctk0uAEAMIa6EwAAgJasM4GqjG8QiAAwAAAAAAAAszlEBgCgJ/UmAAAAAADpCAADAAAAAAAQgduAAQBoTY0JkJ9xHKjMGAcARKM+gWAEgAEAAAAAAIjEoTIAAC2oKwEAAAAASE0AGAAAAAAAgGiENQAAeId6EgAAgBGsPwGArgSAAQAAAAAAiEjTDAAAZ6gjAQDIQN0KAAC8JAAMAAAAAABAVJrgAAA4Qv0IAAAAAOfYW4OABIABAAAAAACIzEEzAAB7qBsB6jLGAwAAAEsSAAYAAAAAACA6jb4AADyjXgQAAAAAoBwBYAAAAAAAADIQ6gAA4B51IgAA2ahhoRbvNADQjQAwAAAAAAAAAACQkSZrAAAAAHiffTYISgAYAAAAAACALC6bw2cAAD6pCwHWYtwHqjCeAQAAuwkAAwAAAABAbZqJqMjvGgBgbepBAAAAIrFOBQC6EAAGAAAAAAAgI7cBAwCsRw0IsDZzAJCdcQwAiEiNAoEJAAMAAAAAAJCZA2kAgDWo+wAAyEw9C/V5zwGA5gSA97vOfgAAAAAAAADuchMcAEBtaj0AbswJAEBkahUgG+MWBCcADAAAAAAAQBUOqAEA6lHjAQCQnZoWAAA4RQAYPllYAwAAAABADW4DBgCoQ10HAABANtayAEAzAsDw6Tr7AQAAAAAAgKY02AAA5KaeA+ARcwSQiTELAAA4TQAYAAAAAACAqjTXAQDkpI4DAAAAAGB5AsDwycERAAAAAADU5AwAACAX9RsAAADZWdsCAE0IAAMAAAAAAFCdRhsAgBzUbQAAAAAA8B8BYAAAAAAAAFYgTAIAENdlU68BcIx5A8jAWAUAALxFABgAAAAAAIBVaLgDAIhHjQYAAAAA49mXgwQEgAEAAAAAAFiJ2+UAAOJQlwEAAAAAwAMCwAAAAAAAAKxI2AQAYC71GAAAAAAAPCEADAAAAAAAwKqETgAAxrts6jAA2jCfAAAAAKUJAAMAAAAAALAyARQAgHHUXQAAAAAAsJMAMAAAAAAAAAgCAwD0ptYCAGAl6l8AAOBtAsAAAAAAAADwRWMeAEB7aiwAAABWYy0MALxNABgAAAAAAAB+0pQDANCO2gqAnswzAAAAQFkCwAAAAAAAAPCXBmIAgPdcNjUVAABrUgcDAABNCAADAAAAAADAfRr1AADOUUcBMJJ5BwAA4BjrKEhCABgAAAAAAAAec/gNAHCM+gkAAAA+WSMDAG8RAAYAAAAAAIDnNOgAAOyjbgIAYHVqYgAAoBkBYAAAAAAAAHhN4x4AwGOXTb0EwFzmISACYxEAANCUADAAAAAAAADsI9gCAPCX+ggAAAAes24GojEuQSICwAAAAAAAAHCMQ3EAAB9HASAe8xIAAABQigAwAAAAAAAAHCfwAgCsTB0EAAA/qZEBAIDmBIABAAByuM5+AAAAAO4SBAYAVqP2AQAAgGOspQGAUwSAAQAAAAAA4H2CwABAdeodADIwVwEzGHsAgCzULZCMADDwipvmAAAAAABgP8EYAKAi9Q0AAAAAAAwmAAwAAAAAAADtCckAABX4uAkAAAC0YX0NABwmAAwAAAAAAAB9CMwAAJmpYwAA4DV1MwCQhboFEhIABgAAAAAAgL4cpgMAmfiICQDZmccAgKjUKQDAIQLAAAAAAAAA0J8gDQCQgXoFAAD2Uz8DAABdCQADAAAAAADAOILAAEBUahQAAAAAqMneHyT1MfsBAAAAAAAAYEG3Q/br1KcAAND8BwAAAAAAIbkBGAAAAAAAAOYRuAEAZlKLAADAOWpp4CzjBwCwmwAwAAAAAAAAzHXZNPwAAGOpPwCozjwHAADwyfoIEhMABgAAAAAAgBgcvgMAvQn+AgAAAABAEgLAAAAAAAAAEIdADgDQizoDAADaUFsD7zKOAAC7fMx+AAAAAAAAAOCHW+PPdepTAABVaCoGAAAAAICE3AAMAAAAAAAAMQnrAADvUk8AsDLzIAAAsDrrIkjODcAAAAAAAAAQl9uAAYAzNPYBAEAfam0AAGAYNwADAAAAAABAfBoLAYA9Lpu6AQAAADKwfgcAXhIABgAAAAAAgBwEegCAZ9QJAAAAAABQyMfsBwAAAAAAAAAOuYV7rlOfAgCIQvAXAADGUHsDAJmoXaAAAWAAAAAAAADISRAYANamgQ8AAAAAAAr7N/sBAAAAAAAAgLdcNgEgAFiJuR8A9jNnAgCRqVUAgKcEgAEAAAAAAKAGjUIAUJvgLwAAAAAALORj9gMAAAAAAAAAzdxCQdepTwEAtCT0CwAA86nLAYBM1C5QhBuAAQAAAAAAoB43BAJADeZzAAAAAABYlAAwAAAAAAAA1CU0BAA5+ZgHALRjTgUAIlOrAAAPCQADAAAAAABAbQJEAJCLeRsAAGJRowMAmahdoJCP2Q8AAADAS9fZDwAAAEAJt8N+60wAiEljHgAAAAAA8H9uAAYAAIhP0xcAAAAtWWcCQCyXzfwMAAAAAAD8IgAMAAAQn5uZAAAAaE3ICADmumyCvwAwkjkXOMv4AQAATCMADAAAAAAAAGsSOgKA8cy/AAAAwG/2CgCAuz5mPwAAAAAAAAAw1a2x6Dr1KQCgLk28AACQk1oeAMhG/QLFuAEYAAAAAAAA2DYNAQDQg/kVAOIwLwMAAACpCAADAAAAAAAAN5dNQzQAtGBOBQAAAI6wjwC8yzgCBX3MfgAAAAAAAAAgnFuDwHXqUwBAPprsAACgBrU9AAAwnRuAAQAAAAAAgEc0OgLAPm78BYAczNcAAABAGm4ABgAAAAAAAJ5xGzAAPCZEBAAAAADMZp8SinIDMAAAAAAAALCHxgEA+OLGXwAAqEutD8xi/AEAfnADMAAAAAAAALCX24ABWJ1GXAAAAAAAYAg3AAMAAAAAAABHCT8BsCLzHwAAAAAAMIwbgAEAAAAAAIAz3AYMwAqEfgGgnstmLQs8Zg0AAGSjfoHC3AAMAAAAAAAAvENTAQAVXTZzHAAAADCe/QgA4P/cAAwAAAAAAAC8y23AAFShyRYAAAAAAAjBDcAAAAAAAABAK0JTAGTlxl8AAAAAIBt7mlCcG4ABAAAAAACAlr43GrgRGIDoNMgBAAA31gcAAEAobgAGi3UAAAAAAIBe3KYIQGTmKAAAAAAAICwBYPDleQAAAAAAgN4EgQGIxLwEAKgFAIDI1CoAwLZtAsAAAAAAAADAOAJXAMxmHgIAAAAAKrDXCQv4mP0AEIAJDwAAAAAAYKzb+cx16lMAsBK9AQAAAAAAQCpuAAYAAAAAgNqE64DI3AgMQG/mGgAAAAAAICUBYAAAAAAAAGA2wSwAWhP8BQAAjrB+AAAyUbvAIgSA6cEk8py/DwAAAAAAwF+CWgC0YD4BAPZSMwAAAAChCQADAAAAAAAAkWjABuAMwV8AAACgEvscAIAA8AGKJwAAAAAAABhDiAuAvcwZAADAu6wpAIBM1C6wEAFgAAAAAAAAIKrLJtgFwH3mBwCgBfUEABCZWgUAFvcx+wEAAAAAAAAAdvjd6HSd8hQARKD5FQAAaMX6AgAACMsNwAAAAPE5bAIA4B3qSaAqNz8CrMfYDwD0oL4AACJTqwDfGRNgMW4ABgAAAAAAADL73ujgVmCAmjS1AQAAPVhrAAAAobkBuDYNDgAAUIdDJwAAAHjNzZAAtRjXAYBR1BywHu89kIkxCwAWJQAMgtIAAAAAAADVaIYCyE3wFwAA6Ml6A8jI2AUYB2BBAsD0IFALAAB92LwBAOAoNSSwMuExgFwum7EbAJhLHQIARGfvBAAWIwAMAACQi01cAAD2UjcCfLKWBojNOA0ARKIugdqsP4AqjGWwHu89LOpj9gOcNGPQcqstAAAQyWUbs055tv6yTgIAiMvhH8Bf38dGa1qA+dSsAEBUo85igXGsP4CK7HnDOtQysLCsAWAAAADabOK+szFkU6mmV7+lFRoeVvhnBOKpPK/umVuO/u/wWOXfEkBLGqMA5lGzAgAZZDgvOlNXRf9niu7o39zfez7rD2AVZ/a8j4yRLee0KGOzeZpXv8UIv5Eo7wswUYYNinvcALyfv9U+o/9O2f5GigYAAAAAAGAF2c5wALJw5gwAZPXuOlEdBO87+h567wCA2Z7VL8+yfOoY4A83AAMAAAAAAAB8+t1YIRAMcJ5mNQCggiO36al/oA/vFgCQzav6RX0D7CYADAAAAAAAAHDfrQFDEBhgH41rAEBlah0AAABgqKwB4OtmIwUAAAAAAAAY48iNTwAr0sMBAAAAAADQWNYAMAAAAAAAAMAMv0NuAsHAqoR+AQAAAAAAOhIABgAAAAAAADjvFoATBAZWIfgLAAAAAAAwgAAwPVw2DQ4AAAAAAACsRRAYqEzoFwAAAAAAYDABYHBQCQAAAAAAQDvfz56EgYHMnKUDAAAAAABMJAAMc7glGQAAAAAAoD63AgOZCPwCAAAAAAAEIgAMAAAAAAAA0JdbgYFIBH0BAAAAAAASyBwAvm4OpWAU7xsAAAAAAEAbbgUGRnHGCwAAAAAAkFjmADAAAAAAAABAVr+DeQLBwFmCvgAAAAAAAAUJANfn5lYAAAAAAACI79GZnmAwcI8+AAAAAAAAgOIEgOlBEwIAAAAAAAC04aZgYNsEfgEAAAAAAJYjAAwAAAAAAACQxy0EKAgMtQn8AgAAAAAALE4AGD6bIxyeAgAAAAAAkIkgMNTizBoAAAAAAIAfBIBhzkGqRgwAAAAAAABaEASG+IR7AQAAAAAAOEwAGNwADAAAAAAAQH6/z7sEgmE8584AAAAAAAA0IwAMAAAAAAAAUM+eIKKQMLxH4BcAAAAAAIBuBIABAAAAAAAA1vQovCgYDJ8EfAEAAAAAAJhGABjmHNpeNo0TAAAAAAAAxOT2YFYg3AsAAAAAAEBoAsAAAAAAAAAAHHUkPCkszEyCvgAAAAAAAKQkAFyfw0wAAAAAAABgpr1nloLCvMPZOAAAAAAAAKUIAAN7OCwHAAAAAACgN0FhnnFmCQAAAAAAwFIEgAEAAAAAAADI5EgQ9Prff19oOAchXwAAAAAAAPhP9oPO0Yd/Gf9Wsw5Is/ytZh8g+zsBAAAAAABAHVnO/0Zy1ggAAAAAAAAnuAG4NgeptOB3BAAAAAAAAPv0PFu73WZ8+8+jOC8EAAAAAACACQSAAQAAAAAAACC+y4P/DAAAAAAAABT0b/YDvMGBJu/yGwIAAAAAAAAAAAAAAAAAwskcACY24dp9ov+doj8fAAAAAAAAAAAAAAAAAJQjAAwAAAAAAAAAAAAAAAAAAIEIANfl5lYAAAAAAAAAAAAAAAAAgIT+bYKirMnv/jV/IwAAAAAAAAAAAAAAAACY4HYDsKAfAAAAAAAAAAAAAAAAAAAE8O/1fwUAAAAAAAAAAAAAAAAAABjlf+Nc4YbXiqVBAAAAAElFTkSuQmCC',

  // Global template configuration
  config: {
    company: {
      name: 'JESKO ApS',
      address: 'Vestergade 12',
      postalCity: '2100 K√∏benhavn √ò',
      cvr: '12345678',
      website: 'www.ordreflow.dk',
      email: 'support@ordreflow.dk'
    },
    colors: {
      primary: [26, 26, 46],      // #1a1a2e - Dark blue
      accent: [99, 102, 241],     // #6366f1 - Primary purple
      success: [34, 197, 94],     // #22c55e - Green
      text: [51, 51, 51],         // #333333
      muted: [132, 139, 152],     // #848b98
      border: [224, 224, 224],    // #e0e0e0
      headerBg: [249, 250, 251],  // #f9fafb
      white: [255, 255, 255]
    },
    fonts: {
      title: 24,
      subtitle: 14,
      header: 12,
      body: 10,
      small: 9,
      tiny: 8
    },
    margins: {
      top: 20,
      left: 20,
      right: 20,
      bottom: 25
    }
  },

  // Report titles mapping
  titles: {
    'dagsrapport': 'Dagsrapport',
    'produktrapport': 'Produktoversigt',
    'zrapport': 'Z-Rapport',
    'konverteringsrapport': 'Konverteringsrapport',
    'genbestillingsrapport': 'Genbestillingsrapport',
    'anmeldelsesrapport': 'Anmeldelsesrapport',
    'heatmaprapport': 'Heatmap Rapport'
  },

  // Get current restaurant context
  getRestaurant() {
    const selected = typeof restaurants !== 'undefined' ? 
      restaurants.find(r => r.id === currentProfileRestaurantId) : null;
    return {
      name: selected?.name || 'Restaurant',
      cvr: selected?.cvr || 'CVR: 12345678',
      address: selected?.address || 'Adresse',
      postalCity: selected?.postalCity || '2200 K√∏benhavn N',
      phone: selected?.phone || '+45 12 34 56 78'
    };
  },

  // Get formatted date
  getFormattedDate() {
    return new Date().toLocaleDateString('da-DK', { 
      day: '2-digit', 
      month: 'long', 
      year: 'numeric' 
    });
  },

  getShortDate() {
    return new Date().toLocaleDateString('da-DK', { 
      day: '2-digit', 
      month: '2-digit', 
      year: 'numeric' 
    });
  },

  // Get report data based on type
  getReportData(reportType) {
    switch(reportType) {
      case 'dagsrapport':
        return typeof dagsrapportData !== 'undefined' ? dagsrapportData : null;
      case 'produktrapport':
        return this.getProduktrapportData();
      case 'zrapport':
        return this.getZrapportData();
      case 'konverteringsrapport':
        return this.getKonverteringsrapportData();
      case 'genbestillingsrapport':
        return this.getGenbestillingsrapportData();
      case 'anmeldelsesrapport':
        return this.getAnmeldelsesrapportData();
      case 'heatmaprapport':
        return this.getHeatmaprapportData();
      default:
        return null;
    }
  },

  // Sample data generators for each report type
  getProduktrapportData() {
    return {
      title: 'Produktoversigt',
      period: 'Januar 2026',
      headers: ['Produkt', 'Kategori', 'Solgt', 'Oms√¶tning', 'Avance'],
      rows: [
        ['Margherita Pizza', 'Pizza', '245', '24.500 kr', '68%'],
        ['Pepperoni Pizza', 'Pizza', '189', '20.790 kr', '65%'],
        ['Caesar Salat', 'Salater', '156', '10.920 kr', '72%'],
        ['Pasta Carbonara', 'Pasta', '134', '14.740 kr', '61%'],
        ['Tiramisu', 'Dessert', '98', '4.900 kr', '78%'],
        ['Cola', 'Drikkevarer', '312', '9.360 kr', '82%'],
        ['Husets R√∏dvin', 'Vin', '87', '13.050 kr', '58%'],
        ['Bruschetta', 'Forretter', '76', '5.320 kr', '71%']
      ],
      summary: {
        'Total produkter': '8',
        'Total solgt': '1.297 stk',
        'Total oms√¶tning': '103.580 kr',
        'Gns. avance': '69%'
      }
    };
  },

  getZrapportData() {
    return {
      title: 'Z-Rapport',
      period: this.getFormattedDate(),
      headers: ['Beskrivelse', 'Antal', 'Bel√∏b'],
      rows: [
        ['Kontant salg', '45', '12.450 kr'],
        ['Kort salg', '187', '52.360 kr'],
        ['MobilePay', '34', '8.920 kr'],
        ['Gavekort', '12', '3.600 kr'],
        ['Rabatter givet', '23', '-2.340 kr'],
        ['Returneringer', '3', '-890 kr']
      ],
      summary: {
        'Brutto oms√¶tning': '77.330 kr',
        'Rabatter': '-2.340 kr',
        'Returneringer': '-890 kr',
        'Netto oms√¶tning': '74.100 kr',
        'Moms (25%)': '14.820 kr',
        'Oms√¶tning ekskl. moms': '59.280 kr'
      }
    };
  },

  getKonverteringsrapportData() {
    return {
      title: 'Konverteringsrapport',
      period: 'Sidste 30 dage',
      headers: ['Kilde', 'Bes√∏gende', 'Ordrer', 'Konvertering', 'Gns. ordre'],
      rows: [
        ['Direkte', '2.450', '312', '12.7%', '245 kr'],
        ['Google', '1.890', '198', '10.5%', '289 kr'],
        ['Facebook', '876', '87', '9.9%', '198 kr'],
        ['Instagram', '654', '76', '11.6%', '234 kr'],
        ['Email', '432', '89', '20.6%', '312 kr'],
        ['Henvisning', '234', '45', '19.2%', '278 kr']
      ],
      summary: {
        'Total bes√∏gende': '6.536',
        'Total ordrer': '807',
        'Gns. konvertering': '12.3%',
        'Total oms√¶tning': '198.456 kr'
      }
    };
  },

  getGenbestillingsrapportData() {
    return {
      title: 'Genbestillingsrapport',
      period: 'Sidste 90 dage',
      headers: ['Kunde', 'Ordrer', 'Sidste ordre', 'Total', 'Gns. interval'],
      rows: [
        ['Anders Jensen', '12', '14-01-2026', '4.560 kr', '7 dage'],
        ['Maria Nielsen', '8', '12-01-2026', '3.240 kr', '11 dage'],
        ['Peter Hansen', '15', '15-01-2026', '6.780 kr', '6 dage'],
        ['Louise Pedersen', '6', '10-01-2026', '2.340 kr', '15 dage'],
        ['Thomas Andersen', '9', '13-01-2026', '4.050 kr', '10 dage']
      ],
      summary: {
        'Tilbagevendende kunder': '156',
        'Gns. ordrer pr. kunde': '4.2',
        'Gns. interval': '12 dage',
        'Retention rate': '67%'
      }
    };
  },

  getAnmeldelsesrapportData() {
    return {
      title: 'Anmeldelsesrapport',
      period: 'Sidste 30 dage',
      headers: ['Platform', 'Anmeldelser', 'Gns. rating', 'Positive', 'Negative'],
      rows: [
        ['Google', '45', '4.6 ‚òÖ', '42', '3'],
        ['Trustpilot', '23', '4.4 ‚òÖ', '20', '3'],
        ['Facebook', '18', '4.7 ‚òÖ', '17', '1'],
        ['TripAdvisor', '12', '4.5 ‚òÖ', '11', '1'],
        ['Intern feedback', '67', '4.8 ‚òÖ', '65', '2']
      ],
      summary: {
        'Total anmeldelser': '165',
        'Gns. rating': '4.6 ‚òÖ',
        'Positive': '155 (94%)',
        'Negative': '10 (6%)'
      }
    };
  },

  getHeatmaprapportData() {
    return {
      title: 'Heatmap Rapport',
      period: 'Sidste 7 dage',
      headers: ['Tidspunkt', 'Man', 'Tir', 'Ons', 'Tor', 'Fre', 'L√∏r', 'S√∏n'],
      rows: [
        ['11:00-12:00', '12', '15', '14', '18', '22', '45', '38'],
        ['12:00-13:00', '34', '38', '35', '42', '48', '67', '54'],
        ['13:00-14:00', '28', '32', '29', '35', '38', '52', '43'],
        ['17:00-18:00', '18', '22', '20', '25', '32', '28', '24'],
        ['18:00-19:00', '45', '52', '48', '56', '78', '89', '67'],
        ['19:00-20:00', '56', '62', '58', '68', '92', '98', '78'],
        ['20:00-21:00', '42', '48', '45', '52', '72', '82', '62']
      ],
      summary: {
        'Travleste dag': 'L√∏rdag',
        'Travleste time': '19:00-20:00',
        'Total ordrer': '2.156',
        'Gns. pr. time': '44'
      }
    };
  },

  // === PDF EXPORT with Professional Wrapper ===
  async toPDF(reportType) {
    const data = this.getReportData(reportType);

    if (reportType === 'dagsrapport') {
      if (!data) {
        toast('Generer f√∏rst en rapport', 'error');
        return;
      }
      // Use existing dagsrapport PDF function if available
      if (typeof exportDagsrapportPDF === 'function') {
        exportDagsrapportPDF();
        return;
      }
    }

    // Generate PDF with professional wrapper
    this.generateProfessionalPDF(reportType, data);
  },

  generateProfessionalPDF(reportType, data) {
    if (typeof window.jspdf === 'undefined') {
      toast('PDF bibliotek indl√¶ses...', 'info');
      setTimeout(() => this.generateProfessionalPDF(reportType, data), 500);
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

    const c = this.config.colors;
    const m = this.config.margins;
    const f = this.config.fonts;
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const contentWidth = pageWidth - m.left - m.right;
    const restaurant = this.getRestaurant();
    const company = this.config.company;

    let y = m.top;

    // === HEADER SECTION ===
    // Logo (left side)
    try {
      doc.addImage(this.logo, 'PNG', m.left, y, 40, 12);
    } catch(e) {
      // Fallback if logo fails
      doc.setFontSize(f.title);
      doc.setTextColor(...c.accent);
      doc.setFont('helvetica', 'bold');
      doc.text('ORDREFLOW', m.left, y + 8);
    }

    // Restaurant info (right side)
    doc.setFontSize(f.body);
    doc.setTextColor(...c.text);
    doc.setFont('helvetica', 'bold');
    doc.text(restaurant.name, pageWidth - m.right, y + 3, { align: 'right' });

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(f.small);
    doc.setTextColor(...c.muted);
    doc.text(restaurant.address, pageWidth - m.right, y + 7, { align: 'right' });
    doc.text(restaurant.postalCity, pageWidth - m.right, y + 11, { align: 'right' });

    y += 18;

    // Divider line
    doc.setDrawColor(...c.accent);
    doc.setLineWidth(0.8);
    doc.line(m.left, y, pageWidth - m.right, y);

    y += 12;

    // === REPORT TITLE ===
    doc.setFontSize(f.title);
    doc.setTextColor(...c.primary);
    doc.setFont('helvetica', 'bold');
    doc.text(data?.title || this.titles[reportType] || 'Rapport', m.left, y);

    y += 6;

    // Period/Date
    doc.setFontSize(f.body);
    doc.setTextColor(...c.muted);
    doc.setFont('helvetica', 'normal');
    doc.text(data?.period || this.getFormattedDate(), m.left, y);

    // Generated timestamp (right)
    doc.setFontSize(f.tiny);
    const timestamp = new Date().toLocaleString('da-DK');
    doc.text('Genereret: ' + timestamp, pageWidth - m.right, y, { align: 'right' });

    y += 12;

    // === DATA TABLE ===
    if (data && data.headers && data.rows) {
      const colCount = data.headers.length;
      const colWidth = contentWidth / colCount;
      const rowHeight = 8;

      // Table header background
      doc.setFillColor(...c.headerBg);
      doc.rect(m.left, y - 5, contentWidth, rowHeight + 2, 'F');

      // Table header text
      doc.setFontSize(f.small);
      doc.setTextColor(...c.text);
      doc.setFont('helvetica', 'bold');

      data.headers.forEach((header, i) => {
        const x = m.left + (i * colWidth) + 2;
        doc.text(header, x, y);
      });

      y += rowHeight;

      // Table header bottom border
      doc.setDrawColor(...c.border);
      doc.setLineWidth(0.3);
      doc.line(m.left, y - 2, pageWidth - m.right, y - 2);

      // Table rows
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(f.small);

      data.rows.forEach((row, rowIdx) => {
        // Alternate row background
        if (rowIdx % 2 === 1) {
          doc.setFillColor(252, 252, 253);
          doc.rect(m.left, y - 4, contentWidth, rowHeight, 'F');
        }

        doc.setTextColor(...c.text);
        row.forEach((cell, i) => {
          const x = m.left + (i * colWidth) + 2;
          doc.text(String(cell), x, y);
        });

        y += rowHeight;

        // Check for page break
        if (y > pageHeight - 50) {
          doc.addPage();
          y = m.top + 10;
        }
      });

      // Table bottom border
      doc.setDrawColor(...c.border);
      doc.line(m.left, y - 2, pageWidth - m.right, y - 2);

      y += 10;
    }

    // === SUMMARY SECTION ===
    if (data && data.summary) {
      // Summary box
      const summaryHeight = Object.keys(data.summary).length * 7 + 12;

      doc.setFillColor(...c.headerBg);
      doc.roundedRect(m.left, y, contentWidth, summaryHeight, 3, 3, 'F');

      doc.setDrawColor(...c.accent);
      doc.setLineWidth(0.5);
      doc.roundedRect(m.left, y, contentWidth, summaryHeight, 3, 3, 'S');

      y += 8;

      doc.setFontSize(f.header);
      doc.setTextColor(...c.primary);
      doc.setFont('helvetica', 'bold');
      doc.text('Opsummering', m.left + 5, y);

      y += 7;

      doc.setFontSize(f.body);
      doc.setFont('helvetica', 'normal');

      Object.entries(data.summary).forEach(([key, value]) => {
        doc.setTextColor(...c.muted);
        doc.text(key + ':', m.left + 5, y);

        doc.setTextColor(...c.text);
        doc.setFont('helvetica', 'bold');
        doc.text(String(value), m.left + 60, y);
        doc.setFont('helvetica', 'normal');

        y += 6;
      });
    }

    // === FOOTER ===
    const footerY = pageHeight - 15;

    // Footer divider
    doc.setDrawColor(...c.border);
    doc.setLineWidth(0.3);
    doc.line(m.left, footerY - 8, pageWidth - m.right, footerY - 8);

    // Footer text
    doc.setFontSize(f.tiny);
    doc.setTextColor(...c.muted);

    // Left: Company info
    doc.text(company.name + ' ‚Ä¢ CVR: ' + company.cvr, m.left, footerY - 3);
    doc.text(company.website + ' ‚Ä¢ ' + company.email, m.left, footerY + 1);

    // Right: Page number
    doc.text('Side 1 af 1', pageWidth - m.right, footerY - 1, { align: 'right' });

    // Center: Powered by
    doc.setTextColor(...c.accent);
    doc.text('Powered by Ordreflow', pageWidth / 2, footerY - 1, { align: 'center' });

    // Save PDF
    const filename = `${this.titles[reportType] || reportType}_${this.getShortDate().replace(/\./g, '-')}.pdf`;
    doc.save(filename);
    closeExportDropdown();
  },

  // === EXCEL EXPORT ===
  toExcel(reportType) {
    const data = this.getReportData(reportType);

    if (reportType === 'dagsrapport' && !data) {
      toast('Generer f√∏rst en rapport', 'error');
      return;
    }

    const rows = this.buildDataRows(reportType, data);
    const xmlContent = this.generateExcelXML(reportType, rows, data);

    const blob = new Blob([xmlContent], {
      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    });

    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${this.titles[reportType] || reportType}_${this.getShortDate().replace(/\./g, '-')}.xlsx`;
    link.click();
    URL.revokeObjectURL(link.href);

    closeExportDropdown();
  },

  buildDataRows(reportType, data) {
    // For dagsrapport, use existing format
    if (reportType === 'dagsrapport' && data) {
      const d = data;
      const fmt = (n) => typeof n === 'number' ? n.toFixed(2) : n;
      return [
        ['DAGSRAPPORT', d.dato || this.getFormattedDate()],
        [''],
        ['DETALJER'],
        ['√Öbnet', d.aabnet || ''],
        ['Lukket', d.lukket || ''],
        ['√Öbnet af', d.medarbejder || ''],
        ['Dokumentnummer', d.dokumentNummer || ''],
        [''],
        ['SALGSOVERSIGT'],
        ['Bruttooms√¶tning', fmt(d.bruttoomsaetning || 0)],
        ['Rabatter', fmt(d.rabatter || 0)],
        ['Totaloms√¶tning', fmt(d.totalomsaetning || 0)],
        ['Moms opkr√¶vet', fmt(d.momsOpkraevet || 0)],
        ['Salg ekskl. moms', fmt(d.salgEksMoms || 0)]
      ];
    }

    // For other reports with headers/rows structure
    if (data && data.headers && data.rows) {
      const rows = [
        [data.title || this.titles[reportType], data.period || this.getFormattedDate()],
        [''],
        data.headers,
        ...data.rows
      ];

      // Add summary if exists
      if (data.summary) {
        rows.push(['']);
        rows.push(['OPSUMMERING']);
        Object.entries(data.summary).forEach(([key, value]) => {
          rows.push([key, value]);
        });
      }

      return rows;
    }

    // Default empty
    return [
      [this.titles[reportType] || reportType, this.getFormattedDate()],
      [''],
      ['Ingen data tilg√¶ngelig']
    ];
  },

  generateExcelXML(reportType, rows, data) {
    let xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
    xml += '<?mso-application progid="Excel.Sheet"?>\n';
    xml += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" ';
    xml += 'xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">\n';
    xml += '<Styles>\n';
    xml += '<Style ss:ID="Title"><Font ss:Bold="1" ss:Size="16" ss:Color="#6366f1"/></Style>\n';
    xml += '<Style ss:ID="Header"><Font ss:Bold="1" ss:Size="11"/><Interior ss:Color="#f9fafb" ss:Pattern="Solid"/></Style>\n';
    xml += '<Style ss:ID="Bold"><Font ss:Bold="1"/></Style>\n';
    xml += '<Style ss:ID="Number"><NumberFormat ss:Format="#,##0.00"/></Style>\n';
    xml += '</Styles>\n';
    xml += `<Worksheet ss:Name="${this.titles[reportType] || 'Rapport'}">\n`;
    xml += '<Table>\n';

    rows.forEach((row, idx) => {
      xml += '<Row>\n';
      (Array.isArray(row) ? row : [row]).forEach((cell, cellIdx) => {
        let styleAttr = '';
        if (idx === 0) styleAttr = ' ss:StyleID="Title"';
        else if (idx === 2 && data?.headers) styleAttr = ' ss:StyleID="Header"';
        else if (typeof cell === 'string' && cell === cell.toUpperCase() && cell.length > 2) styleAttr = ' ss:StyleID="Bold"';

        const isNumber = typeof cell === 'number' || (typeof cell === 'string' && !isNaN(parseFloat(cell)) && cell.match(/^[\d.,]+$/));
        const cellType = isNumber ? 'Number' : 'String';
        const cellValue = cell === undefined || cell === null ? '' : cell;

        xml += `<Cell${styleAttr}><Data ss:Type="${cellType}">${this.escapeXml(cellValue)}</Data></Cell>\n`;
      });
      xml += '</Row>\n';
    });

    xml += '</Table>\n';
    xml += '</Worksheet>\n';
    xml += '</Workbook>';

    return xml;
  },

  // === CSV EXPORT ===
  toCSV(reportType) {
    const data = this.getReportData(reportType);

    if (reportType === 'dagsrapport' && !data) {
      toast('Generer f√∏rst en rapport', 'error');
      return;
    }

    const rows = this.buildDataRows(reportType, data);

    // Convert to CSV with semicolon separator (Danish Excel default)
    const csv = rows.map(row =>
      (Array.isArray(row) ? row : [row]).map(cell => {
        const str = String(cell === undefined || cell === null ? '' : cell);
        if (str.includes(';') || str.includes('"') || str.includes('\n')) {
          return '"' + str.replace(/"/g, '""') + '"';
        }
        return str;
      }).join(';')
    ).join('\n');

    // UTF-8 BOM for proper Danish character encoding
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${this.titles[reportType] || reportType}_${this.getShortDate().replace(/\./g, '-')}.csv`;
    link.click();
    URL.revokeObjectURL(link.href);

    closeExportDropdown();
  },

  // Helper: Escape XML special characters
  escapeXml(str) {
    if (str === undefined || str === null) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&apos;');
  }
};

// === EXPORT DROPDOWN FUNCTIONS ===
function toggleExportDropdown(id) {
  const dropdown = document.getElementById('export-' + id);
  if (!dropdown) return;

  document.querySelectorAll('.export-dropdown.open').forEach(d => {
    if (d.id !== 'export-' + id) d.classList.remove('open');
  });

  dropdown.classList.toggle('open');
}

function closeExportDropdown() {
  document.querySelectorAll('.export-dropdown.open').forEach(d => d.classList.remove('open'));
}

document.addEventListener('click', (e) => {
  if (!e.target.closest('.export-dropdown')) {
    closeExportDropdown();
  }
});


// =====================================================
// DATA LOADING
// =====================================================
function updateBreadcrumb(page, subpage) {
  const pageTitle = document.getElementById('page-title-kunder');
  if (!pageTitle) return;
  
  const pageTitles = {
    'dashboard': 'Dashboard',
    'kunder': 'Kunder',
    'orders': 'Ordrer',
    'workflow': 'Workflow',
    'settings': 'Indstillinger'
  };
  
  if (subpage) {
    pageTitle.innerHTML = `${pageTitles[page] || page} <span style="color:var(--muted);font-weight:400"> / </span> <span style="color:var(--text)">${subpage}</span>`;
  } else {
    pageTitle.textContent = pageTitles[page] || page;
  }
}

function showModal(id) {
  document.getElementById('modal-' + id).classList.add('active');
}

function closeModal(id) {
  document.getElementById('modal-' + id).classList.remove('active');
}

// =====================================================
// DATA LOADING
// =====================================================
// Dashboard data storage
let dashboardStats = {
  ordersThisMonth: 0,
  ordersTotal: 0,
  revenueThisMonth: 0,
  revenueTotal: 0,
  revenueHistory: [],
  revenuePeriod: 'week'
};

let revenueChart = null;

function loadDashboard() {
  // Restaurant counts - EXTENDED for full lifecycle
  const active = restaurants.filter(r => r.status === 'active').length;
  const inactive = restaurants.filter(r => r.status === 'inactive' || r.status === 'pending').length;
  const churned = restaurants.filter(r => r.status === 'churned' || r.status === 'cancelled').length;
  const terminated = restaurants.filter(r => r.status === 'terminated').length;

  // Order counts (REAL DATA ONLY - no random generation)
  const ordersToday = restaurants.reduce((s, r) => s + (r.orders || 0), 0);

  // PRODUKTIONSKLAR: Brug reelle data fra restaurants (ingen mock data)
  dashboardStats.ordersThisMonth = restaurants.reduce((s, r) => s + (r.ordersThisMonth || 0), 0);
  dashboardStats.ordersTotal = restaurants.reduce((s, r) => s + (r.ordersTotal || 0), 0);

  const conversations = Math.floor(ordersToday * 0.3);

  // Revenue calculations (REAL DATA ONLY)
  const revenueToday = restaurants.reduce((s, r) => s + (r.revenueToday || 0), 0);
  dashboardStats.revenueThisMonth = restaurants.reduce((s, r) => s + (r.revenueThisMonth || 0), 0);
  dashboardStats.revenueTotal = restaurants.reduce((s, r) => s + (r.revenueTotal || 0), 0);

  // Generate revenue history for chart (empty if no data)
  generateRevenueHistory();
  
  // Update Restaurant Status
  const el1 = document.getElementById('stat-restaurants');
  const el2 = document.getElementById('stat-inactive');
  const el3 = document.getElementById('stat-churned');
  
  if (el1) el1.textContent = active;
  if (el2) el2.textContent = inactive;
  if (el3) el3.textContent = churned;

  // Update terminated count (GDPR retention)
  const elTerminated = document.getElementById('stat-terminated');
  if (elTerminated) elTerminated.textContent = terminated;

  // Update Order Statistics
  const el4 = document.getElementById('stat-orders');
  const el5 = document.getElementById('stat-orders-month');
  const el6 = document.getElementById('stat-orders-total');
  const el7 = document.getElementById('stat-conversations');
  
  if (el4) el4.textContent = ordersToday;
  if (el5) el5.textContent = dashboardStats.ordersThisMonth.toLocaleString('da-DK');
  if (el6) el6.textContent = dashboardStats.ordersTotal.toLocaleString('da-DK');
  if (el7) el7.textContent = conversations;
  
  // Update Revenue
  const el8 = document.getElementById('stat-revenue');
  const el9 = document.getElementById('stat-revenue-month');
  const el10 = document.getElementById('stat-revenue-total');
  
  if (el8) el8.textContent = revenueToday.toLocaleString('da-DK') + ' kr';
  if (el9) el9.textContent = dashboardStats.revenueThisMonth.toLocaleString('da-DK') + ' kr';
  if (el10) el10.textContent = dashboardStats.revenueTotal.toLocaleString('da-DK') + ' kr';
  
  // Initialize chart with delay to ensure Chart.js is loaded
  setTimeout(() => {
    initRevenueChart();
  }, 100);

  // Update recent activity feed
  updateRecentActivityUI();
}

function generateRevenueHistory() {
  const now = new Date();
  const history = { week: [], month: [], year: [], weekPrev: [], monthPrev: [], yearPrev: [] };

  // PRODUKTIONSKLAR: Hvis ingen restauranter, returner tom data
  if (!restaurants || restaurants.length === 0) {
    // Generer labels med 0 values
    // 7 dage
    for (let i = 6; i >= 0; i--) {
      const date = new Date(now);
      date.setDate(date.getDate() - i);
      const dayLabel = date.toLocaleDateString('da-DK', { weekday: 'short' });
      history.week.push({ label: dayLabel, value: 0 });
      history.weekPrev.push({ label: dayLabel, value: 0 });
    }

    // 30 dage
    for (let i = 29; i >= 0; i--) {
      const date = new Date(now);
      date.setDate(date.getDate() - i);
      const dayLabel = date.getDate() + '/' + (date.getMonth() + 1);
      history.month.push({ label: dayLabel, value: 0 });
      history.monthPrev.push({ label: dayLabel, value: 0 });
    }

    // 12 m√•neder
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Maj', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dec'];
    for (let i = 11; i >= 0; i--) {
      const date = new Date(now);
      date.setMonth(date.getMonth() - i);
      const monthLabel = monthNames[date.getMonth()];
      history.year.push({ label: monthLabel, value: 0 });
      history.yearPrev.push({ label: monthLabel, value: 0 });
    }

    dashboardStats.revenueHistory = history;
    return;
  }

  // REAL DATA: Beregn revenue history fra restaurants' faktiske data
  // (For nu: tom data da vi ikke har historik endnu)
  // Denne kode kan udvides n√•r backend tilf√∏jer revenue history

  // 7 dage - tom data indtil historik implementeres
  for (let i = 6; i >= 0; i--) {
    const date = new Date(now);
    date.setDate(date.getDate() - i);
    const dayLabel = date.toLocaleDateString('da-DK', { weekday: 'short' });
    history.week.push({ label: dayLabel, value: 0 });
    history.weekPrev.push({ label: dayLabel, value: 0 });
  }

  // 30 dage - tom data
  for (let i = 29; i >= 0; i--) {
    const date = new Date(now);
    date.setDate(date.getDate() - i);
    const dayLabel = date.getDate() + '/' + (date.getMonth() + 1);
    history.month.push({ label: dayLabel, value: 0 });
    history.monthPrev.push({ label: dayLabel, value: 0 });
  }

  // 12 m√•neder - tom data
  const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Maj', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dec'];
  for (let i = 11; i >= 0; i--) {
    const date = new Date(now);
    date.setMonth(date.getMonth() - i);
    const monthLabel = monthNames[date.getMonth()];
    history.year.push({ label: monthLabel, value: 0 });
    history.yearPrev.push({ label: monthLabel, value: 0 });
  }

  dashboardStats.revenueHistory = history;
}

function initRevenueChart() {
  const canvas = document.getElementById('revenue-chart');
  if (!canvas || typeof Chart === 'undefined') return;
  
  // Destroy existing chart
  if (revenueChart) {
    revenueChart.destroy();
  }
  
  const ctx = canvas.getContext('2d');
  const period = dashboardStats.revenuePeriod;
  const data = dashboardStats.revenueHistory[period] || [];
  const prevData = dashboardStats.revenueHistory[period + 'Prev'] || [];
  
  revenueChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map(d => d.label),
      datasets: [
        {
          label: 'Oms√¶tning',
          data: data.map(d => d.value),
          borderColor: '#22c55e',
          backgroundColor: 'rgba(34, 197, 94, 0.1)',
          fill: true,
          tension: 0.4,
          borderWidth: 2,
          pointRadius: 0,
          pointHoverRadius: 4
        },
        {
          label: 'Forrige periode',
          data: prevData.map(d => d.value),
          borderColor: '#60a5fa',
          backgroundColor: 'transparent',
          borderDash: [5, 5],
          tension: 0.4,
          borderWidth: 1.5,
          pointRadius: 0,
          pointHoverRadius: 4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: false,
          external: function(context) {
            // Get or create tooltip element
            let tooltipEl = document.getElementById('chartjs-tooltip');
            if (!tooltipEl) {
              tooltipEl = document.createElement('div');
              tooltipEl.id = 'chartjs-tooltip';
              tooltipEl.innerHTML = '<div class="chart-tooltip-inner"></div>';
              document.body.appendChild(tooltipEl);
            }
            
            const tooltipModel = context.tooltip;
            
            // Hide if no tooltip
            if (tooltipModel.opacity === 0) {
              tooltipEl.style.opacity = 0;
              return;
            }
            
            // Set content
            if (tooltipModel.body) {
              const dataPoints = tooltipModel.dataPoints;
              const label = dataPoints[0].label;
              
              // Format date based on period
              let dateStr = label;
              const now = new Date();
              if (dashboardStats.revenuePeriod === 'week') {
                // Convert weekday to full date
                const dayMap = { 'man': 1, 'tir': 2, 'ons': 3, 'tor': 4, 'fre': 5, 'l√∏r': 6, 's√∏n': 0 };
                const dayIndex = dataPoints[0].dataIndex;
                const date = new Date();
                date.setDate(date.getDate() - (6 - dayIndex));
                dateStr = date.getDate() + ' ' + ['jan', 'feb', 'mar', 'apr', 'maj', 'jun', 'jul', 'aug', 'sep', 'okt', 'nov', 'dec'][date.getMonth()] + ' ' + date.getFullYear();
              } else if (dashboardStats.revenuePeriod === 'month') {
                // Already in d/m format, convert to full
                const parts = label.split('/');
                if (parts.length === 2) {
                  const monthNames = ['jan', 'feb', 'mar', 'apr', 'maj', 'jun', 'jul', 'aug', 'sep', 'okt', 'nov', 'dec'];
                  dateStr = parts[0] + ' ' + monthNames[parseInt(parts[1]) - 1] + ' ' + now.getFullYear();
                }
              } else {
                // Year view - month name
                dateStr = label + ' ' + now.getFullYear();
              }
              
              let innerHtml = '<div class="chart-tooltip-title">' + dateStr + '</div>';
              innerHtml += '<div class="chart-tooltip-body">';
              
              dataPoints.forEach((point, i) => {
                const color = point.dataset.borderColor;
                const value = point.raw.toLocaleString('da-DK');
                const labelText = i === 0 ? 'Oms√¶tning' : 'Forrige periode';
                innerHtml += '<div class="chart-tooltip-row">';
                innerHtml += '<span class="chart-tooltip-dot" style="background:' + color + '"></span>';
                innerHtml += '<span class="chart-tooltip-label">' + labelText + '</span>';
                innerHtml += '<span class="chart-tooltip-value">' + value + ' DKK</span>';
                innerHtml += '</div>';
              });
              
              innerHtml += '</div>';
              tooltipEl.querySelector('.chart-tooltip-inner').innerHTML = innerHtml;
            }
            
            // Position
            const position = context.chart.canvas.getBoundingClientRect();
            tooltipEl.style.opacity = 1;
            tooltipEl.style.position = 'absolute';
            tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px';
            tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY - 10 + 'px';
            tooltipEl.style.pointerEvents = 'none';
            tooltipEl.style.transform = 'translateX(-50%)';
          }
        }
      },
      scales: {
        x: {
          grid: {
            display: true,
            color: 'rgba(255,255,255,0.05)',
            drawBorder: true,
            borderColor: 'rgba(255,255,255,0.1)'
          },
          ticks: {
            display: true,
            color: '#ffffff',
            font: { size: 11 },
            maxRotation: 0,
            autoSkip: true,
            maxTicksLimit: 7
          },
          border: {
            display: true,
            color: 'rgba(255,255,255,0.2)'
          }
        },
        y: {
          beginAtZero: true,
          grid: {
            display: true,
            color: 'rgba(255,255,255,0.05)',
            drawBorder: true,
            borderColor: 'rgba(255,255,255,0.2)'
          },
          ticks: {
            display: true,
            color: '#ffffff',
            font: { size: 11 },
            maxTicksLimit: 6,
            callback: function(value) {
              if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
              if (value >= 1000) return (value / 1000).toFixed(0) + 'k';
              return value;
            }
          },
          border: {
            display: true,
            color: 'rgba(255,255,255,0.2)'
          }
        }
      }
    }
  });
}

function setRevenuePeriod(period) {
  dashboardStats.revenuePeriod = period;
  
  // Update button states
  document.querySelectorAll('.chart-period').forEach(btn => {
    btn.classList.toggle('active', btn.textContent.includes(
      period === 'week' ? '7 dage' : period === 'month' ? '30 dage' : '12 mdr'
    ));
  });
  
  // Redraw chart
  initRevenueChart();
}

// Restaurant logo SVG icons based on type/emoji
function getRestaurantLogoSvg(logo) {
  // Map food types to SVG icons - supports both emoji (legacy) and text keys
  const iconMap = {
    // Text keys (new format)
    'pizza': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2L2 19.5h20L12 2z"/><circle cx="9" cy="13" r="1.5"/><circle cx="12" cy="9" r="1.5"/><circle cx="15" cy="14" r="1.5"/></svg>',
    'burger': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 15h16v2a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-2z"/><path d="M4 11h16"/><path d="M20 11V9a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v2"/><ellipse cx="12" cy="5" rx="8" ry="2"/></svg>',
    'sushi': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="14" rx="8" ry="4"/><path d="M4 14c0-2.21 3.58-4 8-4s8 1.79 8 4"/><path d="M8 10c0-2 1.79-4 4-4s4 2 4 4"/></svg>',
    'ramen': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 11h16"/><path d="M6 11c0 4 2 8 6 8s6-4 6-8"/><path d="M9 5c0 2 1.5 3 3 3s3-1 3-3"/><line x1="12" y1="8" x2="12" y2="11"/></svg>',
    'salad': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="14" rx="9" ry="6"/><path d="M3 14c0-4 4-7 9-7s9 3 9 7"/><path d="M8 12l2 3 4-5"/></svg>',
    'cafe': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V8z"/><line x1="6" y1="2" x2="6" y2="4"/><line x1="10" y1="2" x2="10" y2="4"/><line x1="14" y1="2" x2="14" y2="4"/></svg>',
    'dessert': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 19h16v-4H4v4z"/><path d="M4 15V11a4 4 0 0 1 8 0h8v4"/><path d="M12 7V4"/><circle cx="12" cy="3" r="1"/></svg>',
    'breakfast': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 12c0-4 3.5-6 8-6s8 2 8 6-3.5 6-8 6-8-2-8-6z"/><path d="M6 12c2-2 4-2 6 0s4 2 6 0"/></svg>',
    'bar': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 11h1a3 3 0 0 1 0 6h-1"/><path d="M5 7h12v10a4 4 0 0 1-4 4H9a4 4 0 0 1-4-4V7z"/><path d="M5 7l1-4h10l1 4"/></svg>',
    'pasta': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="16" rx="8" ry="4"/><path d="M4 16v-2c0-1 2-2 2-4s2-4 6-4 6 2 6 4 2 3 2 4v2"/></svg>',
    'default': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
    // Emoji keys (legacy support)
    'üçï': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2L2 19.5h20L12 2z"/><circle cx="9" cy="13" r="1.5"/><circle cx="12" cy="9" r="1.5"/><circle cx="15" cy="14" r="1.5"/></svg>',
    'üçî': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 15h16v2a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-2z"/><path d="M4 11h16"/><path d="M20 11V9a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v2"/><ellipse cx="12" cy="5" rx="8" ry="2"/></svg>',
    'üç£': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="14" rx="8" ry="4"/><path d="M4 14c0-2.21 3.58-4 8-4s8 1.79 8 4"/><path d="M8 10c0-2 1.79-4 4-4s4 2 4 4"/></svg>',
    'üçú': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 11h16"/><path d="M6 11c0 4 2 8 6 8s6-4 6-8"/><path d="M9 5c0 2 1.5 3 3 3s3-1 3-3"/><line x1="12" y1="8" x2="12" y2="11"/></svg>',
    'ü•ó': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="14" rx="9" ry="6"/><path d="M3 14c0-4 4-7 9-7s9 3 9 7"/><path d="M8 12l2 3 4-5"/></svg>',
    '‚òï': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V8z"/><line x1="6" y1="2" x2="6" y2="4"/><line x1="10" y1="2" x2="10" y2="4"/><line x1="14" y1="2" x2="14" y2="4"/></svg>',
    'üç∞': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 19h16v-4H4v4z"/><path d="M4 15V11a4 4 0 0 1 8 0h8v4"/><path d="M12 7V4"/><circle cx="12" cy="3" r="1"/></svg>',
    'ü•ê': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 12c0-4 3.5-6 8-6s8 2 8 6-3.5 6-8 6-8-2-8-6z"/><path d="M6 12c2-2 4-2 6 0s4 2 6 0"/></svg>',
    'üç∫': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 11h1a3 3 0 0 1 0 6h-1"/><path d="M5 7h12v10a4 4 0 0 1-4 4H9a4 4 0 0 1-4-4V7z"/><path d="M5 7l1-4h10l1 4"/></svg>',
    'üçù': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><ellipse cx="12" cy="16" rx="8" ry="4"/><path d="M4 16v-2c0-1 2-2 2-4s2-4 6-4 6 2 6 4 2 3 2 4v2"/></svg>',
  };
  
  // Return mapped SVG or default restaurant icon
  return iconMap[logo] || iconMap['default'];
}

function loadRestaurants() {
  const grid = document.getElementById('restaurants-grid');
  
  // Null check - grid might not exist
  if (!grid) {
    console.log('restaurants-grid not found, skipping');
    return;
  }
  
  if (restaurants.length === 0) {
    grid.innerHTML = '<div class="empty"><div class="empty-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div><div>Ingen restauranter endnu</div><button class="btn btn-primary" style="margin-top:16px" onclick="showModal(\'add-restaurant\')">+ Tilf√∏j restaurant</button></div>';
    return;
  }
  
  grid.innerHTML = restaurants.map(r => {
    // Tjek aktuel √•bningsstatus
    const openStatus = checkRestaurantOpen(r);
    const openBadge = openStatus.isOpen 
      ? `<span style="display:inline-flex;align-items:center;gap:4px;font-size:11px;color:var(--success);background:rgba(52,211,153,0.1);padding:3px 8px;border-radius:4px;margin-top:6px"><span style="width:6px;height:6px;border-radius:50%;background:var(--success)"></span>√Öben nu</span>`
      : `<span style="display:inline-flex;align-items:center;gap:4px;font-size:11px;color:var(--danger);background:rgba(248,113,113,0.1);padding:3px 8px;border-radius:4px;margin-top:6px"><span style="width:6px;height:6px;border-radius:50%;background:var(--danger)"></span>Lukket</span>`;
    
    // F√• dagens √•bningstider (st√∏tter begge navne-formater)
    const dayNamesShort = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
    const dayNamesFull = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
    const dayIndex = new Date().getDay();
    const todayHours = r.openingHours?.[dayNamesShort[dayIndex]] || r.openingHours?.[dayNamesFull[dayIndex]];
    let hoursText = 'Lukket i dag';
    if (todayHours?.enabled) {
      if (todayHours.open === '00:00' && todayHours.close === '00:00') {
        hoursText = 'D√∏gn√•bent';
      } else {
        hoursText = `I dag: ${todayHours.open} - ${todayHours.close}`;
      }
    }
    
    // KPI Section (only if enabled)
    const kpiSection = r.kpiEnabled && r.kpi ? `
      <div class="kpi-section">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <span style="font-size:12px;font-weight:600;color:var(--accent);display:flex;align-items:center;gap:6px">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
            Performance
          </span>
          <span style="font-size:10px;color:var(--muted)">Denne m√•ned</span>
        </div>
        <div class="kpi-grid">
          <div class="kpi-item">
            <div class="kpi-label">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
              Oms√¶tning
            </div>
            <div class="kpi-value">${formatCurrency(r.kpi.totalRevenue)}</div>
          </div>
          <div class="kpi-item">
            <div class="kpi-label">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 6l-9.5 9.5-5-5L1 18"/><polyline points="17 6 23 6 23 12"/></svg>
              Genvundet
            </div>
            <div class="kpi-value positive">${formatCurrency(r.kpi.recoveredRevenue)}</div>
          </div>
          <div class="kpi-item">
            <div class="kpi-label">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
              Rating
            </div>
            <div class="kpi-value">${r.kpi.reviews.avgRating.toFixed(1)}</div>
            <div class="kpi-sub">${r.kpi.reviews.total} anmeldelser</div>
          </div>
          <div class="kpi-item">
            <div class="kpi-label">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
              Konvertering
            </div>
            <div class="kpi-value">${r.kpi.conversionRate}%</div>
          </div>
        </div>
        <div class="review-stats">
          <div class="review-source">
            <svg class="review-source-icon google" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            <span>${r.kpi.reviews.google.avgRating.toFixed(1)} (${r.kpi.reviews.google.count})</span>
          </div>
          <div class="review-source">
            <svg class="review-source-icon trustpilot" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
            <span>${r.kpi.reviews.trustpilot.avgRating.toFixed(1)} (${r.kpi.reviews.trustpilot.count})</span>
          </div>
        </div>
      </div>
    ` : '';
    
    return `
    <div class="restaurant">
      <div class="restaurant-header">
        <div class="restaurant-logo">${getRestaurantLogoSvg(r.logo)}</div>
        <div style="flex:1">
          <div class="restaurant-name">${r.name}</div>
          <div class="restaurant-phone">${r.phone || 'Ikke tildelt'}</div>
          ${openBadge}
        </div>
        <span class="restaurant-status status-${r.status}">${r.status === 'active' ? '‚óè Aktiv' : '‚óã Afventer'}</span>
      </div>
      <div style="font-size:11px;color:var(--muted);padding:8px 0;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        ${hoursText}
      </div>
      <div class="restaurant-stats">
        <div class="restaurant-stat"><div class="restaurant-stat-value">${r.orders || 0}</div><div class="restaurant-stat-label">Ordrer</div></div>
        <div class="restaurant-stat"><div class="restaurant-stat-value">${r.recovered || 0}</div><div class="restaurant-stat-label">Genvundet</div></div>
        <div class="restaurant-stat"><div class="restaurant-stat-value">${r.orders ? Math.round((r.recovered / r.orders) * 100) : 0}%</div><div class="restaurant-stat-label">Rate</div></div>
      </div>
      ${kpiSection}
      <div class="restaurant-actions">
        <button class="btn btn-secondary" style="flex:1" onclick="event.stopPropagation(); editRestaurant('${r.id}')">Rediger</button>
        <button class="btn btn-primary" style="flex:1" onclick="event.stopPropagation(); openCrmDrawer('${r.id}')">Detaljer</button>
      </div>
    </div>
  `}).join('');
  
  // Add click handlers to restaurant cards
  document.querySelectorAll('.restaurant').forEach((card, index) => {
    card.addEventListener('click', () => showCrmProfileView(restaurants[index].id));
  });
  
  // Initialize CRM table
  initCrmTable();
  
  // Update test select (use safer population)
  populateTestRestaurants();
}

// =====================================================
// RESTAURANTS
// =====================================================
async function addRestaurant() {
  const name = document.getElementById('new-restaurant-name').value;
  const logo = document.getElementById('new-restaurant-logo').value || 'pizza';
  const phone = document.getElementById('new-restaurant-phone').value;

  if (!name) {
    toast('Indtast et navn', 'error');
    return;
  }

  const newRestaurantData = {
    name,
    contact_phone: phone,
    status: phone ? 'active' : 'pending',
    orders: 0,
    orders_this_month: 0,
    orders_total: 0,
    revenue_today: 0,
    revenue_this_month: 0,
    revenue_total: 0,
    // Store extra data in metadata JSONB field
    metadata: {
      logo,
      recovered: 0,
      features: { ai: true, sms: true },
      website: '',
      menuUrl: '',
      googleReviewUrl: '',
      trustpilotUrl: '',
      reviewDelay: 60,
      deliveryEnabled: true,
      kpiEnabled: false,
      kpi: {
        totalRevenue: 0,
        recoveredRevenue: 0,
        avgOrderValue: 0,
        reviews: {
          total: 0,
          avgRating: 0,
          google: { count: 0, avgRating: 0 },
          trustpilot: { count: 0, avgRating: 0 }
        },
        conversionRate: 0,
        responseTime: 0
      },
      timeFormat: '24h',
      openingHours: getDefaultOpeningHours()
    }
  };

  // Save to Supabase
  if (typeof SupabaseDB !== 'undefined' && currentUser) {
    try {
      const createdRestaurant = await SupabaseDB.createRestaurant(currentUser.id, newRestaurantData);

      // Add to local array
      restaurants.push(createdRestaurant);

      // Update dashboard KPIs (don't reload all restaurants - real-time sync handles that)
      loadDashboard();
      closeModal('add-restaurant');

      // Log activity
      if (typeof logActivity === 'function') {
        logActivity('create', 'Ny restaurant oprettet', {
          category: 'kunder',
          restaurantId: createdRestaurant.id,
          restaurantName: createdRestaurant.name
        });
      }

      // Add notification to Dashboard (s√• bl√• prik vises p√• Dashboard menupunkt)
      if (typeof NotificationSystem !== 'undefined') {
        NotificationSystem.add('dashboard', {
          title: 'Ny kunde oprettet',
          message: `${createdRestaurant.name} blev tilf√∏jet`,
          timestamp: Date.now()
        });
        console.log('üîµ Dashboard notification added for new customer (modal)');
      }

      toast('Restaurant oprettet!', 'success');
    } catch (err) {
      console.error('‚ùå Error creating restaurant:', err);
      toast('Fejl ved oprettelse af restaurant', 'error');
    }
  } else {
    toast('Supabase ikke tilg√¶ngelig', 'error');
  }

  // Clear form
  document.getElementById('new-restaurant-name').value = '';
  document.getElementById('new-restaurant-phone').value = '';
}

async function addRestaurantFromPage() {
  const name = document.getElementById('new-restaurant-name').value;
  const owner = document.getElementById('new-restaurant-owner')?.value || '';
  const phone = document.getElementById('new-restaurant-phone').value;
  const cvr = document.getElementById('new-restaurant-cvr')?.value || '';
  const email = document.getElementById('new-restaurant-email')?.value || '';
  const address = document.getElementById('new-restaurant-address')?.value || '';
  const country = document.getElementById('new-restaurant-country')?.value || 'DK';
  const contact = document.getElementById('new-restaurant-contact')?.value || '';
  const website = document.getElementById('new-restaurant-website')?.value || '';
  const industry = document.getElementById('new-restaurant-industry')?.value || 'restaurant';
  const role = document.getElementById('new-restaurant-role')?.value || 'owner';

  if (!name) {
    toast('Indtast et restaurantnavn', 'error');
    return;
  }

  // Create data structure matching Supabase schema
  const newRestaurantData = {
    name,
    contact_phone: phone,
    contact_email: email,
    contact_name: contact,
    address,
    country,
    cvr,
    status: phone ? 'active' : 'pending',
    orders: 0,
    orders_this_month: 0,
    orders_total: 0,
    revenue_today: 0,
    revenue_this_month: 0,
    revenue_total: 0,
    ai_enabled: true,
    integration_status: 'none',
    settings: {},
    metadata: {
      logo: 'pizza',
      owner: owner || contact,
      industry: industry,
      user_role: role,
      features: { ai: true, sms: true, billing: true, export: true },
      website: website,
      menuUrl: '',
      googleReviewUrl: '',
      trustpilotUrl: '',
      reviewDelay: 60,
      deliveryEnabled: true,
      kpiEnabled: false,
      kpi: {
        totalRevenue: 0,
        recoveredRevenue: 0,
        avgOrderValue: 0,
        reviews: { total: 0, avgRating: 0, google: { count: 0, avgRating: 0 }, trustpilot: { count: 0, avgRating: 0 } },
        conversionRate: 0,
        responseTime: 0
      },
      timeFormat: '24h',
      openingHours: getDefaultOpeningHours(),
      createdBy: currentUser?.email || 'system'
    }
  };

  try {
    // Check if Supabase is available
    if (typeof SupabaseDB === 'undefined' || !SupabaseDB) {
      console.warn('‚ö†Ô∏è Supabase not available, using localStorage fallback');
      throw new Error('Supabase not available');
    }

    // Save to Supabase database
    console.log('üíæ Attempting to save restaurant to Supabase...');
    const createdRestaurant = await SupabaseDB.createRestaurant(currentUser.id, newRestaurantData);

    if (!createdRestaurant) {
      throw new Error('Failed to create restaurant in database');
    }

    console.log('‚úÖ Restaurant created in Supabase:', createdRestaurant.id);

    // Add to local array with real UUID
    restaurants.push(createdRestaurant);

    // Log activity to Supabase
    await logActivity('create', `Ny restaurant oprettet: ${name}`, {
      category: 'kunder',
      subCategory: 'stamdata',
      customerId: createdRestaurant.id
    });

    // Add notification to Dashboard (s√• bl√• prik vises p√• Dashboard menupunkt)
    if (typeof NotificationSystem !== 'undefined') {
      NotificationSystem.add('dashboard', {
        title: 'Ny kunde oprettet',
        message: `${name} blev tilf√∏jet`,
        timestamp: Date.now()
      });
      console.log('üîµ Dashboard notification added for new customer');
    }

    // Log to customer-specific aktivitetslogs
    addCustomerAktivitetslog(createdRestaurant.id, 'system', 'Kundeprofil oprettet');

    // Auto-import menu fra hjemmeside (i baggrunden)
    if (website) {
      console.log('üåê Auto-importing menu from website:', website);
      importMenuFromWebsite(website, createdRestaurant.id, true)
        .then(products => {
          if (products && products.length > 0) {
            toast(`${products.length} produkter importeret fra hjemmeside`, 'success');
            addCustomerAktivitetslog(createdRestaurant.id, 'system', `${products.length} produkter auto-importeret fra hjemmeside`);
          }
        })
        .catch(err => console.warn('Auto-import menu failed:', err));
    }

    // Update dashboard KPIs (don't reload all restaurants - real-time sync handles that)
    loadDashboard();

    // Clear form
    clearAddRestaurantForm();

    toast(`Restaurant "${name}" oprettet`, 'success');

    // Navigate to customer profile with real UUID
    setTimeout(() => {
      openCrmProfile(createdRestaurant.id);
    }, 300);

  } catch (err) {
    console.error('‚ùå Error creating restaurant:', err);

    // Fallback to localStorage when Supabase is not available
    console.log('üíæ Using localStorage fallback for restaurant creation...');

    // Generate a local ID
    const localId = 'local-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    const localRestaurant = {
      ...newRestaurantData,
      id: localId,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };

    // Add to local array
    restaurants.push(localRestaurant);

    // Save to localStorage
    try {
      localStorage.setItem('orderflow_restaurants', JSON.stringify(restaurants));
      console.log('‚úÖ Restaurant saved to localStorage:', localId);
    } catch (storageErr) {
      console.error('localStorage save error:', storageErr);
    }

    // Add notification to Dashboard
    if (typeof NotificationSystem !== 'undefined') {
      NotificationSystem.add('dashboard', {
        title: 'Ny kunde oprettet (lokal)',
        message: `${name} blev tilf√∏jet`,
        timestamp: Date.now()
      });
    }

    // Log to customer-specific aktivitetslogs
    addCustomerAktivitetslog(localId, 'system', 'Kundeprofil oprettet (lokal)');

    // Update dashboard
    loadDashboard();

    // Clear form
    clearAddRestaurantForm();

    toast(`Restaurant "${name}" oprettet (lokal lagring)`, 'success');

    // Navigate to customer profile
    setTimeout(() => {
      openCrmProfile(localId);
    }, 300);
  }
}

function clearAddRestaurantForm() {
  const fields = ['new-restaurant-name', 'new-restaurant-owner', 'new-restaurant-phone', 'new-restaurant-cvr', 'new-restaurant-email', 'new-restaurant-address', 'new-restaurant-contact', 'new-restaurant-website'];
  fields.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  const country = document.getElementById('new-restaurant-country');
  if (country) country.value = 'DK';
  const industry = document.getElementById('new-restaurant-industry');
  if (industry) industry.value = 'restaurant';
  const role = document.getElementById('new-restaurant-role');
  if (role) role.value = 'owner';
}

// =====================================================
// ALLE KUNDER LIST VIEW
// =====================================================

let alleKunderCurrentPage = 1;
const alleKunderPageSize = 25;
let alleKunderStatusFilter = 'all';
let alleKunderSearchQuery = '';

function loadAlleKunderGrid() {
  const tbody = document.getElementById('alle-kunder-tbody');
  if (!tbody) return;

  // Get filtered restaurants
  const filteredRestaurants = getFilteredAlleKunder();

  // Calculate pagination
  const totalItems = filteredRestaurants.length;
  const totalPages = Math.ceil(totalItems / alleKunderPageSize);
  const startIndex = (alleKunderCurrentPage - 1) * alleKunderPageSize;
  const endIndex = startIndex + alleKunderPageSize;
  const paginatedRestaurants = filteredRestaurants.slice(startIndex, endIndex);

  if (filteredRestaurants.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" style="text-align:center;padding:60px 20px;color:var(--muted)">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin:0 auto 16px;opacity:0.3"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          <p style="font-size:var(--font-size-lg)">Ingen kunder fundet</p>
          <p style="font-size:var(--font-size-sm);margin-top:8px">${alleKunderSearchQuery ? 'Pr√∏v en anden s√∏gning' : 'Opret din f√∏rste kunde for at komme i gang'}</p>
        </td>
      </tr>
    `;
    updateAlleKunderPagination(0, 0);
    return;
  }

  tbody.innerHTML = paginatedRestaurants.map(restaurant => {
    const status = restaurant.status || 'pending';
    const statusBadge = getStatusBadge(status);
    const userId = restaurant.user_id ? restaurant.user_id.substring(0, 8) + '...' : 'N/A';

    return `
      <tr onclick="openCustomerFromAlleKunder('${restaurant.id}')" style="cursor:pointer">
        <td><code style="font-size:11px;background:var(--bg3);padding:2px 6px;border-radius:4px">${userId}</code></td>
        <td style="font-weight:var(--font-weight-medium)">${restaurant.name || 'Unavngivet'}</td>
        <td>${restaurant.metadata?.owner || restaurant.contact_name || '-'}</td>
        <td>${restaurant.phone || restaurant.contact_phone || '-'}</td>
        <td>${restaurant.cvr || '-'}</td>
        <td>${restaurant.orders_total || 0}</td>
        <td>${statusBadge}</td>
      </tr>
    `;
  }).join('');

  updateAlleKunderPagination(totalItems, totalPages);
}

/**
 * Open customer profile from Alle Kunder grid
 * Navigates to Kunder page and shows the CRM profile
 */
function openCustomerFromAlleKunder(restaurantId) {
  // Navigate to kunder page and show profile
  showPage('kunder');
  // Small delay to ensure page is rendered
  setTimeout(() => {
    showCrmProfileView(restaurantId);
  }, 100);
}

function getStatusBadge(status) {
  const statusConfig = {
    active: { label: 'Aktiv', class: 'status-active' },
    pending: { label: 'Afventer', class: 'status-pending' },
    inactive: { label: 'Inaktiv', class: 'status-inactive' },
    demo: { label: 'Demo', class: 'status-demo' },
    churned: { label: 'Churned', class: 'status-churned' },
    cancelled: { label: 'Annulleret', class: 'status-cancelled' },
    terminated: { label: 'Opsagt', class: 'status-terminated' },
    gdpr_deleted: { label: 'GDPR Slettet', class: 'status-gdpr-deleted' }
  };
  const config = statusConfig[status] || { label: status, class: '' };
  return `<span class="status-badge ${config.class}">${config.label}</span>`;
}

function getFilteredAlleKunder() {
  let filtered = [...restaurants];

  // Apply status filter
  if (alleKunderStatusFilter !== 'all') {
    filtered = filtered.filter(r => r.status === alleKunderStatusFilter);
  }

  // Apply search filter
  if (alleKunderSearchQuery) {
    const query = alleKunderSearchQuery.toLowerCase();
    filtered = filtered.filter(r =>
      (r.name && r.name.toLowerCase().includes(query)) ||
      (r.contact_name && r.contact_name.toLowerCase().includes(query)) ||
      (r.metadata?.owner && r.metadata.owner.toLowerCase().includes(query)) ||
      (r.contact_phone && r.contact_phone.includes(query)) ||
      (r.cvr && r.cvr.includes(query)) ||
      (r.user_id && r.user_id.toLowerCase().includes(query))
    );
  }

  // Sort by created_at descending (newest first)
  filtered.sort((a, b) => {
    const aTime = new Date(a.created_at || 0).getTime();
    const bTime = new Date(b.created_at || 0).getTime();
    return bTime - aTime;
  });

  return filtered;
}

function filterAlleKunderByStatus(status) {
  alleKunderStatusFilter = status;
  alleKunderCurrentPage = 1;
  loadAlleKunderGrid();
}

function filterAlleKunderList() {
  const searchInput = document.getElementById('alle-kunder-search');
  alleKunderSearchQuery = searchInput ? searchInput.value.trim() : '';
  alleKunderCurrentPage = 1;
  loadAlleKunderGrid();
}

function updateAlleKunderPagination(totalItems, totalPages) {
  // Update page info text
  const pageInfo = document.getElementById('alle-kunder-page-info');
  if (pageInfo) {
    pageInfo.textContent = `Side ${alleKunderCurrentPage} af ${totalPages || 1}`;
  }

  // Update button disabled states
  const paginationEl = document.getElementById('alle-kunder-pagination');
  if (paginationEl) {
    const buttons = paginationEl.querySelectorAll('.crm-page-btn');
    buttons.forEach(btn => {
      const onclick = btn.getAttribute('onclick') || '';
      if (onclick.includes('First') || onclick.includes('Prev')) {
        btn.disabled = alleKunderCurrentPage === 1;
      } else if (onclick.includes('Next') || onclick.includes('Last')) {
        btn.disabled = alleKunderCurrentPage >= totalPages || totalPages === 0;
      }
    });
  }
}

function alleKunderFirstPage() {
  alleKunderCurrentPage = 1;
  loadAlleKunderGrid();
}

function alleKunderPrevPage() {
  if (alleKunderCurrentPage > 1) {
    alleKunderCurrentPage--;
    loadAlleKunderGrid();
  }
}

function alleKunderNextPage() {
  const totalPages = Math.ceil(getFilteredAlleKunder().length / alleKunderPageSize);
  if (alleKunderCurrentPage < totalPages) {
    alleKunderCurrentPage++;
    loadAlleKunderGrid();
  }
}

function alleKunderLastPage() {
  const totalPages = Math.ceil(getFilteredAlleKunder().length / alleKunderPageSize);
  alleKunderCurrentPage = totalPages || 1;
  loadAlleKunderGrid();
}

// =====================================================
// DEMO CUSTOMER ONBOARDING
// =====================================================

let demoOnboardingStep = 1;
const DEFAULT_DEMO_LICENSE_DAYS = 14;
const DEFAULT_DEMO_MESSAGE_LIMIT = 50;

function resetDemoOnboarding() {
  demoOnboardingStep = 1;
  
  // Reset all form fields
  document.getElementById('demo-firstname').value = '';
  document.getElementById('demo-lastname').value = '';
  document.getElementById('demo-email').value = '';
  document.getElementById('demo-phone').value = '';
  document.getElementById('demo-restaurant-name').value = '';
  document.getElementById('demo-cvr').value = '';
  document.getElementById('demo-address').value = '';
  document.getElementById('demo-zip').value = '';
  document.getElementById('demo-city').value = '';
  document.getElementById('demo-confirm-terms').checked = false;
  
  // Reset license settings to defaults
  const licenseDaysEl = document.getElementById('demo-license-days');
  const messageLimitEl = document.getElementById('demo-message-limit');
  if (licenseDaysEl) licenseDaysEl.value = DEFAULT_DEMO_LICENSE_DAYS.toString();
  if (messageLimitEl) messageLimitEl.value = DEFAULT_DEMO_MESSAGE_LIMIT.toString();
  
  // Reset step indicators
  updateDemoOnboardingSteps();
}

function updateDemoOnboardingSteps() {
  const steps = document.querySelectorAll('#page-demo-onboarding .onboarding-step');
  const sections = document.querySelectorAll('#page-demo-onboarding .onboarding-section');
  const prevBtn = document.getElementById('demo-prev-btn');
  const nextBtn = document.getElementById('demo-next-btn');
  
  // Update step indicators
  steps.forEach((step, idx) => {
    const stepNum = idx + 1;
    step.classList.remove('active', 'completed');
    if (stepNum === demoOnboardingStep) {
      step.classList.add('active');
    } else if (stepNum < demoOnboardingStep) {
      step.classList.add('completed');
      step.querySelector('.onboarding-step-dot').innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
    } else {
      step.querySelector('.onboarding-step-dot').textContent = stepNum;
    }
  });
  
  // Update sections
  sections.forEach(section => {
    section.classList.remove('active');
    if (parseInt(section.dataset.step) === demoOnboardingStep) {
      section.classList.add('active');
    }
  });
  
  // Update buttons
  prevBtn.style.visibility = demoOnboardingStep === 1 ? 'hidden' : 'visible';
  
  if (demoOnboardingStep === 3) {
    nextBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Opret Demo-kunde';
    updateDemoSummary();
  } else {
    nextBtn.innerHTML = 'N√¶ste <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
  }
}

function updateDemoSummary() {
  const firstName = document.getElementById('demo-firstname').value;
  const lastName = document.getElementById('demo-lastname').value;
  const email = document.getElementById('demo-email').value;
  const phone = document.getElementById('demo-phone').value;
  const restaurant = document.getElementById('demo-restaurant-name').value;
  const cvr = document.getElementById('demo-cvr').value;
  const address = document.getElementById('demo-address').value;
  const zip = document.getElementById('demo-zip').value;
  const city = document.getElementById('demo-city').value;
  
  // Get license settings
  const licenseDays = parseInt(document.getElementById('demo-license-days')?.value) || DEFAULT_DEMO_LICENSE_DAYS;
  const messageLimit = parseInt(document.getElementById('demo-message-limit')?.value) || DEFAULT_DEMO_MESSAGE_LIMIT;
  
  document.getElementById('summary-contact').textContent = `${firstName} ${lastName}`;
  document.getElementById('summary-email').textContent = email || '-';
  document.getElementById('summary-phone').textContent = phone || '-';
  document.getElementById('summary-restaurant').textContent = restaurant || '-';
  document.getElementById('summary-cvr').textContent = cvr || '-';
  document.getElementById('summary-address').textContent = address ? `${address}, ${zip} ${city}` : '-';
  
  // Update license info in summary
  document.getElementById('summary-license').innerHTML = `<span class="demo-badge">Demo ${licenseDays} dage</span>`;
  document.getElementById('summary-messages').textContent = `${messageLimit} beskeder`;
  
  // Calculate expiry date
  const expiryDate = new Date();
  expiryDate.setDate(expiryDate.getDate() + licenseDays);
  document.getElementById('summary-expires').textContent = expiryDate.toLocaleDateString('da-DK', { 
    day: 'numeric', 
    month: 'long', 
    year: 'numeric' 
  });
}

function validateDemoStep(step) {
  if (step === 1) {
    const firstName = document.getElementById('demo-firstname').value.trim();
    const lastName = document.getElementById('demo-lastname').value.trim();
    const email = document.getElementById('demo-email').value.trim();
    const phone = document.getElementById('demo-phone').value.trim();
    
    if (!firstName) { toast('Indtast fornavn', 'error'); return false; }
    if (!lastName) { toast('Indtast efternavn', 'error'); return false; }
    if (!email || !email.includes('@')) { toast('Indtast gyldig e-mail', 'error'); return false; }
    if (!phone) { toast('Indtast telefonnummer', 'error'); return false; }
    
    return true;
  }
  
  if (step === 2) {
    const restaurant = document.getElementById('demo-restaurant-name').value.trim();
    if (!restaurant) { toast('Indtast restaurantnavn', 'error'); return false; }
    return true;
  }
  
  if (step === 3) {
    const confirmed = document.getElementById('demo-confirm-terms').checked;
    if (!confirmed) { toast('Bekr√¶ft at kunden er informeret om demo-vilk√•r', 'error'); return false; }
    return true;
  }
  
  return true;
}

function demoOnboardingNext() {
  if (!validateDemoStep(demoOnboardingStep)) return;
  
  if (demoOnboardingStep < 3) {
    demoOnboardingStep++;
    updateDemoOnboardingSteps();
  } else {
    // Create demo customer
    createDemoCustomer();
  }
}

function demoOnboardingPrev() {
  if (demoOnboardingStep > 1) {
    demoOnboardingStep--;
    updateDemoOnboardingSteps();
  }
}

function createDemoCustomer() {
  const firstName = document.getElementById('demo-firstname').value.trim();
  const lastName = document.getElementById('demo-lastname').value.trim();
  const email = document.getElementById('demo-email').value.trim();
  const phone = document.getElementById('demo-phone').value.trim();
  const restaurantName = document.getElementById('demo-restaurant-name').value.trim();
  const cvr = document.getElementById('demo-cvr').value.trim();
  const restaurantType = document.getElementById('demo-restaurant-type').value;
  const address = document.getElementById('demo-address').value.trim();
  const zip = document.getElementById('demo-zip').value.trim();
  const city = document.getElementById('demo-city').value.trim();
  
  // Get license settings from dropdowns
  const licenseDays = parseInt(document.getElementById('demo-license-days')?.value) || DEFAULT_DEMO_LICENSE_DAYS;
  const messageLimit = parseInt(document.getElementById('demo-message-limit')?.value) || DEFAULT_DEMO_MESSAGE_LIMIT;
  
  // Calculate demo license dates
  const startDate = new Date();
  const expiryDate = new Date();
  expiryDate.setDate(expiryDate.getDate() + licenseDays);
  
  // Create demo customer object
  const demoCustomer = {
    id: 'demo_' + Date.now(),
    name: restaurantName,
    logo: restaurantType,
    phone: phone,
    status: 'demo',
    isDemo: true,
    demoLicense: {
      startDate: startDate.toISOString(),
      expiryDate: expiryDate.toISOString(),
      daysRemaining: licenseDays,
      messagesUsed: 0,
      messagesLimit: messageLimit,
      status: 'active' // active, expired
    },
    contact: {
      firstName,
      lastName,
      email,
      phone
    },
    cvr: cvr,
    address: {
      street: address,
      zip: zip,
      city: city,
      country: 'DK'
    },
    orders: 0,
    recovered: 0,
    features: { 
      ai: true, 
      sms: true,
      billing: false, // Demo cannot access billing
      export: false   // Demo cannot export sensitive data
    },
    website: '',
    menuUrl: '',
    googleReviewUrl: '',
    trustpilotUrl: '',
    reviewDelay: 60,
    deliveryEnabled: true,
    kpiEnabled: true,
    kpi: {
      totalRevenue: 0,
      recoveredRevenue: 0,
      avgOrderValue: 0,
      reviews: { total: 0, avgRating: 0, google: { count: 0, avgRating: 0 }, trustpilot: { count: 0, avgRating: 0 } },
      conversionRate: 0,
      responseTime: 0
    },
    timeFormat: '24h',
    openingHours: getDefaultOpeningHours(),
    createdAt: startDate.toISOString(),
    createdBy: currentUser?.email || 'system'
  };
  
  // Add to restaurants array
  restaurants.push(demoCustomer);
  
  // Log activity
  logActivity('create', `Demo-kunde oprettet: ${restaurantName}`, { 
    category: 'kunder', 
    subCategory: 'stamdata',
    customerId: demoCustomer.id, 
    contact: `${firstName} ${lastName}`, 
    demoExpiry: expiryDate.toISOString() 
  });
  
  // Update UI
  loadRestaurants();
  loadDashboard();
  
  // Reset onboarding form
  resetDemoOnboarding();
  
  // Show success and navigate to customer
  toast(`Demo-kunde "${restaurantName}" oprettet med ${licenseDays} dages pr√∏veperiode`, 'success');
  
  // Navigate to customer profile
  setTimeout(() => {
    openCrmProfile(demoCustomer.id);
  }, 300);
}

function getDemoLicenseStatus(customer) {
  if (!customer.isDemo || !customer.demoLicense) return null;
  
  const now = new Date();
  const expiry = new Date(customer.demoLicense.expiryDate);
  const daysRemaining = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
  
  return {
    isExpired: daysRemaining <= 0,
    daysRemaining: Math.max(0, daysRemaining),
    messagesUsed: customer.demoLicense.messagesUsed || 0,
    messagesLimit: customer.demoLicense.messagesLimit || 50,
    expiryDate: expiry
  };
}

function formatDemoStatus(customer) {
  const status = getDemoLicenseStatus(customer);
  if (!status) return '';
  
  if (status.isExpired) {
    return '<span class="status-demo status-demo-expired">Demo udl√∏bet</span>';
  }
  
  return `<span class="status-demo">Demo ¬∑ ${status.daysRemaining} dage</span>`;
}

function upgradeDemoCustomer(id) {
  const restaurant = restaurants.find(r => r.id === id);
  if (!restaurant) {
    toast('Kunde ikke fundet', 'error');
    return;
  }
  
  if (!confirm(`Er du sikker p√•, at du vil opgradere "${restaurant.name}" til betalende kunde?\n\nDette vil:\n- Fjerne demo-status\n- Aktivere fuld funktionalitet\n- Kr√¶ve manuel oprettelse af faktureringaftale`)) {
    return;
  }
  
  // Remove demo status
  restaurant.isDemo = false;
  restaurant.demoLicense = null;
  restaurant.status = 'active';
  restaurant.features.billing = true;
  restaurant.features.export = true;
  
  // Log activity
  logActivity('update', `Demo-kunde opgraderet til betalt: ${restaurant.name}`, { 
    category: 'kunder',
    subCategory: 'abonnement',
    customerId: restaurant.id, 
    previousStatus: 'demo',
    newStatus: 'active'
  });
  
  // Update UI
  loadRestaurants();
  loadDashboard();
  
  // Refresh profile view if open
  if (currentProfileRestaurantId === id) {
    showCrmProfileView(id);
  }
  
  toast(`"${restaurant.name}" er nu en betalende kunde`, 'success');
}

// Override showModal to handle demo-onboarding reset
const originalShowModal = showModal;
showModal = function(id) {
  if (id === 'demo-onboarding') {
    resetDemoOnboarding();
  }
  originalShowModal(id);
};

function editRestaurant(id) {
  const restaurant = restaurants.find(r => r.id === id);
  if (!restaurant) {
    toast('Restaurant ikke fundet', 'error');
    return;
  }
  
  // Populate basic form fields
  document.getElementById('edit-restaurant-id').value = id;
  document.getElementById('edit-restaurant-name').value = restaurant.name || '';
  document.getElementById('edit-restaurant-logo').value = restaurant.logo || 'pizza';
  document.getElementById('edit-restaurant-phone').value = restaurant.phone || '';
  document.getElementById('edit-restaurant-website').value = restaurant.website || '';
  document.getElementById('edit-restaurant-menu').value = restaurant.menuUrl || '';
  document.getElementById('edit-restaurant-google').value = restaurant.googleReviewUrl || '';
  document.getElementById('edit-restaurant-trustpilot').value = restaurant.trustpilotUrl || '';
  document.getElementById('edit-restaurant-delay').value = restaurant.reviewDelay || 60;
  
  // Populate delivery toggle
  document.getElementById('edit-restaurant-delivery').checked = restaurant.deliveryEnabled !== false;
  
  // Populate KPI toggle
  const kpiEnabled = restaurant.kpiEnabled || false;
  document.getElementById('edit-restaurant-kpi-enabled').checked = kpiEnabled;
  document.getElementById('kpi-preview').style.display = kpiEnabled ? 'block' : 'none';
  
  // Update KPI preview values
  if (restaurant.kpi) {
    document.getElementById('kpi-preview-revenue').textContent = formatCurrency(restaurant.kpi.totalRevenue);
    document.getElementById('kpi-preview-recovered').textContent = formatCurrency(restaurant.kpi.recoveredRevenue);
    document.getElementById('kpi-preview-rating').textContent = restaurant.kpi.reviews?.avgRating?.toFixed(1) || '0.0';
    document.getElementById('kpi-preview-conversion').textContent = (restaurant.kpi.conversionRate || 0) + '%';
    
    // Extended KPIs
    document.getElementById('kpi-preview-ai').textContent = (restaurant.kpi.aiAutomationRate || 0) + '%';
    document.getElementById('kpi-preview-clv').textContent = formatCurrency(restaurant.kpi.clv || 0);
    document.getElementById('kpi-preview-ctr').textContent = (restaurant.kpi.reviewCTR || 0) + '%';
    
    // Render heatmap
    renderOrderHeatmap(restaurant.kpi.orderHeatmap);
    
    // Render sentiment
    renderSentiment(restaurant.kpi.sentiment);
  }
  
  // Populate review request toggle (Workflow Sync)
  document.getElementById('edit-restaurant-review-request').checked = restaurant.reviewRequestEnabled !== false;
  updateReviewSyncStatus(restaurant.reviewRequestEnabled !== false);
  
  // Load menu editor
  loadMenuItemsEditor(id);
  
  // Populate time format
  const timeFormat = restaurant.timeFormat || '24h';
  document.getElementById('time-format-24').checked = (timeFormat === '24h');
  document.getElementById('time-format-12').checked = (timeFormat === '12h');
  
  // Populate opening hours
  const defaultHours = getDefaultOpeningHours();
  const hours = restaurant.openingHours || defaultHours;
  
  const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
  days.forEach(day => {
    const dayEl = document.querySelector(`.opening-day[data-day="${day}"]`);
    if (dayEl) {
      const dayHours = hours[day] || defaultHours[day];
      dayEl.querySelector('.day-enabled').checked = dayHours.enabled;
      dayEl.querySelector('.open-time').value = dayHours.open;
      dayEl.querySelector('.close-time').value = dayHours.close;
    }
  });
  
  showModal('edit-restaurant');
}

// Render order heatmap
function renderOrderHeatmap(heatmapData) {
  const container = document.getElementById('order-heatmap');
  if (!container || !heatmapData) return;
  
  // Get max value for scaling
  let maxVal = 1;
  Object.values(heatmapData).forEach(dayData => {
    dayData.forEach(val => { if (val > maxVal) maxVal = val; });
  });
  
  // Sum all days for display
  const hourTotals = new Array(24).fill(0);
  Object.values(heatmapData).forEach(dayData => {
    dayData.forEach((val, hour) => { hourTotals[hour] += val; });
  });
  
  container.innerHTML = hourTotals.map((val, hour) => {
    const intensity = val / (maxVal * 7); // 7 days
    const color = intensity > 0.7 ? 'var(--green)' : intensity > 0.4 ? 'var(--orange)' : intensity > 0.1 ? 'var(--accent)' : 'var(--bg2)';
    return `<div style="height:20px;background:${color};border-radius:2px;opacity:${0.3 + intensity * 0.7}" title="${hour}:00 - ${val} ordrer"></div>`;
  }).join('');
}

// Render sentiment analysis
function renderSentiment(sentimentData) {
  if (!sentimentData) return;
  
  const total = sentimentData.positive + sentimentData.neutral + sentimentData.negative;
  if (total === 0) return;
  
  const posPercent = Math.round((sentimentData.positive / total) * 100);
  const neuPercent = Math.round((sentimentData.neutral / total) * 100);
  const negPercent = Math.round((sentimentData.negative / total) * 100);
  
  document.getElementById('sentiment-positive').style.width = posPercent + '%';
  document.getElementById('sentiment-neutral').style.width = neuPercent + '%';
  document.getElementById('sentiment-negative').style.width = negPercent + '%';
  
  document.getElementById('sentiment-pos-pct').textContent = posPercent;
  document.getElementById('sentiment-neu-pct').textContent = neuPercent;
  document.getElementById('sentiment-neg-pct').textContent = negPercent;
}

// Sync review request toggle with workflow node
function syncReviewRequestToggle() {
  const enabled = document.getElementById('edit-restaurant-review-request').checked;
  updateReviewSyncStatus(enabled);
  
  // Update workflow node status (visual indicator)
  const reviewNode = workflowNodes.find(n => n.id === 'send-review-request');
  if (reviewNode) {
    reviewNode.disabled = !enabled;
    renderWorkflowNodes(); // Re-render to show disabled state
  }
}

// Update sync status indicator
function updateReviewSyncStatus(enabled) {
  const statusEl = document.getElementById('review-sync-status');
  if (statusEl) {
    statusEl.innerHTML = enabled 
      ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg><span style="color:var(--green)">Aktiv - synkroniseret med workflow node "Anmeldelsesanmodning"</span>'
      : '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg><span>Deaktiveret - noden springes over i workflow</span>';
  }
}

// Export KPI as PDF
function exportKpiPdf() {
  const id = document.getElementById('edit-restaurant-id').value;
  const restaurant = restaurants.find(r => r.id === id);
  if (!restaurant) return;
  
  // In production, this would call a PDF generation API
  console.log(`Generating PDF for ${restaurant.name}`);
}

// Export KPI as Excel
function exportKpiExcel() {
  const id = document.getElementById('edit-restaurant-id').value;
  const restaurant = restaurants.find(r => r.id === id);
  if (!restaurant) return;
  
  // In production, this would generate an XLSX file
  console.log(`Generating Excel for ${restaurant.name}`);
}

// =====================================================
// CRM MODULE FUNCTIONS - SEARCH FIRST DESIGN
// =====================================================

// Current CRM state
let currentProfileRestaurantId = null;
let crmCurrentPage = 1;
const crmPageSize = 10;

// Generate 6-digit UserID from restaurant id
function generateUserId(id) {
  // Handle null/undefined/empty
  if (!id) return '000000';
  
  // Ensure id is a string
  const idStr = String(id);
  
  // Create a hash from the id string to get consistent 6 digits
  let hash = 0;
  for (let i = 0; i < idStr.length; i++) {
    hash = ((hash << 5) - hash) + idStr.charCodeAt(i);
    hash = hash & hash;
  }
  return String(Math.abs(hash) % 1000000).padStart(6, '0');
}

// Safe string getter for search
function safeString(val) {
  if (val === null || val === undefined) return '';
  return String(val).toLowerCase();
}

// Initialize CRM table on page load - show empty state
function initCrmTable() {
  // Show empty state in table (table is always visible now)
  const tbody = document.getElementById('crm-table-body');
  if (tbody) {
    tbody.innerHTML = `
      <tr id="crm-empty-row">
        <td colspan="6" style="text-align:center;padding:40px;color:var(--muted)">
          <div style="margin-bottom:8px">Indtast s√∏gekriterier ovenfor</div>
          <div style="font-size:12px">S√∏g p√• navn, CVR, telefonnummer eller UserID</div>
        </td>
      </tr>
    `;
  }
  document.getElementById('crm-page-info').textContent = '1 af 1';
}

// Handle CRM search with autocomplete
function handleCrmSearch(query) {
  query = safeString(query).trim().toLowerCase();
  
  // Always filter and show results in table
  let filtered;
  
  if (!query) {
    // Show empty state row if no query
    const tbody = document.getElementById('crm-table-body');
    if (tbody) {
      tbody.innerHTML = `
        <tr id="crm-empty-row">
          <td colspan="6" style="text-align:center;padding:40px;color:var(--muted)">
            <div style="margin-bottom:8px">Indtast s√∏gekriterier ovenfor</div>
            <div style="font-size:12px">S√∏g p√• navn, CVR, telefonnummer eller UserID</div>
          </td>
        </tr>
      `;
    }
    document.getElementById('crm-page-info').textContent = '1 af 1';
    return;
  }
  
  // Filter restaurants with safe string handling
  filtered = restaurants.filter(r => {
    if (!r) return false;
    const userId = generateUserId(r.id).toLowerCase();
    const name = safeString(r.name).toLowerCase();
    const phone = safeString(r.phone || r.contact_phone).toLowerCase();
    const cvr = safeString(r.cvr).toLowerCase();
    const address = safeString(r.address).toLowerCase();
    const city = safeString(r.city).toLowerCase();

    return name.includes(query) ||
           phone.includes(query) ||
           cvr.includes(query) ||
           userId.includes(query) ||
           address.includes(query) ||
           city.includes(query);
  });
  
  // Update table directly
  renderCrmTable(filtered, query);
}

// Render CRM table
function renderCrmTable(data, query) {
  const tbody = document.getElementById('crm-table-body');
  const pageInfo = document.getElementById('crm-page-info');
  
  if (!data || data.length === 0) {
    // Show "no results" in table body
    if (tbody) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" style="text-align:center;padding:40px;color:var(--muted)">
            <div style="margin-bottom:8px">Ingen kunder fundet</div>
            <div style="font-size:12px">Pr√∏v at tilpasse din s√∏gning</div>
          </td>
        </tr>
      `;
    }
    if (pageInfo) pageInfo.textContent = '0 af 0';
    return;
  }
  
  // HTML escape function
  const escapeHtml = (str) => {
    if (!str) return '-';
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  };
  
  // Pagination
  const totalPages = Math.ceil(data.length / crmPageSize);
  const start = (crmCurrentPage - 1) * crmPageSize;
  const pageData = data.slice(start, start + crmPageSize);
  
  tbody.innerHTML = pageData.map(r => {
    if (!r) return '';
    const userId = generateUserId(r.id);
    const id = escapeHtml(r.id);
    const name = escapeHtml(r.name) || 'Uden navn';
    const phone = escapeHtml(r.phone || r.contact_phone);
    const cvr = escapeHtml(r.cvr);
    const status = r.status || 'pending';
    const isDemo = r.isDemo || false;
    const rowClass = isDemo ? 'demo-row' : '';
    
    // Status badge with demo support
    let statusBadge = '';
    if (isDemo) {
      const demoStatus = getDemoLicenseStatus(r);
      if (demoStatus && demoStatus.isExpired) {
        statusBadge = '<span class="status-badge status-demo status-demo-expired">Demo udl√∏bet</span>';
      } else if (demoStatus) {
        statusBadge = `<span class="status-badge status-demo">Demo ¬∑ ${demoStatus.daysRemaining}d</span>`;
      } else {
        statusBadge = '<span class="status-badge status-demo">Demo</span>';
      }
    } else if (status === 'active') {
      statusBadge = '<span class="status-badge status-active">Aktiv</span>';
    } else if (status === 'inactive') {
      statusBadge = '<span class="status-badge status-pending">Inaktiv</span>';
    } else if (status === 'churned') {
      statusBadge = '<span class="status-badge" style="background:rgba(248,113,113,.1);color:var(--danger)">Opsagt</span>';
    } else if (status === 'terminated') {
      statusBadge = '<span class="status-badge status-terminated">Opsagt (GDPR)</span>';
    } else if (status === 'gdpr_deleted') {
      statusBadge = '<span class="status-badge" style="background:rgba(107,114,128,.15);color:var(--muted)">GDPR Slettet</span>';
    } else {
      statusBadge = '<span class="status-badge status-pending">Afventer</span>';
    }
    
    return `
    <tr class="${rowClass}" onclick="showCrmProfileView('${id}')">
      <td style="font-family:'SF Mono',monospace;font-size:12px">${userId}</td>
      <td style="font-weight:500">${name}${isDemo ? ' <span class="demo-badge">DEMO</span>' : ''}</td>
      <td>${phone}</td>
      <td>${cvr}</td>
      <td>Danmark</td>
      <td>${statusBadge}</td>
    </tr>
  `}).join('');
  
  // Update pagination info
  if (pageInfo) pageInfo.textContent = `${crmCurrentPage} af ${totalPages}`;
}

// Pagination functions
function crmFirstPage() { crmCurrentPage = 1; handleCrmSearch(document.getElementById('crm-search')?.value); }
function crmPrevPage() { if (crmCurrentPage > 1) { crmCurrentPage--; handleCrmSearch(document.getElementById('crm-search')?.value); } }
function crmNextPage() { const total = Math.ceil(restaurants.length / crmPageSize); if (crmCurrentPage < total) { crmCurrentPage++; handleCrmSearch(document.getElementById('crm-search')?.value); } }
function crmLastPage() { crmCurrentPage = Math.ceil(restaurants.length / crmPageSize); handleCrmSearch(document.getElementById('crm-search')?.value); }

// Show search view
function showCrmSearchView() {
  document.getElementById('crm-search-view').style.display = 'block';
  document.getElementById('crm-profile-view').style.display = 'none';
  currentProfileRestaurantId = null;
  document.getElementById('crm-search').value = '';
  initCrmTable();
  
  // Hide customer context menu
  document.getElementById('nav-customer-context').style.display = 'none';
  
  // Update breadcrumb
  updateBreadcrumb('kunder');
}

// Close customer context and return to search
function closeCustomerContext() {
  showCrmSearchView();
}

// Show customer sub-page
function showCustomerSubpage(subpage) {
  const isCustomerView = currentUser?.role && [ROLES.CUSTOMER, ROLES.DEMO].includes(currentUser.role);
  const restaurantId = currentProfileRestaurantId || (restaurants[0]?.id);

  console.log('üìÑ showCustomerSubpage:', subpage, 'isCustomerView:', isCustomerView, 'restaurantId:', restaurantId);

  // === FOR DEMO/KUNDE: Brug de RIGTIGE subpages (samme som admin) ===
  if (isCustomerView) {
    // S√∏rg for at demo restaurant context er sat
    if (!currentProfileRestaurantId && restaurants.length > 0) {
      currentProfileRestaurantId = restaurants[0].id;
      console.log('üìç Sat currentProfileRestaurantId til:', currentProfileRestaurantId);
    }

    // Vis kunder-siden med profil-view aktiv
    const kunderPage = document.getElementById('page-kunder');
    const crmSearchView = document.getElementById('crm-search-view');
    const crmProfileView = document.getElementById('crm-profile-view');

    if (kunderPage && crmProfileView) {
      // Skjul andre pages
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      kunderPage.classList.add('active');

      // Vis profil-view (ikke s√∏ge-view)
      if (crmSearchView) crmSearchView.style.display = 'none';
      crmProfileView.style.display = 'block';

      // Opdater header med demo restaurant info
      const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
      if (restaurant) {
        const profileName = document.getElementById('profile-name');
        const profileCvr = document.getElementById('profile-cvr');
        if (profileName) profileName.textContent = restaurant.name;
        if (profileCvr) profileCvr.textContent = restaurant.cvr || '-';
      }
    }
  }

  // Hide all subpages
  document.querySelectorAll('.customer-subpage').forEach(sp => sp.classList.remove('active'));

  // Show selected subpage
  const targetSubpage = document.getElementById('subpage-' + subpage);
  if (targetSubpage) {
    targetSubpage.classList.add('active');
    console.log('‚úÖ Viser subpage:', 'subpage-' + subpage);
  } else {
    console.warn('‚ö†Ô∏è Subpage ikke fundet:', 'subpage-' + subpage);
    // Fallback til dashboard subpage
    const dashboardSubpage = document.getElementById('subpage-dashboard');
    if (dashboardSubpage) {
      dashboardSubpage.classList.add('active');
      subpage = 'dashboard';
    }
  }

  // Update sidebar menu items (ensure only one active highlight)
  document.querySelectorAll('.nav-dropdown-item').forEach(item => {
    item.classList.remove('active');
  });
  event?.target?.closest('.nav-dropdown-item')?.classList.add('active');

  // Load data for the sub-page if needed
  if (subpage === 'noegletal') loadCustomerKPIData();
  if (subpage === 'dashboard') loadCustomerDashboard(restaurantId);
  if (subpage === 'produkter') loadProductsPage();
  if (subpage === 'kategorier') renderCategoriesTable();
  if (subpage === 'faktura') loadFakturaPage();
  if (subpage === 'abonnement') loadAbonnementPage();
  if (subpage === 'kundelogs') loadCustomerKundelogs();
  if (subpage === 'aktivitetslogs') loadCustomerAktivitetslogs();
  if (subpage === 'stamdata') loadStamdataPage(restaurantId);
  if (subpage === 'beskeder') loadBeskederPage(restaurantId);
  if (subpage === 'workflow-kontrol') loadWorkflowKontrolPage(restaurantId);
}

/**
 * Load stamdata page - populerer formularfelter med restaurant data
 */
function loadStamdataPage(restaurantId) {
  const restaurant = restaurants.find(r => r.id === restaurantId);
  if (!restaurant) {
    console.warn('Restaurant ikke fundet for stamdata:', restaurantId);
    return;
  }

  console.log('üìã Loading stamdata for:', restaurant.name);

  // Populate STAMDATA form
  const setVal = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.value = val || '';
  };

  setVal('stamdata-name', restaurant.name);
  setVal('stamdata-cvr', restaurant.cvr);
  setVal('stamdata-owner', restaurant.owner || restaurant.contact_name);
  setVal('stamdata-contact', restaurant.contactPerson || restaurant.contact_name);
  setVal('stamdata-email', restaurant.email || restaurant.contact_email);
  setVal('stamdata-phone', restaurant.phone || restaurant.contact_phone);
  setVal('stamdata-industry', restaurant.industry || restaurant.metadata?.industry);
  setVal('stamdata-address', restaurant.address);
  setVal('stamdata-country', restaurant.country || 'DK');
  setVal('stamdata-website', restaurant.website || restaurant.metadata?.website);
  setVal('stamdata-created', restaurant.createdAt || restaurant.created_at || '-');

  // MobilePay integration
  setVal('stamdata-mobilepay-merchant', restaurant.mobilepayMerchantId);
  setVal('stamdata-mobilepay-api-key', restaurant.mobilepayApiKey);
}

/**
 * Load beskeder page - populerer SMS skabeloner
 */
function loadBeskederPage(restaurantId) {
  const restaurant = restaurants.find(r => r.id === restaurantId);
  if (!restaurant) {
    console.warn('Restaurant ikke fundet for beskeder:', restaurantId);
    return;
  }

  console.log('üí¨ Loading beskeder for:', restaurant.name);

  // Load saved messages or defaults
  const messages = restaurant.messages || {};
  const setMsg = (id, defaultText) => {
    const el = document.getElementById(id);
    if (el) el.value = messages[id] || defaultText;
  };

  setMsg('msg-welcome-text', 'Hej {{kunde}}! Tak for din interesse i {{restaurant}}.');
  setMsg('msg-pending-text', 'Vi har modtaget din ordre og arbejder p√• den.');
  setMsg('msg-accepted-text', 'Din ordre er accepteret! Forventet ventetid: {{ventetid}} min.');
  setMsg('msg-preparing-text', 'Din ordre er nu under tilberedning.');
  setMsg('msg-ready-text', 'Din ordre er klar til afhentning/levering!');
  setMsg('msg-picked-up-text', 'Tak for din ordre hos {{restaurant}}!');
  setMsg('msg-closed-text', 'Vi har desv√¶rre lukket. √Öbningstider: {{√•bningstider}}');
  setMsg('msg-error-text', 'Beklager, der opstod en fejl. Pr√∏v igen eller ring til os.');
}

/**
 * Load workflow kontrol page - populerer workflow indstillinger
 */
function loadWorkflowKontrolPage(restaurantId) {
  const restaurant = restaurants.find(r => r.id === restaurantId);
  if (!restaurant) {
    console.warn('Restaurant ikke fundet for workflow kontrol:', restaurantId);
    return;
  }

  console.log('‚öôÔ∏è Loading workflow kontrol for:', restaurant.name);

  // Workflow toggles
  const setChecked = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.checked = !!val;
  };

  setChecked('wf-review-enabled', restaurant.googleReviewUrl || restaurant.trustpilotUrl);
  setChecked('wf-reorder-enabled', restaurant.reorderEnabled !== false);
  setChecked('wf-receipt-enabled', restaurant.receiptEnabled !== false);
  setChecked('wf-delivery-enabled', restaurant.deliveryEnabled !== false);

  // Review links
  const setVal = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.value = val || '';
  };

  setVal('wf-google-link', restaurant.googleReviewUrl);
  setVal('wf-trustpilot-link', restaurant.trustpilotUrl);

  // Opening hours
  const oh = restaurant.openingHours || {};
  const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
  const defaultTimes = {
    mon: { open: '10:00', close: '22:00' },
    tue: { open: '10:00', close: '22:00' },
    wed: { open: '10:00', close: '22:00' },
    thu: { open: '10:00', close: '22:00' },
    fri: { open: '10:00', close: '23:00' },
    sat: { open: '11:00', close: '23:00' },
    sun: { open: '12:00', close: '21:00' }
  };

  days.forEach(day => {
    const dayData = oh[day] || defaultTimes[day];
    setChecked(`oh-${day}-enabled`, dayData.enabled !== false);
    setVal(`oh-${day}-open`, dayData.open);
    setVal(`oh-${day}-close`, dayData.close);
  });

  // Toggle delivery settings visibility
  if (typeof toggleDeliverySettings === 'function') {
    toggleDeliverySettings();
  }
}

// =====================================================
// CUSTOMER DASHBOARD - Charts and Stats
// =====================================================

let customerRevenueChart = null;
let customerPaymentChart = null;
let customerProductsChart = null;

/**
 * Load customer dashboard data and render charts
 */
async function loadCustomerDashboard(restaurantId) {
  const restaurant = restaurants.find(r => r.id === restaurantId);
  if (!restaurant) return;

  // Update KPI stats
  const statsOrders = document.getElementById('customer-stat-orders');
  const statsRevenue = document.getElementById('customer-stat-revenue');
  const statsAvgOrder = document.getElementById('customer-stat-avg-order');
  const statsContacts = document.getElementById('customer-stat-contacts');

  if (statsOrders) statsOrders.textContent = restaurant.orders_total || 0;
  if (statsRevenue) statsRevenue.textContent = formatCurrency(restaurant.revenue_total || 0);
  if (statsAvgOrder) {
    const avg = restaurant.orders_total > 0 ? (restaurant.revenue_total / restaurant.orders_total) : 0;
    statsAvgOrder.textContent = formatCurrency(avg);
  }
  if (statsContacts) statsContacts.textContent = restaurant.contacts_count || 0;

  // Try to load orders for charts (revenue & payment methods)
  let orders = [];
  try {
    if (typeof SupabaseDB !== 'undefined' && SupabaseDB.getOrdersByRestaurant) {
      orders = await SupabaseDB.getOrdersByRestaurant(restaurantId) || [];
      console.log(`üìä Loaded ${orders.length} orders from database`);
    }
  } catch (err) {
    console.log('Could not load orders from database:', err.message);
  }

  // No demo data fallback - show empty/0 values if no real orders
  if (orders.length === 0) {
    console.log('üìä No orders found - charts will show empty values');
  }

  // Load menu items for products chart (from produktbibliotek)
  let menuItems = [];
  try {
    // Try restaurant's customMenu first
    if (restaurant.customMenu && restaurant.customMenu.items && restaurant.customMenu.items.length > 0) {
      menuItems = restaurant.customMenu.items;
      console.log(`üìä Loaded ${menuItems.length} products from customMenu`);
    }
    // Try localStorage
    else {
      const savedMenu = localStorage.getItem(`menu_${restaurantId}`);
      if (savedMenu) {
        const parsed = JSON.parse(savedMenu);
        menuItems = parsed.items || [];
        console.log(`üìä Loaded ${menuItems.length} products from localStorage`);
      }
    }
    // Try Supabase if still empty
    if (menuItems.length === 0 && typeof SupabaseDB !== 'undefined' && SupabaseDB.getMenu) {
      const menu = await SupabaseDB.getMenu(restaurantId);
      if (menu && menu.items && menu.items.length > 0) {
        menuItems = menu.items;
        console.log(`üìä Loaded ${menuItems.length} products from Supabase`);
      }
    }
  } catch (err) {
    console.log('Could not load menu items:', err.message);
  }

  // Hide demo data indicator (we no longer use demo data)
  const demoIndicator = document.getElementById('demo-data-indicator');
  if (demoIndicator) {
    demoIndicator.style.display = 'none';
  }

  // Render charts
  renderCustomerRevenueChart(orders);
  renderCustomerPaymentChart(orders);
  renderCustomerProductsChart(menuItems); // Nu med produktbibliotek data
}

// Chart instances for demo dashboard
let demoRevenueChart = null;
let demoPaymentChart = null;
let demoProductsChart = null;

// Track retry count to prevent infinite loops
let demoDashboardRetryCount = 0;
const MAX_DEMO_DASHBOARD_RETRIES = 10;

/**
 * Load demo dashboard with KPIs and charts for demo/kunde users
 * Called from loginDemo() after showApp()
 */
async function loadDemoDashboard() {
  console.log('üìä Loading demo dashboard... (attempt', demoDashboardRetryCount + 1, ')');

  const restaurant = restaurants[0]; // Use first demo restaurant
  if (!restaurant) {
    console.warn('No restaurant for demo dashboard');
    return;
  }

  // Tjek at customer-dashboard er synligt
  const customerDash = document.getElementById('customer-dashboard');
  if (!customerDash || customerDash.classList.contains('hidden')) {
    if (demoDashboardRetryCount < MAX_DEMO_DASHBOARD_RETRIES) {
      demoDashboardRetryCount++;
      console.warn('Customer dashboard not visible, retrying... (', demoDashboardRetryCount, '/', MAX_DEMO_DASHBOARD_RETRIES, ')');
      setTimeout(() => loadDemoDashboard(), 150);
      return;
    } else {
      console.error('Customer dashboard still not visible after max retries. Forcing visibility.');
      // Force visibility and continue
      if (customerDash) customerDash.classList.remove('hidden');
    }
  }

  // Tjek at canvas elementer eksisterer
  const revenueCtx = document.getElementById('demo-revenue-chart');
  const paymentCtx = document.getElementById('demo-payment-chart');
  const productsCtx = document.getElementById('demo-products-chart');

  if (!revenueCtx || !paymentCtx || !productsCtx) {
    if (demoDashboardRetryCount < MAX_DEMO_DASHBOARD_RETRIES) {
      demoDashboardRetryCount++;
      console.warn('Demo chart canvas elements not found, retrying... (', demoDashboardRetryCount, '/', MAX_DEMO_DASHBOARD_RETRIES, ')');
      setTimeout(() => loadDemoDashboard(), 150);
      return;
    } else {
      console.error('Demo chart canvas elements not found after max retries');
      return;
    }
  }

  // Reset retry count on success
  demoDashboardRetryCount = 0;

  // Update KPI stats
  const statsOrders = document.getElementById('demo-stat-orders');
  const statsRevenue = document.getElementById('demo-stat-revenue');
  const statsAvg = document.getElementById('demo-stat-avg');
  const statsRating = document.getElementById('demo-stat-rating');

  if (statsOrders) statsOrders.textContent = restaurant.orders_total || 127;
  if (statsRevenue) statsRevenue.textContent = formatCurrency(restaurant.revenue_total || 45890);
  if (statsAvg) {
    const avg = restaurant.orders_total > 0 ? (restaurant.revenue_total / restaurant.orders_total) : 361;
    statsAvg.textContent = formatCurrency(avg);
  }
  if (statsRating) statsRating.textContent = '4.8';

  // Generate demo orders for charts
  const orders = generateDemoOrdersData(restaurant.id);
  console.log('üìä Generated', orders.length, 'demo orders for charts');

  // Render demo charts med requestAnimationFrame for at sikre DOM er klar
  requestAnimationFrame(() => {
    renderDemoRevenueChart(orders);
    renderDemoPaymentChart(orders);
    renderDemoProductsChart(orders);
    console.log('‚úÖ Demo charts rendered');
  });

  console.log('‚úÖ Demo dashboard loaded');
}

/**
 * Demo revenue chart
 */
function renderDemoRevenueChart(orders) {
  const ctx = document.getElementById('demo-revenue-chart');
  if (!ctx) return;

  // Group by day (last 30 days)
  const last30Days = [];
  const revenueByDay = {};
  const ordersByDay = {};

  for (let i = 29; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const key = date.toISOString().split('T')[0];
    last30Days.push(key);
    revenueByDay[key] = 0;
    ordersByDay[key] = 0;
  }

  orders.forEach(order => {
    const date = new Date(order.created_at).toISOString().split('T')[0];
    if (revenueByDay.hasOwnProperty(date)) {
      revenueByDay[date] += order.total || 0;
      ordersByDay[date]++;
    }
  });

  if (demoRevenueChart) demoRevenueChart.destroy();

  demoRevenueChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: last30Days.map(d => new Date(d).toLocaleDateString('da-DK', { day: 'numeric', month: 'short' })),
      datasets: [
        {
          label: 'Oms√¶tning',
          data: last30Days.map(d => revenueByDay[d]),
          backgroundColor: 'rgba(34, 197, 94, 0.7)',
          borderRadius: 4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
        x: { grid: { display: false } }
      }
    }
  });
}

/**
 * Demo payment methods pie chart
 */
function renderDemoPaymentChart(orders) {
  const ctx = document.getElementById('demo-payment-chart');
  if (!ctx) return;

  const paymentCounts = {};
  orders.forEach(order => {
    const method = order.payment_method || 'Ukendt';
    paymentCounts[method] = (paymentCounts[method] || 0) + 1;
  });

  if (demoPaymentChart) demoPaymentChart.destroy();

  demoPaymentChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: Object.keys(paymentCounts),
      datasets: [{
        data: Object.values(paymentCounts),
        backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right', labels: { color: '#999' } }
      }
    }
  });
}

/**
 * Demo top products bar chart
 */
function renderDemoProductsChart(orders) {
  const ctx = document.getElementById('demo-products-chart');
  if (!ctx) return;

  const productSales = {};
  orders.forEach(order => {
    (order.items || []).forEach(item => {
      productSales[item.name] = (productSales[item.name] || 0) + item.quantity;
    });
  });

  const sortedProducts = Object.entries(productSales)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);

  if (demoProductsChart) demoProductsChart.destroy();

  demoProductsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sortedProducts.map(p => p[0]),
      datasets: [{
        label: 'Solgte enheder',
        data: sortedProducts.map(p => p[1]),
        backgroundColor: 'rgba(59, 130, 246, 0.7)',
        borderRadius: 4
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
        y: { grid: { display: false } }
      }
    }
  });
}

/**
 * Set demo chart period (not implemented fully - placeholder)
 */
function setDemoChartPeriod(days) {
  // Update active button
  document.querySelectorAll('.demo-charts-section .chart-period').forEach(btn => {
    btn.classList.toggle('active', btn.textContent.includes(days === '30' ? '30' : days === '90' ? '3' : '12'));
  });
  // Could regenerate data for different period here
}

/**
 * Generate demo orders data for charts
 */
function generateDemoOrdersData(restaurantId) {
  const orders = [];
  const paymentMethods = ['Kort', 'Kontant', 'MobilePay', 'Faktura'];
  const products = ['Margherita', 'Pepperoni', 'Quattro Formaggi', 'Calzone', 'Hawaiianer', 'Kebab Pizza', 'Vegetar', 'Tiramisu', 'Cola', 'Fanta'];

  for (let i = 0; i < 50; i++) {
    const date = new Date();
    date.setDate(date.getDate() - Math.floor(Math.random() * 30));

    const numItems = Math.floor(Math.random() * 4) + 1;
    const items = [];
    for (let j = 0; j < numItems; j++) {
      items.push({
        name: products[Math.floor(Math.random() * products.length)],
        quantity: Math.floor(Math.random() * 3) + 1,
        price: Math.floor(Math.random() * 100) + 50
      });
    }

    orders.push({
      id: `demo-${i}`,
      restaurant_id: restaurantId,
      created_at: date.toISOString(),
      total: items.reduce((sum, item) => sum + (item.price * item.quantity), 0),
      payment_method: paymentMethods[Math.floor(Math.random() * paymentMethods.length)],
      items: items
    });
  }
  return orders;
}

/**
 * Monthly revenue/orders line chart
 */
function renderCustomerRevenueChart(orders) {
  const ctx = document.getElementById('customer-revenue-chart');
  if (!ctx) return;

  // Group by day (last 30 days)
  const last30Days = [];
  const revenueByDay = {};
  const ordersByDay = {};

  for (let i = 29; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    const key = date.toISOString().split('T')[0];
    last30Days.push(key);
    revenueByDay[key] = 0;
    ordersByDay[key] = 0;
  }

  orders.forEach(order => {
    const date = new Date(order.created_at).toISOString().split('T')[0];
    if (revenueByDay.hasOwnProperty(date)) {
      revenueByDay[date] += order.total || 0;
      ordersByDay[date]++;
    }
  });

  if (customerRevenueChart) customerRevenueChart.destroy();

  customerRevenueChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: last30Days.map(d => new Date(d).toLocaleDateString('da-DK', { day: 'numeric', month: 'short' })),
      datasets: [
        {
          label: 'Oms√¶tning',
          data: last30Days.map(d => revenueByDay[d]),
          backgroundColor: 'rgba(134, 197, 158, 0.8)',  // Bl√∏d gr√∏n (matcher cirkeldiagram)
          borderRadius: 3
        },
        {
          label: 'Ordrer',
          data: last30Days.map(d => ordersByDay[d]),
          backgroundColor: 'rgba(134, 182, 246, 0.8)',  // Bl√∏d bl√• (matcher cirkeldiagram)
          borderRadius: 3,
          yAxisID: 'y1'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(255,255,255,0.05)' }
        },
        y1: {
          position: 'right',
          beginAtZero: true,
          grid: { display: false }
        },
        x: {
          grid: { display: false }
        }
      }
    }
  });
}

/**
 * Payment methods doughnut chart
 */
function renderCustomerPaymentChart(orders) {
  const ctx = document.getElementById('customer-payment-chart');
  if (!ctx) return;

  // Standard betalingsmetoder (vises altid)
  const defaultMethods = ['Kort', 'Kontant', 'MobilePay', 'Faktura'];
  const methodColors = {
    'Kort': 'rgba(134, 182, 246, 0.8)',
    'Kontant': 'rgba(134, 197, 158, 0.8)',
    'MobilePay': 'rgba(178, 132, 190, 0.8)',
    'Faktura': 'rgba(246, 186, 134, 0.8)'
  };

  // T√¶l betalingsmetoder fra ordrer
  const paymentMethods = {};
  orders.forEach(order => {
    const method = order.payment_method || 'Ukendt';
    paymentMethods[method] = (paymentMethods[method] || 0) + 1;
  });

  if (customerPaymentChart) customerPaymentChart.destroy();

  // Hvis ingen data, vis gr√• placeholder doughnut
  if (Object.keys(paymentMethods).length === 0) {
    customerPaymentChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Ingen data'],
        datasets: [{
          data: [1],
          backgroundColor: ['rgba(80, 80, 80, 0.3)'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%',
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false }
        }
      }
    });
  } else {
    // Vis rigtig data
    const colors = defaultMethods.map(m => methodColors[m]);
    customerPaymentChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(paymentMethods),
        datasets: [{
          data: Object.values(paymentMethods),
          backgroundColor: Object.keys(paymentMethods).map(m => methodColors[m] || 'rgba(158, 158, 158, 0.8)'),
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%',
        plugins: {
          legend: { display: false }
        }
      }
    });
  }

  // Generer betalingsmetode-tabel - viser ALTID de 4 standard metoder
  const total = Object.values(paymentMethods).reduce((a, b) => a + b, 0);
  let tableHtml = '';

  defaultMethods.forEach(method => {
    const count = paymentMethods[method] || 0;
    const methodOrders = orders.filter(o => o.payment_method === method);
    const amount = methodOrders.reduce((sum, o) => sum + (o.total || 0), 0);
    const percentage = total > 0 ? ((count / total) * 100).toFixed(0) : 0;

    tableHtml += `
      <div class="payment-row">
        <span class="payment-dot" style="background:${methodColors[method]}"></span>
        <span class="payment-method">${method}</span>
        <span class="payment-amount">${formatCurrency(amount)}</span>
        <span class="payment-percent">${percentage}%</span>
      </div>
    `;
  });

  const tableEl = document.getElementById('payment-stats-table');
  if (tableEl) tableEl.innerHTML = tableHtml;
}

/**
 * Top products horizontal bar chart - viser produkter fra produktbibliotek
 */
function renderCustomerProductsChart(menuItems) {
  const ctx = document.getElementById('customer-products-chart');
  if (!ctx) return;

  // Vis produkter fra kundens produktbibliotek (menu items)
  const products = (menuItems || []).slice(0, 10);

  if (customerProductsChart) customerProductsChart.destroy();

  // Hvis ingen produkter, vis synlig gr√• placeholder bar
  if (products.length === 0) {
    customerProductsChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Ingen produkter endnu'],
        datasets: [{
          label: 'Produkter',
          data: [100],  // Synlig v√¶rdi
          backgroundColor: 'rgba(80, 80, 80, 0.3)',
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
          legend: { display: false },
          tooltip: { enabled: false }
        },
        scales: {
          x: { display: false, max: 100 },
          y: { grid: { display: false } }
        }
      }
    });
    return;
  }

  customerProductsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: products.map(p => p.name || p.title || 'Ukendt'),
      datasets: [{
        label: 'Pris',
        data: products.map(p => p.price || 0),
        backgroundColor: 'rgba(59, 130, 246, 0.8)',
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (context) => `${context.raw} kr`
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          grid: { color: 'rgba(255,255,255,0.05)' },
          title: { display: true, text: 'Pris (kr)', color: 'var(--muted)' }
        },
        y: {
          grid: { display: false }
        }
      }
    }
  });
}

/**
 * Change chart period (placeholder for future implementation)
 */
function setCustomerChartPeriod(period) {
  // Update active button
  document.querySelectorAll('#subpage-dashboard .chart-period').forEach(btn => {
    btn.classList.remove('active');
  });
  event?.target?.classList.add('active');

  // TODO: Implement period filtering
  console.log('Set customer chart period:', period);
}

// =====================================================
// FAKTURA PAGE - Invoice Management
// =====================================================

let invoiceHistoryData = [];
let invoiceCurrentPage = 1;
const invoicesPerPage = 10;

// Default subscription plans
let subscriptionPlans = JSON.parse(localStorage.getItem('orderflow_subscription_plans') || 'null') || [
  { id: 'starter', name: 'Starter', price: 299, description: 'Perfekt til sm√• restauranter', features: ['100 SMS/m√•ned', '2 brugere', 'Basis workflow', 'Email support'], popular: false },
  { id: 'professional', name: 'Professional', price: 799, description: 'Den perfekte l√∏sning for voksende restauranter', features: ['500 SMS/m√•ned', '5 brugere', 'AI Workflow', 'Rapporter', 'Email support', 'API adgang'], popular: true },
  { id: 'enterprise', name: 'Enterprise', price: 1499, description: 'For store restaurantk√¶der', features: ['Ubegr√¶nset SMS', 'Ubegr√¶nset brugere', 'AI Workflow Pro', 'Avancerede rapporter', '24/7 Support', 'Dedikeret manager'], popular: false }
];

function loadFakturaPage() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  
  // Version check - regenerate if old version (SMS-pakke update)
  const invoiceVersion = 2; // Increment when invoice structure changes
  if (!restaurant.invoices || restaurant.invoiceVersion !== invoiceVersion) {
    restaurant.invoices = generateDemoInvoices(restaurant);
    restaurant.invoiceVersion = invoiceVersion;
  }
  if (!restaurant.paymentMethod) restaurant.paymentMethod = { type: 'card', last4: '4242', holder: (restaurant.contactPerson || restaurant.contact || 'KORTHOLDER').toUpperCase(), expiry: '12/26' };
  if (!restaurant.subscription) restaurant.subscription = { planId: 'professional', nextBilling: getNextMonthFirst() };
  
  invoiceHistoryData = restaurant.invoices;
  invoiceCurrentPage = 1;
  
  updateUpcomingInvoice(restaurant);
  updatePaymentMethodDisplay(restaurant);
  renderInvoiceHistory();
}

function generateDemoInvoices(restaurant) {
  const invoices = [];
  const today = new Date();
  for (let i = 0; i < 12; i++) {
    const invoiceDate = new Date(today.getFullYear(), today.getMonth() - i, 1);
    const dueDate = new Date(invoiceDate); dueDate.setDate(dueDate.getDate() + 14);
    
    // Generate realistic line items matching Python wrapper structure
    const smsCount = Math.floor(Math.random() * 3) + 1;
    const extraUsers = Math.floor(Math.random() * 5);
    const apiCalls = Math.floor(Math.random() * 20000);
    
    const lines = [
      { description: 'OrderFlow Professional - M√•nedligt abonnement', quantity: 1, unit: 'm√•ned', price: 799 }
    ];
    
    if (smsCount > 0) {
      lines.push({ description: 'SMS-pakke (1.000 stk.)', quantity: smsCount, unit: 'pakke', price: 249 });
    }
    if (extraUsers > 0) {
      lines.push({ description: 'Ekstra brugerkonti', quantity: extraUsers, unit: 'stk', price: 49 });
    }
    if (apiCalls > 10000) {
      lines.push({ description: 'API-kald overskridelse', quantity: apiCalls - 10000, unit: 'kald', price: 0.02 });
    }
    
    // Calculate totals
    const subtotal = lines.reduce((sum, line) => sum + (line.quantity * line.price), 0);
    const vat = Math.round(subtotal * 0.25 * 100) / 100;
    
    invoices.push({
      id: `INV-${invoiceDate.getFullYear()}-${String(invoiceDate.getMonth() + 1).padStart(2, '0')}${String(Math.floor(Math.random() * 90) + 10)}`,
      number: `${invoiceDate.getFullYear()}-${String(1000 + i + 42).slice(-4)}`,
      date: invoiceDate.toISOString().split('T')[0],
      dueDate: dueDate.toISOString().split('T')[0],
      month: invoiceDate.toLocaleDateString('da-DK', { month: 'long', year: 'numeric' }),
      subtotal: Math.round(subtotal * 100) / 100,
      vat: vat,
      total: Math.round((subtotal + vat) * 100) / 100,
      lines: lines,
      paymentTerms: 'Netto 14 dage',
      orderReference: i < 3 ? `PO-${invoiceDate.getFullYear()}-${String(100 + i).padStart(3, '0')}` : null,
      status: i === 0 ? 'pending' : 'paid'
    });
  }
  return invoices;
}

function getNextMonthFirst() {
  const today = new Date();
  return new Date(today.getFullYear(), today.getMonth() + 1, 1).toISOString().split('T')[0];
}

function updateUpcomingInvoice(restaurant) {
  const plan = subscriptionPlans.find(p => p.id === restaurant.subscription?.planId) || subscriptionPlans[1];
  const subtotal = plan.price + 249 + 98; // SMS-pakke (1.000 stk.) 249 DKK + Ekstra brugere 98 DKK
  const vat = Math.round(subtotal * 0.25 * 100) / 100;
  const nextMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 1);
  document.getElementById('upcoming-invoice-number').textContent = `2025-${String(restaurant.invoices?.length + 43 || 43).padStart(4, '0')}`;
  document.getElementById('upcoming-invoice-period').textContent = nextMonth.toLocaleDateString('da-DK', { month: 'long', year: 'numeric' });
  document.getElementById('upcoming-invoice-date').textContent = formatDateDK(nextMonth);
  document.getElementById('upcoming-invoice-due').textContent = formatDateDK(new Date(nextMonth.getTime() + 14*24*60*60*1000));
  document.getElementById('upcoming-invoice-subtotal').textContent = formatCurrencyDK(subtotal);
  document.getElementById('upcoming-invoice-vat').textContent = formatCurrencyDK(vat);
  document.getElementById('upcoming-invoice-total').textContent = formatCurrencyDK(subtotal + vat);
}

function updatePaymentMethodDisplay(restaurant) {
  const pm = restaurant.paymentMethod;
  document.getElementById('payment-card-number').textContent = `‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${pm.last4}`;
  document.getElementById('payment-card-holder').textContent = pm.holder;
  document.getElementById('payment-card-expiry').textContent = pm.expiry;
}

function renderInvoiceHistory() {
  const container = document.getElementById('invoice-history-list');
  const searchTerm = document.getElementById('invoice-search')?.value?.toLowerCase() || '';
  let filtered = searchTerm ? invoiceHistoryData.filter(inv => inv.number.toLowerCase().includes(searchTerm) || inv.month.toLowerCase().includes(searchTerm)) : invoiceHistoryData;
  const start = (invoiceCurrentPage - 1) * invoicesPerPage;
  const paginated = filtered.slice(start, start + invoicesPerPage);
  container.innerHTML = paginated.map(inv => `
    <div style="display:grid;grid-template-columns:1fr 100px 120px 120px 80px;gap:16px;padding:14px 16px;border-bottom:1px solid var(--border);align-items:center;font-size:13px">
      <span style="font-weight:500">${inv.month}</span>
      <span style="color:var(--muted)">${formatDateDK(new Date(inv.date))}</span>
      <span style="font-family:monospace;color:var(--accent)">${inv.number}</span>
      <span style="text-align:right;font-weight:500">${formatCurrencyDK(inv.total)}</span>
      <div style="text-align:center"><button class="btn btn-secondary btn-sm" onclick="downloadInvoicePDF('${inv.number}')" title="Eksporter PDF">‚Üì</button></div>
    </div>
  `).join('');
  document.getElementById('invoice-count-label').textContent = `Viser ${start + 1}-${Math.min(start + invoicesPerPage, filtered.length)} af ${filtered.length} fakturaer`;
  document.getElementById('invoice-prev-btn').disabled = invoiceCurrentPage <= 1;
  document.getElementById('invoice-next-btn').disabled = start + invoicesPerPage >= filtered.length;
}

function filterInvoiceHistory() { invoiceCurrentPage = 1; renderInvoiceHistory(); }
function prevInvoicePage() { if (invoiceCurrentPage > 1) { invoiceCurrentPage--; renderInvoiceHistory(); } }
function nextInvoicePage() { invoiceCurrentPage++; renderInvoiceHistory(); }
function formatDateDK(date) { if (typeof date === 'string') date = new Date(date); return date.toLocaleDateString('da-DK', { day: '2-digit', month: '2-digit', year: 'numeric' }); }
function formatCurrencyDK(amount) { return amount.toLocaleString('da-DK', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' DKK'; }

async function downloadInvoicePDF(invoiceNumber) {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  const invoice = restaurant?.invoices?.find(inv => inv.number === invoiceNumber);
  if (!invoice) { toast('Faktura ikke fundet', 'error'); return; }
  toast('Genererer faktura PDF...', 'info');
  
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
    
    // ============ COLORS (matching Python wrapper exactly) ============
    const PRIMARY_COLOR = [26, 26, 46];     // #1a1a2e
    const MEDIUM_GRAY = [224, 224, 224];    // #e0e0e0
    const LIGHT_GRAY = [248, 249, 250];     // #f8f9fa
    const TEXT_COLOR = [51, 51, 51];        // #333333
    
    // ============ PLATFORM INFO (from Python PlatformInfo dataclass) ============
    const platform = {
      company_name: 'OrderFlow ApS',
      address: 'Vestergade 12',
      postal_city: '2100 K√∏benhavn √ò',
      cvr: '12345678',
      phone: '+45 70 20 30 40',
      email: 'faktura@orderflow.dk',
      website: 'www.orderflow.dk',
      bank_name: 'Danske Bank',
      bank_reg: '1234',
      bank_account: '12345678'
    };
    
    // ============ PAGE DIMENSIONS (matching Python: A4, 20mm margins) ============
    const pageWidth = 210;   // A4 width in mm
    const pageHeight = 297;  // A4 height in mm
    const margin = 20;
    const contentWidth = pageWidth - 2 * margin;  // 170mm
    
    // ============ HEADER - Left: Company Info ============
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(...TEXT_COLOR);
    doc.text(platform.company_name, margin, 25);
    
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text(`${platform.address}, ${platform.postal_city}`, margin, 31);
    doc.text(`CVR: DK ${platform.cvr} | Tlf: ${platform.phone}`, margin, 36);
    doc.text(platform.email, margin, 41);
    
    // ============ HEADER - Right: FAKTURA Title ============
    doc.setFontSize(24);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(...PRIMARY_COLOR);
    doc.text('FAKTURA', pageWidth - margin, 25, { align: 'right' });
    
    doc.setFontSize(11);
    doc.text(`Nr. ${invoice.number}`, pageWidth - margin, 33, { align: 'right' });
    
    // ============ HORIZONTAL LINE (1.5pt like Python) ============
    doc.setDrawColor(...PRIMARY_COLOR);
    doc.setLineWidth(0.5);
    doc.line(margin, 46, pageWidth - margin, 46);
    
    // ============ CUSTOMER INFO BOX (Left, Light Gray Background) ============
    // Matching Python: page_width * 0.55, with 3mm padding
    const customerBoxY = 52;
    const customerBoxWidth = contentWidth * 0.55;  // ~93.5mm
    const customerBoxHeight = 38;
    
    doc.setFillColor(...LIGHT_GRAY);
    doc.rect(margin, customerBoxY, customerBoxWidth, customerBoxHeight, 'F');
    
    // Customer info text (with 3mm padding)
    let custY = customerBoxY + 6;
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(...TEXT_COLOR);
    doc.text('Faktureres til:', margin + 3, custY);
    
    // Company name (bold, size 10)
    custY += 6;
    doc.setFontSize(10);
    doc.text(restaurant.name || 'Kunde', margin + 3, custY);
    
    custY += 5;
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    
    // Att: (if contact exists)
    if (restaurant.contactPerson || restaurant.contact) {
      doc.text(`Att: ${restaurant.contactPerson || restaurant.contact}`, margin + 3, custY);
      custY += 5;
    }
    
    // Split address into street and postal/city
    const fullAddress = restaurant.address || 'Adresse ikke angivet';
    const addressParts = fullAddress.split(',').map(p => p.trim());
    
    // Street address
    doc.text(addressParts[0] || fullAddress, margin + 3, custY);
    custY += 5;
    
    // Postal city (if exists after comma)
    if (addressParts[1]) {
      doc.text(addressParts[1], margin + 3, custY);
      custY += 5;
    }
    
    // CVR
    if (restaurant.cvr) {
      doc.text(`CVR: ${restaurant.cvr}`, margin + 3, custY);
    }
    
    // ============ INVOICE DATES (Right Side - on same line as labels) ============
    const datesRightX = pageWidth - margin;
    let dateY = customerBoxY + 6;
    
    doc.setFontSize(9);
    
    // Fakturadato
    doc.setFont('helvetica', 'bold');
    doc.text('Fakturadato:', margin + customerBoxWidth + 5, dateY);
    doc.setFont('helvetica', 'normal');
    doc.text(formatDateDK(new Date(invoice.date)), datesRightX, dateY, { align: 'right' });
    
    // Forfaldsdato
    dateY += 6;
    doc.setFont('helvetica', 'bold');
    doc.text('Forfaldsdato:', margin + customerBoxWidth + 5, dateY);
    doc.setFont('helvetica', 'normal');
    doc.text(formatDateDK(new Date(invoice.dueDate)), datesRightX, dateY, { align: 'right' });
    
    // Betaling
    dateY += 6;
    doc.setFont('helvetica', 'bold');
    doc.text('Betaling:', margin + customerBoxWidth + 5, dateY);
    doc.setFont('helvetica', 'normal');
    doc.text(invoice.paymentTerms || 'Netto 14 dage', datesRightX, dateY, { align: 'right' });
    
    // Deres ref. (if exists)
    if (invoice.orderReference) {
      dateY += 6;
      doc.setFont('helvetica', 'bold');
      doc.text('Deres ref.:', margin + customerBoxWidth + 5, dateY);
      doc.setFont('helvetica', 'normal');
      doc.text(invoice.orderReference, datesRightX, dateY, { align: 'right' });
    }
    
    // ============ INVOICE LINES TABLE ============
    let y = customerBoxY + customerBoxHeight + 8;
    
    // Column widths (matching Python: 0.40, 0.12, 0.12, 0.18, 0.18)
    const colWidths = [
      contentWidth * 0.40,  // Beskrivelse
      contentWidth * 0.12,  // Antal
      contentWidth * 0.12,  // Enhed
      contentWidth * 0.18,  // Enhedspris
      contentWidth * 0.18   // Bel√∏b
    ];
    
    // Table Header (dark background)
    doc.setFillColor(...PRIMARY_COLOR);
    doc.rect(margin, y, contentWidth, 10, 'F');
    
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    
    let colX = margin + 3;
    doc.text('Beskrivelse', colX, y + 7);
    colX = margin + colWidths[0];
    doc.text('Antal', colX + colWidths[1] - 3, y + 7, { align: 'right' });
    colX += colWidths[1];
    doc.text('Enhed', colX + colWidths[2] - 3, y + 7, { align: 'right' });
    colX += colWidths[2];
    doc.text('Enhedspris', colX + colWidths[3] - 3, y + 7, { align: 'right' });
    doc.text('Bel√∏b', pageWidth - margin - 3, y + 7, { align: 'right' });
    
    y += 14;
    
    // Table Rows
    doc.setTextColor(...TEXT_COLOR);
    doc.setFont('helvetica', 'normal');
    
    const lines = invoice.lines || [
      { description: 'OrderFlow Abonnement', quantity: 1, unit: 'm√•ned', price: invoice.subtotal || 799 }
    ];
    
    lines.forEach((line, index) => {
      const qty = line.quantity || 1;
      const unitPrice = line.price || line.unit_price || 0;
      const lineTotal = qty * unitPrice;
      
      // Format quantity (integer or 2 decimals)
      const qtyStr = qty === Math.floor(qty) ? String(qty) : qty.toFixed(2).replace('.', ',');
      
      colX = margin + 3;
      doc.text(line.description || 'Linje', colX, y);
      
      colX = margin + colWidths[0];
      doc.text(qtyStr, colX + colWidths[1] - 3, y, { align: 'right' });
      
      colX += colWidths[1];
      doc.text(line.unit || 'stk', colX + colWidths[2] - 3, y, { align: 'right' });
      
      colX += colWidths[2];
      doc.text(formatCurrencyDKShort(unitPrice), colX + colWidths[3] - 3, y, { align: 'right' });
      
      doc.text(formatCurrencyDKShort(lineTotal), pageWidth - margin - 3, y, { align: 'right' });
      
      // Line separator (gray, 0.5pt)
      y += 3;
      doc.setDrawColor(...MEDIUM_GRAY);
      doc.setLineWidth(0.2);
      doc.line(margin, y, pageWidth - margin, y);
      
      y += 5;
    });
    
    // Final line under last row (darker, PRIMARY_COLOR)
    doc.setDrawColor(...PRIMARY_COLOR);
    doc.setLineWidth(0.4);
    doc.line(margin, y - 5, pageWidth - margin, y - 5);
    
    // ============ TOTALS (Right Aligned, matching Python layout) ============
    y += 6;
    const totalsLabelX = pageWidth - margin - 75;
    const totalsValueX = pageWidth - margin - 3;
    
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('Subtotal ekskl. moms:', totalsLabelX, y);
    doc.text(formatCurrencyDK(invoice.subtotal), totalsValueX, y, { align: 'right' });
    
    y += 6;
    doc.text('Moms 25%:', totalsLabelX, y);
    doc.text(formatCurrencyDK(invoice.vat), totalsValueX, y, { align: 'right' });
    
    // Line above total
    y += 2;
    doc.setDrawColor(...PRIMARY_COLOR);
    doc.setLineWidth(0.4);
    doc.line(totalsLabelX - 5, y, pageWidth - margin, y);
    
    // Total row with background
    y += 1;
    doc.setFillColor(...LIGHT_GRAY);
    doc.rect(totalsLabelX - 5, y, 80, 9, 'F');
    
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text('Total inkl. moms:', totalsLabelX, y + 6);
    doc.text(formatCurrencyDK(invoice.total), totalsValueX, y + 6, { align: 'right' });
    
    // ============ PAYMENT INFO BOX (Bottom Left, matching Python exactly) ============
    // Python: box_y = 20mm from bottom, box_height = 22mm, box_width = page_width * 0.55
    const paymentBoxY = pageHeight - 42;  // 20mm + 22mm from bottom
    const paymentBoxHeight = 22;
    const paymentBoxWidth = contentWidth * 0.55;
    
    doc.setFillColor(...LIGHT_GRAY);
    doc.rect(margin, paymentBoxY, paymentBoxWidth, paymentBoxHeight, 'F');
    
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(...TEXT_COLOR);
    doc.text('Betalingsoplysninger', margin + 3, paymentBoxY + 5);
    
    doc.setFont('helvetica', 'normal');
    doc.text(`${platform.bank_name} | Reg: ${platform.bank_reg} | Konto: ${platform.bank_account}`, margin + 3, paymentBoxY + 11);
    
    // "Anf√∏r fakturanr. XXXX ved betaling" with bold invoice number
    const refPrefix = 'Anf√∏r fakturanr. ';
    const refSuffix = ' ved betaling';
    doc.text(refPrefix, margin + 3, paymentBoxY + 17);
    
    const prefixWidth = doc.getStringUnitWidth(refPrefix) * 9 / doc.internal.scaleFactor;
    doc.setFont('helvetica', 'bold');
    doc.text(invoice.number, margin + 3 + prefixWidth, paymentBoxY + 17);
    
    const numWidth = doc.getStringUnitWidth(invoice.number) * 9 / doc.internal.scaleFactor;
    doc.setFont('helvetica', 'normal');
    doc.text(refSuffix, margin + 3 + prefixWidth + numWidth, paymentBoxY + 17);
    
    // ============ FOOTER (matching Python exactly) ============
    const footerLineY = pageHeight - 15;
    
    // Thin line above footer
    doc.setDrawColor(...MEDIUM_GRAY);
    doc.setLineWidth(0.2);
    doc.line(margin, footerLineY, pageWidth - margin, footerLineY);
    
    // Company info line
    doc.setFontSize(7);
    doc.setTextColor(128, 128, 128);
    const footerText = `${platform.company_name} | ${platform.address}, ${platform.postal_city} | CVR: DK ${platform.cvr} | ${platform.phone} | ${platform.email} | ${platform.website}`;
    doc.text(footerText, pageWidth / 2, footerLineY + 5, { align: 'center' });
    
    // Page number
    doc.setFontSize(8);
    doc.text('Side 1 af 1', pageWidth / 2, footerLineY + 10, { align: 'center' });
    
    // ============ SAVE PDF ============
    doc.save(`Faktura_${invoice.number}.pdf`);
    // toast('Faktura downloadet', 'success'); // Removed - unnecessary
    
  } catch (err) { 
    console.error('PDF generation error:', err); 
    toast('Kunne ikke generere PDF: ' + err.message, 'error'); 
  }
}

// Helper function for currency without "DKK" suffix
function formatCurrencyDKShort(amount) {
  return amount.toLocaleString('da-DK', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function editPaymentMethod() { toast('Betalingsmetode redigering kommer snart', 'info'); }
function updatePaymentCard() { toast('Kortopdatering kommer snart', 'info'); }
function exportInvoiceHistory() { toast('Eksport funktion kommer snart', 'info'); }

// =====================================================
// ABONNEMENT PAGE - Subscription Management
// =====================================================

function loadAbonnementPage() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  if (!restaurant.subscription) restaurant.subscription = { planId: 'professional', nextBilling: getNextMonthFirst() };
  const currentPlan = subscriptionPlans.find(p => p.id === restaurant.subscription.planId) || subscriptionPlans[1];
  document.getElementById('current-plan-name').textContent = currentPlan.name;
  document.getElementById('current-plan-desc').textContent = currentPlan.description;
  document.getElementById('current-plan-price').innerHTML = `${currentPlan.price} <span style="font-size:16px;font-weight:400">DKK/md</span>`;
  currentPlan.features.forEach((f, i) => { const el = document.getElementById(`plan-feature-${i + 1}`); if (el) el.textContent = f; });
  document.getElementById('next-billing-date').textContent = new Date(restaurant.subscription.nextBilling).toLocaleDateString('da-DK', { day: 'numeric', month: 'long', year: 'numeric' });
  renderOtherPlans(restaurant.subscription.planId);
}

function renderOtherPlans(currentPlanId) {
  const container = document.getElementById('other-plans-grid');
  container.innerHTML = subscriptionPlans.filter(p => p.id !== currentPlanId).map(plan => `
    <div class="card" style="padding:24px;${plan.popular ? 'border:2px solid var(--accent)' : ''}">
      ${plan.popular ? '<span style="position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:var(--accent);color:#0a0b0d;font-size:11px;font-weight:600;padding:4px 12px;border-radius:20px">POPUL√ÜR</span>' : ''}
      <h4 style="font-size:18px;font-weight:600;margin-bottom:4px">${plan.name}</h4>
      <p style="font-size:13px;color:var(--muted);margin-bottom:16px">${plan.description}</p>
      <div style="font-size:28px;font-weight:700;margin-bottom:16px">${plan.price} <span style="font-size:14px;font-weight:400;color:var(--muted)">DKK/md</span></div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px">${plan.features.map(f => `<div style="display:flex;align-items:center;gap:8px;font-size:13px"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>${f}</div>`).join('')}</div>
      <button class="btn ${plan.popular ? 'btn-primary' : 'btn-secondary'}" style="width:100%" onclick="changePlan('${plan.id}')">Skift til ${plan.name}</button>
    </div>
  `).join('');
}

function changePlan(planId) {
  const plan = subscriptionPlans.find(p => p.id === planId);
  if (!plan) return;
  if (confirm(`Er du sikker p√• du vil skifte til ${plan.name} (${plan.price} DKK/md)?`)) {
    const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
    if (restaurant) { restaurant.subscription.planId = planId; saveRestaurants(); loadAbonnementPage(); toast(`Skiftet til ${plan.name}`, 'success'); }
  }
}

function purchaseAddon(type) {
  const addons = { 'sms': 'Ekstra SMS-pakke (249 DKK)', 'user': 'Ekstra bruger (49 DKK/md)' };
  toast(`${addons[type]} tilf√∏jet til n√¶ste faktura`, 'success');
}

// =====================================================
// SUBSCRIPTION PLAN CONFIGURATION (Settings Admin)
// =====================================================

function renderSubscriptionPlansConfig() {
  const container = document.getElementById('subscription-plans-config');
  if (!container) return;
  
  container.innerHTML = subscriptionPlans.map((plan, index) => `
    <div class="card" style="padding:20px;position:relative;${plan.popular ? 'border:2px solid var(--accent)' : ''}" data-plan-id="${plan.id}">
      ${plan.popular ? '<span style="position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:var(--accent);color:#0a0b0d;font-size:10px;font-weight:600;padding:3px 10px;border-radius:20px">POPUL√ÜR</span>' : ''}
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
        <div>
          <h4 style="font-size:16px;font-weight:600;margin:0">${plan.name}</h4>
          <p style="font-size:12px;color:var(--muted);margin:4px 0 0 0">${plan.description}</p>
        </div>
        <div style="display:flex;gap:4px">
          <button class="btn btn-secondary btn-sm" onclick="editSubscriptionPlan('${plan.id}')" title="Rediger">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          </button>
          <button class="btn btn-secondary btn-sm" onclick="deleteSubscriptionPlan('${plan.id}')" title="Slet" ${subscriptionPlans.length <= 1 ? 'disabled' : ''}>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
          </button>
        </div>
      </div>
      <div style="font-size:24px;font-weight:700;margin-bottom:12px">${plan.price} <span style="font-size:12px;font-weight:400;color:var(--muted)">DKK/md</span></div>
      <div style="display:flex;flex-direction:column;gap:6px;font-size:12px">
        ${plan.features.slice(0, 4).map(f => `
          <div style="display:flex;align-items:center;gap:6px">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
            ${f}
          </div>
        `).join('')}
        ${plan.features.length > 4 ? `<div style="color:var(--muted)">+${plan.features.length - 4} mere...</div>` : ''}
      </div>
      <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
        <label style="display:flex;align-items:center;gap:8px;font-size:12px;cursor:pointer">
          <input type="checkbox" ${plan.popular ? 'checked' : ''} onchange="togglePlanPopular('${plan.id}', this.checked)">
          Mark√©r som popul√¶r
        </label>
      </div>
    </div>
  `).join('');
}

function addSubscriptionPlan() {
  const newPlan = {
    id: 'plan_' + Date.now(),
    name: 'Ny Plan',
    price: 499,
    description: 'Beskrivelse af planen',
    features: ['Feature 1', 'Feature 2', 'Feature 3'],
    popular: false
  };
  
  subscriptionPlans.push(newPlan);
  saveSubscriptionPlans();
  renderSubscriptionPlansConfig();
  editSubscriptionPlan(newPlan.id);
}

function editSubscriptionPlan(planId) {
  const plan = subscriptionPlans.find(p => p.id === planId);
  if (!plan) return;
  
  const html = `
    <div style="display:flex;flex-direction:column;gap:16px">
      <div class="form-group">
        <label class="form-label">Plannavn</label>
        <input type="text" class="input" id="edit-plan-name" value="${plan.name}">
      </div>
      <div class="form-group">
        <label class="form-label">Beskrivelse</label>
        <input type="text" class="input" id="edit-plan-desc" value="${plan.description}">
      </div>
      <div class="form-group">
        <label class="form-label">Pris (DKK/md)</label>
        <input type="number" class="input" id="edit-plan-price" value="${plan.price}">
      </div>
      <div class="form-group">
        <label class="form-label">Features (√©n per linje)</label>
        <textarea class="input" id="edit-plan-features" rows="6" style="resize:vertical">${plan.features.join('\n')}</textarea>
      </div>
      <div style="display:flex;gap:12px;justify-content:flex-end">
        <button class="btn btn-secondary" onclick="closeCustomModal()">Annuller</button>
        <button class="btn btn-primary" onclick="saveEditedPlan('${planId}')">Gem √¶ndringer</button>
      </div>
    </div>
  `;
  
  showCustomModal('Rediger plan: ' + plan.name, html);
}

function saveEditedPlan(planId) {
  const plan = subscriptionPlans.find(p => p.id === planId);
  if (!plan) return;
  
  plan.name = document.getElementById('edit-plan-name').value;
  plan.description = document.getElementById('edit-plan-desc').value;
  plan.price = parseInt(document.getElementById('edit-plan-price').value) || 0;
  plan.features = document.getElementById('edit-plan-features').value.split('\n').filter(f => f.trim());
  
  saveSubscriptionPlans();
  renderSubscriptionPlansConfig();
  closeCustomModal();
  toast('Plan opdateret', 'success');
}

function deleteSubscriptionPlan(planId) {
  if (subscriptionPlans.length <= 1) {
    toast('Der skal v√¶re mindst √©n plan', 'error');
    return;
  }
  
  if (confirm('Er du sikker p√• du vil slette denne plan?')) {
    subscriptionPlans = subscriptionPlans.filter(p => p.id !== planId);
    saveSubscriptionPlans();
    renderSubscriptionPlansConfig();
    toast('Plan slettet', 'success');
  }
}

function togglePlanPopular(planId, isPopular) {
  if (isPopular) {
    subscriptionPlans.forEach(p => p.popular = false);
  }
  const plan = subscriptionPlans.find(p => p.id === planId);
  if (plan) {
    plan.popular = isPopular;
    saveSubscriptionPlans();
    renderSubscriptionPlansConfig();
  }
}

function saveSubscriptionPlans() {
  localStorage.setItem('orderflow_subscription_plans', JSON.stringify(subscriptionPlans));
}

function saveBillingSettings() {
  const settings = {
    paymentTerms: document.getElementById('default-payment-terms')?.value || '14',
    vatRate: document.getElementById('default-vat-rate')?.value || '25'
  };
  localStorage.setItem('orderflow_billing_settings', JSON.stringify(settings));
  // toast('Faktureringsindstillinger gemt', 'success'); // Removed - unnecessary
}

function savePlatformBillingInfo() {
  const info = {
    company: document.getElementById('platform-company')?.value || 'OrderFlow ApS',
    cvr: document.getElementById('platform-cvr')?.value || '12345678',
    bankReg: document.getElementById('platform-bank-reg')?.value || '1234',
    bankAccount: document.getElementById('platform-bank-account')?.value || '12345678'
  };
  localStorage.setItem('orderflow_platform_billing', JSON.stringify(info));
  // toast('Platforminfo gemt', 'success'); // Removed - unnecessary
}

function showCustomModal(title, content) {
  let modal = document.getElementById('custom-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'custom-modal';
    modal.className = 'modal-overlay';
    modal.innerHTML = `
      <div class="modal" style="max-width:500px">
        <div class="modal-header">
          <h3 id="custom-modal-title"></h3>
          <button class="modal-close" onclick="closeCustomModal()">&times;</button>
        </div>
        <div class="modal-body" id="custom-modal-body"></div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  document.getElementById('custom-modal-title').textContent = title;
  document.getElementById('custom-modal-body').innerHTML = content;
  modal.classList.add('active');
}

function closeCustomModal() {
  const modal = document.getElementById('custom-modal');
  if (modal) modal.classList.remove('active');
}

// =====================================================
// PRODUKTER PAGE - Menu Management
// =====================================================

let currentProductFilter = null;

function loadProductsPage() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  
  // Initialize products array if not exists
  if (!restaurant.products) {
    restaurant.products = [];
  }
  if (!restaurant.productCategories) {
    restaurant.productCategories = ['Pizza', 'Pasta', 'Burger', 'Salat', 'Drikkevarer', 'Tilbeh√∏r'];
  }
  if (!restaurant.deliveryZones) {
    restaurant.deliveryZones = [];
  }
  if (!restaurant.extras) {
    restaurant.extras = [];
  }
  
  renderProductCategories(restaurant);
  renderProducts(restaurant);
  renderDeliveryZones(restaurant);
  renderExtras(restaurant);
  updateProductCount(restaurant);
}

function renderProductCategories(restaurant) {
  const container = document.getElementById('product-categories');
  const filterContainer = document.getElementById('product-category-filters');
  if (!container || !filterContainer) return;
  
  const categories = restaurant.productCategories || [];
  
  // Render category tags
  container.innerHTML = categories.map((cat, idx) => `
    <div class="tag" style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--bg3);border-radius:var(--radius-full);font-size:12px">
      ${cat}
      <button onclick="removeProductCategory(${idx})" style="background:none;border:none;cursor:pointer;opacity:0.5;padding:0;line-height:1" title="Fjern kategori">√ó</button>
    </div>
  `).join('');
  
  // Render filter buttons
  filterContainer.innerHTML = `
    <button class="btn btn-secondary btn-sm ${!currentProductFilter ? 'active' : ''}" onclick="filterProductsByCategory(null)" data-category="all">Alle</button>
    ${categories.map(cat => `
      <button class="btn btn-secondary btn-sm ${currentProductFilter === cat ? 'active' : ''}" onclick="filterProductsByCategory('${cat}')">${cat}</button>
    `).join('')}
  `;
}

function addProductCategory() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  
  const name = prompt('Navn p√• ny kategori:');
  if (!name || name.trim() === '') return;
  
  if (!restaurant.productCategories) {
    restaurant.productCategories = [];
  }
  
  if (restaurant.productCategories.includes(name.trim())) {
    toast('Kategori findes allerede', 'error');
    return;
  }
  
  restaurant.productCategories.push(name.trim());
  renderProductCategories(restaurant);
  markProductsUnsaved();
  toast('Kategori tilf√∏jet', 'success');
}

function removeProductCategory(idx) {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant || !restaurant.productCategories) return;
  
  if (!confirm('Fjern denne kategori?')) return;
  
  restaurant.productCategories.splice(idx, 1);
  renderProductCategories(restaurant);
  markProductsUnsaved();
}

function filterProductsByCategory(category) {
  currentProductFilter = category;
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (restaurant) {
    renderProductCategories(restaurant);
    renderProducts(restaurant);
  }
}

function renderProducts(restaurant) {
  const container = document.getElementById('products-list');
  const emptyState = document.getElementById('products-empty');
  if (!container) return;

  let products = restaurant.products || [];

  // Apply filter
  if (currentProductFilter) {
    products = products.filter(p => p.category === currentProductFilter);
  }

  // Apply category filter (multi-select)
  const selectedCategories = getCategoryFilters(restaurant.id);
  if (selectedCategories.length > 0) {
    products = products.filter(p => selectedCategories.includes(p.category));
  }

  // Apply search
  const searchTerm = document.getElementById('product-search')?.value?.toLowerCase() || '';
  if (searchTerm) {
    products = products.filter(p =>
      p.name.toLowerCase().includes(searchTerm) ||
      p.number?.toString().includes(searchTerm) ||
      p.category?.toLowerCase().includes(searchTerm)
    );
  }
  
  if (products.length === 0) {
    container.innerHTML = '';
    if (emptyState) emptyState.style.display = 'block';
    return;
  }
  
  if (emptyState) emptyState.style.display = 'none';
  
  container.innerHTML = products.map((product, idx) => {
    const originalIdx = restaurant.products.indexOf(product);
    const categoryName = product.category || 'Ingen kategori';

    return `
    <div style="display:grid;grid-template-columns:60px 2fr 1.5fr 1fr 80px;gap:var(--space-3);padding:12px 16px;background:var(--bg);border-bottom:1px solid var(--border);align-items:center">
      <div style="width:32px;height:32px;background:var(--bg3);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:12px;color:var(--muted)">${product.number || idx + 1}</div>
      <div style="font-weight:500;font-size:14px">${product.name}</div>
      <div style="font-size:12px;color:var(--muted)">${categoryName}</div>
      <div style="font-weight:600;color:var(--accent);text-align:right">${product.price || '0'} kr</div>
      <div style="display:flex;gap:4px;justify-content:flex-end">
        <button class="btn btn-secondary btn-sm" onclick="editProduct(${originalIdx})" title="Rediger">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <button class="btn btn-secondary btn-sm" onclick="deleteProduct(${originalIdx})" title="Slet" style="color:var(--danger)">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        </button>
      </div>
    </div>
  `;
  }).join('');
}

function filterProducts() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (restaurant) {
    renderProducts(restaurant);
  }
}

function updateProductCount(restaurant) {
  const countEl = document.getElementById('product-count');
  if (countEl) {
    const count = restaurant.products?.length || 0;
    countEl.textContent = `${count} produkt${count !== 1 ? 'er' : ''}`;
  }
}

function showAddProductModal() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  
  const categories = restaurant.productCategories || [];
  const nextNumber = (restaurant.products?.length || 0) + 1;
  
  const modal = document.createElement('div');
  modal.id = 'product-modal';
  modal.className = 'modal active';
  modal.innerHTML = `
    <div class="modal-content" style="max-width:500px">
      <div class="modal-header">
        <h3>Tilf√∏j produkt</h3>
        <button class="modal-close" onclick="closeProductModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div style="display:grid;grid-template-columns:80px 1fr;gap:12px;margin-bottom:16px">
          <div class="form-group">
            <label class="form-label">Nr.</label>
            <input type="text" class="input" id="product-number" value="${nextNumber}">
          </div>
          <div class="form-group">
            <label class="form-label">Navn *</label>
            <input type="text" class="input" id="product-name" placeholder="Pizza Margherita">
          </div>
        </div>
        <div class="form-group" style="margin-bottom:16px">
          <label class="form-label">Beskrivelse</label>
          <input type="text" class="input" id="product-description" placeholder="Tomat, mozzarella, basilikum">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
          <div class="form-group">
            <label class="form-label">Kategori</label>
            <select class="input" id="product-category">
              <option value="">V√¶lg kategori...</option>
              ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Pris (kr) *</label>
            <input type="number" class="input" id="product-price" placeholder="89" min="0" step="1">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeProductModal()">Annuller</button>
        <button class="btn btn-primary" onclick="saveProduct()">Tilf√∏j produkt</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  document.getElementById('product-name').focus();
}

function closeProductModal() {
  const modal = document.getElementById('product-modal');
  if (modal) modal.remove();
}

function saveProduct(editIdx = null) {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  
  const number = document.getElementById('product-number').value.trim();
  const name = document.getElementById('product-name').value.trim();
  const description = document.getElementById('product-description').value.trim();
  const category = document.getElementById('product-category').value;
  const price = parseFloat(document.getElementById('product-price').value) || 0;
  
  if (!name) {
    toast('Navn er p√•kr√¶vet', 'error');
    return;
  }
  if (price <= 0) {
    toast('Pris skal v√¶re st√∏rre end 0', 'error');
    return;
  }
  
  const product = {
    id: editIdx !== null ? restaurant.products[editIdx].id : Date.now().toString(),
    number: number,
    name: name,
    description: description,
    category: category,
    price: price
  };
  
  if (!restaurant.products) {
    restaurant.products = [];
  }
  
  if (editIdx !== null) {
    restaurant.products[editIdx] = product;
    showSaveStatus('product-library-save-status', 'saved');
  } else {
    restaurant.products.push(product);
    showSaveStatus('product-library-save-status', 'saved');
  }
  
  closeProductModal();
  renderProducts(restaurant);
  updateProductCount(restaurant);
  markProductsUnsaved();
}

function editProduct(idx) {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant || !restaurant.products || !restaurant.products[idx]) return;
  
  const product = restaurant.products[idx];
  const categories = restaurant.productCategories || [];
  
  const modal = document.createElement('div');
  modal.id = 'product-modal';
  modal.className = 'modal active';
  modal.innerHTML = `
    <div class="modal-content" style="max-width:500px">
      <div class="modal-header">
        <h3>Rediger produkt</h3>
        <button class="modal-close" onclick="closeProductModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div style="display:grid;grid-template-columns:80px 1fr;gap:12px;margin-bottom:16px">
          <div class="form-group">
            <label class="form-label">Nr.</label>
            <input type="text" class="input" id="product-number" value="${product.number || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">Navn *</label>
            <input type="text" class="input" id="product-name" value="${product.name}">
          </div>
        </div>
        <div class="form-group" style="margin-bottom:16px">
          <label class="form-label">Beskrivelse</label>
          <input type="text" class="input" id="product-description" value="${product.description || ''}">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
          <div class="form-group">
            <label class="form-label">Kategori</label>
            <select class="input" id="product-category">
              <option value="">V√¶lg kategori...</option>
              ${categories.map(cat => `<option value="${cat}" ${product.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Pris (kr) *</label>
            <input type="number" class="input" id="product-price" value="${product.price}" min="0" step="1">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeProductModal()">Annuller</button>
        <button class="btn btn-primary" onclick="saveProduct(${idx})">Gem √¶ndringer</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function deleteProduct(idx) {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant || !restaurant.products) return;
  
  if (!confirm('Slet dette produkt?')) return;
  
  restaurant.products.splice(idx, 1);
  renderProducts(restaurant);
  updateProductCount(restaurant);
  markProductsUnsaved();
  toast('Produkt slettet', 'info');
}

// =====================================================
// DELIVERY ZONES
// =====================================================

function renderDeliveryZones(restaurant) {
  const container = document.getElementById('delivery-zones-list');
  const emptyState = document.getElementById('delivery-empty');
  if (!container) return;
  
  const zones = restaurant.deliveryZones || [];
  
  if (zones.length === 0) {
    container.innerHTML = '';
    if (emptyState) emptyState.style.display = 'block';
    return;
  }
  
  if (emptyState) emptyState.style.display = 'none';
  
  container.innerHTML = zones.map((zone, idx) => `
    <div style="display:flex;align-items:center;gap:12px;padding:10px;background:var(--bg);border-radius:var(--radius-sm);margin-bottom:8px">
      <div style="flex:1">
        <div style="font-size:13px;font-weight:500">${zone.name}</div>
        <div style="font-size:11px;color:var(--muted)">${zone.postalCodes || 'Ingen postnumre'}</div>
      </div>
      <div style="font-weight:600;color:var(--accent)">${zone.price} kr</div>
      <button onclick="deleteDeliveryZone(${idx})" style="background:none;border:none;cursor:pointer;opacity:0.5;padding:4px">√ó</button>
    </div>
  `).join('');
}

function addDeliveryZone() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  
  const name = prompt('Zonenavn (f.eks. "Indre by"):');
  if (!name) return;
  
  const postalCodes = prompt('Postnumre (kommasepareret, f.eks. "2100, 2200, 2300"):');
  const price = prompt('Leveringspris (kr):');
  
  if (!restaurant.deliveryZones) {
    restaurant.deliveryZones = [];
  }
  
  restaurant.deliveryZones.push({
    name: name.trim(),
    postalCodes: postalCodes?.trim() || '',
    price: parseFloat(price) || 0
  });
  
  renderDeliveryZones(restaurant);
  markProductsUnsaved();
  toast('Leveringszone tilf√∏jet', 'success');
}

function deleteDeliveryZone(idx) {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant || !restaurant.deliveryZones) return;
  
  restaurant.deliveryZones.splice(idx, 1);
  renderDeliveryZones(restaurant);
  markProductsUnsaved();
}

// =====================================================
// EXTRAS / TILBEH√òR
// =====================================================

function renderExtras(restaurant) {
  const container = document.getElementById('extras-list');
  const emptyState = document.getElementById('extras-empty');
  if (!container) return;
  
  const extras = restaurant.extras || [];
  
  if (extras.length === 0) {
    container.innerHTML = '';
    if (emptyState) emptyState.style.display = 'block';
    return;
  }
  
  if (emptyState) emptyState.style.display = 'none';
  
  container.innerHTML = extras.map((extra, idx) => `
    <div style="display:flex;align-items:center;gap:12px;padding:10px;background:var(--bg);border-radius:var(--radius-sm);margin-bottom:8px">
      <div style="flex:1">
        <div style="font-size:13px;font-weight:500">${extra.name}</div>
        ${extra.applicableTo ? `<div style="font-size:11px;color:var(--muted)">Til: ${extra.applicableTo}</div>` : ''}
      </div>
      <div style="font-weight:600;color:var(--accent)">+${extra.price} kr</div>
      <button onclick="deleteExtra(${idx})" style="background:none;border:none;cursor:pointer;opacity:0.5;padding:4px">√ó</button>
    </div>
  `).join('');
}

function addExtra() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  
  const name = prompt('Tilbeh√∏r navn (f.eks. "Ekstra ost"):');
  if (!name) return;
  
  const price = prompt('Pris (kr):');
  const applicableTo = prompt('G√¶lder for kategorier (valgfrit, f.eks. "Pizza, Burger"):');
  
  if (!restaurant.extras) {
    restaurant.extras = [];
  }
  
  restaurant.extras.push({
    id: Date.now().toString(),
    name: name.trim(),
    price: parseFloat(price) || 0,
    applicableTo: applicableTo?.trim() || ''
  });
  
  renderExtras(restaurant);
  markProductsUnsaved();
  toast('Tilbeh√∏r tilf√∏jet', 'success');
}

function deleteExtra(idx) {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant || !restaurant.extras) return;
  
  restaurant.extras.splice(idx, 1);
  renderExtras(restaurant);
  markProductsUnsaved();
}

// =====================================================
// IMPORT FUNCTIONS
// =====================================================

async function importMenuFromUrl() {
  const url = document.getElementById('product-import-url').value.trim();
  if (!url) {
    toast('Indtast en URL', 'error');
    return;
  }

  const statusEl = document.getElementById('import-status');
  statusEl.style.display = 'block';
  statusEl.innerHTML = '<span style="color:var(--accent)">‚è≥ Henter menu fra hjemmeside...</span>';

  try {
    // Check API key
    if (!CONFIG.OPENAI_API_KEY || CONFIG.OPENAI_API_KEY.includes('YOUR_')) {
      statusEl.innerHTML = '<span style="color:var(--danger)">‚ùå OpenAI API key mangler for URL import</span>';
      return;
    }

    // Step 1: Scrape website content via Supabase Edge Function
    let websiteContent = '';
    try {
      statusEl.innerHTML = '<span style="color:var(--accent)">‚è≥ L√¶ser hjemmeside indhold...</span>';

      // Get Supabase config safely
      if (typeof SupabaseDB !== 'undefined' && SupabaseDB.getConfig) {
        const config = SupabaseDB.getConfig();
        const scrapeResponse = await fetch(`${config.url}/functions/v1/scrape-menu`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${config.key}`
          },
          body: JSON.stringify({ url: url })
        });

        if (scrapeResponse.ok) {
          const scrapeData = await scrapeResponse.json();
          websiteContent = scrapeData.content || '';
        }
      }
    } catch (scrapeErr) {
      console.warn('Scrape fallback - using URL directly:', scrapeErr);
    }

    // Step 2: Parse with AI
    statusEl.innerHTML = '<span style="color:var(--accent)">‚è≥ Analyserer menu med AI...</span>';

    const aiPrompt = websiteContent
      ? `Udtr√¶k ALLE produkter med priser fra dette menukort:\n\n${websiteContent.substring(0, 8000)}`
      : `Hent menukort fra denne hjemmeside og udtr√¶k alle produkter: ${url}\nHvis du ikke kan tilg√• URL'en, generer et realistisk eksempel-menukort baseret p√• restaurantens navn.`;

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          {
            role: 'system',
            content: `Du er en menu-parser. Udtr√¶k ALLE produkter fra menukortet.
Returner KUN et JSON array med produkter i dette format:
[
  {"number": "1", "name": "Pizza Margherita", "description": "Tomat, mozzarella, basilikum", "category": "Pizza", "price": 89}
]
Svar KUN med JSON array, ingen anden tekst.
Priser skal v√¶re tal uden "kr" eller valuta.
G√¶t kategori baseret p√• produktnavn hvis ikke angivet.`
          },
          {
            role: 'user',
            content: aiPrompt
          }
        ],
        max_tokens: 4000,
        temperature: 0.3
      })
    });

    const data = await response.json();
    let products = [];

    try {
      let content = data.choices[0].message.content;
      content = content.replace(/```json\n?/gi, '').replace(/```\n?/gi, '').trim();
      products = JSON.parse(content);
    } catch (e) {
      statusEl.innerHTML = '<span style="color:var(--danger)">‚ùå Kunne ikke parse menu data</span>';
      return;
    }

    if (products.length > 0) {
      const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
      if (restaurant) {
        // Add unique categories
        const newCategories = [...new Set(products.map(p => p.category).filter(Boolean))];
        if (!restaurant.productCategories) restaurant.productCategories = [];
        newCategories.forEach(cat => {
          if (!restaurant.productCategories.includes(cat)) {
            restaurant.productCategories.push(cat);
          }
        });

        // Add products
        if (!restaurant.products) restaurant.products = [];
        products.forEach(p => {
          p.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
          restaurant.products.push(p);
        });

        // Save to Supabase
        if (typeof SupabaseDB !== 'undefined') {
          SupabaseDB.saveMenu(restaurant.id, restaurant.products)
            .catch(err => console.error('Menu save error:', err));
        }

        loadProductsPage();
        markProductsUnsaved();
        statusEl.innerHTML = `<span style="color:var(--accent)">‚úì ${products.length} produkter importeret fra hjemmesiden</span>`;
        toast(`${products.length} produkter importeret`, 'success');
      }
    } else {
      statusEl.innerHTML = '<span style="color:var(--warn)">‚ö†Ô∏è Ingen produkter fundet p√• hjemmesiden</span>';
    }
  } catch (err) {
    console.error('Import error:', err);
    statusEl.innerHTML = `<span style="color:var(--danger)">‚ùå Fejl: ${err.message}</span>`;
  }
}

/**
 * Import menu from restaurant's website (from stamdata)
 * @param {string} websiteUrl - Website URL from stamdata
 * @param {string} restaurantId - Restaurant ID
 * @param {boolean} autoMode - If true, suppress error toasts
 */
async function importMenuFromWebsite(websiteUrl, restaurantId, autoMode = false) {
  if (!websiteUrl) {
    if (!autoMode) toast('Ingen hjemmeside angivet i stamdata', 'warning');
    return [];
  }

  const restaurant = restaurants.find(r => r.id === restaurantId);
  if (!restaurant) return [];

  try {
    // Check API key
    if (!CONFIG.OPENAI_API_KEY || CONFIG.OPENAI_API_KEY.includes('YOUR_')) {
      if (!autoMode) toast('OpenAI API key mangler', 'error');
      return [];
    }

    // Step 1: Fetch website using CORS proxy
    let websiteContent = '';

    // CORS proxy services (fallback chain)
    const CORS_PROXIES = [
      (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
      (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`
    ];

    // Try each proxy until one works
    for (const proxyFn of CORS_PROXIES) {
      if (websiteContent) break;
      try {
        const proxyUrl = proxyFn(websiteUrl);
        console.log('üåê Trying CORS proxy:', proxyUrl);
        const response = await fetch(proxyUrl);
        if (response.ok) {
          websiteContent = await response.text();
          console.log('‚úÖ Successfully fetched website content:', websiteContent.length, 'chars');
        }
      } catch (err) {
        console.warn('Proxy failed, trying next...', err);
      }
    }

    if (!websiteContent) {
      if (!autoMode) toast('Kunne ikke l√¶se hjemmesiden. Pr√∏v igen eller brug "Import fra tekst".', 'warning');
      return [];
    }

    // Step 2: Parse with AI
    console.log('ü§ñ Sending to OpenAI for parsing...', websiteContent.substring(0, 500));
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          {
            role: 'system',
            content: `Du er en menu-parser. Udtr√¶k ALLE produkter med priser fra teksten.
Returner KUN et JSON array: [{"number": "1", "name": "Produkt", "price": 99, "category": "Kategori"}]
G√¶t kategori baseret p√• produktnavn. Priser skal v√¶re tal uden "kr".`
          },
          {
            role: 'user',
            content: websiteContent.substring(0, 10000)
          }
        ],
        max_tokens: 4000
      })
    });

    const aiResult = await response.json();
    console.log('ü§ñ OpenAI response:', aiResult);
    let products = [];

    try {
      let content = aiResult.choices[0].message.content;
      console.log('ü§ñ AI content:', content);
      content = content.replace(/```json\n?/gi, '').replace(/```\n?/gi, '').trim();
      products = JSON.parse(content);
      console.log('‚úÖ Parsed products:', products.length, 'items');
    } catch (e) {
      console.error('Parse error:', e, 'aiResult:', aiResult);
      if (!autoMode) toast('Kunne ikke parse AI svar', 'error');
      return [];
    }

    // Save products
    if (products.length > 0) {
      products.forEach(p => {
        p.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
      });

      if (!restaurant.products) restaurant.products = [];
      restaurant.products.push(...products);

      // Save to Supabase
      if (typeof SupabaseDB !== 'undefined') {
        await SupabaseDB.saveMenu(restaurant.id, restaurant.products);
      }

      toast(`${products.length} produkter importeret fra hjemmeside`, 'success');
    }

    return products;
  } catch (error) {
    console.error('Menu import fejl:', error);
    if (!autoMode) toast('Kunne ikke importere menu', 'error');
    return [];
  }
}

/**
 * Import menu from website URL stored in stamdata
 * Called from "Hent fra Stamdata" button on products page
 */
async function importFromStamdataWebsite() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) {
    toast('V√¶lg en kunde f√∏rst', 'error');
    return;
  }

  const websiteUrl = restaurant.website || restaurant.metadata?.website;
  if (!websiteUrl) {
    toast('Ingen hjemmeside angivet i stamdata. Tilf√∏j website URL under Stamdata f√∏rst.', 'warning');
    return;
  }

  const statusEl = document.getElementById('import-status');
  if (statusEl) {
    statusEl.style.display = 'block';
    statusEl.innerHTML = `<span style="color:var(--accent)">‚è≥ Henter menu fra ${websiteUrl}...</span>`;
  }

  const products = await importMenuFromWebsite(websiteUrl, restaurant.id, false);

  if (statusEl) {
    if (products.length > 0) {
      statusEl.innerHTML = `<span style="color:var(--accent)">‚úì ${products.length} produkter importeret fra hjemmesiden</span>`;
      loadProductsPage();
      markProductsUnsaved();
    } else {
      statusEl.innerHTML = `<span style="color:var(--warn)">‚ö†Ô∏è Ingen produkter fundet p√• ${websiteUrl}</span>`;
    }
  }
}

/**
 * Import menu from uploaded file (PDF or Image)
 * Uses OpenAI Vision API for images, PDF.js + OpenAI for PDFs
 */
async function importMenuFromFile(file) {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) {
    toast('V√¶lg en kunde f√∏rst', 'error');
    return [];
  }

  if (!CONFIG.OPENAI_API_KEY || CONFIG.OPENAI_API_KEY.includes('YOUR_')) {
    toast('OpenAI API key mangler', 'error');
    return [];
  }

  const statusEl = document.getElementById('import-status');
  if (statusEl) {
    statusEl.style.display = 'block';
    statusEl.innerHTML = '<span style="color:var(--accent)">‚è≥ L√¶ser fil...</span>';
  }

  try {
    let products = [];

    if (file.type.startsWith('image/')) {
      // Image file - use OpenAI Vision API
      products = await parseImageMenuWithAI(file);
    } else if (file.type === 'application/pdf') {
      // PDF file - extract text and parse
      products = await parsePDFMenuWithAI(file);
    } else {
      toast('Kun billeder (JPG, PNG) og PDF filer underst√∏ttes', 'warning');
      return [];
    }

    if (products.length > 0) {
      // Add unique IDs
      products.forEach(p => {
        p.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
      });

      // Add to restaurant
      if (!restaurant.products) restaurant.products = [];
      restaurant.products.push(...products);

      // Add categories
      const newCategories = [...new Set(products.map(p => p.category).filter(Boolean))];
      if (!restaurant.productCategories) restaurant.productCategories = [];
      newCategories.forEach(cat => {
        if (!restaurant.productCategories.includes(cat)) {
          restaurant.productCategories.push(cat);
        }
      });

      // Save to Supabase
      if (typeof SupabaseDB !== 'undefined') {
        await SupabaseDB.saveMenu(restaurant.id, restaurant.products);
      }

      loadProductsPage();
      markProductsUnsaved();

      if (statusEl) {
        statusEl.innerHTML = `<span style="color:var(--accent)">‚úì ${products.length} produkter importeret fra fil</span>`;
      }
      toast(`${products.length} produkter importeret`, 'success');
    } else {
      if (statusEl) {
        statusEl.innerHTML = '<span style="color:var(--warn)">‚ö†Ô∏è Ingen produkter fundet i filen</span>';
      }
    }

    return products;
  } catch (error) {
    console.error('File import error:', error);
    if (statusEl) {
      statusEl.innerHTML = `<span style="color:var(--danger)">‚ùå Fejl: ${error.message}</span>`;
    }
    toast('Kunne ikke importere fra fil', 'error');
    return [];
  }
}

/**
 * Parse menu from image using OpenAI Vision API
 */
async function parseImageMenuWithAI(file) {
  // Convert file to base64
  const base64 = await new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });

  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
    },
    body: JSON.stringify({
      model: 'gpt-4o',
      messages: [
        {
          role: 'system',
          content: `Du er en menu-parser. Udtr√¶k ALLE produkter med priser fra billedet.
Returner KUN et JSON array: [{"number": "1", "name": "Produkt", "description": "Beskrivelse", "price": 99, "category": "Kategori"}]
Priser skal v√¶re tal uden "kr". G√¶t kategori baseret p√• produktnavn.`
        },
        {
          role: 'user',
          content: [
            { type: 'text', text: 'Udtr√¶k alle produkter med priser fra dette menukort:' },
            { type: 'image_url', image_url: { url: `data:${file.type};base64,${base64}` } }
          ]
        }
      ],
      max_tokens: 4000
    })
  });

  const data = await response.json();

  try {
    let content = data.choices[0].message.content;
    content = content.replace(/```json\n?/gi, '').replace(/```\n?/gi, '').trim();
    return JSON.parse(content);
  } catch (e) {
    console.error('Parse image menu error:', e);
    return [];
  }
}

/**
 * Parse menu from PDF using text extraction + OpenAI
 */
async function parsePDFMenuWithAI(file) {
  // Use PDF.js to extract text (if available)
  let pdfText = '';

  try {
    // Check if PDF.js is loaded
    if (typeof pdfjsLib !== 'undefined') {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        pdfText += textContent.items.map(item => item.str).join(' ') + '\n';
      }
    } else {
      // Fallback: Read as text (won't work for most PDFs but worth trying)
      pdfText = await file.text();
    }
  } catch (err) {
    console.warn('PDF text extraction failed:', err);
    // If text extraction fails, try using Vision API on first page
    toast('Pr√∏ver billedbaseret analyse af PDF...', 'info');
    return await parseImageMenuWithAI(file);
  }

  if (!pdfText.trim()) {
    toast('Kunne ikke l√¶se tekst fra PDF - pr√∏ver billedanalyse', 'info');
    return await parseImageMenuWithAI(file);
  }

  // Parse extracted text with AI
  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
    },
    body: JSON.stringify({
      model: 'gpt-4o-mini',
      messages: [
        {
          role: 'system',
          content: `Du er en menu-parser. Udtr√¶k ALLE produkter med priser fra PDF-teksten.
Returner KUN et JSON array: [{"number": "1", "name": "Produkt", "description": "Beskrivelse", "price": 99, "category": "Kategori"}]
Priser skal v√¶re tal uden "kr". G√¶t kategori baseret p√• produktnavn.`
        },
        {
          role: 'user',
          content: pdfText.substring(0, 10000)
        }
      ],
      max_tokens: 4000
    })
  });

  const data = await response.json();

  try {
    let content = data.choices[0].message.content;
    content = content.replace(/```json\n?/gi, '').replace(/```\n?/gi, '').trim();
    return JSON.parse(content);
  } catch (e) {
    console.error('Parse PDF menu error:', e);
    return [];
  }
}

/**
 * Handle file input for menu import
 */
function handleMenuFileImport(input) {
  if (input.files && input.files[0]) {
    importMenuFromFile(input.files[0]);
  }
}

async function parseMenuFromText() {
  const text = document.getElementById('product-import-text').value.trim();
  if (!text) {
    toast('Inds√¶t menu tekst f√∏rst', 'error');
    return;
  }
  
  const statusEl = document.getElementById('import-status');
  statusEl.style.display = 'block';
  statusEl.innerHTML = '<span style="color:var(--accent)">‚è≥ Parser menu tekst...</span>';
  
  try {
    // Try AI parsing first
    if (CONFIG.OPENAI_API_KEY && !CONFIG.OPENAI_API_KEY.includes('YOUR_')) {
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
        },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [
            {
              role: 'system',
              content: `Du er en menu-parser. Udtr√¶k produkter fra teksten.
Returner KUN et JSON array med produkter:
[{"number": "1", "name": "...", "description": "...", "category": "...", "price": 89}]
Priser skal v√¶re tal uden "kr". G√¶t kategori baseret p√• produktnavn hvis ikke angivet.
Svar KUN med JSON array.`
            },
            {
              role: 'user',
              content: text
            }
          ],
          max_tokens: 2000,
          temperature: 0.2
        })
      });
      
      const data = await response.json();
      let products = [];
      
      try {
        let content = data.choices[0].message.content;
        content = content.replace(/```json\n?/gi, '').replace(/```\n?/gi, '').trim();
        products = JSON.parse(content);
      } catch (e) {
        // Fall through to regex parsing
      }
      
      if (products.length > 0) {
        importParsedProducts(products, statusEl);
        return;
      }
    }
    
    // Fallback: Simple regex parsing
    const products = parseMenuWithRegex(text);
    if (products.length > 0) {
      importParsedProducts(products, statusEl);
    } else {
      statusEl.innerHTML = '<span style="color:var(--warn)">‚ö†Ô∏è Kunne ikke finde produkter. Pr√∏v format: "1. Pizza Margherita - 89 kr"</span>';
    }
  } catch (err) {
    console.error('Parse error:', err);
    statusEl.innerHTML = `<span style="color:var(--danger)">‚ùå Fejl: ${err.message}</span>`;
  }
}

function parseMenuWithRegex(text) {
  const products = [];
  const lines = text.split('\n').filter(l => l.trim());
  
  for (const line of lines) {
    // Try various patterns
    // Pattern 1: "1. Pizza Margherita - 89 kr"
    let match = line.match(/^(\d+)[\.\)]\s*(.+?)\s*[-‚Äì]\s*(\d+)\s*(kr|,-)?/i);
    if (match) {
      products.push({
        number: match[1],
        name: match[2].trim(),
        price: parseInt(match[3]),
        category: guessCategory(match[2])
      });
      continue;
    }
    
    // Pattern 2: "Pizza Margherita 89,-"
    match = line.match(/^(.+?)\s+(\d+)\s*(kr|,-)/i);
    if (match) {
      products.push({
        number: (products.length + 1).toString(),
        name: match[1].trim(),
        price: parseInt(match[2]),
        category: guessCategory(match[1])
      });
      continue;
    }
    
    // Pattern 3: "Pizza Margherita: 89"
    match = line.match(/^(.+?):\s*(\d+)/i);
    if (match) {
      products.push({
        number: (products.length + 1).toString(),
        name: match[1].trim(),
        price: parseInt(match[2]),
        category: guessCategory(match[1])
      });
    }
  }
  
  return products;
}

function guessCategory(name) {
  const n = name.toLowerCase();
  if (n.includes('pizza')) return 'Pizza';
  if (n.includes('pasta') || n.includes('spaghetti') || n.includes('lasagne')) return 'Pasta';
  if (n.includes('burger')) return 'Burger';
  if (n.includes('salat')) return 'Salat';
  if (n.includes('sandwich') || n.includes('panini')) return 'Sandwich';
  if (n.includes('suppe')) return 'Suppe';
  if (n.includes('dessert') || n.includes('is') || n.includes('kage')) return 'Dessert';
  if (n.includes('cola') || n.includes('fanta') || n.includes('vand') || n.includes('√∏l') || n.includes('vin')) return 'Drikkevarer';
  if (n.includes('pommes') || n.includes('frites') || n.includes('dip') || n.includes('br√∏d')) return 'Tilbeh√∏r';
  return 'Andet';
}

function importParsedProducts(products, statusEl) {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  
  // Add unique categories
  const newCategories = [...new Set(products.map(p => p.category).filter(Boolean))];
  if (!restaurant.productCategories) restaurant.productCategories = [];
  newCategories.forEach(cat => {
    if (!restaurant.productCategories.includes(cat)) {
      restaurant.productCategories.push(cat);
    }
  });
  
  // Add products with unique IDs
  if (!restaurant.products) restaurant.products = [];
  products.forEach(p => {
    p.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
    restaurant.products.push(p);
  });
  
  loadProductsPage();
  markProductsUnsaved();
  statusEl.innerHTML = `<span style="color:var(--accent)">‚úì ${products.length} produkter importeret</span>`;
  toast(`${products.length} produkter importeret`, 'success');
  
  // Clear textarea
  document.getElementById('product-import-text').value = '';
}

function handleMenuFileUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    const content = e.target.result;
    document.getElementById('product-import-text').value = content;
    toast('Fil indl√¶st - klik "Parse tekst" for at importere', 'info');
  };
  reader.readAsText(file);
}

// =====================================================
// SAVE & SYNC
// =====================================================

function markProductsUnsaved() {
  const statusEl = document.getElementById('products-save-status');
  if (statusEl) {
    statusEl.innerHTML = '<span style="color:var(--warn)">‚óè √Ündringer ikke gemt</span>';
  }
}

function saveProductsExplicit() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  
  // Save to localStorage
  const key = `products_${restaurant.id}`;
  const data = {
    products: restaurant.products || [],
    productCategories: restaurant.productCategories || [],
    deliveryZones: restaurant.deliveryZones || [],
    extras: restaurant.extras || []
  };
  localStorage.setItem(key, JSON.stringify(data));
  
  // Update save status
  const statusEl = document.getElementById('products-save-status');
  if (statusEl) {
    statusEl.innerHTML = '<span style="color:var(--accent)">‚úì Gemt</span>';
  }
  
  // Sync to workflow
  syncProductsToWorkflow();
  
  // toast('Produkter gemt', 'success'); // Removed - unnecessary
}

function syncProductsToWorkflow() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  
  // Update DEMO_MENUS with restaurant products
  const menuKey = restaurant.id;
  
  // Build menu structure for workflow
  const workflowMenu = {
    restaurantId: restaurant.id,
    restaurantName: restaurant.name,
    currency: 'DKK',
    items: (restaurant.products || []).map(p => ({
      id: p.id,
      number: p.number,
      name: p.name,
      description: p.description || '',
      price: p.price,
      category: p.category || 'Andet'
    })),
    extras: restaurant.extras || [],
    deliveryZones: restaurant.deliveryZones || []
  };
  
  // Store in global menus
  if (!window.RESTAURANT_MENUS) {
    window.RESTAURANT_MENUS = {};
  }
  window.RESTAURANT_MENUS[menuKey] = workflowMenu;
  
  // Also update DEMO_MENUS if it's a demo restaurant
  if (DEMO_MENUS && DEMO_MENUS[menuKey]) {
    DEMO_MENUS[menuKey] = workflowMenu;
  }
  
  addLog(`üì¶ Menu synkroniseret: ${workflowMenu.items.length} produkter`, 'success');
  toast('Menu synkroniseret til workflow', 'success');
}

// Load saved products when showing CRM profile
function loadSavedProducts(restaurant) {
  const key = `products_${restaurant.id}`;
  const saved = localStorage.getItem(key);
  
  if (saved) {
    try {
      const data = JSON.parse(saved);
      restaurant.products = data.products || [];
      restaurant.productCategories = data.productCategories || [];
      restaurant.deliveryZones = data.deliveryZones || [];
      restaurant.extras = data.extras || [];
    } catch (e) {
      console.error('Error loading saved products:', e);
    }
  }
}

// ==================== PRODUKTBIBLIOTEK FUNCTIONS ====================

// Toggle product handlinger dropdown
function toggleProductHandlingerDropdown() {
  const dropdown = document.getElementById('product-handlinger-dropdown');
  if (!dropdown) return;

  if (dropdown.style.display === 'none' || dropdown.style.display === '') {
    dropdown.style.display = 'block';
    // Close on outside click
    setTimeout(() => {
      document.addEventListener('click', closeProductHandlingerOnOutsideClick);
    }, 100);
  } else {
    dropdown.style.display = 'none';
    document.removeEventListener('click', closeProductHandlingerOnOutsideClick);
  }
}

function closeProductHandlingerOnOutsideClick(e) {
  const dropdown = document.getElementById('product-handlinger-dropdown');
  const btn = document.getElementById('product-handlinger-btn');
  if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
    dropdown.style.display = 'none';
    document.removeEventListener('click', closeProductHandlingerOnOutsideClick);
  }
}

// Demo version of product handlinger dropdown
function toggleDemoProductHandlingerDropdown() {
  const dropdown = document.getElementById('demo-product-handlinger-dropdown');
  if (!dropdown) return;

  if (dropdown.style.display === 'none' || dropdown.style.display === '') {
    dropdown.style.display = 'block';
    setTimeout(() => {
      document.addEventListener('click', closeDemoProductHandlingerOnOutsideClick);
    }, 100);
  } else {
    dropdown.style.display = 'none';
    document.removeEventListener('click', closeDemoProductHandlingerOnOutsideClick);
  }
}

function closeDemoProductHandlingerOnOutsideClick(e) {
  const dropdown = document.getElementById('demo-product-handlinger-dropdown');
  const btn = document.getElementById('demo-product-handlinger-btn');
  if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
    dropdown.style.display = 'none';
    document.removeEventListener('click', closeDemoProductHandlingerOnOutsideClick);
  }
}

// Navigate to Kategorier page
function navigateToKategorier() {
  showCustomerSubpage('kategorier');
}

// Toggle category filter dropdown
function toggleCategoryFilterDropdown() {
  const dropdown = document.getElementById('category-filter-dropdown');
  if (!dropdown) return;

  if (dropdown.style.display === 'none' || dropdown.style.display === '') {
    // Load categories into dropdown
    renderCategoryFilters();
    dropdown.style.display = 'block';

    // Close on outside click
    setTimeout(() => {
      document.addEventListener('click', closeCategoryFilterOnOutsideClick);
    }, 100);
  } else {
    dropdown.style.display = 'none';
    document.removeEventListener('click', closeCategoryFilterOnOutsideClick);
  }
}

function closeCategoryFilterOnOutsideClick(e) {
  const dropdown = document.getElementById('category-filter-dropdown');
  const btn = document.getElementById('category-filter-btn');
  if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
    dropdown.style.display = 'none';
    document.removeEventListener('click', closeCategoryFilterOnOutsideClick);
  }
}

// Render category filters with checkboxes (MULTI-SELECT)
function renderCategoryFilters() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;

  const container = document.getElementById('category-filter-list');
  if (!container) return;

  const categories = restaurant.productCategories || [];

  // Hvis INGEN kategorier eksisterer - dropdown HELT TOM
  if (categories.length === 0) {
    container.innerHTML = '';
    return;
  }

  // Load saved filter state from localStorage
  const savedFilters = getCategoryFilters(restaurant.id);

  let html = '';

  // "Vis alle" som BUTTON (ikke checkbox) √∏verst
  html += `
    <button class="dropdown-item" onclick="clearAllCategoryFilters()" style="display:flex;align-items:center;gap:8px;width:100%;padding:10px 16px;background:none;border:none;text-align:left;cursor:pointer;font-size:var(--font-size-sm);color:var(--text);font-weight:500">
      Vis alle
    </button>
  `;

  // Separator efter "Vis alle" button
  html += `<hr style="margin:4px 0;border:none;border-top:1px solid var(--border)">`;

  // Alle kategorier med checkboxes (visual feedback via checkbox styling)
  categories.forEach(cat => {
    const isChecked = savedFilters.includes(cat) || savedFilters.length === 0;
    html += `
      <label class="dropdown-item" style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:10px 16px;transition:background 0.15s">
        <input type="checkbox"
               class="category-filter-checkbox"
               data-category="${cat}"
               ${isChecked ? 'checked' : ''}
               onchange="updateCategoryFilter()"
               style="accent-color:var(--accent)">
        <span style="color:${isChecked ? 'var(--accent)' : 'var(--text)'};font-weight:${isChecked ? '500' : '400'}">${cat}</span>
      </label>
    `;
  });

  container.innerHTML = html;
}

// Clear all category filters (for "Vis alle" button)
function clearAllCategoryFilters() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;

  // Clear localStorage
  const key = `category_filters_${restaurant.id}`;
  localStorage.removeItem(key);

  // Re-render dropdown and products
  renderCategoryFilters();
  renderProducts(restaurant);

  // Close dropdown
  toggleCategoryFilterDropdown();
}

// Update category filter when checkbox changes (MULTI-SELECT)
function updateCategoryFilter() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;

  // Get all checked category names (MULTI-SELECT)
  const checkboxes = document.querySelectorAll('.category-filter-checkbox');
  const selectedCategories = Array.from(checkboxes)
    .filter(cb => cb.checked)
    .map(cb => cb.getAttribute('data-category'));

  // Save to localStorage (ARRAY)
  saveCategoryFilters(restaurant.id, selectedCategories);

  // Re-render products with filter
  renderProducts(restaurant);

  // Re-render dropdown to update visual feedback
  renderCategoryFilters();
}

// Get saved category filters from localStorage (PLURAL - returns array)
function getCategoryFilters(restaurantId) {
  const key = `category_filters_${restaurantId}`;
  const saved = localStorage.getItem(key);
  return saved ? JSON.parse(saved) : [];
}

// Save category filters to localStorage (PLURAL - saves array)
function saveCategoryFilters(restaurantId, categoryNames) {
  const key = `category_filters_${restaurantId}`;
  if (!categoryNames || categoryNames.length === 0) {
    localStorage.removeItem(key);
  } else {
    localStorage.setItem(key, JSON.stringify(categoryNames));
  }
}

// Show Bulk Product Modal (placeholder)
function showBulkProductModal() {
  toast('Tilf√∏j samlet produkt modal kommer snart', 'info');
}

// Show Import CSV Modal (placeholder)
function showImportCSVModal() {
  toast('Import CSV modal kommer snart', 'info');
}

// Show Product Sorting Modal (placeholder)
function showProductSortingModal() {
  toast('Produktsortering modal kommer snart', 'info');
}

// Show Add Category Modal
function showAddCategoryModal() {
  const modal = document.getElementById('add-category-modal');
  if (modal) {
    // Reset form
    document.getElementById('category-name').value = '';

    // Populate VAT dropdown with restaurant's momssatser
    const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
    const vatSelect = document.getElementById('category-vat');
    if (vatSelect && restaurant) {
      vatSelect.innerHTML = '<option value="">V√¶lg momssats (valgfri)</option>';
      const vatRates = restaurant.vatRates || [];
      vatRates.forEach(vat => {
        vatSelect.innerHTML += `<option value="${vat.rate}">${vat.name} (${vat.rate}%)</option>`;
      });
    }

    modal.style.display = 'flex';
  }
}

// Close Add Category Modal
function closeAddCategoryModal() {
  const modal = document.getElementById('add-category-modal');
  if (modal) {
    modal.style.display = 'none';
  }
}

// Save Category
async function saveCategory() {
  const nameInput = document.getElementById('category-name');
  const vatSelect = document.getElementById('category-vat');

  const name = nameInput?.value?.trim();
  const vatRate = vatSelect?.value || null;

  if (!name) {
    toast('Kategorinavn er p√•kr√¶vet', 'error');
    return;
  }

  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) {
    toast('Ingen restaurant valgt', 'error');
    return;
  }

  // Initialize productCategories if not exists
  if (!restaurant.productCategories) {
    restaurant.productCategories = [];
  }

  // Check for duplicate
  if (restaurant.productCategories.includes(name)) {
    toast('Kategori eksisterer allerede', 'error');
    return;
  }

  // Add category
  restaurant.productCategories.push(name);

  // Save to Supabase
  try {
    await SupabaseDB.updateRestaurant(restaurant.id, {
      product_categories: restaurant.productCategories
    });

    toast('Kategori tilf√∏jet', 'success');
    closeAddCategoryModal();

    // Re-render categories table
    renderCategoriesTable();
  } catch (err) {
    console.error('Error saving category:', err);
    toast('Fejl ved gem af kategori', 'error');
  }
}

// Render Categories Table
function renderCategoriesTable() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;

  const tableBody = document.getElementById('categories-table-body');
  const emptyState = document.getElementById('categories-empty');

  if (!tableBody) return;

  const categories = restaurant.productCategories || [];

  if (categories.length === 0) {
    tableBody.innerHTML = '';
    if (emptyState) emptyState.style.display = 'block';
    return;
  }

  if (emptyState) emptyState.style.display = 'none';

  let html = '';
  categories.forEach((cat, index) => {
    html += `
      <div style="display:grid;grid-template-columns:2fr 1fr 100px;gap:var(--space-3);padding:14px 16px;border-bottom:1px solid var(--border);align-items:center">
        <span style="font-weight:500">${cat}</span>
        <span style="text-align:right;color:var(--muted)">-</span>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn btn-secondary btn-sm" onclick="deleteCategory('${cat}')" title="Slet kategori">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
          </button>
        </div>
      </div>
    `;
  });

  tableBody.innerHTML = html;
}

// Delete Category
async function deleteCategory(categoryName) {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant || !restaurant.productCategories) return;

  if (!confirm(`Er du sikker p√• at du vil slette kategorien "${categoryName}"?`)) {
    return;
  }

  // Remove category from array
  restaurant.productCategories = restaurant.productCategories.filter(c => c !== categoryName);

  // Save to Supabase
  try {
    await SupabaseDB.updateRestaurant(restaurant.id, {
      product_categories: restaurant.productCategories
    });

    toast('Kategori slettet', 'success');
    renderCategoriesTable();

    // Also re-render category filters in case dropdown is open
    renderCategoryFilters();
  } catch (err) {
    console.error('Error deleting category:', err);
    toast('Fejl ved sletning af kategori', 'error');
  }
}

// Save Product Library
async function saveProductLibrary() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) {
    toast('Ingen restaurant valgt', 'error');
    return;
  }

  try {
    // Get current products from the local restaurant object
    const products = restaurant.menu_items || restaurant.menuItems || [];
    const categories = restaurant.productCategories || [];

    // Save to Supabase
    await SupabaseDB.updateRestaurant(restaurant.id, {
      menu_items: products,
      product_categories: categories
    });

    toast('Produktbibliotek gemt', 'success');
  } catch (err) {
    console.error('Error saving product library:', err);
    toast('Fejl ved gem af produktbibliotek', 'error');
  }
}

// Save Categories Changes
async function saveCategoriesChanges() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) {
    toast('Ingen restaurant valgt', 'error');
    return;
  }

  try {
    const categories = restaurant.productCategories || [];

    // Save to Supabase
    await SupabaseDB.updateRestaurant(restaurant.id, {
      product_categories: categories
    });

    toast('Kategorier gemt', 'success');
  } catch (err) {
    console.error('Error saving categories:', err);
    toast('Fejl ved gem af kategorier', 'error');
  }
}

// ==================== MOMS FUNCTIONS ====================

// Show Add Momssats Modal
function showAddMomssatsModal() {
  const modal = document.getElementById('add-momssats-modal');
  if (modal) {
    // Reset form
    document.getElementById('momssats-name').value = '';
    document.getElementById('momssats-rate').value = '';
    document.getElementById('momssats-description').value = '';

    modal.style.display = 'flex';
    setTimeout(() => document.getElementById('momssats-name').focus(), 100);
  }
}

// Close Add Momssats Modal
function closeAddMomssatsModal() {
  const modal = document.getElementById('add-momssats-modal');
  if (modal) {
    modal.style.display = 'none';
  }
}

// Save Momssats
function saveMomssats() {
  const name = document.getElementById('momssats-name').value.trim();
  const rate = parseFloat(document.getElementById('momssats-rate').value);
  const description = document.getElementById('momssats-description').value.trim();

  // Validation
  if (!name) {
    toast('Indtast et navn til momssatsen', 'error');
    document.getElementById('momssats-name').focus();
    return;
  }

  if (isNaN(rate) || rate < 0 || rate > 100) {
    toast('Indtast en gyldig momssats mellem 0 og 100', 'error');
    document.getElementById('momssats-rate').focus();
    return;
  }

  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;

  // Initialize customVatRates if not exists
  if (!restaurant.customVatRates) {
    restaurant.customVatRates = [];
  }

  // Add new VAT rate
  const newRate = {
    id: Date.now().toString(),
    name: name,
    rate: rate,
    description: description,
    createdAt: new Date().toISOString()
  };

  restaurant.customVatRates.push(newRate);

  // Save to localStorage
  saveRestaurants();

  // Update dropdown
  updateMomssatsDropdown();

  // Close modal
  closeAddMomssatsModal();

  showSaveStatus('moms-save-status', 'saved');
}

// Update Momssats Dropdown
function updateMomssatsDropdown() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;

  const select = document.getElementById('restaurant-moms-rate');
  if (!select) return;

  // Keep default options
  const defaultOptions = `
    <option value="25">25% (Standard)</option>
    <option value="0">0% (Momsfritaget)</option>
  `;

  // Add custom rates
  let customOptions = '';
  if (restaurant.customVatRates && restaurant.customVatRates.length > 0) {
    customOptions = restaurant.customVatRates.map(rate =>
      `<option value="${rate.rate}">${rate.rate}% (${rate.name})</option>`
    ).join('');
  }

  select.innerHTML = defaultOptions + customOptions;
}

// Load KPI data for customer
function loadCustomerKPIData() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  
  // Render heatmap
  renderCustomerHeatmap(restaurant.kpi?.orderHeatmap);
}

// Render customer heatmap
function renderCustomerHeatmap(heatmapData) {
  const container = document.getElementById('customer-heatmap');
  if (!container) return;
  
  if (!heatmapData) {
    container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);font-size:12px">Ingen data tilg√¶ngelig</div>';
    return;
  }
  
  let maxVal = 1;
  Object.values(heatmapData).forEach(dayData => {
    if (Array.isArray(dayData)) {
      dayData.forEach(val => { if (val > maxVal) maxVal = val; });
    }
  });
  
  const hourTotals = new Array(24).fill(0);
  Object.values(heatmapData).forEach(dayData => {
    if (Array.isArray(dayData)) {
      dayData.forEach((val, hour) => { hourTotals[hour] += val; });
    }
  });
  
  container.innerHTML = hourTotals.map((val, hour) => {
    const intensity = val / (maxVal * 7);
    const color = intensity > 0.7 ? 'var(--green)' : intensity > 0.4 ? 'var(--orange)' : intensity > 0.1 ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
    return `<div class="heatmap-bar" style="background:${color};opacity:${0.3 + intensity * 0.7}" title="${hour}:00 - ${val} ordrer"></div>`;
  }).join('');
}

// Show profile view
function showCrmProfileView(id) {
  const restaurant = restaurants.find(r => r.id === id);
  if (!restaurant) {
    toast('Kunde ikke fundet', 'error');
    return;
  }
  
  currentProfileRestaurantId = id;
  const userId = generateUserId(id);
  
  // Load saved products for this restaurant
  loadSavedProducts(restaurant);
  
  // Hide search, show profile
  document.getElementById('crm-search-view').style.display = 'none';
  document.getElementById('crm-profile-view').style.display = 'block';

  // Remove active indicator from Kunder nav button (the green dot)
  document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));

  // Show customer context menu in sidebar
  const contextMenu = document.getElementById('nav-customer-context');
  contextMenu.style.display = 'block';
  document.getElementById('nav-customer-name').textContent = restaurant.name;
  document.getElementById('nav-customer-id').textContent = 'ID: ' + userId;
  document.getElementById('nav-customer-avatar').textContent = restaurant.name.charAt(0).toUpperCase();
  
  // Reset to first subpage (dashboard)
  document.querySelectorAll('.customer-subpage').forEach(sp => sp.classList.remove('active'));
  document.getElementById('subpage-dashboard').classList.add('active');
  document.querySelectorAll('.nav-customer-menu .nav-dropdown-item').forEach((item, i) => {
    item.classList.toggle('active', i === 0);
  });

  // Load customer dashboard
  loadCustomerDashboard(id);
  
  // Update breadcrumb with restaurant name
  updateBreadcrumb('kunder', restaurant.name);
  
  // Populate header
  document.getElementById('profile-logo').innerHTML = getRestaurantLogoSvg(restaurant.logo);
  document.getElementById('profile-name').textContent = restaurant.name;
  document.getElementById('profile-cvr').textContent = restaurant.cvr || '-';
  document.getElementById('profile-userid').textContent = userId;
  
  const statusEl = document.getElementById('profile-status');
  
  // Handle demo customer status
  if (restaurant.isDemo) {
    const demoStatus = getDemoLicenseStatus(restaurant);
    if (demoStatus && demoStatus.isExpired) {
      statusEl.textContent = 'Demo udl√∏bet';
      statusEl.className = 'crm-profile-status demo-expired';
      statusEl.style.background = 'rgba(248,113,113,0.1)';
      statusEl.style.color = 'var(--danger)';
    } else if (demoStatus) {
      statusEl.textContent = `Demo ¬∑ ${demoStatus.daysRemaining} dage`;
      statusEl.className = 'crm-profile-status demo';
      statusEl.style.background = 'rgba(251,191,36,0.1)';
      statusEl.style.color = 'var(--warn)';
    } else {
      statusEl.textContent = 'Demo';
      statusEl.className = 'crm-profile-status demo';
      statusEl.style.background = 'rgba(251,191,36,0.1)';
      statusEl.style.color = 'var(--warn)';
    }
  } else if (restaurant.status === 'active') {
    statusEl.textContent = 'Aktiv';
    statusEl.className = 'crm-profile-status active';
    statusEl.style.background = '';
    statusEl.style.color = '';
  } else if (restaurant.status === 'inactive') {
    statusEl.textContent = 'Inaktiv';
    statusEl.className = 'crm-profile-status pending';
    statusEl.style.background = '';
    statusEl.style.color = '';
  } else if (restaurant.status === 'churned') {
    statusEl.textContent = 'Opsagt';
    statusEl.className = 'crm-profile-status';
    statusEl.style.background = 'rgba(248,113,113,0.1)';
    statusEl.style.color = 'var(--danger)';
  } else if (restaurant.status === 'terminated') {
    statusEl.textContent = 'Opsagt (GDPR)';
    statusEl.className = 'crm-profile-status terminated';
    statusEl.style.background = 'rgba(248,113,113,0.15)';
    statusEl.style.color = 'var(--danger)';
    // Show termination banner
    showTerminationBanner(restaurant);
  } else if (restaurant.status === 'gdpr_deleted') {
    statusEl.textContent = 'GDPR Slettet';
    statusEl.className = 'crm-profile-status gdpr-deleted';
    statusEl.style.background = 'rgba(107,114,128,0.15)';
    statusEl.style.color = 'var(--muted)';
  } else {
    statusEl.textContent = 'Afventer';
    statusEl.className = 'crm-profile-status pending';
    statusEl.style.background = '';
    statusEl.style.color = '';
  }

  // Hide termination banner if not terminated
  if (restaurant.status !== 'terminated') {
    const existingBanner = document.getElementById('termination-banner');
    if (existingBanner) existingBanner.style.display = 'none';
  }

  // Show/hide activate button for pending customers (or undefined/null status)
  const activateBtn = document.getElementById('btn-activate-customer');
  if (activateBtn) {
    // Show activate button if status is 'pending', undefined, null, or empty string
    const canActivate = !restaurant.status || restaurant.status === 'pending';
    activateBtn.style.display = canActivate ? 'flex' : 'none';
  }

  // Show/hide terminate button based on status
  const terminateBtn = document.getElementById('btn-terminate-customer');
  if (terminateBtn) {
    const canTerminate = ['active', 'inactive', 'demo'].includes(restaurant.status);
    terminateBtn.style.display = canTerminate ? 'flex' : 'none';
  }

  // Show demo license banner if demo customer
  let demoBanner = document.getElementById('demo-license-banner');
  if (restaurant.isDemo) {
    const demoStatus = getDemoLicenseStatus(restaurant);
    if (!demoBanner) {
      demoBanner = document.createElement('div');
      demoBanner.id = 'demo-license-banner';
      const profileHeader = document.querySelector('.crm-profile-header');
      if (profileHeader) {
        profileHeader.parentNode.insertBefore(demoBanner, profileHeader.nextSibling);
      }
    }
    
    if (demoStatus && demoStatus.isExpired) {
      demoBanner.className = 'demo-expired-banner';
      demoBanner.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
        <div class="demo-expired-banner-content">
          <h4>Demo-periode udl√∏bet</h4>
          <p>Denne kundes pr√∏veperiode er udl√∏bet. Opgrader til betalt licens for at forts√¶tte.</p>
        </div>
        <button class="btn btn-primary" onclick="upgradeDemoCustomer('${restaurant.id}')">Opgrader kunde</button>
      `;
    } else if (demoStatus) {
      demoBanner.className = 'demo-license-info';
      demoBanner.style.marginBottom = 'var(--space-5)';
      demoBanner.innerHTML = `
        <h4 style="margin-bottom:var(--space-3)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          Demo-licens aktiv
        </h4>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:var(--space-4)">
          <div>
            <div style="font-size:20px;font-weight:600;color:var(--text)">${demoStatus.daysRemaining}</div>
            <div style="font-size:11px;color:var(--muted)">Dage tilbage</div>
          </div>
          <div>
            <div style="font-size:20px;font-weight:600;color:var(--text)">${demoStatus.messagesUsed}/${demoStatus.messagesLimit}</div>
            <div style="font-size:11px;color:var(--muted)">Beskeder brugt</div>
          </div>
          <div>
            <div style="font-size:20px;font-weight:600;color:var(--text)">${demoStatus.expiryDate.toLocaleDateString('da-DK', { day: 'numeric', month: 'short' })}</div>
            <div style="font-size:11px;color:var(--muted)">Udl√∏ber</div>
          </div>
          <div style="display:flex;align-items:center">
            <button class="btn btn-primary btn-sm" onclick="upgradeDemoCustomer('${restaurant.id}')">Opgrader</button>
          </div>
        </div>
      `;
    }
    demoBanner.style.display = 'block';
  } else if (demoBanner) {
    demoBanner.style.display = 'none';
  }
  
  // Populate STAMDATA form
  document.getElementById('stamdata-name').value = restaurant.name || '';
  document.getElementById('stamdata-cvr').value = restaurant.cvr || '';
  document.getElementById('stamdata-owner').value = restaurant.owner || '';
  document.getElementById('stamdata-contact').value = restaurant.contactPerson || '';
  document.getElementById('stamdata-email').value = restaurant.email || '';
  document.getElementById('stamdata-phone').value = restaurant.phone || '';
  document.getElementById('stamdata-industry').value = restaurant.industry || restaurant.metadata?.industry || '';
  document.getElementById('stamdata-address').value = restaurant.address || '';
  document.getElementById('stamdata-country').value = restaurant.country || 'DK';
  document.getElementById('stamdata-website').value = restaurant.website || '';
  document.getElementById('stamdata-created').value = restaurant.createdAt || restaurant.created_at || '-';

  // Populate BETALINGSINTEGRATION
  document.getElementById('stamdata-mobilepay-merchant').value = restaurant.mobilepayMerchantId || '';
  document.getElementById('stamdata-mobilepay-api-key').value = restaurant.mobilepayApiKey || '';
  // Generate callback URL
  const callbackEl = document.getElementById('stamdata-payment-callback');
  if (callbackEl) {
    const supabaseUrl = (typeof SupabaseDB !== 'undefined' && SupabaseDB.getConfig) ? SupabaseDB.getConfig().url : '';
    callbackEl.value = restaurant.id && supabaseUrl ? `${supabaseUrl}/functions/v1/mobilepay-webhook?restaurant=${restaurant.id}` : 'Genereres automatisk';
  }

  // Populate WORKFLOW KONTROL
  document.getElementById('wf-review-enabled').checked = !!(restaurant.googleReviewUrl || restaurant.trustpilotUrl);
  document.getElementById('wf-reorder-enabled').checked = restaurant.reorderEnabled !== false;
  document.getElementById('wf-receipt-enabled').checked = restaurant.receiptEnabled !== false;
  document.getElementById('wf-google-link').value = restaurant.googleReviewUrl || '';
  document.getElementById('wf-trustpilot-link').value = restaurant.trustpilotUrl || '';
  document.getElementById('wf-delivery-enabled').checked = restaurant.deliveryEnabled !== false;
  toggleDeliverySettings();
  
  // Populate opening hours (with defaults if not set)
  const oh = restaurant.openingHours || {};
  const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
  const defaultTimes = {
    mon: { open: '10:00', close: '22:00' },
    tue: { open: '10:00', close: '22:00' },
    wed: { open: '10:00', close: '22:00' },
    thu: { open: '10:00', close: '22:00' },
    fri: { open: '10:00', close: '23:00' },
    sat: { open: '11:00', close: '23:00' },
    sun: { open: '12:00', close: '21:00' }
  };
  
  days.forEach(day => {
    const dayData = oh[day] || defaultTimes[day];
    const enabledEl = document.getElementById(`oh-${day}-enabled`);
    const openEl = document.getElementById(`oh-${day}-open`);
    const closeEl = document.getElementById(`oh-${day}-close`);
    if (enabledEl) enabledEl.checked = dayData.enabled !== false;
    if (openEl) openEl.value = dayData.open || defaultTimes[day].open;
    if (closeEl) closeEl.value = dayData.close || defaultTimes[day].close;
  });
  
  // Delivery settings
  document.getElementById('wf-delivery-from').value = restaurant.deliveryFrom || '18:00';
  document.getElementById('wf-delivery-to').value = restaurant.deliveryTo || '22:00';
  document.getElementById('wf-delivery-time-restricted').checked = restaurant.deliveryTimeRestricted || false;
  
  // Populate BESKEDER (with defaults)
  const msg = restaurant.messages || {};
  const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
  const setChecked = (id, val) => { const el = document.getElementById(id); if (el) el.checked = val; };
  
  // Automation toggle
  setChecked('msg-auto-enabled', msg.autoEnabled || false);
  
  // Workflow Beskeder
  setVal('msg-welcome-text', msg.welcome?.text || 'Hej! Tak for dit opkald til {{restaurant}}. Vi fik desv√¶rre ikke taget telefonen...');
  setVal('msg-pending-text', msg.pending?.text || 'Tak! Din ordre er nu sendt til k√∏kkenet. Afvent venligst, at restauranten accepterer din bestilling. Du modtager en bekr√¶ftelse snarest.');
  setVal('msg-delivery-text', msg.delivery?.text || 'Din ordre er p√• vej! Forventet leveringstid: {{ventetid}} minutter...');
  
  // Ordre Status Beskeder
  setVal('msg-confirmed-text', msg.confirmed?.text || 'Din ordre er bekr√¶ftet! {{restaurant}} har modtaget din bestilling og g√•r straks i gang. Vi sender besked, n√•r maden er klar.');
  setVal('msg-cooking-text', msg.cooking?.text || 'K√∏kkenet er nu g√•et i gang med din bestilling! Din mad er klar om ca. {{ventetid}} minutter.');
  setVal('msg-ready-text', msg.ready?.text || 'Din ordre er nu f√¶rdig og {{leveringstype}}! Velbekomme fra {{restaurant}}!');
  
  // Efter-Ordre Beskeder
  setChecked('msg-review-enabled', msg.review?.enabled !== false);
  setVal('msg-review-text', msg.review?.text || 'Tak for din ordre hos {{restaurant}}! Vi h√•ber du n√∏d maden üòä Del gerne din oplevelse: {{review_link}}');
  setChecked('msg-reorder-enabled', msg.reorder?.enabled || false);
  setVal('msg-reorder-text', msg.reorder?.text || 'Hej {{kunde}}! Det er et stykke tid siden vi har set dig hos {{restaurant}}. Har du lyst til at bestille igen? Svar "JA" for at se din sidste ordre üçï');
  const reorderInterval = document.getElementById('msg-reorder-interval');
  if (reorderInterval) reorderInterval.value = msg.reorder?.interval || '14';
  setChecked('msg-receipt-enabled', msg.receipt?.enabled !== false);
  setVal('msg-receipt-text', msg.receipt?.text || 'KVITTERING - {{restaurant}}\nOrdre: #{{ordre}}\nTotal: {{total}} kr\nDato: {{dato}}\nTak for din ordre!');
  
  // System Beskeder
  setVal('msg-closed-text', msg.closed?.text || 'Tak for din henvendelse! {{restaurant}} har desv√¶rre lukket lige nu. Vores √•bningstider er {{√•bningstider}}. Vi gl√¶der os til at h√∏re fra dig!');
  setVal('msg-error-text', msg.error?.text || 'Beklager, der opstod en fejl. Pr√∏v venligst igen eller ring til os p√• {{telefon}}.');
  
  // Populate N√òGLETAL
  if (restaurant.kpi) {
    document.getElementById('kpi-revenue').textContent = formatCurrency(restaurant.kpi.recoveredRevenue || 0);
    document.getElementById('kpi-ai-rate').textContent = (restaurant.kpi.aiAutomationRate || 0) + '%';
    document.getElementById('kpi-review-rate').textContent = (restaurant.kpi.reviewCTR || 0) + '%';
    document.getElementById('kpi-conversion').textContent = (restaurant.kpi.conversionRate || 0) + '%';
    
    // Reviews
    document.getElementById('review-avg-score').textContent = restaurant.kpi.reviews?.avgRating?.toFixed(1) || '0.0';
    document.getElementById('review-total-count').textContent = restaurant.kpi.reviews?.total || 0;
    document.getElementById('review-stars').innerHTML = renderStars(restaurant.kpi.reviews?.avgRating || 0);
    document.getElementById('google-rating').textContent = restaurant.kpi.reviews?.google?.avgRating?.toFixed(1) || '0.0';
    document.getElementById('google-count').textContent = restaurant.kpi.reviews?.google?.count || 0;
    document.getElementById('trustpilot-rating').textContent = restaurant.kpi.reviews?.trustpilot?.avgRating?.toFixed(1) || '0.0';
    document.getElementById('trustpilot-count').textContent = restaurant.kpi.reviews?.trustpilot?.count || 0;
  }
}

// Render profile heatmap
function renderProfileHeatmap(heatmapData) {
  const container = document.getElementById('profile-heatmap');
  if (!container || !heatmapData) return;
  
  let maxVal = 1;
  Object.values(heatmapData).forEach(dayData => {
    if (Array.isArray(dayData)) {
      dayData.forEach(val => { if (val > maxVal) maxVal = val; });
    }
  });
  
  const hourTotals = new Array(24).fill(0);
  Object.values(heatmapData).forEach(dayData => {
    if (Array.isArray(dayData)) {
      dayData.forEach((val, hour) => { hourTotals[hour] += val; });
    }
  });
  
  container.innerHTML = hourTotals.map((val, hour) => {
    const intensity = val / (maxVal * 7);
    const color = intensity > 0.7 ? 'var(--green)' : intensity > 0.4 ? 'var(--orange)' : intensity > 0.1 ? 'var(--accent)' : 'var(--bg2)';
    return `<div class="crm-heatmap-cell" style="background:${color};opacity:${0.3 + intensity * 0.7}" title="${hour}:00 - ${val} ordrer"></div>`;
  }).join('');
}

// Render stars
function renderStars(rating) {
  const fullStars = Math.floor(rating);
  const hasHalf = rating % 1 >= 0.5;
  let html = '';
  
  for (let i = 0; i < 5; i++) {
    if (i < fullStars) {
      html += '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';
    } else if (i === fullStars && hasHalf) {
      html += '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1" style="opacity:0.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';
    } else {
      html += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="opacity:0.3"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';
    }
  }
  return html;
}

// =====================================================
// CUSTOMER SUB-PAGE FUNCTIONS
// =====================================================

// Save Stamdata
function saveStamdata() {
  if (!currentProfileRestaurantId) return;
  
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  
  // Track changes for activity log
  const oldName = restaurant.name;
  const oldCvr = restaurant.cvr;
  const oldOwner = restaurant.owner;
  const oldContact = restaurant.contactPerson;
  const oldEmail = restaurant.email;
  const oldPhone = restaurant.phone;
  const oldIndustry = restaurant.industry;
  const oldAddress = restaurant.address;
  const oldWebsite = restaurant.website;

  // Update values
  restaurant.name = document.getElementById('stamdata-name')?.value || '';
  restaurant.cvr = document.getElementById('stamdata-cvr')?.value || '';
  restaurant.owner = document.getElementById('stamdata-owner')?.value || '';
  restaurant.contactPerson = document.getElementById('stamdata-contact')?.value || '';
  restaurant.email = document.getElementById('stamdata-email')?.value || '';
  restaurant.phone = document.getElementById('stamdata-phone')?.value || '';
  restaurant.industry = document.getElementById('stamdata-industry')?.value || '';
  restaurant.address = document.getElementById('stamdata-address')?.value || '';
  restaurant.country = document.getElementById('stamdata-country')?.value || 'DK';
  restaurant.website = document.getElementById('stamdata-website')?.value || '';

  // Save MobilePay integration
  restaurant.mobilepayMerchantId = document.getElementById('stamdata-mobilepay-merchant')?.value || '';
  restaurant.mobilepayApiKey = document.getElementById('stamdata-mobilepay-api-key')?.value || '';

  // Log field changes
  const fieldMappings = [
    { field: 'Navn', old: oldName, new: restaurant.name },
    { field: 'CVR', old: oldCvr, new: restaurant.cvr },
    { field: 'Ejer', old: oldOwner, new: restaurant.owner },
    { field: 'Kontaktperson', old: oldContact, new: restaurant.contactPerson },
    { field: 'Email', old: oldEmail, new: restaurant.email },
    { field: 'Telefon', old: oldPhone, new: restaurant.phone },
    { field: 'Branche', old: oldIndustry, new: restaurant.industry },
    { field: 'Adresse', old: oldAddress, new: restaurant.address },
    { field: 'Website', old: oldWebsite, new: restaurant.website }
  ];
  
  const changes = fieldMappings.filter(f => f.old !== f.new && (f.old || f.new));
  
  if (changes.length > 0) {
    changes.forEach(change => {
      logActivity('update', `${change.field} opdateret`, {
        category: 'kunder',
        subCategory: 'stamdata',
        field: change.field,
        oldValue: change.old || '(tom)',
        newValue: change.new || '(tom)',
        restaurantId: restaurant.id,
        restaurantName: restaurant.name
      });
    });
    
    // Log to customer-specific aktivitetslogs
    const changedFields = changes.map(c => c.field).join(', ');
    addCustomerAktivitetslog(restaurant.id, 'profil', `Stamdata opdateret: ${changedFields}`);
  }
  
  // Mark last saved timestamp
  restaurant.stamdataUpdatedAt = new Date().toISOString();
  
  // Update header displays
  document.getElementById('profile-name').textContent = restaurant.name || '-';
  document.getElementById('profile-cvr').textContent = restaurant.cvr || '-';
  document.getElementById('nav-customer-name').textContent = restaurant.name || 'Kunde';
  document.getElementById('nav-customer-avatar').textContent = (restaurant.name || '?').charAt(0).toUpperCase();
  
  // Update CRM table if visible
  updateCrmTableRow(restaurant);
  
  // Persist to localStorage
  persistRestaurants();

  // Show save status
  showSaveStatus('stamdata-save-status', 'saved');
}

// Update CRM table row with new data
function updateCrmTableRow(restaurant) {
  const row = document.querySelector(`tr[data-id="${restaurant.id}"]`);
  if (row) {
    const cells = row.querySelectorAll('td');
    if (cells[1]) cells[1].textContent = restaurant.name || '-';
    if (cells[2]) cells[2].textContent = restaurant.phone || '-';
    if (cells[3]) cells[3].textContent = restaurant.cvr || '-';
  }
}

// Toggle delivery settings visibility
function toggleDeliverySettings() {
  const enabled = document.getElementById('wf-delivery-enabled').checked;
  document.getElementById('delivery-settings').style.display = enabled ? 'block' : 'none';
}

// ============================================================================
// MOBILEPAY INTEGRATION
// ============================================================================

/**
 * Test MobilePay connection
 */
async function testMobilePayConnection() {
  const statusEl = document.getElementById('mobilepay-test-status');
  const merchantId = document.getElementById('stamdata-mobilepay-merchant')?.value;
  const apiKey = document.getElementById('stamdata-mobilepay-api-key')?.value;

  if (!merchantId || !apiKey) {
    statusEl.textContent = '‚ö†Ô∏è Udfyld Merchant ID og API n√∏gle';
    statusEl.style.color = 'var(--warning)';
    return;
  }

  statusEl.textContent = 'Tester forbindelse...';
  statusEl.style.color = 'var(--muted)';

  try {
    // In production, this would make a real API call to MobilePay
    // For now, we validate the format and simulate a check
    const isValidFormat = /^POSDK\d+$/.test(merchantId) || merchantId.length > 5;

    if (isValidFormat && apiKey.length > 10) {
      statusEl.textContent = '‚úÖ Forbindelse OK';
      statusEl.style.color = 'var(--success)';
    } else {
      statusEl.textContent = '‚ùå Ugyldigt format';
      statusEl.style.color = 'var(--danger)';
    }
  } catch (err) {
    statusEl.textContent = '‚ùå Fejl: ' + err.message;
    statusEl.style.color = 'var(--danger)';
  }
}

/**
 * Create a MobilePay payment link for an order
 * @param {Object} order - Order data
 * @param {Object} restaurant - Restaurant with MobilePay credentials
 * @returns {string|null} Payment URL or null if not configured
 */
async function createMobilePayLink(order, restaurant) {
  const merchantId = restaurant.mobilepayMerchantId;
  const apiKey = restaurant.mobilepayApiKey;

  if (!merchantId || !apiKey) {
    console.warn('MobilePay ikke konfigureret for denne restaurant');
    return null;
  }

  try {
    // MobilePay MyShop API endpoint
    // In production, this should go through a Supabase Edge Function for security
    const config = (typeof SupabaseDB !== 'undefined' && SupabaseDB.getConfig) ? SupabaseDB.getConfig() : null;
    if (!config) {
      console.error('Supabase config not available for MobilePay');
      return null;
    }

    const response = await fetch(`${config.url}/functions/v1/create-mobilepay-payment`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${config.key}`
      },
      body: JSON.stringify({
        merchantId: merchantId,
        amount: Math.round(order.total * 100), // MobilePay uses √∏re
        orderId: order.id || Date.now().toString(),
        description: `Ordre #${order.id} - ${restaurant.name}`,
        restaurantId: restaurant.id,
        customerPhone: order.phone
      })
    });

    if (!response.ok) {
      throw new Error('MobilePay API fejl');
    }

    const data = await response.json();
    return data.paymentUrl || data.mobilePayAppRedirectUri;
  } catch (err) {
    console.error('MobilePay link error:', err);

    // Fallback: Generate a simple payment reference link
    // In production, this would be a proper MobilePay deep link
    const amount = Math.round((order.total || 0) * 100);
    const reference = order.id || Date.now().toString();
    return `https://mobilepay.dk/erhverv/betalingslink/${merchantId}?amount=${amount}&ref=${reference}`;
  }
}

/**
 * Send payment link to customer via SMS
 * @param {string} phone - Customer phone
 * @param {Object} order - Order data
 * @param {Object} restaurant - Restaurant
 */
async function sendPaymentLink(phone, order, restaurant) {
  const paymentUrl = await createMobilePayLink(order, restaurant);

  if (!paymentUrl) {
    addLog('‚ö†Ô∏è MobilePay ikke konfigureret - springer betalingslink over', 'warning');
    return false;
  }

  const msg = `üí≥ Betal din ordre med MobilePay:\n\nOrdre #${order.id || 'N/A'}\nTotal: ${order.total} kr\n\nBetal her: ${paymentUrl}\n\n${restaurant.name}`;

  await sendSMS(phone, msg, restaurant);
  addLog('üí≥ Betalingslink sendt til kunden', 'success');
  return true;
}

// Clear workflow dirty state (shows save confirmation)
function clearWorkflowDirty() {
  showSaveStatus('workflow-save-status', 'saved');
}

/**
 * Generic save status system
 * Usage:
 *   1. Add <span class="save-status" id="unique-id"></span> near save button in HTML
 *   2. Call showSaveStatus('unique-id', 'saved') after successful save
 *   3. Call showSaveStatus('unique-id', 'error') to display error message
 */
function showSaveStatus(elementId, status = 'saved') {
  const statusEl = document.getElementById(elementId);
  if (!statusEl) return;

  if (status === 'saved') {
    statusEl.textContent = '‚úì Gemt';
    statusEl.style.color = 'var(--green)';
    setTimeout(() => {
      statusEl.textContent = '';
    }, 3000);
  } else if (status === 'error') {
    statusEl.textContent = '‚úó Fejl ved gemning';
    statusEl.style.color = 'var(--red)';
    setTimeout(() => {
      statusEl.textContent = '';
    }, 5000);
  } else {
    statusEl.textContent = '';
  }
}

function clearSaveStatus(elementId) {
  const statusEl = document.getElementById(elementId);
  if (statusEl) {
    statusEl.textContent = '';
  }
}

// Save Workflow Settings (internal - collects data)
function saveWorkflowSettings() {
  if (!currentProfileRestaurantId) return false;
  
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return false;
  
  // Workflow features
  restaurant.reviewEnabled = document.getElementById('wf-review-enabled')?.checked ?? false;
  restaurant.reorderEnabled = document.getElementById('wf-reorder-enabled')?.checked ?? false;
  restaurant.receiptEnabled = document.getElementById('wf-receipt-enabled')?.checked ?? false;
  restaurant.googleReviewUrl = document.getElementById('wf-google-link')?.value || '';
  restaurant.trustpilotUrl = document.getElementById('wf-trustpilot-link')?.value || '';
  
  // Delivery settings
  restaurant.deliveryEnabled = document.getElementById('wf-delivery-enabled')?.checked ?? false;
  restaurant.deliveryFrom = document.getElementById('wf-delivery-from')?.value || '18:00';
  restaurant.deliveryTo = document.getElementById('wf-delivery-to')?.value || '22:00';
  restaurant.deliveryTimeRestricted = document.getElementById('wf-delivery-time-restricted')?.checked ?? false;
  
  // Opening hours
  const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
  restaurant.openingHours = {};
  days.forEach(day => {
    restaurant.openingHours[day] = {
      enabled: document.getElementById(`oh-${day}-enabled`)?.checked ?? true,
      open: document.getElementById(`oh-${day}-open`)?.value || '10:00',
      close: document.getElementById(`oh-${day}-close`)?.value || '22:00'
    };
  });
  
  // Time format
  restaurant.timeFormat = document.getElementById('wf-time-format')?.value || '24h';
  
  // Mark last saved timestamp
  restaurant.workflowSettingsUpdatedAt = new Date().toISOString();
  
  console.log('Workflow settings saved:', restaurant);
  return true;
}

// Save Messages Config (for workflow messages modal)
function saveMessagesConfig() {
  if (!currentProfileRestaurantId) {
    toast('Kunne ikke gemme beskeder - ingen restaurant valgt', 'error');
    return;
  }

  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) {
    toast('Restaurant ikke fundet', 'error');
    return;
  }

  // Initialize messages object if needed
  if (!restaurant.messages) {
    restaurant.messages = {};
  }

  // Save message templates from form (assuming these IDs exist in the modal)
  const confirmationMessage = document.getElementById('msg-confirmation')?.value;
  const reviewMessage = document.getElementById('msg-review')?.value;
  const reorderMessage = document.getElementById('msg-reorder')?.value;

  if (confirmationMessage !== undefined) restaurant.messages.confirmation = confirmationMessage;
  if (reviewMessage !== undefined) restaurant.messages.review = reviewMessage;
  if (reorderMessage !== undefined) restaurant.messages.reorder = reorderMessage;

  // Persist to localStorage and Supabase
  persistRestaurants();

  if (typeof SupabaseDB !== 'undefined') {
    SupabaseDB.updateRestaurant(restaurant.id, {
      metadata: { ...restaurant.metadata, messages: restaurant.messages }
    }).catch(err => console.error('Error saving messages to Supabase:', err));
  }

  closeModal('messages-config');
  toast('Beskeder gemt', 'success');

  console.log('‚úÖ Messages config saved for restaurant:', restaurant.name);
}

// Explicit save with user feedback
function saveWorkflowSettingsExplicit() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;

  if (saveWorkflowSettings()) {
    // Persist to localStorage
    persistRestaurants();

    clearWorkflowDirty();

    // LOG ACTIVITY - dette vil automatisk vise bl√• prik p√• Workflow Kontrol nav item
    logActivity('update', 'Workflow indstillinger opdateret', {
      category: 'kunder',
      subCategory: 'workflow-kontrol',
      restaurantId: restaurant.id,
      restaurantName: restaurant.name
    });

    // Sync to workflow if active
    syncWorkflowFromCustomerSettings();
  } else {
    toast('Kunne ikke gemme indstillinger', 'error');
  }
}

// Sync workflow from customer settings
function syncWorkflowFromCustomerSettings() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  
  // Update workflow nodes based on customer settings
  if (typeof syncWorkflowReviewNode === 'function') {
    syncWorkflowReviewNode(restaurant.reviewEnabled && (restaurant.googleReviewUrl || restaurant.trustpilotUrl));
  }
  
  console.log('Workflow synced with customer settings');
}

// Save Message Settings (internal - collects data)
function saveMessageSettings() {
  if (!currentProfileRestaurantId) return false;
  
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return false;
  
  // Helper to safely get element value
  const getVal = (id) => document.getElementById(id)?.value || '';
  const getChecked = (id) => document.getElementById(id)?.checked || false;
  
  restaurant.messages = {
    // Automation
    autoEnabled: getChecked('msg-auto-enabled'),
    
    // Workflow Beskeder
    welcome: { text: getVal('msg-welcome-text') },
    pending: { text: getVal('msg-pending-text') },
    delivery: { text: getVal('msg-delivery-text') },
    
    // Ordre Status Beskeder
    confirmed: { text: getVal('msg-confirmed-text') },
    cooking: { text: getVal('msg-cooking-text') },
    ready: { text: getVal('msg-ready-text') },
    
    // Efter-Ordre Beskeder
    review: { 
      enabled: getChecked('msg-review-enabled'),
      text: getVal('msg-review-text') 
    },
    reorder: { 
      enabled: getChecked('msg-reorder-enabled'),
      text: getVal('msg-reorder-text'),
      interval: document.getElementById('msg-reorder-interval')?.value || '14'
    },
    receipt: { 
      enabled: getChecked('msg-receipt-enabled'),
      text: getVal('msg-receipt-text') 
    },
    
    // System Beskeder
    closed: { text: getVal('msg-closed-text') },
    error: { text: getVal('msg-error-text') }
  };
  
  // Mark last saved timestamp
  restaurant.messagesUpdatedAt = new Date().toISOString();
  
  console.log('Message settings saved:', restaurant.messages);
  return true;
}

// Save all messages with toast notification
function saveAllMessages() {
  if (saveMessageSettings()) {
    // Persist to localStorage
    persistRestaurants();

    // Show save status
    showSaveStatus('messages-save-status', 'saved');

    // Sync messages to workflow
    syncMessagesToWorkflow();
  } else {
    toast('Kunne ikke gemme beskeder', 'error');
  }
}

// Sync messages to workflow nodes
function syncMessagesToWorkflow() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant || !restaurant.messages) return;
  
  // Update workflow nodes with new message templates
  // This ensures the workflow uses the latest messages
  console.log('Messages synced to workflow:', restaurant.messages);
}

// =====================================================
// WORKFLOW RUNTIME HELPERS
// Get customer-specific settings for workflow execution
// =====================================================

// Get message template for a specific type
function getCustomerMessage(restaurantId, messageType, variables = {}) {
  const restaurant = restaurants.find(r => r.id === restaurantId);
  if (!restaurant || !restaurant.messages) return null;
  
  let template = '';
  
  switch (messageType) {
    case 'welcome':
      template = restaurant.messages.welcome?.text || 'Hej! Tak for dit opkald til {{restaurant}}.';
      break;
    case 'pending':
      template = restaurant.messages.pending?.text || 'Tak! Din ordre er nu sendt til k√∏kkenet.';
      break;
    case 'delivery':
      template = restaurant.messages.delivery?.text || 'Din ordre er p√• vej!';
      break;
    case 'confirmed':
      template = restaurant.messages.confirmed?.text || 'Din ordre er bekr√¶ftet!';
      break;
    case 'cooking':
      template = restaurant.messages.cooking?.text || 'K√∏kkenet er nu g√•et i gang med din bestilling!';
      break;
    case 'ready':
      template = restaurant.messages.ready?.text || 'Din ordre er nu f√¶rdig!';
      break;
    case 'review':
      if (!restaurant.messages.review?.enabled) return null;
      template = restaurant.messages.review?.text || 'Tak for din ordre! Del gerne din oplevelse.';
      break;
    case 'closed':
      template = restaurant.messages.closed?.text || 'Vi har desv√¶rre lukket lige nu.';
      break;
    case 'error':
      template = restaurant.messages.error?.text || 'Beklager, der opstod en fejl.';
      break;
    default:
      return null;
  }
  
  // Replace variables
  Object.keys(variables).forEach(key => {
    template = template.replace(new RegExp(`{{${key}}}`, 'g'), variables[key]);
  });
  
  // Replace restaurant name
  template = template.replace(/{{restaurant}}/g, restaurant.name || 'restauranten');
  
  return template;
}

// Check if delivery is available for a restaurant right now
function isDeliveryAvailableNow(restaurantId) {
  const restaurant = restaurants.find(r => r.id === restaurantId);
  if (!restaurant) return false;
  if (!restaurant.deliveryEnabled) return false;
  if (!restaurant.deliveryTimeRestricted) return true;
  
  const now = new Date();
  const currentTime = now.getHours() * 60 + now.getMinutes();
  
  const [fromHour, fromMin] = (restaurant.deliveryFrom || '18:00').split(':').map(Number);
  const [toHour, toMin] = (restaurant.deliveryTo || '22:00').split(':').map(Number);
  
  const fromTime = fromHour * 60 + fromMin;
  const toTime = toHour * 60 + toMin;
  
  return currentTime >= fromTime && currentTime <= toTime;
}

// Check if restaurant is open right now
function isRestaurantOpenNow(restaurantId) {
  const restaurant = restaurants.find(r => r.id === restaurantId);
  if (!restaurant || !restaurant.openingHours) return true; // Default to open
  
  const now = new Date();
  // Support both short and full day names for compatibility
  const dayNamesShort = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
  const dayNamesFull = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
  const dayIndex = now.getDay();
  
  // Try both name formats
  const todayHours = restaurant.openingHours[dayNamesShort[dayIndex]] || 
                     restaurant.openingHours[dayNamesFull[dayIndex]];
  
  if (!todayHours || !todayHours.enabled) return false;
  
  const currentTime = now.getHours() * 60 + now.getMinutes();
  const [openHour, openMin] = (todayHours.open || '00:00').split(':').map(Number);
  const [closeHour, closeMin] = (todayHours.close || '00:00').split(':').map(Number);
  
  const openTime = openHour * 60 + openMin;
  let closeTime = closeHour * 60 + closeMin;
  
  // D√òGN√ÖBENT: Hvis b√•de open og close er 00:00
  if (openTime === 0 && closeTime === 0 && todayHours.open === '00:00' && todayHours.close === '00:00') {
    return true;
  }
  
  // Midnat fix: 00:00 lukketid = 24:00
  if (closeTime === 0 && todayHours.close === '00:00') {
    closeTime = 1440;
  }
  
  // Over midnat: fx 18:00 - 02:00
  if (closeTime < openTime) {
    return currentTime >= openTime || currentTime < closeTime;
  }
  
  // Normal: fx 10:00 - 22:00
  return currentTime >= openTime && currentTime < closeTime;
}

// Get customer workflow settings
function getCustomerWorkflowSettings(restaurantId) {
  const restaurant = restaurants.find(r => r.id === restaurantId);
  if (!restaurant) return null;
  
  return {
    reviewEnabled: restaurant.reviewEnabled && (restaurant.googleReviewUrl || restaurant.trustpilotUrl),
    reorderEnabled: restaurant.reorderEnabled,
    receiptEnabled: restaurant.receiptEnabled,
    deliveryEnabled: restaurant.deliveryEnabled,
    deliveryAvailableNow: isDeliveryAvailableNow(restaurantId),
    isOpen: isRestaurantOpenNow(restaurantId),
    autoEnabled: restaurant.messages?.autoEnabled || false,
    googleReviewUrl: restaurant.googleReviewUrl,
    trustpilotUrl: restaurant.trustpilotUrl
  };
}

// Insert variable into textarea
function insertVariable(textareaId, variable) {
  const textarea = document.getElementById(textareaId);
  if (!textarea) return;
  
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const text = textarea.value;
  
  textarea.value = text.substring(0, start) + variable + text.substring(end);
  textarea.focus();
  textarea.selectionStart = textarea.selectionEnd = start + variable.length;
  
  // Don't auto-save on variable insert to avoid confusion
}

// Export customer PDF (M√•nedlig KPI Rapport)
function exportCustomerPdf() {
  if (!currentProfileRestaurantId) return;
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  
  // Wait for jsPDF to load
  if (typeof window.jspdf === 'undefined') {
    toast('PDF bibliotek indl√¶ses...', 'info');
    setTimeout(exportCustomerPdf, 500);
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({
    orientation: 'portrait',
    unit: 'mm',
    format: 'a4'
  });
  
  // PDF Konfiguration
  const PRIMARY_COLOR = [26, 26, 46];
  const ACCENT_COLOR = [45, 212, 191];
  const TEXT_COLOR = [51, 51, 51];
  const MEDIUM_GRAY = [224, 224, 224];
  const GREEN_COLOR = [34, 197, 94];
  
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const margin = 25;
  
  let y = 20;
  
  // === HEADER ===
  doc.setFontSize(22);
  doc.setTextColor(...PRIMARY_COLOR);
  doc.setFont('helvetica', 'bold');
  doc.text('M√ÖNEDSRAPPORT', margin, y);
  
  y += 6;
  doc.setFontSize(10);
  doc.setTextColor(...ACCENT_COLOR);
  doc.setFont('helvetica', 'normal');
  doc.text('OrderFlow SaaS - N√∏gletal', margin, y);
  
  // H√∏jre side
  const dateStr = new Date().toLocaleDateString('da-DK');
  doc.setFontSize(11);
  doc.setTextColor(...TEXT_COLOR);
  doc.setFont('helvetica', 'bold');
  doc.text(restaurant.name || 'Restaurant', pageWidth - margin, y - 6, { align: 'right' });
  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  doc.text('CVR: ' + (restaurant.cvr || '-'), pageWidth - margin, y, { align: 'right' });
  doc.text('Genereret: ' + dateStr, pageWidth - margin, y + 4, { align: 'right' });
  
  // Header linje
  y += 5;
  doc.setDrawColor(...PRIMARY_COLOR);
  doc.setLineWidth(0.7);
  doc.line(margin, y, pageWidth - margin, y);
  
  y += 15;
  
  // === KPI SEKTION ===
  const kpi = restaurant.kpi || {};
  
  doc.setFontSize(14);
  doc.setTextColor(...PRIMARY_COLOR);
  doc.setFont('helvetica', 'bold');
  doc.text('N√∏gletal', margin, y);
  y += 10;
  
  // KPI Grid (2x2)
  const kpiData = [
    { label: 'Genvundet Oms√¶tning', value: (kpi.recoveredRevenue || 0).toLocaleString('da-DK') + ' kr', color: GREEN_COLOR },
    { label: 'AI H√•ndteringsrate', value: (kpi.aiAutomationRate || 0) + '%', color: [168, 85, 247] },
    { label: 'Anmeldelseskonvertering', value: (kpi.reviewCTR || 0) + '%', color: [251, 146, 60] },
    { label: 'Konverteringsrate', value: (kpi.conversionRate || 0) + '%', color: [59, 130, 246] }
  ];
  
  const boxWidth = 75;
  const boxHeight = 25;
  
  kpiData.forEach((item, index) => {
    const col = index % 2;
    const row = Math.floor(index / 2);
    const x = margin + (col * (boxWidth + 10));
    const boxY = y + (row * (boxHeight + 8));
    
    // Box background
    doc.setFillColor(245, 245, 245);
    doc.roundedRect(x, boxY, boxWidth, boxHeight, 2, 2, 'F');
    
    // Value
    doc.setFontSize(16);
    doc.setTextColor(...item.color);
    doc.setFont('helvetica', 'bold');
    doc.text(item.value, x + 5, boxY + 10);
    
    // Label
    doc.setFontSize(9);
    doc.setTextColor(...TEXT_COLOR);
    doc.setFont('helvetica', 'normal');
    doc.text(item.label, x + 5, boxY + 18);
  });
  
  y += (boxHeight * 2) + 25;
  
  // === ANMELDELSER SEKTION ===
  doc.setFontSize(14);
  doc.setTextColor(...PRIMARY_COLOR);
  doc.setFont('helvetica', 'bold');
  doc.text('Anmeldelser', margin, y);
  y += 10;
  
  const reviews = kpi.reviews || {};
  
  doc.setFontSize(10);
  doc.setTextColor(...TEXT_COLOR);
  doc.setFont('helvetica', 'normal');
  
  doc.text('Samlet bed√∏mmelse: ' + (reviews.avgRating || 0).toFixed(1) + ' / 5.0', margin, y);
  y += 6;
  doc.text('Antal anmeldelser: ' + (reviews.total || 0), margin, y);
  y += 8;
  
  if (reviews.google) {
    doc.text('Google: ' + (reviews.google.avgRating || 0).toFixed(1) + ' (' + (reviews.google.count || 0) + ' anmeldelser)', margin, y);
    y += 6;
  }
  if (reviews.trustpilot) {
    doc.text('Trustpilot: ' + (reviews.trustpilot.avgRating || 0).toFixed(1) + ' (' + (reviews.trustpilot.count || 0) + ' anmeldelser)', margin, y);
    y += 6;
  }
  
  y += 10;
  
  // === OMS√ÜTNING SEKTION ===
  doc.setFontSize(14);
  doc.setTextColor(...PRIMARY_COLOR);
  doc.setFont('helvetica', 'bold');
  doc.text('Oms√¶tning', margin, y);
  y += 10;
  
  doc.setFontSize(10);
  doc.setTextColor(...TEXT_COLOR);
  doc.setFont('helvetica', 'normal');
  
  doc.text('Total oms√¶tning: ' + (kpi.totalRevenue || 0).toLocaleString('da-DK') + ' kr', margin, y);
  y += 6;
  doc.text('Genvundet oms√¶tning: ' + (kpi.recoveredRevenue || 0).toLocaleString('da-DK') + ' kr', margin, y);
  y += 6;
  doc.text('Gennemsnitlig ordrev√¶rdi: ' + (kpi.avgOrderValue || 0).toLocaleString('da-DK') + ' kr', margin, y);
  
  // === FOOTER ===
  const footerY = pageHeight - 15;
  
  doc.setDrawColor(...MEDIUM_GRAY);
  doc.setLineWidth(0.3);
  doc.line(margin, footerY - 5, pageWidth - margin, footerY - 5);
  
  doc.setFontSize(9);
  doc.setTextColor(...TEXT_COLOR);
  doc.text('Side 1 af 1', pageWidth / 2, footerY, { align: 'center' });
  
  doc.setFontSize(8);
  doc.setTextColor(128, 128, 128);
  doc.text('OrderFlow SaaS  ‚Ä¢  Vestergade 12, 2100 K√∏benhavn √ò  ‚Ä¢  CVR: 12345678', pageWidth / 2, footerY + 4, { align: 'center' });
  
  // === DOWNLOAD ===
  const fileName = `Maanedsrapport_${restaurant.name?.replace(/\s+/g, '_') || 'Restaurant'}_${new Date().toISOString().slice(0,7)}.pdf`;
  doc.save(fileName);
  
  // toast('PDF downloadet', 'success'); // Removed - unnecessary
}

// Export customer Excel
function exportCustomerExcel() {
  if (!currentProfileRestaurantId) return;
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  
  const kpi = restaurant.kpi || {};
  const reviews = kpi.reviews || {};
  
  // Create CSV content
  const rows = [
    ['M√ÖNEDSRAPPORT - ' + (restaurant.name || 'Restaurant')],
    ['Genereret', new Date().toLocaleDateString('da-DK')],
    [''],
    ['STAMDATA'],
    ['Virksomhedsnavn', restaurant.name || ''],
    ['CVR', restaurant.cvr || ''],
    ['Adresse', restaurant.address || ''],
    [''],
    ['N√òGLETAL'],
    ['Genvundet Oms√¶tning', kpi.recoveredRevenue || 0],
    ['AI H√•ndteringsrate (%)', kpi.aiAutomationRate || 0],
    ['Anmeldelseskonvertering (%)', kpi.reviewCTR || 0],
    ['Konverteringsrate (%)', kpi.conversionRate || 0],
    [''],
    ['OMS√ÜTNING'],
    ['Total oms√¶tning', kpi.totalRevenue || 0],
    ['Genvundet oms√¶tning', kpi.recoveredRevenue || 0],
    ['Gennemsnitlig ordrev√¶rdi', kpi.avgOrderValue || 0],
    [''],
    ['ANMELDELSER'],
    ['Samlet bed√∏mmelse', reviews.avgRating || 0],
    ['Antal anmeldelser', reviews.total || 0],
    ['Google bed√∏mmelse', reviews.google?.avgRating || 0],
    ['Google antal', reviews.google?.count || 0],
    ['Trustpilot bed√∏mmelse', reviews.trustpilot?.avgRating || 0],
    ['Trustpilot antal', reviews.trustpilot?.count || 0]
  ];
  
  const csv = rows.map(row => row.join(';')).join('\n');
  
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Maanedsrapport_${restaurant.name?.replace(/\s+/g, '_') || 'Restaurant'}_${new Date().toISOString().slice(0,7)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  
  // toast('Excel eksport downloadet', 'success'); // Removed - unnecessary
}

// Check if delivery is available based on time restrictions
function isDeliveryAvailable(restaurant) {
  if (!restaurant.deliveryEnabled) return false;
  if (!restaurant.deliveryTimeRestricted) return true;
  
  const now = new Date();
  const currentTime = now.getHours() * 60 + now.getMinutes();
  
  const [fromHour, fromMin] = (restaurant.deliveryFrom || '18:00').split(':').map(Number);
  const [toHour, toMin] = (restaurant.deliveryTo || '22:00').split(':').map(Number);
  
  const fromTime = fromHour * 60 + fromMin;
  const toTime = toHour * 60 + toMin;
  
  return currentTime >= fromTime && currentTime <= toTime;
}

// Update review links status (legacy - now handled by saveWorkflowSettings)
function updateReviewLinks() {
  // This function is kept for backwards compatibility but logic moved to workflow settings
  saveWorkflowSettings();
}

// Save review links and activate workflow node (legacy)
function saveReviewLinks() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;

  const googleUrl = document.getElementById('wf-google-link')?.value.trim() || '';
  const trustpilotUrl = document.getElementById('wf-trustpilot-link')?.value.trim() || '';

  restaurant.googleReviewUrl = googleUrl;
  restaurant.trustpilotUrl = trustpilotUrl;
  restaurant.reviewRequestEnabled = !!(googleUrl || trustpilotUrl);

  // Persist to localStorage
  persistRestaurants();

  // LOG ACTIVITY - dette vil automatisk vise bl√• prik p√• Workflow Kontrol nav item
  logActivity('update', 'Anmeldelseslinks opdateret', {
    category: 'kunder',
    subCategory: 'workflow-kontrol',
    restaurantId: restaurant.id,
    restaurantName: restaurant.name
  });

  // Sync workflow node - activate if links exist
  syncWorkflowReviewNode(restaurant.reviewRequestEnabled);

  // Show save status
  showSaveStatus('workflow-save-status', 'saved');
}

// Toggle profile delivery (legacy - redirects to new function)
function toggleProfileDelivery() {
  toggleDeliverySettings();
}

// Toggle automation mode visibility
function toggleAutoMode(enabled) {
  const settings = document.getElementById('auto-mode-settings');
  if (settings) {
    settings.style.display = enabled ? 'block' : 'none';
  }
}

// Open messages configuration modal
function openMessagesModal() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  
  // Initialize custom messages object if not exists
  if (!restaurant.customMessages) {
    restaurant.customMessages = {};
  }
  
  // Initialize automation settings if not exists
  if (!restaurant.automation) {
    restaurant.automation = { enabled: false, defaultTime: 40 };
  }
  
  // Populate automation settings
  document.getElementById('msg-auto-mode').checked = restaurant.automation.enabled || false;
  document.getElementById('msg-auto-time').value = restaurant.automation.defaultTime || 40;
  toggleAutoMode(restaurant.automation.enabled);
  
  // Populate NEW order status messages
  document.getElementById('msg-order-accepted').value = restaurant.customMessages.orderAccepted || '';
  document.getElementById('msg-order-started').value = restaurant.customMessages.orderStarted || '';
  document.getElementById('msg-order-completed').value = restaurant.customMessages.orderCompleted || '';
  
  // Populate existing workflow messages
  document.getElementById('msg-welcome').value = restaurant.customMessages.welcome || '';
  document.getElementById('msg-order-confirm').value = restaurant.customMessages.orderConfirm || '';
  document.getElementById('msg-delivery').value = restaurant.customMessages.delivery || '';
  document.getElementById('msg-review').value = restaurant.customMessages.review || '';
  document.getElementById('msg-receipt').value = restaurant.customMessages.receipt || '';
  
  showModal('messages-config');
}

// Save custom messages
function saveCustomMessages() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  
  // Initialize if not exists
  if (!restaurant.customMessages) {
    restaurant.customMessages = {};
  }
  if (!restaurant.automation) {
    restaurant.automation = {};
  }
  
  // Save automation settings
  restaurant.automation.enabled = document.getElementById('msg-auto-mode').checked;
  restaurant.automation.defaultTime = parseInt(document.getElementById('msg-auto-time').value) || 40;
  
  // Save NEW order status messages
  const orderAccepted = document.getElementById('msg-order-accepted').value.trim();
  const orderStarted = document.getElementById('msg-order-started').value.trim();
  const orderCompleted = document.getElementById('msg-order-completed').value.trim();
  
  restaurant.customMessages.orderAccepted = orderAccepted || null;
  restaurant.customMessages.orderStarted = orderStarted || null;
  restaurant.customMessages.orderCompleted = orderCompleted || null;
  
  // Save existing workflow messages
  const welcome = document.getElementById('msg-welcome').value.trim();
  const orderConfirm = document.getElementById('msg-order-confirm').value.trim();
  const delivery = document.getElementById('msg-delivery').value.trim();
  const review = document.getElementById('msg-review').value.trim();
  const receipt = document.getElementById('msg-receipt').value.trim();
  
  restaurant.customMessages.welcome = welcome || null;
  restaurant.customMessages.orderConfirm = orderConfirm || null;
  restaurant.customMessages.delivery = delivery || null;
  restaurant.customMessages.review = review || null;
  restaurant.customMessages.receipt = receipt || null;
  
  closeModal('messages-config');
}

// Get message for a node - returns custom or default
function getMessageForNode(restaurantId, nodeId) {
  const restaurant = restaurants.find(r => r.id === restaurantId);
  if (!restaurant || !restaurant.customMessages) return null;
  
  const messageMap = {
    'send-welcome': restaurant.customMessages.welcome,
    'send-order-confirm': restaurant.customMessages.orderConfirm,
    'send-delivery-info': restaurant.customMessages.delivery,
    'send-review-request': restaurant.customMessages.review,
    'send-receipt': restaurant.customMessages.receipt
  };
  
  return messageMap[nodeId] || null; // null = use default
}

// Edit current profile
function editCurrentProfile() {
  if (currentProfileRestaurantId) {
    editRestaurant(currentProfileRestaurantId);
  }
}

// Test current profile
function testCurrentProfile() {
  if (currentProfileRestaurantId) {
    testRestaurant(currentProfileRestaurantId);
    showPage('workflow');
  }
}

// Export profile PDF
function exportProfilePdf() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  
  console.log(`Generating PDF for ${restaurant.name}`);
}

// Export profile Excel
function exportProfileExcel() {
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  if (!restaurant) return;
  
  console.log(`Generating Excel for ${restaurant.name}`);
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();
    const searchInput = document.getElementById('crm-search');
    if (searchInput && document.getElementById('page-kunder').classList.contains('active')) {
      showCrmSearchView();
      searchInput.focus();
      searchInput.select();
    }
  }
  
  // Escape to go back to search view
  if (e.key === 'Escape' && currentProfileRestaurantId) {
    showCrmSearchView();
  }
});

// Click handler (autocomplete removed)
document.addEventListener('click', (e) => {
  // Close command results
  if (!e.target.closest('.sidebar-search')) {
    const commandResults = document.getElementById('command-results');
    if (commandResults) commandResults.classList.remove('active');
  }
});

// =====================================================
// GLOBAL COMMAND SEARCH
// =====================================================

// Command search data
const commandItems = [
  // Pages
  { type: 'page', id: 'dashboard', name: 'Dashboard', hint: 'Overblik', keywords: ['dashboard', 'overblik', 'hjem', 'start'] },
  { type: 'page', id: 'kunder', name: 'Kunder', hint: 'CRM', keywords: ['restauranter', 'kunder', 'crm', 'kunde'] },
  { type: 'page', id: 'orders', name: 'Ordrer', hint: 'Alle ordrer', keywords: ['ordrer', 'ordre', 'bestillinger', 'salg'] },
  { type: 'page', id: 'workflow', name: 'Workflow', hint: 'Automatisering', keywords: ['workflow', 'flow', 'automatisering', 'automation'] },
  { type: 'page', id: 'settings', name: 'Indstillinger', hint: 'Konfiguration', keywords: ['indstillinger', 'settings', 'config'] },
  { type: 'page', id: 'salgsoversigt', name: 'Salgsoversigt', hint: 'Salg', keywords: ['salg', 'omsaetning', 'revenue', 'oversigt'] },
  { type: 'page', id: 'loyalty', name: 'Loyalty Program', hint: 'Marketing', keywords: ['loyalty', 'point', 'stamkunde', 'bonus'] },
  { type: 'page', id: 'campaigns', name: 'Kampagner', hint: 'Marketing', keywords: ['kampagne', 'tilbud', 'marketing', 'rabat'] },
  { type: 'page', id: 'appbuilder-design', name: 'App Builder', hint: 'PWA', keywords: ['app', 'builder', 'pwa', 'mobil', 'design'] },
  { type: 'page', id: 'leads', name: 'Leads', hint: 'Salg', keywords: ['leads', 'prospekter', 'potentielle', 'kunder'] },
  // Account
  { type: 'account', id: 'mine-oplysninger', name: 'Mine oplysninger', hint: 'Profil', keywords: ['profil', 'oplysninger', 'konto', 'bruger', 'mig'] },
  { type: 'account', id: 'ordrehistorik', name: 'Ordre historik', hint: 'Historik', keywords: ['ordre', 'historik', 'tidligere', 'bestillinger', 'genbestil'] },
  { type: 'account', id: 'betalingsmetoder', name: 'Betalingsmetoder', hint: 'Kort', keywords: ['betaling', 'kort', 'kreditkort', 'faktura', 'visa', 'mastercard'] },
  { type: 'account', id: 'leveringsadresser', name: 'Leveringsadresser', hint: 'Adresser', keywords: ['adresse', 'levering', 'delivery', 'hjem', 'arbejde'] },
  // Settings
  { type: 'setting', id: 'openai', name: 'OpenAI API', hint: 'AI', keywords: ['openai', 'ai', 'gpt', 'api'] },
  { type: 'setting', id: 'beskeder', name: 'Beskeder', hint: 'Templates', keywords: ['beskeder', 'messages', 'templates', 'skabeloner'] },
  { type: 'setting', id: 'notifications', name: 'Notifikationer', hint: 'Advarsler', keywords: ['notifikationer', 'alerts', 'beskeder', 'push'] },
  { type: 'setting', id: 'users', name: 'Brugerindstillinger', hint: 'Profil', keywords: ['bruger', 'profil', 'konto', 'team'] },
  // Reports
  { type: 'report', id: 'kpi', name: 'KPI Oversigt', hint: 'Analytics', keywords: ['kpi', 'analytics', 'statistik', 'data'] },
  { type: 'report', id: 'monthly', name: 'M√•nedsrapport', hint: 'PDF', keywords: ['rapport', 'maanedlig', 'pdf', 'export'] }
];

// Handle command search
function handleCommandSearch(query) {
  const results = document.getElementById('command-results');
  if (!results) return;
  
  query = (query || '').toLowerCase().trim();
  
  if (!query) {
    // Show all items grouped
    results.innerHTML = buildCommandResultsHTML(commandItems);
    return;
  }
  
  // Filter items
  const filtered = commandItems.filter(item => 
    item.name.toLowerCase().includes(query) ||
    item.hint.toLowerCase().includes(query) ||
    item.keywords.some(k => k.includes(query))
  );
  
  if (filtered.length === 0) {
    results.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted);font-size:13px">Ingen resultater fundet</div>';
  } else {
    results.innerHTML = buildCommandResultsHTML(filtered);
  }
}

// Build command results HTML
function buildCommandResultsHTML(items) {
  const pages = items.filter(i => i.type === 'page');
  const account = items.filter(i => i.type === 'account');
  const settings = items.filter(i => i.type === 'setting');
  const reports = items.filter(i => i.type === 'report');

  let html = '';

  if (pages.length) {
    html += '<div class="command-group"><div class="command-group-title">Sider</div>';
    pages.forEach(item => {
      html += `<div class="command-item" onclick="navigateCommand('${item.id}')">
        ${getCommandIcon(item.id)}
        <span class="command-item-text">${item.name}</span>
        <span class="command-item-hint">${item.hint}</span>
      </div>`;
    });
    html += '</div>';
  }

  if (account.length) {
    html += '<div class="command-group"><div class="command-group-title">Min konto</div>';
    account.forEach(item => {
      html += `<div class="command-item" onclick="navigateCommand('account', '${item.id}')">
        ${getCommandIcon(item.id)}
        <span class="command-item-text">${item.name}</span>
        <span class="command-item-hint">${item.hint}</span>
      </div>`;
    });
    html += '</div>';
  }

  if (settings.length) {
    html += '<div class="command-group"><div class="command-group-title">Indstillinger</div>';
    settings.forEach(item => {
      html += `<div class="command-item" onclick="navigateCommand('settings', '${item.id}')">
        ${getCommandIcon(item.id)}
        <span class="command-item-text">${item.name}</span>
        <span class="command-item-hint">${item.hint}</span>
      </div>`;
    });
    html += '</div>';
  }

  if (reports.length) {
    html += '<div class="command-group"><div class="command-group-title">Rapporter</div>';
    reports.forEach(item => {
      html += `<div class="command-item" onclick="navigateCommand('dashboard', '${item.id}')">
        ${getCommandIcon(item.id)}
        <span class="command-item-text">${item.name}</span>
        <span class="command-item-hint">${item.hint}</span>
      </div>`;
    });
    html += '</div>';
  }

  return html;
}

// Get icon for command item
function getCommandIcon(id) {
  const icons = {
    'dashboard': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>',
    'kunder': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>',
    'orders': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/></svg>',
    'workflow': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>',
    'settings': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/></svg>',
    'openai': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42"/></svg>',
    'beskeder': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
    'kpi': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>',
    'monthly': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
    // Account icons
    'mine-oplysninger': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
    'ordrehistorik': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg>',
    'betalingsmetoder': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>',
    'leveringsadresser': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>',
    // Additional page icons
    'salgsoversigt': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>',
    'loyalty': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
    'campaigns': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
    'appbuilder-design': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>',
    'leads': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>',
    'notifications': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>',
    'users': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>'
  };
  return icons[id] || '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/></svg>';
}

// Show command results
function showCommandResults() {
  const results = document.getElementById('command-results');
  if (results) {
    results.classList.add('active');
    handleCommandSearch(document.getElementById('command-search')?.value);
  }
}

// Navigate from command
function navigateCommand(page, sub) {
  const results = document.getElementById('command-results');
  const input = document.getElementById('command-search');

  if (results) results.classList.remove('active');
  if (input) input.value = '';

  // Handle account navigation
  if (page === 'account' && sub) {
    showAccountPage(sub);
    return;
  }

  // Handle settings navigation
  if (page === 'settings' && sub) {
    showPage('settings');
    setTimeout(() => {
      if (typeof showSettingsPage === 'function') {
        showSettingsPage(sub);
      }
    }, 50);
    return;
  }

  showPage(page);
}

// Global keyboard shortcut for command search (Cmd/Ctrl + K)
document.addEventListener('keydown', (e) => {
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
    e.preventDefault();
    const input = document.getElementById('command-search');
    if (input) {
      input.focus();
      input.select();
      showCommandResults();
    }
  }
  
  // Escape to close command results
  if (e.key === 'Escape') {
    const results = document.getElementById('command-results');
    if (results && results.classList.contains('active')) {
      results.classList.remove('active');
      document.getElementById('command-search')?.blur();
    }
  }
});

// Update KPI preview visibility
function updateKpiPreview() {
  const checked = document.getElementById('edit-restaurant-kpi-enabled').checked;
  document.getElementById('kpi-preview').style.display = checked ? 'block' : 'none';
}

// Sync workflow review node with restaurant setting
function syncWorkflowReviewNode(enabled) {
  // Find the review request node in workflow
  const reviewNode = workflowNodes.find(n => n.id === 'send-review-request');
  if (reviewNode) {
    reviewNode.disabled = !enabled;
    
    // Re-render workflow to show visual change
    if (typeof renderWorkflowNodes === 'function') {
      renderWorkflowNodes();
    }
  }
}

async function saveRestaurantSettings() {
  const id = document.getElementById('edit-restaurant-id').value;
  const restaurant = restaurants.find(r => r.id === id);

  if (!restaurant) {
    toast('Restaurant ikke fundet', 'error');
    return;
  }
  
  // Update basic restaurant data
  restaurant.name = document.getElementById('edit-restaurant-name').value;
  restaurant.logo = document.getElementById('edit-restaurant-logo').value || 'pizza';
  restaurant.phone = document.getElementById('edit-restaurant-phone').value;
  restaurant.website = document.getElementById('edit-restaurant-website').value;
  restaurant.menuUrl = document.getElementById('edit-restaurant-menu').value;
  restaurant.googleReviewUrl = document.getElementById('edit-restaurant-google').value;
  restaurant.trustpilotUrl = document.getElementById('edit-restaurant-trustpilot').value;
  restaurant.reviewDelay = parseInt(document.getElementById('edit-restaurant-delay').value) || 60;
  
  // Save delivery toggle
  restaurant.deliveryEnabled = document.getElementById('edit-restaurant-delivery').checked;
  
  // Save review request toggle (Workflow Sync)
  const reviewWasEnabled = restaurant.reviewRequestEnabled;
  restaurant.reviewRequestEnabled = document.getElementById('edit-restaurant-review-request').checked;
  
  // Sync with workflow node if changed
  if (reviewWasEnabled !== restaurant.reviewRequestEnabled) {
    syncWorkflowReviewNode(restaurant.reviewRequestEnabled);
  }
  
  // Save KPI settings
  const kpiWasEnabled = restaurant.kpiEnabled;
  restaurant.kpiEnabled = document.getElementById('edit-restaurant-kpi-enabled').checked;
  
  // Initialize KPI data if newly enabled
  if (restaurant.kpiEnabled && !restaurant.kpi) {
    restaurant.kpi = {
      totalRevenue: 0,
      recoveredRevenue: 0,
      avgOrderValue: 0,
      reviews: {
        total: 0,
        avgRating: 0,
        google: { count: 0, avgRating: 0 },
        trustpilot: { count: 0, avgRating: 0 }
      },
      conversionRate: 0,
      responseTime: 0,
      // Extended KPIs
      aiAutomationRate: 0,
      clv: 0,
      reviewCTR: 0,
      missedCalls: 0,
      completedOrders: 0,
      orderHeatmap: {
        monday: new Array(24).fill(0),
        tuesday: new Array(24).fill(0),
        wednesday: new Array(24).fill(0),
        thursday: new Array(24).fill(0),
        friday: new Array(24).fill(0),
        saturday: new Array(24).fill(0),
        sunday: new Array(24).fill(0)
      },
      sentiment: { positive: 0, neutral: 0, negative: 0 }
    };
  }
  
  // Save menu from editor
  saveMenuFromEditor(id);
  
  // Save time format
  restaurant.timeFormat = document.getElementById('time-format-24').checked ? '24h' : '12h';
  
  // Save opening hours
  restaurant.openingHours = {};
  const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
  days.forEach(day => {
    const dayEl = document.querySelector(`.opening-day[data-day="${day}"]`);
    if (dayEl) {
      restaurant.openingHours[day] = {
        enabled: dayEl.querySelector('.day-enabled').checked,
        open: dayEl.querySelector('.open-time').value,
        close: dayEl.querySelector('.close-time').value
      };
    }
  });
  
  // Only auto-activate pending customers when phone is added
  // NEVER reset an active/terminated/etc customer to pending
  if ((!restaurant.status || restaurant.status === 'pending') && restaurant.phone) {
    restaurant.status = 'active';
  }

  // Show save status
  showSaveStatus('stamdata-save-status', 'saved');

  // Log activity
  if (typeof logActivity === 'function') {
    await logActivity('update', `Restaurant opdateret: ${restaurant.name}`, {
      category: 'kunder',
      subCategory: 'stamdata',
      customerId: restaurant.id,
      data: { name: restaurant.name }
    });
  }

  // Refresh UI
  loadRestaurants();
  loadDashboard();
  closeModal('edit-restaurant');
}

// Default √•bningstider
function getDefaultOpeningHours() {
  return {
    mon: { enabled: true, open: '10:00', close: '22:00' },
    tue: { enabled: true, open: '10:00', close: '22:00' },
    wed: { enabled: true, open: '10:00', close: '22:00' },
    thu: { enabled: true, open: '10:00', close: '22:00' },
    fri: { enabled: true, open: '10:00', close: '23:00' },
    sat: { enabled: true, open: '11:00', close: '23:00' },
    sun: { enabled: true, open: '12:00', close: '21:00' }
  };
}

async function deleteRestaurant() {
  const id = document.getElementById('edit-restaurant-id').value;
  const restaurant = restaurants.find(r => r.id === id);

  if (!restaurant) return;

  if (confirm(`Er du sikker p√• du vil slette "${restaurant.name}"?`)) {
    // Delete from Supabase
    if (typeof SupabaseDB !== 'undefined') {
      try {
        await SupabaseDB.deleteRestaurant(id);

        // Log activity before removing from array
        if (typeof logActivity === 'function') {
          await logActivity('delete', `Restaurant slettet: ${restaurant.name}`, {
            category: 'kunder',
            subCategory: 'stamdata',
            customerId: id,
            data: { name: restaurant.name }
          });
        }

        // Remove from local array
        restaurants = restaurants.filter(r => r.id !== id);

        // Refresh UI
        loadRestaurants();
        loadDashboard();
        closeModal('edit-restaurant');

        toast('Restaurant slettet', 'success');
      } catch (err) {
        console.error('‚ùå Error deleting restaurant:', err);
        toast('Fejl ved sletning af restaurant', 'error');
      }
    }
  }
}

// =====================================================
// CUSTOMER TERMINATION & GDPR
// =====================================================

/**
 * Show termination modal for customer
 * @param {string} restaurantId - Restaurant ID to terminate
 */
function showTerminationModal(restaurantId) {
  const restaurant = restaurants.find(r => r.id === restaurantId);
  if (!restaurant) {
    toast('Kunde ikke fundet', 'error');
    return;
  }

  // Check if customer can be terminated
  if (restaurant.status === 'terminated' || restaurant.status === 'gdpr_deleted') {
    toast('Denne kunde er allerede opsagt', 'warning');
    return;
  }

  // Calculate retention info
  const retentionYears = 5;
  const deletionDate = new Date();
  deletionDate.setFullYear(deletionDate.getFullYear() + retentionYears);

  // Populate modal
  const nameEl = document.getElementById('termination-customer-name');
  const idEl = document.getElementById('termination-customer-id');
  const dateEl = document.getElementById('termination-deletion-date');
  const reasonEl = document.getElementById('termination-reason');
  const reasonOtherEl = document.getElementById('termination-reason-other');
  const confirmEl = document.getElementById('termination-confirm-check');

  if (nameEl) nameEl.textContent = restaurant.name || 'Ukendt kunde';
  if (idEl) idEl.value = restaurantId;
  if (dateEl) dateEl.textContent = deletionDate.toLocaleDateString('da-DK', {
    day: 'numeric', month: 'long', year: 'numeric'
  });
  if (reasonEl) reasonEl.value = '';
  if (reasonOtherEl) {
    reasonOtherEl.value = '';
    reasonOtherEl.style.display = 'none';
  }
  if (confirmEl) confirmEl.checked = false;

  showModal('terminate-customer');
}

/**
 * Handle termination reason change (show/hide other field)
 */
function onTerminationReasonChange() {
  const reasonEl = document.getElementById('termination-reason');
  const otherEl = document.getElementById('termination-reason-other');

  if (reasonEl && otherEl) {
    otherEl.style.display = reasonEl.value === 'Andet' ? 'block' : 'none';
    if (reasonEl.value !== 'Andet') {
      otherEl.value = '';
    }
  }
}

/**
 * Execute customer termination
 */
async function terminateCustomer() {
  const restaurantId = document.getElementById('termination-customer-id')?.value;
  const reasonSelect = document.getElementById('termination-reason')?.value;
  const reasonOther = document.getElementById('termination-reason-other')?.value?.trim();
  const confirmCheck = document.getElementById('termination-confirm-check')?.checked;

  // Determine final reason
  let reason = reasonSelect;
  if (reasonSelect === 'Andet' && reasonOther) {
    reason = reasonOther;
  }

  if (!reason) {
    toast('Angiv venligst en √•rsag til opsigelsen', 'error');
    return;
  }

  if (!confirmCheck) {
    toast('Du skal bekr√¶fte at du forst√•r GDPR-reglerne', 'error');
    return;
  }

  const restaurant = restaurants.find(r => r.id === restaurantId);
  if (!restaurant) {
    toast('Kunde ikke fundet', 'error');
    return;
  }

  try {
    let result;

    // Terminate via Supabase if available
    if (typeof SupabaseDB !== 'undefined' && supabaseClient) {
      result = await SupabaseDB.terminateCustomer(
        restaurantId,
        reason,
        currentUser?.email || 'unknown'
      );
    } else {
      // Local fallback
      const terminatedAt = new Date();
      const gdprDeletionDate = new Date(terminatedAt);
      gdprDeletionDate.setFullYear(gdprDeletionDate.getFullYear() + 5);

      result = {
        ...restaurant,
        status: 'terminated',
        terminated_at: terminatedAt.toISOString(),
        termination_reason: reason,
        termination_initiated_by: currentUser?.email || 'unknown',
        gdpr_deletion_scheduled_at: gdprDeletionDate.toISOString()
      };
    }

    // Update local array
    const index = restaurants.findIndex(r => r.id === restaurantId);
    if (index !== -1) {
      restaurants[index] = result;
    }

    // Persist to localStorage
    if (typeof persistRestaurants === 'function') {
      persistRestaurants();
    }

    // Log activity
    if (typeof logActivity === 'function') {
      await logActivity('update', `Kunde opsagt: ${restaurant.name}`, {
        category: 'kunder',
        subCategory: 'opsigelse',
        customerId: restaurantId,
        data: { reason, status: 'terminated' }
      });
    }

    // Refresh UI
    loadDashboard();
    if (typeof renderCrmTable === 'function') {
      renderCrmTable(restaurants, '');
    }
    closeModal('terminate-customer');
    closeCrmProfile();

    toast('Kunde opsagt. Data bevares i 5 √•r iht. bogf√∏ringsloven.', 'success');
  } catch (err) {
    console.error('‚ùå Error terminating customer:', err);
    toast('Fejl ved opsigelse af kunde: ' + err.message, 'error');
  }
}

/**
 * Activate a pending customer (change status from pending to active)
 * @param {string} restaurantId - Restaurant ID to activate
 */
async function activateCustomer(restaurantId) {
  const restaurant = restaurants.find(r => r.id === restaurantId);
  if (!restaurant) {
    toast('Kunde ikke fundet', 'error');
    return;
  }

  // Allow activation if status is 'pending', undefined, null, or empty
  if (restaurant.status && restaurant.status !== 'pending') {
    toast('Kun afventende kunder kan aktiveres', 'warning');
    return;
  }

  if (!confirm(`Vil du aktivere "${restaurant.name}"?\n\nKunden vil blive aktiv og kan modtage workflows.`)) {
    return;
  }

  try {
    // Update status
    restaurant.status = 'active';
    restaurant.activated_at = new Date().toISOString();

    // Update via Supabase if available
    if (typeof SupabaseDB !== 'undefined' && supabaseClient) {
      await supabaseClient
        .from('restaurants')
        .update({
          status: 'active',
          updated_at: new Date().toISOString()
        })
        .eq('id', restaurantId);
    }

    // Persist to localStorage
    if (typeof persistRestaurants === 'function') {
      persistRestaurants();
    }

    // Log activity
    if (typeof logActivity === 'function') {
      await logActivity('update', `Kunde aktiveret: ${restaurant.name}`, {
        category: 'kunder',
        subCategory: 'aktivering',
        customerId: restaurantId
      });
    }

    // Refresh UI
    loadDashboard();
    if (typeof renderCrmTable === 'function') {
      renderCrmTable(restaurants, '');
    }

    // Refresh profile view if open
    if (currentProfileRestaurantId === restaurantId) {
      showCrmProfileView(restaurantId);
    }

    toast('Kunde aktiveret', 'success');
  } catch (err) {
    console.error('‚ùå Error activating customer:', err);
    toast('Fejl ved aktivering: ' + err.message, 'error');
  }
}

/**
 * Reactivate a terminated customer
 * @param {string} restaurantId - Restaurant ID to reactivate
 */
async function reactivateCustomer(restaurantId) {
  const restaurant = restaurants.find(r => r.id === restaurantId);
  if (!restaurant) {
    toast('Kunde ikke fundet', 'error');
    return;
  }

  if (restaurant.status !== 'terminated') {
    toast('Kun opsagte kunder kan genaktiveres', 'warning');
    return;
  }

  if (!confirm(`Vil du genaktivere "${restaurant.name}"?\n\nKunden vil igen v√¶re aktiv og modtage workflows.`)) {
    return;
  }

  try {
    let result;

    // Reactivate via Supabase if available
    if (typeof SupabaseDB !== 'undefined' && supabaseClient) {
      result = await SupabaseDB.reactivateCustomer(
        restaurantId,
        currentUser?.email || 'unknown'
      );
    } else {
      // Local fallback
      result = {
        ...restaurant,
        status: 'active',
        terminated_at: null,
        termination_reason: null,
        termination_initiated_by: null,
        gdpr_deletion_scheduled_at: null
      };
    }

    // Update local array
    const index = restaurants.findIndex(r => r.id === restaurantId);
    if (index !== -1) {
      restaurants[index] = result;
    }

    // Persist to localStorage
    if (typeof persistRestaurants === 'function') {
      persistRestaurants();
    }

    // Log activity
    if (typeof logActivity === 'function') {
      await logActivity('update', `Kunde genaktiveret: ${restaurant.name}`, {
        category: 'kunder',
        subCategory: 'genaktivering',
        customerId: restaurantId
      });
    }

    // Refresh UI
    loadDashboard();
    if (typeof renderCrmTable === 'function') {
      renderCrmTable(restaurants, '');
    }

    // Refresh profile view if open
    if (currentProfileRestaurantId === restaurantId) {
      showCrmProfileView(restaurantId);
    }

    toast('Kunde genaktiveret', 'success');
  } catch (err) {
    console.error('‚ùå Error reactivating customer:', err);
    toast('Fejl ved genaktivering: ' + err.message, 'error');
  }
}

/**
 * Get retention info for a terminated customer
 * @param {Object} restaurant - Restaurant object
 * @returns {Object|null} Retention info or null if not terminated
 */
function getRetentionInfo(restaurant) {
  if (!restaurant || restaurant.status !== 'terminated' || !restaurant.terminated_at) {
    return null;
  }

  const terminatedDate = new Date(restaurant.terminated_at);
  const deletionDate = new Date(restaurant.gdpr_deletion_scheduled_at);
  const now = new Date();

  const daysRemaining = Math.ceil((deletionDate - now) / (1000 * 60 * 60 * 24));
  const totalDays = Math.ceil((deletionDate - terminatedDate) / (1000 * 60 * 60 * 24));
  const percentComplete = Math.round(((totalDays - daysRemaining) / totalDays) * 100);

  return {
    terminatedDate,
    deletionDate,
    daysRemaining: Math.max(0, daysRemaining),
    totalDays,
    percentComplete: Math.min(100, Math.max(0, percentComplete)),
    reason: restaurant.termination_reason || '-',
    initiatedBy: restaurant.termination_initiated_by || '-'
  };
}

/**
 * Show termination info banner on customer profile
 * @param {Object} restaurant - Restaurant object
 */
function showTerminationBanner(restaurant) {
  const retentionInfo = getRetentionInfo(restaurant);
  if (!retentionInfo) {
    // Hide banner if exists
    const existingBanner = document.getElementById('termination-banner');
    if (existingBanner) existingBanner.style.display = 'none';
    return;
  }

  let banner = document.getElementById('termination-banner');
  if (!banner) {
    banner = document.createElement('div');
    banner.id = 'termination-banner';
    const profileView = document.getElementById('crm-profile-view');
    const profileHeader = profileView?.querySelector('.crm-profile-header');
    if (profileHeader) {
      profileHeader.parentNode.insertBefore(banner, profileHeader.nextSibling);
    }
  }

  banner.className = 'termination-info-banner';
  banner.innerHTML = `
    <div class="termination-banner-header">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      <div>
        <h4>Kunde opsagt</h4>
        <p>Data bevares iht. dansk bogf√∏ringslov (5 √•r)</p>
      </div>
    </div>
    <div class="termination-details">
      <div class="termination-detail">
        <span class="label">Opsagt</span>
        <span class="value">${retentionInfo.terminatedDate.toLocaleDateString('da-DK')}</span>
      </div>
      <div class="termination-detail">
        <span class="label">√Örsag</span>
        <span class="value">${retentionInfo.reason}</span>
      </div>
      <div class="termination-detail">
        <span class="label">Slettes</span>
        <span class="value">${retentionInfo.deletionDate.toLocaleDateString('da-DK')}</span>
      </div>
      <div class="termination-detail">
        <span class="label">Dage tilbage</span>
        <span class="value">${retentionInfo.daysRemaining} dage</span>
      </div>
    </div>
    <div class="termination-progress">
      <div class="progress-bar">
        <div class="progress-fill" style="width: ${retentionInfo.percentComplete}%"></div>
      </div>
      <span class="progress-label">${retentionInfo.percentComplete}% af retention-periode</span>
    </div>
    <div class="termination-actions">
      <button class="btn btn-secondary btn-sm" onclick="reactivateCustomer('${restaurant.id}')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="23 4 23 10 17 10"></polyline>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
        </svg>
        Genaktiver kunde
      </button>
    </div>
  `;
  banner.style.display = 'block';
}

/**
 * Check if a customer can receive workflow actions
 * @param {Object} restaurant - Restaurant object
 * @returns {boolean} True if workflow actions are allowed
 */
function canReceiveWorkflowActions(restaurant) {
  if (!restaurant) return false;
  // Default til 'pending' hvis status er undefined/null (nye kunder)
  const status = restaurant.status || 'pending';
  const allowedStatuses = ['active', 'pending', 'demo'];
  return allowedStatuses.includes(status);
}

/**
 * Get the currently selected restaurant from workflow test dropdown
 * @returns {Object|null} Restaurant object or null if none selected
 */
function getSelectedRestaurant() {
  const select = document.getElementById('test-restaurant');
  if (!select || !select.value) return null;
  return restaurants.find(r => r.id === select.value) || null;
}

/**
 * Filter CRM list by status
 * @param {string} status - Status to filter by ('all' for no filter)
 */
let currentCrmStatusFilter = 'all';

function filterByStatus(status) {
  currentCrmStatusFilter = status;

  // Update active state on filter buttons
  document.querySelectorAll('.crm-status-filters .filter-tab').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.status === status);
  });

  // Filter restaurants
  let filtered = restaurants;
  if (status !== 'all') {
    if (status === 'demo') {
      filtered = restaurants.filter(r => r.status === 'demo' || r.isDemo);
    } else {
      filtered = restaurants.filter(r => r.status === status);
    }
  }

  // Re-render table
  renderCrmTable(filtered, document.getElementById('crm-search')?.value || '');
}

// Populate test restaurant dropdown
function populateTestRestaurants() {
  const select = document.getElementById('test-restaurant');
  if (!select) return;

  // HTML escape function
  const escapeHtml = (str) => {
    if (!str) return '';
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  };

  // Get restaurants that can receive workflow actions (active, pending, demo)
  const workflowRestaurants = restaurants.filter(r => r && canReceiveWorkflowActions(r));

  // Build options
  let optionsHtml = '<option value="">V√¶lg restaurant...</option>';
  workflowRestaurants.forEach(r => {
    const id = escapeHtml(r.id);
    const name = escapeHtml(r.name) || 'Uden navn';
    const userId = generateUserId(r.id);
    const statusLabel = r.status === 'demo' ? ' [Demo]' : r.status === 'pending' ? ' [Afventer]' : '';
    optionsHtml += `<option value="${id}">${name}${statusLabel} (${userId})</option>`;
  });

  select.innerHTML = optionsHtml;

  // Update buttons state
  updateTestButtons();
}

function testRestaurant(id) {
  document.getElementById('test-restaurant').value = id;
  showPage('workflow');
  updateTestButtons();
}

// =====================================================
// MENU EDITOR FUNKTIONER
// =====================================================
let currentEditingMenuItems = [];

function loadMenuItemsEditor(restaurantId) {
  const editor = document.getElementById('menu-items-editor');
  if (!editor) return;
  
  // Hent eksisterende menu
  const restaurant = restaurants.find(r => r.id === restaurantId);
  
  // Prioriter: customMenu > localStorage > demo menu
  let menuItems = [];
  
  if (restaurant?.customMenu?.items?.length > 0) {
    menuItems = restaurant.customMenu.items;
  } else {
    const storedMenu = localStorage.getItem(`menu_${restaurantId}`);
    if (storedMenu) {
      try {
        const parsed = JSON.parse(storedMenu);
        if (parsed.items) menuItems = parsed.items;
      } catch (e) {}
    }
  }
  
  // Hvis ingen menu, vis demo eller tom
  if (menuItems.length === 0 && DEMO_MENUS[restaurantId]) {
    menuItems = DEMO_MENUS[restaurantId].items;
  }
  
  currentEditingMenuItems = [...menuItems];
  renderMenuItemsEditor();
}

function renderMenuItemsEditor() {
  const editor = document.getElementById('menu-items-editor');
  if (!editor) return;
  
  if (currentEditingMenuItems.length === 0) {
    editor.innerHTML = `<div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">
      Ingen produkter endnu. Klik "+ Tilf√∏j produkt" eller "Import√©r fra tekst".
    </div>`;
    return;
  }
  
  editor.innerHTML = currentEditingMenuItems.map((item, index) => `
    <div class="menu-item-row" style="display:flex;gap:6px;align-items:center;margin-bottom:6px;padding:6px;background:var(--bg3);border-radius:4px">
      <input type="text" class="input" value="${item.number || ''}" placeholder="Nr" 
        style="width:40px;padding:6px;font-size:12px" 
        onchange="updateMenuItem(${index}, 'number', this.value)">
      <input type="text" class="input" value="${item.name || ''}" placeholder="Produktnavn" 
        style="flex:1;padding:6px;font-size:12px" 
        onchange="updateMenuItem(${index}, 'name', this.value)">
      <input type="number" class="input" value="${item.price || ''}" placeholder="Pris" 
        style="width:60px;padding:6px;font-size:12px" 
        onchange="updateMenuItem(${index}, 'price', parseInt(this.value))">
      <button onclick="removeMenuItem(${index})" style="background:none;border:none;cursor:pointer;color:#f87171;font-size:14px">‚úï</button>
    </div>
  `).join('');
}

function addMenuItemRow() {
  const nextNumber = currentEditingMenuItems.length + 1;
  currentEditingMenuItems.push({
    id: Date.now(),
    number: String(nextNumber),
    name: '',
    price: 0,
    category: 'Mad'
  });
  renderMenuItemsEditor();
  
  // Scroll til bunden
  const editor = document.getElementById('menu-items-editor');
  if (editor) editor.scrollTop = editor.scrollHeight;
}

function updateMenuItem(index, field, value) {
  if (currentEditingMenuItems[index]) {
    currentEditingMenuItems[index][field] = value;
  }
}

function removeMenuItem(index) {
  currentEditingMenuItems.splice(index, 1);
  renderMenuItemsEditor();
}

function clearMenuItems() {
  if (confirm('Er du sikker p√• du vil fjerne alle produkter fra menuen?')) {
    currentEditingMenuItems = [];
    renderMenuItemsEditor();
  }
}

function importMenuFromText() {
  const text = prompt(`Inds√¶t menu tekst (et produkt per linje):\n\nFormat: "Nummer. Produktnavn - Pris kr"\nEller: "Produktnavn: Pris"\n\nEksempel:\n1. Pizza Margherita - 89 kr\n2. Calzone - 99 kr\nCoca-Cola: 25`);
  
  if (!text) return;
  
  const lines = text.split('\n').filter(line => line.trim());
  const newItems = [];
  
  lines.forEach((line, index) => {
    // Pr√∏v forskellige formater
    let match;
    let number = String(index + 1);
    let name = '';
    let price = 0;
    
    // Format: "1. Pizza Margherita - 89 kr" eller "1. Pizza Margherita 89"
    match = line.match(/^(\d+)[.\s]+(.+?)[\s-]+(\d+)\s*(kr)?$/i);
    if (match) {
      number = match[1];
      name = match[2].trim();
      price = parseInt(match[3]);
    } else {
      // Format: "Pizza Margherita: 89" eller "Pizza Margherita - 89"
      match = line.match(/^(.+?)[\s:-]+(\d+)\s*(kr)?$/i);
      if (match) {
        name = match[1].trim();
        price = parseInt(match[2]);
      } else {
        // Bare tekst - brug som navn
        name = line.trim();
      }
    }
    
    if (name) {
      newItems.push({
        id: Date.now() + index,
        number: number,
        name: name,
        price: price || 0,
        category: 'Mad'
      });
    }
  });
  
  if (newItems.length > 0) {
    currentEditingMenuItems = [...currentEditingMenuItems, ...newItems];
    renderMenuItemsEditor();
  } else {
    toast('Kunne ikke parse nogen produkter', 'error');
  }
}

function saveMenuFromEditor(restaurantId) {
  // Filtrer tomme items
  const validItems = currentEditingMenuItems.filter(item => item.name && item.name.trim());

  if (validItems.length === 0) {
    // Slet menu
    localStorage.removeItem(`menu_${restaurantId}`);
    const restaurant = restaurants.find(r => r.id === restaurantId);
    if (restaurant) delete restaurant.customMenu;
    // Slet ogs√• fra Supabase
    if (typeof SupabaseDB !== 'undefined' && SupabaseDB.saveMenu) {
      SupabaseDB.saveMenu(restaurantId, { items: [], currency: 'DKK' })
        .catch(err => console.warn('Could not clear menu in Supabase:', err.message));
    }
    return;
  }

  // Gem menu
  const menu = {
    restaurantId: restaurantId,
    items: validItems,
    currency: 'DKK',
    updatedAt: new Date().toISOString()
  };

  // Gem til localStorage (hurtig backup)
  localStorage.setItem(`menu_${restaurantId}`, JSON.stringify(menu));

  // Gem til Supabase (persistent storage)
  if (typeof SupabaseDB !== 'undefined' && SupabaseDB.saveMenu) {
    SupabaseDB.saveMenu(restaurantId, menu)
      .catch(err => console.warn('Could not save menu to Supabase:', err.message));
  }

  // Opdater restaurant objektet
  const restaurant = restaurants.find(r => r.id === restaurantId);
  if (restaurant) {
    restaurant.customMenu = menu;
  }

  console.log(`Menu saved for ${restaurantId}:`, validItems.length, 'items');
}

// =====================================================
// WORKFLOW
// =====================================================

// Workflow Module System
let currentWorkflowModule = localStorage.getItem('workflow_module') || 'restaurant';

const workflowModules = {
  restaurant: {
    name: 'Restaurant / Takeaway',
    title: 'Restaurant Order Flow',
    icon: 'üçï',
    description: 'Workflows til madbestillinger, bordreservationer og kundeservice',
    templates: [
      { id: 'order-food', name: 'üì¶ Bestilling', description: 'Madbestillinger (take-away/levering)' },
      { id: 'book-table', name: 'üçΩÔ∏è Bordreservation', description: 'H√•ndter bordreservationer' },
      { id: 'complaint', name: 'üòû Klage', description: 'Klageh√•ndtering' }
    ]
  },
  haandvaerker: {
    name: 'H√•ndv√¶rker',
    title: 'H√•ndv√¶rker Workflow',
    icon: 'üîß',
    description: 'Workflows til tilbud, tidsbestilling og opf√∏lgning',
    templates: [
      { id: 'tilbud-request', name: 'üìã Tilbudsforesp√∏rgsel', description: 'Modtag og besvar tilbudsanmodninger' },
      { id: 'haandvaerker-booking', name: 'üìÖ Tidsbestilling', description: 'Book tid til opgave' },
      { id: 'followup', name: 'üîÑ Opf√∏lgning', description: 'F√∏lg op p√• afgivne tilbud' }
    ]
  },
  instagram: {
    name: 'Instagram',
    title: 'Instagram Automation',
    icon: 'üì∏',
    description: 'Automatiserede Instagram workflows og engagement',
    templates: [
      { id: 'ig-dm-reply', name: 'üí¨ DM Auto-svar', description: 'Automatiske svar p√• Instagram DMs' },
      { id: 'ig-comment-reply', name: 'üí≠ Kommentar-svar', description: 'Automatiske svar p√• kommentarer' },
      { id: 'ig-story-engagement', name: 'üì± Story Engagement', description: 'H√•ndter story mentions og reaktioner' }
    ]
  },
  facebook: {
    name: 'Facebook',
    title: 'Facebook Automation',
    icon: 'üëç',
    description: 'Automatiserede Facebook workflows og kundeservice',
    templates: [
      { id: 'fb-messenger', name: 'üí¨ Messenger Bot', description: 'Automatiske Messenger beskeder' },
      { id: 'fb-comment-reply', name: 'üí≠ Kommentar-svar', description: 'Automatiske svar p√• opslag' },
      { id: 'fb-review-response', name: '‚≠ê Anmeldelse-svar', description: 'Besvar Facebook anmeldelser' }
    ]
  }
};

function switchWorkflowModule(module) {
  if (!workflowModules[module]) {
    toast('Modul kommer snart', 'info');
    return;
  }

  currentWorkflowModule = module;

  // Update dropdown styling
  document.querySelectorAll('.workflow-module-option').forEach(opt => {
    opt.classList.toggle('active', opt.dataset.module === module);
  });

  // Update selected text in dropdown
  const selectedEl = document.getElementById('workflow-module-selected');
  if (selectedEl && workflowModules[module]) {
    selectedEl.textContent = workflowModules[module].name.split(' / ')[0]; // Get first part of name
  }

  // Update title
  const titleEl = document.getElementById('workflow-module-title');
  if (titleEl) {
    titleEl.textContent = workflowModules[module].title;
  }

  // Save preference
  localStorage.setItem('workflow_module', module);

  // Show toast
  toast(`Skiftet til ${workflowModules[module].name}`, 'success');

  console.log('Switched workflow module to:', module);
}

// Workflow Module Dropdown Functions
function toggleWorkflowModuleDropdown() {
  const dropdown = document.getElementById('workflow-module-dropdown');
  if (dropdown) {
    dropdown.classList.toggle('open');
  }
}

function selectWorkflowModule(module, element) {
  // Update dropdown styling
  document.querySelectorAll('.workflow-module-option').forEach(opt => {
    opt.classList.remove('active');
  });
  if (element) {
    element.classList.add('active');
  }

  // Close dropdown
  const dropdown = document.getElementById('workflow-module-dropdown');
  if (dropdown) {
    dropdown.classList.remove('open');
  }

  // Switch module
  switchWorkflowModule(module);
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
  const dropdown = document.getElementById('workflow-module-dropdown');
  if (dropdown && !dropdown.contains(e.target)) {
    dropdown.classList.remove('open');
  }
});

function initWorkflowModule() {
  const savedModule = localStorage.getItem('workflow_module') || 'restaurant';

  // Update dropdown
  document.querySelectorAll('.workflow-module-option').forEach(opt => {
    opt.classList.toggle('active', opt.dataset.module === savedModule);
  });

  // Update selected text
  const selectedEl = document.getElementById('workflow-module-selected');
  if (selectedEl && workflowModules[savedModule]) {
    selectedEl.textContent = workflowModules[savedModule].name.split(' / ')[0];
  }

  // Update title
  const titleEl = document.getElementById('workflow-module-title');
  if (titleEl && workflowModules[savedModule]) {
    titleEl.textContent = workflowModules[savedModule].title;
  }

  currentWorkflowModule = savedModule;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', initWorkflowModule);

let workflowNodes = [
  // ============================================
  // LAYOUT KONSTANTER: Col spacing=220px, Row spacing=150px
  // Col0=100, Col1=320, Col2=540, Col3=760, Col4=980
  // ============================================
  
  // SEKTION 1: TRIGGERS (Row 0: y=50)
  { id: 'trigger-call', type: 'trigger', label: 'Trigger', sublabel: 'Missed opkald', x: 320, y: 50, icon: 'üìû', next: 'open-check' },
  { id: 'trigger-sms', type: 'trigger', label: 'Trigger', sublabel: 'SMS', x: 540, y: 50, icon: 'üí¨', next: 'open-check' },
  
  // SEKTION 2: OPEN CHECKER (Row 1: y=200)
  { id: 'open-check', type: 'condition', label: 'Open Checker', sublabel: '{{restaurant.openingHours}}', x: 430, y: 200, icon: 'üïê', branches: [
    { id: 'dynamic-open', label: 'Dynamisk: √Öben', class: 'yes', next: 'open-node' },
    { id: 'dynamic-closed', label: 'Dynamisk: Lukket', class: 'no', next: 'send-closed' }
  ]},
  
  // SEKTION 3: OPEN BRANCHES (Row 2: y=350)
  { id: 'open-node', type: 'condition', label: 'Open', x: 210, y: 350, icon: '‚úì', branches: [
    { id: 'missed-call-branch', label: 'Missed Call', class: 'order', next: 'send-missed' },
    { id: 'sms-branch', label: 'SMS', class: 'order', next: 'ai-classify-1' },
    { id: 'none-branch', label: 'None', class: 'none', next: 'end-open-none' }
  ]},
  { id: 'go-to-open', type: 'action', label: 'Go To', x: 430, y: 350, icon: '‚ÜóÔ∏è', next: 'open-node' },
  { id: 'send-closed', type: 'sms', label: 'Lukket besked', sublabel: 'Dynamisk med n√¶ste √•bning', x: 650, y: 350, icon: 'üí¨', message: '{{generateClosedMessage}}', next: 'end-closed' },
  { id: 'end-closed', type: 'end', label: 'END', x: 870, y: 350, icon: 'üèÅ' },
  { id: 'end-open-none', type: 'end', label: 'END', x: 430, y: 500, icon: 'üèÅ' },
  
  // SEKTION 4: MISSED CALL PATH (Col0: x=100)
  { id: 'send-missed', type: 'sms', label: 'Beklager, vi missede dit opkald', x: 100, y: 500, icon: 'üí¨', message: 'Hej! Vi missede desv√¶rre dit opkald. Var det for at bestille mad? Svar JA for at starte din bestilling. Hilsen {restaurant}', next: 'wait-missed' },
  { id: 'wait-missed', type: 'wait', label: 'Wait', x: 100, y: 650, icon: '‚è≥', timeout: 20, branches: [
    { id: 'contact-reply-missed', label: 'Contact Reply', next: 'intent-check-missed' },
    { id: 'timeout-missed', label: 'Time Out', class: 'timeout', next: 'end-timeout-missed' }
  ]},
  { id: 'end-timeout-missed', type: 'end', label: 'END', x: 320, y: 650, icon: 'üèÅ' },
  { id: 'intent-check-missed', type: 'condition', label: 'Intent check', x: 100, y: 800, icon: 'ü§ñ', branches: [
    { id: 'yes-intent', label: 'Yes', class: 'yes', next: 'go-to-prev-order-1' },
    { id: 'no-intent', label: 'No', class: 'no', next: 'end-no-intent' },
    { id: 'none-intent', label: 'None', class: 'none', next: 'notification-unclear-1' },
    { id: 'order-intent', label: 'ORDER', class: 'order', next: 'condition-prev-order' }
  ]},
  { id: 'go-to-prev-order-1', type: 'action', label: 'Go To', x: 100, y: 950, icon: '‚ÜóÔ∏è', next: 'condition-prev-order' },
  { id: 'end-no-intent', type: 'end', label: 'END', x: 320, y: 800, icon: 'üèÅ' },
  { id: 'notification-unclear-1', type: 'action', label: 'Notification', x: 100, y: 1100, icon: 'üîî', next: 'end-notification-1' },
  { id: 'end-notification-1', type: 'end', label: 'END', x: 100, y: 1250, icon: 'üèÅ' },
  
  // SEKTION 5: SMS PATH + AI CLASSIFICATION (Col3-4: x=760-980)
  { id: 'ai-classify-1', type: 'ai', label: '#1 AI Classification', x: 760, y: 500, icon: 'ü§ñ', systemPrompt: 'Kategoriser kundens svar: POSITIVE/YES, NEGATIVE/NO, GREETING, eller NONE.', next: 'ai-condition-1' },
  { id: 'ai-condition-1', type: 'condition', label: 'Condition', x: 760, y: 650, icon: '‚ùì', branches: [
    { id: 'order-ai', label: 'ORDER', class: 'order', next: 'condition-prev-order' },
    { id: 'greeting-ai', label: 'GREETING', class: 'greeting', next: 'send-greeting' },
    { id: 'none-ai', label: 'None', class: 'none', next: 'end-none-ai' }
  ]},
  { id: 'end-none-ai', type: 'end', label: 'END', x: 980, y: 650, icon: 'üèÅ' },
  { id: 'send-greeting', type: 'sms', label: 'Vil du bestille over SMS?', x: 760, y: 800, icon: 'üí¨', message: 'Hej! Kunne du t√¶nke dig at afgive en bestilling over SMS?', next: 'wait-greeting' },
  { id: 'wait-greeting', type: 'wait', label: 'Wait', x: 760, y: 950, icon: '‚è≥', timeout: 20, branches: [
    { id: 'contact-reply-greet', label: 'Contact Reply', next: 'intent-check-greet' },
    { id: 'timeout-greet', label: 'Time Out', class: 'timeout', next: 'end-timeout-greet' }
  ]},
  { id: 'end-timeout-greet', type: 'end', label: 'END', x: 980, y: 950, icon: 'üèÅ' },
  { id: 'intent-check-greet', type: 'condition', label: 'Intent check', x: 760, y: 1100, icon: 'ü§ñ', branches: [
    { id: 'yes-greet', label: 'Yes', class: 'yes', next: 'go-to-prev-order-2' },
    { id: 'no-greet', label: 'No', class: 'no', next: 'go-to-end-greet' },
    { id: 'none-greet', label: 'None', class: 'none', next: 'end-none-greet' }
  ]},
  { id: 'go-to-prev-order-2', type: 'action', label: 'Go To', x: 760, y: 1250, icon: '‚ÜóÔ∏è', next: 'condition-prev-order' },
  { id: 'go-to-end-greet', type: 'action', label: 'Go To', x: 980, y: 1100, icon: '‚ÜóÔ∏è', next: 'end-go-to-greet' },
  { id: 'end-none-greet', type: 'end', label: 'END', x: 1200, y: 1100, icon: 'üèÅ' },
  { id: 'end-go-to-greet', type: 'end', label: 'END', x: 980, y: 1250, icon: 'üèÅ' },
  
  // SEKTION 6: PREVIOUS ORDER CHECK (Center: x=430)
  { id: 'condition-prev-order', type: 'condition', label: 'Previous Order Check', x: 430, y: 1400, icon: '‚ùì', branches: [
    { id: 'prev-delivery', label: 'Prev Delivery', class: 'order', next: 'reorder-delivery' },
    { id: 'prev-pickup', label: 'Prev Pickup', class: 'order', next: 'reorder-pickup' },
    { id: 'normal', label: 'Normal', class: 'none', next: 'ask-delivery-type' }
  ]},
  
  // SEKTION 7: REORDER + DELIVERY TYPE
  { id: 'reorder-delivery', type: 'sms', label: 'Genbestil levering?', x: 100, y: 1550, icon: 'üí¨', message: 'Vil du genbestille din sidste levering?', next: 'wait-reorder-del' },
  { id: 'reorder-pickup', type: 'sms', label: 'Genbestil afhentning?', x: 320, y: 1550, icon: 'üí¨', message: 'Vil du genbestille din sidste afhentning?', next: 'wait-reorder-pick' },
  { id: 'ask-delivery-type', type: 'sms', label: 'Levering eller afhentning?', x: 650, y: 1550, icon: 'üí¨', message: 'Super! Skal maden leveres eller vil du hente? (Svar Levering eller Afhentning)', next: 'wait-delivery-type' },
  
  { id: 'wait-reorder-del', type: 'wait', label: 'Wait', x: 100, y: 1700, icon: '‚è≥', timeout: 20, branches: [
    { id: 'reply-reorder-del', label: 'Contact Reply', next: 'intent-reorder-del' },
    { id: 'timeout-reorder-del', label: 'Time Out', class: 'timeout', next: 'end-reorder-timeout-del' }
  ]},
  { id: 'wait-reorder-pick', type: 'wait', label: 'Wait', x: 320, y: 1700, icon: '‚è≥', timeout: 20, branches: [
    { id: 'reply-reorder-pick', label: 'Contact Reply', next: 'intent-reorder-pick' },
    { id: 'timeout-reorder-pick', label: 'Time Out', class: 'timeout', next: 'end-reorder-timeout-pick' }
  ]},
  { id: 'wait-delivery-type', type: 'wait', label: 'Wait', x: 650, y: 1700, icon: '‚è≥', timeout: 20, branches: [
    { id: 'reply-type', label: 'Contact Reply', next: 'ai-delivery-type' },
    { id: 'timeout-type', label: 'Time Out', class: 'timeout', next: 'end-timeout-type' }
  ]},
  
  { id: 'end-reorder-timeout-del', type: 'end', label: 'END', x: 100, y: 2000, icon: 'üèÅ' },
  { id: 'end-reorder-timeout-pick', type: 'end', label: 'END', x: 320, y: 2000, icon: 'üèÅ' },
  { id: 'end-timeout-type', type: 'end', label: 'END', x: 870, y: 1700, icon: 'üèÅ' },
  
  { id: 'intent-reorder-del', type: 'condition', label: 'Intent check', x: 100, y: 1850, icon: 'ü§ñ', branches: [
    { id: 'yes-reorder-del', label: 'Yes', class: 'yes', next: 'go-to-delivery-type' },
    { id: 'no-reorder-del', label: 'No', class: 'no', next: 'lukker-chat-del' }
  ]},
  { id: 'intent-reorder-pick', type: 'condition', label: 'Intent check', x: 320, y: 1850, icon: 'ü§ñ', branches: [
    { id: 'yes-reorder-pick', label: 'Yes', class: 'yes', next: 'go-to-pickup-type' },
    { id: 'no-reorder-pick', label: 'No', class: 'no', next: 'lukker-chat-pick' }
  ]},
  
  { id: 'go-to-delivery-type', type: 'action', label: 'Go To', x: 100, y: 2150, icon: '‚ÜóÔ∏è', next: 'order-type-delivery' },
  { id: 'lukker-chat-del', type: 'sms', label: 'Lukker chat', x: 100, y: 2300, icon: 'üí¨', message: 'Ok, vi lukker denne chat. Kontakt os igen!', next: 'end-reorder-del' },
  { id: 'end-reorder-del', type: 'end', label: 'END', x: 100, y: 2450, icon: 'üèÅ' },
  
  { id: 'go-to-pickup-type', type: 'action', label: 'Go To', x: 320, y: 2150, icon: '‚ÜóÔ∏è', next: 'order-type-pickup' },
  { id: 'lukker-chat-pick', type: 'sms', label: 'Lukker chat', x: 320, y: 2300, icon: 'üí¨', message: 'Ok, vi lukker denne chat. Kontakt os igen!', next: 'end-reorder-pick' },
  { id: 'end-reorder-pick', type: 'end', label: 'END', x: 320, y: 2450, icon: 'üèÅ' },
  
  // SEKTION 8: AI DELIVERY TYPE
  { id: 'ai-delivery-type', type: 'ai', label: '#3 GPT Delivery Check', x: 650, y: 1850, icon: 'ü§ñ', systemPrompt: 'Kategoriser: PICKUP, DELIVERY, eller UNCLEAR.', next: 'delivery-condition' },
  { id: 'delivery-condition', type: 'condition', label: 'Condition', x: 650, y: 2000, icon: '‚ùì', branches: [
    { id: 'pickup-branch', label: 'Pickup', class: 'yes', next: 'order-type-pickup' },
    { id: 'delivery-branch', label: 'DELIVERY', class: 'order', next: 'order-type-delivery' },
    { id: 'none-delivery', label: 'None', class: 'none', next: 'notification-delivery' }
  ]},
  { id: 'notification-delivery', type: 'action', label: 'Notification', x: 870, y: 2000, icon: 'üîî', next: 'end-notification-delivery' },
  { id: 'end-notification-delivery', type: 'end', label: 'END', x: 870, y: 2150, icon: 'üèÅ' },
  
  // SEKTION 9: ORDER TYPE + ASK ORDER
  { id: 'order-type-pickup', type: 'action', label: 'Order Type: Pickup', x: 540, y: 2150, icon: 'üè™', next: 'ask-order-pickup' },
  { id: 'order-type-delivery', type: 'action', label: 'Order Type: Delivery', x: 760, y: 2150, icon: 'üöó', next: 'ask-address' },
  
  { id: 'ask-order-pickup', type: 'sms', label: 'Send din bestilling', x: 540, y: 2300, icon: 'üí¨', message: 'Lyder godt! Send hele din bestilling i √©n besked. Menu: {menu_url}', next: 'wait-order-pickup' },
  { id: 'ask-address', type: 'sms', label: 'Hvad er din adresse?', x: 760, y: 2300, icon: 'üí¨', message: 'Hvad er den fulde leveringsadresse inkl. postnummer?', next: 'wait-address' },
  
  { id: 'wait-order-pickup', type: 'wait', label: 'Wait', x: 540, y: 2450, icon: '‚è≥', timeout: 25, branches: [
    { id: 'contact-reply-order-p', label: 'Contact Reply', next: 'ai-order-parser' },
    { id: 'timeout-order-p', label: 'Time Out', class: 'timeout', next: 'end-timeout-order-p' }
  ]},
  { id: 'wait-address', type: 'wait', label: 'Wait', x: 760, y: 2450, icon: '‚è≥', timeout: 25, branches: [
    { id: 'contact-reply-addr', label: 'Contact Reply', next: 'ai-address-extractor' },
    { id: 'timeout-addr', label: 'Time Out', class: 'timeout', next: 'end-timeout-addr' }
  ]},
  { id: 'end-timeout-order-p', type: 'end', label: 'END', x: 540, y: 2600, icon: 'üèÅ' },
  { id: 'end-timeout-addr', type: 'end', label: 'END', x: 980, y: 2450, icon: 'üèÅ' },
  
  // SEKTION 10: ADDRESS EXTRACTOR (Right side)
  { id: 'ai-address-extractor', type: 'ai', label: '#5 Address Extractor', x: 760, y: 2600, icon: 'ü§ñ', systemPrompt: 'Udtr√¶k adressen. Format: [Vejnavn] [Nr], [Postnr] [By]. Hvis mangelfuld: ERROR.', next: 'address-condition' },
  { id: 'address-condition', type: 'condition', label: 'Condition', x: 760, y: 2750, icon: '‚ùì', branches: [
    { id: 'addr-valid', label: 'Valid', class: 'yes', next: 'update-delivery-address' },
    { id: 'addr-error', label: 'ERROR', class: 'no', next: 'end-addr-error' }
  ]},
  { id: 'update-delivery-address', type: 'action', label: 'Update Address', x: 760, y: 2900, icon: 'üìç', next: 'ask-order-delivery' },
  { id: 'end-addr-error', type: 'end', label: 'END', x: 980, y: 2750, icon: 'üèÅ' },
  
  { id: 'ask-order-delivery', type: 'sms', label: 'Send din bestilling', x: 760, y: 3050, icon: 'üí¨', message: 'Lyder godt! Send hele din bestilling i √©n besked. Menu: {menu_url}', next: 'wait-order-delivery' },
  { id: 'wait-order-delivery', type: 'wait', label: 'Wait', x: 760, y: 3200, icon: '‚è≥', timeout: 25, branches: [
    { id: 'contact-reply-order-d', label: 'Contact Reply', next: 'ai-order-parser' },
    { id: 'timeout-order-d', label: 'Time Out', class: 'timeout', next: 'end-timeout-order-d' }
  ]},
  { id: 'end-timeout-order-d', type: 'end', label: 'END', x: 980, y: 3200, icon: 'üèÅ' },
  
  // SEKTION 11: ORDER PARSER (Center)
  { id: 'ai-order-parser', type: 'ai', label: '#4 GPT Order Parser', x: 430, y: 2750, icon: 'ü§ñ', systemPrompt: 'Analyser bestillingen. JSON med items og valid: true/false.', next: 'order-parser-condition' },
  { id: 'order-parser-condition', type: 'condition', label: 'Condition', x: 430, y: 2900, icon: '‚ùì', branches: [
    { id: 'order-valid', label: 'Valid', class: 'yes', next: 'send-confirm-order' },
    { id: 'order-invalid', label: 'Invalid', class: 'no', next: 'end-order-invalid' },
    { id: 'order-offtopic', label: 'Off Topic', class: 'none', next: 'notification-off-topic' }
  ]},
  { id: 'end-order-invalid', type: 'end', label: 'END', x: 210, y: 2900, icon: 'üèÅ' },
  { id: 'notification-off-topic', type: 'action', label: 'Notification', x: 210, y: 3050, icon: 'üîî', next: 'end-notification-off' },
  { id: 'end-notification-off', type: 'end', label: 'END', x: 210, y: 3200, icon: 'üèÅ' },
  
  // SEKTION 12: ORDER CONFIRMATION
  { id: 'send-confirm-order', type: 'sms', label: 'Bekr√¶ft bestilling', x: 430, y: 3050, icon: 'üí¨', message: 'Bare for at bekr√¶fte: {order}. Er det korrekt?', next: 'wait-confirm' },
  { id: 'wait-confirm', type: 'wait', label: 'Wait', x: 430, y: 3200, icon: '‚è≥', timeout: 25, branches: [
    { id: 'contact-reply-confirm', label: 'Contact Reply', next: 'order-confirmation' },
    { id: 'timeout-confirm', label: 'Time Out', class: 'timeout', next: 'end-timeout-confirm' }
  ]},
  { id: 'end-timeout-confirm', type: 'end', label: 'END', x: 210, y: 3350, icon: 'üèÅ' },
  
  { id: 'order-confirmation', type: 'condition', label: 'Order Confirmation', x: 430, y: 3350, icon: '‚úì', branches: [
    { id: 'yes-confirm', label: 'Yes', class: 'yes', next: 'ask-name' },
    { id: 'no-confirm', label: 'No', class: 'no', next: 'send-retry' },
    { id: 'none-confirm', label: 'None', class: 'none', next: 'notification-confirm' }
  ]},
  { id: 'send-retry', type: 'sms', label: 'Pr√∏v igen', x: 210, y: 3500, icon: 'üí¨', message: 'Ingen problem! Hvad vil du bestille?', next: 'go-to-wait-order' },
  { id: 'go-to-wait-order', type: 'action', label: 'Go To', x: 210, y: 3650, icon: '‚ÜóÔ∏è', next: 'wait-order-pickup' },
  { id: 'notification-confirm', type: 'action', label: 'Notification', x: 650, y: 3350, icon: 'üîî', next: 'end-notification-confirm' },
  { id: 'end-notification-confirm', type: 'end', label: 'END', x: 650, y: 3500, icon: 'üèÅ' },
  
  // SEKTION 13: ASK NAME
  { id: 'ask-name', type: 'sms', label: 'Hvad er dit navn?', x: 430, y: 3500, icon: 'üí¨', message: 'M√• jeg bede om dit fulde navn til bestillingen?', next: 'wait-name' },
  { id: 'wait-name', type: 'wait', label: 'Wait', x: 430, y: 3650, icon: '‚è≥', timeout: 25, branches: [
    { id: 'contact-reply-name', label: 'Contact Reply', next: 'ai-name-extractor' },
    { id: 'timeout-name', label: 'Time Out', class: 'timeout', next: 'end-timeout-name' }
  ]},
  { id: 'end-timeout-name', type: 'end', label: 'END', x: 650, y: 3650, icon: 'üèÅ' },
  
  // SEKTION 14: NAME EXTRACTOR
  { id: 'ai-name-extractor', type: 'ai', label: '#6 GPT Name Extractor', x: 430, y: 3800, icon: 'ü§ñ', systemPrompt: 'Udtr√¶k kundens navn. Kun navnet eller ERROR.', next: 'name-condition' },
  { id: 'name-condition', type: 'condition', label: 'Condition', x: 430, y: 3950, icon: '‚ùì', branches: [
    { id: 'name-valid', label: 'Valid', class: 'yes', next: 'update-contact-name' },
    { id: 'name-error', label: 'ERROR', class: 'no', next: 'end-error-name' }
  ]},
  { id: 'end-error-name', type: 'end', label: 'END', x: 650, y: 3950, icon: 'üèÅ' },
  
  // SEKTION 15: SAVE & PROCESS (Center column)
  { id: 'update-contact-name', type: 'action', label: 'Update Contact Name', x: 430, y: 4100, icon: 'üë§', next: 'save-order-next' },
  { id: 'save-order-next', type: 'action', label: 'Save Order', x: 430, y: 4250, icon: 'üíæ', next: 'new-order-task' },
  { id: 'new-order-task', type: 'action', label: 'New Order Task', x: 430, y: 4400, icon: 'üìã', next: 'increment-order-count' },
  { id: 'increment-order-count', type: 'action', label: '+1 Order Count', x: 430, y: 4550, icon: '‚ûï', next: 'internal-notification' },
  { id: 'internal-notification', type: 'action', label: 'Internal Notification', x: 430, y: 4700, icon: 'üîî', next: 'send-final-confirm' },
  
  // SEKTION 16: FINAL CONFIRMATION
  { id: 'send-final-confirm', type: 'sms', label: 'Ordrebekr√¶ftelse', x: 430, y: 4850, icon: 'üí¨', message: 'Tak! Din ordre er sendt til k√∏kkenet. Vi giver besked n√•r maden er klar!', next: 'ask-receipt' },
  
  // SEKTION 17: RECEIPT WORKFLOW (NY)
  { id: 'ask-receipt', type: 'sms', label: 'Sp√∏rg om kvittering', x: 430, y: 5000, icon: 'üí¨', message: '√ònsker du en kvittering p√• din bestilling? Svar JA eller NEJ.', next: 'wait-receipt' },
  { id: 'wait-receipt', type: 'wait', label: 'Wait', x: 430, y: 5150, icon: '‚è≥', timeout: 15, branches: [
    { id: 'contact-reply-receipt', label: 'Contact Reply', next: 'intent-check-receipt' },
    { id: 'timeout-receipt', label: 'Time Out', class: 'timeout', next: 'push-to-orders' }
  ]},
  { id: 'intent-check-receipt', type: 'condition', label: 'Intent check', x: 430, y: 5300, icon: 'ü§ñ', branches: [
    { id: 'yes-receipt', label: 'Yes', class: 'yes', next: 'generate-receipt' },
    { id: 'no-receipt', label: 'No', class: 'no', next: 'send-no-receipt' }
  ]},
  
  // Receipt YES branch
  { id: 'generate-receipt', type: 'action', label: 'Gener√©r kvittering', x: 210, y: 5450, icon: 'üìÑ', next: 'send-receipt-sms' },
  { id: 'send-receipt-sms', type: 'sms', label: 'Send kvittering', x: 210, y: 5600, icon: 'üí¨', message: 'üìã KVITTERING\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nOrdre: #{order_number}\n{order_items}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nTotal: {total} kr\nAfhentning: {pickup_time}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nTak for din bestilling!\n{restaurant_name}', next: 'push-to-orders' },
  
  // Receipt NO branch
  { id: 'send-no-receipt', type: 'sms', label: 'P√¶n afslutning', x: 650, y: 5450, icon: 'üí¨', message: 'Helt i orden! Vi gl√¶der os til at se dig. Hav en fortsat god dag!', next: 'push-to-orders' },
  
  // SEKTION 18: ORDER PROCESSING + REVIEW
  { id: 'push-to-orders', type: 'action', label: 'Push til Ordrer', x: 430, y: 5750, icon: 'üì¶', next: 'add-to-review' },
  { id: 'add-to-review', type: 'action', label: 'Add to Review Flow', x: 430, y: 5900, icon: '‚≠ê', next: 'wait-review-delay' },
  { id: 'wait-review-delay', type: 'wait', label: 'Wait Review Delay', x: 430, y: 6050, icon: '‚è≥', timeout: 60, next: 'send-review-request' },
  { id: 'send-review-request', type: 'sms', label: 'Anmeldelsesanmodning', x: 430, y: 6200, icon: '‚≠ê', message: 'Tak for din ordre! Giv os gerne en anmeldelse: Google: {google_review_url} Trustpilot: {trustpilot_url}', next: 'wait-1-hour' },
  { id: 'wait-1-hour', type: 'wait', label: 'Wait 1 hour lock', x: 430, y: 6350, icon: '‚è≥', timeout: 60, next: 'end-final' },
  { id: 'end-final', type: 'end', label: 'END', x: 430, y: 6500, icon: 'üèÅ' }
];

let selectedNodeId = null;

// SVG ikoner til workflow noder
const nodeIcons = {
  trigger: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
  sms: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
  wait: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
  condition: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
  ai: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13A1.5 1.5 0 0 0 6 14.5 1.5 1.5 0 0 0 7.5 16 1.5 1.5 0 0 0 9 14.5 1.5 1.5 0 0 0 7.5 13m9 0a1.5 1.5 0 0 0-1.5 1.5 1.5 1.5 0 0 0 1.5 1.5 1.5 1.5 0 0 0 1.5-1.5 1.5 1.5 0 0 0-1.5-1.5"/></svg>',
  action: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>',
  end: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>',
  goto: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>'
};

function getNodeIcon(node) {
  // Returner SVG baseret p√• node type
  return nodeIcons[node.type] || nodeIcons['end'];
}

function renderWorkflowNodes() {
  const container = document.getElementById('workflow-nodes');
  const svg = document.getElementById('wf-connections');
  
  // Clear
  container.innerHTML = '';
  svg.innerHTML = '';
  
  // Render connections first
  workflowNodes.forEach(node => {
    if (node.next) {
      const targetNode = workflowNodes.find(n => n.id === node.next);
      if (targetNode) {
        drawConnection(svg, node, targetNode);
      }
    }
    if (node.branches) {
      node.branches.forEach(branch => {
        if (branch.next) {
          const targetNode = workflowNodes.find(n => n.id === branch.next);
          if (targetNode) {
            drawConnection(svg, node, targetNode, branch.label);
          }
        }
      });
    }
  });
  
  // Render nodes
  workflowNodes.forEach(node => {
    const nodeEl = document.createElement('div');
    const disabledClass = node.disabled ? ' disabled' : '';
    nodeEl.className = `wf-node ${node.id === selectedNodeId ? 'selected' : ''}${disabledClass}`;
    nodeEl.id = `node-${node.id}`;
    nodeEl.style.left = `${node.x}px`;
    nodeEl.style.top = `${node.y}px`;
    
    const iconClass = node.type === 'trigger' ? 'trigger' : 
                      node.type === 'condition' ? 'condition' :
                      node.type === 'sms' ? 'sms' :
                      node.type === 'wait' ? 'wait' :
                      node.type === 'ai' ? 'ai' :
                      node.type === 'action' ? 'action' : 'end';
    
    // Brug SVG ikon i stedet for emoji
    const iconSvg = getNodeIcon(node);
    
    // Add disabled badge if node is disabled
    const disabledBadge = node.disabled ? '<span style="position:absolute;top:-8px;right:-8px;background:var(--danger);color:white;font-size:9px;padding:2px 6px;border-radius:10px">OFF</span>' : '';
    
    let html = `
      ${disabledBadge}
      <div class="wf-node-header">
        <div class="wf-node-icon ${iconClass}">${iconSvg}</div>
        <div class="wf-node-info">
          <div class="wf-node-type">${node.type.toUpperCase()}</div>
          <div class="wf-node-label">${node.label}</div>
        </div>
        <button class="wf-node-menu" onclick="event.stopPropagation(); openNodeEditor('${node.id}')">‚ãØ</button>
      </div>
    `;
    
    if (node.sublabel) {
      html += `<div class="wf-node-body">${node.sublabel}</div>`;
    }
    
    if (node.branches && node.branches.length > 0) {
      html += `<div class="wf-node-branches">`;
      node.branches.forEach(branch => {
        const branchClass = branch.class || '';
        html += `<span class="wf-branch ${branchClass}" onclick="event.stopPropagation(); editBranch('${node.id}', '${branch.id}')">${branch.label}</span>`;
      });
      html += `</div>`;
    }
    
    nodeEl.innerHTML = html;
    
    // Single click - select node
    nodeEl.addEventListener('click', () => selectNode(node.id));
    
    // Double click - open editor
    nodeEl.addEventListener('dblclick', (e) => {
      e.stopPropagation();
      openNodeEditor(node.id);
    });
    
    // Drag handler
    makeDraggable(nodeEl, node);
    
    container.appendChild(nodeEl);
  });
}

// Canvas transform state - SKAL v√¶re defineret f√∏r centerWorkflow
let canvasTransform = { x: 0, y: 0, scale: 1 };
let canvasPanningInitialized = false;
let isSpaceHeld = false;

// Centrer workflow i viewport - starter med triggers synlige og centreret horisontalt
function centerWorkflow() {
  const canvas = document.getElementById('workflow-canvas');
  if (!canvas || workflowNodes.length === 0) return;
  
  // Ensure viewport exists
  let viewport = canvas.querySelector('.canvas-viewport');
  if (!viewport) {
    console.warn('[Workflow] No viewport found, skipping center');
    return;
  }
  
  // Get actual viewport dimensions (wait for render)
  const viewportWidth = canvas.clientWidth || canvas.offsetWidth || 800;
  const viewportHeight = canvas.clientHeight || canvas.offsetHeight || 600;
  
  // Skip if dimensions are too small (not rendered yet)
  if (viewportWidth < 100 || viewportHeight < 100) {
    console.warn('[Workflow] Viewport too small, retrying...');
    setTimeout(centerWorkflow, 100);
    return;
  }
  
  // Find bounding box af alle noder
  let minX = Infinity, minY = Infinity;
  let maxX = -Infinity, maxY = -Infinity;
  
  workflowNodes.forEach(node => {
    minX = Math.min(minX, node.x);
    minY = Math.min(minY, node.y);
    maxX = Math.max(maxX, node.x + 180);
    maxY = Math.max(maxY, node.y + 100);
  });
  
  // Beregn node cluster dimensioner
  const nodesWidth = maxX - minX;
  const nodesHeight = maxY - minY;
  const nodesCenterX = minX + nodesWidth / 2;
  const nodesCenterY = minY + nodesHeight / 2;
  
  // Calculate scale to fit all nodes with padding
  const padding = 80;
  const scaleX = (viewportWidth - padding * 2) / nodesWidth;
  const scaleY = (viewportHeight - padding * 2) / nodesHeight;
  
  // Use fitScale to ensure all nodes are visible, but don't zoom in beyond 100%
  const fitScale = Math.min(scaleX, scaleY, 1);
  
  // Set scale - start at 80% or fitScale if nodes are large
  canvasTransform.scale = Math.max(0.3, Math.min(0.8, fitScale));
  
  // Center nodes in viewport
  canvasTransform.x = (viewportWidth / 2) - (nodesCenterX * canvasTransform.scale);
  canvasTransform.y = (viewportHeight / 2) - (nodesCenterY * canvasTransform.scale);
  
  // Apply transform
  viewport.style.transform = `translate(${canvasTransform.x}px, ${canvasTransform.y}px) scale(${canvasTransform.scale})`;
  
  // Update zoom display
  const zoomDisplay = document.getElementById('zoom-display');
  if (zoomDisplay) zoomDisplay.textContent = Math.round(canvasTransform.scale * 100) + '%';
  
  console.log(`[Workflow] Centreret - Viewport: ${viewportWidth}x${viewportHeight}, Nodes: ${Math.round(nodesWidth)}x${Math.round(nodesHeight)}, Scale: ${Math.round(canvasTransform.scale*100)}%`);
}

// FitView function - shows top triggers at comfortable zoom
function fitWorkflowToView() {
  const canvas = document.getElementById('workflow-canvas');
  if (!canvas || workflowNodes.length === 0) return;
  
  let viewport = canvas.querySelector('.canvas-viewport');
  if (!viewport) {
    console.warn('[Workflow] fitView: No viewport');
    return;
  }
  
  const viewportWidth = canvas.clientWidth || 800;
  const viewportHeight = canvas.clientHeight || 600;
  
  if (viewportWidth < 100 || viewportHeight < 100) {
    setTimeout(fitWorkflowToView, 100);
    return;
  }
  
  // Find only the top nodes (triggers) for initial view
  const topNodes = workflowNodes.filter(n => n.y <= 400);
  const targetNodes = topNodes.length > 0 ? topNodes : workflowNodes.slice(0, 10);
  
  let minX = Infinity, minY = Infinity;
  let maxX = -Infinity, maxY = -Infinity;
  
  targetNodes.forEach(node => {
    minX = Math.min(minX, node.x);
    minY = Math.min(minY, node.y);
    maxX = Math.max(maxX, node.x + 180);
    maxY = Math.max(maxY, node.y + 100);
  });
  
  const nodesWidth = maxX - minX;
  const nodesHeight = maxY - minY;
  const nodesCenterX = minX + nodesWidth / 2;
  
  // Set comfortable zoom level (80%)
  canvasTransform.scale = 0.8;
  
  // Center horizontally, position top nodes near top of view
  canvasTransform.x = (viewportWidth / 2) - (nodesCenterX * canvasTransform.scale);
  canvasTransform.y = 40 - (minY * canvasTransform.scale);
  
  viewport.style.transform = `translate(${canvasTransform.x}px, ${canvasTransform.y}px) scale(${canvasTransform.scale})`;
  
  const zoomDisplay = document.getElementById('zoom-display');
  if (zoomDisplay) zoomDisplay.textContent = Math.round(canvasTransform.scale * 100) + '%';
  
  console.log(`[Workflow] fitView - Scale: ${Math.round(canvasTransform.scale*100)}%, X: ${Math.round(canvasTransform.x)}, Y: ${Math.round(canvasTransform.y)}`);
}

// Initialiser canvas panning - Figma/Miro style infinite canvas
function initCanvasPanning() {
  if (canvasPanningInitialized) return;
  
  const canvas = document.getElementById('workflow-canvas');
  if (!canvas) return;
  
  canvasPanningInitialized = true;
  
  let isPanning = false;
  let startX, startY;
  
  // Get viewport element (create if not exists)
  let viewport = canvas.querySelector('.canvas-viewport');
  if (!viewport) {
    // Wrap existing content in viewport
    const grid = canvas.querySelector('.canvas-grid');
    const connections = canvas.querySelector('.wf-connections');
    const nodes = canvas.querySelector('.nodes-container');
    
    viewport = document.createElement('div');
    viewport.className = 'canvas-viewport';
    viewport.style.width = '5000px';
    viewport.style.height = '7000px';
    
    if (grid) viewport.appendChild(grid);
    if (connections) viewport.appendChild(connections);
    if (nodes) viewport.appendChild(nodes);
    
    canvas.appendChild(viewport);
  }
  
  function updateTransform() {
    viewport.style.transform = `translate(${canvasTransform.x}px, ${canvasTransform.y}px) scale(${canvasTransform.scale})`;
  }
  
  // Space key handling for pan mode
  document.addEventListener('keydown', (e) => {
    if (e.code === 'Space' && !isSpaceHeld && document.getElementById('page-workflow').classList.contains('active')) {
      isSpaceHeld = true;
      canvas.classList.add('space-held');
      e.preventDefault();
    }
  });
  
  document.addEventListener('keyup', (e) => {
    if (e.code === 'Space') {
      isSpaceHeld = false;
      canvas.classList.remove('space-held');
    }
  });
  
  // Mouse down - start panning
  canvas.addEventListener('mousedown', (e) => {
    // Pan with space + click, middle mouse, or direct canvas click
    const isMiddleMouse = e.button === 1;
    const isLeftClick = e.button === 0;
    const onCanvas = !e.target.closest('.wf-node') && !e.target.closest('.test-panel') && !e.target.closest('.node-editor');
    
    if (isMiddleMouse || (isSpaceHeld && isLeftClick) || (isLeftClick && onCanvas)) {
      isPanning = true;
      canvas.classList.add('panning');
      startX = e.clientX - canvasTransform.x;
      startY = e.clientY - canvasTransform.y;
      e.preventDefault();
    }
  });
  
  // Mouse move - pan canvas
  document.addEventListener('mousemove', (e) => {
    if (!isPanning) return;
    
    canvasTransform.x = e.clientX - startX;
    canvasTransform.y = e.clientY - startY;
    
    // Clamp to reasonable bounds
    const maxPan = 2000;
    canvasTransform.x = Math.max(-maxPan, Math.min(maxPan, canvasTransform.x));
    canvasTransform.y = Math.max(-maxPan, Math.min(maxPan, canvasTransform.y));
    
    updateTransform();
  });
  
  // Mouse up - stop panning
  document.addEventListener('mouseup', () => {
    if (isPanning) {
      isPanning = false;
      canvas.classList.remove('panning');
    }
  });
  
  // Mouse wheel - zoom
  canvas.addEventListener('wheel', (e) => {
    if (e.ctrlKey || e.metaKey) {
      e.preventDefault();
      
      const delta = e.deltaY > 0 ? 0.9 : 1.1;
      const newScale = Math.max(0.25, Math.min(2, canvasTransform.scale * delta));
      
      // Zoom towards mouse position
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;
      
      const scaleChange = newScale / canvasTransform.scale;
      canvasTransform.x = mouseX - (mouseX - canvasTransform.x) * scaleChange;
      canvasTransform.y = mouseY - (mouseY - canvasTransform.y) * scaleChange;
      canvasTransform.scale = newScale;
      
      updateTransform();
      document.getElementById('zoom-level').textContent = Math.round(newScale * 100) + '%';
    } else {
      // Normal scroll to pan
      e.stopPropagation();
      canvasTransform.x -= e.deltaX;
      canvasTransform.y -= e.deltaY;
      updateTransform();
    }
  }, { passive: false });
  
  // Initial transform
  updateTransform();
}

function drawConnection(svg, fromNode, toNode, label) {
  // Calculate positions based on node type and position
  const fromWidth = 160;
  const fromHeight = fromNode.branches ? 100 : 70;
  
  const fromX = fromNode.x + fromWidth / 2;
  const fromY = fromNode.y + fromHeight;
  const toX = toNode.x + fromWidth / 2;
  const toY = toNode.y;
  
  // Create path with bezier curve
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  
  // Calculate control points for smoother curves
  const deltaY = toY - fromY;
  const deltaX = Math.abs(toX - fromX);
  
  let d;
  if (deltaX < 50) {
    // Straight down
    d = `M ${fromX} ${fromY} L ${toX} ${toY - 8}`;
  } else {
    // Curved path
    const cp1Y = fromY + Math.min(deltaY * 0.3, 50);
    const cp2Y = toY - Math.min(deltaY * 0.3, 50);
    d = `M ${fromX} ${fromY} C ${fromX} ${cp1Y}, ${toX} ${cp2Y}, ${toX} ${toY - 8}`;
  }
  
  path.setAttribute('d', d);
  path.setAttribute('class', 'wf-connection');
  path.setAttribute('fill', 'none');
  svg.appendChild(path);
  
  // Add arrow at end
  const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
  arrow.setAttribute('points', `${toX},${toY} ${toX-5},${toY-10} ${toX+5},${toY-10}`);
  arrow.setAttribute('class', 'wf-connection-arrow');
  svg.appendChild(arrow);
}

function makeDraggable(element, node) {
  let isDragging = false;
  let startX, startY, nodeStartX, nodeStartY;
  
  element.addEventListener('mousedown', (e) => {
    if (e.target.closest('.wf-node-menu') || e.target.closest('.wf-branch')) return;
    if (isSpaceHeld) return; // Don't drag nodes when panning
    isDragging = true;
    startX = e.clientX;
    startY = e.clientY;
    nodeStartX = node.x;
    nodeStartY = node.y;
    element.style.zIndex = '100';
    e.preventDefault();
    e.stopPropagation();
  });
  
  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    // Account for current zoom level
    const scale = canvasTransform?.scale || currentZoom || 1;
    const dx = (e.clientX - startX) / scale;
    const dy = (e.clientY - startY) / scale;
    
    // Snap to grid (20px grid)
    const gridSize = 20;
    const newX = Math.round((nodeStartX + dx) / gridSize) * gridSize;
    const newY = Math.round((nodeStartY + dy) / gridSize) * gridSize;
    
    node.x = Math.max(0, newX);
    node.y = Math.max(0, newY);
    element.style.left = `${node.x}px`;
    element.style.top = `${node.y}px`;
    renderWorkflowNodes(); // Re-render connections
  });
  
  document.addEventListener('mouseup', () => {
    if (isDragging) {
      isDragging = false;
      element.style.zIndex = '';
    }
  });
}

function selectNode(id) {
  selectedNodeId = id;
  renderWorkflowNodes();
}

function openNodeEditor(id) {
  const node = workflowNodes.find(n => n.id === id);
  if (!node) return;
  
  selectedNodeId = id;
  renderWorkflowNodes();
  
  const editor = document.getElementById('node-editor');
  const body = document.getElementById('node-editor-body');
  
  // Build editor based on node type
  let html = '';
  
  // Header with node type title (no icons)
  const typeLabels = {
    trigger: 'TRIGGER',
    condition: 'CONDITION',
    sms: 'SMS BESKED',
    wait: 'WAIT / VENT',
    ai: 'AI CLASSIFICATION',
    action: 'ACTION',
    end: 'END'
  };
  
  // Type badge colors
  const typeColors = {
    trigger: 'var(--accent)',
    condition: 'var(--orange)',
    sms: 'var(--green)',
    wait: 'var(--purple)',
    ai: 'var(--pink)',
    action: 'var(--blue)',
    end: 'var(--muted)'
  };
  
  html += `
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border)">
      <div style="width:8px;height:40px;border-radius:4px;background:${typeColors[node.type] || 'var(--accent)'}"></div>
      <div>
        <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:600">${typeLabels[node.type] || node.type.toUpperCase()}</div>
        <div style="font-size:16px;font-weight:600;margin-top:2px">${node.label}</div>
      </div>
    </div>
  `;
  
  // === TRIGGER NODE ===
  if (node.type === 'trigger') {
    html += `
      <div class="node-editor-section">
        <div class="node-editor-section-title">Trigger Indstillinger</div>
        <div class="form-group">
          <label class="form-label">Trigger Type</label>
          <select class="input" onchange="updateNodeProperty('${id}', 'triggerType', this.value)">
            <option value="missed_call" ${node.triggerType === 'missed_call' ? 'selected' : ''}>Missed Call</option>
            <option value="sms" ${node.triggerType === 'sms' ? 'selected' : ''}>Incoming SMS</option>
            <option value="both" ${node.triggerType === 'both' ? 'selected' : ''}>Begge</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Label</label>
          <input class="input" value="${node.label}" onchange="updateNodeProperty('${id}', 'label', this.value)">
        </div>
        <div class="form-group">
          <label class="form-label">Sublabel</label>
          <input class="input" value="${node.sublabel || ''}" onchange="updateNodeProperty('${id}', 'sublabel', this.value)">
        </div>
      </div>
    `;
  }
  
  // === SMS NODE ===
  else if (node.type === 'sms') {
    html += `
      <div class="node-editor-section">
        <div class="node-editor-section-title">SMS Indstillinger</div>
        <div class="form-group">
          <label class="form-label">Node Label</label>
          <input class="input" value="${node.label}" onchange="updateNodeProperty('${id}', 'label', this.value)">
        </div>
        <div class="form-group">
          <label class="form-label">SMS Besked til kunden</label>
          <textarea class="input" rows="5" style="font-size:13px;line-height:1.5" onchange="updateNodeProperty('${id}', 'message', this.value)">${node.message || ''}</textarea>
          <div style="font-size:11px;color:var(--muted);margin-top:6px">
            Variabler: {restaurant}, {name}, {order}, {address}
          </div>
        </div>
      </div>
      <div class="node-editor-section">
        <div class="node-editor-section-title">SMS Skabeloner</div>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          <button class="btn btn-secondary" style="font-size:11px;padding:6px 10px" onclick="setSmsTemplate('${id}', 'missed_call')">Missed Call</button>
          <button class="btn btn-secondary" style="font-size:11px;padding:6px 10px" onclick="setSmsTemplate('${id}', 'delivery_type')">Levering/Afhentning</button>
          <button class="btn btn-secondary" style="font-size:11px;padding:6px 10px" onclick="setSmsTemplate('${id}', 'address')">Sp√∏rg Adresse</button>
          <button class="btn btn-secondary" style="font-size:11px;padding:6px 10px" onclick="setSmsTemplate('${id}', 'order')">Sp√∏rg Ordre</button>
          <button class="btn btn-secondary" style="font-size:11px;padding:6px 10px" onclick="setSmsTemplate('${id}', 'confirm')">Bekr√¶ftelse</button>
          <button class="btn btn-secondary" style="font-size:11px;padding:6px 10px" onclick="setSmsTemplate('${id}', 'error')">Fejl/Retry</button>
        </div>
      </div>
    `;
  }
  
  // === WAIT NODE ===
  else if (node.type === 'wait') {
    html += `
      <div class="node-editor-section">
        <div class="node-editor-section-title">Wait Indstillinger</div>
        <div class="form-group">
          <label class="form-label">Wait Type</label>
          <select class="input" onchange="updateNodeProperty('${id}', 'waitType', this.value)">
            <option value="contact_reply" ${node.waitType === 'contact_reply' || !node.waitType ? 'selected' : ''}>Contact Reply (Vent p√• kundesvar)</option>
            <option value="time_delay" ${node.waitType === 'time_delay' ? 'selected' : ''}>Time Delay (Fast ventetid)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Timeout (minutter)</label>
          <input class="input" type="number" value="${node.timeout || 25}" onchange="updateNodeProperty('${id}', 'timeout', parseInt(this.value))">
          <div style="font-size:11px;color:var(--muted);margin-top:6px">
            Anbefalet: 20-30 min for madbestillinger
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Label</label>
          <input class="input" value="${node.label}" onchange="updateNodeProperty('${id}', 'label', this.value)">
        </div>
      </div>
      <div class="node-editor-section">
        <div class="node-editor-section-title">Timeout Handling</div>
        <div style="background:var(--bg3);padding:12px;border-radius:8px;font-size:12px;color:var(--text2)">
          <div style="margin-bottom:8px"><strong>Contact Reply:</strong> Kunden svarer inden timeout</div>
          <div><strong>Time Out:</strong> Kunden svarer ikke - send reminder eller afslut</div>
        </div>
      </div>
    `;
  }
  
  // === AI NODE ===
  else if (node.type === 'ai') {
    html += `
      <div class="node-editor-section">
        <div class="node-editor-section-title">AI Classification Indstillinger</div>
        <div class="form-group">
          <label class="form-label">AI Funktion</label>
          <select class="input" onchange="updateNodeProperty('${id}', 'aiFunction', this.value)">
            <option value="intent" ${node.aiFunction === 'intent' || !node.aiFunction ? 'selected' : ''}>Intent Classifier (Ja/Nej/Greeting)</option>
            <option value="address" ${node.aiFunction === 'address' ? 'selected' : ''}>Address Extractor</option>
            <option value="order" ${node.aiFunction === 'order' ? 'selected' : ''}>Order Parser</option>
            <option value="name" ${node.aiFunction === 'name' ? 'selected' : ''}>Name Extractor</option>
            <option value="delivery" ${node.aiFunction === 'delivery' ? 'selected' : ''}>Delivery Type (Pickup/Levering)</option>
            <option value="custom" ${node.aiFunction === 'custom' ? 'selected' : ''}>Custom Prompt</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Label</label>
          <input class="input" value="${node.label}" onchange="updateNodeProperty('${id}', 'label', this.value)">
        </div>
      </div>
      <div class="node-editor-section">
        <div class="node-editor-section-title">System Prompt</div>
        <div class="form-group">
          <textarea class="input" rows="8" style="font-size:12px;font-family:monospace;line-height:1.4" onchange="updateNodeProperty('${id}', 'systemPrompt', this.value)">${node.systemPrompt || getDefaultAIPrompt(node.aiFunction || 'intent')}</textarea>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn btn-secondary" style="font-size:11px;padding:6px 10px" onclick="setAIPrompt('${id}', 'intent')">Intent Prompt</button>
          <button class="btn btn-secondary" style="font-size:11px;padding:6px 10px" onclick="setAIPrompt('${id}', 'address')">Address Prompt</button>
          <button class="btn btn-secondary" style="font-size:11px;padding:6px 10px" onclick="setAIPrompt('${id}', 'order')">Order Prompt</button>
          <button class="btn btn-secondary" style="font-size:11px;padding:6px 10px" onclick="setAIPrompt('${id}', 'name')">Name Prompt</button>
        </div>
      </div>
      <div class="node-editor-section">
        <div class="node-editor-section-title">AI Indstillinger</div>
        <div class="form-group">
          <label class="form-label">Temperature</label>
          <input class="input" type="number" step="0.1" min="0" max="1" value="${node.temperature || 0.1}" onchange="updateNodeProperty('${id}', 'temperature', parseFloat(this.value))">
          <div style="font-size:11px;color:var(--muted);margin-top:6px">
            Anbefalet: 0.0-0.1 for konsistente svar
          </div>
        </div>
      </div>
    `;
  }
  
  // === CONDITION NODE ===
  else if (node.type === 'condition') {
    html += `
      <div class="node-editor-section">
        <div class="node-editor-section-title">Condition Indstillinger</div>
        <div class="form-group">
          <label class="form-label">Label</label>
          <input class="input" value="${node.label}" onchange="updateNodeProperty('${id}', 'label', this.value)">
        </div>
        <div class="form-group">
          <label class="form-label">Sublabel</label>
          <input class="input" value="${node.sublabel || ''}" onchange="updateNodeProperty('${id}', 'sublabel', this.value)">
        </div>
      </div>
    `;
    
    if (node.branches && node.branches.length > 0) {
      html += `
        <div class="node-editor-section">
          <div class="node-editor-section-title">Branches (${node.branches.length})</div>
          ${node.branches.map((b, i) => `
            <div style="background:var(--bg3);padding:12px;border-radius:8px;margin-bottom:10px;border-left:3px solid ${b.class === 'yes' ? '#10b981' : b.class === 'no' ? '#ef4444' : b.class === 'order' ? '#3b82f6' : '#94a3b8'}">
              <div class="form-group" style="margin-bottom:8px">
                <label class="form-label">Branch Label</label>
                <input class="input" value="${b.label}" onchange="updateBranchProperty('${id}', '${b.id}', 'label', this.value)">
              </div>
              <div class="form-group" style="margin-bottom:8px">
                <label class="form-label">Condition</label>
                <input class="input" value="${b.condition || ''}" placeholder="f.eks. Intent Type = Positive/Yes" onchange="updateBranchProperty('${id}', '${b.id}', 'condition', this.value)">
              </div>
              <div class="form-group" style="margin-bottom:8px">
                <label class="form-label">Branch Type</label>
                <select class="input" onchange="updateBranchProperty('${id}', '${b.id}', 'class', this.value)">
                  <option value="yes" ${b.class === 'yes' ? 'selected' : ''}>Yes/Positive</option>
                  <option value="no" ${b.class === 'no' ? 'selected' : ''}>No/Negative</option>
                  <option value="order" ${b.class === 'order' ? 'selected' : ''}>Order</option>
                  <option value="greeting" ${b.class === 'greeting' ? 'selected' : ''}>Greeting</option>
                  <option value="timeout" ${b.class === 'timeout' ? 'selected' : ''}>Timeout</option>
                  <option value="none" ${b.class === 'none' || !b.class ? 'selected' : ''}>None/Default</option>
                </select>
              </div>
              <div class="form-group" style="margin-bottom:0">
                <label class="form-label">Next Node</label>
                <input class="input" value="${b.next || ''}" placeholder="Node ID" onchange="updateBranchProperty('${id}', '${b.id}', 'next', this.value)">
              </div>
            </div>
          `).join('')}
          <button class="btn btn-secondary" style="width:100%;margin-top:8px" onclick="addBranch('${id}')">+ Tilf√∏j Branch</button>
        </div>
      `;
    }
  }
  
  // === ACTION NODE ===
  else if (node.type === 'action') {
    html += `
      <div class="node-editor-section">
        <div class="node-editor-section-title">Action Indstillinger</div>
        <div class="form-group">
          <label class="form-label">Action Type</label>
          <select class="input" onchange="updateNodeProperty('${id}', 'actionType', this.value)">
            <option value="update_contact" ${node.actionType === 'update_contact' ? 'selected' : ''}>Update Contact</option>
            <option value="save_order" ${node.actionType === 'save_order' ? 'selected' : ''}>Save Order</option>
            <option value="create_task" ${node.actionType === 'create_task' ? 'selected' : ''}>Create Task</option>
            <option value="notification" ${node.actionType === 'notification' ? 'selected' : ''}>Send Notification</option>
            <option value="go_to" ${node.actionType === 'go_to' ? 'selected' : ''}>Go To (Jump)</option>
            <option value="increment" ${node.actionType === 'increment' ? 'selected' : ''}>Increment Counter</option>
            <option value="add_workflow" ${node.actionType === 'add_workflow' ? 'selected' : ''}>Add to Workflow</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Label</label>
          <input class="input" value="${node.label}" onchange="updateNodeProperty('${id}', 'label', this.value)">
        </div>
      </div>
    `;
    
    if (node.actionType === 'notification' || node.label.toLowerCase().includes('notification')) {
      html += `
        <div class="node-editor-section">
          <div class="node-editor-section-title">Notification Besked</div>
          <div class="form-group">
            <textarea class="input" rows="4" onchange="updateNodeProperty('${id}', 'notificationText', this.value)">${node.notificationText || 'üö® NY SMS-ORDRE MODTAGET!\\nüë§ Kunde: {name}\\nüìû Tlf: {phone}\\nüìç Type: {order_type}\\nüè† Adresse: {address}\\nüìù Ordre: {order}'}</textarea>
          </div>
        </div>
      `;
    }
  }
  
  // === END NODE ===
  else if (node.type === 'end') {
    html += `
      <div class="node-editor-section">
        <div class="node-editor-section-title">End Node</div>
        <div class="form-group">
          <label class="form-label">Label</label>
          <input class="input" value="${node.label}" onchange="updateNodeProperty('${id}', 'label', this.value)">
        </div>
        <div style="background:var(--bg3);padding:12px;border-radius:8px;font-size:12px;color:var(--text2)">
          End noden afslutter denne gren af workflowet. Kunden kan starte forfra ved n√¶ste henvendelse.
        </div>
      </div>
    `;
  }
  
  // Connection section for non-branch nodes
  if (node.next && !node.branches) {
    html += `
      <div class="node-editor-section">
        <div class="node-editor-section-title">Forbindelse</div>
        <div class="form-group">
          <label class="form-label">Next Node ID</label>
          <input class="input" value="${node.next}" onchange="updateNodeProperty('${id}', 'next', this.value)">
        </div>
      </div>
    `;
  }
  
  // Delete button (except for critical nodes)
  if (!['trigger-call', 'trigger-sms', 'end-final'].includes(id)) {
    html += `
      <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border)">
        <button class="btn btn-danger" style="width:100%;display:flex;align-items:center;justify-content:center;gap:6px" onclick="if(confirm('Slet denne node?')) deleteNode('${id}')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
          Slet Node
        </button>
      </div>
    `;
  }
  
  body.innerHTML = html;
  editor.classList.add('active');
}

// SMS Templates
function setSmsTemplate(id, template) {
  const templates = {
    missed_call: "Hej! Vi missede desv√¶rre dit opkald. Var det for at bestille mad? Svar 'JA' for at starte din bestilling direkte her over SMS. Hilsen {restaurant}",
    delivery_type: "Super! Skal maden leveres direkte til din d√∏r, eller vil du selv komme og hente den? (Svar 'Levering' eller 'Afhentning')",
    address: "Hvad er den fulde leveringsadresse inkl. postnummer?",
    order: "Perfekt! Send venligst hele din bestilling i √©n enkelt besked.",
    confirm: "Tak! Din ordre er nu sendt til k√∏kkenet. Afvent venligst, at restauranten accepterer din bestilling. Du modtager en bekr√¶ftelse snarest. üçï",
    error: "Beklager, jeg kunne ikke helt forst√• dit svar. Kan du pr√∏ve igen?"
  };
  updateNodeProperty(id, 'message', templates[template] || '');
  openNodeEditor(id); // Refresh editor
}

// AI Prompts
function getDefaultAIPrompt(type) {
  const prompts = {
    intent: `Du er en AI-assistent for en restaurant. Din opgave er at kategorisere kundens svar i √©n af f√∏lgende kategorier:

1. POSITIVE/YES: Hvis kunden bekr√¶fter, at de vil bestille mad (f.eks. 'ja tak', 'jeg vil gerne bestille', 'kan jeg f√• en pizza').
2. NEGATIVE/NO: Hvis kunden takker nej (f.eks. 'nej tak', 'forkert nummer').
3. GREETING: Hvis kunden kun siger hej uden at tage stilling til bestilling.
4. NONE: Hvis svaret er uklart eller irrelevant.

Output format: Return√©r kun √©t ord: Enten 'POSITIVE', 'NEGATIVE', 'GREETING' eller 'NONE'.`,
    
    address: `Du er en data-ekstraktor. Kunden har sendt en besked med deres leveringsadresse. Din opgave er at udtr√¶kke adressen pr√¶cist.

Regler:
‚Ä¢ Hvis du finder en gyldig adresse, return√©r den i formatet: [Vejnavn] [Nummer], [Postnummer] [By].
‚Ä¢ Hvis beskeden IKKE indeholder en adresse, eller den er mangelfuld, skal du svare med ordet: 'ERROR'.
‚Ä¢ Fjern un√∏dvendig tekst som 'min adresse er' eller 'lever venligst til'.

Output: Kun selve adressen eller 'ERROR'.`,
    
    order: `Analyser kundens besked og udtr√¶k bestillingen. 

Output format (JSON):
{
  "items": "Liste over retter/varer kunden har n√¶vnt",
  "valid": true/false
}

Hvis beskeden ikke indeholder en gyldig bestilling, s√¶t valid til false.`,
    
    name: `Udtr√¶k kundens navn fra beskeden.

Regler:
‚Ä¢ Return√©r kun navnet (fornavn og evt. efternavn)
‚Ä¢ Hvis intet navn findes, return√©r 'ERROR'
‚Ä¢ Fjern hilsner og andet tekst

Output: Kun navnet eller 'ERROR'.`,
    
    delivery: `Kategoris√©r kundens svar som enten levering eller afhentning.

Output: Return√©r kun √©t ord: 'PICKUP' eller 'DELIVERY' eller 'UNCLEAR'.`
  };
  return prompts[type] || prompts.intent;
}

function setAIPrompt(id, type) {
  updateNodeProperty(id, 'systemPrompt', getDefaultAIPrompt(type));
  updateNodeProperty(id, 'aiFunction', type);
  openNodeEditor(id);
}

// Add new branch to condition node
function addBranch(nodeId) {
  const node = workflowNodes.find(n => n.id === nodeId);
  if (node && node.branches) {
    const newBranch = {
      id: 'branch-' + Date.now(),
      label: 'New Branch',
      class: 'none',
      condition: '',
      next: ''
    };
    node.branches.push(newBranch);
    openNodeEditor(nodeId);
  }
}

// Delete node
function deleteNode(id) {
  const index = workflowNodes.findIndex(n => n.id === id);
  if (index > -1) {
    workflowNodes.splice(index, 1);
    closeNodeEditor();
    renderWorkflowNodes();
  }
}

// =====================================================
// NODE PALETTE FUNCTIONS
// =====================================================

function toggleNodePalette() {
  const palette = document.getElementById('node-palette');
  const canvas = document.getElementById('workflow-canvas');

  if (!palette || !canvas) return;

  palette.classList.toggle('collapsed');
  canvas.classList.toggle('palette-collapsed');

  const isCollapsed = palette.classList.contains('collapsed');
  addLog(`${isCollapsed ? 'üì¶' : 'üìã'} Node palette ${isCollapsed ? 'skjult' : 'vist'}`, 'info');
}

function addNodeFromPalette(type) {
  // Find max Y position to place new node below existing ones
  const maxY = workflowNodes.length > 0 ? Math.max(...workflowNodes.map(n => n.y)) : 0;

  // Generate unique ID
  const newId = `${type}-${Date.now()}`;

  // Create node with default values
  const newNode = createDefaultNode(type, newId, 430, maxY + 200);

  // Add to workflow
  workflowNodes.push(newNode);
  renderWorkflowNodes();

  // Auto-open editor for new node
  selectNode(newId);
  openNodeEditor(newId);

  addLog(`‚úÖ Ny ${type} node tilf√∏jet: ${newId}`, 'success');
}

function createDefaultNode(type, id, x, y) {
  const defaults = {
    trigger: {
      id,
      type,
      label: 'Ny Trigger',
      x,
      y,
      icon: 'üìû',
      next: '',
      triggerType: 'sms',
      description: 'SMS trigger'
    },
    sms: {
      id,
      type,
      label: 'Ny SMS',
      x,
      y,
      icon: 'üí¨',
      next: '',
      message: 'Skriv din SMS besked her...',
      useTemplate: false
    },
    wait: {
      id,
      type,
      label: 'Vent p√• svar',
      x,
      y,
      icon: '‚è≥',
      timeout: 25,
      waitType: 'contact_reply',
      branches: [
        { id: `${id}-reply`, label: 'Contact Reply', next: '' },
        { id: `${id}-timeout`, label: 'Time Out', class: 'timeout', next: '' }
      ]
    },
    condition: {
      id,
      type,
      label: 'Ny Betingelse',
      x,
      y,
      icon: '‚ùì',
      conditionType: 'simple',
      branches: [
        { id: `${id}-yes`, label: 'Yes', class: 'yes', next: '' },
        { id: `${id}-no`, label: 'No', class: 'no', next: '' }
      ]
    },
    ai: {
      id,
      type,
      label: 'AI Klassificering',
      x,
      y,
      icon: 'ü§ñ',
      next: '',
      aiFunction: 'intent',
      context: '',
      expectedCategories: []
    },
    action: {
      id,
      type,
      label: 'Ny Action',
      x,
      y,
      icon: '‚ö°',
      next: '',
      actionType: 'notification',
      actionData: {}
    },
    end: {
      id,
      type,
      label: 'END',
      x,
      y,
      icon: 'üèÅ',
      endType: 'success'
    }
  };

  return defaults[type] || {
    id,
    type,
    label: 'Ny Node',
    x,
    y,
    icon: 'üì¶',
    next: ''
  };
}

// Drag and drop functionality
let draggedNodeType = null;

function dragStartPalette(event, nodeType) {
  draggedNodeType = nodeType;
  event.dataTransfer.effectAllowed = 'copy';
  event.dataTransfer.setData('text/plain', nodeType);
}

function initCanvasDrop() {
  const canvas = document.getElementById('workflow-canvas');

  if (!canvas) {
    console.warn('Workflow canvas not found - drag-drop initialization skipped');
    return;
  }

  canvas.addEventListener('dragover', (e) => {
    if (draggedNodeType) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
    }
  });

  canvas.addEventListener('drop', (e) => {
    if (!draggedNodeType) return;
    e.preventDefault();

    // Beregn drop position relativt til canvas transform
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX - rect.left - (canvasTransform?.x || 0)) / (canvasTransform?.scale || 1);
    const y = (e.clientY - rect.top - (canvasTransform?.y || 0)) / (canvasTransform?.scale || 1);

    // Opret node p√• drop position
    const newId = `${draggedNodeType}-${Date.now()}`;
    const newNode = createDefaultNode(draggedNodeType, newId, x, y);

    workflowNodes.push(newNode);
    renderWorkflowNodes();

    // Auto-select og √•bn editor
    selectNode(newId);
    openNodeEditor(newId);

    addLog(`‚úÖ ${draggedNodeType} node droppet p√• (${Math.round(x)}, ${Math.round(y)})`, 'success');

    draggedNodeType = null;
  });

  addLog('üé® Canvas drag-drop initialiseret', 'info');
}

// Slet node med bekr√¶ftelse
function confirmDeleteNode(id) {
  const node = workflowNodes.find(n => n.id === id);

  if (!node) {
    addLog(`‚ö†Ô∏è Node ikke fundet: ${id}`, 'warn');
    return;
  }

  const confirmMessage = `Er du sikker p√• at du vil slette denne node?\n\nNode ID: ${id}\nType: ${node.type}\nLabel: ${node.label}\n\nDenne handling kan ikke fortrydes.`;

  if (confirm(confirmMessage)) {
    deleteNode(id);
    addLog(`üóëÔ∏è Node slettet: ${id}`, 'warn');
  } else {
    addLog(`‚ùå Sletning annulleret for: ${id}`, 'info');
  }
}

function closeNodeEditor() {
  document.getElementById('node-editor').classList.remove('active');
  selectedNodeId = null;
  renderWorkflowNodes();
}

function updateNodeProperty(id, prop, value) {
  const node = workflowNodes.find(n => n.id === id);
  if (node) {
    node[prop] = value;

    // VIGTIGT: Gem med det samme til localStorage
    saveWorkflow();

    renderWorkflowNodes();
    addLog(`üíæ Node ${id} opdateret: ${prop} = ${typeof value === 'string' && value.length > 50 ? value.substring(0, 50) + '...' : value}`, 'info');
  }
}

function updateBranchProperty(nodeId, branchId, prop, value) {
  const node = workflowNodes.find(n => n.id === nodeId);
  if (node && node.branches) {
    const branch = node.branches.find(b => b.id === branchId);
    if (branch) {
      branch[prop] = value;

      // VIGTIGT: Gem med det samme til localStorage
      saveWorkflow();

      renderWorkflowNodes();
      addLog(`üíæ Branch ${branchId} opdateret: ${prop} = ${value}`, 'info');
    }
  }
}

function editBranch(nodeId, branchId) {
  openNodeEditor(nodeId);
}

// ============================================
// ZOOM FUNKTIONALITET
// ============================================
let currentZoom = 1;
const minZoom = 0.25;
const maxZoom = 2;
const zoomStep = 0.1;

function zoomIn() {
  if (currentZoom < maxZoom) {
    currentZoom = Math.min(currentZoom + zoomStep, maxZoom);
    applyZoom();
  }
}

function zoomOut() {
  if (currentZoom > minZoom) {
    currentZoom = Math.max(currentZoom - zoomStep, minZoom);
    applyZoom();
  }
}

function resetZoom() {
  currentZoom = 1;
  canvasTransform = { x: 0, y: 0, scale: 1 };
  applyZoom();
  centerWorkflow();
}

function applyZoom() {
  // Update canvas transform
  canvasTransform.scale = currentZoom;
  
  const canvas = document.getElementById('workflow-canvas');
  const viewport = canvas?.querySelector('.canvas-viewport');
  
  if (viewport) {
    viewport.style.transform = `translate(${canvasTransform.x}px, ${canvasTransform.y}px) scale(${canvasTransform.scale})`;
  } else {
    // Fallback for old structure
    const nodesContainer = document.getElementById('workflow-nodes');
    const connectionsContainer = document.getElementById('wf-connections');
    const grid = document.querySelector('.canvas-grid');
    
    if (nodesContainer) {
      nodesContainer.style.transform = `scale(${currentZoom})`;
      nodesContainer.style.transformOrigin = '0 0';
    }
    
    if (connectionsContainer) {
      connectionsContainer.style.transform = `scale(${currentZoom})`;
      connectionsContainer.style.transformOrigin = '0 0';
    }
    
    if (grid) {
      grid.style.transform = `scale(${currentZoom})`;
      grid.style.transformOrigin = '0 0';

      // Dynamically adjust dot size and opacity for visibility at all zoom levels
      const baseDotSize = 1;
      const baseOpacity = 0.3;

      // Compensate dot size inversely to zoom level
      // This ensures dots appear ~1px on screen regardless of zoom
      const compensatedDotSize = Math.max(1, Math.round(baseDotSize / currentZoom));

      // Boost opacity at low zoom levels for better visibility
      let compensatedOpacity = baseOpacity;
      if (currentZoom < 0.5) {
        // At 0.25x zoom: opacity becomes ~0.4
        // At 0.4x zoom: opacity becomes ~0.34
        compensatedOpacity = Math.min(0.5, baseOpacity + (0.5 - currentZoom) * 0.4);
      }

      // Apply dynamic background with compensated values
      grid.style.backgroundImage = `radial-gradient(circle, rgba(100, 116, 139, ${compensatedOpacity}) ${compensatedDotSize}px, transparent ${compensatedDotSize}px)`;
    }
  }
  
  // Re-render connections for at sikre de er synkroniseret med nodes
  // Dette sikrer at lines f√∏lger noderne pr√¶cist
  setTimeout(() => {
    renderWorkflowNodes();
  }, 10);
  
  // Update zoom display
  const zoomDisplay = document.getElementById('zoom-level');
  if (zoomDisplay) {
    zoomDisplay.textContent = Math.round(currentZoom * 100) + '%';
  }
}

// Mouse wheel zoom
document.addEventListener('DOMContentLoaded', () => {
  const canvas = document.getElementById('workflow-canvas');
  if (canvas) {
    canvas.addEventListener('wheel', (e) => {
      if (e.ctrlKey || e.metaKey) {
        e.preventDefault();
        if (e.deltaY < 0) {
          zoomIn();
        } else {
          zoomOut();
        }
      }
    }, { passive: false });
  }

  // Initialize node palette drag-drop functionality
  initCanvasDrop();
});

function saveWorkflow() {
  localStorage.setItem('workflow_nodes', JSON.stringify(workflowNodes));
  // Visual feedback - brief button flash
  const btn = document.querySelector('[onclick="saveWorkflow()"]');
  if (btn) {
    btn.style.background = 'var(--green)';
    setTimeout(() => btn.style.background = '', 300);
  }
}

function resetWorkflow() {
  if (confirm('Er du sikker p√• du vil nulstille workflowet?')) {
    localStorage.removeItem('workflow_nodes');
    location.reload();
  }
}

// Load saved workflow
const savedWorkflow = localStorage.getItem('workflow_nodes');
if (savedWorkflow) {
  try {
    workflowNodes = JSON.parse(savedWorkflow);
  } catch (e) {}
}

// =====================================================
// LOCALSTORAGE PERSISTENCE SYSTEM
// =====================================================
const STORAGE_KEYS = {
  RESTAURANTS: 'orderflow_restaurants',
  SETTINGS: 'orderflow_settings',
  VERSION: 'orderflow_version'
};

// Save all restaurants to localStorage
function persistRestaurants() {
  try {
    // Only save user-modified properties, not demo data
    const toSave = restaurants.map(r => ({
      id: r.id,
      name: r.name,
      cvr: r.cvr,
      email: r.email,
      phone: r.phone,
      owner: r.owner,
      contactPerson: r.contactPerson,
      address: r.address,
      website: r.website,
      createdAt: r.createdAt,
      // Status
      status: r.status,
      // Workflow settings
      reviewEnabled: r.reviewEnabled,
      reorderEnabled: r.reorderEnabled,
      receiptEnabled: r.receiptEnabled,
      googleReviewUrl: r.googleReviewUrl,
      trustpilotUrl: r.trustpilotUrl,
      deliveryEnabled: r.deliveryEnabled,
      deliveryFrom: r.deliveryFrom,
      deliveryTo: r.deliveryTo,
      deliveryTimeRestricted: r.deliveryTimeRestricted,
      timeFormat: r.timeFormat,
      openingHours: r.openingHours,
      // Messages
      messages: r.messages,
      // Timestamps
      stamdataUpdatedAt: r.stamdataUpdatedAt,
      workflowSettingsUpdatedAt: r.workflowSettingsUpdatedAt,
      messagesUpdatedAt: r.messagesUpdatedAt
    }));
    
    localStorage.setItem(STORAGE_KEYS.RESTAURANTS, JSON.stringify(toSave));
    console.log('Restaurants persisted to localStorage:', toSave.length);
    return true;
  } catch (e) {
    console.error('Failed to persist restaurants:', e);
    return false;
  }
}

// Load restaurants from localStorage and merge with demo data
function loadPersistedRestaurants() {
  try {
    const saved = localStorage.getItem(STORAGE_KEYS.RESTAURANTS);
    if (!saved) return false;

    const savedData = JSON.parse(saved);
    console.log('Loading persisted restaurants:', savedData.length);

    // Merge saved data with existing restaurants OR add new ones
    savedData.forEach(savedRestaurant => {
      const existing = restaurants.find(r => r.id === savedRestaurant.id);
      if (existing) {
        // Merge user-modified properties
        Object.keys(savedRestaurant).forEach(key => {
          if (savedRestaurant[key] !== undefined && savedRestaurant[key] !== null) {
            existing[key] = savedRestaurant[key];
          }
        });
      } else {
        // Add new restaurant that doesn't exist yet (e.g., locally created)
        restaurants.push(savedRestaurant);
        console.log('‚úÖ Added locally saved restaurant:', savedRestaurant.name);
      }
    });

    return true;
  } catch (e) {
    console.error('Failed to load persisted restaurants:', e);
    return false;
  }
}

// Clear all persisted data
function clearPersistedData() {
  if (confirm('Er du sikker p√• du vil slette alle gemte data? Dette kan ikke fortrydes.')) {
    localStorage.removeItem(STORAGE_KEYS.RESTAURANTS);
    localStorage.removeItem(STORAGE_KEYS.SETTINGS);
    toast('Alle gemte data slettet', 'success');
    location.reload();
  }
}

// Initialize persistence on app load
function initPersistence() {
  // Load saved restaurants
  loadPersistedRestaurants();
  
  console.log('Persistence system initialized');
}

// Call persistence init after restaurants are loaded
setTimeout(initPersistence, 100);

// =====================================================
// TEST WORKFLOW
// =====================================================
// Initialize test panel event listeners safely
function initTestPanel() {
  const testRestaurant = document.getElementById('test-restaurant');
  const testPhone = document.getElementById('test-phone');
  
  if (testRestaurant) {
    testRestaurant.addEventListener('change', updateTestButtons);
  }
  if (testPhone) {
    testPhone.addEventListener('input', function() {
      const convPhone = document.getElementById('conv-phone');
      if (convPhone) convPhone.textContent = this.value;
    });
  }
}

// Call init when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initTestPanel);
} else {
  initTestPanel();
}

function updateTestButtons() {
  const hasRestaurant = !!document.getElementById('test-restaurant').value;
  document.getElementById('btn-call').disabled = !hasRestaurant;
  document.getElementById('btn-sms').disabled = !hasRestaurant;
}

function toggleLive() {
  console.log('toggleLive called!');
  const toggle = document.getElementById('live-toggle');
  const checkbox = toggle?.querySelector('input[type="checkbox"]');
  const badge = document.getElementById('live-badge');
  const container = document.getElementById('live-toggle-container');
  const warning = document.getElementById('live-mode-warning');
  
  // Determine new state from checkbox or toggle current state
  const newState = checkbox ? checkbox.checked : !liveMode;
  
  if (newState) {
    // Enable live mode - GR√òN for aktiv
    liveMode = true;
    if (checkbox) checkbox.checked = true;
    if (badge) badge.classList.add('active');
    if (container) {
      container.classList.add('active');
      container.style.background = 'rgba(45,212,191,0.1)';
      container.style.border = '1px solid rgba(45,212,191,0.3)';
    }
    if (warning) {
      warning.textContent = 'LIVE aktiv - SMS sendes til telefon';
      warning.style.color = 'var(--accent)';
      warning.style.fontWeight = '500';
    }
    addLog('LIVE MODE aktiveret - SMS sendes nu', 'success');
    toast('LIVE MODE aktiveret', 'success');
    console.log('LIVE MODE ON');
  } else {
    // Disable live mode - tilbage til neutral
    liveMode = false;
    if (checkbox) checkbox.checked = false;
    if (badge) badge.classList.remove('active');
    if (container) {
      container.classList.remove('active');
      container.style.background = 'var(--bg)';
      container.style.border = '1px solid var(--border)';
    }
    if (warning) {
      warning.textContent = 'Demo mode - SMS vises kun i UI';
      warning.style.color = 'var(--muted)';
      warning.style.fontWeight = 'normal';
    }
    addLog('Demo mode aktiveret', 'info');
    toast('Demo mode', 'info');
    console.log('LIVE MODE OFF');
  }
}

// Make it global
window.toggleLive = toggleLive;

async function startTest(type) {
  const restaurantId = document.getElementById('test-restaurant').value;
  const restaurant = restaurants.find(r => r.id === restaurantId);
  if (!restaurant) return;

  // Check if customer can receive workflow actions
  if (!canReceiveWorkflowActions(restaurant)) {
    toast(`Workflows er deaktiveret for ${restaurant.status === 'terminated' ? 'opsagte' : 'inaktive'} kunder`, 'warning');
    addLog(`‚ö†Ô∏è Kunde "${restaurant.name}" kan ikke modtage workflows (status: ${restaurant.status})`, 'warning');
    return;
  }

  // LIVE MODE PRE-FLIGHT CHECKS
  if (liveMode) {
    const apiKey = localStorage.getItem('inmobile_api_key');
    const sender = localStorage.getItem('inmobile_sender');
    if (!apiKey || !sender) {
      toast('Fejl: InMobile credentials ikke konfigureret', 'error');
      addLog('‚ùå InMobile API key eller sender mangler - g√• til Indstillinger ‚Üí SMS', 'error');
      return;
    }

    const phone = document.getElementById('test-phone').value;
    if (!phone || phone.replace(/\D/g, '').length < 8) {
      toast('Ugyldigt telefonnummer', 'error');
      addLog('‚ùå Telefonnummer skal v√¶re mindst 8 cifre', 'error');
      return;
    }
  }

  console.log('startTest called:', type, 'Restaurant:', restaurant.name);
  
  // Auto-switch to messages tab to show SMS conversation
  switchTestTab('messages');
  
  // Hide empty state in messages tab
  const emptyState = document.getElementById('messages-empty-state');
  if (emptyState) emptyState.style.display = 'none';
  
  // Hide test empty state
  const testEmptyState = document.getElementById('test-empty-state');
  if (testEmptyState) testEmptyState.style.display = 'none';
  
  // Info about current mode
  if (!liveMode) {
    addLog('Demo mode - SMS vises i UI, sendes ikke', 'info');
  } else {
    addLog('‚úì LIVE MODE - Rigtige SMS sendes', 'success');
  }
  
  testRunning = true;
  document.getElementById('btn-stop').style.display = 'block';
  
  const messagesContainer = document.getElementById('messages');
  console.log('Messages container before clear:', messagesContainer);
  messagesContainer.innerHTML = '';

  // Clear intent display when starting new test
  if (typeof window.hideIntentDisplay === 'function') {
    window.hideIntentDisplay();
  }

  // Clear detailed log at start
  const detailedLog = document.getElementById('detailed-log');
  if (detailedLog) {
    detailedLog.innerHTML = '';
  }
  
  addLog(`Test startet: ${type === 'call' ? 'Missed Call' : 'SMS'}`, 'success');
  addLog(`Nummer: ${document.getElementById('test-phone').value}`, 'info');

  // Simulate workflow med error handling
  try {
    await runWorkflow(restaurant, type);
  } catch (err) {
    console.error('Workflow error:', err);
    addLog(`‚ùå Workflow fejl: ${err.message}`, 'error');
  } finally {
    // Cleanup uanset hvad
    testRunning = false;
    document.getElementById('btn-stop').style.display = 'none';
    document.getElementById('waiting').style.display = 'none';
    if (replyResolver) {
      replyResolver(null);
      replyResolver = null;
    }
  }
}

function stopTest() {
  testRunning = false;
  document.getElementById('btn-stop').style.display = 'none';
  document.getElementById('waiting').style.display = 'none';

  // Clear any pending reply resolver
  if (replyResolver) {
    replyResolver(null);
    replyResolver = null;
  }

  addLog('‚èπÔ∏è Test stoppet manuelt', 'warn');
  toast('Test stoppet', 'info');
}

async function runWorkflow(restaurant, type) {
  const phone = document.getElementById('test-phone').value;
  let customerName = '';
  let order = '';
  let orderType = '';
  let address = '';
  let parsedOrder = null; // NY: Parsed order med priser
  let currentMenu = null; // NY: Menu data
  let openingHoursContext = ''; // NY: √Öbningstider til AI

  // =====================================================
  // ADVANCED AI: Initialis√©r conversation state
  // =====================================================
  const conversationId = getCurrentConversationId();

  if (window.AdvancedAI) {
    const conversation = AdvancedAI.ConversationStateManager.getConversation(conversationId);
    addLog(`üí¨ Advanced AI conversation initialiseret: ${conversationId}`, 'ai');

    // Nulstil conversation ved ny workflow
    conversation.currentPhase = 'FASE_0_HILSEN';
    conversation.customerData.orderItems = [];
    conversation.customerData.modifications = [];
    conversation.customerData.extras = [];
    conversation.validationAttempts = {};
  }
  
  // TRIN 1: Fetch menu ved workflow start
  addLog('üìã Henter menu data...', 'info');
  currentMenu = await fetchMenuForRestaurant(restaurant);
  
  // Gem √•bningstider som context til AI
  openingHoursContext = formatOpeningHoursText(restaurant);
  
  // Log aktuelle √•bningstider fra restaurant indstillinger
  const dayNamesShort = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
  const dayNamesFull = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
  const dayIndex = new Date().getDay();
  const todayShort = dayNamesShort[dayIndex];
  const todayFull = dayNamesFull[dayIndex];
  const todayHours = restaurant.openingHours?.[todayShort] || restaurant.openingHours?.[todayFull];
  if (todayHours?.enabled) {
    // Check for 24h
    if (todayHours.open === '00:00' && todayHours.close === '00:00') {
      addLog(`üïê Dagens √•bningstider (${getDayNameDanish(todayFull)}): D√∏gn√•bent`, 'info');
    } else {
      addLog(`üïê Dagens √•bningstider (${getDayNameDanish(todayFull)}): ${todayHours.open} - ${todayHours.close}`, 'info');
    }
  } else {
    addLog(`üïê ${getDayNameDanish(todayFull)}: Lukket i dag`, 'warn');
  }
  
  // Node 1: Trigger
  activateNode(type === 'call' ? 'trigger-call' : 'trigger-sms');
  addLog('‚ö° Trigger: ' + (type === 'call' ? 'Missed Call' : 'SMS modtaget'), 'info');
  await sleep(500);
  
  // Node 2: DYNAMISK Check if open (bruger restaurant.openingHours)
  activateNode('open-check');
  addLog('‚ùì Tjekker √•bningstider fra restaurant indstillinger...', 'info');
  await sleep(500);
  
  // Brug dynamisk Open Checker - l√¶ser DIREKTE fra restaurant.openingHours
  const openStatus = checkRestaurantOpen(restaurant);
  
  if (openStatus.isOpen) {
    addLog(`‚úÖ ${restaurant.name} er √•ben (lukker kl. ${openStatus.closeTime})`, 'success');
  } else {
    addLog(`üî¥ ${restaurant.name} er lukket (${openStatus.reason})`, 'warn');
    if (openStatus.nextOpen) {
      addLog(`üìÖ N√¶ste √•bning: ${openStatus.nextOpen.day} kl. ${openStatus.nextOpen.time}`, 'info');
    }
  }
  
  if (!openStatus.isOpen) {
    activateNode('send-closed');
    // Generer dynamisk lukket-besked med n√¶ste √•bningstid
    const closedMessage = generateClosedMessage(restaurant, openStatus);
    await sendSMS(phone, closedMessage, restaurant);
    activateNode('end-closed');
    return;
  }
  
  // Node: Open
  activateNode('open-node');
  await sleep(300);
  
  // Missed Call path
  activateNode('send-missed');
  await sendSMS(phone, `Hej! Vi missede desv√¶rre dit opkald. Var det for at bestille mad? Svar JA for at starte din bestilling direkte her over SMS. Hilsen ${restaurant.name}`, restaurant);
  
  // Wait for reply
  activateNode('wait-missed');
  const reply1 = await waitForReply();
  if (!reply1 || !testRunning) return;
  
  // Intent check - inkluder √•bningstider i AI context
  activateNode('intent-check-missed');
  const classification1 = await classifyWithAI(reply1, `Kategoriser svaret: POSITIVE/YES, NEGATIVE/NO, GREETING, eller NONE. Restaurantens √•bningstider:\n${openingHoursContext}`);
  
  const replyLower = reply1.toLowerCase();
  const normalizedCategory = (classification1.category || '').toUpperCase();
  const isNo = normalizedCategory === 'NO' || normalizedCategory === 'NEGATIVE' ||
    replyLower.includes('nej') ||
    replyLower.includes('no') ||
    replyLower.includes('ikke') ||
    replyLower.includes('nej tak');
  const isYes = !isNo;
  
  addLog(`üéØ AI Intent: ${classification1.category} -> ${isYes ? 'JA' : 'NEJ'}`, 'ai');
  
  if (isNo) {
    activateNode('end-no-intent');
    await sendSMS(phone, 'Ingen problem! Ring gerne igen üìû', restaurant);
    return;
  }
  
  // Go to previous order check
  activateNode('go-to-prev-order-1');
  await sleep(200);
  
  // Previous order check
  activateNode('condition-prev-order');
  await sleep(300);
  
  // DYNAMISK LEVERINGSKONTROL - Tjek om restaurant tilbyder levering
  const deliveryEnabled = restaurant.deliveryEnabled !== false; // Default true
  let isPickup = false;
  
  if (!deliveryEnabled) {
    // Levering deaktiveret - spring direkte til afhentning
    activateNode('delivery-check');
    addLog('üöó Levering deaktiveret for denne restaurant', 'warn');
    await sleep(200);
    
    activateNode('ask-delivery-type');
    await sendSMS(phone, 'Vi tilbyder desv√¶rre ikke levering i √∏jeblikket. Du kan bestille til afhentning. Er det okay?', restaurant);
    
    activateNode('wait-delivery-type');
    const pickupConfirm = await waitForReply();
    if (!pickupConfirm || !testRunning) return;
    
    // Tjek om kunden accepterer afhentning
    const pickupClass = await classifyWithAI(pickupConfirm, 'Accepterer kunden afhentning? YES/NO');
    const acceptsPickup = pickupClass.category === 'YES' || 
                          pickupConfirm.toLowerCase().includes('ja') ||
                          pickupConfirm.toLowerCase().includes('okay') ||
                          pickupConfirm.toLowerCase().includes('fint');
    
    if (!acceptsPickup) {
      await sendSMS(phone, 'Det forst√•r vi godt. Du er altid velkommen tilbage n√•r det passer dig bedre üëã', restaurant);
      activateNode('end-no-delivery');
      return;
    }
    
    isPickup = true;
    orderType = 'Pickup';
  } else {
    // Levering aktiveret - sp√∏rg kunden
    activateNode('ask-delivery-type');
    await sendSMS(phone, 'Super! Skal maden leveres direkte til din d√∏r, eller vil du selv komme og hente den? (Svar Levering eller Afhentning)', restaurant);
    
    // Wait for delivery type
    activateNode('wait-delivery-type');
    const replyDelivery = await waitForReply();
    if (!replyDelivery || !testRunning) return;
    
    // AI classify delivery
    activateNode('ai-delivery-type');
    const deliveryClass = await classifyWithAI(replyDelivery, 'Kategoriser: PICKUP eller DELIVERY eller UNCLEAR');
    isPickup = replyDelivery.toLowerCase().includes('afhent') || 
               replyDelivery.toLowerCase().includes('hente') ||
               deliveryClass.category === 'PICKUP';
    orderType = isPickup ? 'Pickup' : 'Delivery';
  }
  
  addLog(`üéØ Type: ${orderType}`, 'ai');
  
  activateNode('delivery-condition');
  await sleep(300);
  
  const menuUrl = restaurant.menuUrl || restaurant.website || 'vores hjemmeside';
  
  if (isPickup) {
    activateNode('order-type-pickup');
    await sleep(200);
    
    // Ask for order (pickup)
    activateNode('ask-order-pickup');
    await sendSMS(phone, `Lyder godt! Send venligst hele din bestilling i √©n enkelt besked. Du kan se vores menu her: ${menuUrl}`, restaurant);
    
    activateNode('wait-order-pickup');
  } else {
    activateNode('order-type-delivery');
    await sleep(200);
    
    // =====================================================
    // ADRESSE INDSAMLING MED VALIDERING
    // =====================================================
    // ADRESSE VALIDERING - Med AdvancedAI integration
    // =====================================================
    let addressConfirmed = false;
    let addressRetryCount = 0;
    const maxAddressRetries = 3;

    while (!addressConfirmed && addressRetryCount < maxAddressRetries && testRunning) {
      activateNode('ask-address');

      // Opdater conversation phase
      if (window.AdvancedAI) {
        const conv = AdvancedAI.ConversationStateManager.getConversation(conversationId);
        conv.currentPhase = 'FASE_3_ADRESSE';
        conv.validationAttempts.address = addressRetryCount;
      }

      // Brug AdvancedAI til at generere kontekst-aware prompt
      let addressPrompt;
      if (window.AdvancedAI && addressRetryCount > 0) {
        const conv = AdvancedAI.ConversationStateManager.getConversation(conversationId);
        addressPrompt = AdvancedAI.generateAddressPrompt(conv, addressRetryCount);
      } else {
        // Legacy prompts
        if (addressRetryCount === 0) {
          addressPrompt = 'Hvad er den fulde leveringsadresse inkl. postnummer?';
        } else if (addressRetryCount === 1) {
          addressPrompt = 'Jeg mangler adressen. Skriv venligst vejnavn, husnummer og postnummer (f.eks. "Vestergade 10, 2100 K√∏benhavn")';
        } else {
          addressPrompt = 'Skriv din adresse s√• vi kan levere maden:';
        }
      }

      await sendSMS(phone, addressPrompt, restaurant);

      activateNode('wait-address');
      const addressReply = await waitForReply();
      if (!addressReply || !testRunning) return;

      // Tilf√∏j til conversation history
      if (window.AdvancedAI) {
        AdvancedAI.ConversationStateManager.addMessage(conversationId, 'user', addressReply);
      }

      // Brug AdvancedAI validering hvis tilg√¶ngelig
      let validation;
      if (window.AdvancedAI) {
        validation = AdvancedAI.validation.validateAddress(addressReply);
        addLog(`üîç AdvancedAI adresse validering: ${validation.valid ? '‚úì' : '‚úó'} complete=${validation.complete}`, 'ai');
      } else {
        // Legacy validation
        activateNode('ai-address-extractor');
        const addressClass = await classifyWithAI(addressReply,
          `Udtr√¶k leveringsadressen fra beskeden.
          Kategoriser:
          - ADDRESS: Gyldig adresse fundet (udtr√¶k i "extracted")
          - INCOMPLETE: Mangler postnummer eller husnummer
          - ERROR: Ikke en adresse

          En gyldig adresse har: vejnavn, husnummer, og helst postnummer.`
        );

        const extractedAddress = addressClass.extracted || addressReply.trim();
        const hasNumber = /\d+/.test(extractedAddress);
        const hasLetters = /[a-z√¶√∏√•]{3,}/i.test(extractedAddress);
        const hasPostalCode = /\b\d{4}\b/.test(extractedAddress);

        validation = {
          valid: addressClass.category === 'ADDRESS' || (hasNumber && hasLetters),
          complete: hasPostalCode,
          address: extractedAddress,
          missing: !hasPostalCode ? ['postnummer'] : []
        };
      }

      activateNode('address-condition');
      await sleep(200);

      // H√•ndter validerings resultat
      if (validation.valid && validation.complete) {
        // Perfekt adresse
        address = validation.address;
        addressConfirmed = true;

        if (window.AdvancedAI) {
          AdvancedAI.ConversationStateManager.updateCustomerData(conversationId, 'address', validation.parsed || { full: address });
        }

        addLog(`üìç Adresse gemt: ${address}`, 'success');
      } else if (validation.valid && !validation.complete) {
        // Delvis adresse - sp√∏rg efter manglende dele
        addressRetryCount++;

        if (validation.prompt && window.AdvancedAI) {
          await sendSMS(phone, validation.prompt, restaurant);
          addLog(`‚ö†Ô∏è Delvis adresse - mangler: ${validation.missing.join(', ')}`, 'warn');
        } else {
          addLog(`‚ö†Ô∏è Postnummer mangler (fors√∏g ${addressRetryCount}/${maxAddressRetries})`, 'warn');
        }
      } else {
        // Ugyldig adresse
        addressRetryCount++;
        addLog(`‚ö†Ô∏è Ugyldig adresse: "${validation.address || addressReply}" (fors√∏g ${addressRetryCount}/${maxAddressRetries})`, 'warn');

        if (addressRetryCount >= maxAddressRetries) {
          // Brug hvad vi har efter max fors√∏g
          address = validation.address || addressReply.trim() || 'Ukendt adresse';
          addressConfirmed = true;
          addLog(`üìç Adresse accepteret efter ${maxAddressRetries} fors√∏g: ${address}`, 'info');
        }
      }
    }
    
    activateNode('update-delivery-address');
    await sleep(200);
    
    // Ask for order (delivery)
    activateNode('ask-order-delivery');
    await sendSMS(phone, `Lyder godt! Send venligst hele din bestilling i √©n enkelt besked. Du kan se vores menu her: ${menuUrl}`, restaurant);
    
    activateNode('wait-order-delivery');
  }
  
  // Wait for order
  const orderReply = await waitForReply();
  if (!orderReply || !testRunning) return;
  
  // TRIN 2: AI parse order MED menu-matching og priskalkulation
  activateNode('ai-order-parser');
  parsedOrder = await parseOrderWithMenu(orderReply, currentMenu, restaurant.name);
  
  // =====================================================
  // ORDRE VALIDERING - Kr√¶v mindst 1 produkt
  // =====================================================
  let orderValidationAttempts = 0;
  const maxOrderAttempts = 3;
  
  while ((!parsedOrder.valid || !parsedOrder.items || parsedOrder.items.length === 0 || parsedOrder.total <= 0) && 
         orderValidationAttempts < maxOrderAttempts && testRunning) {
    orderValidationAttempts++;
    addLog(`‚ö†Ô∏è Ordre ikke valid - ingen produkter fundet (fors√∏g ${orderValidationAttempts}/${maxOrderAttempts})`, 'warn');
    
    // Bed kunden om at v√¶re mere specifik
    let helpMessage;
    if (orderValidationAttempts === 1) {
      helpMessage = `Jeg kunne ikke finde produkterne i vores menu. Pr√∏v at skrive f.eks. "2x Pizza Margherita" eller brug produktnumre fra menuen: ${restaurant.menuUrl || 'vores hjemmeside'}`;
    } else if (orderValidationAttempts === 2) {
      // List some menu items as examples
      const exampleItems = currentMenu.items.slice(0, 3).map(i => `${i.number}. ${i.name} (${i.price} kr)`).join(', ');
      helpMessage = `Her er nogle af vores produkter: ${exampleItems}. Hvad vil du gerne bestille?`;
    } else {
      helpMessage = 'Skriv venligst din bestilling som f.eks. "1 margherita og 1 pepperoni" eller "nummer 1 og nummer 5"';
    }
    
    await sendSMS(phone, helpMessage, restaurant);
    
    activateNode('wait-order-retry');
    const retryOrderReply = await waitForReply();
    if (!retryOrderReply || !testRunning) return;
    
    // Parse igen
    activateNode('ai-order-parser');
    parsedOrder = await parseOrderWithMenu(retryOrderReply, currentMenu, restaurant.name);
  }
  
  // Hvis stadig ikke valid efter max fors√∏g
  if (!parsedOrder.valid || parsedOrder.items.length === 0) {
    addLog('‚ùå Kunne ikke identificere produkter - afslutter', 'error');
    await sendSMS(phone, 'Beklager, jeg kunne ikke forst√• din bestilling. Pr√∏v at ringe til os direkte, s√• hj√¶lper vi dig gerne!', restaurant);
    activateNode('end-invalid-order');
    return;
  }
  
  // Generer bekr√¶ftelsesbesked med produktnavne og pris
  const orderConfirmation = generateOrderConfirmation(parsedOrder);
  order = orderConfirmation.summary;
  addLog(`üìã Ordre: ${order}`, 'success');
  addLog(`üí∞ Total: ${parsedOrder.total} kr`, 'success');
  
  activateNode('order-parser-condition');
  await sleep(300);
  
  // =====================================================
  // ORDRE BEKR√ÜFTELSE MED LOOP-BACK
  // =====================================================
  let orderConfirmed = false;
  let retryCount = 0;
  const maxRetries = 3;
  
  while (!orderConfirmed && retryCount < maxRetries && testRunning) {
    // Confirm order MED pris
    activateNode('send-confirm-order');
    await sendSMS(phone, orderConfirmation.message, restaurant);
    
    activateNode('wait-confirm');
    const confirmReply = await waitForReply();
    if (!confirmReply || !testRunning) return;
    
    // AI analyserer svar med forbedret kontekst
    activateNode('order-confirmation');
    const confirmClass = await classifyWithAI(confirmReply, 
      `Kundens svar p√• ordrebekr√¶ftelse. Kategoriser:
      - YES: Kunden bekr√¶fter ordren er korrekt
      - NO: Kunden siger ordren er forkert/vil √¶ndre
      - CHANGE: Kunden vil tilf√∏je/fjerne noget
      - QUESTION: Kunden stiller sp√∏rgsm√•l
      Ordre: ${order}`
    );
    
    const isConfirmed = confirmClass.category === 'YES' || 
                        confirmClass.category === 'POSITIVE' ||
                        confirmReply.toLowerCase().match(/^(ja|jep|yes|korrekt|rigtigt|det passer|fint|okay|ok|perfekt)[\s!.,]*$/i);
    
    const isRejected = confirmClass.category === 'NO' ||
                       confirmClass.category === 'CHANGE' ||
                       confirmReply.toLowerCase().includes('ikke korrekt') ||
                       confirmReply.toLowerCase().includes('forkert') ||
                       confirmReply.toLowerCase().includes('nej') ||
                       confirmReply.toLowerCase().includes('√¶ndre');
    
    if (isConfirmed) {
      orderConfirmed = true;
      addLog('‚úÖ Ordre bekr√¶ftet af kunden', 'success');
    } else if (isRejected) {
      retryCount++;
      addLog(`üîÑ Kunden vil √¶ndre ordren (fors√∏g ${retryCount}/${maxRetries})`, 'warn');
      
      // LOOP-BACK: Sp√∏rg hvad der skal √¶ndres
      activateNode('send-retry');
      await sendSMS(phone, 'Ingen problem! Hvad vil du gerne √¶ndre eller tilf√∏je til din bestilling?', restaurant);
      
      activateNode('wait-order-change');
      const changeReply = await waitForReply();
      if (!changeReply || !testRunning) return;
      
      // Re-parse den √¶ndrede ordre
      activateNode('ai-order-parser');
      
      // Tjek om det er en tilf√∏jelse eller helt ny ordre
      const isAddition = changeReply.toLowerCase().includes('tilf√∏j') || 
                        changeReply.toLowerCase().includes('ogs√•') ||
                        changeReply.toLowerCase().includes('ekstra');
      
      if (isAddition && parsedOrder.items.length > 0) {
        // Parse kun tilf√∏jelsen og kombiner
        const additionalOrder = await parseOrderWithMenu(changeReply, currentMenu, restaurant.name);
        if (additionalOrder.valid && additionalOrder.items.length > 0) {
          parsedOrder.items = [...parsedOrder.items, ...additionalOrder.items];
          parsedOrder.total = parsedOrder.items.reduce((sum, item) => sum + item.lineTotal, 0);
          addLog(`‚ûï Tilf√∏jet: ${additionalOrder.items.map(i => i.name).join(', ')}`, 'success');
        }
      } else {
        // Helt ny ordre
        parsedOrder = await parseOrderWithMenu(changeReply, currentMenu, restaurant.name);
      }
      
      // Generer ny bekr√¶ftelse
      const newConfirmation = generateOrderConfirmation(parsedOrder);
      orderConfirmation.message = newConfirmation.message;
      orderConfirmation.summary = newConfirmation.summary;
      orderConfirmation.total = newConfirmation.total;
      order = newConfirmation.summary;
      
      addLog(`üìã Opdateret ordre: ${order} = ${parsedOrder.total} kr`, 'info');
    } else {
      // Uklart svar - sp√∏rg igen
      retryCount++;
      addLog(`‚ùì Uklart svar - sp√∏rger igen (fors√∏g ${retryCount}/${maxRetries})`, 'warn');
      await sendSMS(phone, 'Undskyld, jeg forstod ikke helt. Er ordren korrekt? Svar Ja eller Nej.', restaurant);
      continue;
    }
  }
  
  if (!orderConfirmed) {
    await sendSMS(phone, 'Det ser ud til vi har problemer med ordren. Ring venligst til os direkte, s√• hj√¶lper vi dig! üìû', restaurant);
    return;
  }
  
  // =====================================================
  // NAVN INDSAMLING MED FORBEDRET VALIDERING - AdvancedAI
  // =====================================================
  let customerNameConfirmed = false;
  let nameRetryCount = 0;

  while (!customerNameConfirmed && nameRetryCount < maxRetries && testRunning) {
    // Ask name
    activateNode('ask-name');

    // Opdater conversation phase
    if (window.AdvancedAI) {
      const conv = AdvancedAI.ConversationStateManager.getConversation(conversationId);
      conv.currentPhase = 'FASE_4_NAVN';
      conv.validationAttempts.name = nameRetryCount;
    }

    // Brug kontekst-aware prompts
    let namePrompt;
    if (nameRetryCount === 0) {
      namePrompt = 'Perfekt! M√• jeg bede om dit fulde navn til bestillingen?';
    } else if (nameRetryCount === 1) {
      namePrompt = 'Jeg har brug for b√•de fornavn og efternavn. Hvad hedder du?';
    } else {
      namePrompt = 'Et fornavn er nok - hvad m√• vi kalde dig?';
    }

    await sendSMS(phone, namePrompt, restaurant);

    activateNode('wait-name');
    const nameReply = await waitForReply();
    if (!nameReply || !testRunning) return;

    // Tilf√∏j til conversation history
    if (window.AdvancedAI) {
      AdvancedAI.ConversationStateManager.addMessage(conversationId, 'user', nameReply);
    }
    
    // Brug AdvancedAI navn validering hvis tilg√¶ngelig
    let nameValidation;
    if (window.AdvancedAI) {
      nameValidation = AdvancedAI.validation.validateName(nameReply);
      addLog(`üîç AdvancedAI navn validering: ${nameValidation.valid ? '‚úì' : '‚úó'}`, 'ai');

      if (nameValidation.valid) {
        customerName = nameValidation.name;
        customerNameConfirmed = true;

        // Opdater conversation state
        AdvancedAI.ConversationStateManager.updateCustomerData(conversationId, 'name', customerName);

        addLog(`üë§ Navn: ${customerName}`, 'success');
      } else if (nameValidation.needsConfirmation) {
        // Us√¶dvanligt navn - sp√∏rg for at bekr√¶fte
        await sendSMS(phone, nameValidation.confirm, restaurant);
        const confirmReply = await waitForReply();

        if (confirmReply && /ja|yes|korrekt|rigtigt|ok/i.test(confirmReply)) {
          customerName = nameValidation.name;
          customerNameConfirmed = true;
          AdvancedAI.ConversationStateManager.updateCustomerData(conversationId, 'name', customerName);
          addLog(`üë§ Navn bekr√¶ftet: ${customerName}`, 'success');
        } else {
          nameRetryCount++;
          addLog(`‚ö†Ô∏è Navn ikke bekr√¶ftet (fors√∏g ${nameRetryCount}/${maxRetries})`, 'warn');
        }
      } else {
        nameRetryCount++;
        addLog(`‚ö†Ô∏è Ugyldigt navn: "${nameReply}" (fors√∏g ${nameRetryCount}/${maxRetries})`, 'warn');

        if (nameRetryCount >= maxRetries) {
          customerName = 'G√¶st';
          customerNameConfirmed = true;
          addLog('üë§ Navn sat til: G√¶st', 'info');
        }
      }
    } else {
      // Legacy AI validering
      activateNode('ai-name-extractor');
      const nameClass = await classifyWithAI(nameReply,
        `Udtr√¶k kundens navn fra beskeden.
        Accepter: fulde navne, fornavne, kaldenavne.
        Kategoriser:
        - NAME: Beskeden indeholder et navn (udtr√¶k det i "extracted")
        - NO: Kunden vil ikke give navn
        - QUESTION: Kunden stiller sp√∏rgsm√•l
        - OTHER: Andet

        Eksempler p√• gyldige navne: "Martin", "Martin Klaksvig", "Klaksvig", "kh", "mk"`
      );

      // Tjek for negativt svar
      const isNegative = nameClass.category === 'NO' ||
                         nameReply.toLowerCase().match(/^(nej|no|ikke|vil ikke)[\s!.,]*$/i);

      if (isNegative) {
        nameRetryCount++;
        addLog(`‚ö†Ô∏è Kunden vil ikke give navn (fors√∏g ${nameRetryCount}/${maxRetries})`, 'warn');

        if (nameRetryCount >= maxRetries) {
          customerName = 'G√¶st';
          customerNameConfirmed = true;
          addLog('üë§ Navn sat til: G√¶st', 'info');
        } else {
          await sendSMS(phone, 'Vi har brug for et navn til ordren, s√• vi kan kalde dig op. Det kan bare v√¶re et fornavn üòä', restaurant);
        }
      } else if (nameClass.category === 'NAME' || nameClass.extracted) {
        // Udtr√¶k navn fra AI eller brug reply direkte
        let extractedName = nameClass.extracted || nameReply.trim();

        // Rens navnet - fjern "jeg hedder", "mit navn er" etc.
        extractedName = extractedName
          .replace(/^(jeg hedder|jeg er|mit navn er|hedder|navn:?)\s*/i, '')
          .replace(/[.,!?]+$/, '')
          .trim();

        // Kapitaliser navn korrekt
        extractedName = extractedName.split(' ')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
          .join(' ');

        // Valider at det ligner et navn (mindst 2 tegn, prim√¶rt bogstaver)
        const isValidName = extractedName.length >= 2 &&
                            /^[A-Z√Ü√ò√Öa-z√¶√∏√•\s\-']+$/.test(extractedName) &&
                            !/^\d+$/.test(extractedName);

        if (isValidName) {
          customerName = extractedName;
          customerNameConfirmed = true;
          addLog(`üë§ Navn: ${customerName}`, 'success');
        } else {
          nameRetryCount++;
          addLog(`‚ö†Ô∏è Ugyldigt navn format: "${extractedName}"`, 'warn');

          if (nameRetryCount >= maxRetries) {
            // Brug hvad vi har eller "G√¶st"
            customerName = extractedName.length >= 2 ? extractedName : 'G√¶st';
            customerNameConfirmed = true;
            addLog(`üë§ Navn (accepteret): ${customerName}`, 'info');
          }
        }
      } else {
        // Pr√∏v at bruge reply direkte som navn hvis det ser ud som et
        const directName = nameReply.trim();
        if (directName.length >= 2 && directName.length <= 50 && /^[A-Z√Ü√ò√Öa-z√¶√∏√•\s\-']+$/.test(directName)) {
          customerName = directName.split(' ')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
            .join(' ');
          customerNameConfirmed = true;
          addLog(`üë§ Navn (direkte): ${customerName}`, 'success');
        } else {
          nameRetryCount++;
          addLog(`‚ùì Kunne ikke finde navn i: "${nameReply}"`, 'warn');

          if (nameRetryCount >= maxRetries) {
            customerName = 'G√¶st';
            customerNameConfirmed = true;
            addLog('üë§ Navn sat til: G√¶st', 'info');
          }
        }
      }
    }
  }
  
  activateNode('name-condition');
  await sleep(300);
  
  // Save & Process
  activateNode('update-contact-name');
  addLog('üíæ Kontakt opdateret', 'success');
  await sleep(200);
  
  activateNode('save-order-next');
  addLog('üíæ Ordre gemt til n√¶ste gang', 'success');
  await sleep(200);
  
  activateNode('new-order-task');
  addLog('üìã Ny ordre task oprettet', 'success');
  await sleep(200);
  
  activateNode('increment-order-count');
  restaurant.orders++;
  restaurant.recovered++;
  await sleep(200);
  
  // Internal notification
  activateNode('internal-notification');
  addLog(`üîî Notifikation: NY ORDRE fra ${customerName}!`, 'success');
  await sleep(200);
  
  // Check if full automation is enabled
  const isAutoMode = restaurant?.automation?.enabled || false;
  const autoTime = restaurant?.automation?.defaultTime || 40;
  
  if (isAutoMode) {
    // AUTOMATIC MODE - send confirmation immediately
    activateNode('send-final-confirm');
    
    // Get custom message or default
    const defaultAutoMsg = `Din ordre er bekr√¶ftet! {{restaurant}} har modtaget din bestilling og forventer den er klar om ca. {{ventetid}} minutter. Vi sender besked, n√•r maden er klar.`;
    let confirmMsg = restaurant?.customMessages?.orderAccepted || defaultAutoMsg;
    confirmMsg = confirmMsg
      .replace(/\{\{restaurant\}\}/gi, restaurant.name)
      .replace(/\{\{ventetid\}\}/gi, autoTime);
    
    await sendSMS(phone, confirmMsg, restaurant);
    addLog(`‚ö° Auto-bekr√¶ftelse sendt (${autoTime} min estimat)`, 'success');
    
    // Auto-create order with accepted status
    saveOrderToModule({
      phone,
      customerName,
      orderType,
      address,
      items: order,
      parsedOrder,
      restaurantId: restaurant.id,
      status: 'Accepteret',
      estimatedTime: autoTime,
      acceptedAt: new Date().toISOString()
    });
  } else {
    // MANUAL MODE - wait for restaurant to accept
    activateNode('send-final-confirm');
    
    // Get custom message or default
    const defaultPendingMsg = `Tak! Din ordre er nu sendt til k√∏kkenet. Afvent venligst, at restauranten accepterer din bestilling. Du modtager en bekr√¶ftelse snarest. üçï`;
    let pendingMsg = restaurant?.customMessages?.orderConfirm || defaultPendingMsg;
    pendingMsg = pendingMsg.replace(/\{\{restaurant\}\}/gi, restaurant.name);
    
    await sendSMS(phone, pendingMsg, restaurant);
    
    // Create order with pending status
    saveOrderToModule({
      phone,
      customerName,
      orderType,
      address,
      items: order,
      parsedOrder,
      restaurantId: restaurant.id,
      status: 'Afventer',
      createdAt: new Date().toISOString()
    });
    
    addLog('üìã Ordre oprettet - afventer restaurantens accept', 'info');
  }
  
  // RECEIPT WORKFLOW (NY SEKTION)
  activateNode('ask-receipt');
  await sendSMS(phone, '√ònsker du en kvittering p√• din bestilling? Svar JA eller NEJ.', restaurant);
  addLog('Sp√∏rger kunde om kvittering...', 'info');
  await sleep(200);
  
  activateNode('wait-receipt');
  addLog('Venter p√• svar om kvittering...', 'info');
  
  // Wait for receipt response
  const receiptReply = await waitForReply();
  addLog(`Kunde svarede: "${receiptReply}"`, 'info');
  
  // Process receipt response
  activateNode('intent-check-receipt');
  const wantsReceipt = classifyReceiptIntent(receiptReply);
  
  if (wantsReceipt) {
    // YES - Generate and send PDF receipt
    activateNode('generate-receipt');
    addLog('Genererer PDF-kvittering...', 'info');
    await sleep(200);

    // Build receipt data
    const orderNumber = Math.floor(100000 + Math.random() * 900000);
    const pickupTime = new Date(Date.now() + 30 * 60000).toLocaleTimeString('da-DK', { hour: '2-digit', minute: '2-digit' });

    // Generate PDF receipt
    const receiptData = {
      ordreNummer: orderNumber,
      dato: new Date().toISOString(),
      kunde: {
        navn: customerName,
        telefon: phone
      },
      linjer: (parsedOrder?.items || []).map(i => ({
        beskrivelse: i.name,
        antal: i.quantity || 1,
        pris: i.price
      })),
      total: parsedOrder?.total || 0,
      restaurant: {
        navn: restaurant.name,
        adresse: restaurant.address,
        telefon: restaurant.phone || restaurant.contact_phone,
        cvr: restaurant.cvr
      },
      orderType: orderType,
      pickupTime: pickupTime
    };

    activateNode('send-receipt-sms');

    // Try to generate and upload PDF
    let receiptUrl = null;
    try {
      if (typeof kvitteringGenerator !== 'undefined' && typeof SupabaseDB !== 'undefined') {
        const pdfBlob = kvitteringGenerator.getBlob(receiptData);
        const uploadResult = await SupabaseDB.uploadReceipt(pdfBlob, orderNumber, restaurant.id);
        if (!uploadResult.error) {
          receiptUrl = uploadResult.url;
          addLog(`üìÑ PDF uploadet: ${receiptUrl}`, 'success');
        }
      }
    } catch (pdfErr) {
      console.error('PDF generation error:', pdfErr);
      addLog('‚ö†Ô∏è PDF kunne ikke genereres - sender tekst-kvittering', 'warning');
    }

    // Send SMS with PDF link OR fallback to text receipt
    if (receiptUrl) {
      const pdfMsg = `üìã Din kvittering er klar!\n\nOrdre #${orderNumber}\nTotal: ${parsedOrder?.total || 0} kr\n\nDownload her:\n${receiptUrl}\n\nTak for din bestilling!\n${restaurant.name}`;
      await sendSMS(phone, pdfMsg, restaurant);
      addLog('PDF-kvittering sendt til kunden via SMS', 'success');
    } else {
      // Fallback to text receipt
      const orderItems = parsedOrder?.items?.map(i => `‚Ä¢ ${i.name} - ${i.price} kr`).join('\n') || order;
      const receiptMsg = `üìã KVITTERING\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nOrdre: #${orderNumber}\n${orderItems}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nTotal: ${parsedOrder?.total || 0} kr\n${orderType === 'Pickup' ? 'Afhentning' : 'Levering'}: ca. ${pickupTime}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nTak for din bestilling!\n${restaurant.name}`;
      await sendSMS(phone, receiptMsg, restaurant);
      addLog('Tekst-kvittering sendt til kunden (PDF fallback)', 'success');
    }
  } else {
    // NO - Send polite goodbye
    activateNode('send-no-receipt');
    await sendSMS(phone, 'Helt i orden! Vi gl√¶der os til at se dig. Hav en fortsat god dag!', restaurant);
    addLog('Kunde √∏nsker ikke kvittering - p√¶n afslutning sendt', 'success');
  }
  await sleep(200);
  
  // TRIN 3: Gem ordre til intern Ordrer-side
  activateNode('push-to-orders');
  
  // Byg komplet ordre data pakke
  const orderDataPackage = {
    customerName: customerName,
    phone: phone,
    address: address,
    orderType: orderType,
    orderSummary: order,
    items: parsedOrder?.items || [],
    totalPrice: parsedOrder?.total || 0,
    restaurantId: restaurant.id,
    restaurantName: restaurant.name
  };
  
  // Gem til intern Ordrer-side (sidebar menu)
  saveOrderToInternalOrdersPage(orderDataPackage);
  
  addLog(`üì¶ Ordre sendt til Ordrer-siden: ${order} - ${parsedOrder?.total || 0} kr`, 'success');
  await sleep(200);
  
  // Update KPI data
  updateRestaurantKpi(restaurant, parsedOrder);
  
  // Check if review request is enabled for this restaurant
  if (restaurant.reviewRequestEnabled !== false) {
    // Add to review workflow
    activateNode('add-to-review');
    addLog('‚≠ê Tilf√∏jet til Review Workflow (Trustpilot + Google)', 'success');
    await sleep(200);
    
    // Wait for review delay (configurable per restaurant)
    activateNode('wait-review-delay');
    const reviewDelay = restaurant.reviewDelay || 60; // Default 60 min
    addLog(`Wait: ${reviewDelay} min (fra ${restaurant.name} indstillinger)`, 'info');
    await sleep(200);
    
    // Send review request (in real scenario this would be delayed)
    activateNode('send-review-request');
    
    // Build review message with actual URLs
    const reviewMsg = `Tak for din ordre hos ${restaurant.name}! Vi h√•ber du n√∏d maden. Giv os gerne en anmeldelse:\n\nGoogle: ${restaurant.googleReviewUrl || 'N/A'}\nTrustpilot: ${restaurant.trustpilotUrl || 'N/A'}`;
    // In production: await sendSMS(phone, reviewMsg, restaurant);
    addLog('‚≠ê Anmeldelsesanmodning sendt (Trustpilot + Google)', 'success');
    await sleep(200);
    
    // 1 hour lock
    activateNode('wait-1-hour');
    addLog('üîí 1 time lock aktiveret (loop beskyttelse)', 'info');
    await sleep(200);
  } else {
    addLog('‚è≠Ô∏è Anmeldelsesanmodning er deaktiveret - springer over', 'info');
    await sleep(200);
  }
  
  // Update stats
  loadRestaurants();
  loadDashboard();
  
  // End
  activateNode('end-final');
  addLog('üèÅ Workflow f√¶rdig!', 'success');
}

// Update restaurant KPI data after order
function updateRestaurantKpi(restaurant, parsedOrder) {
  if (!restaurant.kpi) return;
  
  // Update heatmap for current hour
  const now = new Date();
  const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
  const dayName = dayNames[now.getDay()];
  const hour = now.getHours();
  
  if (restaurant.kpi.orderHeatmap && restaurant.kpi.orderHeatmap[dayName]) {
    restaurant.kpi.orderHeatmap[dayName][hour]++;
  }
  
  // Update revenue
  if (parsedOrder?.total) {
    restaurant.kpi.totalRevenue += parsedOrder.total;
    restaurant.kpi.recoveredRevenue += parsedOrder.total;
  }
  
  // Update completed orders
  restaurant.kpi.completedOrders = (restaurant.kpi.completedOrders || 0) + 1;
  
  // Recalculate conversion rate
  if (restaurant.kpi.missedCalls > 0) {
    restaurant.kpi.conversionRate = Math.round((restaurant.kpi.completedOrders / restaurant.kpi.missedCalls) * 100);
  }
}

function activateNode(id) {
  document.querySelectorAll('.wf-node').forEach(n => n.classList.remove('active'));
  const node = document.getElementById('node-' + id);
  if (node) {
    node.classList.add('active');
    node.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

async function sendSMS(to, message, restaurant) {
  addLog(`üì± SMS -> ${to}`, 'sms');
  addMessage(message, 'out');

  // Log to customer aktivitetslogs
  if (restaurant?.id) {
    addCustomerAktivitetslog(restaurant.id, 'sms', `SMS sendt til ${to}: ${message.substring(0, 80)}${message.length > 80 ? '...' : ''}`);
  }

  if (liveMode) {
    // Format phone number
    const normalized = normalizePhoneNumber(to);
    const phoneNumber = normalized.digits;
    if (!phoneNumber) {
      addLog('‚ùå Ugyldigt telefonnummer', 'error');
      return;
    }

    // Send SMS via InMobile
    await sendSMS(phoneNumber, message);
  }

  await sleep(300);
}

// Send SMS via InMobile
async function sendSMS(phoneNumber, message) {
  // Get InMobile credentials
  const apiKey = localStorage.getItem('inmobile_api_key');
  const sender = localStorage.getItem('inmobile_sender') || 'OrderFlow';

  if (!apiKey) {
    addLog(`‚ùå SMS API key mangler - tjek Indstillinger`, 'error');
    return;
  }

  addLog(`üì§ Sender SMS til ${phoneNumber}...`, 'info');

  try {
    // Send via Supabase Edge Function (InMobile)
    const supabaseUrl = CONFIG.SUPABASE_URL;
    const response = await fetch(`${supabaseUrl}/functions/v1/send-sms`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify({
        to: phoneNumber,
        message: message,
        sender: sender,
        apiKey: apiKey
      })
    });

    const result = await response.json();
    console.log('SMS response:', result);

    if (result.success || result.sid) {
      addLog(`‚úÖ SMS sendt! ID: ${result.sid}`, 'success');
    } else {
      addLog(`‚ùå SMS fejl: ${result.error || 'Ukendt fejl'}`, 'error');
    }
  } catch (err) {
    console.error('SMS error:', err);
    addLog(`‚ùå SMS fejl: ${err.message}`, 'error');
  }
}

function addMessage(text, dir, showApproval = false) {
  const container = document.getElementById('messages');
  if (!container) {
    console.error('Messages container not found!');
    return null;
  }

  console.log('addMessage called:', { text: text.substring(0, 50), dir, container: container.id });

  // Classify intent for incoming messages (customer messages)
  if (dir === 'in' && typeof window.classifyAndDisplayIntent === 'function') {
    window.classifyAndDisplayIntent(text);
  }

  const time = new Date().toLocaleTimeString('da-DK');
  const msgId = 'msg-' + Date.now();

  let approvalHtml = '';
  if (showApproval) {
    approvalHtml = `
      <div class="msg-approval" id="${msgId}-approval">
        <div style="font-size:10px;color:var(--warn);margin-bottom:6px;">ü§ñ AI forslag - godkend eller rediger:</div>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-primary" style="flex:1;padding:6px;font-size:11px;" onclick="approveAiResponse('${msgId}')">‚úì Send</button>
          <button class="btn btn-secondary" style="flex:1;padding:6px;font-size:11px;" onclick="editAiResponse('${msgId}')">‚úé Rediger</button>
          <button class="btn btn-danger" style="padding:6px;font-size:11px;" onclick="rejectAiResponse('${msgId}')">‚úó</button>
        </div>
      </div>
    `;
  }

  container.innerHTML += `
    <div class="msg ${dir}" id="${msgId}" data-text="${encodeURIComponent(text)}">
      ${text}
      <div class="msg-time">${time}</div>
      ${approvalHtml}
    </div>
  `;
  container.scrollTop = container.scrollHeight;
  return msgId;
}

// AI Classification with OpenAI
// =====================================================
// MENU & ORDER FUNCTIONS (Trin 1, 2, 3)
// =====================================================

// Trin 1: Fetch menu - bruger demo data eller scraper website (fremtidig feature)
async function fetchMenuForRestaurant(restaurant) {
  const restaurantId = restaurant.id;
  const websiteUrl = restaurant.website || restaurant.menuUrl;
  
  addLog(`üìã Indl√¶ser menu for ${restaurant.name}...`, 'info');
  
  // PRIORITET 0: Produkter fra Produkter-siden (h√∏jeste prioritet)
  const productsKey = `products_${restaurantId}`;
  const savedProducts = localStorage.getItem(productsKey);
  if (savedProducts) {
    try {
      const productData = JSON.parse(savedProducts);
      if (productData.products && productData.products.length > 0) {
        addLog(`‚úÖ Produkter indl√¶st fra Produkter-siden: ${productData.products.length} produkter`, 'success');
        return {
          items: productData.products.map(p => ({
            id: p.id,
            number: p.number || '',
            name: p.name,
            description: p.description || '',
            price: p.price,
            category: p.category || 'Andet'
          })),
          extras: productData.extras || [],
          deliveryZones: productData.deliveryZones || [],
          restaurantId: restaurantId,
          restaurantName: restaurant.name,
          currency: 'DKK'
        };
      }
    } catch (e) {
      console.error('Products parse error:', e);
    }
  }
  
  // PRIORITET 0.5: Produkter direkte p√• restaurant objektet
  if (restaurant.products && restaurant.products.length > 0) {
    addLog(`‚úÖ Restaurant produkter indl√¶st: ${restaurant.products.length} produkter`, 'success');
    return {
      items: restaurant.products.map(p => ({
        id: p.id,
        number: p.number || '',
        name: p.name,
        description: p.description || '',
        price: p.price,
        category: p.category || 'Andet'
      })),
      extras: restaurant.extras || [],
      deliveryZones: restaurant.deliveryZones || [],
      restaurantId: restaurantId,
      restaurantName: restaurant.name,
      currency: 'DKK'
    };
  }
  
  // PRIORITET 1: Custom menu gemt i restaurant settings
  if (restaurant.customMenu && restaurant.customMenu.items && restaurant.customMenu.items.length > 0) {
    addLog(`‚úÖ Custom menu indl√¶st: ${restaurant.customMenu.items.length} produkter`, 'success');
    return {
      items: restaurant.customMenu.items,
      restaurantId: restaurantId,
      restaurantName: restaurant.name,
      currency: restaurant.customMenu.currency || 'DKK'
    };
  }
  
  // PRIORITET 2: Menu fra Supabase (persistent storage)
  if (typeof SupabaseDB !== 'undefined' && SupabaseDB.getMenu) {
    try {
      const supabaseMenu = await SupabaseDB.getMenu(restaurantId);
      if (supabaseMenu && supabaseMenu.items && supabaseMenu.items.length > 0) {
        addLog(`‚úÖ Menu indl√¶st fra database: ${supabaseMenu.items.length} produkter`, 'success');
        return {
          ...supabaseMenu,
          restaurantName: restaurant.name
        };
      }
    } catch (e) {
      console.log('Could not load menu from Supabase:', e.message);
    }
  }

  // PRIORITET 3: Menu gemt i localStorage (fallback/cache)
  const storedMenu = localStorage.getItem(`menu_${restaurantId}`);
  if (storedMenu) {
    try {
      const parsedMenu = JSON.parse(storedMenu);
      if (parsedMenu.items && parsedMenu.items.length > 0) {
        addLog(`‚úÖ Gemt menu indl√¶st fra cache: ${parsedMenu.items.length} produkter`, 'success');
        return parsedMenu;
      }
    } catch (e) {
      console.error('Menu parse error:', e);
    }
  }

  // PRIORITET 4: Demo menu data
  const demoMenu = DEMO_MENUS[restaurantId];
  if (demoMenu) {
    addLog(`‚úÖ Demo menu indl√¶st: ${demoMenu.items.length} produkter`, 'success');
    return demoMenu;
  }
  
  // PRIORITET 4: Generisk standard menu
  addLog('‚ö†Ô∏è Ingen menu fundet - bruger generisk standard menu', 'warn');
  addLog('üí° Tip: G√• til Kunder -> [Restaurant] -> Produkter for at tilf√∏je produkter', 'info');
  return { 
    items: [
      { id: 1, number: '1', name: 'Ret 1', price: 99, category: 'Mad' },
      { id: 2, number: '2', name: 'Ret 2', price: 119, category: 'Mad' },
      { id: 3, number: '3', name: 'Ret 3', price: 89, category: 'Mad' },
      { id: 4, number: '4', name: 'Drikkevare', price: 25, category: 'Drikkevarer' }
    ], 
    restaurantId, 
    restaurantName: restaurant.name,
    currency: 'DKK' 
  };
}

// Gem custom menu for restaurant
function saveCustomMenu(restaurantId, menuItems) {
  const menu = {
    restaurantId: restaurantId,
    items: menuItems,
    currency: 'DKK',
    updatedAt: new Date().toISOString()
  };

  // Gem til localStorage (hurtig backup)
  localStorage.setItem(`menu_${restaurantId}`, JSON.stringify(menu));

  // Gem til Supabase (persistent storage)
  if (typeof SupabaseDB !== 'undefined' && SupabaseDB.saveMenu) {
    SupabaseDB.saveMenu(restaurantId, menu)
      .catch(err => console.warn('Could not save menu to Supabase:', err.message));
  }

  // Opdater ogs√• restaurant objektet
  const restaurant = restaurants.find(r => r.id === restaurantId);
  if (restaurant) {
    restaurant.customMenu = menu;
  }

  return menu;
}

// Trin 2: Parse ordre med menu-matching og priskalkulation - FORBEDRET
async function parseOrderWithMenu(orderText, menu, restaurantName) {
  if (!CONFIG.OPENAI_API_KEY || CONFIG.OPENAI_API_KEY.includes('YOUR_')) {
    addLog('‚ö†Ô∏è OpenAI API key mangler - bruger fallback', 'warn');
    return { items: [], total: 0, valid: false, orderText: orderText };
  }
  
  addLog('ü§ñ AI parser ordre med menu (JSON integration)...', 'ai');
  
  // Byg komplet JSON menu struktur til AI
  const menuJSON = JSON.stringify(menu.items.map(item => ({
    nummer: item.number,
    navn: item.name,
    pris: item.price,
    kategori: item.category || 'Andet'
  })), null, 2);
  
  // Byg ogs√• simpel tekstliste som backup
  const menuText = menu.items.map(item => 
    `Nr. ${item.number}: ${item.name} = ${item.price} kr`
  ).join('\n');
  
  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          {
            role: 'system',
            content: `Du er en ordre-parser for restauranten "${restaurantName}".
Din ENESTE opgave er at matche kundens bestilling med menukortet og beregne den PR√ÜCISE totalpris.

MENUKORT (JSON):
${menuJSON}

MENUKORT (TEKST):
${menuText}

KRITISKE REGLER:
1. Match "nummer X", "nr X", "nr. X" til produktets nummer-felt
2. Match produktnavne direkte (f.eks. "margherita" -> "Pizza Margherita")
3. Match delvist (f.eks. "pepperoni" -> "Pizza Pepperoni")
4. Udtr√¶k antal: "2x", "to stk", "2 styk", "et par" = 2, default = 1
5. BEREGN ALTID: unit_price √ó quantity = line_total
6. BEREGN ALTID: sum af alle line_total = total_price

DU SKAL SVARE MED PR√ÜCIS DETTE JSON FORMAT:
{
  "items": [
    {
      "number": "1",
      "name": "Pizza Margherita",
      "quantity": 2,
      "unit_price": 89,
      "line_total": 178
    }
  ],
  "total_price": 178,
  "valid": true,
  "error": null
}

VIGTIGT:
- unit_price SKAL v√¶re prisen fra menukortet
- line_total SKAL v√¶re unit_price √ó quantity
- total_price SKAL v√¶re summen af alle line_total
- Hvis du ikke kan matche et produkt, s√¶t valid: false og forklar i "error"
- Svar KUN med JSON, ingen anden tekst`
          },
          {
            role: 'user',
            content: `Parse denne bestilling og beregn totalpris:\n"${orderText}"`
          }
        ],
        max_tokens: 800,
        temperature: 0.05  // Lavere temperatur for mere pr√¶cis parsing
      })
    });
    
    const data = await response.json();
    
    if (!data.choices || !data.choices[0]) {
      addLog('‚ùå Intet svar fra AI', 'error');
      return { items: [], total: 0, valid: false, orderText: orderText };
    }
    
    let result;
    
    try {
      // Rens JSON output grundigt
      let content = data.choices[0].message.content;
      content = content.replace(/```json\n?/gi, '').replace(/```\n?/gi, '').trim();
      // Fjern eventuelle kommentarer
      content = content.replace(/\/\/.*$/gm, '');
      result = JSON.parse(content);
    } catch (parseErr) {
      addLog('‚ö†Ô∏è Kunne ikke parse AI JSON svar: ' + parseErr.message, 'warn');
      console.error('AI response:', data.choices[0].message.content);
      return { items: [], total: 0, valid: false, orderText: orderText };
    }
    
    // Normaliser felter (h√•ndter b√•de total og total_price)
    const total = Number(result.total_price) || Number(result.total) || 0;
    const items = (result.items || []).map(item => {
      const quantity = Number(item.quantity) || Number(item.antal) || 1;
      const unitPrice = Number(item.unit_price) || Number(item.unitPrice) || Number(item.pris) || 0;
      const lineTotal = Number(item.line_total) || Number(item.lineTotal) || (unitPrice * quantity);

      return {
        number: String(item.number || item.nummer || ''),
        name: String(item.name || item.navn || ''),
        quantity: quantity,
        unitPrice: unitPrice,
        lineTotal: isNaN(lineTotal) ? 0 : lineTotal
      };
    });

    // Valider og genberegn total hvis n√∏dvendigt (med NaN check)
    const calculatedTotal = items.reduce((sum, item) => {
      const val = Number(item.lineTotal) || 0;
      return sum + (isNaN(val) ? 0 : val);
    }, 0);
    const finalTotal = calculatedTotal > 0 ? calculatedTotal : total;
    
    if (items.length > 0 && finalTotal > 0) {
      const itemSummary = items.map(i => `${i.quantity}x ${i.name} (${i.unitPrice} kr)`).join(', ');
      addLog(`‚úÖ Ordre parsed: ${itemSummary}`, 'success');
      addLog(`üí∞ Total pris: ${finalTotal} kr`, 'success');
    } else if (result.error) {
      addLog(`‚ö†Ô∏è Ordre kunne ikke parses: ${result.error}`, 'warn');
    }
    
    return { 
      items: items, 
      total: finalTotal,
      valid: items.length > 0 && finalTotal > 0,
      orderText: orderText,
      error: result.error
    };
  } catch (err) {
    console.error('Order parsing error:', err);
    addLog(`‚ùå Ordre parsing fejl: ${err.message}`, 'error');
    return { items: [], total: 0, valid: false, orderText: orderText };
  }
}

// Generer bekr√¶ftelsesbesked med produktnavne og TOTAL PRIS - FORBEDRET
function generateOrderConfirmation(parsedOrder) {
  if (!parsedOrder.valid || !parsedOrder.items || parsedOrder.items.length === 0) {
    // Fallback uden priser
    return {
      message: `Bare for at bekr√¶fte din bestilling: ${parsedOrder.orderText}. Er det korrekt?`,
      summary: parsedOrder.orderText,
      total: 0,
      hasPrice: false
    };
  }
  
  // Byg detaljeret liste med priser
  const itemsList = parsedOrder.items.map(item => {
    if (item.quantity > 1) {
      return `${item.quantity}x ${item.name}`;
    }
    return item.name;
  }).join(', ');
  
  // Sikr at total er et tal
  const totalPrice = Number(parsedOrder.total) || 0;
  
  // Bekr√¶ftelsesbesked MED total pris
  let message;
  if (totalPrice > 0) {
    message = `Bare for at bekr√¶fte din bestilling: ${itemsList}. Den samlede pris er ${totalPrice} kr. Er det korrekt?`;
  } else {
    message = `Bare for at bekr√¶fte din bestilling: ${itemsList}. Er det korrekt?`;
  }
  
  return {
    message: message,
    summary: itemsList,
    total: totalPrice,
    items: parsedOrder.items,
    hasPrice: totalPrice > 0
  };
}

// =====================================================
// DYNAMISK OPEN CHECKER (Trin 2)
// =====================================================

// Tjek om restaurant er √•ben baseret p√• individuelle √•bningstider
// Synkroniserer automatisk med restaurant.openingHours
function checkRestaurantOpen(restaurant) {
  const now = new Date();
  // VIGTIG: Brug KORTE dag-navne der matcher UI og saveWorkflowSettings
  const dayNamesShort = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
  const dayNamesFull = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
  const dayIndex = now.getDay();
  const currentTime = now.getHours() * 60 + now.getMinutes(); // Minutter siden midnat
  
  // Hent AKTUELLE √•bningstider direkte fra restaurant objektet
  const hours = restaurant.openingHours || getDefaultOpeningHours();
  
  // Tjek begge navne-formater for bagudkompatibilitet
  const shortDay = dayNamesShort[dayIndex];
  const fullDay = dayNamesFull[dayIndex];
  const todayHours = hours[shortDay] || hours[fullDay];
  
  // Log hvilke √•bningstider der bruges (for debugging)
  console.log(`[OpenChecker] ${restaurant.name} - Day: ${shortDay}/${fullDay}, Hours:`, todayHours, 'Current time:', currentTime);
  
  // Tjek om dagen er lukket
  if (!todayHours || !todayHours.enabled) {
    return {
      isOpen: false,
      reason: 'closed_day',
      currentDay: getDayNameDanish(fullDay),
      openingHours: hours,
      nextOpen: getNextOpenTime(hours, now)
    };
  }
  
  // Parse √•bnings- og lukketid
  const openTime = parseTimeToMinutes(todayHours.open);
  let closeTime = parseTimeToMinutes(todayHours.close);
  
  // VIGTIG FIX: D√∏gn√•bent check (00:00 - 00:00)
  // Hvis b√•de open og close er 00:00, er restauranten d√∏gn√•ben
  if (openTime === 0 && closeTime === 0 && todayHours.open === '00:00' && todayHours.close === '00:00') {
    console.log(`[OpenChecker] ${restaurant.name} - D√òGN√ÖBEN (00:00-00:00)`);
    return {
      isOpen: true,
      currentDay: getDayNameDanish(fullDay),
      closeTime: '00:00',
      openingHours: hours,
      is24h: true
    };
  }
  
  // VIGTIG FIX: Hvis lukketid er 00:00 (midnat), behandl det som 24:00 (1440 minutter)
  // Dette h√•ndterer restauranter der lukker ved midnat
  if (closeTime === 0 && todayHours.close === '00:00') {
    closeTime = 1440; // 24 timer i minutter
  }
  
  // H√•ndter nat√•bent (lukker efter midnat n√¶ste dag)
  // Eksempel: √Öben 10:00 - 02:00 (n√¶ste dag)
  if (closeTime < openTime) {
    // Restauranten lukker efter midnat
    if (currentTime >= openTime || currentTime < closeTime) {
      return {
        isOpen: true,
        currentDay: getDayNameDanish(fullDay),
        closeTime: todayHours.close,
        openingHours: hours,
        closesAfterMidnight: true
      };
    }
  } else {
    // Normal √•bningstid (samme dag)
    if (currentTime >= openTime && currentTime < closeTime) {
      return {
        isOpen: true,
        currentDay: getDayNameDanish(fullDay),
        closeTime: todayHours.close,
        openingHours: hours
      };
    }
  }
  
  // Vi er uden for √•bningstiden
  return {
    isOpen: false,
    reason: currentTime < openTime ? 'not_yet_open' : 'already_closed',
    currentDay: getDayNameDanish(fullDay),
    todayOpen: todayHours.open,
    todayClose: todayHours.close,
    openingHours: hours,
    nextOpen: getNextOpenTime(hours, now)
  };
}

// Konverter tid string til minutter siden midnat
function parseTimeToMinutes(timeStr) {
  if (!timeStr) return 0;
  const [hours, minutes] = timeStr.split(':').map(Number);
  return hours * 60 + (minutes || 0);
}

// Hent dansk navn for ugedag (underst√∏tter b√•de korte og fulde navne)
function getDayNameDanish(day) {
  const names = {
    // Full names
    monday: 'Mandag',
    tuesday: 'Tirsdag',
    wednesday: 'Onsdag',
    thursday: 'Torsdag',
    friday: 'Fredag',
    saturday: 'L√∏rdag',
    sunday: 'S√∏ndag',
    // Short names
    mon: 'Mandag',
    tue: 'Tirsdag',
    wed: 'Onsdag',
    thu: 'Torsdag',
    fri: 'Fredag',
    sat: 'L√∏rdag',
    sun: 'S√∏ndag'
  };
  return names[day] || day;
}

// Find n√¶ste √•bningstid (underst√∏tter b√•de korte og fulde dag-navne)
function getNextOpenTime(hours, fromDate) {
  const dayNamesShort = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
  const dayNamesFull = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
  const now = fromDate || new Date();
  const currentDayIndex = now.getDay();
  const currentMinutes = now.getHours() * 60 + now.getMinutes();
  
  // Tjek de n√¶ste 7 dage
  for (let i = 0; i < 7; i++) {
    const checkDayIndex = (currentDayIndex + i) % 7;
    // Try both name formats
    const dayHours = hours[dayNamesShort[checkDayIndex]] || hours[dayNamesFull[checkDayIndex]];
    const dayName = dayNamesFull[checkDayIndex]; // Use full name for display
    
    if (dayHours && dayHours.enabled) {
      const openMinutes = parseTimeToMinutes(dayHours.open);
      
      // Hvis det er i dag og vi ikke har passeret √•bningstiden
      if (i === 0 && currentMinutes < openMinutes) {
        return {
          day: getDayNameDanish(dayName),
          time: dayHours.open,
          isToday: true
        };
      }
      
      // Hvis det er en fremtidig dag
      if (i > 0) {
        return {
          day: getDayNameDanish(dayName),
          time: dayHours.open,
          isToday: false,
          daysAhead: i
        };
      }
    }
  }
  
  return null; // Ingen √•bne dage fundet
}

// Format √•bningstider til tekst (til AI og beskeder)
// Underst√∏tter b√•de korte (mon, tue) og fulde (monday, tuesday) dag-navne
function formatOpeningHoursText(restaurant) {
  const hours = restaurant.openingHours || getDefaultOpeningHours();
  const timeFormat = restaurant.timeFormat || '24h';
  
  // Mapping fra kort/fuldt navn til dansk forkortelse
  const dayMapping = [
    { short: 'mon', full: 'monday', danish: 'Man' },
    { short: 'tue', full: 'tuesday', danish: 'Tir' },
    { short: 'wed', full: 'wednesday', danish: 'Ons' },
    { short: 'thu', full: 'thursday', danish: 'Tor' },
    { short: 'fri', full: 'friday', danish: 'Fre' },
    { short: 'sat', full: 'saturday', danish: 'L√∏r' },
    { short: 'sun', full: 'sunday', danish: 'S√∏n' }
  ];
  
  const lines = dayMapping.map(({ short, full, danish }) => {
    // Try both short and full names
    const h = hours[short] || hours[full];
    if (!h || !h.enabled) return `${danish}: Lukket`;
    
    // Special case: 00:00-00:00 means 24h
    if (h.open === '00:00' && h.close === '00:00') {
      return `${danish}: D√∏gn√•bent`;
    }
    
    const open = formatTime(h.open, timeFormat);
    const close = formatTime(h.close, timeFormat);
    return `${danish}: ${open}-${close}`;
  });
  
  return lines.join('\n');
}

// Format tid baseret p√• valgt format
function formatTime(timeStr, format) {
  if (!timeStr) return '';
  if (format === '24h') return timeStr;
  
  // Konverter til AM/PM
  const [hours, minutes] = timeStr.split(':').map(Number);
  const period = hours >= 12 ? 'PM' : 'AM';
  const displayHours = hours % 12 || 12;
  return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
}

// Generer lukket-besked med n√¶ste √•bningstid
function generateClosedMessage(restaurant, openStatus) {
  const nextOpen = openStatus.nextOpen;
  
  let message = `Tak for din henvendelse til ${restaurant.name}. Vi har desv√¶rre lukket`;
  
  if (openStatus.reason === 'closed_day') {
    message += ` ${openStatus.currentDay.toLowerCase()}`;
  } else if (openStatus.reason === 'not_yet_open') {
    message += `. Vi √•bner kl. ${openStatus.todayOpen}`;
  } else if (openStatus.reason === 'already_closed') {
    message += ` for i dag`;
  }
  
  if (nextOpen) {
    if (nextOpen.isToday) {
      message += `. Vi √•bner igen kl. ${nextOpen.time} ‚òÄÔ∏è`;
    } else if (nextOpen.daysAhead === 1) {
      message += `. Vi √•bner igen i morgen (${nextOpen.day}) kl. ${nextOpen.time} ‚òÄÔ∏è`;
    } else {
      message += `. Vi √•bner igen ${nextOpen.day} kl. ${nextOpen.time} ‚òÄÔ∏è`;
    }
  }
  
  return message;
}

// Trin 3: Gem ordre til intern Ordrer-side (sidebar menu)
function saveOrderToInternalOrdersPage(orderData) {
  addLog('üì¶ Gemmer ordre til Ordrer-siden...', 'info');
  
  // Byg ordre objekt til intern brug
  const order = {
    id: Date.now(),
    timestamp: new Date().toISOString(),
    status: 'Ny',
    customerName: orderData.customerName,
    phone: orderData.phone,
    orderType: orderData.orderType,
    address: orderData.address || null,
    items: orderData.items || [],
    orderSummary: orderData.orderSummary,
    totalPrice: orderData.totalPrice,
    currency: 'DKK',
    restaurantId: orderData.restaurantId,
    restaurantName: orderData.restaurantName
  };
  
  // Gem i localStorage (vises p√• Ordrer-siden)
  const existingOrders = JSON.parse(localStorage.getItem('orders_module') || '[]');
  existingOrders.unshift(order);
  localStorage.setItem('orders_module', JSON.stringify(existingOrders));
  
  addLog(`‚úÖ Ordre #${order.id} gemt til Ordrer-siden`, 'success');
  
  // Opdater ordrer-siden hvis den er synlig
  if (document.getElementById('page-orders')?.classList.contains('active')) {
    loadOrdersPage();
  }
  
  return order;
}

// Load og vis ordrer p√• Ordrer-siden
function loadOrdersPage() {
  const ordersList = document.getElementById('orders-list');
  const ordersCount = document.getElementById('orders-count');
  const orders = JSON.parse(localStorage.getItem('orders_module') || '[]');
  
  if (ordersCount) {
    const newOrders = orders.filter(o => o.status === 'Ny').length;
    ordersCount.textContent = `${orders.length} ordre${orders.length !== 1 ? 'r' : ''}${newOrders > 0 ? ` (${newOrders} nye)` : ''}`;
  }
  
  if (orders.length === 0) {
    ordersList.innerHTML = `
      <div class="empty">
        <div class="empty-icon">üì¶</div>
        <div>Ingen ordrer endnu</div>
        <div style="font-size:12px;color:var(--muted);margin-top:8px">Ordrer vises her n√•r kunder bestiller via SMS</div>
      </div>`;
    return;
  }
  
  ordersList.innerHTML = orders.map(order => {
    // Status farver (uden ikoner)
    const statusColors = {
      'Ny': { bg: 'rgba(251,191,36,0.15)', color: '#fbbf24' },
      'Afventer': { bg: 'rgba(251,191,36,0.15)', color: '#fbbf24' },
      'Accepteret': { bg: 'rgba(96,165,250,0.15)', color: '#60a5fa' },
      'I gang': { bg: 'rgba(168,85,247,0.15)', color: '#a855f7' },
      'F√¶rdig': { bg: 'rgba(52,211,153,0.15)', color: '#34d399' },
      'Afvist': { bg: 'rgba(248,113,113,0.15)', color: '#f87171' }
    };
    const statusStyle = statusColors[order.status] || statusColors['Ny'];
    
    // Vis forskellige knapper baseret p√• status (uden emojis)
    let actionButtons = '';
    
    if (order.status === 'Ny' || order.status === 'Afventer') {
      // Ny/Afventer ordre: Accept/Afvis knapper
      actionButtons = `
        <button class="btn" style="flex:1;font-size:12px;background:#ef4444;color:#fff" onclick="rejectOrder(${order.id})">Afvis</button>
        <button class="btn btn-primary" style="flex:1;font-size:12px" onclick="acceptOrder(${order.id})">Accepter</button>
      `;
    } else if (order.status === 'Accepteret') {
      // Accepteret: Start knap
      actionButtons = `
        <button class="btn btn-secondary" style="flex:1;font-size:12px" onclick="startOrder(${order.id})">Start tilberedning</button>
      `;
    } else if (order.status === 'I gang') {
      // I gang: F√¶rdig knap
      actionButtons = `
        <button class="btn btn-primary" style="flex:1;font-size:12px" onclick="completeOrder(${order.id})">F√¶rdig</button>
      `;
    } else if (order.status === 'F√¶rdig' || order.status === 'Afvist') {
      // F√¶rdig/Afvist: Slet knap
      actionButtons = `
        <button class="btn btn-secondary" style="flex:1;font-size:12px" onclick="deleteOrder(${order.id})">Fjern</button>
      `;
    }
    
    return `
    <div class="order-item" style="padding:16px;border:1px solid var(--border);border-radius:var(--radius-md);margin-bottom:12px;background:var(--card);${order.status === 'Ny' || order.status === 'Afventer' ? 'border-left:3px solid #fbbf24;' : ''}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
        <div>
          <div style="font-weight:600;font-size:15px">${order.customerName || 'Ukendt kunde'}</div>
          <div style="font-size:12px;color:var(--muted)">${order.phone || ''}</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span style="display:inline-flex;align-items:center;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:500;background:${statusStyle.bg};color:${statusStyle.color}">
            ${order.status}
          </span>
          <span style="font-size:11px;color:var(--muted)">#${order.id}</span>
        </div>
      </div>
      <div style="background:var(--bg3);padding:12px;border-radius:var(--radius-sm);margin-bottom:12px">
        <div style="font-size:13px;margin-bottom:8px"><strong>Ordre:</strong> ${order.orderSummary}</div>
        <div style="font-size:14px;color:var(--accent);font-weight:600">Total: ${order.totalPrice || 0} kr</div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text2);margin-bottom:12px">
        <span>${order.orderType === 'Delivery' ? 'Levering' : 'Afhentning'}${order.address ? ': ' + order.address : ''}</span>
        <span>${new Date(order.timestamp).toLocaleString('da-DK')}</span>
      </div>
      <div style="display:flex;gap:8px">
        ${actionButtons}
      </div>
    </div>
  `}).join('');
}

// ACCEPT ordre - sender bekr√¶ftelses-SMS
async function acceptOrder(orderId) {
  const orders = JSON.parse(localStorage.getItem('orders_module') || '[]');
  // Fix: Compare as strings to handle type mismatch
  const order = orders.find(o => String(o.id) === String(orderId));
  
  if (!order) {
    console.error('Order not found:', orderId);
    toast('Ordre ikke fundet', 'error');
    return;
  }
  
  // Find restaurant for SMS
  const restaurant = restaurants.find(r => r.id === order.restaurantId) || restaurants[0];
  
  // Get custom message or use default
  const defaultMsg = `Din ordre er bekr√¶ftet! ${restaurant?.name || 'Restauranten'} har modtaget din bestilling og g√•r straks i gang. Vi sender besked, n√•r maden er klar.`;
  let message = restaurant?.customMessages?.orderAccepted || defaultMsg;
  
  // Send bekr√¶ftelses-SMS til kunden
  if (order.phone) {
    try {
      await sendSMSToCustomer(order.phone, message, restaurant);
      toast(`SMS sendt til ${order.customerName}`, 'success');
    } catch (err) {
      console.error('SMS fejl:', err);
    }
  }
  
  // Opdater status
  order.status = 'Accepteret';
  order.acceptedAt = new Date().toISOString();
  localStorage.setItem('orders_module', JSON.stringify(orders));
  loadOrdersPage();
  
  toast(`Ordre #${order.id} accepteret`, 'success');
}

// AFVIS ordre - sender afvisnings-SMS
async function rejectOrder(orderId) {
  const orders = JSON.parse(localStorage.getItem('orders_module') || '[]');
  // Fix: Compare as strings to handle type mismatch
  const order = orders.find(o => String(o.id) === String(orderId));
  
  if (!order) {
    console.error('Order not found:', orderId);
    toast('Ordre ikke fundet', 'error');
    return;
  }
  
  if (!confirm(`Er du sikker p√• du vil afvise ordren fra ${order.customerName}? Kunden f√•r besked.`)) return;
  
  // Find restaurant for SMS
  const restaurant = restaurants.find(r => r.id === order.restaurantId) || restaurants[0];
  
  // Send afvisnings-SMS til kunden
  if (order.phone) {
    try {
      await sendSMSToCustomer(order.phone,
        `Beklager! ${restaurant?.name || 'Restauranten'} har desv√¶rre for travlt til at modtage din ordre lige nu. Pr√∏v venligst igen om lidt, eller ring til os direkte. Vi beklager ulejligheden üôè`,
        restaurant
      );
    } catch (err) {
      console.error('SMS fejl:', err);
    }
  }
  
  // Opdater status
  order.status = 'Afvist';
  order.rejectedAt = new Date().toISOString();
  localStorage.setItem('orders_module', JSON.stringify(orders));
  loadOrdersPage();
  
  toast(`Ordre #${order.id} afvist`, 'info');
}

// START tilberedning - viser popup for tidsestimat
async function startOrder(orderId) {
  const orders = JSON.parse(localStorage.getItem('orders_module') || '[]');
  // Fix: Compare as strings to handle type mismatch
  const order = orders.find(o => String(o.id) === String(orderId));
  
  if (!order) {
    console.error('Order not found:', orderId);
    toast('Ordre ikke fundet', 'error');
    return;
  }
  
  // Find restaurant
  const restaurant = restaurants.find(r => r.id === order.restaurantId) || restaurants[0];
  
  // Get default time from automation settings
  const defaultTime = restaurant?.automation?.defaultTime || 30;
  
  // Show time estimate popup
  showTimeEstimatePopup(orderId, defaultTime, restaurant);
}

// Show time estimate popup
function showTimeEstimatePopup(orderId, defaultTime, restaurant) {
  // Create popup overlay
  const popup = document.createElement('div');
  popup.id = 'time-estimate-popup';
  popup.style.cssText = `
    position:fixed;top:0;left:0;right:0;bottom:0;
    background:rgba(0,0,0,0.7);z-index:10000;
    display:flex;align-items:center;justify-content:center;
  `;
  
  popup.innerHTML = `
    <div style="background:var(--bg2);padding:24px;border-radius:var(--radius-lg);max-width:400px;width:90%">
      <h3 style="margin:0 0 16px;font-size:16px">Angiv forventet ventetid</h3>
      <p style="font-size:13px;color:var(--muted);margin-bottom:16px">Hvor lang tid forventes ordren at tage?</p>
      
      <div style="display:flex;gap:8px;margin-bottom:16px">
        <button class="btn btn-secondary time-btn" onclick="setEstimateTime(15)" style="flex:1">15 min</button>
        <button class="btn btn-secondary time-btn" onclick="setEstimateTime(20)" style="flex:1">20 min</button>
        <button class="btn btn-secondary time-btn" onclick="setEstimateTime(30)" style="flex:1">30 min</button>
        <button class="btn btn-secondary time-btn" onclick="setEstimateTime(45)" style="flex:1">45 min</button>
      </div>
      
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:20px">
        <input type="number" id="custom-estimate-time" class="input" value="${defaultTime}" min="5" max="120" style="width:80px">
        <span style="color:var(--muted);font-size:13px">minutter</span>
      </div>
      
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn-secondary" onclick="closeTimeEstimatePopup()">Annuller</button>
        <button class="btn btn-primary" onclick="confirmStartOrder('${orderId}')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
          Start Tilberedning
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(popup);
}

// Set estimate time from quick buttons
function setEstimateTime(minutes) {
  document.getElementById('custom-estimate-time').value = minutes;
  // Highlight selected button
  document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
}

// Close time estimate popup
function closeTimeEstimatePopup() {
  const popup = document.getElementById('time-estimate-popup');
  if (popup) popup.remove();
}

// Confirm and start order with time estimate
async function confirmStartOrder(orderId) {
  const estimateTime = parseInt(document.getElementById('custom-estimate-time').value) || 30;
  closeTimeEstimatePopup();
  
  const orders = JSON.parse(localStorage.getItem('orders_module') || '[]');
  // Fix: Compare as strings to handle type mismatch
  const order = orders.find(o => String(o.id) === String(orderId));
  
  if (!order) {
    console.error('Order not found:', orderId);
    toast('Ordre ikke fundet', 'error');
    return;
  }
  
  // Find restaurant
  const restaurant = restaurants.find(r => r.id === order.restaurantId) || restaurants[0];
  
  // Calculate estimated ready time
  const readyTime = new Date(Date.now() + estimateTime * 60 * 1000);
  const readyTimeStr = readyTime.toLocaleTimeString('da-DK', { hour: '2-digit', minute: '2-digit' });
  
  // Get custom message or use default based on order type
  let message;
  if (order.orderType === 'Delivery') {
    message = `üöó Vi er nu i gang med din bestilling! Forventet levering om ca. ${estimateTime} minutter (kl. ${readyTimeStr}). Vi giver besked n√•r maden er p√• vej!`;
  } else {
    message = `üç≥ K√∏kkenet er nu i gang med din bestilling! Din mad er klar til afhentning om ca. ${estimateTime} minutter (kl. ${readyTimeStr}).`;
  }
  
  // Send "i gang" SMS til kunden
  if (order.phone) {
    try {
      await sendSMSToCustomer(order.phone, message, restaurant);
      toast(`SMS sendt til ${order.customerName}`, 'success');
    } catch (err) {
      console.error('SMS fejl:', err);
      toast('SMS kunne ikke sendes', 'error');
    }
  }
  
  // Opdater status
  order.status = 'I gang';
  order.estimatedTime = estimateTime;
  order.estimatedReadyTime = readyTimeStr;
  order.startedAt = new Date().toISOString();
  localStorage.setItem('orders_module', JSON.stringify(orders));
  loadOrdersPage();
  
  toast(`Ordre #${order.id} - tilberedning startet (${estimateTime} min)`, 'success');
}

// F√ÜRDIG ordre - sender "f√¶rdig" SMS med dynamisk tekst
async function completeOrder(orderId) {
  const orders = JSON.parse(localStorage.getItem('orders_module') || '[]');
  // Fix: Compare as strings to handle type mismatch
  const order = orders.find(o => String(o.id) === String(orderId));
  
  if (!order) {
    console.error('Order not found:', orderId);
    toast('Ordre ikke fundet', 'error');
    return;
  }
  
  // Find restaurant for SMS
  const restaurant = restaurants.find(r => r.id === order.restaurantId) || restaurants[0];
  
  // Dynamisk tekst baseret p√• ordretype
  let message;
  if (order.orderType === 'Delivery') {
    message = `üöó Din mad er nu p√• vej til dig! Forventet levering inden for kort tid. Velbekomme fra ${restaurant?.name || 'os'}! üçï`;
  } else {
    message = `‚úÖ Din ordre er nu klar til afhentning! Vi gl√¶der os til at se dig. Velbekomme fra ${restaurant?.name || 'os'}! üçï`;
  }
  
  // Send "f√¶rdig" SMS til kunden
  if (order.phone) {
    try {
      await sendSMSToCustomer(order.phone, message, restaurant);
      toast(`SMS sendt til ${order.customerName}`, 'success');
    } catch (err) {
      console.error('SMS fejl:', err);
    }
  }
  
  // Opdater status
  order.status = 'F√¶rdig';
  order.completedAt = new Date().toISOString();
  localStorage.setItem('orders_module', JSON.stringify(orders));
  loadOrdersPage();
  
  toast(`Ordre #${order.id} markeret som f√¶rdig`, 'success');
}

// Replace message variables with actual values
function replaceMessageVariables(message, restaurant, order, estimateTime = null) {
  if (!message) return message;
  
  const restaurantName = restaurant?.name || 'Restauranten';
  const orderType = order?.orderType || 'Afhentning';
  const deliveryText = orderType === 'Delivery' ? 'p√• vej til dig! üöó' : 'klar til afhentning! üè™';
  
  return message
    .replace(/\{\{restaurant\}\}/gi, restaurantName)
    .replace(/\{\{restaurant_name\}\}/gi, restaurantName)
    .replace(/\{\{ventetid\}\}/gi, estimateTime || order?.estimatedTime || '30')
    .replace(/\{\{leveringstype\}\}/gi, deliveryText)
    .replace(/\{\{ordre_id\}\}/gi, order?.id || '')
    .replace(/\{\{kunde_navn\}\}/gi, order?.customerName || 'Kunde')
    .replace(/\{\{ordre\}\}/gi, order?.items || '');
}

// Slet enkelt ordre
function deleteOrder(orderId) {
  const orders = JSON.parse(localStorage.getItem('orders_module') || '[]');
  const filtered = orders.filter(o => o.id !== orderId);
  localStorage.setItem('orders_module', JSON.stringify(filtered));
  loadOrdersPage();
}

// Save order to module (from workflow)
function saveOrderToModule(orderData) {
  const orders = JSON.parse(localStorage.getItem('orders_module') || '[]');
  
  const newOrder = {
    id: Date.now().toString(),
    phone: orderData.phone,
    customerName: orderData.customerName || 'Ukendt',
    orderType: orderData.orderType || 'Pickup',
    address: orderData.address || '',
    items: orderData.items || '',
    total: orderData.parsedOrder?.total || 0,
    restaurantId: orderData.restaurantId,
    status: orderData.status || 'Afventer',
    estimatedTime: orderData.estimatedTime || null,
    createdAt: orderData.createdAt || new Date().toISOString(),
    acceptedAt: orderData.acceptedAt || null,
    startedAt: orderData.startedAt || null,
    completedAt: orderData.completedAt || null
  };
  
  orders.push(newOrder);
  localStorage.setItem('orders_module', JSON.stringify(orders));
  
  addLog(`üìã Ordre gemt: #${newOrder.id} - ${newOrder.customerName}`, 'success');
  return newOrder;
}

// Hj√¶lpefunktion til at sende SMS til kunde (bruger eksisterende sendSMS)
async function sendSMSToCustomer(phone, message, restaurant) {
  try {
    // Use our InMobile SMS function
    await sendSMS(phone, message);
    return true;
  } catch (err) {
    console.error('SMS error:', err);
    return false;
  }
}

// Legacy funktion for bagudkompatibilitet
function updateOrderStatus(orderId, newStatus) {
  const orders = JSON.parse(localStorage.getItem('orders_module') || '[]');
  const orderIndex = orders.findIndex(o => o.id === orderId);
  
  if (orderIndex !== -1) {
    orders[orderIndex].status = newStatus;
    localStorage.setItem('orders_module', JSON.stringify(orders));
    loadOrdersPage();
  }
}

// Ryd alle ordrer
function clearAllOrders() {
  if (confirm('Er du sikker p√• du vil slette alle ordrer?')) {
    localStorage.removeItem('orders_module');
    loadOrdersPage();
  }
}

// =====================================================
// ADVANCED AI HELPER FUNCTIONS
// =====================================================

/**
 * Get current conversation ID for AdvancedAI
 */
function getCurrentConversationId() {
  const selectedRestaurant = getSelectedRestaurant();
  const phoneInput = document.getElementById('test-phone');
  const phone = phoneInput ? phoneInput.value : 'default';
  const restaurantId = selectedRestaurant ? selectedRestaurant.id : 'default';

  return `${restaurantId}-${phone}`;
}

/**
 * Toggle AdvancedAI system on/off
 */
function toggleAdvancedAI(enabled) {
  localStorage.setItem('advanced_ai_enabled', enabled ? 'true' : 'false');

  const status = enabled ? '‚ú® Advanced AI aktiveret' : 'üì¶ Legacy AI aktiv (fallback)';
  const type = enabled ? 'success' : 'info';

  if (window.showNotification) {
    showNotification(status, type);
  } else {
    addLog(status, type);
  }
}

async function classifyWithAI(message, context = '', expectedCategories = null) {
  // =====================================================
  // ADVANCED AI SYSTEM INTEGRATION (with fallback)
  // =====================================================

  // Feature flag - kan aktiveres per restaurant
  const USE_ADVANCED_AI = localStorage.getItem('advanced_ai_enabled') === 'true';

  // Pr√∏v Advanced AI system f√∏rst hvis aktiveret
  if (USE_ADVANCED_AI && window.AdvancedAI) {
    try {
      const conversationId = getCurrentConversationId();
      const result = await AdvancedAI.classifyAdvanced(message, conversationId, context);

      if (result && result.category) {
        addLog(`‚ú® AdvancedAI: ${result.category} (${Math.round((result.confidence || 1.0) * 100)}%)`, 'ai');
        return result;
      }
    } catch (error) {
      console.error('AdvancedAI error:', error);
      addLog(`‚ö†Ô∏è AdvancedAI fejl - falder tilbage til legacy: ${error.message}`, 'warn');
      // Fall through til legacy system
    }
  }

  // =====================================================
  // LEGACY AI KLASSIFICERING (FALLBACK)
  // - Deterministisk output
  // - Context-aware prompts
  // - Forbedret fallback
  // =====================================================

  const msg = message.toLowerCase().trim();
  
  // TRIN 1: Deterministisk pre-check (ingen AI n√∏dvendig for klare svar)
  const quickResult = quickClassify(msg, context);
  if (quickResult && quickResult.confidence >= 0.9) {
    addLog(`‚ö° Hurtig klassificering: ${quickResult.category}`, 'ai');
    return quickResult;
  }
  
  // TRIN 2: Brug AI hvis tilg√¶ngelig
  if (!CONFIG.OPENAI_API_KEY || CONFIG.OPENAI_API_KEY.includes('YOUR_')) {
    addLog('‚ö†Ô∏è OpenAI API key ikke konfigureret - bruger fallback', 'warn');
    return classifyWithFallback(message, context);
  }
  
  addLog('ü§ñ AI analyserer besked...', 'ai');
  
  // Byg kontekst-specifik prompt
  const systemPrompt = buildContextualPrompt(context, expectedCategories);
  
  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: `Besked: "${message}"` }
        ],
        max_tokens: 250,
        temperature: 0.1  // Lavere = mere deterministisk
      })
    });
    
    const data = await response.json();
    
    if (!data.choices || !data.choices[0]) {
      addLog('‚ö†Ô∏è Tomt AI svar - bruger fallback', 'warn');
      return classifyWithFallback(message, context);
    }
    
    let result;
    try {
      let content = data.choices[0].message.content;
      content = content.replace(/```json\n?/gi, '').replace(/```\n?/gi, '').trim();
      result = JSON.parse(content);
    } catch (parseErr) {
      addLog('‚ö†Ô∏è Kunne ikke parse AI JSON - bruger fallback', 'warn');
      return classifyWithFallback(message, context);
    }
    
    // Valider og normaliser resultat
    if (!result.category || result.category === 'UNKNOWN') {
      result.category = 'OTHER';
      result.confidence = 0.5;
    }
    
    addLog(`üéØ AI: ${result.category} (${Math.round((result.confidence || 0.5) * 100)}%)`, 'ai');
    return result;
  } catch (err) {
    console.error('AI error:', err);
    addLog(`‚ö†Ô∏è AI fejl - bruger fallback: ${err.message}`, 'warn');
    return classifyWithFallback(message, context);
  }
}

// =====================================================
// HURTIG DETERMINISTISK KLASSIFICERING
// H√•ndterer 80% af beskeder uden AI
// =====================================================
function quickClassify(msg, context = '') {
  const contextLower = context.toLowerCase();
  
  // === JA/NEJ SVAR ===
  // Meget h√∏j sikkerhed for simple ja/nej
  if (/^(ja|jep|yes|jo|jaa|yep|jaaa|ja!+|okay|ok|korrekt|rigtigt|det passer|fint|jeps)[\s!.,]*$/i.test(msg)) {
    return { category: 'YES', confidence: 0.98, extracted: msg };
  }
  if (/^(nej|no|nope|ikke|nej tak|n√¶|n√¶√¶)[\s!.,]*$/i.test(msg)) {
    return { category: 'NO', confidence: 0.98, extracted: msg };
  }
  
  // Ja med tilf√∏jelse
  if (/^ja[,\s]+(det |gerne|tak|perfekt|super)/i.test(msg)) {
    return { category: 'YES', confidence: 0.95, extracted: msg };
  }
  
  // === KONTEKST-BASERET KLASSIFICERING ===
  
  // Hvis vi venter p√• navn
  if (contextLower.includes('navn') || contextLower.includes('name')) {
    // Enkelt ord uden tal = sandsynligvis navn
    if (/^[a-z√¶√∏√•A-Z√Ü√ò√Ö\-']+$/.test(msg) && msg.length >= 2 && msg.length <= 30) {
      return { category: 'NAME', confidence: 0.85, extracted: capitalizeWords(msg) };
    }
    // "Jeg hedder X" format
    const nameMatch = msg.match(/(?:jeg hedder|jeg er|mit navn er|hedder)\s+([a-z√¶√∏√•A-Z√Ü√ò√Ö\s\-']+)/i);
    if (nameMatch) {
      return { category: 'NAME', confidence: 0.95, extracted: capitalizeWords(nameMatch[1].trim()) };
    }
    // To ord = fornavn + efternavn
    if (/^[a-z√¶√∏√•A-Z√Ü√ò√Ö\-']+\s+[a-z√¶√∏√•A-Z√Ü√ò√Ö\-']+$/.test(msg)) {
      return { category: 'NAME', confidence: 0.9, extracted: capitalizeWords(msg) };
    }
  }
  
  // Hvis vi venter p√• adresse
  if (contextLower.includes('adresse') || contextLower.includes('address') || contextLower.includes('levering')) {
    // Indeholder vejnavn og nummer
    if (/[a-z√¶√∏√•]+\s*\d+/i.test(msg) || /\d+\s*[a-z√¶√∏√•]+/i.test(msg)) {
      return { category: 'ADDRESS', confidence: 0.85, extracted: msg };
    }
    // Postnummer pattern
    if (/\b\d{4}\b/.test(msg)) {
      return { category: 'ADDRESS', confidence: 0.8, extracted: msg };
    }
  }
  
  // Hvis vi venter p√• ordre bekr√¶ftelse
  if (contextLower.includes('korrekt') || contextLower.includes('bekr√¶ft') || contextLower.includes('confirm')) {
    if (msg.includes('ikke korrekt') || msg.includes('forkert') || msg.includes('√¶ndre')) {
      return { category: 'NO', confidence: 0.95, extracted: msg };
    }
  }
  
  // === LEVERINGSTYPE ===
  if (/\b(afhent|hente|selv hente|pick\s*up|kommer selv)\b/i.test(msg)) {
    return { category: 'PICKUP', confidence: 0.9, extracted: 'Afhentning' };
  }
  if (/\b(lever|bring|udbring|k√∏r|delivery|hjem)\b/i.test(msg)) {
    return { category: 'DELIVERY', confidence: 0.9, extracted: 'Levering' };
  }
  
  // === ORDRE PATTERNS ===
  // Nummer-baseret ordre
  if (/(?:nr\.?|nummer|#)\s*\d+/i.test(msg)) {
    return { category: 'ORDER', confidence: 0.9, extracted: msg };
  }
  // Antal + produkt
  if (/\d+\s*x\s*[a-z√¶√∏√•]/i.test(msg) || /\b(en|et|to|tre|fire|fem|1|2|3|4|5)\s+[a-z√¶√∏√•]{4,}/i.test(msg)) {
    return { category: 'ORDER', confidence: 0.85, extracted: msg };
  }
  // Kendte madretter
  if (/\b(pizza|burger|sandwich|pasta|salat|kebab|durum|falafel|sushi|karry|b√∏f|schnitzel)\b/i.test(msg)) {
    return { category: 'ORDER', confidence: 0.85, extracted: msg };
  }
  
  // === SP√òRGSM√ÖL ===
  if (/^(hvad|hvorn√•r|hvordan|hvor|kan i|har i|er der|koster|pris|menu)\b/i.test(msg) || msg.endsWith('?')) {
    return { category: 'QUESTION', confidence: 0.85, extracted: msg };
  }
  
  // === HILSENER ===
  if (/^(hej|hello|goddag|god morgen|god aften|hi|hey)[\s!.,]*$/i.test(msg)) {
    return { category: 'GREETING', confidence: 0.95, extracted: msg };
  }
  
  // === POSITIVE SVAR ===
  if (/^(tak|super|perfekt|fedt|fantastisk|dejligt|godt|fint nok)[\s!.,]*$/i.test(msg)) {
    return { category: 'POSITIVE', confidence: 0.9, extracted: msg };
  }
  
  // Ingen klar match - returner null for at lade AI h√•ndtere det
  return null;
}

// =====================================================
// KONTEKST-SPECIFIK PROMPT BUILDER
// =====================================================
function buildContextualPrompt(context, expectedCategories) {
  const baseCategories = expectedCategories || ['YES', 'NO', 'NAME', 'ADDRESS', 'ORDER', 'PICKUP', 'DELIVERY', 'QUESTION', 'POSITIVE', 'OTHER'];
  
  const categoryDescriptions = {
    'YES': 'Bekr√¶ftelse (ja, okay, korrekt, rigtigt, det passer, fint, gerne)',
    'NO': 'Afvisning/√¶ndring (nej, ikke, forkert, √¶ndre, vil ikke)',
    'NAME': 'Kundens navn (fornavn, efternavn, kaldenavn)',
    'ADDRESS': 'Leveringsadresse (vejnavn, husnummer, postnummer, by)',
    'ORDER': 'Bestilling af mad (produktnavne, numre, antal)',
    'PICKUP': 'Vil afhente selv (afhentning, hente, kommer selv)',
    'DELIVERY': 'Vil have levering (levering, bring, udbring)',
    'QUESTION': 'Stiller sp√∏rgsm√•l (hvad, hvorn√•r, hvordan, kan I)',
    'POSITIVE': 'Positiv respons uden bekr√¶ftelse (tak, super, fedt)',
    'OTHER': 'Uklart eller andet'
  };
  
  const relevantCategories = baseCategories.map(cat => `- ${cat}: ${categoryDescriptions[cat] || cat}`).join('\n');
  
  return `Du er en pr√¶cis SMS-klassificerings-AI for en dansk restaurant.

OPGAVE: Klassificer kundens besked i PR√ÜCIS √©n kategori.

KONTEKST FOR DENNE BESKED:
${context || 'Generel kundehenvendelse'}

TILG√ÜNGELIGE KATEGORIER:
${relevantCategories}

REGLER:
1. V√¶lg den MEST specifikke kategori der passer
2. Ved tvivl mellem YES og NAME: hvis det er √©t ord uden tal, v√¶lg NAME
3. Ved tvivl mellem YES og POSITIVE: YES kun ved direkte bekr√¶ftelse p√• et sp√∏rgsm√•l
4. Udtr√¶k ALTID relevant information i "extracted" feltet
5. S√¶t confidence baseret p√• hvor sikker du er (0.0-1.0)

OUTPUT FORMAT (KUN JSON, ingen anden tekst):
{
  "category": "KATEGORI",
  "extracted": "relevant udtrukket info",
  "confidence": 0.0-1.0,
  "reasoning": "kort forklaring p√• dansk"
}`;
}

// =====================================================
// FORBEDRET FALLBACK KLASSIFICERING
// =====================================================
function classifyWithFallback(message, context = '') {
  const msg = message.toLowerCase().trim();
  const contextLower = (context || '').toLowerCase();
  
  // Pr√∏v hurtig klassificering f√∏rst
  const quickResult = quickClassify(msg, context);
  if (quickResult) {
    return quickResult;
  }
  
  // Udvidet fallback logik
  
  // Ja/bekr√¶ftelse med variationer
  if (/\b(ja|jep|yes|okay|ok|jo|gerne|selvf√∏lgelig|korrekt|rigtigt|fint|accepter|godkend)\b/i.test(msg)) {
    if (!msg.includes('nej') && !msg.includes('ikke')) {
      return { category: 'YES', confidence: 0.75, extracted: msg };
    }
  }
  
  // Nej/afvisning
  if (/\b(nej|no|ikke|afbestil|annuller|forkert|√¶ndre)\b/i.test(msg)) {
    return { category: 'NO', confidence: 0.75, extracted: msg };
  }
  
  // Navn pattern (enkelt eller dobbelt ord med kun bogstaver)
  if (contextLower.includes('navn')) {
    if (/^[a-z√¶√∏√•A-Z√Ü√ò√Ö\-'\s]{2,40}$/.test(msg) && !/\d/.test(msg)) {
      return { category: 'NAME', confidence: 0.7, extracted: capitalizeWords(msg) };
    }
  }
  
  // Adresse pattern
  if (contextLower.includes('adresse') || /\d{4}/.test(msg) || /\d+\s*[a-z]/i.test(msg)) {
    return { category: 'ADDRESS', confidence: 0.7, extracted: msg };
  }
  
  // Ordre pattern
  if (/\d/.test(msg) && /[a-z√¶√∏√•]{3,}/i.test(msg)) {
    return { category: 'ORDER', confidence: 0.6, extracted: msg };
  }
  
  // Sp√∏rgsm√•l
  if (msg.includes('?') || /^(hvad|hvorn√•r|hvordan|hvor|kan|har)\b/i.test(msg)) {
    return { 
      category: 'QUESTION', 
      confidence: 0.7, 
      extracted: msg,
      fallbackResponse: 'Tak for din besked! Jeg sender den videre til restauranten.'
    };
  }
  
  // Default: OTHER med fallback respons
  return { 
    category: 'OTHER', 
    confidence: 0.5, 
    extracted: msg,
    fallbackResponse: 'Tak for din besked. Kan du uddybe hvad du mener?'
  };
}

// Hj√¶lpefunktion til at kapitalisere ord
function capitalizeWords(str) {
  return str.split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');
}

// Generate AI response (med √•bningstider context)
async function generateAIResponse(customerMessage, context, restaurant) {
  if (!CONFIG.OPENAI_API_KEY || CONFIG.OPENAI_API_KEY.includes('YOUR_')) {
    return generateSmartFallbackResponse(customerMessage, context, restaurant);
  }
  
  // Hent restaurant navn (h√•ndter b√•de string og objekt)
  const restaurantName = typeof restaurant === 'string' ? restaurant : restaurant?.name || 'Restauranten';
  
  // Byg √•bningstider context hvis restaurant objekt
  let openingHoursInfo = '';
  if (typeof restaurant === 'object' && restaurant.openingHours) {
    openingHoursInfo = `\n\n√ÖBNINGSTIDER:\n${formatOpeningHoursText(restaurant)}`;
  }
  
  // Byg menu context
  let menuInfo = '';
  if (typeof restaurant === 'object' && restaurant.menuUrl) {
    menuInfo = `\n\nMENU: ${restaurant.menuUrl}`;
  }
  
  addLog('ü§ñ AI genererer svar...', 'ai');
  
  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          {
            role: 'system',
            content: `Du er en venlig og professionel SMS-assistent for restauranten "${restaurantName}".

DINE OPGAVER:
1. Hj√¶lp kunder med at bestille mad
2. Svar p√• sp√∏rgsm√•l om menu, priser, √•bningstider
3. Vejled kunden gennem bestillingsprocessen

REGLER:
- Svar ALTID p√• dansk
- Hold svaret KORT (max 160 tegn for SMS)
- V√¶r venlig men professionel
- Brug max 1-2 emojis
- Hvis du ikke ved noget, bed kunden kontakte restauranten direkte
${openingHoursInfo}${menuInfo}

VIGTIGT: 
- Sp√∏rg ALDRIG om det samme to gange
- Hvis kunden har givet information, bekr√¶ft den og g√• videre
- Ved tvivl, stil ETT pr√¶cist opf√∏lgende sp√∏rgsm√•l`
          },
          {
            role: 'user',
            content: `SAMTALEKONTEKST: ${context}\n\nKUNDENS BESKED: "${customerMessage}"\n\nGenerer et passende svar (max 160 tegn):`
          }
        ],
        max_tokens: 100,
        temperature: 0.5  // Lavere for mere konsistente svar
      })
    });
    
    const data = await response.json();
    const aiResponse = data.choices?.[0]?.message?.content?.trim();
    
    if (!aiResponse) {
      return generateSmartFallbackResponse(customerMessage, context, restaurant);
    }
    
    addLog(`üí° AI svar: "${aiResponse.substring(0, 50)}..."`, 'ai');
    return aiResponse;
  } catch (err) {
    console.error('AI response error:', err);
    return generateSmartFallbackResponse(customerMessage, context, restaurant);
  }
}

// Smart fallback n√•r AI ikke er tilg√¶ngelig
function generateSmartFallbackResponse(message, context, restaurant) {
  const msg = message.toLowerCase();
  const restaurantName = typeof restaurant === 'string' ? restaurant : restaurant?.name || 'os';
  
  // √Öbningstider sp√∏rgsm√•l
  if (/√•ben|lukket|hvorn√•r|tider/i.test(msg)) {
    if (typeof restaurant === 'object' && restaurant.openingHours) {
      const today = new Date().getDay();
      const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
      const hours = restaurant.openingHours[dayNames[today]];
      if (hours?.enabled) {
        return `Vi har √•bent i dag fra ${hours.open} til ${hours.close} üïê`;
      }
      return 'Vi har desv√¶rre lukket i dag. Se vores √•bningstider p√• hjemmesiden.';
    }
    return 'Kontakt os for √•bningstider.';
  }
  
  // Menu/priser sp√∏rgsm√•l
  if (/menu|pris|koster|hvad har i/i.test(msg)) {
    const menuUrl = restaurant?.menuUrl || restaurant?.website;
    if (menuUrl) {
      return `Se vores menu her: ${menuUrl} üçï`;
    }
    return 'Kontakt os for menu og priser.';
  }
  
  // Hilsen
  if (/^(hej|hello|goddag|hi|hey)/i.test(msg)) {
    return `Hej! Velkommen til ${restaurantName}. Hvad kan jeg hj√¶lpe med? üòä`;
  }
  
  // Tak
  if (/^tak|takker|mange tak/i.test(msg)) {
    return 'Selv tak! God appetit üçΩÔ∏è';
  }
  
  // Default
  return 'Tak for din besked! Kan du uddybe hvad du √∏nsker hj√¶lp med?';
}

// Pending AI response storage
let pendingAiResponse = null;
let pendingMsgId = null;

function approveAiResponse(msgId) {
  if (pendingAiResponse && pendingMsgId === msgId) {
    const phone = document.getElementById('test-phone').value;
    sendSMSNow(phone, pendingAiResponse);
    document.getElementById(msgId + '-approval').remove();
    addLog('‚úÖ AI svar godkendt og sendt', 'success');
    pendingAiResponse = null;
    pendingMsgId = null;
  }
}

function editAiResponse(msgId) {
  if (pendingAiResponse) {
    const newText = prompt('Rediger svaret:', pendingAiResponse);
    if (newText) {
      pendingAiResponse = newText;
      const msgEl = document.getElementById(msgId);
      if (msgEl) {
        msgEl.querySelector('.msg-approval').previousSibling.textContent = newText;
      }
    }
  }
}

function rejectAiResponse(msgId) {
  document.getElementById(msgId)?.remove();
  addLog('‚ùå AI svar afvist', 'warn');
  pendingAiResponse = null;
  pendingMsgId = null;
}

// Send SMS immediately
async function sendSMSNow(to, message) {
  const normalized = normalizePhoneNumber(to);
  let phoneNumber = normalized.e164;
  if (!phoneNumber) {
    addLog('‚ùå Ugyldigt telefonnummer', 'error');
    return;
  }

  // Use our InMobile SMS function
  try {
    await sendSMS(phoneNumber, message);
    addMessage(message, 'out');
    addLog(`‚úÖ SMS sendt!`, 'success');
  } catch (err) {
    addLog(`‚ùå Fejl: ${err.message}`, 'error');
  }
}

// Classify receipt intent (JA/NEJ)
function classifyReceiptIntent(reply) {
  if (!reply) return false;
  const lower = reply.toLowerCase().trim();
  
  // Positive patterns
  const yesPatterns = /^(ja|jep|yes|gerne|selvf√∏lgelig|ok|okay|jo|yep|jaa|ja tak|please|pls)[!.,\s]*$/i;
  if (yesPatterns.test(lower)) return true;
  if (lower.includes('ja ') || lower.includes('ja,') || lower.includes('ja!')) return true;
  if (lower.includes('gerne') || lower.includes('kvittering')) return true;
  
  // Negative patterns
  const noPatterns = /^(nej|no|nope|ikke|nej tak|nah)[!.,\s]*$/i;
  if (noPatterns.test(lower)) return false;
  if (lower.includes('nej') || lower.includes('ikke')) return false;
  
  // Default to no if unclear
  return false;
}

// =====================================================
// AI FALLBACK & LEARNING SYSTEM
// =====================================================

// Learning log storage (in-memory + localStorage persistence)
let aiLearningLog = JSON.parse(localStorage.getItem('ai_learning_log') || '[]');

// Special intent handlers - actions the AI can trigger
const SPECIAL_INTENTS = {
  RECEIPT: {
    keywords: ['kvittering', 'receipt', 'bon', 'regning', 'faktura'],
    action: 'SEND_RECEIPT',
    response: 'Selvf√∏lgelig! Jeg sender din kvittering med det samme. Tjek din SMS om et √∏jeblik üìÑ'
  },
  ORDER_STATUS: {
    keywords: ['status', 'hvor langt', 'hvorn√•r klar', 'hvor l√¶nge', 'estimat'],
    action: 'CHECK_STATUS',
    response: 'Jeg tjekker status p√• din ordre... Et √∏jeblik! ‚è±Ô∏è'
  },
  MENU: {
    keywords: ['menukort', 'menu', 'hvad har i', 'priser', 'tilbud'],
    action: 'SEND_MENU',
    response: 'Her er vores menu: {menuUrl} - Skriv gerne hvad du kunne t√¶nke dig! üçï'
  },
  CANCEL: {
    keywords: ['annuller', 'afbestil', 'fortryd', 'cancel'],
    action: 'ESCALATE_CANCEL',
    response: 'Jeg forst√•r. Jeg sender din foresp√∏rgsel videre til personalet, som kontakter dig hurtigst muligt üìû'
  },
  COMPLAINT: {
    keywords: ['klage', 'd√•rlig', 'forkert', 'mangel', 'fejl', 'skuffet', 'utilfreds'],
    action: 'ESCALATE_COMPLAINT',
    response: 'Det er jeg ked af at h√∏re. Jeg eskalerer dette til vores personale, som kontakter dig snarest for at l√∏se problemet üôè'
  },
  ALLERGEN: {
    keywords: ['allergi', 'glutenfri', 'laktosefri', 'vegetar', 'vegan', 'n√∏dder', 'intolerans'],
    action: 'ESCALATE_ALLERGEN',
    response: 'Godt sp√∏rgsm√•l om allergener! Jeg sender din foresp√∏rgsel til k√∏kkenet, som svarer dig direkte med pr√¶cise oplysninger ü•ó'
  },
  OPENING_HOURS: {
    keywords: ['√•bningstid', 'lukket', '√•ben', 'hvorn√•r √•bner', 'hvorn√•r lukker'],
    action: 'SEND_HOURS',
    response: null // Dynamic - uses restaurant opening hours
  },
  HELP: {
    keywords: ['hj√¶lp', 'help', 'hvordan', 'problem', 'virker ikke'],
    action: 'SEND_HELP',
    response: 'Jeg hj√¶lper gerne! Du kan:\nüì± Bestille mad ved at skrive din ordre\nüìÑ Bede om kvittering\n‚ùå Annullere ved at skrive "annuller"\n\nEller kontakt os direkte!'
  }
};

// Detect special intent from message
function detectSpecialIntent(message) {
  const lower = message.toLowerCase();
  
  for (const [intentName, config] of Object.entries(SPECIAL_INTENTS)) {
    for (const keyword of config.keywords) {
      if (lower.includes(keyword)) {
        return { intent: intentName, ...config };
      }
    }
  }
  return null;
}

// Log message for AI learning
function logForLearning(message, context, classification, wasHandled, sentiment = 'neutral') {
  const logEntry = {
    id: Date.now(),
    timestamp: new Date().toISOString(),
    message: message,
    context: context,
    classification: classification,
    wasHandled: wasHandled,
    sentiment: sentiment,
    needsReview: !wasHandled || classification?.confidence < 0.7
  };
  
  aiLearningLog.push(logEntry);
  
  // Keep only last 500 entries
  if (aiLearningLog.length > 500) {
    aiLearningLog = aiLearningLog.slice(-500);
  }
  
  // Persist to localStorage
  localStorage.setItem('ai_learning_log', JSON.stringify(aiLearningLog));
  
  addLog(`üìö Logget til AI tr√¶ning: ${classification?.category || 'UNKNOWN'}`, 'info');
  
  return logEntry;
}

// Analyze sentiment of customer message
function analyzeSentiment(message) {
  const lower = message.toLowerCase();
  
  const positiveWords = ['tak', 'super', 'perfekt', 'dejligt', 'godt', 'fantastisk', 'l√¶kkert', 'fedt', 'nice', 'awesome', 'great'];
  const negativeWords = ['d√•rligt', 'skuffet', '√¶rgerligt', 'forkert', 'klage', 'utilfreds', 'langsomt', 'koldt', 'fejl', 'problem'];
  
  let positiveScore = 0;
  let negativeScore = 0;
  
  positiveWords.forEach(word => { if (lower.includes(word)) positiveScore++; });
  negativeWords.forEach(word => { if (lower.includes(word)) negativeScore++; });
  
  if (positiveScore > negativeScore) return 'positive';
  if (negativeScore > positiveScore) return 'negative';
  return 'neutral';
}

// AI Fallback Handler - handles messages that don't match workflow
async function handleAIFallback(message, restaurant, conversationContext = '') {
  addLog('üß† AI Fallback aktiveret - analyserer besked...', 'ai');
  
  // 1. Check for special intents first (kvittering, status, etc.)
  const specialIntent = detectSpecialIntent(message);
  if (specialIntent) {
    addLog(`üéØ Special intent detekteret: ${specialIntent.intent}`, 'ai');
    
    // Log for learning
    logForLearning(message, conversationContext, { category: specialIntent.intent, confidence: 0.95 }, true);
    
    // Execute action if defined
    await executeIntentAction(specialIntent, restaurant);
    
    // Return response (with dynamic substitution)
    let response = specialIntent.response;
    if (response && restaurant) {
      response = response.replace('{menuUrl}', restaurant.menuUrl || restaurant.website || '');
      response = response.replace('{restaurantName}', restaurant.name || '');
    }
    
    // Special case: Opening hours
    if (specialIntent.action === 'SEND_HOURS' && restaurant?.openingHours) {
      response = generateOpeningHoursResponse(restaurant);
    }
    
    return {
      handled: true,
      intent: specialIntent.intent,
      response: response,
      action: specialIntent.action
    };
  }
  
  // 2. Use AI classification for unknown messages
  const classification = await classifyWithAI(message, conversationContext);
  const sentiment = analyzeSentiment(message);
  
  // 3. Log for learning (mark as needing review if low confidence)
  const wasHandled = classification.confidence >= 0.7;
  logForLearning(message, conversationContext, classification, wasHandled, sentiment);
  
  // 4. Generate AI response if needed
  let aiResponse = null;
  if (classification.category === 'QUESTION' || classification.category === 'OTHER') {
    aiResponse = await generateAIFallbackResponse(message, restaurant, conversationContext);
  }
  
  // 5. Determine if escalation is needed
  const needsEscalation = sentiment === 'negative' || classification.confidence < 0.5;
  
  return {
    handled: wasHandled,
    intent: classification.category,
    classification: classification,
    sentiment: sentiment,
    response: aiResponse || classification.fallbackResponse,
    needsEscalation: needsEscalation,
    action: needsEscalation ? 'ESCALATE_STAFF' : null
  };
}

// Execute intent action (send receipt, check status, etc.)
async function executeIntentAction(intent, restaurant) {
  switch(intent.action) {
    case 'SEND_RECEIPT':
      addLog('üìÑ Trigger: Sender kvittering...', 'success');
      // In production: trigger receipt generation and send
      triggerStaffNotification(restaurant, 'Kunde anmoder om kvittering');
      break;
      
    case 'CHECK_STATUS':
      addLog('‚è±Ô∏è Trigger: Tjekker ordrestatus...', 'info');
      // In production: fetch order status from database
      break;
      
    case 'SEND_MENU':
      addLog('üìã Trigger: Sender menukort...', 'info');
      break;
      
    case 'ESCALATE_CANCEL':
    case 'ESCALATE_COMPLAINT':
    case 'ESCALATE_ALLERGEN':
    case 'ESCALATE_STAFF':
      addLog('üö® Trigger: Eskalerer til personale...', 'warn');
      triggerStaffNotification(restaurant, `Kundehenvendelse kr√¶ver opm√¶rksomhed: ${intent.intent}`);
      break;
      
    case 'SEND_HOURS':
      addLog('üïê Trigger: Sender √•bningstider...', 'info');
      break;
      
    case 'SEND_HELP':
      addLog('‚ùì Trigger: Sender hj√¶lp-info...', 'info');
      break;
  }
}

// Trigger notification to staff (placeholder for real implementation)
function triggerStaffNotification(restaurant, message) {
  const notification = {
    id: Date.now(),
    timestamp: new Date().toISOString(),
    restaurant: restaurant?.name || 'Ukendt',
    restaurantId: restaurant?.id,
    message: message,
    status: 'pending'
  };
  
  // Store in localStorage for now (would be database in production)
  const notifications = JSON.parse(localStorage.getItem('staff_notifications') || '[]');
  notifications.push(notification);
  localStorage.setItem('staff_notifications', JSON.stringify(notifications));
  
  addLog(`Staff notification: ${message}`, 'warn');
}

// Generate AI fallback response for unhandled messages
async function generateAIFallbackResponse(message, restaurant, context) {
  if (!CONFIG.OPENAI_API_KEY || CONFIG.OPENAI_API_KEY.includes('YOUR_')) {
    return 'Beklager, jeg forstod ikke helt din besked. Kan du pr√∏ve at omformulere, eller kontakt os direkte? üìû';
  }
  
  const restaurantName = restaurant?.name || 'restauranten';
  let openingHoursInfo = '';
  if (restaurant?.openingHours) {
    openingHoursInfo = `\n\n√Öbningstider:\n${formatOpeningHoursText(restaurant)}`;
  }
  
  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          {
            role: 'system',
            content: `Du er en venlig SMS-assistent for "${restaurantName}".
Du h√•ndterer beskeder som ikke passer ind i det normale bestillingsflow.

VIGTIGE REGLER:
- Svar kort og venligt p√• dansk (max 160 tegn)
- Hvis du ikke kan hj√¶lpe, eskaler venligt til personalet
- Brug max 1-2 emojis
- V√¶r professionel men varm
- Hvis kunden virker utilfreds, anerkend det og tilbyd hj√¶lp
${openingHoursInfo}

Almindelige foresp√∏rgsler du kan hj√¶lpe med:
- Kvittering: Bed dem vente mens du henter den
- Ordrestatus: Bed dem vente mens du tjekker
- √Öbningstider: Giv dem de korrekte tider
- Alt andet: Tilbyd at eskalere til personale`
          },
          {
            role: 'user',
            content: `Kontekst: ${context}\n\nKundens besked: "${message}"\n\nGenerer et passende svar:`
          }
        ],
        max_tokens: 100,
        temperature: 0.6
      })
    });
    
    const data = await response.json();
    return data.choices[0]?.message?.content?.trim() || null;
  } catch (err) {
    console.error('AI Fallback error:', err);
    return null;
  }
}

// Generate opening hours response
function generateOpeningHoursResponse(restaurant) {
  if (!restaurant?.openingHours) {
    return 'Kontakt os for at h√∏re vores √•bningstider üìû';
  }
  
  const dayNames = {
    monday: 'Mandag', tuesday: 'Tirsdag', wednesday: 'Onsdag',
    thursday: 'Torsdag', friday: 'Fredag', saturday: 'L√∏rdag', sunday: 'S√∏ndag'
  };
  
  const today = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'][new Date().getDay()];
  const todayHours = restaurant.openingHours[today];
  
  if (todayHours?.enabled) {
    return `Vi har √•bent i dag (${dayNames[today]}) fra ${todayHours.open} til ${todayHours.close} üïê`;
  } else {
    // Find next open day
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const todayIndex = days.indexOf(today);
    for (let i = 1; i <= 7; i++) {
      const nextDay = days[(todayIndex + i) % 7];
      const nextHours = restaurant.openingHours[nextDay];
      if (nextHours?.enabled) {
        return `Vi har desv√¶rre lukket i dag. Vi √•bner igen ${dayNames[nextDay]} kl. ${nextHours.open} üïê`;
      }
    }
    return 'Kontakt os for at h√∏re vores √•bningstider üìû';
  }
}

// Get learning log for dashboard display
function getAILearningStats() {
  const total = aiLearningLog.length;
  const needsReview = aiLearningLog.filter(e => e.needsReview).length;
  const handled = aiLearningLog.filter(e => e.wasHandled).length;
  const sentimentBreakdown = {
    positive: aiLearningLog.filter(e => e.sentiment === 'positive').length,
    neutral: aiLearningLog.filter(e => e.sentiment === 'neutral').length,
    negative: aiLearningLog.filter(e => e.sentiment === 'negative').length
  };
  
  // Category breakdown
  const categories = {};
  aiLearningLog.forEach(e => {
    const cat = e.classification?.category || 'UNKNOWN';
    categories[cat] = (categories[cat] || 0) + 1;
  });
  
  return {
    total,
    needsReview,
    handled,
    handledRate: total > 0 ? Math.round((handled / total) * 100) : 0,
    sentimentBreakdown,
    categories,
    recentUnhandled: aiLearningLog.filter(e => e.needsReview).slice(-10).reverse()
  };
}

// Export learning data for training
function exportLearningData() {
  const data = {
    exportedAt: new Date().toISOString(),
    totalEntries: aiLearningLog.length,
    entries: aiLearningLog
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `ai-learning-data-${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  addLog('üì• AI tr√¶ningsdata eksporteret', 'success');
}

// Clear learning log
function clearLearningLog() {
  if (confirm('Er du sikker p√• du vil slette alle AI tr√¶ningsdata?')) {
    aiLearningLog = [];
    localStorage.removeItem('ai_learning_log');
    addLog('üóëÔ∏è AI tr√¶ningsdata slettet', 'warn');
  }
}

async function waitForReply() {
  document.getElementById('waiting').style.display = 'block';
  addLog('‚è≥ Venter p√• kundens svar...', 'info');

  return new Promise(async (resolve) => {
    // Gem reference til denne specifikke resolve
    const thisResolve = resolve;
    replyResolver = resolve;

    // I Live Mode: Poll Supabase for indg√•ende SMS
    let pollInterval = null;
    let lastMessageTimestamp = null;  // FIXED: Brug timestamp i stedet for ID
    let timeoutId = null;
    let warningTimeout = null;
    let isResolved = false;
    let mismatchLogged = false;

    // Cleanup funktion for at sikre alle ressourcer frigives
    const cleanup = () => {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
      if (timeoutId) {
        clearTimeout(timeoutId);
        timeoutId = null;
      }
      if (warningTimeout) {
        clearTimeout(warningTimeout);
        warningTimeout = null;
      }
      document.getElementById('waiting').style.display = 'none';
    };

    // Safe resolve funktion
    const safeResolve = (value) => {
      if (isResolved) return;
      isResolved = true;
      cleanup();
      if (replyResolver === thisResolve) {
        replyResolver = null;
      }
      // Clear global resolver
      window.resolveWorkflowReply = null;
      resolve(value);
    };

    // KRITISK: S√¶t global resolver s√• RealtimeSync kan resolve
    window.resolveWorkflowReply = (content) => {
      if (!isResolved) {
        addLog(`üì® Indg√•ende SMS (realtime): "${content}"`, 'success');
        safeResolve(content);
      }
    };

    if (liveMode) {
      const phone = document.getElementById('test-phone').value;
      const formattedPhone = normalizePhoneNumber(phone).e164;
      if (!formattedPhone) {
        addLog('‚ùå Ugyldigt telefonnummer - kan ikke lytte efter svar', 'error');
        safeResolve(null);
        return;
      }

      addLog(`üîé Live match: raw="${phone}" normalized="${formattedPhone}"`, 'info');

      // Gem tidspunkt for workflow start - vi accepterer alle beskeder efter dette tidspunkt
      const workflowStartTime = new Date().toISOString();
      // Track set af allerede sete besked-IDs
      const seenMessageIds = new Set();

      // Hent eksisterende beskeder og marker dem som "set"
      try {
        const initResponse = await fetch(
          `${CONFIG.SUPABASE_URL}/rest/v1/messages?direction=eq.inbound&order=id.desc&limit=20`,
          {
            headers: {
              'apikey': CONFIG.SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
            }
          }
        );
        if (initResponse.ok) {
          const initMsgs = await initResponse.json();
          initMsgs.forEach(m => seenMessageIds.add(m.id));
          console.log('üìã Marked', seenMessageIds.size, 'existing messages as seen');
        }
      } catch (e) {
        console.warn('Could not fetch initial messages:', e);
      }

      addLog(`üì° Lytter efter svar fra ${formattedPhone}...`, 'info');
      addLog(`‚è∞ Accepterer nye beskeder efter: ${new Date(workflowStartTime).toLocaleTimeString()}`, 'info');

      pollInterval = setInterval(async () => {
        // Stop polling hvis allerede resolved eller workflow stoppet
        if (isResolved || !testRunning) {
          console.log('‚ö†Ô∏è Poll stopped - isResolved:', isResolved, 'testRunning:', testRunning);
          cleanup();
          return;
        }

        try {
          // Hent seneste inbound beskeder - sort√©r efter id (nyeste f√∏rst)
          const response = await fetch(
            `${CONFIG.SUPABASE_URL}/rest/v1/messages?direction=eq.inbound&order=id.desc&limit=20`,
            {
              headers: {
                'apikey': CONFIG.SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
              }
            }
          );

          if (!response.ok) {
            console.error('‚ùå Poll API error:', response.status, response.statusText);
            return;
          }

          const messages = await response.json();

          // Find NYE beskeder (ikke set f√∏r)
          const newMessages = messages.filter(m => !seenMessageIds.has(m.id));

          if (newMessages.length > 0) {
            console.log('üì• Found', newMessages.length, 'NEW messages:', newMessages.map(m => ({
              id: m.id,
              phone: m.phone,
              content: m.content?.substring(0, 30)
            })));

            // Find en ny besked der matcher telefonnummeret
            const matched = newMessages.find((msg) => {
              const msgPhone = normalizePhoneNumber(msg.phone).e164;
              const isMatch = msgPhone === formattedPhone;
              console.log(`üîç Phone compare: "${msgPhone}" vs "${formattedPhone}" = ${isMatch}`);
              return isMatch;
            });

            if (matched) {
              // Marker som set
              seenMessageIds.add(matched.id);
              addLog(`üì® Indg√•ende SMS: "${matched.content}"`, 'success');
              console.log('‚úÖ Message accepted, resolving workflow. ID:', matched.id);
              safeResolve(matched.content);
              return;
            } else {
              // Marker alle nye beskeder som set (s√• vi ikke tjekker dem igen)
              newMessages.forEach(m => seenMessageIds.add(m.id));

              if (!mismatchLogged) {
                mismatchLogged = true;
                const otherPhones = newMessages.map(m => m.phone).join(', ');
                addLog(`‚ö†Ô∏è Ny SMS fra andet nummer: ${otherPhones}`, 'warn');
              }
            }
          }
        } catch (err) {
          console.error('‚ùå Poll error:', err);
        }
      }, 1500); // Poll hver 1.5 sekund for hurtigere respons

      // FIXED: Advarsel efter 60 sekunder
      warningTimeout = setTimeout(() => {
        if (!isResolved) {
          addLog('‚è∞ Venter stadig p√• svar... (60s)', 'warn');
        }
      }, 60000);
    }

    // Timeout efter 2 minutter
    timeoutId = setTimeout(() => {
      if (!isResolved) {
        addLog('‚è∞ Timeout efter 2 minutter - ingen svar modtaget', 'warn');
        safeResolve(null);
      }
    }, 120000);
  });
}

// Debug funktion: Tjek alle indg√•ende beskeder i databasen
async function debugCheckMessages() {
  try {
    addLog('üîç Tjekker database for indg√•ende beskeder...', 'info');

    const response = await fetch(
      `${CONFIG.SUPABASE_URL}/rest/v1/messages?direction=eq.inbound&order=id.desc&limit=10`,
      {
        headers: {
          'apikey': CONFIG.SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
        }
      }
    );

    if (!response.ok) {
      addLog(`‚ùå Database fejl: ${response.status}`, 'error');
      return;
    }

    const messages = await response.json();

    if (messages.length === 0) {
      addLog('‚ö†Ô∏è Ingen indg√•ende beskeder fundet i databasen', 'warn');
      addLog('üí° InMobile webhook sender muligvis ikke til korrekt URL', 'info');
    } else {
      addLog(`‚úÖ Fandt ${messages.length} indg√•ende beskeder:`, 'success');
      messages.slice(0, 5).forEach((m, i) => {
        const time = new Date(m.created_at).toLocaleTimeString('da-DK');
        addLog(`  ${i+1}. ${m.phone}: "${m.content?.substring(0, 30)}" (${time})`, 'info');
      });
    }

    console.log('üìã Full message data:', messages);
    return messages;
  } catch (err) {
    addLog(`‚ùå Fejl ved database-tjek: ${err.message}`, 'error');
    console.error('Debug check error:', err);
  }
}

// G√∏r funktionen tilg√¶ngelig globalt for debugging
window.debugCheckMessages = debugCheckMessages;

async function handleIncomingReply(text) {
  // Show incoming message
  addMessage(text, 'in');
  addLog(`üì® Kunde: "${text}"`, 'success');
  
  // Get restaurant context
  const restaurantId = document.getElementById('test-restaurant').value;
  const restaurant = restaurants.find(r => r.id === restaurantId);
  
  // First, try AI Fallback for special intents (kvittering, status, etc.)
  const fallbackResult = await handleAIFallback(text, restaurant, currentConversationContext);
  
  if (fallbackResult.handled && fallbackResult.response) {
    // Special intent detected and handled
    addLog(`‚úÖ AI Fallback h√•ndteret: ${fallbackResult.intent}`, 'success');
    
    if (fallbackResult.action) {
      addLog(`üîß Action triggered: ${fallbackResult.action}`, 'info');
    }
    
    // Show response with approval if needed
    if (fallbackResult.needsEscalation) {
      pendingMsgId = addMessage(fallbackResult.response, 'out', true);
      pendingAiResponse = fallbackResult.response;
    } else {
      // Auto-send for high-confidence special intents
      addMessage(fallbackResult.response, 'out');
      if (liveMode) {
        const phone = document.getElementById('test-phone').value;
        sendSMSNow(phone, fallbackResult.response);
      }
    }
    
    // Update context
    currentConversationContext += `\nKunde: ${text} [AI Fallback: ${fallbackResult.intent}]`;
    
    return { text, classification: fallbackResult.classification || { category: fallbackResult.intent }, fallback: true };
  }
  
  // Standard classification if not handled by fallback
  const classification = await classifyWithAI(text, currentConversationContext);
  
  // Generate AI response suggestion
  const aiSuggestion = await generateAIResponse(text, currentConversationContext, restaurant?.name || 'Restauranten');
  
  if (aiSuggestion) {
    // Show AI suggestion with approval buttons
    pendingMsgId = addMessage(aiSuggestion, 'out', true);
    pendingAiResponse = aiSuggestion;
  }
  
  // Update context
  currentConversationContext += `\nKunde: ${text}`;
  if (classification.extracted) {
    currentConversationContext += ` [${classification.category}: ${classification.extracted}]`;
  }
  
  return { text, classification };
}

let currentConversationContext = '';

function sendReply() {
  const input = document.getElementById('reply-input');
  const text = input.value.trim();
  if (!text) return;
  
  input.value = '';
  
  // If we have a resolver waiting, use it (simulation mode)
  if (replyResolver) {
    addMessage(text, 'in');
    addLog(`üì® Svar modtaget: "${text}"`, 'success');
    document.getElementById('waiting').style.display = 'none';
    replyResolver(text);
    replyResolver = null;
  } else {
    // Live mode - handle as incoming
    handleIncomingReply(text);
  }
}

function quickReply(text) {
  document.getElementById('reply-input').value = text;
  sendReply();
}

function addLog(msg, type = 'info') {
  const time = new Date().toLocaleTimeString('da-DK');
  
  // Fjern emojis fra besked til ren tekst visning
  const cleanMsg = msg.replace(/[\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '').trim();
  
  // Add to detailed log (log tab) only
  addDetailedLog(cleanMsg, type, time);
}

// Tab switching - 3 tabs: chat, messages, log
function switchTestTab(tab) {
  // Update tab buttons
  document.getElementById('tab-chat')?.classList.toggle('active', tab === 'chat');
  document.getElementById('tab-messages')?.classList.toggle('active', tab === 'messages');
  document.getElementById('tab-log')?.classList.toggle('active', tab === 'log');
  
  // Update tab content
  document.getElementById('content-chat')?.classList.toggle('active', tab === 'chat');
  document.getElementById('content-messages')?.classList.toggle('active', tab === 'messages');
  document.getElementById('content-log')?.classList.toggle('active', tab === 'log');
}

// Detailed log functions
function addDetailedLog(msg, type = 'info', time) {
  const container = document.getElementById('detailed-log');
  if (!container) return;
  
  // Clear placeholder if first log
  if (container.querySelector('.log-empty-state')) {
    container.innerHTML = '';
  }
  
  const typeLabels = {
    info: 'INFO',
    success: 'SUCCESS',
    warn: 'WARNING',
    error: 'ERROR',
    ai: 'AI',
    sms: 'SMS'
  };
  
  const entry = document.createElement('div');
  entry.className = `log-entry-detailed ${type}`;
  entry.innerHTML = `
    <span class="log-time">${time || new Date().toLocaleTimeString('da-DK')}</span>
    <span class="log-type">${typeLabels[type] || 'INFO'}</span>
    <span class="log-content">${msg}</span>
  `;
  
  container.appendChild(entry);
  container.scrollTop = container.scrollHeight;
}

function addDetailedLogWithPayload(msg, type, payload) {
  const container = document.getElementById('detailed-log');
  if (!container) return;
  
  const time = new Date().toLocaleTimeString('da-DK');
  const typeLabels = {
    info: 'INFO',
    success: 'SUCCESS',
    warn: 'WARNING',
    error: 'ERROR',
    ai: 'AI',
    api: 'API'
  };
  
  const entry = document.createElement('div');
  entry.className = `log-entry-detailed ${type}`;
  entry.innerHTML = `
    <span class="log-time">${time}</span>
    <span class="log-type">${typeLabels[type] || 'INFO'}</span>
    <span class="log-content">${msg}</span>
    ${payload ? `<pre>${JSON.stringify(payload, null, 2)}</pre>` : ''}
  `;
  
  container.appendChild(entry);
  container.scrollTop = container.scrollHeight;
}

function clearDetailedLog() {
  const container = document.getElementById('detailed-log');
  if (container) {
    container.innerHTML = `
      <div class="log-empty-state">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        <div>Log ryddet</div>
        <div class="log-empty-sub">Start en ny test for at se logs</div>
      </div>
    `;
  }
}

function copyDetailedLog() {
  const container = document.getElementById('detailed-log');
  if (container) {
    const text = container.innerText;
    navigator.clipboard.writeText(text).catch(() => {
      toast('Kunne ikke kopiere log', 'error');
    });
  }
}

function sleep(ms) {
  return new Promise(r => setTimeout(r, ms));
}

// =====================================================
// SETTINGS
// =====================================================
function loadConfig() {
  // Brug CONFIG v√¶rdier som defaults hvis localStorage er tom

  // OpenAI
  const openaiKey = localStorage.getItem('openai_key') || CONFIG.OPENAI_API_KEY;
  if (openaiKey) {
    localStorage.setItem('openai_key', openaiKey);
  }

  updateApiStatus();
}

function saveSmsConfig() {
  const apiKey = document.getElementById('inmobile-api-key')?.value.trim();
  const sender = document.getElementById('inmobile-sender')?.value.trim();

  if (!apiKey) {
    toast('Indtast InMobile API Key', 'error');
    return;
  }

  if (!sender) {
    toast('Indtast afsender / shortcode', 'error');
    return;
  }

  localStorage.setItem('inmobile_api_key', apiKey);
  localStorage.setItem('inmobile_sender', sender);

  toast('SMS indstillinger gemt', 'success');
  closeModal('sms-config');
  updateApiStatus();
}

function loadSmsConfig() {
  const apiKey = localStorage.getItem('inmobile_api_key');
  const sender = localStorage.getItem('inmobile_sender') || '';

  const apiKeyInput = document.getElementById('inmobile-api-key');
  const senderInput = document.getElementById('inmobile-sender');

  if (apiKeyInput && apiKey) apiKeyInput.value = apiKey;
  if (senderInput) senderInput.value = sender;
}

function saveOpenAIConfig() {
  const key = document.getElementById('openai-key').value.trim();
  if (key) localStorage.setItem('openai_key', key);
  closeModal('openai-config');
  updateApiStatus();
}

function saveOpenAIKey() {
  const input = document.getElementById('openai-api-key-input');
  const status = document.getElementById('openai-status');
  const key = input ? input.value.trim() : '';

  if (!key) {
    if (status) status.textContent = 'Indtast en API key';
    return;
  }

  if (!key.startsWith('sk-')) {
    if (status) status.textContent = 'Ugyldig key - skal starte med sk-';
    return;
  }

  localStorage.setItem('openai_key', key);
  if (status) {
    status.style.color = 'var(--success)';
    status.textContent = 'API key gemt!';
  }
  toast('OpenAI API key gemt', 'success');
  updateApiStatus();

  // Mask the input
  setTimeout(() => {
    input.value = key.substring(0, 7) + '...' + key.substring(key.length - 4);
    input.type = 'text';
  }, 1000);
}

function updateApiStatus() {
  const smsOk = localStorage.getItem('inmobile_api_key') && localStorage.getItem('inmobile_sender');
  const openaiOk = localStorage.getItem('openai_key') || CONFIG.OPENAI_API_KEY;
  const googleOk = localStorage.getItem('google_api_key');
  const trustpilotOk = localStorage.getItem('trustpilot_api_key');

  // Status elements
  const smsStatusEl = document.getElementById('status-sms');
  const openaiStatusEl = document.getElementById('status-openai');

  if (smsStatusEl) smsStatusEl.className = 'api-key-status ' + (smsOk ? 'ok' : 'missing');
  if (openaiStatusEl) openaiStatusEl.className = 'api-key-status ' + (openaiOk ? 'ok' : 'missing');

  // New indicator elements
  const indicators = {
    'openai-indicator': openaiOk,
    'sms-indicator': smsOk,
    'inmobile-indicator': smsOk,
    'google-indicator': googleOk,
    'trustpilot-indicator': trustpilotOk
  };

  Object.entries(indicators).forEach(([id, isConnected]) => {
    const el = document.getElementById(id);
    if (el) {
      el.className = 'api-status-indicator' + (isConnected ? ' connected' : '');
    }
  });

  // Update toggle button states and card disabled states
  updateApiToggles();
}

// Update toggle button states based on localStorage
function updateApiToggles() {
  const apis = ['openai', 'google', 'trustpilot', 'webhook'];

  apis.forEach(api => {
    const toggle = document.getElementById(`${api}-toggle`);
    const card = document.getElementById(`api-card-${api}`);
    const isEnabled = localStorage.getItem(`api_${api}_enabled`) !== 'false'; // Default to enabled

    if (toggle) {
      toggle.checked = isEnabled;
    }
    if (card) {
      card.classList.toggle('disabled', !isEnabled);
    }
  });
}

// Toggle API enabled/disabled state
function toggleApiEnabled(api) {
  const toggle = document.getElementById(`${api}-toggle`);
  const newState = toggle ? toggle.checked : false;

  localStorage.setItem(`api_${api}_enabled`, newState.toString());
  updateApiToggles();

  // Save to Supabase
  saveApiEnabledStates();
}

// Save API enabled states to Supabase
async function saveApiEnabledStates() {
  try {
    if (window.supabaseClient && currentUser?.id) {
      const enabledStates = {};
      ['openai', 'google', 'trustpilot', 'webhook'].forEach(api => {
        enabledStates[api] = localStorage.getItem(`api_${api}_enabled`) !== 'false';
      });

      await window.supabaseClient
        .from('user_settings')
        .upsert({
          user_id: currentUser.id,
          settings_type: 'api_enabled_states',
          settings_data: enabledStates,
          updated_at: new Date().toISOString()
        }, { onConflict: 'user_id,settings_type' });
    }
  } catch (err) {
    console.warn('‚ö†Ô∏è Could not save API enabled states:', err.message);
  }
}

// Load API enabled states from Supabase
async function loadApiEnabledStates() {
  try {
    if (window.supabaseClient && currentUser?.id) {
      const { data, error } = await window.supabaseClient
        .from('user_settings')
        .select('settings_data')
        .eq('user_id', currentUser.id)
        .eq('settings_type', 'api_enabled_states')
        .single();

      if (!error && data?.settings_data) {
        Object.entries(data.settings_data).forEach(([api, enabled]) => {
          localStorage.setItem(`api_${api}_enabled`, enabled.toString());
        });
      }
    }
  } catch (err) {
    console.warn('‚ö†Ô∏è Could not load API enabled states');
  }
  updateApiToggles();
}

// Get the active SMS provider

// Toggle API config fields visibility
function toggleApiConfig(api) {
  const fields = document.getElementById(`${api}-fields`);
  if (!fields) return;

  const isVisible = fields.style.display !== 'none';
  fields.style.display = isVisible ? 'none' : 'block';
}

// Save all API settings to Supabase
async function saveAllApiSettings() {
  const statusEl = document.getElementById('api-save-status');
  if (statusEl) statusEl.textContent = 'Gemmer...';

  // Collect all API settings
  const settings = {
    openai_key: document.getElementById('openai-api-key-input')?.value.trim() || '',
    inmobile_api_key: document.getElementById('inmobile-api-key')?.value.trim() || '',
    inmobile_sender: document.getElementById('inmobile-sender')?.value.trim() || '',
    google_place_id: document.getElementById('google-place-id')?.value.trim() || '',
    google_api_key: document.getElementById('google-api-key')?.value.trim() || '',
    trustpilot_business_id: document.getElementById('trustpilot-business-id')?.value.trim() || '',
    trustpilot_api_key: document.getElementById('trustpilot-api-key')?.value.trim() || ''
  };

  // Save to localStorage as backup
  Object.entries(settings).forEach(([key, value]) => {
    if (value) localStorage.setItem(key, value);
  });

  // Try to save to Supabase
  try {
    if (window.supabaseClient && currentUser?.id) {
      const { error } = await window.supabaseClient
        .from('user_settings')
        .upsert({
          user_id: currentUser.id,
          settings_type: 'api_keys',
          settings_data: settings,
          updated_at: new Date().toISOString()
        }, { onConflict: 'user_id,settings_type' });

      if (error) throw error;
      console.log('‚úÖ API settings saved to Supabase');
    }
  } catch (err) {
    console.warn('‚ö†Ô∏è Could not save to Supabase, using localStorage:', err.message);
  }

  if (statusEl) {
    statusEl.textContent = 'Gemt!';
    statusEl.style.color = '#22c55e';
    setTimeout(() => { statusEl.textContent = ''; }, 2000);
  }

  updateApiStatus();
}

// Load all API settings from Supabase or localStorage
async function loadAllApiSettings() {
  let settings = {};

  // Try to load from Supabase first
  try {
    if (window.supabaseClient && currentUser?.id) {
      const { data, error } = await window.supabaseClient
        .from('user_settings')
        .select('settings_data')
        .eq('user_id', currentUser.id)
        .eq('settings_type', 'api_keys')
        .single();

      if (!error && data?.settings_data) {
        settings = data.settings_data;
        console.log('‚úÖ API settings loaded from Supabase');
      }
    }
  } catch (err) {
    console.warn('‚ö†Ô∏è Could not load from Supabase, using localStorage');
  }

  // Merge with localStorage (localStorage takes precedence for non-empty values)
  const localKeys = ['openai_key', 'inmobile_api_key', 'inmobile_sender', 'google_place_id', 'google_api_key', 'trustpilot_business_id', 'trustpilot_api_key'];
  localKeys.forEach(key => {
    const localValue = localStorage.getItem(key);
    if (localValue) settings[key] = localValue;
  });

  // Populate form fields
  const fieldMappings = {
    'openai-api-key-input': 'openai_key',
    'inmobile-api-key': 'inmobile_api_key',
    'inmobile-sender': 'inmobile_sender',
    'google-place-id': 'google_place_id',
    'google-api-key': 'google_api_key',
    'trustpilot-business-id': 'trustpilot_business_id',
    'trustpilot-api-key': 'trustpilot_api_key'
  };

  Object.entries(fieldMappings).forEach(([elementId, settingKey]) => {
    const el = document.getElementById(elementId);
    if (el && settings[settingKey]) {
      el.value = settings[settingKey];
    }
  });

  // Load API enabled states
  await loadApiEnabledStates();

  updateApiStatus();
}

// =====================================================
// LEAD MANAGEMENT
// =====================================================
let leads = [];

// Leads View Switching
function showLeadsAddView() {
  document.getElementById('leads-list-view').style.display = 'none';
  document.getElementById('leads-add-view').style.display = 'block';
  clearLeadForm();
}

function showLeadsListView() {
  document.getElementById('leads-add-view').style.display = 'none';
  document.getElementById('leads-list-view').style.display = 'block';
  clearLeadForm();
}

// Pipeline View Switching
function showPipelineAddView() {
  document.getElementById('pipeline-kanban-view').style.display = 'none';
  document.getElementById('pipeline-add-view').style.display = 'block';
  clearPipelineLeadForm();
}

function showPipelineKanbanView() {
  document.getElementById('pipeline-add-view').style.display = 'none';
  document.getElementById('pipeline-kanban-view').style.display = 'block';
  clearPipelineLeadForm();
}

function clearLeadForm() {
  ['lead-name', 'lead-company', 'lead-phone', 'lead-email', 'lead-source', 'lead-value', 'lead-notes']
    .forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
}

function clearPipelineLeadForm() {
  ['pipeline-lead-name', 'pipeline-lead-company', 'pipeline-lead-phone', 'pipeline-lead-email',
   'pipeline-lead-source', 'pipeline-lead-value', 'pipeline-lead-notes', 'pipeline-lead-stage']
    .forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        if (el.tagName === 'SELECT') {
          el.selectedIndex = 0;
        } else {
          el.value = '';
        }
      }
    });
}

function saveNewLead() {
  const name = document.getElementById('lead-name')?.value.trim();
  const phone = document.getElementById('lead-phone')?.value.trim();

  if (!name) {
    toast('Navn er p√•kr√¶vet', 'error');
    document.getElementById('lead-name')?.focus();
    return;
  }

  if (!phone) {
    toast('Telefon er p√•kr√¶vet', 'error');
    document.getElementById('lead-phone')?.focus();
    return;
  }

  const lead = {
    id: 'lead-' + Date.now(),
    name: name,
    company: document.getElementById('lead-company')?.value.trim() || '',
    phone: phone,
    email: document.getElementById('lead-email')?.value.trim() || '',
    source: document.getElementById('lead-source')?.value || 'workflow',
    value: parseInt(document.getElementById('lead-value')?.value) || 0,
    stage: 'new',
    notes: document.getElementById('lead-notes')?.value.trim() || '',
    created_at: new Date().toISOString()
  };

  leads.push(lead);
  saveLeads();
  showLeadsListView();
  loadLeadsPage();
  toast('Lead tilf√∏jet', 'success');
}

function saveNewLeadFromPipeline() {
  const name = document.getElementById('pipeline-lead-name')?.value.trim();
  const phone = document.getElementById('pipeline-lead-phone')?.value.trim();

  if (!name) {
    toast('Navn er p√•kr√¶vet', 'error');
    document.getElementById('pipeline-lead-name')?.focus();
    return;
  }

  if (!phone) {
    toast('Telefon er p√•kr√¶vet', 'error');
    document.getElementById('pipeline-lead-phone')?.focus();
    return;
  }

  const lead = {
    id: 'lead-' + Date.now(),
    name: name,
    company: document.getElementById('pipeline-lead-company')?.value.trim() || '',
    phone: phone,
    email: document.getElementById('pipeline-lead-email')?.value.trim() || '',
    source: document.getElementById('pipeline-lead-source')?.value || 'workflow',
    value: parseInt(document.getElementById('pipeline-lead-value')?.value) || 0,
    stage: document.getElementById('pipeline-lead-stage')?.value || 'new',
    notes: document.getElementById('pipeline-lead-notes')?.value.trim() || '',
    created_at: new Date().toISOString()
  };

  leads.push(lead);
  saveLeads();
  showPipelineKanbanView();
  loadPipelinePage();
  toast('Lead tilf√∏jet', 'success');
}

// Legacy function for backwards compatibility
function showAddLeadModal() {
  showLeadsAddView();
}

function toggleLeadsSetup() {
  showLeadsAddView();
}

function saveLeads() {
  localStorage.setItem('orderflow_leads', JSON.stringify(leads));
}

function loadLeads() {
  const stored = localStorage.getItem('orderflow_leads');
  if (stored) {
    leads = JSON.parse(stored);
  }
}

function loadLeadsPage() {
  loadLeads();

  // Update stats
  const totalEl = document.getElementById('leads-total');
  const newEl = document.getElementById('leads-new');
  const qualifiedEl = document.getElementById('leads-qualified');
  const conversionEl = document.getElementById('leads-conversion');

  if (totalEl) totalEl.textContent = leads.length;
  if (newEl) newEl.textContent = leads.filter(l => l.stage === 'new').length;
  if (qualifiedEl) qualifiedEl.textContent = leads.filter(l => l.stage === 'qualified').length;

  const won = leads.filter(l => l.stage === 'won').length;
  const convRate = leads.length > 0 ? Math.round((won / leads.length) * 100) : 0;
  if (conversionEl) conversionEl.textContent = convRate + '%';

  // Update table
  const tbody = document.getElementById('leads-tbody');
  if (!tbody) return;

  if (leads.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--muted)">Ingen leads endnu. Klik "Tilf√∏j Lead" for at oprette det f√∏rste.</td></tr>`;
    return;
  }

  tbody.innerHTML = leads.map(lead => `
    <tr onclick="editLead('${lead.id}')" style="cursor:pointer">
      <td>${lead.name}</td>
      <td>${lead.company || '-'}</td>
      <td>${lead.phone || '-'}</td>
      <td>${lead.source}</td>
      <td>${lead.value ? formatCurrency(lead.value) : '-'}</td>
      <td><span class="lead-stage lead-stage-${lead.stage}">${getStageLabel(lead.stage)}</span></td>
      <td>${new Date(lead.created_at).toLocaleDateString('da-DK')}</td>
    </tr>
  `).join('');
}

function getStageLabel(stage) {
  const labels = {
    'new': 'Ny',
    'contacted': 'Kontaktet',
    'qualified': 'Kvalificeret',
    'proposal': 'Tilbud',
    'won': 'Vundet',
    'lost': 'Tabt'
  };
  return labels[stage] || stage;
}

function editLead(leadId) {
  const lead = leads.find(l => l.id === leadId);
  if (!lead) return;

  const newStage = prompt(`√Ündr stadie for ${lead.name}:\n(new, contacted, qualified, proposal, won, lost)`, lead.stage);
  if (newStage && ['new', 'contacted', 'qualified', 'proposal', 'won', 'lost'].includes(newStage)) {
    lead.stage = newStage;
    saveLeads();
    loadLeadsPage();
    loadPipelinePage();
    toast('Lead opdateret', 'success');
  }
}

function loadPipelinePage() {
  loadLeads();

  const stages = ['new', 'contacted', 'qualified', 'proposal', 'won'];

  stages.forEach(stage => {
    const container = document.getElementById('pipeline-' + stage);
    const countEl = document.getElementById('pipeline-count-' + stage);
    const stageLeads = leads.filter(l => l.stage === stage);

    if (countEl) countEl.textContent = stageLeads.length;

    if (container) {
      if (stageLeads.length === 0) {
        container.innerHTML = '<div style="padding:16px;text-align:center;color:var(--muted);font-size:13px">Ingen leads</div>';
      } else {
        container.innerHTML = stageLeads.map(lead => `
          <div class="pipeline-card" onclick="editLead('${lead.id}')" style="background:var(--bg3);padding:12px;border-radius:var(--radius-md);cursor:pointer;border:1px solid var(--border)">
            <div style="font-weight:var(--font-weight-medium);margin-bottom:4px">${lead.name}</div>
            <div style="font-size:12px;color:var(--muted)">${lead.company || 'Ingen firma'}</div>
            ${lead.value ? `<div style="font-size:12px;color:var(--accent);margin-top:4px">${formatCurrency(lead.value)}</div>` : ''}
          </div>
        `).join('');
      }
    }
  });
}

function filterLeadsList() {
  const search = document.getElementById('leads-search')?.value.toLowerCase() || '';
  loadLeads();

  const filtered = leads.filter(lead =>
    lead.name.toLowerCase().includes(search) ||
    (lead.company && lead.company.toLowerCase().includes(search)) ||
    (lead.phone && lead.phone.includes(search))
  );

  const tbody = document.getElementById('leads-tbody');
  if (!tbody) return;

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--muted)">Ingen leads matcher s√∏gningen</td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(lead => `
    <tr onclick="editLead('${lead.id}')" style="cursor:pointer">
      <td>${lead.name}</td>
      <td>${lead.company || '-'}</td>
      <td>${lead.phone || '-'}</td>
      <td>${lead.source}</td>
      <td>${lead.value ? formatCurrency(lead.value) : '-'}</td>
      <td><span class="lead-stage lead-stage-${lead.stage}">${getStageLabel(lead.stage)}</span></td>
      <td>${new Date(lead.created_at).toLocaleDateString('da-DK')}</td>
    </tr>
  `).join('');
}

function filterLeadsByStage(stage) {
  loadLeads();
  const filtered = stage === 'all' ? leads : leads.filter(l => l.stage === stage);

  const tbody = document.getElementById('leads-tbody');
  if (!tbody) return;

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--muted)">Ingen leads i dette stadie</td></tr>`;
    return;
  }

  tbody.innerHTML = filtered.map(lead => `
    <tr onclick="editLead('${lead.id}')" style="cursor:pointer">
      <td>${lead.name}</td>
      <td>${lead.company || '-'}</td>
      <td>${lead.phone || '-'}</td>
      <td>${lead.source}</td>
      <td>${lead.value ? formatCurrency(lead.value) : '-'}</td>
      <td><span class="lead-stage lead-stage-${lead.stage}">${getStageLabel(lead.stage)}</span></td>
      <td>${new Date(lead.created_at).toLocaleDateString('da-DK')}</td>
    </tr>
  `).join('');
}

// =====================================================
// UTILS
// =====================================================

// Format currency for KPI display
function formatCurrency(amount) {
  if (!amount) return '0 kr';
  return new Intl.NumberFormat('da-DK', { 
    style: 'decimal',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0 
  }).format(amount) + ' kr';
}

// Settings tab switching - synchronized with sidebar
function switchSettingsTab(tab) {
  // Tab name to display title mapping
  const tabTitles = {
    'api': 'API Adgang',
    'ailearning': 'L√¶ring',
    'users': 'Brugerindstillinger',
    'roles': 'Roller',
    'moms': 'Moms',
    'sprog': 'Sprog',
    'billing': 'Abonnement',
    'notifications': 'Notifikationer',
    'passwords': 'Adgangskoder',
    'support': 'Support',
    'maintenance': 'Systemvedligeholdelse',
    'cookies': 'Cookie Samtykke'
  };
  
  // Update dynamic page title
  const titleEl = document.getElementById('settings-page-title');
  if (titleEl) {
    titleEl.textContent = tabTitles[tab] || 'Indstillinger';
  }
  
  // Update tab content
  document.querySelectorAll('.settings-tab-content').forEach(c => c.classList.remove('active'));
  const contentEl = document.getElementById('settings-content-' + tab);
  if (contentEl) contentEl.classList.add('active');
  
  // SYNC: Highlight corresponding sidebar item
  syncSidebarSettingsItem(tab);
  
  // Load AI learning stats when that tab is opened
  if (tab === 'ailearning') {
    refreshAILearningStats();
  }
  
  // Load subscription plans config when billing tab is opened
  if (tab === 'billing') {
    renderSubscriptionPlansConfig();
  }

  // Initialize notification settings when notifications tab is opened
  if (tab === 'notifications') {
    initNotificationEmailField();
  }

  // Load session timeout setting when users tab is opened
  if (tab === 'users') {
    loadSessionTimeoutSetting();
  }

  // Initialize 2FA settings when password tab is opened
  if (tab === 'passwords') {
    init2FASettings();
  }

  // Load trusted devices when users tab is opened
  if (tab === 'users') {
    loadTrustedDevices();
  }

  // Load roles when roles tab is opened
  if (tab === 'roles') {
    loadRolesPage();
  }

  // Load cookie consent settings when cookies tab is opened
  if (tab === 'cookies') {
    loadCookieSettings();
  }
}

// Sync sidebar highlight with settings tab
function syncSidebarSettingsItem(tab) {
  // Clear all sidebar nav-dropdown-item active states under indstillinger
  document.querySelectorAll('#nav-indstillinger .nav-dropdown-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // Find and highlight the matching sidebar item
  const sidebarItems = document.querySelectorAll('#nav-indstillinger .nav-dropdown-item');
  sidebarItems.forEach(item => {
    const onclick = item.getAttribute('onclick');
    if (onclick && onclick.includes(`showSettingsPage('${tab}')`)) {
      item.classList.add('active');
    }
  });
}

// Refresh AI Learning Stats in dashboard
function refreshAILearningStats() {
  const stats = getAILearningStats();
  
  // Update stat cards
  document.getElementById('ai-stat-total').textContent = stats.total;
  document.getElementById('ai-stat-handled').textContent = stats.handledRate + '%';
  document.getElementById('ai-stat-review').textContent = stats.needsReview;
  
  // Sentiment display
  const sentimentEl = document.getElementById('ai-stat-sentiment');
  if (stats.total > 0) {
    const posPercent = Math.round((stats.sentimentBreakdown.positive / stats.total) * 100);
    const negPercent = Math.round((stats.sentimentBreakdown.negative / stats.total) * 100);
    if (posPercent > negPercent) {
      sentimentEl.textContent = 'üòä ' + posPercent + '%';
      sentimentEl.style.color = 'var(--green)';
    } else if (negPercent > posPercent) {
      sentimentEl.textContent = 'üòü ' + negPercent + '%';
      sentimentEl.style.color = 'var(--danger)';
    } else {
      sentimentEl.textContent = 'üòê Neutral';
      sentimentEl.style.color = 'var(--muted)';
    }
  } else {
    sentimentEl.textContent = '-';
    sentimentEl.style.color = 'var(--muted)';
  }
  
  // Render unhandled list
  const listEl = document.getElementById('ai-unhandled-list');
  if (stats.recentUnhandled.length > 0) {
    listEl.innerHTML = stats.recentUnhandled.map(entry => `
      <div style="padding:10px;background:var(--bg3);border-radius:var(--radius-sm);margin-bottom:8px;border-left:3px solid ${entry.sentiment === 'negative' ? 'var(--danger)' : 'var(--orange)'}">
        <div style="font-size:12px;color:var(--text);margin-bottom:4px">"${escapeHtml(entry.message?.substring(0, 80))}${entry.message?.length > 80 ? '...' : ''}"</div>
        <div style="display:flex;gap:8px;font-size:10px;color:var(--muted)">
          <span>${entry.classification?.category || 'UNKNOWN'}</span>
          <span>‚Ä¢</span>
          <span>${Math.round((entry.classification?.confidence || 0) * 100)}% conf</span>
          <span>‚Ä¢</span>
          <span>${new Date(entry.timestamp).toLocaleDateString('da-DK')}</span>
        </div>
      </div>
    `).join('');
  } else {
    listEl.innerHTML = '<p style="color:var(--muted);font-size:12px;text-align:center;padding:20px">Ingen ubehandlede beskeder</p>';
  }
}

// Helper for HTML escaping
function escapeHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

// Toggle notification setting - visual feedback only
function toggleNotification(type) {
  // Toggle state is already visible on the checkbox
}

// Save notification email - visual feedback only
function saveNotificationEmail() {
  // Form validation handles errors
}

// Regenerate webhook secret - visual feedback in input field
function regenerateWebhookSecret() {
  const secret = 'whsec_' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
  document.getElementById('webhook-secret').value = secret;
  // Value update in input is visual feedback
}

// Edit user role (placeholder)
function editUserRole(userId) {
  // Would open modal
}

// Toggle KPI for restaurant - visual feedback in UI update
function toggleRestaurantKpi(restaurantId) {
  const restaurant = restaurants.find(r => r.id === restaurantId);
  if (restaurant) {
    restaurant.kpiEnabled = !restaurant.kpiEnabled;
    
    // Initialize KPI data if enabling and not present
    if (restaurant.kpiEnabled && !restaurant.kpi) {
      restaurant.kpi = {
        totalRevenue: 0,
        recoveredRevenue: 0,
        avgOrderValue: 0,
        reviews: {
          total: 0,
          avgRating: 0,
          google: { count: 0, avgRating: 0 },
          trustpilot: { count: 0, avgRating: 0 }
        },
        conversionRate: 0,
        responseTime: 0
      };
    }
    
    loadRestaurants();
  }
}

// ========================================
// CUSTOMER-SPECIFIC LOGS SYSTEM
// ========================================

// Format timestamp for aktivitetslog (DD.MM.YYYY, HH.MM)
function formatAktivitetslogTimestamp(timestamp) {
  const date = new Date(timestamp);
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  
  return `${day}.${month}.${year}, ${hours}.${minutes}`;
}

// Get border color based on type and priority
function getLogBorderColor(type, prioritet) {
  if (prioritet === 'kritisk') return 'var(--danger)';
  if (prioritet === 'h√∏j') return 'var(--orange)';
  
  const colors = {
    'sms': 'var(--accent)',
    'opkald': 'var(--purple)',
    'email': 'var(--info)',
    'ordre': 'var(--green)',
    'klage': 'var(--danger)',
    'feedback': 'var(--cyan)',
    'andet': 'var(--muted)'
  };
  return colors[type] || 'var(--accent)';
}

// Get icon for log type
function getLogTypeIcon(type) {
  const icons = {
    'sms': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
    'opkald': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--purple)" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',
    'email': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--info)" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>',
    'ordre': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>',
    'klage': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
    'feedback': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--cyan)" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
    'andet': '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
  };
  return icons[type] || icons['andet'];
}

// Get priority badge
function getPrioritetBadge(prioritet) {
  const badges = {
    'lav': '<span style="font-size:10px;padding:2px 8px;background:var(--bg2);border-radius:var(--radius-full);color:var(--muted);margin-left:8px">Lav</span>',
    'h√∏j': '<span style="font-size:10px;padding:2px 8px;background:rgba(251,191,36,0.15);border-radius:var(--radius-full);color:var(--orange);margin-left:8px">H√∏j</span>',
    'kritisk': '<span style="font-size:10px;padding:2px 8px;background:rgba(248,113,113,0.15);border-radius:var(--radius-full);color:var(--danger);margin-left:8px">Kritisk</span>'
  };
  return badges[prioritet] || '';
}

// Format log date
function formatLogDate(timestamp) {
  const date = new Date(timestamp);
  const now = new Date();
  const diff = now - date;
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  
  if (days === 0) {
    return 'I dag ' + date.toLocaleTimeString('da-DK', { hour: '2-digit', minute: '2-digit' });
  } else if (days === 1) {
    return 'I g√•r ' + date.toLocaleTimeString('da-DK', { hour: '2-digit', minute: '2-digit' });
  } else if (days < 7) {
    return days + ' dage siden';
  } else {
    return date.toLocaleDateString('da-DK', { day: 'numeric', month: 'short', year: 'numeric' });
  }
}

// Helper: Download file
function downloadFile(content, filename, mimeType) {
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Get all customer kundelogs from localStorage
function getAllCustomerKundelogs() {
  return JSON.parse(localStorage.getItem('orderflow_customer_kundelogs') || '{}');
}

// Save all customer kundelogs to localStorage
function saveAllCustomerKundelogs(data) {
  localStorage.setItem('orderflow_customer_kundelogs', JSON.stringify(data));
}

// Get kundelogs for specific customer
function getCustomerKundelogs(customerId) {
  const allLogs = getAllCustomerKundelogs();
  return allLogs[customerId] || [];
}

// Save kundelogs for specific customer
function saveCustomerKundelogsForCustomer(customerId, logs) {
  const allLogs = getAllCustomerKundelogs();
  allLogs[customerId] = logs;
  saveAllCustomerKundelogs(allLogs);
}

// Load and render customer kundelogs
function loadCustomerKundelogs() {
  if (!currentProfileRestaurantId) return;
  renderCustomerKundelogs();
}

// Render customer kundelogs
function renderCustomerKundelogs() {
  const container = document.getElementById('customer-kundelogs-container');
  const countEl = document.getElementById('customer-kundelogs-count');
  
  if (!container || !currentProfileRestaurantId) return;
  
  const logs = getCustomerKundelogs(currentProfileRestaurantId);
  
  // Get filter values
  const searchTerm = (document.getElementById('customer-kundelog-search')?.value || '').toLowerCase();
  const typeFilter = document.getElementById('customer-kundelog-type-filter')?.value || 'all';
  
  // Filter logs
  let filteredLogs = logs.filter(log => {
    const matchesSearch = !searchTerm || 
      (log.beskrivelse && log.beskrivelse.toLowerCase().includes(searchTerm)) ||
      (log.reference && log.reference.toLowerCase().includes(searchTerm)) ||
      (log.tags && log.tags.some(t => t.toLowerCase().includes(searchTerm)));
    
    const matchesType = typeFilter === 'all' || log.type === typeFilter;
    
    return matchesSearch && matchesType;
  });
  
  // Sort by date (newest first)
  filteredLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  
  // Update count
  if (countEl) {
    countEl.textContent = `(${filteredLogs.length} log${filteredLogs.length !== 1 ? 's' : ''})`;
  }
  
  // Empty state
  if (filteredLogs.length === 0) {
    if (logs.length === 0) {
      container.innerHTML = `
        <div style="text-align:center;padding:60px 20px">
          <div style="width:80px;height:80px;background:var(--accent-dim);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px">
            <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="12" y1="11" x2="12" y2="17"/>
              <line x1="9" y1="14" x2="15" y2="14"/>
            </svg>
          </div>
          <h3 style="font-size:18px;font-weight:600;margin-bottom:8px;color:var(--text)">Ingen kundelogs fundet</h3>
          <p style="color:var(--text2);font-size:14px;margin-bottom:24px">Opret en log for at se den her</p>
          <button class="btn btn-primary" onclick="openCustomerKundelogModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Opret f√∏rste log
          </button>
        </div>
      `;
    } else {
      container.innerHTML = `
        <div style="text-align:center;padding:40px 20px">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="1.5" style="margin-bottom:16px">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          <p style="color:var(--text2);font-size:14px">Ingen logs matcher din s√∏gning</p>
        </div>
      `;
    }
    return;
  }
  
  // Render logs
  container.innerHTML = filteredLogs.map(log => {
    const borderColor = getLogBorderColor(log.type, log.prioritet);
    const typeIcon = getLogTypeIcon(log.type);
    const prioritetBadge = log.prioritet !== 'normal' ? getPrioritetBadge(log.prioritet) : '';
    const formattedDate = formatLogDate(log.timestamp);
    const tagsHtml = log.tags && log.tags.length > 0 
      ? `<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:8px">${log.tags.map(t => `<span style="font-size:10px;padding:2px 8px;background:var(--bg2);border-radius:var(--radius-full);color:var(--text2)">${escapeHtml(t)}</span>`).join('')}</div>` 
      : '';
    
    return `
      <div class="log-entry" style="padding:14px 16px;background:var(--bg3);border-radius:var(--radius-sm);margin-bottom:10px;border-left:3px solid ${borderColor};transition:all 0.15s" 
           onmouseenter="this.style.background='var(--card-hover)'" 
           onmouseleave="this.style.background='var(--bg3)'">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px">
          <div style="display:flex;align-items:center;gap:10px">
            <div style="width:32px;height:32px;background:var(--bg2);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center">
              ${typeIcon}
            </div>
            <div>
              <span style="font-weight:600;color:var(--text);text-transform:capitalize">${log.type}</span>
              ${log.reference ? `<span style="color:var(--muted);font-size:12px;margin-left:8px">${escapeHtml(log.reference)}</span>` : ''}
              ${prioritetBadge}
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <span style="font-size:11px;color:var(--muted)">${formattedDate}</span>
            <div style="display:flex;gap:4px">
              <button class="btn btn-ghost btn-icon" style="width:28px;height:28px" onclick="editCustomerKundelog('${log.id}')" title="Rediger">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
              </button>
              <button class="btn btn-ghost btn-icon" style="width:28px;height:28px;color:var(--danger)" onclick="deleteCustomerKundelog('${log.id}')" title="Slet">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
              </button>
            </div>
          </div>
        </div>
        <div style="font-size:13px;color:var(--text2);line-height:1.5;margin-left:42px">${escapeHtml(log.beskrivelse)}</div>
        ${tagsHtml ? `<div style="margin-left:42px">${tagsHtml}</div>` : ''}
      </div>
    `;
  }).join('');
}

// Filter customer kundelogs
function filterCustomerKundelogs() {
  renderCustomerKundelogs();
}

// Toggle export dropdown for customer kundelogs
function toggleCustomerKundelogExportDropdown() {
  const dropdown = document.getElementById('customer-kundelog-export-dropdown');
  dropdown.classList.toggle('open');
  
  if (dropdown.classList.contains('open')) {
    setTimeout(() => {
      document.addEventListener('click', closeCustomerKundelogExportDropdownOnOutside);
    }, 0);
  }
}

function closeCustomerKundelogExportDropdownOnOutside(e) {
  const dropdown = document.getElementById('customer-kundelog-export-dropdown');
  if (dropdown && !dropdown.contains(e.target)) {
    dropdown.classList.remove('open');
    document.removeEventListener('click', closeCustomerKundelogExportDropdownOnOutside);
  }
}

// Open customer kundelog modal
function openCustomerKundelogModal(editId = null) {
  const modal = document.getElementById('customer-kundelog-modal');
  const title = document.getElementById('customer-kundelog-modal-title');
  
  // Reset form
  document.getElementById('customer-kundelog-edit-id').value = '';
  document.getElementById('customer-kundelog-type').value = 'sms';
  document.getElementById('customer-kundelog-reference').value = '';
  document.getElementById('customer-kundelog-prioritet').value = 'normal';
  document.getElementById('customer-kundelog-beskrivelse').value = '';
  document.getElementById('customer-kundelog-tags').value = '';
  
  if (editId) {
    const logs = getCustomerKundelogs(currentProfileRestaurantId);
    const log = logs.find(l => l.id === editId);
    if (log) {
      title.textContent = 'Rediger kundelog';
      document.getElementById('customer-kundelog-edit-id').value = log.id;
      document.getElementById('customer-kundelog-type').value = log.type;
      document.getElementById('customer-kundelog-reference').value = log.reference || '';
      document.getElementById('customer-kundelog-prioritet').value = log.prioritet;
      document.getElementById('customer-kundelog-beskrivelse').value = log.beskrivelse;
      document.getElementById('customer-kundelog-tags').value = (log.tags || []).join(', ');
    }
  } else {
    title.textContent = 'Opret kundelog';
  }
  
  modal.style.display = 'flex';
  setTimeout(() => document.getElementById('customer-kundelog-beskrivelse').focus(), 100);
}

// Close customer kundelog modal
function closeCustomerKundelogModal() {
  document.getElementById('customer-kundelog-modal').style.display = 'none';
}

// Edit customer kundelog
function editCustomerKundelog(id) {
  openCustomerKundelogModal(id);
}

// Delete customer kundelog
function deleteCustomerKundelog(id) {
  if (confirm('Er du sikker p√•, at du vil slette denne log?')) {
    let logs = getCustomerKundelogs(currentProfileRestaurantId);
    logs = logs.filter(l => l.id !== id);
    saveCustomerKundelogsForCustomer(currentProfileRestaurantId, logs);
    renderCustomerKundelogs();
    toast('Log slettet', 'success');
  }
}

// Save customer kundelog
function saveCustomerKundelog() {
  if (!currentProfileRestaurantId) {
    toast('Ingen kunde valgt', 'error');
    return;
  }
  
  const editId = document.getElementById('customer-kundelog-edit-id').value;
  const type = document.getElementById('customer-kundelog-type').value;
  const reference = document.getElementById('customer-kundelog-reference').value.trim();
  const prioritet = document.getElementById('customer-kundelog-prioritet').value;
  const beskrivelse = document.getElementById('customer-kundelog-beskrivelse').value.trim();
  const tagsInput = document.getElementById('customer-kundelog-tags').value;
  const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
  
  // Validation
  if (!beskrivelse) {
    toast('Indtast en beskrivelse', 'error');
    document.getElementById('customer-kundelog-beskrivelse').focus();
    return;
  }
  
  let logs = getCustomerKundelogs(currentProfileRestaurantId);
  
  // Get customer name for the log
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  const kundeName = restaurant?.name || 'Ukendt kunde';
  
  if (editId) {
    // Update existing
    const index = logs.findIndex(l => l.id === editId);
    if (index !== -1) {
      logs[index] = {
        ...logs[index],
        type,
        reference,
        prioritet,
        beskrivelse,
        tags,
        updatedAt: new Date().toISOString()
      };
    }
    toast('Log opdateret', 'success');
  } else {
    // Create new
    logs.push({
      id: 'clog_' + Date.now(),
      customerId: currentProfileRestaurantId,
      kunde: kundeName,
      type,
      reference,
      prioritet,
      beskrivelse,
      tags,
      timestamp: new Date().toISOString(),
      createdBy: currentUser?.name || 'System'
    });
    toast('Log oprettet', 'success');
  }
  
  saveCustomerKundelogsForCustomer(currentProfileRestaurantId, logs);
  closeCustomerKundelogModal();
  renderCustomerKundelogs();
}

// Export customer kundelogs
function exportCustomerKundelogs(format) {
  document.getElementById('customer-kundelog-export-dropdown').classList.remove('open');
  
  const logs = getCustomerKundelogs(currentProfileRestaurantId);
  
  if (logs.length === 0) {
    toast('Ingen logs at eksportere', 'error');
    return;
  }
  
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  const kundeName = restaurant?.name || 'kunde';
  const timestamp = new Date().toISOString().split('T')[0];
  const filename = `kundelogs_${kundeName.replace(/\s+/g, '_')}_${timestamp}`;
  
  if (format === 'csv') {
    const headers = ['ID', 'Dato', 'Type', 'Reference', 'Prioritet', 'Beskrivelse', 'Tags'];
    const rows = logs.map(log => [
      log.id,
      new Date(log.timestamp).toLocaleString('da-DK'),
      log.type,
      log.reference || '',
      log.prioritet,
      '"' + (log.beskrivelse || '').replace(/"/g, '""') + '"',
      (log.tags || []).join('; ')
    ]);
    const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
    downloadFile(csv, filename + '.csv', 'text/csv;charset=utf-8');
    // toast('CSV eksporteret', 'success'); // Removed - unnecessary
  } else if (format === 'json') {
    const json = JSON.stringify(logs, null, 2);
    downloadFile(json, filename + '.json', 'application/json');
    // toast('JSON eksporteret', 'success'); // Removed - unnecessary
  } else if (format === 'pdf') {
    const printContent = `
      <!DOCTYPE html>
      <html><head><meta charset="UTF-8"><title>Kundelogs - ${kundeName}</title>
      <style>body{font-family:Arial,sans-serif;padding:40px;color:#333}h1{color:#2dd4bf;border-bottom:2px solid #2dd4bf;padding-bottom:10px}.meta{color:#666;margin-bottom:30px}table{width:100%;border-collapse:collapse;margin-top:20px}th{background:#2dd4bf;color:#000;padding:12px;text-align:left;font-weight:600}td{padding:10px 12px;border-bottom:1px solid #ddd;vertical-align:top}tr:nth-child(even){background:#f9f9f9}</style></head>
      <body><h1>Kundelogs: ${escapeHtml(kundeName)}</h1><div class="meta">Eksporteret: ${new Date().toLocaleString('da-DK')}<br>Antal logs: ${logs.length}</div>
      <table><thead><tr><th>Dato</th><th>Type</th><th>Reference</th><th>Prioritet</th><th>Beskrivelse</th></tr></thead><tbody>
      ${logs.map(log => `<tr><td>${new Date(log.timestamp).toLocaleString('da-DK')}</td><td>${log.type}</td><td>${escapeHtml(log.reference || '-')}</td><td>${log.prioritet}</td><td>${escapeHtml(log.beskrivelse)}</td></tr>`).join('')}
      </tbody></table></body></html>`;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.onload = function() { printWindow.print(); };
    // toast('PDF klar til print', 'success'); // Removed - unnecessary
  }
}

// ========================================
// CUSTOMER-SPECIFIC AKTIVITETSLOGS
// ========================================

// Get all customer aktivitetslogs from localStorage
function getAllCustomerAktivitetslogs() {
  return JSON.parse(localStorage.getItem('orderflow_customer_aktivitetslogs') || '{}');
}

// Save all customer aktivitetslogs to localStorage
function saveAllCustomerAktivitetslogs(data) {
  localStorage.setItem('orderflow_customer_aktivitetslogs', JSON.stringify(data));
}

// Get aktivitetslogs for specific customer
function getCustomerAktivitetslogs(customerId) {
  const allLogs = getAllCustomerAktivitetslogs();
  return allLogs[customerId] || [];
}

// Save aktivitetslogs for specific customer
function saveCustomerAktivitetslogsForCustomer(customerId, logs) {
  const allLogs = getAllCustomerAktivitetslogs();
  allLogs[customerId] = logs;
  saveAllCustomerAktivitetslogs(allLogs);
}

// Add a new aktivitetslog for a customer (called automatically by system)
function addCustomerAktivitetslog(customerId, type, besked) {
  if (!customerId) return;
  
  let logs = getCustomerAktivitetslogs(customerId);
  logs.unshift({
    id: 'cakt_' + Date.now(),
    customerId: customerId,
    timestamp: new Date().toISOString(),
    type: type,
    besked: besked
  });
  
  // Keep only last 500 logs per customer
  if (logs.length > 500) {
    logs = logs.slice(0, 500);
  }
  
  saveCustomerAktivitetslogsForCustomer(customerId, logs);
  
  // Refresh if viewing this customer's aktivitetslogs
  if (currentProfileRestaurantId === customerId && 
      document.getElementById('subpage-aktivitetslogs')?.classList.contains('active')) {
    renderCustomerAktivitetslogs();
  }
}

// Load and render customer aktivitetslogs
function loadCustomerAktivitetslogs() {
  if (!currentProfileRestaurantId) return;
  
  // Generate demo data if none exists
  const logs = getCustomerAktivitetslogs(currentProfileRestaurantId);
  if (logs.length === 0) {
    const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
    const name = restaurant?.name || 'Kunde';
    
    // Add demo aktivitetslogs
    const demoLogs = [
      { type: 'email', besked: `E-mail sendt til ${name}: Velkommen til OrderFlow` },
      { type: 'system', besked: 'Kundeprofil oprettet' },
      { type: 'profil', besked: 'Virksomhedsnavn opdateret' }
    ];
    
    demoLogs.forEach((log, i) => {
      const timestamp = new Date();
      timestamp.setDate(timestamp.getDate() - i);
      logs.push({
        id: 'cakt_demo_' + i,
        customerId: currentProfileRestaurantId,
        timestamp: timestamp.toISOString(),
        type: log.type,
        besked: log.besked
      });
    });
    
    saveCustomerAktivitetslogsForCustomer(currentProfileRestaurantId, logs);
  }
  
  renderCustomerAktivitetslogs();
}

// Render customer aktivitetslogs
function renderCustomerAktivitetslogs() {
  const container = document.getElementById('customer-aktivitetslogs-body');
  const countEl = document.getElementById('customer-aktivitetslogs-count');
  
  if (!container || !currentProfileRestaurantId) return;
  
  const logs = getCustomerAktivitetslogs(currentProfileRestaurantId);
  
  // Get filter values
  const searchTerm = (document.getElementById('customer-aktivitetslog-search')?.value || '').toLowerCase();
  const typeFilter = document.getElementById('customer-aktivitetslog-type-filter')?.value || 'all';
  
  // Filter logs
  let filteredLogs = logs.filter(log => {
    const matchesSearch = !searchTerm || log.besked.toLowerCase().includes(searchTerm);
    const matchesType = typeFilter === 'all' || log.type === typeFilter;
    return matchesSearch && matchesType;
  });
  
  // Sort by timestamp (newest first)
  filteredLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  
  // Update count
  if (countEl) {
    countEl.textContent = `(${filteredLogs.length} log${filteredLogs.length !== 1 ? 's' : ''})`;
  }
  
  // Empty state
  if (filteredLogs.length === 0) {
    container.innerHTML = `
      <div style="text-align:center;padding:60px 20px">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--muted)" stroke-width="1.5" style="margin-bottom:16px">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
        </svg>
        <p style="color:var(--text2);font-size:14px">${logs.length === 0 ? 'Ingen aktivitetslogs endnu' : 'Ingen logs matcher din s√∏gning'}</p>
      </div>
    `;
    return;
  }
  
  // Render tabel rows
  container.innerHTML = filteredLogs.map((log, index) => {
    const formattedTimestamp = formatAktivitetslogTimestamp(log.timestamp);
    const bgColor = index % 2 === 0 ? 'transparent' : 'var(--bg2)';
    
    return `
      <div style="display:grid;grid-template-columns:180px 1fr;border-bottom:1px solid var(--border);background:${bgColor};transition:background 0.15s"
           onmouseenter="this.style.background='var(--card-hover)'" 
           onmouseleave="this.style.background='${bgColor}'">
        <div style="padding:14px 20px;font-size:13px;color:var(--muted)">${formattedTimestamp}</div>
        <div style="padding:14px 20px;font-size:13px;color:var(--text2);text-align:right">${escapeHtml(log.besked)}</div>
      </div>
    `;
  }).join('');
}

// Filter customer aktivitetslogs
function filterCustomerAktivitetslogs() {
  renderCustomerAktivitetslogs();
}

// Toggle export dropdown for customer aktivitetslogs
function toggleCustomerAktivitetslogExportDropdown() {
  const dropdown = document.getElementById('customer-aktivitetslog-export-dropdown');
  dropdown.classList.toggle('open');
  
  if (dropdown.classList.contains('open')) {
    setTimeout(() => {
      document.addEventListener('click', closeCustomerAktivitetslogExportDropdownOnOutside);
    }, 0);
  }
}

function closeCustomerAktivitetslogExportDropdownOnOutside(e) {
  const dropdown = document.getElementById('customer-aktivitetslog-export-dropdown');
  if (dropdown && !dropdown.contains(e.target)) {
    dropdown.classList.remove('open');
    document.removeEventListener('click', closeCustomerAktivitetslogExportDropdownOnOutside);
  }
}

// Export customer aktivitetslogs
function exportCustomerAktivitetslogs(format) {
  document.getElementById('customer-aktivitetslog-export-dropdown').classList.remove('open');
  
  const logs = getCustomerAktivitetslogs(currentProfileRestaurantId);
  
  if (logs.length === 0) {
    toast('Ingen logs at eksportere', 'error');
    return;
  }
  
  const restaurant = restaurants.find(r => r.id === currentProfileRestaurantId);
  const kundeName = restaurant?.name || 'kunde';
  const timestamp = new Date().toISOString().split('T')[0];
  const filename = `aktivitetslogs_${kundeName.replace(/\s+/g, '_')}_${timestamp}`;
  
  if (format === 'csv') {
    const headers = ['Timestamp', 'Type', 'Besked'];
    const rows = logs.map(log => [
      formatAktivitetslogTimestamp(log.timestamp),
      log.type,
      '"' + (log.besked || '').replace(/"/g, '""') + '"'
    ]);
    const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
    downloadFile(csv, filename + '.csv', 'text/csv;charset=utf-8');
    // toast('CSV eksporteret', 'success'); // Removed - unnecessary
  } else if (format === 'json') {
    const json = JSON.stringify(logs, null, 2);
    downloadFile(json, filename + '.json', 'application/json');
    // toast('JSON eksporteret', 'success'); // Removed - unnecessary
  } else if (format === 'pdf') {
    const printContent = `
      <!DOCTYPE html>
      <html><head><meta charset="UTF-8"><title>Aktivitetslogs - ${kundeName}</title>
      <style>body{font-family:Arial,sans-serif;padding:40px;color:#333}h1{color:#2dd4bf;border-bottom:2px solid #2dd4bf;padding-bottom:10px}.meta{color:#666;margin-bottom:30px}table{width:100%;border-collapse:collapse;margin-top:20px}th{background:#2dd4bf;color:#000;padding:12px;text-align:left;font-weight:600}th:last-child{text-align:right}td{padding:10px 12px;border-bottom:1px solid #ddd;vertical-align:top}td:last-child{text-align:right}tr:nth-child(even){background:#f9f9f9}</style></head>
      <body><h1>Aktivitetslogs: ${escapeHtml(kundeName)}</h1><div class="meta">Eksporteret: ${new Date().toLocaleString('da-DK')}<br>Antal logs: ${logs.length}</div>
      <table><thead><tr><th>Timestamp</th><th>Besked</th></tr></thead><tbody>
      ${logs.map(log => `<tr><td>${formatAktivitetslogTimestamp(log.timestamp)}</td><td>${escapeHtml(log.besked)}</td></tr>`).join('')}
      </tbody></table></body></html>`;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.onload = function() { printWindow.print(); };
    // toast('PDF klar til print', 'success'); // Removed - unnecessary
  }
}

// ========================================
// END CUSTOMER-SPECIFIC LOGS SYSTEM
// ========================================

function toast(msg, type = 'info') {
  // Remove existing toast
  const existing = document.querySelector('.toast-notification');
  if (existing) existing.remove();
  
  const toast = document.createElement('div');
  toast.className = 'toast-notification';
  
  toast.style.cssText = `
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: #D5DDEC;
    color: #1a1a2e;
    padding: 14px 20px;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    z-index: 10000;
    animation: fadeIn 0.3s ease;
    font-size: 14px;
    font-weight: 500;
  `;
  
  toast.textContent = msg;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'fadeIn 0.3s ease reverse';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// ========================================
// MANGLENDE FUNKTIONER - TILF√òJET I V128
// ========================================
// Gem notifikationsindstillinger
function saveNotificationSettings() {
  const email = document.getElementById('notification-email')?.value || '';
  const cc = document.getElementById('notification-cc')?.value || '';
  
  // Gem alle checkbox-indstillinger
  const checkboxes = document.querySelectorAll('[data-notif]');
  const settings = {};
  checkboxes.forEach(cb => {
    settings[cb.dataset.notif] = cb.checked;
  });
  
  localStorage.setItem('orderflow_notification_settings', JSON.stringify({
    email,
    cc,
    settings
  }));

  showSaveStatus('notification-save-status', 'saved');
}

// Gem stille timer
function saveQuietHours() {
  const start = document.getElementById('quiet-start')?.value || '22:00';
  const end = document.getElementById('quiet-end')?.value || '08:00';
  const allowCritical = document.getElementById('allow-critical')?.checked || true;

  localStorage.setItem('orderflow_quiet_hours', JSON.stringify({
    start,
    end,
    allowCritical
  }));

  showSaveStatus('quiet-hours-save-status', 'saved');
}

// Gem bl√• prik notifikationsindstillinger
function saveBlueNotificationSettings() {
  const dismissType = document.querySelector('input[name="dismiss-type"]:checked')?.value || 'click';
  const dismissValue = parseInt(document.getElementById('dismiss-value')?.value) || 1;

  // Save to activity indicator settings
  const settings = {
    dismissType: dismissType === 'click' ? 'hover' : dismissType,
    dismissValue: dismissValue
  };
  localStorage.setItem('orderflow_activity_indicator_settings', JSON.stringify(settings));

  // Also save to NotificationSystem for compatibility
  if (typeof NotificationSystem !== 'undefined') {
    NotificationSystem.saveSettings({
      defaultDismissType: dismissType,
      defaultDismissValue: dismissValue
    });
  }

  showSaveStatus('blue-notification-save-status', 'saved');

  // Refresh indicators to apply new settings
  updateActivityIndicators();
}

// Ryd alle bl√• prik notifikationer
function clearAllBlueNotifications() {
  if (typeof NotificationSystem !== 'undefined') {
    const count = NotificationSystem.notifications.size;
    if (count === 0) {
      toast('Ingen notifikationer at rydde', 'info');
      return;
    }

    if (confirm(`Er du sikker p√• at du vil rydde alle ${count} notifikationer?`)) {
      NotificationSystem.notifications.clear();
      NotificationSystem.saveNotifications();
      NotificationSystem.applyNotifications();
      toast(`${count} notifikationer ryddet`, 'success');
    }
  } else {
    console.error('NotificationSystem not loaded');
    toast('Fejl: Notifikationssystem ikke indl√¶st', 'error');
  }
}

// =====================================================
// NOTIFIKATION INITIALISERING
// =====================================================

/**
 * Initialiserer notification email-feltet med brugerens login-email
 * Hvis der allerede er gemt en email i localStorage, bruges den i stedet
 */
function initNotificationEmailField() {
  const emailField = document.getElementById('notification-email');
  if (!emailField) return;

  // Tjek om der er gemt indstillinger i localStorage
  const savedSettings = localStorage.getItem('orderflow_notification_settings');

  if (savedSettings) {
    try {
      const parsed = JSON.parse(savedSettings);
      if (parsed.email) {
        emailField.value = parsed.email;
        // S√¶t ogs√• CC hvis gemt
        const ccField = document.getElementById('notification-cc');
        if (ccField && parsed.cc) {
          ccField.value = parsed.cc;
        }
        return;
      }
    } catch (e) {
      console.warn('Kunne ikke parse gemte notifikationsindstillinger:', e);
    }
  }

  // Ingen gemt email - brug brugerens login-email
  if (currentUser && currentUser.email) {
    emailField.value = currentUser.email;
  }
}

// =====================================================
// SAMLET NOTIFIKATION GEM-FUNKTION
// =====================================================

/**
 * Gem alle notifikationsindstillinger p√• √©n gang
 * Sender ogs√• notifikation til header bell og email (hvis aktiveret)
 */
async function saveAllNotificationSettings() {
  try {
    // 1. Gem Bl√• Prik indstillinger
    const dismissType = document.querySelector('input[name="dismiss-type"]:checked')?.value || 'click';
    const dismissValue = parseInt(document.getElementById('dismiss-value')?.value) || 1;

    const blueSettings = {
      dismissType: dismissType === 'click' ? 'hover' : dismissType,
      dismissValue: dismissValue
    };
    localStorage.setItem('orderflow_activity_indicator_settings', JSON.stringify(blueSettings));

    if (typeof NotificationSystem !== 'undefined') {
      NotificationSystem.saveSettings({
        defaultDismissType: dismissType,
        defaultDismissValue: dismissValue
      });
    }

    // 2. Gem Email indstillinger
    const email = document.getElementById('notification-email')?.value || '';
    const cc = document.getElementById('notification-cc')?.value || '';

    const checkboxes = document.querySelectorAll('[data-notif]');
    const notifSettings = {};
    checkboxes.forEach(cb => {
      notifSettings[cb.dataset.notif] = cb.checked;
    });

    localStorage.setItem('orderflow_notification_settings', JSON.stringify({
      email,
      cc,
      settings: notifSettings
    }));

    // 3. Gem Stille timer
    const quietStart = document.getElementById('quiet-start')?.value || '22:00';
    const quietEnd = document.getElementById('quiet-end')?.value || '08:00';
    const allowCritical = document.getElementById('allow-critical')?.checked ?? true;

    localStorage.setItem('orderflow_quiet_hours', JSON.stringify({
      start: quietStart,
      end: quietEnd,
      allowCritical
    }));

    // 4. Send notifikation til header ringeklokke
    addHeaderNotification({
      type: 'settings',
      title: 'Indstillinger gemt',
      message: 'Dine notifikationsindstillinger er blevet opdateret',
      icon: 'green'
    });

    // 5. Send email hvis checkbox er aktiveret og email er udfyldt
    // Tjek om "indstillinger √¶ndret" notifikation er sl√•et til
    const monthlyInvoiceCheckbox = document.querySelector('input[data-notif="monthly-invoice"]');
    if (monthlyInvoiceCheckbox?.checked && email) {
      try {
        await sendSettingsEmail(email, cc);
      } catch (err) {
        console.warn('Email notification failed:', err);
      }
    }

    // 6. Vis gem-status
    showSaveStatus('all-notifications-save-status', 'saved');

    // 7. Opdater activity indicators
    if (typeof updateActivityIndicators === 'function') {
      updateActivityIndicators();
    }

    console.log('‚úÖ Alle notifikationsindstillinger gemt');

  } catch (error) {
    console.error('Fejl ved gem af notifikationsindstillinger:', error);
    toast('Fejl ved gem af indstillinger', 'error');
  }
}

/**
 * Tilf√∏j notifikation til header dropdown (ringeklokke)
 * @param {Object} notification - Notifikationsdata
 * @param {string} notification.type - Type af notifikation
 * @param {string} notification.title - Titel p√• notifikation
 * @param {string} notification.message - Besked
 * @param {string} notification.icon - Icon farve (green, yellow, blue, purple)
 */
function addHeaderNotification(notification) {
  saveHeaderNotifications(notification);
  renderHeaderNotifications();
}

/**
 * Hent ikon SVG baseret p√• notifikationstype
 */
function getNotificationIcon(type) {
  const icons = {
    settings: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>',
    order: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>',
    success: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
    default: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'
  };
  return icons[type] || icons.default;
}

/**
 * Opdater notification badge t√¶ller
 * @param {number} change - √Ündring (+1 eller -1)
 */
function updateNotificationBadge(change) {
  const badge = document.querySelector('.topbar-badge');
  if (!badge) return;

  let count = parseInt(badge.textContent) || 0;
  count = Math.max(0, count + change);
  
  badge.textContent = count;
  badge.style.display = count > 0 ? 'flex' : 'none';
}

function getHeaderNotifications() {
  const saved = JSON.parse(localStorage.getItem('orderflow_header_notifications') || '[]');
  return saved.filter(n => !n.read);
}

function formatNotificationTime(timestamp) {
  if (!timestamp) return 'Lige nu';
  const diffMs = Date.now() - timestamp;
  const minutes = Math.floor(diffMs / 60000);
  if (minutes < 1) return 'Lige nu';
  if (minutes < 60) return `${minutes} min siden`;
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours} timer siden`;
  const days = Math.floor(hours / 24);
  return `${days} dage siden`;
}

function renderHeaderNotifications() {
  const list = document.getElementById('notif-list');
  const badge = document.querySelector('.topbar-badge');
  if (!list) return;

  const notifications = [];
  getHeaderNotifications().forEach(n => notifications.push({ ...n, source: 'header' }));

  if (typeof NotificationSystem !== 'undefined' && NotificationSystem.notifications) {
    NotificationSystem.notifications.forEach((notification) => {
      if (notification.read) return;
      notifications.push({
        title: notification.title || notification.message || 'Notifikation',
        message: notification.message,
        timestamp: notification.timestamp,
        source: 'system'
      });
    });
  }

  notifications.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

  if (!notifications.length) {
    list.innerHTML = '<div class="notif-empty">Ingen notifikationer</div>';
  } else {
    list.innerHTML = notifications.map(item => `
      <div class="topbar-dropdown-item notif-item">
        <div class="notif-content">
          <div class="notif-text">${escapeHtml(item.title || item.message || 'Notifikation')}</div>
          <div class="notif-time">${formatNotificationTime(item.timestamp)}</div>
        </div>
      </div>
    `).join('');
  }

  const count = notifications.length;
  if (badge) {
    badge.textContent = count;
    badge.style.display = count > 0 ? 'flex' : 'none';
  }
}

function markAllHeaderNotificationsRead() {
  const saved = JSON.parse(localStorage.getItem('orderflow_header_notifications') || '[]');
  const updated = saved.map(n => ({ ...n, read: true }));
  localStorage.setItem('orderflow_header_notifications', JSON.stringify(updated));
  if (typeof NotificationSystem !== 'undefined' && NotificationSystem.notifications) {
    NotificationSystem.notifications.forEach((notification, path) => {
      if (!notification.read) {
        NotificationSystem.markRead(path);
      }
    });
  }
  renderHeaderNotifications();
}

/**
 * Gem header notifikationer til localStorage
 */
function saveHeaderNotifications(notification) {
  const saved = JSON.parse(localStorage.getItem('orderflow_header_notifications') || '[]');
  saved.unshift({
    ...notification,
    timestamp: Date.now(),
    read: false
  });
  // Behold kun de sidste 10
  localStorage.setItem('orderflow_header_notifications', JSON.stringify(saved.slice(0, 10)));
}

/**
 * Send email med indstillings√¶ndringer
 * @param {string} email - Modtager email
 * @param {string} cc - CC email (valgfri)
 */
async function sendSettingsEmail(email, cc) {
  if (!email) return;

  // Brug eksisterende Edge Function til at sende email
  const supabaseUrl = window.SUPABASE_CONFIG?.url || 'https://qymtjhzgtcittohutmay.supabase.co';
  const supabaseKey = window.SUPABASE_CONFIG?.key || '';

  const response = await fetch(`${supabaseUrl}/functions/v1/send-otp-email`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${supabaseKey}`
    },
    body: JSON.stringify({
      to: email,
      otp: 'SETTINGS', // Special marker - not a real OTP
      appName: 'OrderFlow',
      subject: 'OrderFlow: Dine indstillinger er opdateret',
      // Custom template flag
      isSettingsEmail: true
    })
  });

  if (!response.ok) {
    throw new Error('Failed to send settings email');
  }

  console.log('‚úÖ Settings email sent to:', email);
}


// Gem momsindstillinger
function saveMomsSettings() {
  const momsRate = document.getElementById('moms-rate')?.value || '25';
  const showMoms = document.getElementById('show-moms')?.checked || true;
  
  localStorage.setItem('orderflow_moms_settings', JSON.stringify({
    rate: parseFloat(momsRate),
    showOnReceipt: showMoms
  }));

  showSaveStatus('moms-save-status', 'saved');
}

// Gem sprogindstillinger
function saveLanguage() {
  const language = document.getElementById('language-select')?.value || 'da';

  localStorage.setItem('orderflow_language', language);

  showSaveStatus('language-save-status', 'saved');
}

// Gem bankindstillinger
function saveBankSettings() {
  const bankName = document.getElementById('bank-name')?.value || '';
  const regNumber = document.getElementById('bank-reg')?.value || '';
  const accountNumber = document.getElementById('bank-account')?.value || '';

  localStorage.setItem('orderflow_bank_settings', JSON.stringify({
    bankName,
    regNumber,
    accountNumber
  }));
}

// Gem virksomhedsoplysninger
function saveCompanySettings() {
  const cvr = document.getElementById('company-cvr')?.value || '';
  const phone = document.getElementById('company-phone')?.value || '';
  const email = document.getElementById('company-invoice-email')?.value || '';
  const address = document.getElementById('company-address')?.value || '';
  const postalCode = document.getElementById('company-zip')?.value || '';
  const city = document.getElementById('company-city')?.value || '';

  localStorage.setItem('orderflow_company_settings', JSON.stringify({
    cvr,
    phone,
    email,
    address,
    postalCode,
    city
  }));
}

// Gem alle bank- og virksomhedsoplysninger
function saveAllBankSettings() {
  saveBankSettings();
  saveCompanySettings();
  showSaveStatus('bank-save-status', 'saved');
}

// Indl√¶s bankindstillinger
function loadBankSettings() {
  const bankSettings = JSON.parse(localStorage.getItem('orderflow_bank_settings') || '{}');
  const companySettings = JSON.parse(localStorage.getItem('orderflow_company_settings') || '{}');

  if (bankSettings.bankName) document.getElementById('bank-name').value = bankSettings.bankName;
  if (bankSettings.regNumber) document.getElementById('bank-reg').value = bankSettings.regNumber;
  if (bankSettings.accountNumber) document.getElementById('bank-account').value = bankSettings.accountNumber;

  if (companySettings.cvr) document.getElementById('company-cvr').value = companySettings.cvr;
  if (companySettings.phone) document.getElementById('company-phone').value = companySettings.phone;
  if (companySettings.email) document.getElementById('company-invoice-email').value = companySettings.email;
  if (companySettings.address) document.getElementById('company-address').value = companySettings.address;
  if (companySettings.postalCode) document.getElementById('company-zip').value = companySettings.postalCode;
  if (companySettings.city) document.getElementById('company-city').value = companySettings.city;
}

// Toggle password visibility
function togglePasswordVisibility(inputId, button) {
  const input = document.getElementById(inputId);
  if (!input) return;

  const isPassword = input.type === 'password';
  input.type = isPassword ? 'text' : 'password';

  // Update icon - show eye-off when password is visible, eye when hidden
  const svg = button.querySelector('svg');
  if (svg) {
    if (isPassword) {
      // Eye-off icon (password is now visible)
      svg.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>';
    } else {
      // Eye icon (password is now hidden)
      svg.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
    }
  }
}

// Skift adgangskode
function changePassword() {
  const currentPassword = document.getElementById('current-password')?.value || '';
  const newPassword = document.getElementById('new-password')?.value || '';
  const confirmPassword = document.getElementById('confirm-password')?.value || '';

  if (!currentPassword || !newPassword || !confirmPassword) {
    showSaveStatus('password-save-status', 'error');
    return;
  }

  if (newPassword !== confirmPassword) {
    showSaveStatus('password-save-status', 'error');
    return;
  }

  if (newPassword.length < 8) {
    showSaveStatus('password-save-status', 'error');
    return;
  }

  // I demo-mode simulerer vi bare at det lykkes
  if (CONFIG.DEMO_MODE) {
    showSaveStatus('password-save-status', 'saved');
    document.getElementById('current-password').value = '';
    document.getElementById('new-password').value = '';
    document.getElementById('confirm-password').value = '';
    return;
  }

  // Her ville normalt v√¶re et API-kald til at √¶ndre adgangskoden
  showSaveStatus('password-save-status', 'saved');
}

// Gem brugerindstillinger
function saveUserSettings() {
  const firstName = document.getElementById('user-firstname')?.value || '';
  const lastName = document.getElementById('user-lastname')?.value || '';
  const email = document.getElementById('user-email')?.value || '';
  const phone = document.getElementById('user-phone')?.value || '';

  // Gem til localStorage (demo mode)
  localStorage.setItem('orderflow_user_profile', JSON.stringify({
    firstName,
    lastName,
    email,
    phone
  }));

  // Vis status
  showSaveStatus('users-save-status', 'saved');
}

// Vis salgsoversigt
function loadSalgsoversigt() {
  const fromDate = document.getElementById('sales-from-date')?.value || '';
  const toDate = document.getElementById('sales-to-date')?.value || '';
  
  if (!fromDate || !toDate) {
    toast('V√¶lg dato interval', 'error');
    return;
  }
  
  // Demo data
  const demoSales = {
    total: Math.floor(Math.random() * 50000) + 10000,
    orders: Math.floor(Math.random() * 200) + 50,
    avgOrder: 0
  };
  demoSales.avgOrder = Math.round(demoSales.total / demoSales.orders);
  
  const salesContainer = document.getElementById('sales-overview-result');
  if (salesContainer) {
    salesContainer.innerHTML = `
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:16px">
        <div style="background:var(--bg3);padding:16px;border-radius:var(--radius-md);text-align:center">
          <div style="font-size:24px;font-weight:700;color:var(--accent)">${demoSales.total.toLocaleString('da-DK')} kr</div>
          <div style="font-size:12px;color:var(--muted);margin-top:4px">Total oms√¶tning</div>
        </div>
        <div style="background:var(--bg3);padding:16px;border-radius:var(--radius-md);text-align:center">
          <div style="font-size:24px;font-weight:700;color:var(--green)">${demoSales.orders}</div>
          <div style="font-size:12px;color:var(--muted);margin-top:4px">Antal ordrer</div>
        </div>
        <div style="background:var(--bg3);padding:16px;border-radius:var(--radius-md);text-align:center">
          <div style="font-size:24px;font-weight:700;color:var(--purple)">${demoSales.avgOrder} kr</div>
          <div style="font-size:12px;color:var(--muted);margin-top:4px">Gns. ordre</div>
        </div>
      </div>
      <p style="font-size:11px;color:var(--muted);margin-top:12px;text-align:center">Data fra ${fromDate} til ${toDate} (demo)</p>
    `;
    salesContainer.style.display = 'block';
  }
  
  toast('Salgsoversigt indl√¶st', 'success');
}

// Vis korttransaktioner
function loadKorttransaktioner() {
  const fromDate = document.getElementById('transactions-from-date')?.value || '';
  const toDate = document.getElementById('transactions-to-date')?.value || '';
  
  if (!fromDate || !toDate) {
    toast('V√¶lg dato interval', 'error');
    return;
  }
  
  // Demo transaktioner
  const demoTransactions = [];
  const numTransactions = Math.floor(Math.random() * 20) + 5;
  
  for (let i = 0; i < numTransactions; i++) {
    const date = new Date();
    date.setDate(date.getDate() - Math.floor(Math.random() * 30));
    
    demoTransactions.push({
      id: 'TXN' + Math.random().toString(36).substr(2, 8).toUpperCase(),
      date: date.toLocaleDateString('da-DK'),
      time: date.toLocaleTimeString('da-DK', { hour: '2-digit', minute: '2-digit' }),
      amount: Math.floor(Math.random() * 500) + 50,
      card: '**** ' + Math.floor(1000 + Math.random() * 9000),
      status: Math.random() > 0.1 ? 'Godkendt' : 'Afvist'
    });
  }
  
  const transContainer = document.getElementById('transactions-result');
  if (transContainer) {
    transContainer.innerHTML = `
      <div style="margin-top:16px;border:1px solid var(--border);border-radius:var(--radius-md);overflow:hidden">
        <div style="display:grid;grid-template-columns:100px 80px 100px 100px 100px;gap:8px;padding:12px;background:var(--bg);font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase">
          <div>ID</div>
          <div>Dato</div>
          <div>Bel√∏b</div>
          <div>Kort</div>
          <div>Status</div>
        </div>
        ${demoTransactions.map(t => `
          <div style="display:grid;grid-template-columns:100px 80px 100px 100px 100px;gap:8px;padding:12px;border-top:1px solid var(--border);font-size:13px">
            <div style="font-family:monospace;font-size:11px">${t.id}</div>
            <div>${t.date}</div>
            <div style="font-weight:600">${t.amount} kr</div>
            <div style="color:var(--muted)">${t.card}</div>
            <div style="color:${t.status === 'Godkendt' ? 'var(--green)' : 'var(--danger)'}">${t.status}</div>
          </div>
        `).join('')}
      </div>
      <p style="font-size:11px;color:var(--muted);margin-top:12px;text-align:center">${demoTransactions.length} transaktioner fundet (demo)</p>
    `;
    transContainer.style.display = 'block';
  }
  
  toast('Korttransaktioner indl√¶st', 'success');
}

// ==================== TEST FUNCTIONS ====================

/**
 * TEST FUNCTION - Demonstrer automatic real-time tracking
 * Kald denne funktion i browser console for at se hvordan
 * ActivityTracker automatisk tracker √¶ndringer
 */
function testAutoTracking() {
  console.log('ü§ñ Testing Automatic Real-Time Tracking...');
  console.log('');
  console.log('üìù For at teste automatic tracking:');
  console.log('');
  console.log('1Ô∏è‚É£ Tilf√∏j data-track attribut til et input felt:');
  console.log('   <input data-track="kunder:stamdata:navn" value="Demo Restaurant">');
  console.log('');
  console.log('2Ô∏è‚É£ √Ündr v√¶rdien i inputfeltet (skriv noget nyt)');
  console.log('');
  console.log('3Ô∏è‚É£ Aktiviteten logges AUTOMATISK efter 1 sekund!');
  console.log('   - Aktivitet tilf√∏jes til "Seneste Aktiviteter"');
  console.log('   - Bl√• prik vises automatisk i sidebar');
  console.log('   - Notifikation sendes til NotificationSystem');
  console.log('');
  console.log('üìä Eksempel data-track formater:');
  console.log('   data-track="kunder:stamdata:navn"          -> Kunder > Stamdata > navn felt');
  console.log('   data-track="workflow:nodes:title"          -> Workflow > Nodes > title felt');
  console.log('   data-track="indstillinger:general:email"   -> Indstillinger > General > email');
  console.log('');
  console.log('üí° ActivityTracker wrapper ogs√• automatisk alle save-funktioner:');
  console.log('   - saveStamdata()');
  console.log('   - saveProduct()');
  console.log('   - saveWorkflow()');
  console.log('   - saveSettings()');
  console.log('   - osv...');
  console.log('');
  console.log('‚ú® Systemet er nu HELT automatisk - ingen manuel logActivity() n√∏dvendig!');
}

/**
 * TEST FUNCTION - Clear all activities and notifications
 * Nyttig til at starte forfra under testing
 */
function clearAllActivities() {
  if (confirm('Er du sikker p√• at du vil slette ALLE aktiviteter og notifikationer?')) {
    localStorage.removeItem('orderflow_activity_log');
    if (typeof NotificationSystem !== 'undefined') {
      NotificationSystem.clear();
    }
    console.log('üóëÔ∏è Alle aktiviteter og notifikationer slettet!');
    console.log('üîÑ Refresh siden for at se √¶ndringerne...');

    // Refresh UI
    if (typeof updateRecentActivityUI === 'function') {
      updateRecentActivityUI();
    }
    if (typeof NotificationSystem !== 'undefined') {
      NotificationSystem.render();
    }
  }
}

// G√∏r tilg√¶ngelig i console
window.testActivityTracking = testActivityTracking;
window.testAutoTracking = testAutoTracking;
window.clearAllActivities = clearAllActivities;

// ============================================================================
// 2FA / OTP AUTHENTICATION FUNCTIONS
// ============================================================================

// Global state for 2FA flow
let pending2FAUser = null;
let pending2FASettings = null;
let current2FAMethod = 'totp';

/**
 * Check if user requires 2FA and handle challenge
 * Called after successful password authentication
 */
async function check2FARequired(user) {
  try {
    // Get user role
    let roleData = null;
    try {
      roleData = await SupabaseDB.getUserRole(user.id);
    } catch (e) {
      console.warn('Could not get user role from DB:', e);
    }

    const role = roleData?.role || user.role || 'customer';
    const isEmployee = role === 'admin' || role === 'employee';

    // Customers and demo users skip 2FA
    if (!isEmployee) {
      return { required: false, canProceed: true };
    }

    // Get 2FA settings - try database first, then localStorage
    let settings = null;
    try {
      settings = await SupabaseDB.get2FASettings(user.id);
    } catch (e) {
      console.warn('Could not get 2FA settings from DB:', e);
    }

    // Fallback to localStorage if DB settings not found
    if (!settings || (!settings.totp_enabled && !settings.email_otp_enabled)) {
      try {
        const localSettings = JSON.parse(localStorage.getItem('orderflow_2fa_settings') || '{}');
        if (localSettings.totp_enabled || localSettings.email_otp_enabled) {
          settings = localSettings;
          console.log('üì± Using 2FA settings from localStorage');
        }
      } catch (e) {
        console.warn('Could not get 2FA settings from localStorage:', e);
      }
    }

    // Check if 2FA is configured
    const hasTOTP = settings?.totp_enabled && settings?.totp_confirmed;
    const hasEmail = settings?.email_otp_enabled;
    const hasAny2FA = hasTOTP || hasEmail;

    console.log('üîê 2FA Check:', {
      role,
      settings,
      hasTOTP,
      hasEmail,
      hasAny2FA,
      totp_enabled: settings?.totp_enabled,
      totp_confirmed: settings?.totp_confirmed
    });

    // Employee without 2FA - require setup
    if (isEmployee && !hasAny2FA && role !== 'admin') {
      return {
        required: true,
        canProceed: false,
        requiresSetup: true,
        message: 'Du skal aktivere 2FA for at forts√¶tte'
      };
    }

    // Admin without 2FA - can proceed (optional)
    if (role === 'admin' && !hasAny2FA) {
      return { required: false, canProceed: true };
    }

    // Has 2FA - show challenge
    if (hasAny2FA) {
      return {
        required: true,
        canProceed: false,
        settings: settings,
        methods: {
          totp: hasTOTP,
          email: hasEmail
        }
      };
    }

    return { required: false, canProceed: true };
  } catch (err) {
    console.error('check2FARequired error:', err);
    return { required: false, canProceed: true, error: err.message };
  }
}

/**
 * Show 2FA challenge UI
 */
function show2FAChallenge(user, settings) {
  pending2FAUser = user;
  pending2FASettings = settings;

  // Hide login form, show 2FA challenge
  const loginForm = document.getElementById('login-form');
  const challengeForm = document.getElementById('2fa-challenge-form');
  const authTabs = document.querySelector('.auth-tabs');
  const demoButtons = document.getElementById('auth-demo-buttons');

  if (loginForm) loginForm.style.display = 'none';
  if (challengeForm) challengeForm.style.display = 'block';
  if (authTabs) authTabs.style.display = 'none';
  if (demoButtons) demoButtons.style.display = 'none';

  const cancelBtn = document.getElementById('2fa-cancel-btn');
  if (cancelBtn) {
    cancelBtn.disabled = false;
    cancelBtn.classList.remove('disabled');
  }

  attach2FAEnterHandlers();

  // Configure method tabs
  const methodTabs = document.getElementById('2fa-method-tabs');
  if (methodTabs) {
    const hasTOTP = settings?.totp_enabled && settings?.totp_confirmed;
    const hasEmail = settings?.email_otp_enabled;

    const totpTab = methodTabs.querySelector('[data-method="totp"]');
    const emailTab = methodTabs.querySelector('[data-method="email"]');

    if (totpTab) totpTab.style.display = hasTOTP ? 'flex' : 'none';
    if (emailTab) emailTab.style.display = hasEmail ? 'flex' : 'none';

    // Select first available method
    if (hasTOTP) {
      switch2FAMethod('totp');
    } else if (hasEmail) {
      switch2FAMethod('email');
    }
  }

  // Set email display
  const emailDisplay = document.getElementById('2fa-email-display');
  if (emailDisplay && user?.email) {
    emailDisplay.textContent = user.email;
  }

  // Focus code input
  setTimeout(() => {
    const input = document.getElementById('2fa-code-input');
    if (input) input.focus();
  }, 100);
}

function attach2FAEnterHandlers() {
  const inputs = [
    document.getElementById('2fa-code-input'),
    document.getElementById('2fa-email-code-input'),
    document.getElementById('2fa-backup-code-input')
  ].filter(Boolean);

  inputs.forEach((input) => {
    if (input.dataset.enterBound === 'true') {
      return;
    }
    input.dataset.enterBound = 'true';
    input.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        verify2FAChallenge();
      }
    });
  });
}

/**
 * Show 2FA setup required UI (for employees)
 */
function show2FASetupRequired(user) {
  pending2FAUser = user;

  // Hide all forms, show setup required
  const loginForm = document.getElementById('login-form');
  const challengeForm = document.getElementById('2fa-challenge-form');
  const setupRequired = document.getElementById('2fa-setup-required');
  const authTabs = document.querySelector('.auth-tabs');
  const demoButtons = document.getElementById('auth-demo-buttons');

  if (loginForm) loginForm.style.display = 'none';
  if (challengeForm) challengeForm.style.display = 'none';
  if (setupRequired) setupRequired.style.display = 'block';
  if (authTabs) authTabs.style.display = 'none';
  if (demoButtons) demoButtons.style.display = 'none';
}

/**
 * Switch between 2FA methods (TOTP/Email)
 */
function switch2FAMethod(method) {
  current2FAMethod = method;

  // Update tabs
  document.querySelectorAll('.2fa-method-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.method === method);
    if (tab.dataset.method === method) {
      tab.style.background = 'var(--accent-dim)';
      tab.style.borderColor = 'var(--accent)';
    } else {
      tab.style.background = '';
      tab.style.borderColor = '';
    }
  });

  // Show/hide inputs
  const totpInput = document.getElementById('2fa-totp-input');
  const emailInput = document.getElementById('2fa-email-input');

  if (totpInput) totpInput.style.display = method === 'totp' ? 'block' : 'none';
  if (emailInput) emailInput.style.display = method === 'email' ? 'block' : 'none';

  // If switching to email, send OTP automatically
  if (method === 'email' && pending2FAUser) {
    send2FAEmailOTP();
  }

  // Focus appropriate input
  setTimeout(() => {
    const inputId = method === 'totp' ? '2fa-code-input' : '2fa-email-code-input';
    const input = document.getElementById(inputId);
    if (input) input.focus();
  }, 100);
}

/**
 * Toggle backup code input visibility
 */
function toggle2FABackupInput() {
  const backupInput = document.getElementById('2fa-backup-input');
  if (backupInput) {
    const isVisible = backupInput.style.display !== 'none';
    backupInput.style.display = isVisible ? 'none' : 'block';

    if (!isVisible) {
      const input = document.getElementById('2fa-backup-code-input');
      if (input) input.focus();
    }
  }
}

/**
 * Send 2FA email OTP
 */
async function send2FAEmailOTP() {
  if (!pending2FAUser?.email) return;

  const resendBtn = document.getElementById('2fa-resend-btn');
  if (resendBtn) {
    resendBtn.disabled = true;
    resendBtn.textContent = 'Sender...';
  }

  try {
    // Generate OTP via EmailOTP module
    const result = await window.EmailOTP?.generate(
      pending2FAUser.email,
      { userId: pending2FAUser.id },
      async (emailData) => {
        // Send via Edge Function
        const response = await fetch(`${SUPABASE_CONFIG?.url || 'https://qymtjhzgtcittohutmay.supabase.co'}/functions/v1/send-otp-email`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_CONFIG?.key || ''}`
          },
          body: JSON.stringify({
            to: emailData.to,
            otp: emailData.otp,
            appName: 'OrderFlow'
          })
        });

        if (!response.ok) {
          throw new Error('Failed to send email');
        }
      }
    );

    if (result?.success) {
      toast('Kode sendt til din email', 'success');
    } else {
      toast(result?.error || 'Kunne ikke sende kode', 'error');
    }
  } catch (err) {
    console.error('send2FAEmailOTP error:', err);
    toast('Fejl ved afsendelse af kode', 'error');
  } finally {
    if (resendBtn) {
      resendBtn.disabled = false;
      resendBtn.textContent = 'Send ny kode';
    }
  }
}

/**
 * Resend 2FA email OTP
 */
async function resend2FAEmail() {
  await send2FAEmailOTP();
}

/**
 * Verify 2FA challenge
 */
async function verify2FAChallenge() {
  const verifyBtn = document.getElementById('2fa-verify-btn');
  if (verifyBtn) {
    verifyBtn.disabled = true;
    verifyBtn.textContent = 'Verificerer...';
  }

  try {
    let code = '';
    let method = current2FAMethod;

    // Check for backup code first
    const backupInput = document.getElementById('2fa-backup-input');
    const backupCode = document.getElementById('2fa-backup-code-input')?.value?.trim();

    if (backupInput?.style.display !== 'none' && backupCode) {
      code = backupCode.replace(/-/g, '');
      method = 'backup';
    } else if (current2FAMethod === 'email') {
      code = document.getElementById('2fa-email-code-input')?.value?.trim() || '';
    } else {
      code = document.getElementById('2fa-code-input')?.value?.trim() || '';
    }

    if (!code) {
      toast('Indtast en kode', 'error');
      return;
    }

    let result;

    if (method === 'email') {
      // Verify email OTP
      result = await window.EmailOTP?.verify(pending2FAUser.email, code);
    } else {
      // Verify TOTP or backup code (use email as userId for consistency)
      result = await window.TOTP2FA?.verify(pending2FAUser.email, code);
    }

    if (result?.success) {
      // Update last used timestamp in database
      if (typeof SupabaseDB !== 'undefined') {
        SupabaseDB.update2FASettings(pending2FAUser.id, {
          last_used_at: new Date().toISOString()
        });

        // Update backup codes if one was used
        if (result.method === 'backup' && result.backupCodesRemaining !== undefined) {
          // Would need to sync with database here
        }
      }

      // 2FA successful - complete login
      currentUser = pending2FAUser;
      pending2FAUser = null;
      pending2FASettings = null;

      // Load user data and show app
      await completeLogin();

    } else {
      toast(result?.error || 'Ugyldig kode', 'error');

      // Clear input on error
      const inputId = method === 'email' ? '2fa-email-code-input' :
                      method === 'backup' ? '2fa-backup-code-input' : '2fa-code-input';
      const input = document.getElementById(inputId);
      if (input) {
        input.value = '';
        input.focus();
      }
    }

  } catch (err) {
    console.error('verify2FAChallenge error:', err);
    toast('Fejl ved verificering', 'error');
  } finally {
    if (verifyBtn) {
      verifyBtn.disabled = false;
      verifyBtn.textContent = 'Bekr√¶ft';
    }
  }
}

/**
 * Complete login after 2FA verification
 */
async function completeLogin() {
  try {
    // Get pending login data
    const pendingData = window._pending2FALogin;
    if (pendingData && pendingData.user) {
      currentUser = pendingData.user;
    }

    // Clean up pending data
    window._pending2FALogin = null;
    pending2FAUser = null;
    pending2FASettings = null;

    // Load restaurants from Supabase
    if (typeof SupabaseDB !== 'undefined' && currentUser) {
      const dbRestaurants = await SupabaseDB.getRestaurants(currentUser.id);
      restaurants = dbRestaurants || [];
      loadPersistedRestaurants();

      if (typeof RealtimeSync !== 'undefined') {
        await RealtimeSync.init(currentUser.id);
      }
    }

    // Play login animation (same as normal login)
    await playLoginTransition();

    showApp();

    logActivity('login', '2FA login succesfuld', {
      category: 'system',
      user: currentUser.email,
      role: currentUser.role
    });

  } catch (err) {
    console.error('completeLogin error:', err);
    showApp(); // Show app anyway
  }
}

/**
 * Cancel 2FA challenge and return to login
 */
function cancel2FAChallenge() {
  pending2FAUser = null;
  pending2FASettings = null;
  window._pending2FALogin = null;

  // Sign out from Supabase since login was cancelled
  if (typeof supabaseClient !== 'undefined' && supabaseClient) {
    supabaseClient.auth.signOut().catch(err => {
      console.warn('Could not sign out after 2FA cancel:', err);
    });
  }

  // Show login form, hide challenge
  const loginForm = document.getElementById('login-form');
  const challengeForm = document.getElementById('2fa-challenge-form');
  const authTabs = document.querySelector('.auth-tabs');
  const demoButtons = document.getElementById('auth-demo-buttons');

  if (loginForm) loginForm.style.display = 'block';
  if (challengeForm) challengeForm.style.display = 'none';
  if (authTabs) authTabs.style.display = 'flex';
  if (demoButtons) demoButtons.style.display = 'block';

  // Clear inputs
  const codeInput = document.getElementById('2fa-code-input');
  const emailInput = document.getElementById('2fa-email-code-input');
  const backupInput = document.getElementById('2fa-backup-code-input');
  if (codeInput) codeInput.value = '';
  if (emailInput) emailInput.value = '';
  if (backupInput) backupInput.value = '';
}

/**
 * Setup 2FA from login screen (for employees without 2FA)
 */
async function setup2FAFromLogin(method) {
  if (!pending2FAUser) return;

  if (method === 'email') {
    // Enable email OTP directly
    const result = await SupabaseDB?.enableEmailOTP(pending2FAUser.id);
    if (result?.success) {
      toast('Email 2FA aktiveret', 'success');
      // Now show challenge
      const settings = await SupabaseDB?.get2FASettings(pending2FAUser.id);
      show2FAChallenge(pending2FAUser, settings);
    } else {
      toast('Kunne ikke aktivere email 2FA', 'error');
    }
  } else if (method === 'totp') {
    // Show TOTP setup - would need to implement inline setup
    // For now, complete login and redirect to settings
    currentUser = pending2FAUser;
    pending2FAUser = null;
    await completeLogin();
    // Navigate to 2FA settings
    setTimeout(() => {
      showSettings('passwords');
      toast('Konfigurer venligst din authenticator app', 'info');
    }, 500);
  }
}

/**
 * Cancel 2FA setup from login and logout
 */
function cancel2FASetupFromLogin() {
  pending2FAUser = null;
  pending2FASettings = null;
  window._pending2FALogin = null;

  // Sign out from Supabase
  if (typeof supabaseClient !== 'undefined' && supabaseClient) {
    supabaseClient.auth.signOut();
  }

  // Reset UI
  const loginForm = document.getElementById('login-form');
  const setupRequired = document.getElementById('2fa-setup-required');
  const authTabs = document.querySelector('.auth-tabs');
  const demoButtons = document.getElementById('auth-demo-buttons');

  if (loginForm) loginForm.style.display = 'block';
  if (setupRequired) setupRequired.style.display = 'none';
  if (authTabs) authTabs.style.display = 'flex';
  if (demoButtons) demoButtons.style.display = 'block';
}

// ============================================================================
// 2FA SETTINGS FUNCTIONS (for index.html settings page)
// ============================================================================

/**
 * Initialize 2FA settings page
 */
async function init2FASettings() {
  if (!currentUser) return;

  try {
    // Get settings from localStorage first (always available)
    const localSettings = JSON.parse(localStorage.getItem('orderflow_2fa_settings') || '{}');
    let settings = { ...localSettings };

    // Try to get from database if available (non-blocking)
    if (typeof window.SupabaseDB !== 'undefined' && window.SupabaseDB.get2FASettings) {
      try {
        const dbSettings = await window.SupabaseDB.get2FASettings(currentUser.id);
        if (dbSettings) {
          settings = { ...settings, ...dbSettings };
          if (localSettings.totp_enabled && !settings.totp_enabled) {
            settings.totp_enabled = true;
          }
          if (localSettings.totp_confirmed && !settings.totp_confirmed) {
            settings.totp_confirmed = true;
          }
          if (localSettings.email_otp_enabled && !settings.email_otp_enabled) {
            settings.email_otp_enabled = true;
          }
          // Sync to localStorage
          localStorage.setItem('orderflow_2fa_settings', JSON.stringify(settings));
        }
      } catch (dbErr) {
        console.warn('Database read failed, using localStorage:', dbErr);
      }
    }

    const role = currentUser.role || 'customer';
    const isEmployee = role === 'employee';
    const isAdmin = role === 'admin';

    // Show employee warning if applicable
    const warning = document.getElementById('2fa-employee-warning');
    if (warning) {
      warning.style.display = isEmployee ? 'block' : 'none';
    }

    // Update TOTP status
    const totpEnabled = settings?.totp_enabled;
    const totpConfirmed = settings?.totp_confirmed;
    const hasTOTP = totpEnabled && totpConfirmed;
    const totpToggle = document.getElementById('2fa-totp-toggle');
    const totpStatus = document.getElementById('2fa-totp-status');
    const totpBtn = document.getElementById('2fa-totp-btn');

    // Update toggle state
    if (totpToggle) {
      totpToggle.checked = hasTOTP;
      totpToggle.disabled = false;
    }

    // Legacy support for old UI elements
    if (totpStatus) {
      totpStatus.style.display = 'inline-block';
      totpStatus.textContent = hasTOTP ? 'Aktiv' : 'Ikke aktiv';
      totpStatus.style.background = hasTOTP ? 'var(--green)' : 'var(--muted)';
      totpStatus.style.color = 'white';
    }

    if (totpBtn) {
      totpBtn.textContent = hasTOTP ? 'Deaktiver' : 'Aktiv√©r';
      totpBtn.onclick = hasTOTP ? deactivateTOTP : setup2FATOTP;
    }

    const setupDiv = document.getElementById('2fa-totp-setup');
    if (setupDiv) {
      const inSetup = totpEnabled && !totpConfirmed;
      setupDiv.style.display = inSetup ? 'block' : 'none';
      if (inSetup && settings?.totp_secret && currentUser?.email) {
        const secretCode = document.getElementById('2fa-secret-code');
        if (secretCode) {
          secretCode.textContent = settings.totp_secret;
        }

        const qrImg = document.getElementById('2fa-qr-code');
        if (qrImg && window.TOTP2FA?.utils?.generateOtpauthUrl) {
          const otpauthUrl = window.TOTP2FA.utils.generateOtpauthUrl(currentUser.email, settings.totp_secret);
          render2FAQrCode(otpauthUrl);
        }
      }
    }

    // Update Email OTP status
    const hasEmail = settings?.email_otp_enabled;
    const emailToggle = document.getElementById('2fa-email-toggle');
    const emailStatus = document.getElementById('2fa-email-status');
    const emailBtn = document.getElementById('2fa-email-btn');

    // Update toggle state
    if (emailToggle) {
      emailToggle.checked = hasEmail;
      emailToggle.disabled = false;
    }

    // Legacy support for old UI elements
    if (emailStatus) {
      emailStatus.style.display = 'inline-block';
      emailStatus.textContent = hasEmail ? 'Aktiv' : 'Ikke aktiv';
      emailStatus.style.background = hasEmail ? 'var(--green)' : 'var(--muted)';
      emailStatus.style.color = 'white';
    }

    if (emailBtn) {
      emailBtn.textContent = hasEmail ? 'Deaktiver' : 'Aktiv√©r';
    }

    // Show email address
    const emailAddress = document.getElementById('2fa-email-address');
    if (emailAddress && currentUser.email) {
      emailAddress.textContent = currentUser.email;
    }

    // Show backup codes section if any 2FA is enabled
    const backupSection = document.getElementById('2fa-backup-section');
    if (backupSection) {
      backupSection.style.display = (hasTOTP || hasEmail) ? 'block' : 'none';
    }

    // Update backup codes count
    const backupCount = document.getElementById('2fa-backup-count');
    if (backupCount && settings?.backup_codes_remaining !== undefined) {
      backupCount.textContent = `${settings.backup_codes_remaining} koder tilbage`;
    }

    // Show disable section for admin only
    const disableSection = document.getElementById('2fa-disable-section');
    if (disableSection) {
      disableSection.style.display = isAdmin && (hasTOTP || hasEmail) ? 'block' : 'none';
    }

  } catch (err) {
    console.error('init2FASettings error:', err);
  }
}

/**
 * Setup TOTP 2FA
 */
async function setup2FATOTP() {
  if (!currentUser) return;

  try {
    // Generate TOTP secret using local TOTP2FA module
    const result = await window.TOTP2FA?.enable(currentUser.email, 'OrderFlow');

    if (!result?.success) {
      toast(result?.error || 'Kunne ikke starte 2FA ops√¶tning', 'error');
      return;
    }

    // Save to localStorage (works without database)
    const settings = JSON.parse(localStorage.getItem('orderflow_2fa_settings') || '{}');
    settings.totp_enabled = true;
    settings.totp_secret = result.secret;
    settings.totp_confirmed = false;
    settings.backup_codes = result.backupCodes;
    localStorage.setItem('orderflow_2fa_settings', JSON.stringify(settings));

    // Also try database if available (non-blocking)
    if (typeof window.SupabaseDB !== 'undefined' && window.SupabaseDB.enableTOTP) {
      try {
        await window.SupabaseDB.enableTOTP(currentUser.id, result.secret, result.backupCodes);
      } catch (dbErr) {
        console.warn('Database save failed, using localStorage:', dbErr);
      }
    }

    // Show setup UI
    const setupDiv = document.getElementById('2fa-totp-setup');
    if (setupDiv) {
      setupDiv.style.display = 'block';
    }

    // Display secret code
    const secretCode = document.getElementById('2fa-secret-code');
    if (secretCode) {
      secretCode.textContent = result.secret;
    }

    // Generate QR code
    render2FAQrCode(result.otpauthUrl);

    // Store backup codes for display after confirmation
    window._pending2FABackupCodes = result.backupCodes;

    toast('Scan QR-koden med din authenticator app', 'success');

  } catch (err) {
    console.error('setup2FATOTP error:', err);
    toast('Fejl ved ops√¶tning af 2FA', 'error');
  }
}

function render2FAQrCode(otpauthUrl) {
  const container = document.getElementById('2fa-qr-container');
  if (!container) return;

  // Clear previous QR content
  container.innerHTML = '';

  // Try QRCode.toDataURL first (from qrcode npm package)
  if (typeof QRCode !== 'undefined' && typeof QRCode.toDataURL === 'function') {
    QRCode.toDataURL(otpauthUrl, {
      width: 200,
      margin: 1,
      color: { dark: '#000000', light: '#ffffff' }
    }).then((qrDataUrl) => {
      const img = document.createElement('img');
      img.width = 200;
      img.height = 200;
      img.alt = 'QR Code';
      img.style.display = 'block';
      img.src = qrDataUrl;
      container.appendChild(img);
      console.log('‚úÖ QR code generated with toDataURL');
    }).catch((qrErr) => {
      console.error('QR code generation error:', qrErr);
      container.innerHTML = `<p style="color:#000;font-size:12px;word-break:break-all;padding:10px;">${otpauthUrl}</p>`;
    });
    return;
  }

  // Fallback to QRCode constructor (from qrcodejs library)
  if (typeof QRCode !== 'undefined' && typeof QRCode === 'function') {
    try {
      const temp = document.createElement('div');
      temp.style.position = 'fixed';
      temp.style.left = '-9999px';
      temp.style.top = '-9999px';
      document.body.appendChild(temp);

      new QRCode(temp, {
        text: otpauthUrl,
        width: 200,
        height: 200,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel ? QRCode.CorrectLevel.M : 2
      });

      setTimeout(() => {
        const rendered = temp.querySelector('img') || temp.querySelector('canvas');
        if (rendered) {
          const img = document.createElement('img');
          img.width = 200;
          img.height = 200;
          img.alt = 'QR Code';
          img.style.display = 'block';
          img.src = rendered.tagName === 'CANVAS' ? rendered.toDataURL('image/png') : rendered.src;
          container.appendChild(img);
          console.log('‚úÖ QR code generated with constructor');
        } else {
          container.innerHTML = `<p style="color:#000;font-size:12px;word-break:break-all;padding:10px;">${otpauthUrl}</p>`;
        }
        temp.remove();
      }, 100);
    } catch (e) {
      console.error('QRCode constructor error:', e);
      container.innerHTML = `<p style="color:#000;font-size:12px;word-break:break-all;padding:10px;">${otpauthUrl}</p>`;
    }
    return;
  }

  console.warn('QRCode library not available');
  container.innerHTML = `<p style="color:#000;font-size:12px;word-break:break-all;padding:10px;">${otpauthUrl}</p>`;
}

/**
 * Confirm TOTP 2FA setup
 */
async function confirm2FATOTP() {
  const code = document.getElementById('2fa-totp-verify-code')?.value?.trim();

  if (!code || code.length !== 6) {
    toast('Indtast 6-cifret kode', 'error');
    return;
  }

  try {
    // Verify the code using local TOTP module
    const result = await window.TOTP2FA?.confirm(currentUser.email, code);

    if (result?.success) {
      // Update localStorage
      const settings = JSON.parse(localStorage.getItem('orderflow_2fa_settings') || '{}');
      settings.totp_confirmed = true;
      localStorage.setItem('orderflow_2fa_settings', JSON.stringify(settings));

      // Also try database if available (non-blocking)
      if (typeof window.SupabaseDB !== 'undefined' && window.SupabaseDB.confirmTOTP) {
        try {
          await window.SupabaseDB.confirmTOTP(currentUser.id);
        } catch (dbErr) {
          console.warn('Database confirm failed, using localStorage:', dbErr);
        }
      }

      toast('2FA aktiveret!', 'success');

      // Hide setup UI
      const setupDiv = document.getElementById('2fa-totp-setup');
      if (setupDiv) {
        setupDiv.style.display = 'none';
      }

      // Show backup codes
      if (window._pending2FABackupCodes) {
        showBackupCodesModal(window._pending2FABackupCodes);
        delete window._pending2FABackupCodes;
      }

      // Refresh settings
      init2FASettings();

    } else {
      toast(result?.error || 'Ugyldig kode', 'error');
      document.getElementById('2fa-totp-verify-code').value = '';
    }

  } catch (err) {
    console.error('confirm2FATOTP error:', err);
    toast('Fejl ved bekr√¶ftelse', 'error');
  }
}

/**
 * Cancel 2FA setup
 */
function cancel2FASetup() {
  // Nulstil localStorage flags - vigtig for at forhindre at setup UI vises igen
  const settings = JSON.parse(localStorage.getItem('orderflow_2fa_settings') || '{}');
  settings.totp_enabled = false;
  settings.totp_secret = null;
  settings.totp_confirmed = false;
  localStorage.setItem('orderflow_2fa_settings', JSON.stringify(settings));

  // Skjul setup div
  const setupDiv = document.getElementById('2fa-totp-setup');
  if (setupDiv) {
    setupDiv.style.display = 'none';
  }

  // Nulstil toggle
  const toggle = document.getElementById('2fa-totp-toggle');
  if (toggle) toggle.checked = false;

  // Clear inputs og pending data
  const verifyCode = document.getElementById('2fa-totp-verify-code');
  if (verifyCode) verifyCode.value = '';
  delete window._pending2FABackupCodes;

  // Refresh UI state
  init2FASettings();
}

/**
 * Deactivate TOTP 2FA
 */
async function deactivateTOTP() {
  const code = prompt('Indtast din nuv√¶rende 2FA kode for at deaktivere:');
  if (!code) return;

  try {
    const result = await window.TOTP2FA?.disable(currentUser.email, code);

    if (result?.success) {
      // Update localStorage
      const settings = JSON.parse(localStorage.getItem('orderflow_2fa_settings') || '{}');
      settings.totp_enabled = false;
      settings.totp_secret = null;
      settings.totp_confirmed = false;
      localStorage.setItem('orderflow_2fa_settings', JSON.stringify(settings));

      // Also try database if available (non-blocking)
      if (typeof window.SupabaseDB !== 'undefined') {
        try {
          await window.SupabaseDB.update2FASettings(currentUser.id, {
            totp_enabled: false,
            totp_secret: null,
            totp_confirmed: false
          });
        } catch (dbErr) {
          console.warn('Database update failed, using localStorage:', dbErr);
        }
      }

      toast('TOTP deaktiveret', 'success');
      init2FASettings();
    } else {
      toast(result?.error || 'Kunne ikke deaktivere', 'error');
    }
  } catch (err) {
    console.error('deactivateTOTP error:', err);
    toast('Fejl', 'error');
  }
}

/**
 * Toggle Email OTP
 */
async function toggle2FAEmail() {
  if (!currentUser) return;

  try {
    // Get current settings from localStorage
    const settings = JSON.parse(localStorage.getItem('orderflow_2fa_settings') || '{}');
    const hasEmail = settings.email_otp_enabled;

    if (hasEmail) {
      // Check if can disable (must have another method or be admin)
      const hasTOTP = settings.totp_enabled && settings.totp_confirmed;
      const role = currentUser.role;

      if (!hasTOTP && role === 'employee') {
        toast('Du skal have mindst √©n 2FA metode aktiveret', 'error');
        return;
      }

      // Disable
      settings.email_otp_enabled = false;
      localStorage.setItem('orderflow_2fa_settings', JSON.stringify(settings));
      toast('Email 2FA deaktiveret', 'success');

    } else {
      // Enable
      settings.email_otp_enabled = true;
      localStorage.setItem('orderflow_2fa_settings', JSON.stringify(settings));
      toast('Email 2FA aktiveret', 'success');
    }

    // Also try database if available (non-blocking)
    if (typeof window.SupabaseDB !== 'undefined') {
      try {
        if (hasEmail) {
          await window.SupabaseDB.update2FASettings(currentUser.id, { email_otp_enabled: false });
        } else {
          await window.SupabaseDB.enableEmailOTP(currentUser.id);
        }
      } catch (dbErr) {
        console.warn('Database update failed, using localStorage:', dbErr);
      }
    }

    init2FASettings();

  } catch (err) {
    console.error('toggle2FAEmail error:', err);
    toast('Fejl', 'error');
  }
}

/**
 * Handle TOTP toggle change
 * @param {boolean} checked - Whether toggle is checked
 */
async function handleTOTPToggle(checked) {
  const toggle = document.getElementById('2fa-totp-toggle');
  const emailToggle = document.getElementById('2fa-email-toggle');

  if (!currentUser) {
    if (toggle) toggle.checked = !checked;
    return;
  }

  if (checked) {
    // Deaktiver E-mail Kode hvis den er aktiv (mutually exclusive)
    const settings = JSON.parse(localStorage.getItem('orderflow_2fa_settings') || '{}');
    if (settings.email_otp_enabled) {
      settings.email_otp_enabled = false;
      localStorage.setItem('orderflow_2fa_settings', JSON.stringify(settings));
      if (emailToggle) emailToggle.checked = false;
    }

    // Enable TOTP - start setup process
    await setup2FATOTP();
  } else {
    // Disable TOTP
    await deactivateTOTP();
  }

  // Refresh toggle state after action
  init2FASettings();
}

/**
 * Handle Email OTP toggle change
 * @param {boolean} checked - Whether toggle is checked
 */
async function handleEmailToggle(checked) {
  const toggle = document.getElementById('2fa-email-toggle');
  const totpToggle = document.getElementById('2fa-totp-toggle');

  if (!currentUser) {
    if (toggle) toggle.checked = !checked;
    return;
  }

  try {
    // Get settings from localStorage
    const settings = JSON.parse(localStorage.getItem('orderflow_2fa_settings') || '{}');

    if (!checked) {
      // Disable E-mail OTP
      settings.email_otp_enabled = false;
      localStorage.setItem('orderflow_2fa_settings', JSON.stringify(settings));
      toast('E-mail 2FA deaktiveret', 'success');

    } else {
      // Deaktiver Authenticator App hvis den er aktiv (mutually exclusive)
      if (settings.totp_enabled && settings.totp_confirmed) {
        settings.totp_enabled = false;
        settings.totp_confirmed = false;
        settings.totp_secret = null;
        if (totpToggle) totpToggle.checked = false;
      }

      // Enable E-mail OTP
      settings.email_otp_enabled = true;
      localStorage.setItem('orderflow_2fa_settings', JSON.stringify(settings));
      toast('E-mail 2FA aktiveret. Ved login sendes en kode til din e-mail.', 'success');
    }

    // Also try database if available (non-blocking)
    if (typeof window.SupabaseDB !== 'undefined') {
      try {
        if (!checked) {
          await window.SupabaseDB.update2FASettings(currentUser.id, { email_otp_enabled: false });
        }
      } catch (dbErr) {
        console.warn('Database update failed, using localStorage:', dbErr);
      }
    }

    init2FASettings();

  } catch (err) {
    console.error('handleEmailToggle error:', err);
    toast('Fejl', 'error');
    // Revert toggle on error
    if (toggle) toggle.checked = !checked;
  }
}

/**
 * Show backup codes
 */
function showBackupCodes() {
  const display = document.getElementById('2fa-backup-codes-display');
  if (display) {
    display.style.display = 'block';
    // Would need to fetch from TOTP2FA or database
    const list = document.getElementById('2fa-backup-codes-list');
    if (list) {
      list.innerHTML = '<p style="color:var(--muted);font-size:13px">Backup koder er krypteret. Kontakt support hvis du har brug for nye.</p>';
    }
  }
}

/**
 * Hide backup codes
 */
function hideBackupCodes() {
  const display = document.getElementById('2fa-backup-codes-display');
  if (display) {
    display.style.display = 'none';
  }
}

/**
 * Show backup codes modal after TOTP setup
 */
function showBackupCodesModal(codes) {
  const list = document.getElementById('2fa-backup-codes-list');
  if (list && codes) {
    list.innerHTML = codes.map(code =>
      `<code style="background:var(--bg2);padding:8px;border-radius:4px;font-size:14px;text-align:center">${code}</code>`
    ).join('');

    const display = document.getElementById('2fa-backup-codes-display');
    if (display) {
      display.style.display = 'block';
    }

    // Also show the backup section
    const section = document.getElementById('2fa-backup-section');
    if (section) {
      section.style.display = 'block';
    }
  }
}

/**
 * Regenerate backup codes
 */
async function regenerateBackupCodes() {
  const code = prompt('Indtast din nuv√¶rende 2FA kode for at generere nye backup koder:');
  if (!code) return;

  try {
    const result = await window.TOTP2FA?.regenerateBackupCodes(currentUser.email, code);

    if (result?.success) {
      showBackupCodesModal(result.backupCodes);
      toast('Nye backup koder genereret', 'success');
      init2FASettings();
    } else {
      toast(result?.error || 'Kunne ikke generere nye koder', 'error');
    }
  } catch (err) {
    console.error('regenerateBackupCodes error:', err);
    toast('Fejl', 'error');
  }
}

/**
 * Disable all 2FA (admin only)
 */
async function disable2FA() {
  if (currentUser?.role !== 'admin') {
    toast('Kun administratorer kan deaktivere 2FA helt', 'error');
    return;
  }

  if (!confirm('Er du sikker p√• at du vil deaktivere al 2FA? Dette reducerer sikkerheden p√• din konto.')) {
    return;
  }

  try {
    await SupabaseDB?.disable2FA(currentUser.id);
    toast('2FA deaktiveret', 'success');
    init2FASettings();
  } catch (err) {
    console.error('disable2FA error:', err);
    toast('Fejl ved deaktivering', 'error');
  }
}

// Export 2FA functions to window
window.check2FARequired = check2FARequired;
window.show2FAChallenge = show2FAChallenge;
window.show2FASetupRequired = show2FASetupRequired;
window.switch2FAMethod = switch2FAMethod;
window.toggle2FABackupInput = toggle2FABackupInput;
window.send2FAEmailOTP = send2FAEmailOTP;
window.resend2FAEmail = resend2FAEmail;
window.verify2FAChallenge = verify2FAChallenge;
window.cancel2FAChallenge = cancel2FAChallenge;
window.setup2FAFromLogin = setup2FAFromLogin;
window.cancel2FASetupFromLogin = cancel2FASetupFromLogin;
window.init2FASettings = init2FASettings;
window.setup2FATOTP = setup2FATOTP;
window.confirm2FATOTP = confirm2FATOTP;
window.cancel2FASetup = cancel2FASetup;
window.toggle2FAEmail = toggle2FAEmail;
window.showBackupCodes = showBackupCodes;
window.hideBackupCodes = hideBackupCodes;
window.regenerateBackupCodes = regenerateBackupCodes;
window.disable2FA = disable2FA;



// ===== Flatpickr Calendar Initialization =====
document.addEventListener('DOMContentLoaded', function() {
  // Initialize Flatpickr on all date inputs
  if (typeof flatpickr !== 'undefined') {
    flatpickr.localize(flatpickr.l10ns.da);

    document.querySelectorAll('input[type="date"]').forEach(function(input) {
      // Convert to text input for Flatpickr
      input.type = 'text';
      input.classList.add('flatpickr-input');

      flatpickr(input, {
        dateFormat: 'd.m.Y',
        locale: 'da',
        disableMobile: true,
        allowInput: true,
        defaultDate: input.value || null
      });
    });
  }
});


// ===== LOYALTY PROGRAM =====

// Loyalty data cache
let loyaltySettings = null;
let loyaltyRewards = [];
let loyaltyMembers = [];

// Tier colors and icons
const LOYALTY_TIERS = {
  bronze: { color: '#cd7f32', icon: '', name: 'Bronze' },
  silver: { color: '#c0c0c0', icon: '', name: 'S√∏lv' },
  gold: { color: '#ffd700', icon: '', name: 'Guld' },
  platinum: { color: '#e5e4e2', icon: '', name: 'Platin' }
};

// Get loyalty settings for restaurant
async function getLoyaltySettings(restaurantId) {
  if (!restaurantId) return null;

  try {
    const response = await fetch(
      `${CONFIG.SUPABASE_URL}/rest/v1/loyalty_settings?restaurant_id=eq.${restaurantId}&limit=1`,
      {
        headers: {
          'apikey': CONFIG.SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
        }
      }
    );

    if (!response.ok) return null;
    const data = await response.json();
    loyaltySettings = data[0] || null;
    return loyaltySettings;
  } catch (err) {
    console.error('getLoyaltySettings error:', err);
    return null;
  }
}

// Create default loyalty settings
async function createLoyaltySettings(restaurantId) {
  try {
    const defaultSettings = {
      restaurant_id: restaurantId,
      enabled: true,
      points_per_kr: 1,
      min_order_for_points: 50,
      welcome_bonus: 50,
      birthday_bonus: 100,
      tier_bronze_min: 0,
      tier_silver_min: 500,
      tier_gold_min: 1500,
      tier_platinum_min: 5000,
      silver_multiplier: 1.25,
      gold_multiplier: 1.5,
      platinum_multiplier: 2.0
    };

    const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/loyalty_settings`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': CONFIG.SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
        'Prefer': 'return=representation'
      },
      body: JSON.stringify(defaultSettings)
    });

    if (!response.ok) throw new Error('Failed to create settings');
    const data = await response.json();
    loyaltySettings = data[0];
    return loyaltySettings;
  } catch (err) {
    console.error('createLoyaltySettings error:', err);
    return null;
  }
}

// Get customer loyalty info
async function getCustomerLoyalty(phone, restaurantId) {
  if (!phone || !restaurantId) return null;

  const normalizedPhone = normalizePhoneNumber(phone).e164;

  try {
    const response = await fetch(
      `${CONFIG.SUPABASE_URL}/rest/v1/loyalty_points?customer_phone=eq.${encodeURIComponent(normalizedPhone)}&restaurant_id=eq.${restaurantId}&limit=1`,
      {
        headers: {
          'apikey': CONFIG.SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
        }
      }
    );

    if (!response.ok) return null;
    const data = await response.json();
    return data[0] || null;
  } catch (err) {
    console.error('getCustomerLoyalty error:', err);
    return null;
  }
}

// Create new loyalty member
async function createLoyaltyMember(phone, restaurantId, name = null) {
  const normalizedPhone = normalizePhoneNumber(phone).e164;

  // Get settings for welcome bonus
  const settings = await getLoyaltySettings(restaurantId);
  const welcomeBonus = settings?.welcome_bonus || 50;

  try {
    const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/loyalty_points`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': CONFIG.SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
        'Prefer': 'return=representation'
      },
      body: JSON.stringify({
        restaurant_id: restaurantId,
        customer_phone: normalizedPhone,
        customer_name: name,
        points: welcomeBonus,
        lifetime_points: welcomeBonus,
        tier: 'bronze'
      })
    });

    if (!response.ok) throw new Error('Failed to create member');
    const data = await response.json();

    // Log welcome bonus transaction
    if (welcomeBonus > 0) {
      await addLoyaltyTransaction(data[0].id, restaurantId, 'bonus', welcomeBonus, 'Velkomstbonus');
    }

    return data[0];
  } catch (err) {
    console.error('createLoyaltyMember error:', err);
    return null;
  }
}

// Add points to customer
async function addLoyaltyPoints(phone, restaurantId, orderAmount, orderId = null) {
  const normalizedPhone = normalizePhoneNumber(phone).e164;

  // Get or create loyalty member
  let member = await getCustomerLoyalty(normalizedPhone, restaurantId);
  if (!member) {
    member = await createLoyaltyMember(normalizedPhone, restaurantId);
    if (!member) return null;
  }

  // Get settings
  const settings = await getLoyaltySettings(restaurantId);
  if (!settings?.enabled) return member;

  // Check minimum order
  if (orderAmount < (settings.min_order_for_points || 0)) {
    return member;
  }

  // Calculate points with tier multiplier
  let multiplier = 1;
  if (member.tier === 'silver') multiplier = settings.silver_multiplier || 1.25;
  else if (member.tier === 'gold') multiplier = settings.gold_multiplier || 1.5;
  else if (member.tier === 'platinum') multiplier = settings.platinum_multiplier || 2.0;

  const basePoints = Math.floor(orderAmount * (settings.points_per_kr || 1));
  const earnedPoints = Math.floor(basePoints * multiplier);

  // Update member points
  const newPoints = member.points + earnedPoints;
  const newLifetime = member.lifetime_points + earnedPoints;
  const newTier = calculateTier(newLifetime, settings);

  try {
    const response = await fetch(
      `${CONFIG.SUPABASE_URL}/rest/v1/loyalty_points?id=eq.${member.id}`,
      {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'apikey': CONFIG.SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
          'Prefer': 'return=representation'
        },
        body: JSON.stringify({
          points: newPoints,
          lifetime_points: newLifetime,
          tier: newTier,
          updated_at: new Date().toISOString()
        })
      }
    );

    if (!response.ok) throw new Error('Failed to update points');
    const data = await response.json();

    // Log transaction
    await addLoyaltyTransaction(
      member.id,
      restaurantId,
      'earn',
      earnedPoints,
      `Ordre: ${orderAmount} kr (${multiplier}x bonus)`,
      orderId
    );

    // Check for tier upgrade
    if (newTier !== member.tier) {
      await addLoyaltyTransaction(
        member.id,
        restaurantId,
        'bonus',
        0,
        `Opgraderet til ${LOYALTY_TIERS[newTier].name}!`
      );
    }

    return data[0];
  } catch (err) {
    console.error('addLoyaltyPoints error:', err);
    return null;
  }
}

// Calculate tier based on lifetime points
function calculateTier(lifetimePoints, settings) {
  if (lifetimePoints >= (settings?.tier_platinum_min || 5000)) return 'platinum';
  if (lifetimePoints >= (settings?.tier_gold_min || 1500)) return 'gold';
  if (lifetimePoints >= (settings?.tier_silver_min || 500)) return 'silver';
  return 'bronze';
}

// Add loyalty transaction
async function addLoyaltyTransaction(loyaltyId, restaurantId, type, points, description, orderId = null) {
  try {
    await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/loyalty_transactions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': CONFIG.SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify({
        loyalty_id: loyaltyId,
        restaurant_id: restaurantId,
        type,
        points,
        description,
        order_id: orderId
      })
    });
  } catch (err) {
    console.error('addLoyaltyTransaction error:', err);
  }
}

// Get loyalty rewards
async function getLoyaltyRewards(restaurantId) {
  try {
    const response = await fetch(
      `${CONFIG.SUPABASE_URL}/rest/v1/loyalty_rewards?restaurant_id=eq.${restaurantId}&active=eq.true&order=points_required.asc`,
      {
        headers: {
          'apikey': CONFIG.SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
        }
      }
    );

    if (!response.ok) return [];
    loyaltyRewards = await response.json();
    return loyaltyRewards;
  } catch (err) {
    console.error('getLoyaltyRewards error:', err);
    return [];
  }
}

// Redeem loyalty reward
async function redeemLoyaltyReward(phone, restaurantId, rewardId) {
  const member = await getCustomerLoyalty(phone, restaurantId);
  if (!member) return { success: false, error: 'Kunde ikke fundet' };

  const rewards = await getLoyaltyRewards(restaurantId);
  const reward = rewards.find(r => r.id === rewardId);
  if (!reward) return { success: false, error: 'Bel√∏nning ikke fundet' };

  if (member.points < reward.points_required) {
    return { success: false, error: `Du mangler ${reward.points_required - member.points} points` };
  }

  // Deduct points
  const newPoints = member.points - reward.points_required;

  try {
    await fetch(
      `${CONFIG.SUPABASE_URL}/rest/v1/loyalty_points?id=eq.${member.id}`,
      {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'apikey': CONFIG.SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify({
          points: newPoints,
          updated_at: new Date().toISOString()
        })
      }
    );

    // Update reward redemption count
    await fetch(
      `${CONFIG.SUPABASE_URL}/rest/v1/loyalty_rewards?id=eq.${rewardId}`,
      {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'apikey': CONFIG.SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify({
          current_redemptions: (reward.current_redemptions || 0) + 1
        })
      }
    );

    // Log transaction
    await addLoyaltyTransaction(
      member.id,
      restaurantId,
      'redeem',
      -reward.points_required,
      `Indl√∏st: ${reward.name}`
    );

    return {
      success: true,
      reward: reward,
      newPoints: newPoints,
      message: `Du har indl√∏st "${reward.name}"!`
    };
  } catch (err) {
    console.error('redeemLoyaltyReward error:', err);
    return { success: false, error: 'Fejl ved indl√∏sning' };
  }
}

// Get available rewards for customer
async function getAvailableRewards(phone, restaurantId) {
  const member = await getCustomerLoyalty(phone, restaurantId);
  if (!member) return [];

  const rewards = await getLoyaltyRewards(restaurantId);
  return rewards.map(r => ({
    ...r,
    canRedeem: member.points >= r.points_required,
    pointsNeeded: Math.max(0, r.points_required - member.points)
  }));
}

// Format loyalty message for SMS
function formatLoyaltyMessage(member, earnedPoints = 0) {
  const tier = LOYALTY_TIERS[member.tier] || LOYALTY_TIERS.bronze;
  let msg = `${tier.icon} `;

  if (earnedPoints > 0) {
    msg += `Du har optjent ${earnedPoints} points! `;
  }

  msg += `Total: ${member.points} points (${tier.name})`;
  return msg;
}

// Render loyalty demo page (when no restaurant is selected)
function renderLoyaltyDemoPage() {
  const container = document.getElementById('main-content');
  if (!container) return;

  // Demo data
  const demoMembers = 234;
  const demoPoints = 45678;
  const demoVIP = 45;
  const demoRewards = 5;

  container.innerHTML = `
    <div class="page-header">
      <h1>Loyalty Program</h1>
      <p class="text-secondary">Administrer dit kundeloyalitetsprogram</p>
      <span class="badge badge-info" style="margin-left:12px">Demo-tilstand</span>
    </div>

    <div class="alert alert-info" style="margin-bottom:24px">
      <strong>Demo-tilstand:</strong> V√¶lg en restaurant for at se rigtige data, eller se demo-data nedenfor.
    </div>

    <!-- Stats -->
    <div class="stats-grid" style="margin-bottom:24px">
      <div class="stat-card">
        <div class="stat-value">${demoMembers}</div>
        <div class="stat-label">Medlemmer</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${demoPoints.toLocaleString('da-DK')}</div>
        <div class="stat-label">Aktive points</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${demoVIP}</div>
        <div class="stat-label">VIP medlemmer</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${demoRewards}</div>
        <div class="stat-label">Aktive bel√∏nninger</div>
      </div>
    </div>

    <!-- Settings -->
    <div class="card" style="margin-bottom:24px">
      <div class="card-header">
        <h3>Indstillinger</h3>
        <label class="switch">
          <input type="checkbox" disabled checked>
          <span class="slider"></span>
        </label>
      </div>
      <div class="card-body">
        <div class="form-grid" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px">
          <div class="form-group">
            <label class="form-label">Points pr. krone</label>
            <input type="number" class="input" value="1" disabled>
          </div>
          <div class="form-group">
            <label class="form-label">Min. ordre for points</label>
            <input type="number" class="input" value="50" disabled>
          </div>
          <div class="form-group">
            <label class="form-label">Velkomstbonus</label>
            <input type="number" class="input" value="50" disabled>
          </div>
          <div class="form-group">
            <label class="form-label">F√∏dselsdagsbonus</label>
            <input type="number" class="input" value="100" disabled>
          </div>
        </div>

        <h4 style="margin:24px 0 16px">Tier-gr√¶nser</h4>
        <div class="form-grid" style="display:grid;grid-template-columns:repeat(4, 1fr);gap:16px">
          <div class="form-group">
            <label class="form-label">S√∏lv fra</label>
            <input type="number" class="input" value="500" disabled>
          </div>
          <div class="form-group">
            <label class="form-label">Guld fra</label>
            <input type="number" class="input" value="1500" disabled>
          </div>
          <div class="form-group">
            <label class="form-label">Platin fra</label>
            <input type="number" class="input" value="5000" disabled>
          </div>
        </div>
      </div>
    </div>

    <!-- Demo Rewards -->
    <div class="card" style="margin-bottom:24px">
      <div class="card-header">
        <h3>Bel√∏nninger</h3>
        <button class="btn btn-primary btn-sm" disabled>+ Tilf√∏j bel√∏nning</button>
      </div>
      <div class="card-body">
        <div class="rewards-grid" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:16px">
          <div class="reward-card" style="background:var(--card2);border-radius:12px;padding:16px;border:1px solid var(--border)">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
              <h4 style="margin:0">Gratis drink</h4>
              <span class="badge" style="background:var(--accent);color:white">250 pts</span>
            </div>
            <p class="text-secondary" style="font-size:13px;margin-bottom:12px">Valgfri sodavand eller juice</p>
          </div>
          <div class="reward-card" style="background:var(--card2);border-radius:12px;padding:16px;border:1px solid var(--border)">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
              <h4 style="margin:0">Gratis dessert</h4>
              <span class="badge" style="background:var(--accent);color:white">500 pts</span>
            </div>
            <p class="text-secondary" style="font-size:13px;margin-bottom:12px">Valgfri dessert fra menuen</p>
          </div>
          <div class="reward-card" style="background:var(--card2);border-radius:12px;padding:16px;border:1px solid var(--border)">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
              <h4 style="margin:0">50 kr rabat</h4>
              <span class="badge" style="background:var(--accent);color:white">1000 pts</span>
            </div>
            <p class="text-secondary" style="font-size:13px;margin-bottom:12px">Rabat p√• n√¶ste ordre over 200 kr</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Demo Members -->
    <div class="card">
      <div class="card-header">
        <h3>Medlemmer</h3>
        <input type="text" class="input" placeholder="S√∏g p√• telefon eller navn..." style="width:250px" disabled>
      </div>
      <div class="card-body">
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Kunde</th>
                <th>Telefon</th>
                <th>Tier</th>
                <th>Points</th>
                <th>Lifetime</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Demo Kunde</td>
                <td>+45 12 34 56 78</td>
                <td><span class="badge badge-gold">Guld</span></td>
                <td>1.234</td>
                <td>4.567</td>
              </tr>
              <tr>
                <td>Test Person</td>
                <td>+45 87 65 43 21</td>
                <td><span class="badge badge-silver">S√∏lv</span></td>
                <td>567</td>
                <td>1.890</td>
              </tr>
              <tr>
                <td>Ny Bruger</td>
                <td>+45 11 22 33 44</td>
                <td><span class="badge badge-bronze">Bronze</span></td>
                <td>123</td>
                <td>123</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
}

// Render loyalty admin page
async function renderLoyaltyPage() {
  let restaurantId = document.getElementById('test-restaurant')?.value;

  // Auto-select first restaurant if none selected
  if (!restaurantId) {
    const dropdown = document.getElementById('test-restaurant');
    if (dropdown && dropdown.options.length > 1) {
      dropdown.selectedIndex = 1;
      restaurantId = dropdown.value;
    }
  }

  if (!restaurantId) {
    renderLoyaltyDemoPage();
    return;
  }

  // Get settings or create defaults
  let settings = await getLoyaltySettings(restaurantId);
  if (!settings) {
    settings = await createLoyaltySettings(restaurantId);
  }

  // Get rewards and members
  const rewards = await getLoyaltyRewards(restaurantId);
  const membersResponse = await fetch(
    `${CONFIG.SUPABASE_URL}/rest/v1/loyalty_points?restaurant_id=eq.${restaurantId}&order=lifetime_points.desc&limit=100`,
    {
      headers: {
        'apikey': CONFIG.SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
      }
    }
  );
  const members = await membersResponse.json();

  // Calculate stats
  const totalMembers = members.length;
  const totalPoints = members.reduce((sum, m) => sum + m.points, 0);
  const tierCounts = { bronze: 0, silver: 0, gold: 0, platinum: 0 };
  members.forEach(m => tierCounts[m.tier]++);

  const html = `
    <div class="page-header">
      <h1>Loyalty Program</h1>
      <p class="text-secondary">Administrer dit kundeloyalitetsprogram</p>
    </div>

    <!-- Stats -->
    <div class="stats-grid" style="margin-bottom:24px">
      <div class="stat-card">
        <div class="stat-value">${totalMembers}</div>
        <div class="stat-label">Medlemmer</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${totalPoints.toLocaleString('da-DK')}</div>
        <div class="stat-label">Aktive points</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${tierCounts.gold + tierCounts.platinum}</div>
        <div class="stat-label">VIP medlemmer</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${rewards.length}</div>
        <div class="stat-label">Aktive bel√∏nninger</div>
      </div>
    </div>

    <!-- Settings -->
    <div class="card" style="margin-bottom:24px">
      <div class="card-header">
        <h3>Indstillinger</h3>
        <label class="switch">
          <input type="checkbox" id="loyalty-enabled" ${settings?.enabled ? 'checked' : ''} onchange="toggleLoyaltyEnabled()">
          <span class="slider"></span>
        </label>
      </div>
      <div class="card-body">
        <div class="form-grid" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px">
          <div class="form-group">
            <label class="form-label">Points pr. krone</label>
            <input type="number" class="input" id="loyalty-points-per-kr" value="${settings?.points_per_kr || 1}" step="0.1" min="0">
          </div>
          <div class="form-group">
            <label class="form-label">Min. ordre for points</label>
            <input type="number" class="input" id="loyalty-min-order" value="${settings?.min_order_for_points || 50}" min="0">
          </div>
          <div class="form-group">
            <label class="form-label">Velkomstbonus</label>
            <input type="number" class="input" id="loyalty-welcome-bonus" value="${settings?.welcome_bonus || 50}" min="0">
          </div>
          <div class="form-group">
            <label class="form-label">F√∏dselsdagsbonus</label>
            <input type="number" class="input" id="loyalty-birthday-bonus" value="${settings?.birthday_bonus || 100}" min="0">
          </div>
        </div>

        <h4 style="margin:24px 0 16px">Tier-gr√¶nser</h4>
        <div class="form-grid" style="display:grid;grid-template-columns:repeat(4, 1fr);gap:16px">
          <div class="form-group">
            <label class="form-label">S√∏lv fra</label>
            <input type="number" class="input" id="loyalty-tier-silver" value="${settings?.tier_silver_min || 500}" min="0">
          </div>
          <div class="form-group">
            <label class="form-label">Guld fra</label>
            <input type="number" class="input" id="loyalty-tier-gold" value="${settings?.tier_gold_min || 1500}" min="0">
          </div>
          <div class="form-group">
            <label class="form-label">Platin fra</label>
            <input type="number" class="input" id="loyalty-tier-platinum" value="${settings?.tier_platinum_min || 5000}" min="0">
          </div>
        </div>

        <h4 style="margin:24px 0 16px">Tier-bonusser</h4>
        <div class="form-grid" style="display:grid;grid-template-columns:repeat(3, 1fr);gap:16px">
          <div class="form-group">
            <label class="form-label">S√∏lv multiplier</label>
            <input type="number" class="input" id="loyalty-mult-silver" value="${settings?.silver_multiplier || 1.25}" step="0.05" min="1">
          </div>
          <div class="form-group">
            <label class="form-label">Guld multiplier</label>
            <input type="number" class="input" id="loyalty-mult-gold" value="${settings?.gold_multiplier || 1.5}" step="0.05" min="1">
          </div>
          <div class="form-group">
            <label class="form-label">Platin multiplier</label>
            <input type="number" class="input" id="loyalty-mult-platinum" value="${settings?.platinum_multiplier || 2.0}" step="0.05" min="1">
          </div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:24px">
          <span id="settings-save-status" style="color:var(--success);display:none">√Ündringer gemt</span>
          <button class="btn btn-primary" onclick="saveLoyaltySettings()">Gem indstillinger</button>
        </div>
      </div>
    </div>

    <!-- Loyalty Tiers for Website & App -->
    <div class="card" style="margin-bottom:24px">
      <div class="card-header">
        <div>
          <h3>Loyalty Tiers</h3>
          <p class="text-secondary" style="margin:4px 0 0;font-size:13px">Konfigurer tiers for website og app</p>
        </div>
      </div>
      <div class="card-body" id="loyalty-tiers-container">
        ${renderLoyaltyTiersHTML(settings)}
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:16px;border-top:1px solid var(--border)">
        <span id="tiers-save-status" style="color:var(--success);display:none">√Ündringer gemt</span>
        <button class="btn btn-primary" onclick="saveLoyaltyTiers()">Gem tiers</button>
      </div>
    </div>

    <!-- Rewards -->
    <div class="card" style="margin-bottom:24px">
      <div class="card-header">
        <h3>Bel√∏nninger</h3>
        <button class="btn btn-primary btn-sm" onclick="showAddRewardModal()">+ Tilf√∏j bel√∏nning</button>
      </div>
      <div class="card-body">
        ${rewards.length === 0 ? '<p class="text-secondary">Ingen bel√∏nninger oprettet endnu</p>' : `
          <div class="rewards-grid" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:16px">
            ${rewards.map(r => `
              <div class="reward-card" style="background:var(--card2);border-radius:12px;padding:16px;border:1px solid var(--border)">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
                  <h4 style="margin:0">${r.name}</h4>
                  <span class="badge" style="background:var(--accent);color:white">${r.points_required} pts</span>
                </div>
                <p class="text-secondary" style="font-size:13px;margin-bottom:12px">${r.description || ''}</p>
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <span class="text-secondary" style="font-size:12px">${r.current_redemptions || 0} indl√∏st</span>
                  <div>
                    <button class="btn btn-sm" onclick="editReward('${r.id}')">Rediger</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteReward('${r.id}')">Slet</button>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `}
      </div>
    </div>

    <!-- Members -->
    <div class="card">
      <div class="card-header">
        <h3>Medlemmer</h3>
        <input type="text" class="input" placeholder="S√∏g p√• telefon eller navn..." style="width:250px" oninput="filterLoyaltyMembers(this.value)">
      </div>
      <div class="card-body">
        <div class="table-container">
          <table class="data-table" id="loyalty-members-table">
            <thead>
              <tr>
                <th>Kunde</th>
                <th>Telefon</th>
                <th>Tier</th>
                <th>Points</th>
                <th>Lifetime</th>
                <th>Handlinger</th>
              </tr>
            </thead>
            <tbody>
              ${members.map(m => `
                <tr data-phone="${m.customer_phone}" data-name="${m.customer_name || ''}">
                  <td>${m.customer_name || '<span class="text-secondary">Ukendt</span>'}</td>
                  <td>${m.customer_phone}</td>
                  <td>
                    <span class="tier-badge tier-${m.tier}">
                      ${LOYALTY_TIERS[m.tier]?.icon || ''} ${LOYALTY_TIERS[m.tier]?.name || 'Bronze'}
                    </span>
                  </td>
                  <td><strong>${m.points.toLocaleString('da-DK')}</strong></td>
                  <td>${m.lifetime_points.toLocaleString('da-DK')}</td>
                  <td>
                    <button class="btn btn-sm" onclick="showMemberDetails('${m.id}')">Detaljer</button>
                    <button class="btn btn-sm" onclick="adjustMemberPoints('${m.id}')">+/- Points</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;

  document.getElementById('main-content').innerHTML = html;
}

// Save loyalty settings
async function saveLoyaltySettings() {
  const restaurantId = document.getElementById('test-restaurant')?.value;
  if (!restaurantId) return;

  const settings = {
    enabled: document.getElementById('loyalty-enabled')?.checked ?? true,
    points_per_kr: parseFloat(document.getElementById('loyalty-points-per-kr')?.value) || 1,
    min_order_for_points: parseFloat(document.getElementById('loyalty-min-order')?.value) || 50,
    welcome_bonus: parseInt(document.getElementById('loyalty-welcome-bonus')?.value) || 50,
    birthday_bonus: parseInt(document.getElementById('loyalty-birthday-bonus')?.value) || 100,
    tier_silver_min: parseInt(document.getElementById('loyalty-tier-silver')?.value) || 500,
    tier_gold_min: parseInt(document.getElementById('loyalty-tier-gold')?.value) || 1500,
    tier_platinum_min: parseInt(document.getElementById('loyalty-tier-platinum')?.value) || 5000,
    silver_multiplier: parseFloat(document.getElementById('loyalty-mult-silver')?.value) || 1.25,
    gold_multiplier: parseFloat(document.getElementById('loyalty-mult-gold')?.value) || 1.5,
    platinum_multiplier: parseFloat(document.getElementById('loyalty-mult-platinum')?.value) || 2.0,
    updated_at: new Date().toISOString()
  };

  try {
    await fetch(
      `${CONFIG.SUPABASE_URL}/rest/v1/loyalty_settings?restaurant_id=eq.${restaurantId}`,
      {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'apikey': CONFIG.SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify(settings)
      }
    );

    loyaltySettings = { ...loyaltySettings, ...settings };
    const statusEl = document.getElementById('settings-save-status');
    if (statusEl) {
      statusEl.style.display = 'inline';
      setTimeout(() => statusEl.style.display = 'none', 3000);
    }
    toast('Indstillinger gemt', 'success');
  } catch (err) {
    console.error('saveLoyaltySettings error:', err);
    toast('Fejl ved gem', 'error');
  }
}

// Render Loyalty Tiers HTML for website and app
function renderLoyaltyTiersHTML(settings) {
  const tiers = settings?.loyalty_tiers || [
    { name: 'Bronze', min_points: 0, max_points: 500, benefit: '5% rabat p√• ordrer' },
    { name: 'S√∏lv', min_points: 501, max_points: 2000, benefit: '10% rabat p√• ordrer' },
    { name: 'Guld', min_points: 2001, max_points: null, benefit: '15% rabat + gratis levering' }
  ];

  return `
    <div id="loyalty-tiers-list">
      ${tiers.map((tier, index) => `
        <div class="tier-row" data-tier-index="${index}" style="display:grid; grid-template-columns:1fr 100px 100px 2fr 40px; gap:12px; align-items:center; padding:12px; background:var(--card2); border:1px solid var(--border); border-radius:8px; margin-bottom:12px;">
          <input type="text" class="input tier-name" value="${tier.name}" placeholder="Tier navn">
          <input type="number" class="input tier-min" value="${tier.min_points}" placeholder="Fra" min="0">
          <input type="number" class="input tier-max" value="${tier.max_points || ''}" placeholder="Til">
          <input type="text" class="input tier-benefit" value="${tier.benefit}" placeholder="Fordele (fx 5% rabat)">
          <button class="btn btn-sm btn-icon" onclick="removeLoyaltyTier(${index})" title="Fjern tier" style="padding:8px;color:var(--danger)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
      `).join('')}
    </div>
    <button class="btn btn-secondary" onclick="addLoyaltyTier()" style="margin-top:8px">+ Tilf√∏j tier</button>
  `;
}

// Add a new loyalty tier
function addLoyaltyTier() {
  const container = document.getElementById('loyalty-tiers-list');
  if (!container) return;

  const tierRows = container.querySelectorAll('.tier-row');
  const newIndex = tierRows.length;

  const newTierHTML = `
    <div class="tier-row" data-tier-index="${newIndex}" style="display:grid; grid-template-columns:1fr 100px 100px 2fr 40px; gap:12px; align-items:center; padding:12px; background:var(--card2); border:1px solid var(--border); border-radius:8px; margin-bottom:12px;">
      <input type="text" class="input tier-name" value="" placeholder="Tier navn">
      <input type="number" class="input tier-min" value="" placeholder="Fra" min="0">
      <input type="number" class="input tier-max" value="" placeholder="Til">
      <input type="text" class="input tier-benefit" value="" placeholder="Fordele (fx 5% rabat)">
      <button class="btn btn-sm btn-icon" onclick="removeLoyaltyTier(${newIndex})" title="Fjern tier" style="padding:8px;color:var(--danger)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
  `;

  container.insertAdjacentHTML('beforeend', newTierHTML);
}

// Remove a loyalty tier
function removeLoyaltyTier(index) {
  const container = document.getElementById('loyalty-tiers-list');
  if (!container) return;

  const tierRow = container.querySelector(`.tier-row[data-tier-index="${index}"]`);
  if (tierRow) {
    tierRow.remove();
    // Re-index remaining tiers
    const rows = container.querySelectorAll('.tier-row');
    rows.forEach((row, i) => {
      row.dataset.tierIndex = i;
      const removeBtn = row.querySelector('button');
      if (removeBtn) {
        removeBtn.setAttribute('onclick', `removeLoyaltyTier(${i})`);
      }
    });
  }
}

// Save loyalty tiers
async function saveLoyaltyTiers() {
  const restaurantId = document.getElementById('test-restaurant')?.value;
  if (!restaurantId) return;

  const container = document.getElementById('loyalty-tiers-list');
  if (!container) return;

  const tierRows = container.querySelectorAll('.tier-row');
  const tiers = [];

  tierRows.forEach(row => {
    const name = row.querySelector('.tier-name')?.value?.trim();
    const minPoints = parseInt(row.querySelector('.tier-min')?.value) || 0;
    const maxPoints = row.querySelector('.tier-max')?.value ? parseInt(row.querySelector('.tier-max')?.value) : null;
    const benefit = row.querySelector('.tier-benefit')?.value?.trim();

    if (name) {
      tiers.push({
        name,
        min_points: minPoints,
        max_points: maxPoints,
        benefit: benefit || ''
      });
    }
  });

  try {
    await fetch(
      `${CONFIG.SUPABASE_URL}/rest/v1/loyalty_settings?restaurant_id=eq.${restaurantId}`,
      {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'apikey': CONFIG.SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify({
          loyalty_tiers: tiers,
          updated_at: new Date().toISOString()
        })
      }
    );

    const statusEl = document.getElementById('tiers-save-status');
    if (statusEl) {
      statusEl.style.display = 'inline';
      setTimeout(() => statusEl.style.display = 'none', 3000);
    }
    toast('Loyalty tiers gemt', 'success');
  } catch (err) {
    console.error('saveLoyaltyTiers error:', err);
    toast('Fejl ved gem af tiers', 'error');
  }
}

// Toggle loyalty enabled
async function toggleLoyaltyEnabled() {
  const enabled = document.getElementById('loyalty-enabled')?.checked;
  const restaurantId = document.getElementById('test-restaurant')?.value;
  if (!restaurantId) return;

  try {
    await fetch(
      `${CONFIG.SUPABASE_URL}/rest/v1/loyalty_settings?restaurant_id=eq.${restaurantId}`,
      {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'apikey': CONFIG.SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify({ enabled, updated_at: new Date().toISOString() })
      }
    );

    toast(enabled ? 'Loyalty aktiveret' : 'Loyalty deaktiveret', 'success');
  } catch (err) {
    toast('Fejl', 'error');
  }
}

// Filter loyalty members
function filterLoyaltyMembers(query) {
  const rows = document.querySelectorAll('#loyalty-members-table tbody tr');
  const q = query.toLowerCase();

  rows.forEach(row => {
    const phone = row.dataset.phone?.toLowerCase() || '';
    const name = row.dataset.name?.toLowerCase() || '';
    row.style.display = (phone.includes(q) || name.includes(q)) ? '' : 'none';
  });
}

// Show add reward modal
function showAddRewardModal(reward = null) {
  const isEdit = !!reward;

  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.id = 'reward-modal';
  modal.innerHTML = `
    <div class="modal" style="max-width:500px">
      <div class="modal-header">
        <h3>${isEdit ? 'Rediger' : 'Tilf√∏j'} bel√∏nning</h3>
        <button class="modal-close" onclick="closeRewardModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Navn *</label>
          <input type="text" class="input" id="reward-name" value="${reward?.name || ''}" placeholder="F.eks. Gratis dessert">
        </div>
        <div class="form-group">
          <label class="form-label">Beskrivelse</label>
          <textarea class="input" id="reward-description" rows="2" placeholder="Valgfri beskrivelse">${reward?.description || ''}</textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Points kr√¶vet *</label>
          <input type="number" class="input" id="reward-points" value="${reward?.points_required || 100}" min="1">
        </div>
        <div class="form-group">
          <label class="form-label">Bel√∏nningstype</label>
          <select class="input" id="reward-type">
            <option value="discount_percent" ${reward?.reward_type === 'discount_percent' ? 'selected' : ''}>Rabat i procent</option>
            <option value="discount_amount" ${reward?.reward_type === 'discount_amount' ? 'selected' : ''}>Rabat i kroner</option>
            <option value="free_item" ${reward?.reward_type === 'free_item' ? 'selected' : ''}>Gratis produkt</option>
            <option value="free_delivery" ${reward?.reward_type === 'free_delivery' ? 'selected' : ''}>Gratis levering</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">V√¶rdi (procent eller kroner)</label>
          <input type="number" class="input" id="reward-value" value="${reward?.reward_value || ''}" placeholder="F.eks. 10 for 10% eller 50 kr">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeRewardModal()">Annuller</button>
        <button class="btn btn-primary" onclick="saveReward('${reward?.id || ''}')">${isEdit ? 'Gem' : 'Opret'}</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

// Close reward modal
function closeRewardModal() {
  document.getElementById('reward-modal')?.remove();
}

// Save reward
async function saveReward(rewardId = null) {
  const restaurantId = document.getElementById('test-restaurant')?.value;
  if (!restaurantId) return;

  const name = document.getElementById('reward-name')?.value?.trim();
  const description = document.getElementById('reward-description')?.value?.trim();
  const points_required = parseInt(document.getElementById('reward-points')?.value) || 100;
  const reward_type = document.getElementById('reward-type')?.value || 'discount_percent';
  const reward_value = parseFloat(document.getElementById('reward-value')?.value) || null;

  if (!name) {
    toast('Indtast et navn', 'error');
    return;
  }

  const data = {
    restaurant_id: restaurantId,
    name,
    description,
    points_required,
    reward_type,
    reward_value,
    active: true
  };

  try {
    if (rewardId) {
      await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/loyalty_rewards?id=eq.${rewardId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'apikey': CONFIG.SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify(data)
      });
    } else {
      await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/loyalty_rewards`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': CONFIG.SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify(data)
      });
    }

    toast(rewardId ? 'Bel√∏nning opdateret' : 'Bel√∏nning oprettet', 'success');
    closeRewardModal();
    renderLoyaltyPage();
  } catch (err) {
    console.error('saveReward error:', err);
    toast('Fejl ved gem', 'error');
  }
}

// Edit reward
async function editReward(rewardId) {
  const rewards = await getLoyaltyRewards(document.getElementById('test-restaurant')?.value);
  const reward = rewards.find(r => r.id === rewardId);
  if (reward) {
    showAddRewardModal(reward);
  }
}

// Delete reward
async function deleteReward(rewardId) {
  if (!confirm('Er du sikker p√• du vil slette denne bel√∏nning?')) return;

  try {
    await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/loyalty_rewards?id=eq.${rewardId}`, {
      method: 'DELETE',
      headers: {
        'apikey': CONFIG.SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
      }
    });

    toast('Bel√∏nning slettet', 'success');
    renderLoyaltyPage();
  } catch (err) {
    toast('Fejl ved sletning', 'error');
  }
}

// Adjust member points
function adjustMemberPoints(memberId) {
  const adjustment = prompt('Indtast antal points (negativt tal tr√¶kker fra):');
  if (!adjustment) return;

  const points = parseInt(adjustment);
  if (isNaN(points)) {
    toast('Ugyldigt tal', 'error');
    return;
  }

  // TODO: Implement point adjustment
  toast('Point justering kommer snart', 'info');
}

// Show member details
function showMemberDetails(memberId) {
  // TODO: Show member transaction history modal
  toast('Detaljer kommer snart', 'info');
}

// Export loyalty functions
window.renderLoyaltyPage = renderLoyaltyPage;
window.saveLoyaltySettings = saveLoyaltySettings;
window.saveLoyaltyTiers = saveLoyaltyTiers;
window.addLoyaltyTier = addLoyaltyTier;
window.removeLoyaltyTier = removeLoyaltyTier;
window.toggleLoyaltyEnabled = toggleLoyaltyEnabled;
window.filterLoyaltyMembers = filterLoyaltyMembers;
window.showAddRewardModal = showAddRewardModal;
window.closeRewardModal = closeRewardModal;
window.saveReward = saveReward;
window.editReward = editReward;
window.deleteReward = deleteReward;
window.adjustMemberPoints = adjustMemberPoints;
window.showMemberDetails = showMemberDetails;
window.getCustomerLoyalty = getCustomerLoyalty;
window.addLoyaltyPoints = addLoyaltyPoints;
window.redeemLoyaltyReward = redeemLoyaltyReward;
window.getAvailableRewards = getAvailableRewards;
window.formatLoyaltyMessage = formatLoyaltyMessage;


// ===== MARKETING CAMPAIGNS =====

// Campaign data cache
let campaigns = [];
let campaignSends = [];

// Campaign trigger types
const CAMPAIGN_TRIGGERS = {
  manual: { name: 'Manuel', icon: '', description: 'Send manuelt n√•r du vil' },
  birthday: { name: 'F√∏dselsdag', icon: '', description: 'Automatisk p√• kundens f√∏dselsdag' },
  inactive: { name: 'Inaktiv', icon: '', description: 'N√•r kunden ikke har bestilt i X dage' },
  loyalty_tier: { name: 'Loyalty Tier', icon: '', description: 'N√•r kunden opn√•r et nyt tier' },
  first_order: { name: 'F√∏rste ordre', icon: '', description: 'Efter kundens f√∏rste ordre' },
  scheduled: { name: 'Planlagt', icon: '', description: 'P√• et bestemt tidspunkt' }
};

// Get campaigns for restaurant
async function getCampaigns(restaurantId) {
  try {
    const response = await fetch(
      `${CONFIG.SUPABASE_URL}/rest/v1/marketing_campaigns?restaurant_id=eq.${restaurantId}&order=created_at.desc`,
      {
        headers: {
          'apikey': CONFIG.SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
        }
      }
    );

    if (!response.ok) return [];
    campaigns = await response.json();
    return campaigns;
  } catch (err) {
    console.error('getCampaigns error:', err);
    return [];
  }
}

// Render campaigns page
async function renderCampaignsPage() {
  const restaurantId = document.getElementById('test-restaurant')?.value;
  const content = document.getElementById('campaigns-content') || document.getElementById('main-content');

  if (!restaurantId) {
    content.innerHTML = '<div class="empty-state"><p>V√¶lg en restaurant f√∏rst</p></div>';
    return;
  }

  const campaignList = await getCampaigns(restaurantId);

  // Calculate stats
  const activeCampaigns = campaignList.filter(c => c.active).length;
  const totalSent = campaignList.reduce((sum, c) => sum + (c.total_sent || 0), 0);

  const html = `
    <div class="page-header">
      <h1>Marketing Kampagner</h1>
      <p class="text-secondary">Automatis√©r din kundekommunikation</p>
    </div>

    <!-- Stats -->
    <div class="stats-grid" style="margin-bottom:24px">
      <div class="stat-card">
        <div class="stat-value">${campaignList.length}</div>
        <div class="stat-label">Kampagner</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${activeCampaigns}</div>
        <div class="stat-label">Aktive</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${totalSent.toLocaleString('da-DK')}</div>
        <div class="stat-label">Beskeder sendt</div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="card" style="margin-bottom:24px">
      <div class="card-header">
        <h3>‚ö° Hurtige kampagner</h3>
      </div>
      <div class="card-body">
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px">
          <button class="btn btn-secondary" onclick="createQuickCampaign('inactive')" style="display:flex;flex-direction:column;align-items:center;padding:24px;height:auto">
            <span style="font-weight:600">Inaktive kunder</span>
            <span class="text-secondary" style="font-size:12px">Genaktiver kunder</span>
          </button>
          <button class="btn btn-secondary" onclick="createQuickCampaign('birthday')" style="display:flex;flex-direction:column;align-items:center;padding:24px;height:auto">
            <span style="font-weight:600">F√∏dselsdagshilsen</span>
            <span class="text-secondary" style="font-size:12px">Automatisk hilsen</span>
          </button>
          <button class="btn btn-secondary" onclick="createQuickCampaign('first_order')" style="display:flex;flex-direction:column;align-items:center;padding:24px;height:auto">
            <span style="font-weight:600">Velkomstbesked</span>
            <span class="text-secondary" style="font-size:12px">Efter f√∏rste ordre</span>
          </button>
          <button class="btn btn-primary" onclick="showCreateCampaignModal()" style="display:flex;flex-direction:column;align-items:center;padding:24px;height:auto">
            <span style="font-weight:600">Opret kampagne</span>
            <span style="font-size:12px;opacity:0.8">Tilpasset kampagne</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Campaigns List -->
    <div class="card">
      <div class="card-header">
        <h3>üìã Dine kampagner</h3>
      </div>
      <div class="card-body">
        ${campaignList.length === 0 ? '<p class="text-secondary">Ingen kampagner oprettet endnu. Brug knapperne ovenfor for at komme i gang.</p>' : `
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Kampagne</th>
                  <th>Type</th>
                  <th>Trigger</th>
                  <th>Sendt</th>
                  <th>Status</th>
                  <th>Handlinger</th>
                </tr>
              </thead>
              <tbody>
                ${campaignList.map(c => `
                  <tr>
                    <td>
                      <strong>${c.name}</strong>
                      ${c.description ? `<br><span class="text-secondary" style="font-size:12px">${c.description}</span>` : ''}
                    </td>
                    <td><span class="badge">${c.type === 'sms' ? 'SMS' : 'Email'}</span></td>
                    <td>
                      <span>${CAMPAIGN_TRIGGERS[c.trigger_type]?.icon || ''}</span>
                      ${CAMPAIGN_TRIGGERS[c.trigger_type]?.name || c.trigger_type}
                      ${c.trigger_days ? `<br><span class="text-secondary" style="font-size:11px">${c.trigger_days} dage</span>` : ''}
                    </td>
                    <td>${(c.total_sent || 0).toLocaleString('da-DK')}</td>
                    <td>
                      <label class="switch switch-sm">
                        <input type="checkbox" ${c.active ? 'checked' : ''} onchange="toggleCampaign('${c.id}', this.checked)">
                        <span class="slider"></span>
                      </label>
                    </td>
                    <td>
                      <button class="btn btn-sm" onclick="editCampaign('${c.id}')">Rediger</button>
                      ${c.trigger_type === 'manual' ? `<button class="btn btn-sm btn-primary" onclick="sendCampaign('${c.id}')">Send nu</button>` : ''}
                      <button class="btn btn-sm btn-danger" onclick="deleteCampaign('${c.id}')">Slet</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `}
      </div>
    </div>
  `;

  content.innerHTML = html;
}

// Create quick campaign with preset
async function createQuickCampaign(type) {
  const restaurantId = document.getElementById('test-restaurant')?.value;
  if (!restaurantId) return;

  const presets = {
    inactive: {
      name: 'Genaktiv√©r inaktive kunder',
      description: 'Automatisk SMS til kunder der ikke har bestilt i 30 dage',
      trigger_type: 'inactive',
      trigger_days: 30,
      message_template: 'Hej {navn}! Vi savner dig hos {restaurant}. Bestil i dag og f√• 10% rabat med koden SAVNER10 üçï'
    },
    birthday: {
      name: 'F√∏dselsdagshilsen',
      description: 'Automatisk f√∏dselsdagshilsen med tilbud',
      trigger_type: 'birthday',
      message_template: 'Tillykke med f√∏dselsdagen {navn}! Som gave fra {restaurant} f√•r du 15% rabat p√• din n√¶ste ordre. Brug koden F√òDSELSDAG15'
    },
    first_order: {
      name: 'Velkomstbesked',
      description: 'Tak for f√∏rste ordre',
      trigger_type: 'first_order',
      message_template: 'Tak for din f√∏rste ordre hos {restaurant}, {navn}! Vi h√•ber du n√∏d maden. N√¶ste gang f√•r du 10% rabat med koden VELKOMMEN10'
    }
  };

  const preset = presets[type];
  if (!preset) return;

  try {
    await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/marketing_campaigns`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': CONFIG.SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify({
        restaurant_id: restaurantId,
        name: preset.name,
        description: preset.description,
        type: 'sms',
        trigger_type: preset.trigger_type,
        trigger_days: preset.trigger_days || null,
        message_template: preset.message_template,
        active: true
      })
    });

    toast('Kampagne oprettet!', 'success');
    renderCampaignsPage();
  } catch (err) {
    console.error('createQuickCampaign error:', err);
    toast('Fejl ved oprettelse', 'error');
  }
}

// Show create campaign modal
function showCreateCampaignModal(campaign = null) {
  const isEdit = !!campaign;

  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.id = 'campaign-modal';
  modal.innerHTML = `
    <div class="modal" style="max-width:600px">
      <div class="modal-header">
        <h3>${isEdit ? 'Rediger' : 'Opret'} kampagne</h3>
        <button class="modal-close" onclick="closeCampaignModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Navn *</label>
          <input type="text" class="input" id="campaign-name" value="${campaign?.name || ''}" placeholder="F.eks. Sommerrabat">
        </div>
        <div class="form-group">
          <label class="form-label">Beskrivelse</label>
          <input type="text" class="input" id="campaign-description" value="${campaign?.description || ''}" placeholder="Kort beskrivelse">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div class="form-group">
            <label class="form-label">Type</label>
            <select class="input" id="campaign-type">
              <option value="sms" ${campaign?.type === 'sms' ? 'selected' : ''}>SMS</option>
              <option value="email" ${campaign?.type === 'email' ? 'selected' : ''}>Email</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Trigger</label>
            <select class="input" id="campaign-trigger" onchange="toggleTriggerOptions()">
              ${Object.entries(CAMPAIGN_TRIGGERS).map(([key, val]) => `
                <option value="${key}" ${campaign?.trigger_type === key ? 'selected' : ''}>${val.icon} ${val.name}</option>
              `).join('')}
            </select>
          </div>
        </div>
        <div class="form-group" id="trigger-days-group" style="${campaign?.trigger_type === 'inactive' ? '' : 'display:none'}">
          <label class="form-label">Dage uden ordre</label>
          <input type="number" class="input" id="campaign-trigger-days" value="${campaign?.trigger_days || 30}" min="1">
        </div>
        <div class="form-group">
          <label class="form-label">Besked *</label>
          <textarea class="input" id="campaign-message" rows="4" placeholder="Brug {navn} for kundens navn, {restaurant} for restaurantnavn">${campaign?.message_template || ''}</textarea>
          <p class="text-secondary" style="font-size:12px;margin-top:4px">Variabler: {navn}, {restaurant}, {points}, {tier}</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeCampaignModal()">Annuller</button>
        <button class="btn btn-primary" onclick="saveCampaign('${campaign?.id || ''}')">${isEdit ? 'Gem' : 'Opret'}</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

// Toggle trigger options visibility
function toggleTriggerOptions() {
  const trigger = document.getElementById('campaign-trigger')?.value;
  const daysGroup = document.getElementById('trigger-days-group');
  if (daysGroup) {
    daysGroup.style.display = trigger === 'inactive' ? '' : 'none';
  }
}

// Close campaign modal
function closeCampaignModal() {
  document.getElementById('campaign-modal')?.remove();
}

// Save campaign
async function saveCampaign(campaignId = null) {
  const restaurantId = document.getElementById('test-restaurant')?.value;
  if (!restaurantId) return;

  const name = document.getElementById('campaign-name')?.value?.trim();
  const description = document.getElementById('campaign-description')?.value?.trim();
  const type = document.getElementById('campaign-type')?.value || 'sms';
  const trigger_type = document.getElementById('campaign-trigger')?.value || 'manual';
  const trigger_days = parseInt(document.getElementById('campaign-trigger-days')?.value) || null;
  const message_template = document.getElementById('campaign-message')?.value?.trim();

  if (!name || !message_template) {
    toast('Udfyld navn og besked', 'error');
    return;
  }

  const data = {
    restaurant_id: restaurantId,
    name,
    description,
    type,
    trigger_type,
    trigger_days: trigger_type === 'inactive' ? trigger_days : null,
    message_template,
    active: true
  };

  try {
    if (campaignId) {
      await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/marketing_campaigns?id=eq.${campaignId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'apikey': CONFIG.SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify(data)
      });
    } else {
      await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/marketing_campaigns`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': CONFIG.SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify(data)
      });
    }

    toast(campaignId ? 'Kampagne opdateret' : 'Kampagne oprettet', 'success');
    closeCampaignModal();
    renderCampaignsPage();
  } catch (err) {
    console.error('saveCampaign error:', err);
    toast('Fejl ved gem', 'error');
  }
}

// Edit campaign
async function editCampaign(campaignId) {
  const campaign = campaigns.find(c => c.id === campaignId);
  if (campaign) {
    showCreateCampaignModal(campaign);
  }
}

// Toggle campaign active status
async function toggleCampaign(campaignId, active) {
  try {
    await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/marketing_campaigns?id=eq.${campaignId}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'apikey': CONFIG.SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify({ active, updated_at: new Date().toISOString() })
    });

    toast(active ? 'Kampagne aktiveret' : 'Kampagne deaktiveret', 'success');
  } catch (err) {
    toast('Fejl', 'error');
  }
}

// Delete campaign
async function deleteCampaign(campaignId) {
  if (!confirm('Er du sikker p√• du vil slette denne kampagne?')) return;

  try {
    await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/marketing_campaigns?id=eq.${campaignId}`, {
      method: 'DELETE',
      headers: {
        'apikey': CONFIG.SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
      }
    });

    toast('Kampagne slettet', 'success');
    renderCampaignsPage();
  } catch (err) {
    toast('Fejl ved sletning', 'error');
  }
}

// Send manual campaign
async function sendCampaign(campaignId) {
  toast('Manuel kampagne-send kommer snart', 'info');
  // TODO: Implement manual campaign send with segment selection
}

// Export campaign functions
window.renderCampaignsPage = renderCampaignsPage;
window.createQuickCampaign = createQuickCampaign;
window.showCreateCampaignModal = showCreateCampaignModal;
window.closeCampaignModal = closeCampaignModal;
window.saveCampaign = saveCampaign;
window.editCampaign = editCampaign;
window.toggleCampaign = toggleCampaign;
window.deleteCampaign = deleteCampaign;
window.sendCampaign = sendCampaign;
window.toggleTriggerOptions = toggleTriggerOptions;


// ===== CUSTOMER SEGMENTS =====

// Segment data cache
let customerSegments = [];

// Default segment icons and colors
const SEGMENT_TYPES = {
  vip: { icon: '', color: '#f59e0b', name: 'VIP Kunder' },
  new: { icon: '', color: '#10b981', name: 'Nye Kunder' },
  inactive: { icon: '', color: '#ef4444', name: 'Inaktive' },
  high_value: { icon: '', color: '#8b5cf6', name: 'H√∏jv√¶rdi' },
  at_risk: { icon: '', color: '#f97316', name: 'At Risk' },
  loyal: { icon: '', color: '#ec4899', name: 'Loyale' },
  custom: { icon: '', color: '#6366f1', name: 'Tilpasset' }
};

// Get segments for restaurant
async function getSegments(restaurantId) {
  try {
    const response = await fetch(
      `${CONFIG.SUPABASE_URL}/rest/v1/customer_segments?restaurant_id=eq.${restaurantId}&order=segment_type.asc`,
      {
        headers: {
          'apikey': CONFIG.SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
        }
      }
    );

    if (!response.ok) return [];
    customerSegments = await response.json();
    return customerSegments;
  } catch (err) {
    console.error('getSegments error:', err);
    return [];
  }
}

// Create default segments for restaurant
async function createDefaultSegments(restaurantId) {
  const defaults = [
    { segment_type: 'vip', name: 'VIP Kunder', description: 'Kunder med mere end 10 ordrer', filter_rules: { min_orders: 10 } },
    { segment_type: 'new', name: 'Nye Kunder', description: 'Kunder med kun 1 ordre', filter_rules: { max_orders: 1, days_since_first: 30 } },
    { segment_type: 'inactive', name: 'Inaktive Kunder', description: 'Ingen ordre i 30+ dage', filter_rules: { days_inactive: 30 } },
    { segment_type: 'high_value', name: 'H√∏jv√¶rdi Kunder', description: 'Gennemsnitlig ordre over 300 kr', filter_rules: { min_avg_order: 300 } },
    { segment_type: 'at_risk', name: 'At Risk', description: 'Aktive kunder uden ordre i 14-30 dage', filter_rules: { days_inactive_min: 14, days_inactive_max: 30, min_orders: 2 } },
    { segment_type: 'loyal', name: 'Loyale Kunder', description: 'Gold eller Platinum loyalty tier', filter_rules: { tier: ['gold', 'platinum'] } }
  ];

  for (const seg of defaults) {
    try {
      await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/customer_segments`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': CONFIG.SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
        },
        body: JSON.stringify({
          restaurant_id: restaurantId,
          ...seg,
          color: SEGMENT_TYPES[seg.segment_type]?.color || '#6366f1',
          icon: SEGMENT_TYPES[seg.segment_type]?.icon || ''
        })
      });
    } catch (err) {
      console.error('createDefaultSegments error:', err);
    }
  }
}

// Render segments page
async function renderSegmentsPage() {
  const restaurantId = document.getElementById('test-restaurant')?.value;
  const content = document.getElementById('segments-content') || document.getElementById('main-content');

  if (!restaurantId) {
    content.innerHTML = '<div class="empty-state"><p>V√¶lg en restaurant f√∏rst</p></div>';
    return;
  }

  let segments = await getSegments(restaurantId);

  // Create defaults if none exist
  if (segments.length === 0) {
    await createDefaultSegments(restaurantId);
    segments = await getSegments(restaurantId);
  }

  const totalCustomers = segments.reduce((sum, s) => sum + (s.customer_count || 0), 0);

  const html = `
    <div class="page-header">
      <h1>Kundesegmenter</h1>
      <p class="text-secondary">Grupp√©r kunder for m√•lrettet kommunikation</p>
    </div>

    <!-- Stats -->
    <div class="stats-grid" style="margin-bottom:24px">
      <div class="stat-card">
        <div class="stat-value">${segments.length}</div>
        <div class="stat-label">Segmenter</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${totalCustomers}</div>
        <div class="stat-label">Kunder i segmenter</div>
      </div>
    </div>

    <!-- Segments Grid -->
    <div class="card" style="margin-bottom:24px">
      <div class="card-header">
        <h3>üìä Dine segmenter</h3>
        <button class="btn btn-primary btn-sm" onclick="showCreateSegmentModal()">+ Tilpasset segment</button>
      </div>
      <div class="card-body">
        <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:16px">
          ${segments.map(s => `
            <div class="segment-card" style="background:var(--card2);border-radius:12px;padding:20px;border:2px solid ${s.color || '#6366f1'}20;position:relative">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                <div style="width:48px;height:48px;border-radius:12px;background:${s.color || '#6366f1'}20;display:flex;align-items:center;justify-content:center;font-size:24px">
                  ${SEGMENT_TYPES[s.segment_type]?.icon || ''}
                </div>
                <div>
                  <h4 style="margin:0;font-size:16px">${s.name}</h4>
                  <p class="text-secondary" style="margin:0;font-size:12px">${s.description || ''}</p>
                </div>
              </div>
              <div style="display:flex;justify-content:space-between;align-items:center;padding-top:12px;border-top:1px solid var(--border)">
                <div>
                  <span style="font-size:24px;font-weight:700">${s.customer_count || 0}</span>
                  <span class="text-secondary" style="font-size:13px"> kunder</span>
                </div>
                <div style="display:flex;gap:8px">
                  <button class="btn btn-sm" onclick="viewSegmentCustomers('${s.id}')" title="Se kunder">Vis</button>
                  <button class="btn btn-sm" onclick="sendToSegment('${s.id}')" title="Send SMS">Send</button>
                  ${s.segment_type === 'custom' ? `<button class="btn btn-sm btn-danger" onclick="deleteSegment('${s.id}')" title="Slet">Slet</button>` : ''}
                </div>
              </div>
              ${s.last_updated ? `<p class="text-secondary" style="font-size:11px;margin-top:8px">Opdateret: ${new Date(s.last_updated).toLocaleDateString('da-DK')}</p>` : ''}
            </div>
          `).join('')}
        </div>
      </div>
    </div>

    <!-- Segment Explanation -->
    <div class="card">
      <div class="card-header">
        <h3>S√•dan virker segmenter</h3>
      </div>
      <div class="card-body">
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:24px">
          <div>
            <h4 style="display:flex;align-items:center;gap:8px;margin-bottom:8px">VIP Kunder</h4>
            <p class="text-secondary" style="font-size:13px">Kunder med mange ordrer. Bel√∏n dem med eksklusive tilbud.</p>
          </div>
          <div>
            <h4 style="display:flex;align-items:center;gap:8px;margin-bottom:8px">Inaktive</h4>
            <p class="text-secondary" style="font-size:13px">Kunder der ikke har bestilt i 30+ dage. Genaktiver dem med rabatkoder.</p>
          </div>
          <div>
            <h4 style="display:flex;align-items:center;gap:8px;margin-bottom:8px">At Risk</h4>
            <p class="text-secondary" style="font-size:13px">Kunder p√• vej til at blive inaktive. Handl hurtigt!</p>
          </div>
          <div>
            <h4 style="display:flex;align-items:center;gap:8px;margin-bottom:8px">H√∏jv√¶rdi</h4>
            <p class="text-secondary" style="font-size:13px">Kunder med h√∏j gennemsnitlig ordre. Tilbyd premium-service.</p>
          </div>
        </div>
      </div>
    </div>
  `;

  content.innerHTML = html;
}

// Show create segment modal
function showCreateSegmentModal() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.id = 'segment-modal';
  modal.innerHTML = `
    <div class="modal" style="max-width:500px">
      <div class="modal-header">
        <h3>Opret tilpasset segment</h3>
        <button class="modal-close" onclick="closeSegmentModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Navn *</label>
          <input type="text" class="input" id="segment-name" placeholder="F.eks. Fredag-kunder">
        </div>
        <div class="form-group">
          <label class="form-label">Beskrivelse</label>
          <input type="text" class="input" id="segment-description" placeholder="Kort beskrivelse">
        </div>
        <h4 style="margin:20px 0 12px">Filterregler</h4>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="form-group">
            <label class="form-label">Min. antal ordrer</label>
            <input type="number" class="input" id="segment-min-orders" min="0" placeholder="0">
          </div>
          <div class="form-group">
            <label class="form-label">Max antal ordrer</label>
            <input type="number" class="input" id="segment-max-orders" min="0" placeholder="Ubegr√¶nset">
          </div>
          <div class="form-group">
            <label class="form-label">Dage inaktiv (min)</label>
            <input type="number" class="input" id="segment-days-inactive" min="0" placeholder="0">
          </div>
          <div class="form-group">
            <label class="form-label">Min. gennemsnitsordre (kr)</label>
            <input type="number" class="input" id="segment-min-avg" min="0" placeholder="0">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Loyalty tier</label>
          <select class="input" id="segment-tier">
            <option value="">Alle tiers</option>
            <option value="bronze">Bronze</option>
            <option value="silver">S√∏lv</option>
            <option value="gold">Guld</option>
            <option value="platinum">Platin</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeSegmentModal()">Annuller</button>
        <button class="btn btn-primary" onclick="saveSegment()">Opret</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
}

// Close segment modal
function closeSegmentModal() {
  document.getElementById('segment-modal')?.remove();
}

// Save segment
async function saveSegment() {
  const restaurantId = document.getElementById('test-restaurant')?.value;
  if (!restaurantId) return;

  const name = document.getElementById('segment-name')?.value?.trim();
  const description = document.getElementById('segment-description')?.value?.trim();

  if (!name) {
    toast('Indtast et navn', 'error');
    return;
  }

  const filter_rules = {};
  const minOrders = parseInt(document.getElementById('segment-min-orders')?.value);
  const maxOrders = parseInt(document.getElementById('segment-max-orders')?.value);
  const daysInactive = parseInt(document.getElementById('segment-days-inactive')?.value);
  const minAvg = parseInt(document.getElementById('segment-min-avg')?.value);
  const tier = document.getElementById('segment-tier')?.value;

  if (!isNaN(minOrders) && minOrders > 0) filter_rules.min_orders = minOrders;
  if (!isNaN(maxOrders)) filter_rules.max_orders = maxOrders;
  if (!isNaN(daysInactive) && daysInactive > 0) filter_rules.days_inactive = daysInactive;
  if (!isNaN(minAvg) && minAvg > 0) filter_rules.min_avg_order = minAvg;
  if (tier) filter_rules.tier = [tier];

  try {
    await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/customer_segments`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': CONFIG.SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify({
        restaurant_id: restaurantId,
        name,
        description,
        segment_type: 'custom',
        filter_rules,
        color: '#6366f1',
        icon: ''
      })
    });

    toast('Segment oprettet', 'success');
    closeSegmentModal();
    renderSegmentsPage();
  } catch (err) {
    console.error('saveSegment error:', err);
    toast('Fejl ved oprettelse', 'error');
  }
}

// Delete segment
async function deleteSegment(segmentId) {
  if (!confirm('Er du sikker p√• du vil slette dette segment?')) return;

  try {
    await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/customer_segments?id=eq.${segmentId}`, {
      method: 'DELETE',
      headers: {
        'apikey': CONFIG.SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
      }
    });

    toast('Segment slettet', 'success');
    renderSegmentsPage();
  } catch (err) {
    toast('Fejl ved sletning', 'error');
  }
}

// View customers in segment
function viewSegmentCustomers(segmentId) {
  toast('Kunde-visning kommer snart', 'info');
  // TODO: Show modal with customers matching segment
}

// Send SMS to segment
function sendToSegment(segmentId) {
  toast('SMS til segment kommer snart', 'info');
  // TODO: Open campaign modal with segment pre-selected
}

// Export segment functions
window.renderSegmentsPage = renderSegmentsPage;
window.showCreateSegmentModal = showCreateSegmentModal;
window.closeSegmentModal = closeSegmentModal;
window.saveSegment = saveSegment;
window.deleteSegment = deleteSegment;
window.viewSegmentCustomers = viewSegmentCustomers;
window.sendToSegment = sendToSegment;

// =====================================================
// UDSENDELSER (Email/SMS Campaign Overview)
// =====================================================

// Cache for udsendelser
let udsendelserCache = [];

// Render udsendelser page
async function renderUdsendelserPage() {
  const contentEl = document.getElementById('udsendelser-content');
  if (!contentEl) return;

  contentEl.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';

  // Get restaurant ID
  const restaurantId = document.getElementById('test-restaurant')?.value;

  // Mock data for now - can be replaced with real API calls
  const udsendelser = [
    { id: 1, title: 'Velkomsttilbud til nye kunder', type: 'email', sent_at: '2024-01-15', recipients: 156, opened: 89, clicked: 34, status: 'completed' },
    { id: 2, title: 'Weekend special SMS', type: 'sms', sent_at: '2024-01-12', recipients: 423, opened: null, clicked: null, status: 'completed' },
    { id: 3, title: 'Nyhedsbrev januar', type: 'email', sent_at: '2024-01-10', recipients: 892, opened: 456, clicked: 123, status: 'completed' },
    { id: 4, title: 'Loyalitetsbonus reminder', type: 'sms', sent_at: '2024-01-05', recipients: 234, opened: null, clicked: null, status: 'completed' }
  ];

  // Calculate stats
  const totalSent = udsendelser.reduce((sum, u) => sum + u.recipients, 0);
  const emailUdsendelser = udsendelser.filter(u => u.type === 'email');
  const avgOpenRate = emailUdsendelser.length > 0
    ? Math.round(emailUdsendelser.reduce((sum, u) => sum + ((u.opened / u.recipients) * 100), 0) / emailUdsendelser.length)
    : 0;
  const avgClickRate = emailUdsendelser.length > 0
    ? Math.round(emailUdsendelser.reduce((sum, u) => sum + ((u.clicked / u.recipients) * 100), 0) / emailUdsendelser.length)
    : 0;

  const html = `
    <div class="page-header" style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h1>Udsendelser</h1>
        <p class="text-secondary">Oversigt over email og SMS kampagner</p>
      </div>
      <button class="btn btn-primary" onclick="showCreateUdsendelseModal()">Opret udsendelse</button>
    </div>

    <!-- Stats -->
    <div class="stats-grid" style="margin-bottom:24px">
      <div class="stat-card">
        <div class="stat-value">${udsendelser.length}</div>
        <div class="stat-label">Udsendelser</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${totalSent.toLocaleString('da-DK')}</div>
        <div class="stat-label">Sendt i alt</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${avgOpenRate}%</div>
        <div class="stat-label">Gns. √•bningsrate</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">${avgClickRate}%</div>
        <div class="stat-label">Gns. klikrate</div>
      </div>
    </div>

    <!-- Filter tabs -->
    <div class="card">
      <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
        <h3>Sendte udsendelser</h3>
        <div class="btn-group" id="udsendelser-filter">
          <button class="btn btn-sm active" onclick="filterUdsendelser('all')">Alle</button>
          <button class="btn btn-sm" onclick="filterUdsendelser('email')">Email</button>
          <button class="btn btn-sm" onclick="filterUdsendelser('sms')">SMS</button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-container">
          <table class="data-table" id="udsendelser-table">
            <thead>
              <tr>
                <th>Titel</th>
                <th>Type</th>
                <th>Sendt</th>
                <th>Modtagere</th>
                <th>√Öbnet</th>
                <th>Klikket</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${udsendelser.map(u => `
                <tr data-type="${u.type}">
                  <td><strong>${u.title}</strong></td>
                  <td>
                    <span class="badge" style="background:${u.type === 'email' ? 'var(--accent)' : 'var(--warning)'};color:white">
                      ${u.type === 'email' ? 'Email' : 'SMS'}
                    </span>
                  </td>
                  <td>${new Date(u.sent_at).toLocaleDateString('da-DK')}</td>
                  <td>${u.recipients.toLocaleString('da-DK')}</td>
                  <td>${u.opened !== null ? Math.round((u.opened / u.recipients) * 100) + '%' : '-'}</td>
                  <td>${u.clicked !== null ? Math.round((u.clicked / u.recipients) * 100) + '%' : '-'}</td>
                  <td>
                    <span class="badge badge-success">Sendt</span>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;

  contentEl.innerHTML = html;
}

// Filter udsendelser by type
function filterUdsendelser(type) {
  const table = document.getElementById('udsendelser-table');
  if (!table) return;

  const rows = table.querySelectorAll('tbody tr');
  rows.forEach(row => {
    if (type === 'all' || row.dataset.type === type) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });

  // Update active button
  const buttons = document.querySelectorAll('#udsendelser-filter .btn');
  buttons.forEach(btn => {
    btn.classList.remove('active');
    if (btn.textContent.toLowerCase().includes(type) || (type === 'all' && btn.textContent === 'Alle')) {
      btn.classList.add('active');
    }
  });
}

// Show create udsendelse modal
function showCreateUdsendelseModal() {
  // TODO: Implement create udsendelse modal
  toast('Opret udsendelse kommer snart', 'info');
}

// Export udsendelser functions
window.renderUdsendelserPage = renderUdsendelserPage;
window.filterUdsendelser = filterUdsendelser;
window.showCreateUdsendelseModal = showCreateUdsendelseModal;

// =====================================================
// ROLE MANAGEMENT
// =====================================================

const AVAILABLE_PERMISSIONS = [
  { id: 'customers', label: 'Kunder', desc: 'Se og rediger kunder' },
  { id: 'customers_read', label: 'Kunder (l√¶s)', desc: 'Kun se kunder' },
  { id: 'workflow', label: 'Workflow', desc: 'Administrer workflows' },
  { id: 'reports', label: 'Rapporter', desc: 'Se rapporter og statistik' },
  { id: 'leads', label: 'Leads', desc: 'Administrer leads' },
  { id: 'settings', label: 'Indstillinger', desc: '√Ündre indstillinger' },
  { id: 'users', label: 'Brugere', desc: 'Administrer brugere' },
  { id: 'billing', label: 'Fakturering', desc: 'Se fakturering' },
];

const ROLE_COLORS = [
  '#2dd4bf', '#22c55e', '#f97316', '#ef4444', '#8b5cf6',
  '#ec4899', '#3b82f6', '#eab308', '#6b7280', '#14b8a6'
];

let selectedRoleId = null;
let selectedRoleColor = '#6b7280';

// Load roles page
async function loadRolesPage() {
  const rolesList = document.getElementById('roles-list');
  if (!rolesList) return;

  rolesList.innerHTML = '<div class="role-item-loading">Indl√¶ser roller...</div>';

  try {
    const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/custom_roles?order=is_system.desc,name.asc`, {
      headers: {
        'apikey': CONFIG.SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
      }
    });

    if (!response.ok) throw new Error('Kunne ikke hente roller');

    const roles = await response.json();

    if (roles.length === 0) {
      rolesList.innerHTML = '<div class="roles-users-empty">Ingen roller fundet</div>';
      return;
    }

    rolesList.innerHTML = roles.map(role => `
      <div class="role-item ${selectedRoleId === role.id ? 'active' : ''}"
           onclick="selectRole('${role.id}')"
           data-role-id="${role.id}">
        <div class="role-item-info">
          <span class="role-color-dot" style="background:${role.color || '#6b7280'}"></span>
          <span class="role-item-name">${role.name}</span>
          ${role.is_system ? '<span class="role-system-badge">System</span>' : ''}
        </div>
        ${!role.is_system ? `
          <button class="btn-icon-sm btn-danger-ghost" onclick="event.stopPropagation(); deleteRole('${role.id}', '${role.name}')" title="Slet rolle">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
            </svg>
          </button>
        ` : ''}
      </div>
    `).join('');

  } catch (err) {
    console.error('loadRolesPage error:', err);
    rolesList.innerHTML = '<div class="roles-users-empty">Fejl ved indl√¶sning af roller</div>';
  }
}

// Select a role and show users
async function selectRole(roleId) {
  selectedRoleId = roleId;

  // Update active state in list
  document.querySelectorAll('.role-item').forEach(item => {
    item.classList.toggle('active', item.dataset.roleId === roleId);
  });

  const usersContent = document.getElementById('role-users-content');
  const usersTitle = document.getElementById('role-users-title');

  if (!usersContent) return;

  usersContent.innerHTML = '<div class="role-item-loading">Indl√¶ser brugere...</div>';

  try {
    // First get the role name
    const roleResponse = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/custom_roles?id=eq.${roleId}`, {
      headers: {
        'apikey': CONFIG.SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
      }
    });
    const roleData = await roleResponse.json();
    const roleName = roleData[0]?.name || 'Ukendt';

    if (usersTitle) {
      usersTitle.textContent = `Brugere med "${roleName}"`;
    }

    // Map display names to database role values
    const roleMapping = {
      'Administrator': 'admin',
      'Manager': 'manager',
      'Personale': 'employee'
    };
    const dbRoleName = roleMapping[roleName] || roleName.toLowerCase();

    // Get users by role name from user_roles table
    const usersResponse = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/user_roles?role=eq.${dbRoleName}&select=user_id,profiles(id,email,full_name,avatar_url)`, {
      headers: {
        'apikey': CONFIG.SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
      }
    });

    if (!usersResponse.ok) {
      throw new Error('Kunne ikke hente brugere');
    }

    const users = await usersResponse.json();
    renderRoleUsers(users, usersContent);

  } catch (err) {
    console.error('selectRole error:', err);
    usersContent.innerHTML = '<div class="roles-users-empty">Fejl ved indl√¶sning af brugere</div>';
  }
}

function renderRoleUsers(users, container) {
  if (!users || users.length === 0) {
    container.innerHTML = '<div class="roles-users-empty">Ingen brugere med denne rolle</div>';
    return;
  }

  container.innerHTML = users.map(u => {
    const profile = u.profiles || {};
    const name = profile.full_name || profile.email || 'Ukendt bruger';
    const email = profile.email || '';
    const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);

    return `
      <div class="role-user-item">
        <div class="role-user-avatar">${initials}</div>
        <div class="role-user-info">
          <div class="role-user-name">${name}</div>
          <div class="role-user-email">${email}</div>
        </div>
      </div>
    `;
  }).join('');
}

// Show add role modal
function showAddRoleModal() {
  const modal = document.getElementById('add-role-modal');
  if (!modal) return;

  // Reset form
  document.getElementById('new-role-name').value = '';
  selectedRoleColor = '#6b7280';

  // Setup color picker
  const colorGrid = document.getElementById('role-color-picker');
  if (colorGrid) {
    colorGrid.innerHTML = ROLE_COLORS.map(color => `
      <div class="color-option ${color === selectedRoleColor ? 'selected' : ''}"
           style="background:${color}"
           data-color="${color}"
           onclick="selectRoleColor('${color}')"></div>
    `).join('');
  }

  // Setup permissions checkboxes
  const permGrid = document.getElementById('permissions-grid');
  if (permGrid) {
    permGrid.innerHTML = AVAILABLE_PERMISSIONS.map(perm => `
      <label class="permission-checkbox">
        <input type="checkbox" value="${perm.id}">
        <div class="permission-info">
          <span class="permission-label">${perm.label}</span>
          <span class="permission-desc">${perm.desc}</span>
        </div>
      </label>
    `).join('');
  }

  modal.classList.add('active');
}

// Select role color
function selectRoleColor(color) {
  selectedRoleColor = color;
  document.querySelectorAll('.color-option').forEach(opt => {
    opt.classList.toggle('selected', opt.dataset.color === color);
  });
}

// Close add role modal
function closeAddRoleModal() {
  const modal = document.getElementById('add-role-modal');
  if (modal) modal.classList.remove('active');
}

// Save new role
async function saveNewRole() {
  const nameInput = document.getElementById('new-role-name');
  const name = nameInput?.value?.trim();

  if (!name) {
    toast('Indtast et rollenavn', 'error');
    return;
  }

  // Get selected permissions
  const permissions = [];
  document.querySelectorAll('#permissions-grid input[type="checkbox"]:checked').forEach(cb => {
    permissions.push(cb.value);
  });

  try {
    const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/custom_roles`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': CONFIG.SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
        'Prefer': 'return=representation'
      },
      body: JSON.stringify({
        name,
        color: selectedRoleColor,
        permissions: permissions,
        is_system: false
      })
    });

    if (!response.ok) {
      const err = await response.text();
      if (err.includes('duplicate') || err.includes('unique')) {
        toast('En rolle med dette navn findes allerede', 'error');
      } else {
        toast('Kunne ikke oprette rolle', 'error');
      }
      return;
    }

    toast('Rolle oprettet', 'success');
    closeAddRoleModal();
    loadRolesPage();

  } catch (err) {
    console.error('saveNewRole error:', err);
    toast('Fejl ved oprettelse af rolle', 'error');
  }
}

// Delete role
async function deleteRole(roleId, roleName) {
  if (!confirm(`Er du sikker p√• du vil slette rollen "${roleName}"?`)) return;

  try {
    const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/custom_roles?id=eq.${roleId}&is_system=eq.false`, {
      method: 'DELETE',
      headers: {
        'apikey': CONFIG.SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
      }
    });

    if (!response.ok) {
      toast('Kunne ikke slette rolle', 'error');
      return;
    }

    toast('Rolle slettet', 'success');

    // Reset selection if deleted role was selected
    if (selectedRoleId === roleId) {
      selectedRoleId = null;
      const usersContent = document.getElementById('role-users-content');
      const usersTitle = document.getElementById('role-users-title');
      if (usersContent) usersContent.innerHTML = '<div class="roles-users-empty">V√¶lg en rolle for at se tilknyttede brugere</div>';
      if (usersTitle) usersTitle.textContent = 'Brugere';
    }

    loadRolesPage();

  } catch (err) {
    console.error('deleteRole error:', err);
    toast('Fejl ved sletning af rolle', 'error');
  }
}

// Export role management functions
window.loadRolesPage = loadRolesPage;
window.selectRole = selectRole;
window.showAddRoleModal = showAddRoleModal;
window.selectRoleColor = selectRoleColor;
window.closeAddRoleModal = closeAddRoleModal;
window.saveNewRole = saveNewRole;
window.deleteRole = deleteRole;

// =====================================================
// VERSION & CACHE MANAGEMENT
// =====================================================

/**
 * Update version display in System Status
 */
function updateSystemVersion() {
  const versionEl = document.getElementById('system-version');
  if (versionEl && window.VERSION_CONFIG) {
    versionEl.textContent = VERSION_CONFIG.getDisplayVersion();
  }
}

/**
 * Clear Service Worker cache and reload
 * Preserves: theme, session
 */
async function clearAppCache() {
  const confirmed = confirm('Er du sikker p√• at du vil rydde cachen? Siden vil genindl√¶ses.');
  if (!confirmed) return;

  toast('Rydder cache...', 'info');

  try {
    // Clear Service Worker caches
    if ('caches' in window) {
      const cacheNames = await caches.keys();
      await Promise.all(
        cacheNames.map(cacheName => caches.delete(cacheName))
      );
      console.log('Service Worker caches cleared');
    }

    // Unregister Service Workers to force fresh install
    if ('serviceWorker' in navigator) {
      const registrations = await navigator.serviceWorker.getRegistrations();
      for (const registration of registrations) {
        await registration.unregister();
      }
      console.log('Service Workers unregistered');
    }

    toast('Cache ryddet! Genindl√¶ser...', 'success');

    // Force hard reload after short delay
    setTimeout(() => {
      window.location.reload(true);
    }, 1000);

  } catch (error) {
    console.error('Error clearing cache:', error);
    toast('Fejl ved rydning af cache', 'error');
  }
}

/**
 * Clear all app data including localStorage (except session and theme)
 */
async function clearAppCacheAndData() {
  const confirmed = confirm(
    'ADVARSEL: Dette vil slette alle lokale data!\n\n' +
    'Din session og tema-indstilling bevares, men alt andet nulstilles.\n\n' +
    'Forts√¶t?'
  );
  if (!confirmed) return;

  toast('Rydder alle data...', 'info');

  try {
    // Preserve these keys
    const preserveKeys = ['theme', 'orderflow_session'];
    const preserved = {};

    // Save preserved values
    preserveKeys.forEach(key => {
      const value = localStorage.getItem(key);
      if (value) preserved[key] = value;
    });

    // Clear localStorage
    localStorage.clear();

    // Restore preserved values
    Object.entries(preserved).forEach(([key, value]) => {
      localStorage.setItem(key, value);
    });

    console.log('localStorage cleared (preserved: theme, session)');

    // Clear Service Worker caches
    if ('caches' in window) {
      const cacheNames = await caches.keys();
      await Promise.all(
        cacheNames.map(cacheName => caches.delete(cacheName))
      );
    }

    // Unregister Service Workers
    if ('serviceWorker' in navigator) {
      const registrations = await navigator.serviceWorker.getRegistrations();
      for (const registration of registrations) {
        await registration.unregister();
      }
    }

    toast('Alle data ryddet! Genindl√¶ser...', 'success');

    setTimeout(() => {
      window.location.reload(true);
    }, 1000);

  } catch (error) {
    console.error('Error clearing data:', error);
    toast('Fejl ved rydning af data', 'error');
  }
}

// Export cache management functions
window.clearAppCache = clearAppCache;
window.clearAppCacheAndData = clearAppCacheAndData;
window.updateSystemVersion = updateSystemVersion;

// Initialize version display when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', updateSystemVersion);
} else {
  updateSystemVersion();
}

// ==================== APP BUILDER FUNCTIONS ====================

// Show App Builder page
function showAppBuilderPage(page) {
  // Hide all pages
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

  // Show the requested App Builder page
  const pageEl = document.getElementById('page-appbuilder-' + page);
  if (pageEl) {
    pageEl.classList.add('active');
  }

  // Clear all active states
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.nav-dropdown-item').forEach(i => i.classList.remove('active'));
  document.querySelectorAll('.nav-dropdown-toggle').forEach(t => t.classList.remove('active'));

  // Activate the App Builder dropdown
  const appBuilderDropdown = document.getElementById('nav-appbuilder');
  if (appBuilderDropdown) {
    // Activate toggle
    const toggle = appBuilderDropdown.querySelector('.nav-dropdown-toggle');
    if (toggle) toggle.classList.add('active');

    // Activate specific dropdown item
    const items = appBuilderDropdown.querySelectorAll('.nav-dropdown-item');
    items.forEach(item => {
      const onclick = item.getAttribute('onclick');
      if (onclick && onclick.includes(`'${page}'`)) {
        item.classList.add('active');
      }
    });

    // Ensure dropdown is open
    if (!appBuilderDropdown.classList.contains('open')) {
      appBuilderDropdown.classList.add('open');
    }
  }

  // Close sidebar on mobile
  if (window.innerWidth < 1024) {
    document.querySelector('.sidebar')?.classList.remove('open');
  }
}

// Update App Builder color
function updateAppBuilderColor(type, color) {
  // Update preview swatch
  const preview = document.getElementById(`appbuilder-${type}-preview`);
  if (preview) {
    preview.style.background = color;
  }

  // Update value display
  const valueEl = document.getElementById(`appbuilder-${type}-value`);
  if (valueEl) {
    valueEl.textContent = color.toUpperCase();
  }

  // Send to iframe
  const previewFrame = document.getElementById('pwa-preview-frame');
  if (previewFrame) {
    const config = {};
    config[type + 'Color'] = color;

    previewFrame.contentWindow.postMessage({
      type: 'UPDATE_CONFIG',
      config: config
    }, '*');
  }
}

// Adjust color brightness
function adjustColor(color, amount) {
  const hex = color.replace('#', '');
  const r = Math.max(0, Math.min(255, parseInt(hex.substr(0, 2), 16) + amount));
  const g = Math.max(0, Math.min(255, parseInt(hex.substr(2, 2), 16) + amount));
  const b = Math.max(0, Math.min(255, parseInt(hex.substr(4, 2), 16) + amount));
  return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
}

// Handle App Builder logo upload
function handleAppBuilderLogoUpload(input) {
  const file = input.files[0];
  if (!file) return;

  // Validate file size (2MB max)
  const maxSize = 2 * 1024 * 1024; // 2MB in bytes
  if (file.size > maxSize) {
    alert('Filen er for stor. Maksimal st√∏rrelse er 2MB.');
    input.value = '';
    return;
  }

  // Validate file type
  const allowedTypes = ['image/png', 'image/jpeg', 'image/svg+xml'];
  if (!allowedTypes.includes(file.type)) {
    alert('Ugyldig filtype. Tilladte formater: PNG, JPG, SVG.');
    input.value = '';
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const logoUrl = e.target.result;

    // Update upload area with preview
    const uploadZone = document.querySelector('.logo-upload-zone');
    if (uploadZone) {
      uploadZone.innerHTML = `
        <img src="${logoUrl}"
             style="max-width:120px;max-height:120px;border-radius:var(--radius-lg);margin-bottom:12px;">
        <p style="font-size:14px;font-weight:500;color:var(--text);margin-bottom:4px">Klik for at √¶ndre</p>
        <p style="font-size:12px;color:var(--muted)">${file.name}</p>
      `;
      uploadZone.classList.add('has-file');
      uploadZone.onclick = () => input.click();
    }

    // Send to iframe
    const previewFrame = document.getElementById('pwa-preview-frame');
    if (previewFrame) {
      previewFrame.contentWindow.postMessage({
        type: 'UPDATE_CONFIG',
        config: {
          logoUrl: logoUrl
        }
      }, '*');
    }

    // Show saved badge
    showSavedBadge('branding');
  };
  reader.readAsDataURL(file);
}

// Handle App Builder banner upload
function handleAppBuilderBannerUpload(input) {
  const file = input.files[0];
  if (!file) return;

  // Validate file size (3MB max for banner)
  const maxSize = 3 * 1024 * 1024; // 3MB
  if (file.size > maxSize) {
    alert('Filen er for stor. Maksimal st√∏rrelse er 3MB.');
    input.value = '';
    return;
  }

  // Validate file type
  const allowedTypes = ['image/png', 'image/jpeg'];
  if (!allowedTypes.includes(file.type)) {
    alert('Ugyldig filtype. Tilladte formater: PNG, JPG.');
    input.value = '';
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const bannerUrl = e.target.result;

    // Update upload zone with preview
    const uploadZone = document.getElementById('banner-upload-zone');
    if (uploadZone) {
      uploadZone.innerHTML = `
        <img src="${bannerUrl}"
             style="width:100%;height:auto;max-height:160px;object-fit:cover;border-radius:var(--radius-md);box-shadow:0 4px 12px rgba(0,0,0,0.1);">
      `;
      uploadZone.classList.add('has-file');
    }

    // Show remove button
    const removeBtn = document.getElementById('remove-banner-btn');
    if (removeBtn) {
      removeBtn.style.display = 'block';
    }

    // Send to iframe
    const previewFrame = document.getElementById('pwa-preview-frame');
    if (previewFrame) {
      previewFrame.contentWindow.postMessage({
        type: 'UPDATE_CONFIG',
        config: {
          bannerUrl: bannerUrl
        }
      }, '*');
    }

    // Show saved badge
    showSavedBadge('banner');
  };
  reader.readAsDataURL(file);
}

// Remove App Builder banner
function removeAppBuilderBanner() {
  // Reset upload zone to default state
  const uploadZone = document.getElementById('banner-upload-zone');
  if (uploadZone) {
    uploadZone.innerHTML = `
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom:16px;color:var(--muted)">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
        <circle cx="8.5" cy="8.5" r="1.5"/>
        <polyline points="21 15 16 10 5 21"/>
      </svg>
      <p style="font-size:14px;font-weight:500;color:var(--text);margin-bottom:4px">
        Klik for at uploade banner billede
      </p>
      <p style="font-size:12px;color:var(--muted)">
        PNG eller JPG. Anbefalet: 1200x400px. Max 3MB
      </p>
    `;
    uploadZone.classList.remove('has-file');
    uploadZone.onclick = () => document.getElementById('appbuilder-banner-input').click();
  }

  // Hide remove button
  const removeBtn = document.getElementById('remove-banner-btn');
  if (removeBtn) {
    removeBtn.style.display = 'none';
  }

  // Clear file input
  const fileInput = document.getElementById('appbuilder-banner-input');
  if (fileInput) {
    fileInput.value = '';
  }

  // Send removal to iframe
  const previewFrame = document.getElementById('pwa-preview-frame');
  if (previewFrame) {
    previewFrame.contentWindow.postMessage({
      type: 'UPDATE_CONFIG',
      config: {
        bannerUrl: null  // Remove banner, revert to gradient
      }
    }, '*');
  }
}

// Update App Builder preview name
function updateAppBuilderPreviewName() {
  const nameInput = document.getElementById('appbuilder-app-name');
  const previewFrame = document.getElementById('pwa-preview-frame');

  if (nameInput && previewFrame) {
    const value = nameInput.value.trim() || 'Din Restaurant';

    // Send message to iframe
    previewFrame.contentWindow.postMessage({
      type: 'UPDATE_CONFIG',
      config: {
        appName: value
      }
    }, '*');
  }
}

// Update App Builder preview tagline
function updateAppBuilderPreviewTagline() {
  const taglineInput = document.getElementById('appbuilder-tagline');
  const previewFrame = document.getElementById('pwa-preview-frame');

  if (taglineInput && previewFrame) {
    const value = taglineInput.value.trim() || '√Ügte italiensk pizza siden 1985';

    // Send message to iframe
    previewFrame.contentWindow.postMessage({
      type: 'UPDATE_CONFIG',
      config: {
        tagline: value
      }
    }, '*');
  }
}

// Show saved badge with auto-hide
let badgeTimeouts = {};

function showSavedBadge(section) {
  const badgeId = `${section}-status-badge`;
  const badge = document.getElementById(badgeId);

  if (!badge) return;

  // Clear existing timeout for this badge
  if (badgeTimeouts[badgeId]) {
    clearTimeout(badgeTimeouts[badgeId]);
  }

  // Show badge with animation
  badge.style.display = 'inline-flex';

  // Auto-hide after 2 seconds
  badgeTimeouts[badgeId] = setTimeout(() => {
    badge.style.display = 'none';
  }, 2000);
}

function getAppBuilderPreviewConfig() {
  const nameInput = document.getElementById('appbuilder-app-name');
  const taglineInput = document.getElementById('appbuilder-tagline');
  const primaryColorInput = document.getElementById('appbuilder-primary-color');
  const secondaryColorInput = document.getElementById('appbuilder-secondary-color');

  return {
    appName: nameInput?.value || 'Din Restaurant',
    tagline: taglineInput?.value || 'Autentisk smag siden 1985',
    primaryColor: primaryColorInput?.value || '#D4380D',
    secondaryColor: secondaryColorInput?.value || '#FFF7E6'
  };
}

function getAppPreviewBasePath() {
  const origin = window.location.origin;
  const pathBase = window.location.pathname.replace(/[^/]*$/, '');

  if (origin && origin !== 'null') {
    return origin + pathBase;
  }

  const href = window.location.href.split('#')[0].split('?')[0];
  return href.replace(/[^/]*$/, '');
}

function getAppPreviewUrl() {
  return getAppPreviewBasePath() + 'pwa-preview.html';
}

function ensureQRCodeLibrary() {
  if (typeof QRCode !== 'undefined') {
    return Promise.resolve(true);
  }

  return new Promise((resolve) => {
    const existing = document.querySelector('script[data-qrcode-lib="true"]');
    if (existing) {
      existing.addEventListener('load', () => resolve(true));
      existing.addEventListener('error', () => resolve(false));
      return;
    }

    const script = document.createElement('script');
    script.src = 'js/vendor/qrcode.min.js';
    script.async = true;
    script.dataset.qrcodeLib = 'true';
    script.onload = () => resolve(true);
    script.onerror = () => resolve(false);
    document.head.appendChild(script);
  });
}

// Send initial config to App Builder preview - called directly from iframe onload
function sendInitialAppBuilderConfig() {
  const previewFrame = document.getElementById('pwa-preview-frame');
  if (!previewFrame || !previewFrame.contentWindow) {
    console.warn('PWA preview frame not available');
    return;
  }

  // Wait for iframe to be fully loaded
  setTimeout(() => {
    try {
      const config = getAppBuilderPreviewConfig();

      previewFrame.contentWindow.postMessage({
        type: 'UPDATE_CONFIG',
        config: config
      }, '*');

      // Also send scroll reset command
      previewFrame.contentWindow.postMessage({
        type: 'RESET_SCROLL'
      }, '*');

    } catch (err) {
      console.warn('Error sending PWA config:', err);
    }
  }, 100);
}

// Initialize App Builder event listeners
function initAppBuilder() {
  const previewFrame = document.getElementById('pwa-preview-frame');

  if (previewFrame) {
    // Handle iframe load event
    previewFrame.addEventListener('load', () => {
      // Small delay to ensure iframe content is ready
      setTimeout(() => {
        sendInitialAppBuilderConfig();
      }, 150);
    });

    // Handle messages from iframe
    window.addEventListener('message', (event) => {
      if (event.data?.type === 'PWA_READY') {
        sendInitialAppBuilderConfig();
      }
    });
  }
}

// Show QR code for mobile app preview
function showAppPreviewQR() {
  const container = document.getElementById('app-preview-qr-container');
  if (!container) return;

  container.innerHTML = '<p style="color:var(--muted);margin:0">Indl√¶ser QR-kode...</p>';
  container.style.minWidth = '200px';
  container.style.minHeight = '200px';
  container.style.width = '200px';
  container.style.height = '200px';
  container.style.background = '#ffffff';
  container.style.borderRadius = '12px';

  // Generate preview URL (current host + pwa-preview.html)
  const previewUrl = getAppPreviewUrl();

  const renderFallback = (message) => {
    container.innerHTML = `
      <div style="text-align:center">
        <p style="color:var(--muted);margin:0 0 8px">${message}</p>
        <p style="font-size:12px;color:var(--text);word-break:break-all;margin:0">${previewUrl}</p>
      </div>
    `;
  };

  showModal('app-preview-qr');

  ensureQRCodeLibrary().then((loaded) => {
    if (!loaded || typeof QRCode === 'undefined') {
      renderFallback('QR-kode bibliotek ikke tilg√¶ngeligt');
      return;
    }

    const renderQR = () => {
      container.innerHTML = '';

      try {
        new QRCode(container, {
          text: previewUrl,
          width: 200,
          height: 200,
          colorDark: '#000000',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel ? QRCode.CorrectLevel.M : 2
        });
      } catch (err) {
        console.warn('QR-kode fejl:', err);
        renderFallback('Kunne ikke generere QR-kode');
      }
    };

    requestAnimationFrame(() => {
      renderQR();
      setTimeout(renderQR, 50);
    });
  });
}

function openAppPreviewTemplate() {
  const previewUrl = getAppPreviewUrl();
  const templateWindow = window.open(previewUrl, '_blank', 'noopener');

  if (!templateWindow) {
    toast('Popup blev blokeret. Tillad popups for at √•bne skabelonen.', 'warning');
    return;
  }

  const config = getAppBuilderPreviewConfig();
  const sendConfig = () => {
    if (templateWindow.closed) return;
    templateWindow.postMessage({ type: 'UPDATE_CONFIG', config: config }, '*');
    templateWindow.postMessage({ type: 'RESET_SCROLL' }, '*');
  };

  templateWindow.addEventListener('load', sendConfig);
  setTimeout(sendConfig, 400);
}

// Publish mobile app
function publishMobileApp() {
  // Get current app config
  const config = {
    appName: document.getElementById('appbuilder-app-name')?.value || 'Min App',
    tagline: document.getElementById('appbuilder-tagline')?.value || '',
    primaryColor: document.getElementById('appbuilder-primary-color')?.value || '#000000',
    secondaryColor: document.getElementById('appbuilder-secondary-color')?.value || '#ffffff',
    publishedAt: new Date().toISOString(),
    status: 'published'
  };

  // Save to localStorage
  localStorage.setItem('published_mobile_app', JSON.stringify(config));

  toast('App publiceret!', 'success');
}

// =====================================================
// ACCOUNT PAGE FUNCTIONS
// =====================================================

// Navigate to account page
function showAccountPage(page) {
  // Close profile dropdown
  const dropdown = document.getElementById('profile-dropdown');
  if (dropdown) dropdown.classList.remove('active');

  // Hide all pages
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

  // Show requested page
  const targetPage = document.getElementById('page-' + page);
  if (targetPage) {
    targetPage.classList.add('active');

    // Load data based on page
    switch(page) {
      case 'mine-oplysninger':
        loadAccountInfo();
        break;
      case 'betalingsmetoder':
        loadPaymentMethods();
        break;
      case 'leveringsadresser':
        loadDeliveryAddresses();
        break;
      case 'ordrehistorik':
        loadOrderHistory();
        break;
    }
  }
}

// ========== Mine Oplysninger ==========

function loadAccountInfo() {
  const profile = JSON.parse(localStorage.getItem('orderflow_user_profile') || '{}');

  const firstnameEl = document.getElementById('account-firstname');
  const lastnameEl = document.getElementById('account-lastname');
  const emailEl = document.getElementById('account-email');
  const phoneEl = document.getElementById('account-phone');

  if (firstnameEl) firstnameEl.value = profile.firstName || '';
  if (lastnameEl) lastnameEl.value = profile.lastName || '';
  if (emailEl) emailEl.value = profile.email || (currentUser?.email || '');
  if (phoneEl) phoneEl.value = profile.phone || '';
}

function saveAccountInfo() {
  const profile = {
    firstName: document.getElementById('account-firstname')?.value || '',
    lastName: document.getElementById('account-lastname')?.value || '',
    email: document.getElementById('account-email')?.value || '',
    phone: document.getElementById('account-phone')?.value || ''
  };

  localStorage.setItem('orderflow_user_profile', JSON.stringify(profile));

  // Update topbar display
  updateProfileDropdownDisplay(profile);

  const statusEl = document.getElementById('account-save-status');
  if (statusEl) {
    statusEl.textContent = 'Gemt!';
    setTimeout(() => { statusEl.textContent = ''; }, 2000);
  }
  toast('Oplysninger gemt', 'success');
}

function updateProfileDropdownDisplay(profile) {
  const nameEl = document.getElementById('dropdown-name');
  const emailEl = document.getElementById('dropdown-email');
  const avatarEl = document.getElementById('topbar-avatar');

  const fullName = [profile.firstName, profile.lastName].filter(Boolean).join(' ') || 'Bruger';

  if (nameEl) nameEl.textContent = fullName;
  if (emailEl) emailEl.textContent = profile.email || '';
  if (avatarEl) avatarEl.textContent = (profile.firstName?.[0] || 'B').toUpperCase();
}

function changeAccountPassword() {
  const current = document.getElementById('account-current-password')?.value;
  const newPass = document.getElementById('account-new-password')?.value;
  const confirm = document.getElementById('account-confirm-password')?.value;

  if (!current || !newPass || !confirm) {
    toast('Udfyld alle felter', 'error');
    return;
  }

  if (newPass !== confirm) {
    toast('Adgangskoderne matcher ikke', 'error');
    return;
  }

  if (newPass.length < 6) {
    toast('Adgangskoden skal v√¶re mindst 6 tegn', 'error');
    return;
  }

  // In a real implementation, this would call an API
  toast('Adgangskode √¶ndret', 'success');

  // Clear fields
  document.getElementById('account-current-password').value = '';
  document.getElementById('account-new-password').value = '';
  document.getElementById('account-confirm-password').value = '';
}

// ========== Betalingsmetoder ==========

function loadPaymentMethods() {
  const methods = JSON.parse(localStorage.getItem('orderflow_payment_methods') || '[]');
  const container = document.getElementById('payment-methods-list');

  if (!container) return;

  if (methods.length === 0) {
    container.innerHTML = `
      <div class="empty" style="padding:40px;text-align:center">
        <div class="empty-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
            <line x1="1" y1="10" x2="23" y2="10"/>
          </svg>
        </div>
        <div style="margin-top:12px">Ingen betalingsmetoder tilf√∏jet</div>
        <div style="font-size:var(--font-size-sm);color:var(--muted);margin-top:8px">
          Tilf√∏j et kort for hurtigere betaling
        </div>
      </div>
    `;
    return;
  }

  container.innerHTML = methods.map((method, index) => `
    <div class="setting-card" style="display:flex;align-items:center;justify-content:space-between;padding:var(--space-4)">
      <div style="display:flex;align-items:center;gap:var(--space-4)">
        <div style="width:48px;height:32px;background:var(--bg3);border-radius:4px;display:flex;align-items:center;justify-content:center">
          ${getCardTypeIcon(method.type)}
        </div>
        <div>
          <div style="font-weight:500">${method.type} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${method.lastFour}</div>
          <div style="font-size:var(--font-size-sm);color:var(--muted)">Udl√∏ber ${method.expiry}</div>
        </div>
      </div>
      <div style="display:flex;gap:var(--space-2)">
        ${method.isDefault ? '<span style="background:var(--accent);color:#fff;padding:2px 8px;border-radius:4px;font-size:12px">Standard</span>' : ''}
        <button class="btn btn-secondary" style="padding:6px 12px" onclick="deletePaymentMethod(${index})">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
          </svg>
        </button>
      </div>
    </div>
  `).join('');
}

function getCardTypeIcon(type) {
  const icons = {
    'Visa': '<svg width="32" height="20" viewBox="0 0 32 20"><rect fill="#1A1F71" width="32" height="20" rx="2"/><text x="16" y="13" text-anchor="middle" fill="#fff" font-size="8" font-weight="bold">VISA</text></svg>',
    'Mastercard': '<svg width="32" height="20" viewBox="0 0 32 20"><rect fill="#000" width="32" height="20" rx="2"/><circle cx="12" cy="10" r="6" fill="#EB001B"/><circle cx="20" cy="10" r="6" fill="#F79E1B"/></svg>',
    'MobilePay': '<svg width="32" height="20" viewBox="0 0 32 20"><rect fill="#5A78FF" width="32" height="20" rx="2"/><text x="16" y="13" text-anchor="middle" fill="#fff" font-size="6" font-weight="bold">MobilePay</text></svg>'
  };
  return icons[type] || '<svg width="32" height="20" viewBox="0 0 32 20"><rect fill="#666" width="32" height="20" rx="2"/></svg>';
}

function showAddPaymentMethodModal() {
  let modal = document.getElementById('payment-method-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'payment-method-modal';
    modal.className = 'modal';
    document.body.appendChild(modal);
  }

  modal.innerHTML = `
    <div class="modal-overlay" onclick="closePaymentMethodModal()"></div>
    <div class="modal-content" style="max-width:400px">
      <div class="modal-header">
        <h3>Tilf√∏j betalingsmetode</h3>
        <button class="modal-close" onclick="closePaymentMethodModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding:var(--space-5)">
        <div class="form-group">
          <label class="form-label">Korttype</label>
          <select class="input" id="new-card-type">
            <option value="Visa">Visa</option>
            <option value="Mastercard">Mastercard</option>
            <option value="MobilePay">MobilePay</option>
          </select>
        </div>
        <div class="form-group" style="margin-top:var(--space-4)">
          <label class="form-label">Kortnummer</label>
          <input type="text" class="input" id="new-card-number" placeholder="1234 5678 9012 3456" maxlength="19">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--space-4);margin-top:var(--space-4)">
          <div class="form-group">
            <label class="form-label">Udl√∏bsdato</label>
            <input type="text" class="input" id="new-card-expiry" placeholder="MM/YY" maxlength="5">
          </div>
          <div class="form-group">
            <label class="form-label">CVV</label>
            <input type="text" class="input" id="new-card-cvv" placeholder="123" maxlength="4">
          </div>
        </div>
        <div style="margin-top:var(--space-4)">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input type="checkbox" id="new-card-default">
            <span style="font-size:var(--font-size-sm)">G√∏r til standardkort</span>
          </label>
        </div>
      </div>
      <div class="modal-footer" style="padding:var(--space-4);display:flex;gap:var(--space-3);justify-content:flex-end">
        <button class="btn btn-secondary" onclick="closePaymentMethodModal()">Annuller</button>
        <button class="btn btn-primary" onclick="addPaymentMethod()">Tilf√∏j kort</button>
      </div>
    </div>
  `;

  modal.classList.add('active');
}

function closePaymentMethodModal() {
  const modal = document.getElementById('payment-method-modal');
  if (modal) modal.classList.remove('active');
}

function addPaymentMethod() {
  const type = document.getElementById('new-card-type')?.value;
  const number = document.getElementById('new-card-number')?.value.replace(/\s/g, '');
  const expiry = document.getElementById('new-card-expiry')?.value;
  const isDefault = document.getElementById('new-card-default')?.checked;

  if (!number || number.length < 12) {
    toast('Indtast gyldigt kortnummer', 'error');
    return;
  }

  if (!expiry || expiry.length < 5) {
    toast('Indtast gyldig udl√∏bsdato', 'error');
    return;
  }

  const methods = JSON.parse(localStorage.getItem('orderflow_payment_methods') || '[]');

  // If this is default, remove default from others
  if (isDefault) {
    methods.forEach(m => m.isDefault = false);
  }

  methods.push({
    type: type,
    lastFour: number.slice(-4),
    expiry: expiry,
    isDefault: isDefault || methods.length === 0
  });

  localStorage.setItem('orderflow_payment_methods', JSON.stringify(methods));

  closePaymentMethodModal();
  loadPaymentMethods();
  toast('Betalingsmetode tilf√∏jet', 'success');
}

function deletePaymentMethod(index) {
  if (!confirm('Er du sikker p√• du vil fjerne denne betalingsmetode?')) return;

  const methods = JSON.parse(localStorage.getItem('orderflow_payment_methods') || '[]');
  methods.splice(index, 1);
  localStorage.setItem('orderflow_payment_methods', JSON.stringify(methods));

  loadPaymentMethods();
  toast('Betalingsmetode fjernet', 'success');
}

// ========== Leveringsadresser ==========

function loadDeliveryAddresses() {
  const addresses = JSON.parse(localStorage.getItem('orderflow_delivery_addresses') || '[]');
  const container = document.getElementById('delivery-addresses-list');

  if (!container) return;

  if (addresses.length === 0) {
    container.innerHTML = `
      <div class="empty" style="padding:40px;text-align:center">
        <div class="empty-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
        </div>
        <div style="margin-top:12px">Ingen adresser tilf√∏jet</div>
        <div style="font-size:var(--font-size-sm);color:var(--muted);margin-top:8px">
          Tilf√∏j en adresse for hurtigere levering
        </div>
      </div>
    `;
    return;
  }

  container.innerHTML = addresses.map((addr, index) => `
    <div class="setting-card" style="padding:var(--space-4)">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div style="font-weight:500;margin-bottom:4px">${addr.label || 'Adresse'}</div>
          <div style="color:var(--text2)">${addr.street}</div>
          <div style="color:var(--muted);font-size:var(--font-size-sm)">${addr.postalCode} ${addr.city}</div>
          ${addr.note ? `<div style="color:var(--muted);font-size:var(--font-size-sm);margin-top:4px">${addr.note}</div>` : ''}
        </div>
        <div style="display:flex;gap:var(--space-2);align-items:center">
          ${addr.isDefault ? '<span style="background:var(--accent);color:#fff;padding:2px 8px;border-radius:4px;font-size:12px">Standard</span>' : ''}
          <button class="btn btn-secondary" style="padding:6px 12px" onclick="editAddress(${index})">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
          </button>
          <button class="btn btn-secondary" style="padding:6px 12px" onclick="deleteAddress(${index})">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  `).join('');
}

function showAddAddressModal(editIndex = null) {
  const addresses = JSON.parse(localStorage.getItem('orderflow_delivery_addresses') || '[]');
  const addr = editIndex !== null ? addresses[editIndex] : {};
  const isEdit = editIndex !== null;

  let modal = document.getElementById('address-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'address-modal';
    modal.className = 'modal';
    document.body.appendChild(modal);
  }

  modal.innerHTML = `
    <div class="modal-overlay" onclick="closeAddressModal()"></div>
    <div class="modal-content" style="max-width:450px">
      <div class="modal-header">
        <h3>${isEdit ? 'Rediger adresse' : 'Tilf√∏j adresse'}</h3>
        <button class="modal-close" onclick="closeAddressModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding:var(--space-5)">
        <div class="form-group">
          <label class="form-label">Betegnelse</label>
          <input type="text" class="input" id="address-label" placeholder="F.eks. Hjem, Arbejde" value="${addr.label || ''}">
        </div>
        <div class="form-group" style="margin-top:var(--space-4)">
          <label class="form-label">Adresse</label>
          <input type="text" class="input" id="address-street" placeholder="Gadenavn og nummer" value="${addr.street || ''}">
        </div>
        <div style="display:grid;grid-template-columns:120px 1fr;gap:var(--space-4);margin-top:var(--space-4)">
          <div class="form-group">
            <label class="form-label">Postnummer</label>
            <input type="text" class="input" id="address-postal" placeholder="2100" maxlength="4" value="${addr.postalCode || ''}">
          </div>
          <div class="form-group">
            <label class="form-label">By</label>
            <input type="text" class="input" id="address-city" placeholder="K√∏benhavn" value="${addr.city || ''}">
          </div>
        </div>
        <div class="form-group" style="margin-top:var(--space-4)">
          <label class="form-label">Note (valgfri)</label>
          <input type="text" class="input" id="address-note" placeholder="F.eks. Ring p√• d√∏ren" value="${addr.note || ''}">
        </div>
        <div style="margin-top:var(--space-4)">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input type="checkbox" id="address-default" ${addr.isDefault ? 'checked' : ''}>
            <span style="font-size:var(--font-size-sm)">G√∏r til standardadresse</span>
          </label>
        </div>
      </div>
      <div class="modal-footer" style="padding:var(--space-4);display:flex;gap:var(--space-3);justify-content:flex-end">
        <button class="btn btn-secondary" onclick="closeAddressModal()">Annuller</button>
        <button class="btn btn-primary" onclick="saveAddress(${editIndex})">${isEdit ? 'Gem' : 'Tilf√∏j'}</button>
      </div>
    </div>
  `;

  modal.classList.add('active');
}

function closeAddressModal() {
  const modal = document.getElementById('address-modal');
  if (modal) modal.classList.remove('active');
}

function editAddress(index) {
  showAddAddressModal(index);
}

function saveAddress(editIndex) {
  const label = document.getElementById('address-label')?.value.trim();
  const street = document.getElementById('address-street')?.value.trim();
  const postalCode = document.getElementById('address-postal')?.value.trim();
  const city = document.getElementById('address-city')?.value.trim();
  const note = document.getElementById('address-note')?.value.trim();
  const isDefault = document.getElementById('address-default')?.checked;

  if (!street || !postalCode || !city) {
    toast('Udfyld adresse, postnummer og by', 'error');
    return;
  }

  const addresses = JSON.parse(localStorage.getItem('orderflow_delivery_addresses') || '[]');

  if (isDefault) {
    addresses.forEach(a => a.isDefault = false);
  }

  const newAddr = { label, street, postalCode, city, note, isDefault: isDefault || addresses.length === 0 };

  if (editIndex !== null) {
    addresses[editIndex] = newAddr;
  } else {
    addresses.push(newAddr);
  }

  localStorage.setItem('orderflow_delivery_addresses', JSON.stringify(addresses));

  closeAddressModal();
  loadDeliveryAddresses();
  toast(editIndex !== null ? 'Adresse opdateret' : 'Adresse tilf√∏jet', 'success');
}

function deleteAddress(index) {
  if (!confirm('Er du sikker p√• du vil fjerne denne adresse?')) return;

  const addresses = JSON.parse(localStorage.getItem('orderflow_delivery_addresses') || '[]');
  addresses.splice(index, 1);
  localStorage.setItem('orderflow_delivery_addresses', JSON.stringify(addresses));

  loadDeliveryAddresses();
  toast('Adresse fjernet', 'success');
}

// ========== Ordre Historik ==========

let orderHistoryPage = 1;
const ORDERS_PER_PAGE = 10;

function loadOrderHistory() {
  // Get orders from the orders_module (existing system) and mark completed ones
  const allOrders = JSON.parse(localStorage.getItem('orders_module') || '[]');
  const historyOrders = JSON.parse(localStorage.getItem('orderflow_order_history') || '[]');

  // Combine completed orders from active orders + history
  const completedFromActive = allOrders.filter(o =>
    o.status === 'F√¶rdig' || o.status === 'Afvist' || o.status === 'Annulleret'
  );

  // Merge without duplicates (by ID)
  const existingIds = new Set(historyOrders.map(o => o.id));
  completedFromActive.forEach(order => {
    if (!existingIds.has(order.id)) {
      historyOrders.push({
        ...order,
        completedAt: order.completedAt || new Date().toISOString()
      });
    }
  });

  // Sort by date (newest first)
  historyOrders.sort((a, b) => new Date(b.completedAt || b.timestamp) - new Date(a.completedAt || a.timestamp));

  // Save merged history
  localStorage.setItem('orderflow_order_history', JSON.stringify(historyOrders));

  // Apply filters and render
  filterOrderHistory();
}

function filterOrderHistory() {
  const fromDate = document.getElementById('history-from-date')?.value;
  const toDate = document.getElementById('history-to-date')?.value;
  const statusFilter = document.getElementById('history-status-filter')?.value;

  let orders = JSON.parse(localStorage.getItem('orderflow_order_history') || '[]');

  // Apply filters
  if (fromDate) {
    const from = new Date(fromDate);
    orders = orders.filter(o => new Date(o.completedAt || o.timestamp) >= from);
  }

  if (toDate) {
    const to = new Date(toDate);
    to.setHours(23, 59, 59);
    orders = orders.filter(o => new Date(o.completedAt || o.timestamp) <= to);
  }

  if (statusFilter) {
    orders = orders.filter(o => o.status === statusFilter);
  }

  renderOrderHistory(orders);
}

function renderOrderHistory(orders) {
  const container = document.getElementById('order-history-list');
  const paginationContainer = document.getElementById('order-history-pagination');

  if (!container) return;

  if (orders.length === 0) {
    container.innerHTML = `
      <div class="empty" style="padding:60px;text-align:center">
        <div class="empty-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
            <line x1="12" y1="22.08" x2="12" y2="12"/>
          </svg>
        </div>
        <div style="margin-top:12px">Ingen ordrer fundet</div>
        <div style="font-size:var(--font-size-sm);color:var(--muted);margin-top:8px">
          Dine gennemf√∏rte ordrer vises her
        </div>
      </div>
    `;
    if (paginationContainer) paginationContainer.innerHTML = '';
    return;
  }

  // Pagination
  const totalPages = Math.ceil(orders.length / ORDERS_PER_PAGE);
  const startIndex = (orderHistoryPage - 1) * ORDERS_PER_PAGE;
  const pageOrders = orders.slice(startIndex, startIndex + ORDERS_PER_PAGE);

  container.innerHTML = pageOrders.map(order => {
    const statusColors = {
      'F√¶rdig': { bg: 'rgba(52,211,153,0.15)', color: '#34d399', text: 'Gennemf√∏rt' },
      'Afvist': { bg: 'rgba(248,113,113,0.15)', color: '#f87171', text: 'Afvist' },
      'Annulleret': { bg: 'rgba(156,163,175,0.15)', color: '#9ca3af', text: 'Annulleret' }
    };
    const status = statusColors[order.status] || statusColors['F√¶rdig'];

    const orderDate = new Date(order.completedAt || order.timestamp);
    const formattedDate = orderDate.toLocaleDateString('da-DK', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });
    const formattedTime = orderDate.toLocaleTimeString('da-DK', {
      hour: '2-digit',
      minute: '2-digit'
    });

    return `
      <div class="setting-card" style="padding:var(--space-4)">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:var(--space-3)">
          <div>
            <div style="font-weight:600;font-size:var(--font-size-base)">Ordre #${order.id}</div>
            <div style="font-size:var(--font-size-sm);color:var(--muted)">${formattedDate} kl. ${formattedTime}</div>
          </div>
          <span style="background:${status.bg};color:${status.color};padding:4px 12px;border-radius:20px;font-size:12px;font-weight:500">
            ${status.text}
          </span>
        </div>

        <div style="background:var(--bg3);padding:var(--space-3);border-radius:var(--radius-sm);margin-bottom:var(--space-3)">
          <div style="font-size:var(--font-size-sm);color:var(--text2)">${order.items || 'Ingen varer angivet'}</div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <span style="font-size:var(--font-size-sm);color:var(--muted)">${order.orderType || 'Pickup'}</span>
            ${order.address ? `<span style="font-size:var(--font-size-sm);color:var(--muted)"> - ${order.address}</span>` : ''}
          </div>
          <div style="display:flex;align-items:center;gap:var(--space-3)">
            <span style="font-weight:600">${formatOrderPrice(order.total || 0)} kr</span>
            ${order.status === 'F√¶rdig' ? `
              <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="reorder('${order.id}')">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M23 4v6h-6"/>
                  <path d="M1 20v-6h6"/>
                  <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                </svg>
                Genbestil
              </button>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');

  // Render pagination
  if (paginationContainer && totalPages > 1) {
    let paginationHTML = '';

    if (orderHistoryPage > 1) {
      paginationHTML += `<button class="btn btn-secondary" style="padding:6px 12px" onclick="goToHistoryPage(${orderHistoryPage - 1})">‚Üê</button>`;
    }

    for (let i = 1; i <= totalPages; i++) {
      const isActive = i === orderHistoryPage;
      paginationHTML += `
        <button class="btn ${isActive ? 'btn-primary' : 'btn-secondary'}"
                style="padding:6px 12px;min-width:36px"
                onclick="goToHistoryPage(${i})">${i}</button>
      `;
    }

    if (orderHistoryPage < totalPages) {
      paginationHTML += `<button class="btn btn-secondary" style="padding:6px 12px" onclick="goToHistoryPage(${orderHistoryPage + 1})">‚Üí</button>`;
    }

    paginationContainer.innerHTML = paginationHTML;
  } else if (paginationContainer) {
    paginationContainer.innerHTML = '';
  }
}

function goToHistoryPage(page) {
  orderHistoryPage = page;
  filterOrderHistory();

  // Scroll to top of list
  document.getElementById('order-history-list')?.scrollIntoView({ behavior: 'smooth' });
}

function reorder(orderId) {
  const history = JSON.parse(localStorage.getItem('orderflow_order_history') || '[]');
  const order = history.find(o => String(o.id) === String(orderId));

  if (!order) {
    toast('Ordre ikke fundet', 'error');
    return;
  }

  // Create new order based on previous
  const newOrder = {
    id: Date.now().toString(),
    phone: order.phone,
    customerName: order.customerName,
    orderType: order.orderType,
    address: order.address,
    items: order.items,
    total: order.total,
    restaurantId: order.restaurantId,
    status: 'Ny',
    timestamp: new Date().toISOString()
  };

  const orders = JSON.parse(localStorage.getItem('orders_module') || '[]');
  orders.unshift(newOrder);
  localStorage.setItem('orders_module', JSON.stringify(orders));

  toast('Ordre genbestilt!', 'success');

  // Navigate to orders page
  showPage('orders');
}

function formatOrderPrice(price) {
  return new Intl.NumberFormat('da-DK').format(price);
}

// =====================================================
// WEB BUILDER FUNCTIONS
// =====================================================

// Default Web Builder configuration
const defaultWebBuilderConfig = {
  branding: {
    name: 'Din Restaurant',
    slogan: 'Autentisk smag siden 1985',
    description: 'Velkommen til vores restaurant. Vi serverer de bedste retter med friske ingredienser.',
    logo: '',
    colors: {
      primary: '#D4380D',
      secondary: '#FFF7E6',
      accent: '#FFA940',
      text: '#1A1A1A'
    },
    fonts: {
      heading: 'Playfair Display',
      body: 'Inter'
    }
  },
  contact: {
    address: '',
    postalCode: '',
    city: '',
    phone: '',
    email: '',
    socialMedia: {
      facebook: '',
      instagram: '',
      tiktok: ''
    }
  },
  businessHours: {
    monday: { open: '11:00', close: '22:00', closed: false },
    tuesday: { open: '11:00', close: '22:00', closed: false },
    wednesday: { open: '11:00', close: '22:00', closed: false },
    thursday: { open: '11:00', close: '22:00', closed: false },
    friday: { open: '11:00', close: '23:00', closed: false },
    saturday: { open: '12:00', close: '23:00', closed: false },
    sunday: { open: '12:00', close: '21:00', closed: false }
  },
  delivery: {
    enabled: true,
    fee: 35,
    minimumOrder: 150,
    freeDeliveryThreshold: 300,
    estimatedTime: 45
  },
  features: {
    ordering: true,
    loyalty: true,
    pickup: true,
    delivery: true,
    customerAccounts: false,
    pushNotifications: false
  },
  menu: {
    currency: 'DKK',
    taxRate: 25
  },
  images: {
    hero: '',
    featured: ''
  }
};

let webBuilderConfig = null;

// Navigate to Web Builder page with specific section
function showWebBuilderPage(section) {
  // Map section names to page IDs
  const pageMap = {
    'branding': 'wb-branding',
    'farver': 'wb-farver',
    'billeder': 'wb-billeder',
    'menu': 'wb-menu',
    'timer': 'wb-timer',
    'kontakt': 'wb-kontakt',
    'levering': 'wb-levering',
    'funktioner': 'wb-funktioner',
    'social': 'wb-social'
  };

  const pageId = pageMap[section] || 'wb-branding';
  showPage(pageId);

  // Update sidebar active state
  document.querySelectorAll('#nav-webbuilder-section .nav-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  const activeBtn = document.getElementById('nav-wb-' + section);
  if (activeBtn) activeBtn.classList.add('active');

  // Special handling for hours tab
  if (section === 'timer') {
    renderBusinessHoursGrid();
  }

  // Load config if needed and initialize preview
  if (!webBuilderConfig) {
    loadWebBuilderConfig();
  }

  // Update preview after page switch (give iframe time to load)
  setTimeout(() => {
    updateWebBuilderPreview();
  }, 300);
}

// Navigate to Flow landing page (opens in new window)
function showFlowPage(slug) {
  // Map slugs to HTML file names
  const pageMap = {
    'landing': 'landing.html',
    'restaurant-hjemmeside': 'restaurant-hjemmeside.html',
    'online-bestilling': 'online-bestilling.html',
    'custom-mobile-app': 'custom-mobile-app.html',
    'zero-commission-delivery': 'zero-commission-delivery.html',
    'loyalitetsprogram': 'loyalitetsprogram.html',
    'automatiseret-marketing': 'automatiseret-marketing.html',
    'case-studies': 'case-studies.html',
    'restaurant-marketing-guide': 'restaurant-marketing-guide.html',
    'seo-for-restauranter': 'seo-for-restauranter.html',
    'restaurant-email-marketing': 'restaurant-email-marketing.html',
    'restaurant-mobile-app': 'restaurant-mobile-app.html',
    'online-bestillingssystemer': 'online-bestillingssystemer.html',
    'om-os': 'om-os.html',
    'karriere': 'karriere.html',
    'ledelse': 'ledelse.html',
    'presse': 'presse.html',
    'partner': 'partner.html',
    'priser': 'landing.html#priser',
    'how-it-works': 'how-it-works.html',
    'blog': 'blog.html'
  };

  const pagePath = pageMap[slug] || slug + '.html';
  window.open(pagePath, '_blank');
}

// =====================================================
// FLOW CMS FUNCTIONS
// =====================================================

// Flow CMS State
let currentEditingPage = null;
let blogPosts = [];
let currentBlogPost = null;

// Flow Pages List
const flowPagesList = [
  { slug: 'landing', title: 'Landing Page', description: 'Hovedside med hero og features' },
  { slug: 'restaurant-hjemmeside', title: 'Restaurant Hjemmeside', description: 'Produktside for hjemmesider' },
  { slug: 'online-bestilling', title: 'Online Bestilling', description: 'Produktside for bestillingssystem' },
  { slug: 'custom-mobile-app', title: 'Custom Mobile App', description: 'Produktside for mobilapp' },
  { slug: 'zero-commission-delivery', title: 'Zero-Commission Delivery', description: 'Produktside for levering' },
  { slug: 'loyalitetsprogram', title: 'Loyalitetsprogram', description: 'Produktside for loyalitet' },
  { slug: 'automatiseret-marketing', title: 'Automatiseret Marketing', description: 'Produktside for marketing' },
  { slug: 'case-studies', title: 'Case Studies', description: 'Kundehistorier og resultater' },
  { slug: 'seo-for-restauranter', title: 'SEO for Restauranter', description: 'Guide til s√∏gemaskineoptimering' },
  { slug: 'restaurant-email-marketing', title: 'Restaurant Email Marketing', description: 'Guide til email marketing' },
  { slug: 'restaurant-mobile-app', title: 'Restaurant Mobile App', description: 'Guide til mobilapps' },
  { slug: 'online-bestillingssystemer', title: 'Online Bestillingssystemer', description: 'Sammenligning af systemer' },
  { slug: 'om-os', title: 'Om os', description: 'Virksomhedsprofil' },
  { slug: 'karriere', title: 'Karriere', description: 'Jobopslag og kultur' },
  { slug: 'ledelse', title: 'Ledelse', description: 'Ledelseshold' },
  { slug: 'presse', title: 'Presse', description: 'Pressemateriale' },
  { slug: 'partner', title: 'Partner med Flow', description: 'Partnerprogram' },
  { slug: 'how-it-works', title: 'S√•dan virker det', description: 'Produktoversigt' }
];

// Default content for Flow pages (template content that shows before customer edits)
const defaultFlowPageContent = {
  'landing': {
    hero: {
      title: 'AUTOMATION BYGGET TIL AT √òGE SALG',
      subtitle: 'Flow giver dig de samme v√¶rkt√∏jer som store restaurantk√¶der bruger.',
      ctaText: 'F√• en gratis demo',
      ctaUrl: '#demo'
    },
    features: { items: ['Mere Google Trafik', 'Mere Online Salg', 'Flere Genbestillinger', 'Flere App Downloads'] },
    cta: { title: 'Klar til at √∏ge dit salg?', buttonText: 'Book en demo' }
  },
  'restaurant-hjemmeside': {
    hero: {
      title: 'Professionel restaurant hjemmeside',
      subtitle: 'F√• en moderne hjemmeside der tiltr√¶kker kunder og √∏ger dit online salg.',
      ctaText: 'Kom i gang',
      ctaUrl: '#demo'
    },
    features: { items: ['Responsivt design', 'Online bestilling', 'SEO optimeret', 'Hurtig indl√¶sning'] },
    cta: { title: 'F√• din egen hjemmeside', buttonText: 'Start gratis' }
  },
  'online-bestilling': {
    hero: {
      title: 'Online bestilling uden provision',
      subtitle: 'Undg√• dyre gebyrer fra tredjepartsplatforme. F√• dit eget bestillingssystem.',
      ctaText: 'Start gratis',
      ctaUrl: '#demo'
    },
    features: { items: ['0% provision', 'Direkte integration', 'Automatiske bekr√¶ftelser', 'Ordre-tracking'] },
    cta: { title: 'Spar penge p√• provision', buttonText: 'Kom i gang' }
  },
  'custom-mobile-app': {
    hero: {
      title: 'Din egen restaurant app',
      subtitle: 'Giv dine kunder en personlig app-oplevelse med dit brand.',
      ctaText: 'Se demo',
      ctaUrl: '#demo'
    },
    features: { items: ['Push notifikationer', 'Loyalty program', 'Online bestilling', 'Apple Pay & Google Pay'] },
    cta: { title: 'F√• din egen app', buttonText: 'Book demo' }
  },
  'zero-commission-delivery': {
    hero: {
      title: 'Levering uden provision',
      subtitle: 'Administrer din egen levering og behold 100% af oms√¶tningen.',
      ctaText: 'L√¶r mere',
      ctaUrl: '#demo'
    },
    features: { items: ['Ingen provision', 'Real-time tracking', 'Automatisk routing', 'Chauff√∏r-app'] },
    cta: { title: 'Start din levering', buttonText: 'Kom i gang' }
  },
  'loyalitetsprogram': {
    hero: {
      title: '√òg kundeloyaliteten',
      subtitle: 'Bel√∏n dine faste kunder og f√• dem til at vende tilbage igen og igen.',
      ctaText: 'Se hvordan',
      ctaUrl: '#demo'
    },
    features: { items: ['Point-system', 'Automatiske bel√∏nninger', 'VIP-tiers', 'F√∏dselsdagsbel√∏nninger'] },
    cta: { title: 'Start dit loyalty program', buttonText: 'Pr√∏v gratis' }
  },
  'automatiseret-marketing': {
    hero: {
      title: 'Marketing p√• autopilot',
      subtitle: 'Automatis√©r din markedsf√∏ring og n√• kunderne p√• det rigtige tidspunkt.',
      ctaText: 'Se muligheder',
      ctaUrl: '#demo'
    },
    features: { items: ['Email kampagner', 'SMS marketing', 'Automatiske flows', 'Segmentering'] },
    cta: { title: 'Automatis√©r din marketing', buttonText: 'Kom i gang' }
  },
  'case-studies': {
    hero: {
      title: 'Vores kunders succes',
      subtitle: 'Se hvordan andre restauranter har √∏get deres salg med Flow.',
      ctaText: 'Se cases',
      ctaUrl: '#cases'
    },
    features: { items: [] },
    cta: { title: 'Bliv den n√¶ste succes', buttonText: 'Book en demo' }
  },
  'seo-for-restauranter': {
    hero: {
      title: 'SEO for restauranter',
      subtitle: 'Bliv fundet af flere kunder p√• Google med vores SEO-guide.',
      ctaText: 'L√¶s guiden',
      ctaUrl: '#guide'
    },
    features: { items: ['Google My Business', 'Lokale s√∏gninger', 'Anmeldelser', 'Schema markup'] },
    cta: { title: 'Boost din synlighed', buttonText: 'Kom i gang' }
  },
  'restaurant-email-marketing': {
    hero: {
      title: 'Email marketing for restauranter',
      subtitle: 'L√¶r at bygge relationer med dine kunder via email.',
      ctaText: 'L√¶s guiden',
      ctaUrl: '#guide'
    },
    features: { items: ['Nyhedsbreve', 'Tilbudsmails', 'Automatiske flows', 'A/B testing'] },
    cta: { title: 'Start email marketing', buttonText: 'Pr√∏v gratis' }
  },
  'restaurant-mobile-app': {
    hero: {
      title: 'Mobilapps for restauranter',
      subtitle: 'Alt du skal vide om at f√• din egen restaurant-app.',
      ctaText: 'L√¶s mere',
      ctaUrl: '#info'
    },
    features: { items: ['Native apps', 'Push notifikationer', 'Loyalty integration', 'Online bestilling'] },
    cta: { title: 'F√• din egen app', buttonText: 'Se priser' }
  },
  'online-bestillingssystemer': {
    hero: {
      title: 'Sammenlign bestillingssystemer',
      subtitle: 'Find det bedste online bestillingssystem til din restaurant.',
      ctaText: 'Se sammenligning',
      ctaUrl: '#compare'
    },
    features: { items: ['Feature sammenligning', 'Prissammenligning', 'Integrationer', 'Support'] },
    cta: { title: 'V√¶lg det rigtige system', buttonText: 'Kontakt os' }
  },
  'om-os': {
    hero: {
      title: 'Om Flow',
      subtitle: 'Vi hj√¶lper restauranter med at vokse digitalt.',
      ctaText: 'L√¶r os at kende',
      ctaUrl: '#team'
    },
    features: { items: [] },
    cta: { title: 'Bliv en del af Flow', buttonText: 'Se ledige stillinger' }
  },
  'karriere': {
    hero: {
      title: 'Karriere hos Flow',
      subtitle: 'Bliv en del af et passioneret team der transformerer restaurant-branchen.',
      ctaText: 'Se stillinger',
      ctaUrl: '#jobs'
    },
    features: { items: ['Fleksibelt arbejde', 'Konkurrencedygtig l√∏n', 'Fantastisk team', 'Hurtig v√¶kst'] },
    cta: { title: 'Ans√∏g i dag', buttonText: 'Se ledige stillinger' }
  },
  'ledelse': {
    hero: {
      title: 'Vores ledelse',
      subtitle: 'M√∏d holdet bag Flow.',
      ctaText: 'Se teamet',
      ctaUrl: '#team'
    },
    features: { items: [] },
    cta: { title: 'Kontakt os', buttonText: 'Send besked' }
  },
  'presse': {
    hero: {
      title: 'Presse',
      subtitle: 'Pressemateriale og nyheder om Flow.',
      ctaText: 'Download materiale',
      ctaUrl: '#downloads'
    },
    features: { items: [] },
    cta: { title: 'Pressekontakt', buttonText: 'Kontakt os' }
  },
  'partner': {
    hero: {
      title: 'Bliv Flow Partner',
      subtitle: 'Tjen penge ved at hj√¶lpe restauranter med at vokse.',
      ctaText: 'Bliv partner',
      ctaUrl: '#apply'
    },
    features: { items: ['H√∏je provisioner', 'Marketing support', 'Dedikeret manager', 'Uddannelse'] },
    cta: { title: 'Start i dag', buttonText: 'Ans√∏g nu' }
  },
  'how-it-works': {
    hero: {
      title: 'S√•dan virker Flow',
      subtitle: 'Se hvor nemt det er at komme i gang med Flow.',
      ctaText: 'Se demo',
      ctaUrl: '#demo'
    },
    features: { items: ['Tilmeld dig', 'Ops√¶t din profil', 'G√• live', 'Se resultater'] },
    cta: { title: 'Kom i gang p√• 5 minutter', buttonText: 'Start gratis' }
  }
};

// =====================================================
// NEW CMS PAGES EDITOR (React Admin Style)
// =====================================================

// CMS State
let cmsPages = [];
let currentCMSPageId = null;
let cmsHasChanges = false;
let originalCMSPages = null;

// BroadcastChannel for cross-tab CMS sync
const cmsChannel = new BroadcastChannel('orderflow_cms_channel');

// =====================================================
// MEDIA LIBRARY
// =====================================================

let mediaLibraryTarget = null; // { sectionId, field } or callback function
let mediaLibraryItems = [];
let selectedMediaItem = null;

// Open media library modal
// target can be: string (input id), function (callback), or object with sectionId/field
// sectionId and field are used for CMS section field updates
async function openMediaLibrary(target, sectionId, field, mediaType = 'image') {
  console.log('openMediaLibrary called', { target, sectionId, field, mediaType });

  // If called with sectionId and field, construct the target object
  if (sectionId && field) {
    // Handle nested paths like tabs.0.image or backgroundVideos.0.url
    if (field.includes('.')) {
      const parts = field.split('.');
      mediaLibraryTarget = {
        inputId: target,
        sectionId,
        nestedPath: parts,
        type: mediaType === 'video' ? 'video' : 'image'
      };
    } else {
      mediaLibraryTarget = { inputId: target, sectionId, field, type: mediaType === 'video' ? 'video' : 'image' };
    }
  } else {
    mediaLibraryTarget = target;
  }
  selectedMediaItem = null;

  const modal = document.getElementById('media-library-modal');
  const grid = document.getElementById('media-library-grid');
  const empty = document.getElementById('media-library-empty');
  const loading = document.getElementById('media-library-loading');
  const selectBtn = document.getElementById('media-select-btn');

  console.log('Modal element found:', !!modal);

  if (!modal) {
    console.error('Media library modal not found in DOM!');
    toast('Kunne ikke √•bne medie bibliotek', 'error');
    return;
  }

  modal.classList.add('active');
  console.log('Modal classes after add:', modal.className);

  if (grid) grid.innerHTML = '';
  if (empty) empty.style.display = 'none';
  if (loading) loading.style.display = 'block';
  if (selectBtn) selectBtn.disabled = true;

  // Load media from Supabase
  try {
    console.log('Loading media from Supabase...');
    mediaLibraryItems = await SupabaseDB.listMedia('images');
    console.log('Loaded media items:', mediaLibraryItems?.length || 0);
    renderMediaLibrary();
  } catch (err) {
    console.error('Error loading media:', err);
    toast('Kunne ikke indl√¶se billeder', 'error');
  }

  if (loading) loading.style.display = 'none';
}

// Close media library modal
function closeMediaLibrary() {
  const modal = document.getElementById('media-library-modal');
  if (modal) {
    modal.classList.remove('active');
  }
  mediaLibraryTarget = null;
  selectedMediaItem = null;
}

// Render media library grid
function renderMediaLibrary(filter = '') {
  const grid = document.getElementById('media-library-grid');
  const empty = document.getElementById('media-library-empty');

  if (!grid) return;

  const filteredItems = filter
    ? mediaLibraryItems.filter(item => item.name.toLowerCase().includes(filter.toLowerCase()))
    : mediaLibraryItems;

  if (filteredItems.length === 0) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    return;
  }

  empty.style.display = 'none';

  grid.innerHTML = filteredItems.map(item => `
    <div class="media-library-item" data-path="${item.path}" data-url="${item.url}" onclick="selectMediaLibraryItem(this)" style="cursor:pointer;border:2px solid transparent;border-radius:8px;overflow:hidden;background:var(--bg-secondary);transition:border-color 0.2s">
      <div style="aspect-ratio:1;overflow:hidden;display:flex;align-items:center;justify-content:center;background:var(--bg-tertiary)">
        ${item.type === 'video'
          ? `<video src="${item.url}" style="width:100%;height:100%;object-fit:cover" muted></video>`
          : `<img src="${item.url}" alt="${item.name}" style="width:100%;height:100%;object-fit:cover">`
        }
      </div>
      <div style="padding:8px;font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${item.name}</div>
      <button onclick="event.stopPropagation();deleteMediaLibraryItem('${item.path}')" style="position:absolute;top:4px;right:4px;background:rgba(0,0,0,0.6);color:white;border:none;border-radius:4px;padding:4px 8px;font-size:11px;cursor:pointer;opacity:0;transition:opacity 0.2s" class="media-delete-btn">Slet</button>
    </div>
  `).join('');

  // Add hover effect for delete button
  grid.querySelectorAll('.media-library-item').forEach(item => {
    item.addEventListener('mouseenter', () => {
      item.querySelector('.media-delete-btn').style.opacity = '1';
    });
    item.addEventListener('mouseleave', () => {
      item.querySelector('.media-delete-btn').style.opacity = '0';
    });
  });
}

// Filter media library
function filterMediaLibrary(query) {
  renderMediaLibrary(query);
}

// Select a media item
function selectMediaLibraryItem(element) {
  // Deselect previous
  document.querySelectorAll('.media-library-item').forEach(item => {
    item.style.borderColor = 'transparent';
  });

  // Select new
  element.style.borderColor = 'var(--primary)';
  selectedMediaItem = {
    path: element.dataset.path,
    url: element.dataset.url
  };

  document.getElementById('media-select-btn').disabled = false;
}

// Confirm selection
function selectMediaItem() {
  if (!selectedMediaItem || !mediaLibraryTarget) return;

  if (typeof mediaLibraryTarget === 'function') {
    // Callback function
    mediaLibraryTarget(selectedMediaItem.url);
  } else if (mediaLibraryTarget.nestedPath) {
    // Nested CMS section field (e.g., tabs.0.image)
    const page = getCurrentCMSPage();
    if (page) {
      const section = page.sections.find(s => s.id === mediaLibraryTarget.sectionId);
      if (section) {
        let obj = section;
        for (let i = 0; i < mediaLibraryTarget.nestedPath.length - 1; i++) {
          const key = mediaLibraryTarget.nestedPath[i];
          obj = obj[key];
        }
        obj[mediaLibraryTarget.nestedPath[mediaLibraryTarget.nestedPath.length - 1]] = selectedMediaItem.url;
        page.updatedAt = new Date().toISOString();
        markCMSChanged();
      }
    }
    // Update input field if exists
    if (mediaLibraryTarget.inputId) {
      const input = document.getElementById(mediaLibraryTarget.inputId);
      if (input) input.value = selectedMediaItem.url;
    }
    renderCMSSectionsList();
  } else if (mediaLibraryTarget.sectionId && mediaLibraryTarget.field) {
    // CMS section field
    updateSectionField(mediaLibraryTarget.sectionId, mediaLibraryTarget.field, selectedMediaItem.url);
    // Update input field if exists
    if (mediaLibraryTarget.inputId) {
      const input = document.getElementById(mediaLibraryTarget.inputId);
      if (input) input.value = selectedMediaItem.url;
    }
    renderCMSSectionsList();
  } else if (mediaLibraryTarget.sectionId && (mediaLibraryTarget.index !== undefined || mediaLibraryTarget.itemIndex !== undefined)) {
    // Gallery image, review item, or testimonial item
    const idx = mediaLibraryTarget.index ?? mediaLibraryTarget.itemIndex;
    if (mediaLibraryTarget.type === 'gallery') {
      updateGalleryImage(mediaLibraryTarget.sectionId, idx, 'url', selectedMediaItem.url);
    } else if (mediaLibraryTarget.type === 'review') {
      updateReviewItem(mediaLibraryTarget.sectionId, idx, 'image', selectedMediaItem.url);
    } else if (mediaLibraryTarget.type === 'testimonial') {
      updateTestimonialItem(mediaLibraryTarget.sectionId, idx, 'avatar', selectedMediaItem.url);
    }
    // Update input field if exists
    if (mediaLibraryTarget.inputId) {
      const input = document.getElementById(mediaLibraryTarget.inputId);
      if (input) input.value = selectedMediaItem.url;
    }
    renderCMSSectionsList();
  } else if (typeof mediaLibraryTarget === 'string') {
    // Simple input ID
    const input = document.getElementById(mediaLibraryTarget);
    if (input) {
      input.value = selectedMediaItem.url;
      input.dispatchEvent(new Event('change'));
    }
  }

  closeMediaLibrary();
  toast('Billede valgt', 'success');
}

// Handle file upload
async function handleMediaUpload(files) {
  if (!files || files.length === 0) return;

  const grid = document.getElementById('media-library-grid');

  for (const file of files) {
    // Show uploading indicator
    toast('Uploader ' + file.name + '...', 'info');

    const result = await SupabaseDB.uploadMedia(file, 'images');

    if (result.error) {
      toast('Fejl: ' + result.error, 'error');
    } else {
      toast(file.name + ' uploadet', 'success');

      // Add to list and re-render
      mediaLibraryItems.unshift({
        id: result.path,
        name: file.name,
        path: result.path,
        url: result.url,
        type: result.type,
        size: result.size,
        createdAt: new Date().toISOString()
      });
      renderMediaLibrary();
    }
  }

  // Clear file input
  document.getElementById('media-upload-input').value = '';
}

// Delete media item
async function deleteMediaLibraryItem(path) {
  if (!confirm('Er du sikker p√• at du vil slette dette billede?')) return;

  const result = await SupabaseDB.deleteMedia(path);

  if (result.error) {
    toast('Fejl: ' + result.error, 'error');
  } else {
    toast('Billede slettet', 'success');
    mediaLibraryItems = mediaLibraryItems.filter(item => item.path !== path);
    renderMediaLibrary();
  }
}

// Scrape actual content from landing.html to populate CMS
async function scrapeLandingPageContent() {
  try {
    const response = await fetch('/landing.html');
    if (!response.ok) throw new Error('Failed to fetch landing.html');
    const html = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');

    // Scrape Hero Section
    const hero = doc.querySelector('[data-cms="hero"]');
    const heroData = {
      headline: hero?.querySelector('h1')?.textContent?.replace(/\s+/g, ' ').trim() || '',
      subheadline: hero?.querySelector('.hero-content p')?.textContent?.trim() || '',
      backgroundVideo: hero?.querySelector('video source')?.getAttribute('src') || '',
      buttons: [
        {
          text: hero?.querySelector('.button-white')?.textContent?.trim() || 'F√• en gratis demo',
          url: hero?.querySelector('.button-white')?.getAttribute('href') || '#demo',
          variant: 'primary'
        },
        {
          text: hero?.querySelector('.button-outline')?.textContent?.trim() || 'Se priser',
          url: hero?.querySelector('.button-outline')?.getAttribute('href') || '#priser',
          variant: 'secondary'
        }
      ]
    };

    // Scrape Features/Tabs Section
    const features = doc.querySelector('[data-cms="features"]');
    const tabItems = features?.querySelectorAll('.tab-item') || [];
    const tabContents = features?.querySelectorAll('.tab-content') || [];
    const tabsData = Array.from(tabItems).map((tab, i) => {
      const content = tabContents[i];
      return {
        id: 'tab-' + (i + 1),
        tabLabel: tab.querySelector('.tab-text')?.textContent?.trim() || '',
        headline: content?.querySelector('.tab-text-content h3')?.textContent?.trim() || '',
        description: content?.querySelector('.tab-text-content p')?.textContent?.trim() || '',
        image: content?.querySelector('.tab-visual img')?.getAttribute('src') || '',
        video: ''
      };
    });

    // Scrape Trusted Section
    const trusted = doc.querySelector('[data-cms="trusted"]');
    const trustedCards = trusted?.querySelectorAll('.trusted-card:not(:nth-child(n+6))') || []; // First 5 only (skip duplicates)
    const trustedData = {
      heading: trusted?.querySelector('h2')?.textContent?.trim() || '',
      cards: Array.from(trustedCards).slice(0, 5).map(card => ({
        name: card.querySelector('.trusted-card-name')?.textContent?.trim() || '',
        role: card.querySelector('.trusted-card-role')?.textContent?.trim() || '',
        image: card.querySelector('img')?.getAttribute('src') || '',
        gradient: card.querySelector('img')?.getAttribute('style')?.match(/background:\s*([^;]+)/)?.[1] || ''
      }))
    };

    // Scrape Apple Features Section
    const appleFeatures = doc.querySelector('[data-cms="appleFeatures"]');
    const appleFeaturesData = {
      heading: appleFeatures?.querySelector('h2')?.textContent?.trim() || '',
      description: appleFeatures?.querySelector('.apple-features-header p')?.textContent?.trim() || ''
    };

    // Scrape Bento Section
    const bento = doc.querySelector('[data-cms="bento"]');
    const bentoData = {
      heading: bento?.querySelector('h2')?.textContent?.trim() || ''
    };

    // Scrape Beliefs Section
    const beliefs = doc.querySelector('[data-cms="beliefs"]');
    const beliefsData = {
      heading: beliefs?.querySelector('h2, .beliefs-title')?.textContent?.trim() || '',
      subtitle: beliefs?.querySelector('.beliefs-subtitle')?.textContent?.trim() || ''
    };

    console.log('Flow CMS: Scraped landing page content', { heroData, tabsData, trustedData });

    return {
      hero: heroData,
      tabs: tabsData,
      trusted: trustedData,
      appleFeatures: appleFeaturesData,
      bento: bentoData,
      beliefs: beliefsData
    };
  } catch (error) {
    console.error('Flow CMS: Error scraping landing page:', error);
    return null;
  }
}

// Default CMS Pages (populated from flowPagesList if no saved data)
function getDefaultCMSPages(scrapedContent = null) {
  return flowPagesList.map((page, index) => {
    const defaults = defaultFlowPageContent[page.slug] || {};

    // Use scraped content for landing page
    const isLandingPage = page.slug === 'landing';
    const scraped = isLandingPage && scrapedContent ? scrapedContent : null;

    // Build sections array based on page type
    const sections = [];

    // Hero section - use scraped content if available
    sections.push({
      id: 'section-hero-' + index,
      type: 'hero',
      order: 0,
      isVisible: true,
      padding: 'medium',
      headline: scraped?.hero?.headline || defaults.hero?.title || page.title,
      subheadline: scraped?.hero?.subheadline || defaults.hero?.subtitle || '',
      backgroundVideo: scraped?.hero?.backgroundVideo || '',
      backgroundImage: '',
      backgroundOverlay: 50,
      animation: 'none',
      alignment: 'center',
      buttons: scraped?.hero?.buttons || [
        { text: defaults.hero?.ctaText || 'Kom i gang', url: defaults.hero?.ctaUrl || '#demo', variant: 'primary' }
      ]
    });

    // Features section - use scraped tabs if available
    if (scraped?.tabs && scraped.tabs.length > 0) {
      sections.push({
        id: 'section-features-' + index,
        type: 'features',
        order: 1,
        isVisible: true,
        padding: 'medium',
        heading: 'Funktioner',
        tabs: scraped.tabs,
        layout: 'tabs',
        columns: 4
      });
    } else if (defaults.features?.items?.length > 0) {
      sections.push({
        id: 'section-features-' + index,
        type: 'features',
        order: 1,
        isVisible: true,
        padding: 'medium',
        features: defaults.features.items.map((item, i) => ({ id: 'f' + i, title: item, description: '' })),
        layout: 'grid',
        columns: 4
      });
    }

    // Trusted section - use scraped data if available
    if (scraped?.trusted && scraped.trusted.cards?.length > 0) {
      sections.push({
        id: 'section-trusted-' + index,
        type: 'trusted',
        order: 2,
        isVisible: true,
        padding: 'medium',
        heading: scraped.trusted.heading,
        cards: scraped.trusted.cards,
        layout: 'carousel',
        animation: 'none'
      });
    }

    // Bento section (only for landing page)
    if (isLandingPage) {
      sections.push({
        id: 'section-bento-' + index,
        type: 'bento',
        order: sections.length,
        isVisible: true,
        padding: 'medium',
        heading: 'Giv din restaurant den samme<br>teknologi som de store brands',
        heroImage: 'https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?w=1200&h=600&fit=crop',
        heroOverlayText: 'Dine kunder er vant til at bestille p√• telefonen.<br>Derfor giver vi din restaurant sin egen <strong>mobile app</strong>.',
        cards: [
          { label: 'F√• h√∏jere Google rankings med din AI-powered', title: 'restaurant hjemmeside.', image: 'https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=600&h=400&fit=crop' },
          { label: 'V√¶kst dit salg med et', title: 'online bestillingssystem modelleret efter de store brands.', image: 'https://images.unsplash.com/photo-1565299507177-b0ac66763828?w=600&h=400&fit=crop' }
        ]
      });

      // Logo Cloud section
      sections.push({
        id: 'section-logocloud-' + index,
        type: 'logocloud',
        order: sections.length,
        isVisible: true,
        padding: 'medium',
        heading: 'Trusted by the world\'s most innovative teams',
        subheading: 'Join thousands of developers and designers who are already building with Smoothui',
        logos: [
          { name: 'Strava', url: 'https://strava.com' },
          { name: 'Descript', url: 'https://descript.com' },
          { name: 'Duolingo', url: 'https://duolingo.com' },
          { name: 'Faire', url: 'https://faire.com' },
          { name: 'Clearbit', url: 'https://clearbit.com' },
          { name: 'Canva', url: 'https://canva.com' },
          { name: 'Canpoy', url: 'https://canpoy.com' },
          { name: 'Casetext', url: 'https://casetext.com' }
        ]
      });

      // Beliefs section
      sections.push({
        id: 'section-beliefs-' + index,
        type: 'beliefs',
        order: sections.length,
        isVisible: true,
        padding: 'medium',
        heading: 'Tre overbevisninger der guider vores virksomhed',
        subtitle: 'Forst√• principperne der guider vores beslutninger.',
        author: {
          name: 'Adam Guild',
          role: 'Co-Founder and CEO at OrderFlow',
          image: 'https://images.unsplash.com/photo-1560250097-0b93528c311a?w=100&h=100&fit=crop'
        },
        items: [
          { heading: 'Salgsv√¶kst er vigtigere end tilpasning.', text: 'Tredjepartsapps har formet hvordan alle bestiller online. Vi tager deres bedste praksis og giver dem til dig. Det er derfor vi udkonkurrerer dem p√• salg.' },
          { heading: 'Vi skal tjene din forretning hver m√•ned.', text: 'Restauranter er h√•rde nok. Du beh√∏ver ikke endnu en tech-leverand√∏r der binder dig. Kunder stemmer med deres f√∏dder. Vi vil have dig skal kunne forlade os nemt hvis vi ikke tilf√∏jer v√¶rdi.' },
          { heading: 'Restauranter b√∏r eje deres kunderelationer.', text: 'En af de grusomste biprodukter af tech "innovation" er hvordan du bliver separeret fra dine kunder. Hvis du beslutter at forlade OrderFlow, f√•r du dine kunder med dig.' }
        ]
      });

      // Testimonials section
      sections.push({
        id: 'section-testimonials-' + index,
        type: 'testimonials',
        order: sections.length,
        isVisible: true,
        padding: 'medium',
        heading: 'Hvad vores kunder siger',
        layout: 'carousel',
        rotationInterval: 5000,
        items: [
          { text: 'Flow har transformeret vores forretning. Vi har √∏get vores online ordrer med 150% p√• kun 3 m√•neder.', author: 'Maria Jensen', role: 'Caf√© Hygge, K√∏benhavn', image: 'https://i.pravatar.cc/96?img=1' },
          { text: 'Endelig en platform der forst√•r restauranters behov. Supporten er fantastisk og systemet er nemt at bruge.', author: 'Thomas M√∏ller', role: 'Burger Joint, Aalborg', image: 'https://i.pravatar.cc/96?img=2' },
          { text: 'Vi sparede over 40.000 kr. om m√•neden ved at skifte v√¶k fra tredjepartsplatforme. Flow betaler sig selv p√• f√• uger.', author: 'Emma Christensen', role: 'Thai Kitchen, Esbjerg', image: 'https://i.pravatar.cc/96?img=3' }
        ]
      });

      // Footer section
      sections.push({
        id: 'section-footer-' + index,
        type: 'footer',
        order: sections.length,
        isVisible: true,
        padding: 'medium',
        columns: [
          { title: 'PRODUKTER', links: [
            { text: 'Restaurant Hjemmeside', url: 'restaurant-hjemmeside.html' },
            { text: 'Online Bestilling', url: 'online-bestilling.html' },
            { text: 'Custom Mobile App', url: 'custom-mobile-app.html' },
            { text: 'Zero-Commission Delivery', url: 'zero-commission-delivery.html' },
            { text: 'Loyalitetsprogram', url: 'loyalitetsprogram.html' },
            { text: 'Automatiseret Marketing', url: 'automatiseret-marketing.html' }
          ]},
          { title: 'RESSOURCER', links: [
            { text: 'Case Studies', url: 'case-studies.html' },
            { text: 'Restaurant Marketing Guide', url: 'restaurant-marketing-guide.html' },
            { text: 'SEO for Restauranter', url: 'seo-for-restauranter.html' },
            { text: 'Restaurant Email Marketing', url: 'restaurant-email-marketing.html' },
            { text: 'Restaurant Mobile App', url: 'restaurant-mobile-app.html' },
            { text: 'Online Bestillingssystemer', url: 'online-bestillingssystemer.html' }
          ]},
          { title: 'VIRKSOMHED', links: [
            { text: 'Om os', url: 'om-os.html' },
            { text: 'Karriere', url: 'karriere.html' },
            { text: 'Ledelse', url: 'ledelse.html' },
            { text: 'Presse', url: 'presse.html' }
          ]},
          { title: 'SUPPORT', links: [
            { text: '+45 70 12 34 56', url: 'tel:+4570123456' },
            { text: 'support@flow.dk', url: 'mailto:support@flow.dk' }
          ]}
        ],
        contact: { phone: '+45 70 12 34 56', email: 'support@flow.dk' },
        copyright: '¬© 2024 Flow. Alle rettigheder forbeholdes.'
      });
    }

    // CTA section
    sections.push({
      id: 'section-cta-' + index,
      type: 'cta',
      order: sections.length,
      isVisible: true,
      padding: 'medium',
      title: defaults.cta?.title || 'Klar til at komme i gang?',
      description: '',
      button: { text: defaults.cta?.buttonText || 'Book demo', url: '#demo', variant: 'primary' },
      style: 'simple'
    });

    return {
      id: 'page-' + page.slug,
      title: page.title,
      slug: page.slug + '.html',
      description: page.description,
      status: 'published',
      template: 'landing',
      isActive: true,
      seo: {
        title: page.title + ' | Flow',
        description: scraped?.hero?.subheadline || defaults.hero?.subtitle || page.description,
        keywords: []
      },
      sections,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
  });
}

// Load CMS Pages from localStorage (async to support scraping)
async function loadCMSPages() {
  const saved = localStorage.getItem('orderflow_cms_pages');
  if (saved) {
    try {
      cmsPages = JSON.parse(saved);
      // MIGRATION: Auto-populate missing video URLs for existing users
      await migrateVideoUrls();
    } catch (e) {
      console.error('Error loading CMS pages:', e);
      cmsPages = getDefaultCMSPages();
    }
  } else {
    // First time: scrape actual content from landing page
    console.log('Flow CMS: No saved pages found, scraping landing page content...');
    const scrapedContent = await scrapeLandingPageContent();
    cmsPages = getDefaultCMSPages(scrapedContent);
    // Auto-save the scraped content
    localStorage.setItem('orderflow_cms_pages', JSON.stringify(cmsPages));
    console.log('Flow CMS: Landing page content scraped and saved');
  }
  originalCMSPages = JSON.stringify(cmsPages);
  cmsHasChanges = false;
  renderCMSPagesList();
}

// Migrate existing CMS data to include video URLs from landing page
async function migrateVideoUrls() {
  const landingPage = cmsPages.find(p => p.slug === 'landing.html');
  if (!landingPage) return;

  const heroSection = landingPage.sections.find(s => s.type === 'hero');
  if (!heroSection) return;

  let needsSave = false;

  // Migrate old backgroundVideo string to new backgroundVideos array
  if (heroSection.backgroundVideo && !heroSection.backgroundVideos) {
    console.log('Flow CMS: Migrating single video to array format');
    heroSection.backgroundVideos = [{ url: heroSection.backgroundVideo, duration: 10 }];
    heroSection.videoShuffleEnabled = false;
    heroSection.videoShuffleDuration = 10;
    delete heroSection.backgroundVideo;
    needsSave = true;
  }

  // If no videos at all, scrape from landing page
  if (!heroSection.backgroundVideos || heroSection.backgroundVideos.length === 0) {
    console.log('Flow CMS: Scraping video URL from landing page...');
    const scraped = await scrapeLandingPageContent();
    if (scraped?.hero?.backgroundVideo) {
      heroSection.backgroundVideos = [{ url: scraped.hero.backgroundVideo, duration: 10 }];
      heroSection.videoShuffleEnabled = false;
      heroSection.videoShuffleDuration = 10;
      needsSave = true;
      console.log('Flow CMS: Video URL scraped:', scraped.hero.backgroundVideo);
    }
  }

  if (needsSave) {
    localStorage.setItem('orderflow_cms_pages', JSON.stringify(cmsPages));
  }
}

// Save CMS Pages to localStorage
function saveCMSPages() {
  localStorage.setItem('orderflow_cms_pages', JSON.stringify(cmsPages));
  originalCMSPages = JSON.stringify(cmsPages);
  cmsHasChanges = false;
  updateCMSUnsavedBadge();
  toast('Sider gemt', 'success');

  // Dispatch event for other components
  window.dispatchEvent(new CustomEvent('cmsPagesUpdated', { detail: { pages: cmsPages } }));

  // Broadcast to other tabs for cross-tab sync
  cmsChannel.postMessage({ type: 'cms_update', pages: cmsPages });

  // Invalidate service worker cache
  if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({ type: 'CLEAR_CMS_CACHE' });
  }
}

// Mark as changed
function markCMSChanged() {
  cmsHasChanges = true;
  updateCMSUnsavedBadge();
}

// Update unsaved badge
function updateCMSUnsavedBadge() {
  const badge = document.getElementById('cms-unsaved-badge');
  if (badge) {
    badge.style.display = cmsHasChanges ? 'inline-block' : 'none';
  }
}

// Render CMS Pages List
function renderCMSPagesList() {
  const container = document.getElementById('cms-pages-list');
  if (!container) return;

  const searchQuery = (document.getElementById('cms-pages-search')?.value || '').toLowerCase();
  const filteredPages = cmsPages.filter(page =>
    page.title.toLowerCase().includes(searchQuery) ||
    page.slug.toLowerCase().includes(searchQuery)
  );

  container.innerHTML = filteredPages.map(page => `
    <div class="cms-page-item ${currentCMSPageId === page.id ? 'active' : ''}" onclick="selectCMSPage('${page.id}')" style="padding:12px;border-radius:8px;cursor:pointer;border:1px solid ${currentCMSPageId === page.id ? 'var(--primary)' : 'transparent'};background:${currentCMSPageId === page.id ? 'var(--primary-light)' : 'transparent'};margin-bottom:4px;transition:all 0.15s ease">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="font-weight:500;font-size:13px">${page.title}</span>
        <span class="badge ${page.status === 'published' ? 'badge-success' : 'badge-warning'}" style="font-size:10px">${page.status === 'published' ? 'Publiceret' : 'Kladde'}</span>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:4px">/${page.slug}</div>
    </div>
  `).join('');
}

// Filter CMS Pages
function filterCMSPages() {
  renderCMSPagesList();
}

// Select CMS Page
function selectCMSPage(pageId) {
  currentCMSPageId = pageId;
  renderCMSPagesList();
  renderCMSPageEditor();
}

// Get current page
function getCurrentCMSPage() {
  return cmsPages.find(p => p.id === currentCMSPageId);
}

// Render CMS Page Editor
function renderCMSPageEditor() {
  const page = getCurrentCMSPage();
  const headerEl = document.getElementById('cms-editor-header');
  const tabsEl = document.getElementById('cms-editor-tabs');
  const emptyEl = document.getElementById('cms-editor-empty');
  const contentTab = document.getElementById('cms-tab-content');

  if (!page) {
    if (headerEl) headerEl.style.display = 'none';
    if (tabsEl) tabsEl.style.display = 'none';
    if (emptyEl) emptyEl.style.display = 'flex';
    if (contentTab) contentTab.style.display = 'none';
    return;
  }

  if (headerEl) headerEl.style.display = 'block';
  if (tabsEl) tabsEl.style.display = 'block';
  if (emptyEl) emptyEl.style.display = 'none';

  // Update header
  const titleInput = document.getElementById('cms-page-title-input');
  if (titleInput) titleInput.value = page.title;

  const statusBadge = document.getElementById('cms-page-status-badge');
  if (statusBadge) {
    statusBadge.className = 'badge ' + (page.status === 'published' ? 'badge-success' : 'badge-warning');
    statusBadge.textContent = page.status === 'published' ? 'Publiceret' : 'Kladde';
  }

  const publishBtn = document.getElementById('cms-publish-btn');
  if (publishBtn) {
    publishBtn.textContent = page.status === 'published' ? 'Gem som kladde' : 'Publicer';
  }

  // Update schedule badge
  updateScheduleBadge();

  // Switch to content tab by default
  switchCMSEditorTab('content');
}

// Switch CMS Editor Tab
function switchCMSEditorTab(tab) {
  // Update tab buttons
  document.querySelectorAll('#cms-editor-tabs .tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tab);
  });

  // Hide all tabs
  document.getElementById('cms-tab-content').style.display = 'none';
  document.getElementById('cms-tab-seo').style.display = 'none';
  document.getElementById('cms-tab-settings').style.display = 'none';

  // Show selected tab
  const tabEl = document.getElementById('cms-tab-' + tab);
  if (tabEl) tabEl.style.display = 'block';

  // Render tab content
  const page = getCurrentCMSPage();
  if (!page) return;

  if (tab === 'content') {
    renderCMSSectionsList();
  } else if (tab === 'seo') {
    document.getElementById('cms-seo-title').value = page.seo?.title || '';
    document.getElementById('cms-seo-description').value = page.seo?.description || '';
    document.getElementById('cms-seo-keywords').value = (page.seo?.keywords || []).join(', ');
  } else if (tab === 'settings') {
    document.getElementById('cms-page-slug').value = page.slug.replace('.html', '');
    document.getElementById('cms-page-template').value = page.template || 'landing';
    document.getElementById('cms-page-active').checked = page.isActive !== false;
    document.getElementById('cms-page-cookie-banner').checked = page.showCookieBanner === true;
  }
}

// Render CMS Sections List
function renderCMSSectionsList() {
  const page = getCurrentCMSPage();
  const container = document.getElementById('cms-sections-list');
  if (!container || !page) return;

  const sortedSections = [...page.sections].sort((a, b) => a.order - b.order);

  container.innerHTML = sortedSections.map((section, index) => `
    <div class="cms-section-card" style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;margin-bottom:12px;overflow:hidden;${!section.isVisible ? 'opacity:0.5' : ''}">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--bg3);border-bottom:1px solid var(--border)">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-weight:600;font-size:13px">${getSectionLabel(section.type)}</span>
          ${!section.isVisible ? '<span class="badge" style="font-size:10px;background:var(--muted);color:var(--text-inverse)">Skjult</span>' : ''}
        </div>
        <div style="display:flex;gap:4px">
          <button class="btn btn-sm" onclick="moveSectionUp('${section.id}')" ${index === 0 ? 'disabled' : ''} title="Flyt op" style="font-size:11px">Op</button>
          <button class="btn btn-sm" onclick="moveSectionDown('${section.id}')" ${index === sortedSections.length - 1 ? 'disabled' : ''} title="Flyt ned" style="font-size:11px">Ned</button>
          <button class="btn btn-sm" onclick="toggleSectionVisibility('${section.id}')" title="${section.isVisible ? 'Skjul' : 'Vis'}" style="font-size:11px">${section.isVisible ? 'Skjul' : 'Vis'}</button>
          <button class="btn btn-sm btn-danger" onclick="deleteSectionFromPage('${section.id}')" title="Slet" style="font-size:11px">Slet</button>
        </div>
      </div>
      <div style="padding:16px">
        ${renderSectionEditor(section)}
      </div>
    </div>
  `).join('') || '<p style="text-align:center;color:var(--muted);padding:40px">Ingen sektioner endnu. Klik "Tilf√∏j sektion" for at starte.</p>';
}

// Get section icon (returns empty - no icons to keep design clean)
function getSectionIcon(type) {
  return '';
}

// Get section label
function getSectionLabel(type) {
  const labels = {
    hero: 'Hero',
    text: 'Tekst',
    features: 'Funktioner/Tabs',
    cta: 'Call-to-Action',
    testimonials: 'Udtalelser',
    faq: 'FAQ',
    images: 'Billeder',
    trusted: 'Testimonial Carousel',
    appleFeatures: 'Feature Cards',
    bento: 'Bento Grid',
    beliefs: 'Virksomhedsv√¶rdier',
    logocloud: 'Logo Cloud',
    footer: 'Footer'
  };
  return labels[type] || type;
}

// Render Section Editor
function renderSectionEditor(section) {
  switch (section.type) {
    case 'hero':
      return `
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Overskrift</label>
          <input type="text" class="input" value="${section.headline || ''}" onchange="updateSectionField('${section.id}', 'headline', this.value)">
        </div>
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Underoverskrift</label>
          <textarea class="input" rows="2" onchange="updateSectionField('${section.id}', 'subheadline', this.value)">${section.subheadline || ''}</textarea>
        </div>
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Baggrundsbillede</label>
          <div style="display:flex;gap:8px;margin-bottom:8px">
            <input type="text" id="hero-bg-image-${section.id}" class="input" value="${section.backgroundImage || ''}" onchange="updateSectionField('${section.id}', 'backgroundImage', this.value)" placeholder="https://example.com/image.jpg" style="flex:1">
            <button type="button" class="btn btn-secondary" style="white-space:nowrap" onclick="openMediaLibrary('hero-bg-image-${section.id}', '${section.id}', 'backgroundImage')">V√¶lg fra bibliotek</button>
          </div>
          ${section.backgroundImage ? `<img src="${section.backgroundImage}" style="max-width:100%;max-height:120px;border-radius:8px;object-fit:cover">` : '<div style="padding:24px;background:var(--bg-tertiary);border-radius:8px;text-align:center;color:var(--muted);font-size:12px">Intet billede valgt</div>'}
        </div>
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Baggrundsvideo(er)</label>

          <!-- Video Shuffle Controls -->
          <div style="display:flex;align-items:center;gap:16px;margin-bottom:12px;padding:10px;background:var(--bg-tertiary);border-radius:8px">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px">
              <input type="checkbox" ${section.videoShuffleEnabled ? 'checked' : ''} onchange="updateSectionField('${section.id}', 'videoShuffleEnabled', this.checked);this.closest('.form-group').querySelector('.shuffle-duration').style.display=this.checked?'flex':'none'">
              Shuffle videoer
            </label>
            <div class="shuffle-duration" style="display:${section.videoShuffleEnabled ? 'flex' : 'none'};align-items:center;gap:6px">
              <span style="font-size:11px;color:var(--muted)">Skift hver</span>
              <input type="number" class="input" min="3" max="120" value="${section.videoShuffleDuration || 10}" onchange="updateSectionField('${section.id}', 'videoShuffleDuration', parseInt(this.value))" style="width:60px;padding:6px 8px">
              <span style="font-size:11px;color:var(--muted)">sek</span>
            </div>
          </div>

          <!-- Video Liste -->
          <div id="hero-videos-list-${section.id}">
            ${(section.backgroundVideos || []).map((video, idx) => `
              <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;padding:10px;background:var(--bg-tertiary);border-radius:6px">
                <span style="font-size:11px;color:var(--muted);min-width:20px;font-weight:500">${idx + 1}.</span>
                <input type="text" class="input" value="${video.url || ''}" id="hero-video-${section.id}-${idx}" onchange="updateHeroVideo('${section.id}', ${idx}, 'url', this.value)" placeholder="Video URL" style="flex:1">
                <button type="button" class="btn btn-secondary" style="padding:6px 10px;font-size:11px" onclick="openMediaLibrary('hero-video-${section.id}-${idx}', '${section.id}', 'backgroundVideos.${idx}.url', 'video')">Bibliotek</button>
                <button type="button" class="btn" style="padding:6px 10px;color:var(--danger)" onclick="removeHeroVideo('${section.id}', ${idx})">Slet</button>
              </div>
            `).join('')}
          </div>

          <button type="button" class="btn btn-secondary" style="width:100%;margin-top:8px" onclick="addHeroVideo('${section.id}')">+ Tilf√∏j video</button>

          <!-- Video Previews -->
          ${(section.backgroundVideos || []).length > 0 ? `
            <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px">
              ${section.backgroundVideos.map((video, idx) => video.url ? `
                <div style="border-radius:6px;overflow:hidden;background:#000;position:relative">
                  <video src="${video.url}" style="width:100%;height:80px;object-fit:cover" muted playsinline></video>
                  <div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.7);font-size:10px;color:white;padding:4px;text-align:center">${idx + 1}</div>
                </div>
              ` : '').join('')}
            </div>
          ` : '<div style="padding:20px;background:var(--bg-tertiary);border-radius:8px;text-align:center;color:var(--muted);font-size:12px;margin-top:8px">Ingen videoer tilf√∏jet</div>'}
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
          <div class="form-group">
            <label class="form-label" style="font-size:12px">Overlay Opacity (0-100)</label>
            <input type="range" min="0" max="100" value="${section.backgroundOverlay || 50}" oninput="this.nextElementSibling.textContent=this.value+'%'" onchange="updateSectionField('${section.id}', 'backgroundOverlay', parseInt(this.value))" style="width:100%">
            <span style="font-size:11px;color:var(--muted)">${section.backgroundOverlay || 50}%</span>
          </div>
          <div class="form-group">
            <label class="form-label" style="font-size:12px">Animation</label>
            <select class="input" onchange="updateSectionField('${section.id}', 'animation', this.value)">
              <option value="none" ${section.animation === 'none' || !section.animation ? 'selected' : ''}>Ingen</option>
              <option value="fade" ${section.animation === 'fade' ? 'selected' : ''}>Fade In</option>
              <option value="slide" ${section.animation === 'slide' ? 'selected' : ''}>Slide Up</option>
              <option value="zoom" ${section.animation === 'zoom' ? 'selected' : ''}>Zoom In</option>
              <option value="bounce" ${section.animation === 'bounce' ? 'selected' : ''}>Bounce</option>
              <option value="pulse" ${section.animation === 'pulse' ? 'selected' : ''}>Pulse</option>
              <option value="slideLeft" ${section.animation === 'slideLeft' ? 'selected' : ''}>Slide fra venstre</option>
              <option value="slideRight" ${section.animation === 'slideRight' ? 'selected' : ''}>Slide fra h√∏jre</option>
              <option value="rotate" ${section.animation === 'rotate' ? 'selected' : ''}>Rotation</option>
              <option value="scale" ${section.animation === 'scale' ? 'selected' : ''}>Scale Up</option>
            </select>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="form-group">
            <label class="form-label" style="font-size:12px">Knaptekst</label>
            <input type="text" class="input" value="${section.buttons?.[0]?.text || ''}" onchange="updateSectionButton('${section.id}', 0, 'text', this.value)">
          </div>
          <div class="form-group">
            <label class="form-label" style="font-size:12px">Knap URL</label>
            <input type="text" class="input" value="${section.buttons?.[0]?.url || ''}" onchange="updateSectionButton('${section.id}', 0, 'url', this.value)">
          </div>
        </div>
      `;
    case 'text':
      return `
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Titel</label>
          <input type="text" class="input" value="${section.title || ''}" onchange="updateSectionField('${section.id}', 'title', this.value)">
        </div>
        <div class="form-group">
          <label class="form-label" style="font-size:12px">Indhold</label>
          <textarea class="input" rows="4" onchange="updateSectionField('${section.id}', 'content', this.value)">${section.content || ''}</textarea>
        </div>
      `;
    case 'features':
      // Initialize tabs array if not present (4 fixed tabs)
      if (!section.tabs || section.tabs.length !== 4) {
        section.tabs = [
          { id: 'tab-1', tabLabel: 'Tab 1', headline: '', description: '', image: '', video: '' },
          { id: 'tab-2', tabLabel: 'Tab 2', headline: '', description: '', image: '', video: '' },
          { id: 'tab-3', tabLabel: 'Tab 3', headline: '', description: '', image: '', video: '' },
          { id: 'tab-4', tabLabel: 'Tab 4', headline: '', description: '', image: '', video: '' }
        ];
      }
      return `
        <div class="form-group" style="margin-bottom:16px">
          <label class="form-label" style="font-size:12px">Sektion Overskrift</label>
          <input type="text" class="input" value="${section.heading || ''}" onchange="updateSectionField('${section.id}', 'heading', this.value)" placeholder="Sektionens hovedtitel">
        </div>
        <div style="font-size:12px;font-weight:600;margin-bottom:12px;color:var(--text-secondary)">Tabs (4 faste)</div>
        ${section.tabs.map((tab, index) => `
          <details class="feature-tab-editor" style="margin-bottom:12px;background:var(--bg-tertiary);border-radius:8px;padding:12px">
            <summary style="cursor:pointer;font-weight:500;font-size:13px;margin-bottom:8px">Tab ${index + 1}: ${tab.tabLabel || 'Unavngivet'}</summary>
            <div style="padding-top:12px;display:flex;flex-direction:column;gap:10px">
              <div class="form-group">
                <label class="form-label" style="font-size:11px">Tab Label</label>
                <input type="text" class="input" value="${tab.tabLabel || ''}" onchange="updateFeatureTab('${section.id}', ${index}, 'tabLabel', this.value)" placeholder="Vis i tab">
              </div>
              <div class="form-group">
                <label class="form-label" style="font-size:11px">Overskrift</label>
                <input type="text" class="input" value="${tab.headline || ''}" onchange="updateFeatureTab('${section.id}', ${index}, 'headline', this.value)" placeholder="Indholdets overskrift">
              </div>
              <div class="form-group">
                <label class="form-label" style="font-size:11px">Beskrivelse</label>
                <textarea class="input" rows="2" onchange="updateFeatureTab('${section.id}', ${index}, 'description', this.value)" placeholder="Indholdets beskrivelse">${tab.description || ''}</textarea>
              </div>
              <div class="form-group">
                <label class="form-label" style="font-size:11px">Billede</label>
                <div style="display:flex;gap:8px">
                  <input type="text" id="feature-tab-img-${section.id}-${index}" class="input" value="${tab.image || ''}" onchange="updateFeatureTab('${section.id}', ${index}, 'image', this.value)" placeholder="Billede URL" style="flex:1">
                  <button type="button" class="btn btn-secondary" style="white-space:nowrap;font-size:11px;padding:6px 10px" onclick="openMediaLibraryForFeatureTab('${section.id}', ${index})">Bibliotek</button>
                </div>
                ${tab.image ? `<img src="${tab.image}" style="max-width:100%;max-height:80px;margin-top:6px;border-radius:6px;object-fit:cover">` : ''}
              </div>
              <div class="form-group">
                <label class="form-label" style="font-size:11px">Video URL (valgfrit)</label>
                <input type="text" class="input" value="${tab.video || ''}" onchange="updateFeatureTab('${section.id}', ${index}, 'video', this.value)" placeholder="Video URL (MP4)">
              </div>
            </div>
          </details>
        `).join('')}
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
          <div class="form-group">
            <label class="form-label" style="font-size:12px">Layout</label>
            <select class="input" value="${section.layout || 'tabs'}" onchange="updateSectionField('${section.id}', 'layout', this.value)">
              <option value="tabs" ${section.layout === 'tabs' || !section.layout ? 'selected' : ''}>Tabs</option>
              <option value="grid" ${section.layout === 'grid' ? 'selected' : ''}>Grid</option>
              <option value="list" ${section.layout === 'list' ? 'selected' : ''}>Liste</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" style="font-size:12px">Kolonner (grid)</label>
            <select class="input" onchange="updateSectionField('${section.id}', 'columns', parseInt(this.value))">
              <option value="2" ${section.columns === 2 ? 'selected' : ''}>2</option>
              <option value="3" ${section.columns === 3 ? 'selected' : ''}>3</option>
              <option value="4" ${section.columns === 4 || !section.columns ? 'selected' : ''}>4</option>
            </select>
          </div>
        </div>
      `;
    case 'cta':
      return `
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Overskrift</label>
          <input type="text" class="input" value="${section.title || ''}" onchange="updateSectionField('${section.id}', 'title', this.value)">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="form-group">
            <label class="form-label" style="font-size:12px">Knaptekst</label>
            <input type="text" class="input" value="${section.button?.text || ''}" onchange="updateSectionCTAButton('${section.id}', 'text', this.value)">
          </div>
          <div class="form-group">
            <label class="form-label" style="font-size:12px">Knap URL</label>
            <input type="text" class="input" value="${section.button?.url || ''}" onchange="updateSectionCTAButton('${section.id}', 'url', this.value)">
          </div>
        </div>
      `;
    case 'testimonials':
      const testimonialItems = section.items || [];
      return `
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Sektion Overskrift</label>
          <input type="text" class="input" value="${section.heading || ''}" onchange="updateSectionField('${section.id}', 'heading', this.value)" placeholder="Hvad siger vores kunder?">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
          <div class="form-group">
            <label class="form-label" style="font-size:12px">Layout</label>
            <select class="input" onchange="updateSectionField('${section.id}', 'layout', this.value)">
              <option value="carousel" ${section.layout === 'carousel' || !section.layout ? 'selected' : ''}>Karrusel (roterende)</option>
              <option value="grid" ${section.layout === 'grid' ? 'selected' : ''}>Grid</option>
              <option value="single" ${section.layout === 'single' ? 'selected' : ''}>Enkelt (stor)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" style="font-size:12px">Auto-rotation (sek)</label>
            <input type="number" class="input" value="${section.rotationInterval || 5}" min="2" max="30" onchange="updateSectionField('${section.id}', 'rotationInterval', parseInt(this.value))">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" style="font-size:12px;margin-bottom:8px;display:block">Citater (${testimonialItems.length})</label>
          <div id="testimonial-items-${section.id}" style="max-height:400px;overflow-y:auto">
            ${testimonialItems.map((item, idx) => `
              <details style="border:1px solid var(--border);padding:12px;border-radius:8px;margin-bottom:8px;background:var(--bg-secondary)">
                <summary style="cursor:pointer;font-weight:500;font-size:13px;display:flex;align-items:center;gap:8px">
                  ${(item.image || item.avatar) ? `<img src="${item.image || item.avatar}" style="width:28px;height:28px;object-fit:cover;border-radius:50%">` : '<span style="width:28px;height:28px;background:var(--bg-tertiary);border-radius:50%;display:inline-block"></span>'}
                  <span>${item.author || item.name || 'Unavngivet'}</span>
                  <span style="color:var(--muted);font-weight:normal;font-size:11px;margin-left:auto">${item.role || ''}</span>
                </summary>
                <div style="padding-top:12px;display:flex;flex-direction:column;gap:8px">
                  <div class="form-group">
                    <label class="form-label" style="font-size:11px">Citat</label>
                    <textarea class="input" rows="3" placeholder="Hvad sagde de?" onchange="updateTestimonialItem('${section.id}', ${idx}, 'text', this.value)">${item.text || item.quote || ''}</textarea>
                  </div>
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                    <div class="form-group">
                      <label class="form-label" style="font-size:11px">Navn</label>
                      <input type="text" class="input" placeholder="Navn" value="${item.author || item.name || ''}" onchange="updateTestimonialItem('${section.id}', ${idx}, 'author', this.value)">
                    </div>
                    <div class="form-group">
                      <label class="form-label" style="font-size:11px">Rolle/Firma</label>
                      <input type="text" class="input" placeholder="Rolle/Firma" value="${item.role || ''}" onchange="updateTestimonialItem('${section.id}', ${idx}, 'role', this.value)">
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-label" style="font-size:11px">Profilbillede</label>
                    <div style="display:flex;gap:8px">
                      <input type="text" id="testimonial-image-${section.id}-${idx}" class="input" placeholder="Billede URL" value="${item.image || item.avatar || ''}" onchange="updateTestimonialItem('${section.id}', ${idx}, 'image', this.value)" style="flex:1">
                      <button type="button" class="btn btn-secondary" style="white-space:nowrap;font-size:11px;padding:6px 10px" onclick="openMediaLibraryForTestimonial('${section.id}', ${idx})">Bibliotek</button>
                    </div>
                    ${(item.image || item.avatar) ? `<img src="${item.image || item.avatar}" style="max-width:50px;height:50px;object-fit:cover;border-radius:50%;margin-top:6px">` : ''}
                  </div>
                  <button class="btn btn-sm" style="background:var(--danger);color:white;margin-top:4px" onclick="removeTestimonialItem('${section.id}', ${idx})">Fjern citat</button>
                </div>
              </details>
            `).join('')}
          </div>
          <button class="btn btn-sm" onclick="addTestimonialItem('${section.id}')" style="margin-top:8px;width:100%">+ Tilf\u00f8j citat</button>
        </div>
      `;
    case 'faq':
      return `
        <div class="form-group">
          <label class="form-label" style="font-size:12px">FAQ Items (JSON format)</label>
          <textarea class="input" rows="4" onchange="updateSectionField('${section.id}', 'items', JSON.parse(this.value || '[]'))">${JSON.stringify(section.items || [], null, 2)}</textarea>
          <p style="font-size:10px;color:var(--muted);margin-top:4px">Format: [{"question": "Sp√∏rgsm√•l", "answer": "Svar"}]</p>
        </div>
      `;
    case 'images':
      const galleryImages = section.images || [];
      const imagesArray = Array.isArray(galleryImages) ? galleryImages : [];
      const normalizedImages = imagesArray.map(img => typeof img === 'string' ? { url: img, alt: '' } : img);
      return `
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Galleri Titel</label>
          <input type="text" class="input" value="${section.title || ''}" onchange="updateSectionField('${section.id}', 'title', this.value)">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
          <div class="form-group">
            <label class="form-label" style="font-size:12px">Layout</label>
            <select class="input" onchange="updateSectionField('${section.id}', 'layout', this.value)">
              <option value="grid" ${section.layout === 'grid' ? 'selected' : ''}>Grid</option>
              <option value="carousel" ${section.layout === 'carousel' ? 'selected' : ''}>Karrusel</option>
              <option value="masonry" ${section.layout === 'masonry' ? 'selected' : ''}>Masonry</option>
              <option value="single" ${section.layout === 'single' ? 'selected' : ''}>Enkelt</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" style="font-size:12px">Kolonner</label>
            <select class="input" onchange="updateSectionField('${section.id}', 'columns', parseInt(this.value))">
              <option value="2" ${section.columns === 2 ? 'selected' : ''}>2</option>
              <option value="3" ${section.columns === 3 || !section.columns ? 'selected' : ''}>3</option>
              <option value="4" ${section.columns === 4 ? 'selected' : ''}>4</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" style="font-size:12px;margin-bottom:8px;display:block">Billeder (${normalizedImages.length})</label>
          <div id="gallery-images-${section.id}" style="max-height:350px;overflow-y:auto">
            ${normalizedImages.map((img, idx) => `
              <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center;padding:8px;background:var(--bg-secondary);border-radius:8px;border:1px solid var(--border)">
                ${img.url ? `<img src="${img.url}" style="width:60px;height:60px;object-fit:cover;border-radius:4px;flex-shrink:0">` : '<div style="width:60px;height:60px;background:var(--border);border-radius:4px;flex-shrink:0"></div>'}
                <div style="flex:1;display:flex;flex-direction:column;gap:4px">
                  <input type="text" class="input" placeholder="Billede URL" value="${img.url || ''}" onchange="updateGalleryImage('${section.id}', ${idx}, 'url', this.value)">
                  <input type="text" class="input" placeholder="Alt tekst (SEO)" value="${img.alt || ''}" onchange="updateGalleryImage('${section.id}', ${idx}, 'alt', this.value)">
                </div>
                <button class="btn btn-sm" style="background:var(--danger);color:white;height:32px;flex-shrink:0" onclick="removeGalleryImage('${section.id}', ${idx})">X</button>
              </div>
            `).join('')}
          </div>
          <button class="btn btn-sm" onclick="addGalleryImage('${section.id}')" style="margin-top:8px;width:100%">+ Tilf\u00f8j billede</button>
        </div>
      `;
    case 'trusted':
      const trustedCards = section.cards || [];
      return `
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Sektion Overskrift</label>
          <input type="text" class="input" value="${section.heading || ''}" onchange="updateSectionField('${section.id}', 'heading', this.value)">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
          <div class="form-group">
            <label class="form-label" style="font-size:12px">Layout</label>
            <select class="input" onchange="updateSectionField('${section.id}', 'layout', this.value)">
              <option value="carousel" ${section.layout === 'carousel' || !section.layout ? 'selected' : ''}>Karrusel</option>
              <option value="grid" ${section.layout === 'grid' ? 'selected' : ''}>Grid</option>
              <option value="masonry" ${section.layout === 'masonry' ? 'selected' : ''}>Masonry</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" style="font-size:12px">Animation</label>
            <select class="input" onchange="updateSectionField('${section.id}', 'animation', this.value)">
              <option value="none" ${section.animation === 'none' || !section.animation ? 'selected' : ''}>Ingen</option>
              <option value="fade" ${section.animation === 'fade' ? 'selected' : ''}>Fade In</option>
              <option value="slide" ${section.animation === 'slide' ? 'selected' : ''}>Slide</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" style="font-size:12px;margin-bottom:8px;display:block">Udtalelser (${trustedCards.length})</label>
          <div id="trusted-cards-${section.id}" style="max-height:400px;overflow-y:auto">
            ${trustedCards.map((card, idx) => `
              <details style="border:1px solid var(--border);padding:12px;border-radius:8px;margin-bottom:8px;background:var(--bg-secondary)">
                <summary style="cursor:pointer;font-weight:500;font-size:13px;display:flex;align-items:center;gap:8px">
                  ${card.image ? `<img src="${card.image}" style="width:32px;height:32px;object-fit:cover;border-radius:50%">` : '<span style="width:32px;height:32px;background:var(--bg-tertiary);border-radius:50%;display:inline-block"></span>'}
                  <span>${card.name || 'Unavngivet'}</span>
                  <span style="color:var(--muted);font-weight:normal;font-size:11px;margin-left:auto">${card.role || ''}</span>
                </summary>
                <div style="padding-top:12px;display:flex;flex-direction:column;gap:8px">
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                    <div class="form-group">
                      <label class="form-label" style="font-size:11px">Navn</label>
                      <input type="text" class="input" placeholder="Navn" value="${card.name || ''}" onchange="updateReviewItem('${section.id}', ${idx}, 'name', this.value)">
                    </div>
                    <div class="form-group">
                      <label class="form-label" style="font-size:11px">Firma/Rolle</label>
                      <input type="text" class="input" placeholder="Firma/Rolle" value="${card.role || ''}" onchange="updateReviewItem('${section.id}', ${idx}, 'role', this.value)">
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-label" style="font-size:11px">Udtalelse</label>
                    <textarea class="input" rows="2" placeholder="Udtalelse" onchange="updateReviewItem('${section.id}', ${idx}, 'quote', this.value)">${card.quote || ''}</textarea>
                  </div>
                  <div class="form-group">
                    <label class="form-label" style="font-size:11px">Profilbillede</label>
                    <div style="display:flex;gap:8px">
                      <input type="text" id="trusted-img-${section.id}-${idx}" class="input" placeholder="Billede URL" value="${card.image || ''}" onchange="updateReviewItem('${section.id}', ${idx}, 'image', this.value)" style="flex:1">
                      <button type="button" class="btn btn-secondary" style="white-space:nowrap;font-size:11px;padding:6px 10px" onclick="openMediaLibrary({ sectionId: '${section.id}', index: ${idx}, type: 'review' })">Bibliotek</button>
                    </div>
                    ${card.image ? `<img src="${card.image}" style="max-width:60px;height:60px;object-fit:cover;border-radius:50%;margin-top:8px">` : ''}
                  </div>
                  <div class="form-group">
                    <label class="form-label" style="font-size:11px">Kort gradient baggrund (valgfrit)</label>
                    <input type="text" class="input" placeholder="linear-gradient(135deg, #667eea, #764ba2)" value="${card.gradient || ''}" onchange="updateReviewItem('${section.id}', ${idx}, 'gradient', this.value)">
                  </div>
                  <button class="btn btn-sm" style="background:var(--danger);color:white;margin-top:4px" onclick="removeReviewItem('${section.id}', ${idx})">Fjern udtalelse</button>
                </div>
              </details>
            `).join('')}
          </div>
          <button class="btn btn-sm" onclick="addReviewItem('${section.id}')" style="margin-top:8px;width:100%">+ Tilf\u00f8j udtalelse</button>
        </div>
      `;
    case 'appleFeatures':
      return `
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Sektion Overskrift</label>
          <input type="text" class="input" value="${section.heading || ''}" onchange="updateSectionField('${section.id}', 'heading', this.value)">
        </div>
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Beskrivelse</label>
          <textarea class="input" rows="2" onchange="updateSectionField('${section.id}', 'description', this.value)">${section.description || ''}</textarea>
        </div>
        <div class="form-group">
          <label class="form-label" style="font-size:12px">Feature Cards (JSON)</label>
          <textarea class="input" rows="8" onchange="updateSectionField('${section.id}', 'cards', JSON.parse(this.value || '[]'))">${JSON.stringify(section.cards || [], null, 2)}</textarea>
          <p style="font-size:10px;color:var(--muted);margin-top:4px">Format: [{"badge": "Kategori", "title": "Titel", "description": "Beskrivelse"}]</p>
        </div>
      `;
    case 'bento':
      return `
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Sektion Overskrift (HTML tilladt)</label>
          <textarea class="input" rows="2" onchange="updateSectionField('${section.id}', 'heading', this.value)">${section.heading || ''}</textarea>
        </div>
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Hero Billede URL</label>
          <input type="text" class="input" value="${section.heroImage || ''}" onchange="updateSectionField('${section.id}', 'heroImage', this.value)" placeholder="https://...">
        </div>
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Hero Overlay Tekst (HTML tilladt)</label>
          <textarea class="input" rows="2" onchange="updateSectionField('${section.id}', 'heroOverlayText', this.value)">${section.heroOverlayText || ''}</textarea>
        </div>
        <div class="form-group">
          <label class="form-label" style="font-size:12px">Bento Cards (JSON)</label>
          <textarea class="input" rows="6" onchange="updateSectionField('${section.id}', 'cards', JSON.parse(this.value || '[]'))">${JSON.stringify(section.cards || [], null, 2)}</textarea>
          <p style="font-size:10px;color:var(--muted);margin-top:4px">Format: [{"label": "Label tekst", "title": "Titel", "image": "billede URL"}]</p>
        </div>
      `;
    case 'beliefs':
      return `
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Sektion Overskrift</label>
          <input type="text" class="input" value="${section.heading || ''}" onchange="updateSectionField('${section.id}', 'heading', this.value)">
        </div>
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Undertitel</label>
          <input type="text" class="input" value="${section.subtitle || ''}" onchange="updateSectionField('${section.id}', 'subtitle', this.value)">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
          <div class="form-group">
            <label class="form-label" style="font-size:12px">Forfatter Navn</label>
            <input type="text" class="input" value="${section.author?.name || ''}" onchange="updateSectionAuthor('${section.id}', 'name', this.value)">
          </div>
          <div class="form-group">
            <label class="form-label" style="font-size:12px">Forfatter Rolle</label>
            <input type="text" class="input" value="${section.author?.role || ''}" onchange="updateSectionAuthor('${section.id}', 'role', this.value)">
          </div>
        </div>
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Forfatter Billede URL</label>
          <input type="text" class="input" value="${section.author?.image || ''}" onchange="updateSectionAuthor('${section.id}', 'image', this.value)">
        </div>
        <div class="form-group">
          <label class="form-label" style="font-size:12px">Belief Items (JSON)</label>
          <textarea class="input" rows="6" onchange="updateSectionField('${section.id}', 'items', JSON.parse(this.value || '[]'))">${JSON.stringify(section.items || [], null, 2)}</textarea>
          <p style="font-size:10px;color:var(--muted);margin-top:4px">Format: [{"heading": "Overskrift", "text": "Beskrivelse"}]</p>
        </div>
      `;
    case 'logocloud':
      return `
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Overskrift</label>
          <input type="text" class="input" value="${section.heading || ''}" onchange="updateSectionField('${section.id}', 'heading', this.value)">
        </div>
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Underoverskrift</label>
          <input type="text" class="input" value="${section.subheading || ''}" onchange="updateSectionField('${section.id}', 'subheading', this.value)">
        </div>
        <div class="form-group">
          <label class="form-label" style="font-size:12px">Logos (JSON)</label>
          <textarea class="input" rows="6" onchange="updateSectionField('${section.id}', 'logos', JSON.parse(this.value || '[]'))">${JSON.stringify(section.logos || [], null, 2)}</textarea>
          <p style="font-size:10px;color:var(--muted);margin-top:4px">Format: [{"name": "Firmanavn", "url": "https://example.com"}]</p>
        </div>
      `;
    case 'footer':
      return `
        <div class="form-group" style="margin-bottom:12px">
          <label class="form-label" style="font-size:12px">Footer Kolonner (JSON)</label>
          <textarea class="input" rows="8" onchange="updateSectionField('${section.id}', 'columns', JSON.parse(this.value || '[]'))">${JSON.stringify(section.columns || [], null, 2)}</textarea>
          <p style="font-size:10px;color:var(--muted);margin-top:4px">Format: [{"title": "PRODUKTER", "links": [{"text": "Link tekst", "url": "/side.html"}]}]</p>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
          <div class="form-group">
            <label class="form-label" style="font-size:12px">Kontakt Telefon</label>
            <input type="text" class="input" value="${section.contact?.phone || ''}" onchange="updateFooterContact('${section.id}', 'phone', this.value)">
          </div>
          <div class="form-group">
            <label class="form-label" style="font-size:12px">Kontakt Email</label>
            <input type="text" class="input" value="${section.contact?.email || ''}" onchange="updateFooterContact('${section.id}', 'email', this.value)">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" style="font-size:12px">Copyright Tekst</label>
          <input type="text" class="input" value="${section.copyright || ''}" onchange="updateSectionField('${section.id}', 'copyright', this.value)">
        </div>
      `;
    default:
      return '<p style="color:var(--muted)">Ukendt sektionstype</p>';
  }
}

// Update section field
function updateSectionField(sectionId, field, value) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (section) {
    section[field] = value;
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
  }
}

// Add a new hero video
function addHeroVideo(sectionId) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (!section) return;

  if (!section.backgroundVideos) section.backgroundVideos = [];
  section.backgroundVideos.push({ url: '', duration: section.videoShuffleDuration || 10 });

  page.updatedAt = new Date().toISOString();
  markCMSChanged();
  renderCMSSectionsList();
}

// Remove a hero video
function removeHeroVideo(sectionId, videoIndex) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (!section || !section.backgroundVideos) return;

  section.backgroundVideos.splice(videoIndex, 1);
  page.updatedAt = new Date().toISOString();
  markCMSChanged();
  renderCMSSectionsList();
}

// Update a hero video field
function updateHeroVideo(sectionId, videoIndex, field, value) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (!section || !section.backgroundVideos || !section.backgroundVideos[videoIndex]) return;

  section.backgroundVideos[videoIndex][field] = value;
  page.updatedAt = new Date().toISOString();
  markCMSChanged();
}

// Update section button (hero)
function updateSectionButton(sectionId, buttonIndex, field, value) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (section) {
    if (!section.buttons) section.buttons = [{ text: '', url: '', variant: 'primary' }];
    if (!section.buttons[buttonIndex]) section.buttons[buttonIndex] = { text: '', url: '', variant: 'primary' };
    section.buttons[buttonIndex][field] = value;
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
  }
}

// Update section CTA button
function updateSectionCTAButton(sectionId, field, value) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (section) {
    if (!section.button) section.button = { text: '', url: '', variant: 'primary' };
    section.button[field] = value;
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
  }
}

// Update section features
function updateSectionFeatures(sectionId, value) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (section) {
    section.features = value.split('\n').filter(line => line.trim()).map((title, i) => ({
      id: 'feature-' + i,
      title: title.trim(),
      description: ''
    }));
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
  }
}

// Update feature tab (4 fixed tabs)
function updateFeatureTab(sectionId, tabIndex, field, value) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (section) {
    // Initialize tabs if not present
    if (!section.tabs || section.tabs.length !== 4) {
      section.tabs = [
        { id: 'tab-1', tabLabel: 'Tab 1', headline: '', description: '', image: '', video: '' },
        { id: 'tab-2', tabLabel: 'Tab 2', headline: '', description: '', image: '', video: '' },
        { id: 'tab-3', tabLabel: 'Tab 3', headline: '', description: '', image: '', video: '' },
        { id: 'tab-4', tabLabel: 'Tab 4', headline: '', description: '', image: '', video: '' }
      ];
    }
    section.tabs[tabIndex][field] = value;
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
    // Re-render to update summary text
    if (field === 'tabLabel') {
      renderCMSSectionsList();
    }
  }
}

// Open media library for feature tab image
function openMediaLibraryForFeatureTab(sectionId, tabIndex) {
  const targetId = `feature-tab-img-${sectionId}-${tabIndex}`;
  openMediaLibrary(targetId, sectionId, `tabs.${tabIndex}.image`);
}

// Update section images
function updateSectionImages(sectionId, value) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (section) {
    section.images = value.split('\n').filter(line => line.trim());
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
  }
}

// Update review/testimonial item
function updateReviewItem(sectionId, itemIndex, field, value) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (section && section.cards && section.cards[itemIndex]) {
    section.cards[itemIndex][field] = value;
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
  }
}

// Add new review/testimonial item
function addReviewItem(sectionId) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (section) {
    if (!section.cards) section.cards = [];
    section.cards.push({
      name: '',
      role: '',
      quote: '',
      image: '',
      gradient: ''
    });
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
    renderCMSPageEditor();
  }
}

// Remove review/testimonial item
function removeReviewItem(sectionId, itemIndex) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (section && section.cards) {
    section.cards.splice(itemIndex, 1);
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
    renderCMSPageEditor();
  }
}

// Update testimonial item
function updateTestimonialItem(sectionId, itemIndex, field, value) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (section && section.items && section.items[itemIndex]) {
    section.items[itemIndex][field] = value;
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
  }
}

// Add new testimonial item
function addTestimonialItem(sectionId) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (section) {
    if (!section.items) section.items = [];
    section.items.push({
      text: '',
      author: '',
      role: '',
      image: ''
    });
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
    renderCMSSectionsList();
  }
}

// Remove testimonial item
function removeTestimonialItem(sectionId, itemIndex) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (section && section.items) {
    section.items.splice(itemIndex, 1);
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
    renderCMSSectionsList();
  }
}

// Open media library for testimonial avatar
function openMediaLibraryForTestimonial(sectionId, itemIndex) {
  openMediaLibrary({
    sectionId,
    itemIndex,
    type: 'testimonial',
    inputId: `testimonial-avatar-${sectionId}-${itemIndex}`
  });
}

// Update gallery image
function updateGalleryImage(sectionId, imageIndex, field, value) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (section) {
    // Normalize images array to objects
    if (!section.images) section.images = [];
    section.images = section.images.map(img => typeof img === 'string' ? { url: img, alt: '' } : img);

    if (section.images[imageIndex]) {
      section.images[imageIndex][field] = value;
      page.updatedAt = new Date().toISOString();
      markCMSChanged();
    }
  }
}

// Add new gallery image
function addGalleryImage(sectionId) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (section) {
    if (!section.images) section.images = [];
    // Normalize existing images
    section.images = section.images.map(img => typeof img === 'string' ? { url: img, alt: '' } : img);
    section.images.push({ url: '', alt: '' });
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
    renderCMSPageEditor();
  }
}

// Remove gallery image
function removeGalleryImage(sectionId, imageIndex) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (section && section.images) {
    section.images.splice(imageIndex, 1);
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
    renderCMSPageEditor();
  }
}

// Update section author (for beliefs section)
function updateSectionAuthor(sectionId, field, value) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (section) {
    if (!section.author) section.author = { name: '', role: '', image: '' };
    section.author[field] = value;
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
  }
}

// Update footer contact (for footer section)
function updateFooterContact(sectionId, field, value) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (section) {
    if (!section.contact) section.contact = { phone: '', email: '' };
    section.contact[field] = value;
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
  }
}

// Toggle add section dropdown
function toggleAddSectionDropdown() {
  const dropdown = document.getElementById('add-section-dropdown');
  if (dropdown) {
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
  }
}

// Add section to page
function addSectionToPage(type) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const newSection = {
    id: 'section-' + Date.now(),
    type: type,
    order: page.sections.length,
    isVisible: true,
    padding: 'medium'
  };

  // Add type-specific defaults
  switch (type) {
    case 'hero':
      newSection.headline = 'Ny Hero Overskrift';
      newSection.subheadline = '';
      newSection.alignment = 'center';
      newSection.buttons = [{ text: 'Kom i gang', url: '#', variant: 'primary' }];
      break;
    case 'text':
      newSection.title = 'Ny Tekstsektion';
      newSection.content = '';
      newSection.alignment = 'left';
      break;
    case 'features':
      newSection.features = [];
      newSection.layout = 'grid';
      newSection.columns = 3;
      break;
    case 'cta':
      newSection.title = 'Klar til at komme i gang?';
      newSection.description = '';
      newSection.button = { text: 'Kontakt os', url: '#', variant: 'primary' };
      newSection.style = 'simple';
      break;
    case 'testimonials':
      newSection.items = [];
      newSection.layout = 'carousel';
      break;
    case 'faq':
      newSection.items = [];
      break;
    case 'images':
      newSection.images = [];
      newSection.layout = 'gallery';
      break;
    case 'trusted':
      newSection.heading = 'Betroet af tusindvis af restaurat√∏rer';
      newSection.cards = [];
      break;
    case 'appleFeatures':
      newSection.heading = 'Alt hvad du beh√∏ver';
      newSection.description = '';
      newSection.cards = [];
      break;
    case 'bento':
      newSection.heading = 'Giv din restaurant den samme<br>teknologi som de store brands';
      newSection.heroImage = 'https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?w=1200&h=600&fit=crop';
      newSection.heroOverlayText = 'Dine kunder er vant til at bestille p√• telefonen. Derfor giver vi din restaurant sin egen <strong>mobile app</strong>.';
      newSection.cards = [
        { label: 'F√• h√∏jere Google rankings med din AI-powered', title: 'restaurant hjemmeside.', image: 'https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=600&h=400&fit=crop' },
        { label: 'V√¶kst dit salg med et', title: 'online bestillingssystem modelleret efter de store brands.', image: 'https://images.unsplash.com/photo-1565299507177-b0ac66763828?w=600&h=400&fit=crop' }
      ];
      break;
    case 'beliefs':
      newSection.heading = 'Vores overbevisninger';
      newSection.subtitle = '';
      newSection.author = { name: '', role: '', image: '' };
      newSection.items = [];
      break;
    case 'logocloud':
      newSection.heading = 'Trusted by the world\'s most innovative teams';
      newSection.subheading = 'Join thousands of developers and designers who are already building with Smoothui';
      newSection.logos = [
        { name: 'Strava', url: 'https://strava.com' },
        { name: 'Descript', url: 'https://descript.com' },
        { name: 'Duolingo', url: 'https://duolingo.com' },
        { name: 'Faire', url: 'https://faire.com' },
        { name: 'Clearbit', url: 'https://clearbit.com' }
      ];
      break;
    case 'footer':
      newSection.columns = [
        { title: 'PRODUKTER', links: [{ text: 'Restaurant Hjemmeside', url: 'restaurant-hjemmeside.html' }, { text: 'Online Bestilling', url: 'online-bestilling.html' }] },
        { title: 'RESSOURCER', links: [{ text: 'Case Studies', url: 'case-studies.html' }, { text: 'SEO for Restauranter', url: 'seo-for-restauranter.html' }] },
        { title: 'VIRKSOMHED', links: [{ text: 'Om os', url: 'om-os.html' }, { text: 'Karriere', url: 'karriere.html' }] },
        { title: 'SUPPORT', links: [{ text: 'Kontakt', url: '#' }] }
      ];
      newSection.contact = { phone: '+45 70 12 34 56', email: 'support@flow.dk' };
      newSection.copyright = '¬© 2024 Flow. Alle rettigheder forbeholdes.';
      break;
  }

  page.sections.push(newSection);
  page.updatedAt = new Date().toISOString();
  markCMSChanged();

  // Close dropdown and re-render
  document.getElementById('add-section-dropdown').style.display = 'none';
  renderCMSSectionsList();
}

// Delete section from page
function deleteSectionFromPage(sectionId) {
  const page = getCurrentCMSPage();
  if (!page) return;

  if (!confirm('Er du sikker p√• at du vil slette denne sektion?')) return;

  page.sections = page.sections.filter(s => s.id !== sectionId);
  // Re-order remaining sections
  page.sections.forEach((s, i) => s.order = i);
  page.updatedAt = new Date().toISOString();
  markCMSChanged();
  renderCMSSectionsList();
}

// Move section up
function moveSectionUp(sectionId) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const sortedSections = [...page.sections].sort((a, b) => a.order - b.order);
  const index = sortedSections.findIndex(s => s.id === sectionId);
  if (index <= 0) return;

  // Swap orders
  const temp = sortedSections[index].order;
  sortedSections[index].order = sortedSections[index - 1].order;
  sortedSections[index - 1].order = temp;

  page.updatedAt = new Date().toISOString();
  markCMSChanged();
  renderCMSSectionsList();
}

// Move section down
function moveSectionDown(sectionId) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const sortedSections = [...page.sections].sort((a, b) => a.order - b.order);
  const index = sortedSections.findIndex(s => s.id === sectionId);
  if (index < 0 || index >= sortedSections.length - 1) return;

  // Swap orders
  const temp = sortedSections[index].order;
  sortedSections[index].order = sortedSections[index + 1].order;
  sortedSections[index + 1].order = temp;

  page.updatedAt = new Date().toISOString();
  markCMSChanged();
  renderCMSSectionsList();
}

// Toggle section visibility
function toggleSectionVisibility(sectionId) {
  const page = getCurrentCMSPage();
  if (!page) return;

  const section = page.sections.find(s => s.id === sectionId);
  if (section) {
    section.isVisible = !section.isVisible;
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
    renderCMSSectionsList();
  }
}

// Add new CMS page
function addNewCMSPage() {
  const newPage = {
    id: 'page-' + Date.now(),
    title: 'Ny Side',
    slug: 'ny-side.html',
    description: 'Ny side beskrivelse',
    status: 'draft',
    template: 'standard',
    isActive: false,
    seo: {
      title: 'Ny Side | Flow',
      description: '',
      keywords: []
    },
    sections: [],
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };

  cmsPages.unshift(newPage);
  markCMSChanged();
  renderCMSPagesList();
  selectCMSPage(newPage.id);
}

// Delete current page
function deleteCurrentPage() {
  const page = getCurrentCMSPage();
  if (!page) return;

  if (!confirm(`Er du sikker p√• at du vil slette "${page.title}"?`)) return;

  cmsPages = cmsPages.filter(p => p.id !== page.id);
  currentCMSPageId = null;
  markCMSChanged();
  renderCMSPagesList();
  renderCMSPageEditor();
}

// Duplicate current page
function duplicateCurrentPage() {
  const page = getCurrentCMSPage();
  if (!page) return;

  const duplicated = JSON.parse(JSON.stringify(page));
  duplicated.id = 'page-' + Date.now();
  duplicated.title = page.title + ' (Kopi)';
  duplicated.slug = page.slug.replace('.html', '-kopi.html');
  duplicated.status = 'draft';
  duplicated.createdAt = new Date().toISOString();
  duplicated.updatedAt = new Date().toISOString();

  cmsPages.unshift(duplicated);
  markCMSChanged();
  renderCMSPagesList();
  selectCMSPage(duplicated.id);
  toast('Side duplikeret', 'success');
}

// Toggle page publish status
function togglePagePublish() {
  const page = getCurrentCMSPage();
  if (!page) return;

  page.status = page.status === 'published' ? 'draft' : 'published';
  page.updatedAt = new Date().toISOString();
  markCMSChanged();
  renderCMSPagesList();
  renderCMSPageEditor();
}

// Preview current page
function previewCurrentPage() {
  const page = getCurrentCMSPage();
  if (page) {
    window.open(page.slug, '_blank');
  }
}

// Schedule page changes
function schedulePageChanges() {
  console.log('schedulePageChanges called');
  const page = getCurrentCMSPage();
  console.log('Current page:', page);

  if (!page) {
    console.warn('No page selected for scheduling');
    toast('V√¶lg f√∏rst en side at planl√¶gge', 'warning');
    return;
  }

  // Get minimum datetime (now + 1 minute)
  const now = new Date();
  now.setMinutes(now.getMinutes() + 1);
  const minDatetime = now.toISOString().slice(0, 16);

  const pendingSchedules = page.scheduledChanges?.filter(s => s.status === 'pending') || [];

  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  modal.id = 'schedule-modal';
  modal.innerHTML = `
    <div class="modal" style="max-width:500px">
      <div class="modal-header">
        <h3 style="margin:0">Planl√¶g √¶ndringer</h3>
        <button class="modal-close" onclick="closeScheduleModal()" style="background:none;border:none;font-size:20px;cursor:pointer">&times;</button>
      </div>
      <div class="modal-body" style="padding:20px">
        <div class="form-group" style="margin-bottom:16px">
          <label class="form-label">Dato og tid for offentligg√∏relse</label>
          <input type="datetime-local" class="input" id="schedule-datetime" min="${minDatetime}" style="width:100%">
        </div>
        <p style="font-size:12px;color:var(--muted)">
          De nuv√¶rende √¶ndringer vil blive gemt og automatisk publiceret p√• det valgte tidspunkt.
        </p>
        ${pendingSchedules.length > 0 ? `
          <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
            <label class="form-label">Planlagte √¶ndringer (${pendingSchedules.length})</label>
            ${pendingSchedules.map(s => `
              <div style="padding:12px;background:var(--bg-secondary);border-radius:8px;margin-top:8px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                  <span style="font-size:13px;font-weight:500">${new Date(s.scheduledFor).toLocaleString('da-DK')}</span>
                  <span style="font-size:11px;color:var(--muted)">${getTimeUntil(s.scheduledFor)}</span>
                </div>
                <div style="display:flex;gap:8px">
                  <button class="btn btn-sm" onclick="previewScheduledChanges('${s.id}')" style="flex:1">Forh√•ndsvisning</button>
                  <button class="btn btn-sm" onclick="editScheduledChange('${s.id}')" style="flex:1">Rediger tid</button>
                  <button class="btn btn-sm" style="background:var(--danger);color:white" onclick="cancelScheduledChange('${s.id}')">Slet</button>
                </div>
              </div>
            `).join('')}
          </div>
        ` : ''}
      </div>
      <div class="modal-footer" style="padding:16px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px">
        <button class="btn" onclick="closeScheduleModal()">Luk</button>
        <button class="btn btn-primary" onclick="confirmSchedule()">Planl√¶g nu</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

// Get time until scheduled change
function getTimeUntil(dateString) {
  const target = new Date(dateString);
  const now = new Date();
  const diff = target - now;

  if (diff < 0) return 'Forpasset';

  const hours = Math.floor(diff / (1000 * 60 * 60));
  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

  if (hours > 24) {
    const days = Math.floor(hours / 24);
    return `om ${days} dag${days > 1 ? 'e' : ''}`;
  } else if (hours > 0) {
    return `om ${hours}t ${minutes}m`;
  } else {
    return `om ${minutes} min`;
  }
}

// Close schedule modal
function closeScheduleModal() {
  const modal = document.getElementById('schedule-modal');
  if (modal) modal.remove();
}

// Confirm schedule
function confirmSchedule() {
  const datetime = document.getElementById('schedule-datetime').value;
  if (!datetime) {
    toast('V√¶lg en dato og tid', 'error');
    return;
  }

  const scheduledTime = new Date(datetime);
  if (scheduledTime <= new Date()) {
    toast('Tidspunktet skal v√¶re i fremtiden', 'error');
    return;
  }

  const page = getCurrentCMSPage();
  if (!page) return;

  // Create scheduled change
  const scheduledChange = {
    id: 'schedule-' + Date.now(),
    sections: JSON.parse(JSON.stringify(page.sections)),
    scheduledFor: scheduledTime.toISOString(),
    status: 'pending',
    createdAt: new Date().toISOString()
  };

  if (!page.scheduledChanges) page.scheduledChanges = [];
  page.scheduledChanges.push(scheduledChange);

  page.updatedAt = new Date().toISOString();
  markCMSChanged();

  closeScheduleModal();
  toast('√Ündringer planlagt til ' + scheduledTime.toLocaleString('da-DK'), 'success');
  updateScheduleBadge();
  renderCMSPageEditor();
}

// Edit scheduled change time
function editScheduledChange(scheduleId) {
  const page = getCurrentCMSPage();
  if (!page || !page.scheduledChanges) return;

  const schedule = page.scheduledChanges.find(s => s.id === scheduleId);
  if (!schedule) return;

  const currentTime = new Date(schedule.scheduledFor).toISOString().slice(0, 16);
  const now = new Date();
  now.setMinutes(now.getMinutes() + 1);
  const minDatetime = now.toISOString().slice(0, 16);

  const newTime = prompt('Ny tid (YYYY-MM-DDTHH:MM):', currentTime);
  if (!newTime) return;

  const newDate = new Date(newTime);
  if (isNaN(newDate.getTime()) || newDate <= new Date()) {
    toast('Ugyldigt tidspunkt', 'error');
    return;
  }

  schedule.scheduledFor = newDate.toISOString();
  page.updatedAt = new Date().toISOString();
  markCMSChanged();
  toast('Planlagt tidspunkt opdateret', 'success');
  closeScheduleModal();
  schedulePageChanges(); // Reopen modal to show updated time
}

// Preview scheduled changes
function previewScheduledChanges(scheduleId) {
  const page = getCurrentCMSPage();
  if (!page || !page.scheduledChanges) return;

  const schedule = page.scheduledChanges.find(s => s.id === scheduleId);
  if (!schedule) return;

  // Store scheduled sections temporarily for preview
  localStorage.setItem('orderflow_cms_preview', JSON.stringify({
    pageSlug: page.slug,
    sections: schedule.sections
  }));

  // Open preview with query parameter
  window.open(page.slug + '?preview=scheduled', '_blank');
}

// Cancel scheduled change
function cancelScheduledChange(scheduleId) {
  const page = getCurrentCMSPage();
  if (!page || !page.scheduledChanges) return;

  const idx = page.scheduledChanges.findIndex(s => s.id === scheduleId);
  if (idx !== -1) {
    page.scheduledChanges.splice(idx, 1); // Actually remove, not just mark cancelled
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
    closeScheduleModal();
    toast('Planlagt √¶ndring slettet', 'success');
    updateScheduleBadge();
    renderCMSPageEditor();
  }
}

// Update schedule badge on the Planl√¶g button
function updateScheduleBadge() {
  const page = getCurrentCMSPage();
  const pendingCount = page?.scheduledChanges?.filter(s => s.status === 'pending').length || 0;

  const scheduleBtn = document.getElementById('cms-schedule-btn');
  if (scheduleBtn) {
    // Remove existing badge
    const existingBadge = scheduleBtn.querySelector('.schedule-badge');
    if (existingBadge) existingBadge.remove();

    // Add badge if there are pending schedules
    if (pendingCount > 0) {
      const badge = document.createElement('span');
      badge.className = 'schedule-badge';
      badge.textContent = pendingCount;
      badge.style.cssText = 'position:absolute;top:-6px;right:-6px;background:var(--primary);color:white;font-size:10px;min-width:16px;height:16px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:0 4px';
      scheduleBtn.style.position = 'relative';
      scheduleBtn.appendChild(badge);
    }
  }
}

// Update current page title
function updateCurrentPageTitle() {
  const page = getCurrentCMSPage();
  if (!page) return;

  const input = document.getElementById('cms-page-title-input');
  if (input) {
    page.title = input.value;
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
    renderCMSPagesList();
  }
}

// Update current page SEO
function updateCurrentPageSEO() {
  const page = getCurrentCMSPage();
  if (!page) return;

  page.seo = {
    title: document.getElementById('cms-seo-title')?.value || '',
    description: document.getElementById('cms-seo-description')?.value || '',
    keywords: (document.getElementById('cms-seo-keywords')?.value || '').split(',').map(k => k.trim()).filter(k => k)
  };
  page.updatedAt = new Date().toISOString();
  markCMSChanged();
}

// Update current page slug
function updateCurrentPageSlug() {
  const page = getCurrentCMSPage();
  if (!page) return;

  const input = document.getElementById('cms-page-slug');
  if (input) {
    page.slug = input.value.replace(/[^a-z0-9-]/g, '') + '.html';
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
  }
}

// Update current page template
function updateCurrentPageTemplate() {
  const page = getCurrentCMSPage();
  if (!page) return;

  const select = document.getElementById('cms-page-template');
  if (select) {
    page.template = select.value;
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
  }
}

// Update current page active status
function updateCurrentPageActive() {
  const page = getCurrentCMSPage();
  if (!page) return;

  const checkbox = document.getElementById('cms-page-active');
  if (checkbox) {
    page.isActive = checkbox.checked;
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
  }
}

// Update current page cookie banner setting
function updateCurrentPageCookieBanner() {
  const page = getCurrentCMSPage();
  if (!page) return;

  const checkbox = document.getElementById('cms-page-cookie-banner');
  if (checkbox) {
    page.showCookieBanner = checkbox.checked;
    page.updatedAt = new Date().toISOString();
    markCMSChanged();
  }
}

// Navigate to Flow CMS page
function showFlowCMSPage(tab) {
  showPage('flow-cms');
  setTimeout(() => switchFlowCMSTab(tab), 50);
}

// Switch Flow CMS tab
async function switchFlowCMSTab(tab) {
  const tabTitles = {
    'pages': 'Rediger Flow Sider',
    'editor': 'Rediger Side',
    'blog': 'Blog',
    'blog-editor': 'Rediger Blogindl√¶g',
    'seo': 'SEO Indstillinger',
    'products-sms': 'SMS Workflow',
    'products-instagram': 'Instagram Workflow',
    'products-facebook': 'Facebook Workflow'
  };

  const titleEl = document.getElementById('flow-cms-page-title');
  if (titleEl) {
    titleEl.textContent = tabTitles[tab] || 'Flow CMS';
  }

  document.querySelectorAll('#page-flow-cms .settings-tab-content').forEach(c => c.classList.remove('active'));
  const contentEl = document.getElementById('flow-cms-content-' + tab);
  if (contentEl) contentEl.classList.add('active');

  // Load content based on tab
  if (tab === 'pages') await loadCMSPages(); // Use new CMS Pages Editor
  if (tab === 'blog') loadBlogPosts();
  if (tab === 'products-sms') loadWorkflowConfig('sms');
  if (tab === 'products-instagram') loadWorkflowConfig('instagram');
  if (tab === 'products-facebook') loadWorkflowConfig('facebook');
}

// Load and render Flow pages grid
function loadFlowPagesList() {
  const grid = document.getElementById('flow-pages-grid');
  if (!grid) return;

  grid.innerHTML = flowPagesList.map(page => `
    <div class="flow-page-card" onclick="editFlowPage('${page.slug}')">
      <h3>${page.title}</h3>
      <p>${page.description}</p>
      <button class="btn btn-primary btn-sm">Rediger indhold</button>
    </div>
  `).join('');
}

// Edit a Flow page
function editFlowPage(slug) {
  const page = flowPagesList.find(p => p.slug === slug);
  if (!page) return;

  currentEditingPage = {
    slug: slug,
    title: page.title,
    sections: loadPageSections(slug)
  };

  renderPageEditor();
  switchFlowCMSTab('editor');
}

// Load page sections from localStorage or defaults
function loadPageSections(slug) {
  const saved = localStorage.getItem('flow_page_' + slug);
  if (saved) {
    try {
      return JSON.parse(saved);
    } catch (e) {
      console.error('Error loading page sections:', e);
    }
  }

  // Get default content for this page from the template
  const defaults = defaultFlowPageContent[slug] || {};

  // Return default sections with actual page content from template
  return [
    { id: 'header', type: 'Header', locked: true, content: {} },
    {
      id: 'hero',
      type: 'Hero Sektion',
      locked: false,
      content: defaults.hero || { title: '', subtitle: '', ctaText: 'Kom i gang', ctaUrl: '#demo' }
    },
    {
      id: 'features',
      type: 'Features',
      locked: false,
      content: defaults.features || { items: [] }
    },
    {
      id: 'cta',
      type: 'Call to Action',
      locked: false,
      content: defaults.cta || { title: '', buttonText: '' }
    },
    { id: 'footer', type: 'Footer', locked: true, content: {} }
  ];
}

// Render page editor with sections
function renderPageEditor() {
  const container = document.getElementById('flow-sections-list');
  const titleEl = document.getElementById('flow-editor-page-title');

  if (titleEl && currentEditingPage) {
    titleEl.textContent = 'Redigerer: ' + currentEditingPage.title;
  }

  if (!container || !currentEditingPage) return;

  container.innerHTML = currentEditingPage.sections.map((section, index) => `
    <div class="flow-section-editor" data-index="${index}">
      <div class="flow-section-header" onclick="toggleSectionFields(${index})">
        <span class="flow-section-type">${section.type}</span>
        <span class="flow-section-locked">${section.locked ? 'üîí L√•st' : '‚úèÔ∏è Redigerbar'}</span>
      </div>
      ${section.locked ? `
        <div class="flow-section-fields" style="padding:16px;color:var(--muted)">
          <p>Denne sektion er l√•st og kan ikke redigeres. Header og footer er ens p√• alle sider.</p>
        </div>
      ` : `
        <div class="flow-section-fields" id="section-fields-${index}" style="display:none">
          ${renderSectionFields(section)}
        </div>
      `}
    </div>
  `).join('');
}

// Toggle section fields visibility
function toggleSectionFields(index) {
  const fields = document.getElementById('section-fields-' + index);
  if (fields) {
    fields.style.display = fields.style.display === 'none' ? 'block' : 'none';
  }
}

// Render fields for a section
function renderSectionFields(section) {
  if (section.type === 'Hero Sektion') {
    return `
      <div class="form-group">
        <label class="form-label">Overskrift</label>
        <input type="text" class="input" id="section-${section.id}-title" value="${section.content.title || ''}" placeholder="Hovedoverskrift">
      </div>
      <div class="form-group">
        <label class="form-label">Undertitel</label>
        <textarea class="input" id="section-${section.id}-subtitle" rows="2" placeholder="Beskrivende tekst">${section.content.subtitle || ''}</textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Knaptekst</label>
        <input type="text" class="input" id="section-${section.id}-cta-text" value="${section.content.ctaText || ''}" placeholder="Kom i gang">
      </div>
      <div class="form-group">
        <label class="form-label">Knap URL</label>
        <input type="text" class="input" id="section-${section.id}-cta-url" value="${section.content.ctaUrl || ''}" placeholder="#demo">
      </div>
    `;
  }

  if (section.type === 'Call to Action') {
    return `
      <div class="form-group">
        <label class="form-label">Overskrift</label>
        <input type="text" class="input" id="section-${section.id}-title" value="${section.content.title || ''}" placeholder="Klar til at komme i gang?">
      </div>
      <div class="form-group">
        <label class="form-label">Knaptekst</label>
        <input type="text" class="input" id="section-${section.id}-button" value="${section.content.buttonText || ''}" placeholder="Start gratis">
      </div>
    `;
  }

  if (section.type === 'Features') {
    return `
      <div class="form-group">
        <label class="form-label">Feature beskrivelser (√©n per linje)</label>
        <textarea class="input" id="section-${section.id}-items" rows="6" placeholder="Feature 1\nFeature 2\nFeature 3">${(section.content.items || []).join('\n')}</textarea>
      </div>
    `;
  }

  return `<p style="color:var(--muted)">Ingen redigerbare felter for denne sektionstype.</p>`;
}

// Save Flow page
function saveFlowPage() {
  if (!currentEditingPage) return;

  // Collect data from form fields
  currentEditingPage.sections.forEach(section => {
    if (section.locked) return;

    if (section.type === 'Hero Sektion') {
      section.content.title = document.getElementById('section-' + section.id + '-title')?.value || '';
      section.content.subtitle = document.getElementById('section-' + section.id + '-subtitle')?.value || '';
      section.content.ctaText = document.getElementById('section-' + section.id + '-cta-text')?.value || '';
      section.content.ctaUrl = document.getElementById('section-' + section.id + '-cta-url')?.value || '';
    }

    if (section.type === 'Call to Action') {
      section.content.title = document.getElementById('section-' + section.id + '-title')?.value || '';
      section.content.buttonText = document.getElementById('section-' + section.id + '-button')?.value || '';
    }

    if (section.type === 'Features') {
      const items = document.getElementById('section-' + section.id + '-items')?.value || '';
      section.content.items = items.split('\n').filter(i => i.trim());
    }
  });

  // Save to localStorage
  localStorage.setItem('flow_page_' + currentEditingPage.slug, JSON.stringify(currentEditingPage.sections));

  toast('Side gemt', 'success');
}

// Preview Flow page
function previewFlowPage() {
  if (currentEditingPage) {
    window.open(currentEditingPage.slug + '.html', '_blank');
  }
}

// =====================================================
// MARKETING EDITOR (React Admin Style)
// =====================================================

// Marketing State
let marketingCampaigns = [];
let marketingBroadcasts = [];
let marketingSegments = [];
let currentCampaignId = null;
let marketingHasChanges = false;

// Default campaigns
function getDefaultCampaigns() {
  return [
    {
      id: 'campaign-welcome',
      name: 'Velkomstbesked',
      description: 'Automatisk besked til nye kunder',
      type: 'announcement',
      status: 'active',
      channels: ['email', 'sms'],
      content: {
        headline: 'Velkommen til Flow!',
        body: 'Tak fordi du valgte os. Vi gl√¶der os til at servicere dig.',
        ctaText: 'Se vores menu',
        ctaUrl: '/menu'
      },
      stats: { sent: 245, delivered: 240, opened: 180, clicked: 45, converted: 12 },
      createdAt: '2026-01-15T10:00:00Z',
      sentAt: '2026-01-20T12:00:00Z'
    },
    {
      id: 'campaign-birthday',
      name: 'F√∏dselsdagstilbud',
      description: 'Automatisk f√∏dselsdagsrabat',
      type: 'promotion',
      status: 'active',
      channels: ['email', 'push', 'sms'],
      content: {
        headline: 'Tillykke med f√∏dselsdagen!',
        body: 'Fejr din dag med 20% rabat p√• din n√¶ste ordre.',
        ctaText: 'Indl√∏s rabat',
        ctaUrl: '/bestil'
      },
      stats: { sent: 89, delivered: 87, opened: 72, clicked: 34, converted: 18 },
      createdAt: '2026-01-10T10:00:00Z',
      sentAt: null
    }
  ];
}

// Default segments
function getDefaultSegments() {
  return [
    { id: 'segment-vip', name: 'VIP Kunder', description: 'Kunder med mere end 10 ordrer', customerCount: 234, createdAt: '2026-01-01T10:00:00Z' },
    { id: 'segment-new', name: 'Nye Kunder', description: 'Kunder fra de sidste 30 dage', customerCount: 89, createdAt: '2026-01-01T10:00:00Z' },
    { id: 'segment-inactive', name: 'Inaktive Kunder', description: 'Ingen ordre i 60+ dage', customerCount: 156, createdAt: '2026-01-01T10:00:00Z' }
  ];
}

// Default broadcasts
function getDefaultBroadcasts() {
  return [
    {
      id: 'broadcast-1',
      campaignId: 'campaign-welcome',
      campaignName: 'Velkomst Email Kampagne',
      channels: ['email'],
      sentAt: '2026-01-15T10:00:00Z',
      stats: { recipients: 156, delivered: 142, opened: 89, clicked: 34, failed: 14 },
      status: 'completed'
    },
    {
      id: 'broadcast-2',
      campaignId: 'campaign-promo',
      campaignName: 'Weekend Tilbud SMS',
      channels: ['sms'],
      sentAt: '2026-01-12T14:30:00Z',
      stats: { recipients: 423, delivered: 418, opened: 0, clicked: 0, failed: 5 },
      status: 'completed'
    },
    {
      id: 'broadcast-3',
      campaignId: 'campaign-newsletter',
      campaignName: 'Januar Nyhedsbrev',
      channels: ['email', 'app'],
      sentAt: '2026-01-10T09:00:00Z',
      stats: { recipients: 892, delivered: 876, opened: 456, clicked: 123, failed: 16 },
      status: 'completed'
    },
    {
      id: 'broadcast-4',
      campaignId: 'campaign-loyalty',
      campaignName: 'Loyalitetsbonus Reminder',
      channels: ['sms', 'push'],
      sentAt: '2026-01-05T16:00:00Z',
      stats: { recipients: 234, delivered: 230, opened: 0, clicked: 0, failed: 4 },
      status: 'completed'
    }
  ];
}

// Load Marketing Data
function loadMarketingData() {
  // Load campaigns
  const savedCampaigns = localStorage.getItem('orderflow_marketing_campaigns');
  marketingCampaigns = savedCampaigns ? JSON.parse(savedCampaigns) : getDefaultCampaigns();

  // Load broadcasts
  const savedBroadcasts = localStorage.getItem('orderflow_marketing_broadcasts');
  marketingBroadcasts = savedBroadcasts ? JSON.parse(savedBroadcasts) : getDefaultBroadcasts();

  // Load segments
  const savedSegments = localStorage.getItem('orderflow_marketing_segments');
  marketingSegments = savedSegments ? JSON.parse(savedSegments) : getDefaultSegments();

  marketingHasChanges = false;
  updateMarketingUnsavedBadge();
  renderCampaignsList();
}

// Save Marketing Data
function saveMarketingData() {
  localStorage.setItem('orderflow_marketing_campaigns', JSON.stringify(marketingCampaigns));
  localStorage.setItem('orderflow_marketing_broadcasts', JSON.stringify(marketingBroadcasts));
  localStorage.setItem('orderflow_marketing_segments', JSON.stringify(marketingSegments));
  marketingHasChanges = false;
  updateMarketingUnsavedBadge();
  toast('Marketing data gemt', 'success');
}

// Mark marketing as changed
function markMarketingChanged() {
  marketingHasChanges = true;
  updateMarketingUnsavedBadge();
}

// Update unsaved badge
function updateMarketingUnsavedBadge() {
  const badge = document.getElementById('marketing-unsaved-badge');
  if (badge) {
    badge.style.display = marketingHasChanges ? 'inline-block' : 'none';
  }
}

// Switch Marketing Tab
function switchMarketingTab(tab) {
  // Update tab buttons
  document.querySelectorAll('#page-campaigns .tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  document.getElementById('marketing-tab-' + tab)?.classList.add('active');

  // Hide all tabs
  document.getElementById('marketing-content-campaigns').style.display = 'none';
  document.getElementById('marketing-content-broadcasts').style.display = 'none';
  document.getElementById('marketing-content-segments').style.display = 'none';

  // Show selected tab
  document.getElementById('marketing-content-' + tab).style.display = 'block';

  // Render tab content
  if (tab === 'campaigns') renderCampaignsList();
  if (tab === 'broadcasts') renderBroadcastsList();
  if (tab === 'segments') renderSegmentsList();
}

// Render Campaigns List
function renderCampaignsList() {
  const container = document.getElementById('campaigns-list');
  if (!container) return;

  const statusColors = {
    draft: 'badge-warning',
    scheduled: 'badge-info',
    active: 'badge-success',
    completed: 'badge-secondary',
    cancelled: 'badge-danger'
  };

  const statusLabels = {
    draft: 'Kladde',
    scheduled: 'Planlagt',
    active: 'Aktiv',
    completed: 'Afsluttet',
    cancelled: 'Annulleret'
  };

  const typeIcons = {
    promotion: '',
    newsletter: '',
    event: '',
    announcement: ''
  };

  container.innerHTML = marketingCampaigns.map(campaign => `
    <div class="campaign-item" onclick="selectCampaign('${campaign.id}')" style="padding:12px;border-radius:8px;cursor:pointer;border:1px solid ${currentCampaignId === campaign.id ? 'var(--primary)' : 'transparent'};background:${currentCampaignId === campaign.id ? 'var(--primary-light)' : 'transparent'};margin-bottom:8px;transition:all 0.15s ease">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
        <div>
          <div style="display:flex;align-items:center;gap:8px">
            <span>${typeIcons[campaign.type] || ''}</span>
            <span style="font-weight:500;font-size:13px">${campaign.name}</span>
          </div>
          <p style="font-size:11px;color:var(--muted);margin:4px 0 0">${campaign.description || 'Ingen beskrivelse'}</p>
        </div>
        <span class="badge ${statusColors[campaign.status] || 'badge-secondary'}" style="font-size:10px">${statusLabels[campaign.status] || campaign.status}</span>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        ${campaign.channels.map(ch => `<span style="font-size:10px;padding:2px 6px;background:var(--bg3);border-radius:4px">${getChannelIcon(ch)}</span>`).join('')}
      </div>
      ${campaign.stats?.sent > 0 ? `
        <div style="display:flex;gap:12px;margin-top:8px;font-size:10px;color:var(--muted)">
          <span>Sendt: ${campaign.stats.sent}</span>
          <span>√Öbnet: ${campaign.stats.opened}</span>
          <span>Klikket: ${campaign.stats.clicked}</span>
        </div>
      ` : ''}
    </div>
  `).join('') || '<p style="text-align:center;padding:20px;color:var(--muted)">Ingen kampagner endnu</p>';
}

// Get channel label (no icons for cleaner design)
function getChannelIcon(channel) {
  const labels = {
    app: 'App',
    website: 'Web',
    email: 'Email',
    sms: 'SMS',
    push: 'Push'
  };
  return labels[channel] || channel;
}

// Select Campaign
function selectCampaign(campaignId) {
  currentCampaignId = campaignId;
  renderCampaignsList();
  renderCampaignEditor();
}

// Get current campaign
function getCurrentCampaign() {
  return marketingCampaigns.find(c => c.id === currentCampaignId);
}

// Render Campaign Editor
function renderCampaignEditor() {
  const campaign = getCurrentCampaign();
  const emptyEl = document.getElementById('campaign-editor-empty');
  const formEl = document.getElementById('campaign-editor-form');
  const headerEl = document.getElementById('campaign-editor-header');

  if (!campaign) {
    if (emptyEl) emptyEl.style.display = 'flex';
    if (formEl) formEl.style.display = 'none';
    if (headerEl) headerEl.style.display = 'none';
    return;
  }

  if (emptyEl) emptyEl.style.display = 'none';
  if (formEl) formEl.style.display = 'block';
  if (headerEl) headerEl.style.display = 'block';

  // Fill form
  document.getElementById('campaign-name').value = campaign.name || '';
  document.getElementById('campaign-description').value = campaign.description || '';
  document.getElementById('campaign-type').value = campaign.type || 'promotion';
  document.getElementById('campaign-status').value = campaign.status || 'draft';

  // Channels
  document.getElementById('channel-app').checked = campaign.channels?.includes('app');
  document.getElementById('channel-website').checked = campaign.channels?.includes('website');
  document.getElementById('channel-email').checked = campaign.channels?.includes('email');
  document.getElementById('channel-sms').checked = campaign.channels?.includes('sms');
  document.getElementById('channel-push').checked = campaign.channels?.includes('push');

  // Content
  document.getElementById('campaign-headline').value = campaign.content?.headline || '';
  document.getElementById('campaign-body').value = campaign.content?.body || '';
  document.getElementById('campaign-cta-text').value = campaign.content?.ctaText || '';
  document.getElementById('campaign-cta-url').value = campaign.content?.ctaUrl || '';

  // Stats
  const statsEl = document.getElementById('campaign-stats');
  if (campaign.stats?.sent > 0) {
    statsEl.style.display = 'block';
    document.getElementById('stat-sent').textContent = campaign.stats.sent || 0;
    document.getElementById('stat-opened').textContent = campaign.stats.opened || 0;
    document.getElementById('stat-clicked').textContent = campaign.stats.clicked || 0;
    document.getElementById('stat-converted').textContent = campaign.stats.converted || 0;
  } else {
    statsEl.style.display = 'none';
  }
}

// Update current campaign field
function updateCurrentCampaignField(field, value) {
  const campaign = getCurrentCampaign();
  if (!campaign) return;
  campaign[field] = value;
  markMarketingChanged();
  renderCampaignsList();
}

// Update campaign channels
function updateCampaignChannels() {
  const campaign = getCurrentCampaign();
  if (!campaign) return;

  const channels = [];
  if (document.getElementById('channel-app').checked) channels.push('app');
  if (document.getElementById('channel-website').checked) channels.push('website');
  if (document.getElementById('channel-email').checked) channels.push('email');
  if (document.getElementById('channel-sms').checked) channels.push('sms');
  if (document.getElementById('channel-push').checked) channels.push('push');

  campaign.channels = channels;
  markMarketingChanged();
  renderCampaignsList();
}

// Update campaign content
function updateCampaignContent(field, value) {
  const campaign = getCurrentCampaign();
  if (!campaign) return;
  if (!campaign.content) campaign.content = {};
  campaign.content[field] = value;
  markMarketingChanged();
}

// Add new campaign
function addNewCampaign() {
  const newCampaign = {
    id: 'campaign-' + Date.now(),
    name: 'Ny Kampagne',
    description: '',
    type: 'promotion',
    status: 'draft',
    channels: ['email'],
    content: { headline: '', body: '', ctaText: '', ctaUrl: '' },
    stats: { sent: 0, delivered: 0, opened: 0, clicked: 0, converted: 0 },
    createdAt: new Date().toISOString(),
    sentAt: null
  };

  marketingCampaigns.unshift(newCampaign);
  markMarketingChanged();
  renderCampaignsList();
  selectCampaign(newCampaign.id);
}

// Delete current campaign
function deleteCurrentCampaign() {
  const campaign = getCurrentCampaign();
  if (!campaign) return;
  if (!confirm(`Er du sikker p√• at du vil slette "${campaign.name}"?`)) return;

  marketingCampaigns = marketingCampaigns.filter(c => c.id !== campaign.id);
  currentCampaignId = null;
  markMarketingChanged();
  renderCampaignsList();
  renderCampaignEditor();
}

// Duplicate current campaign
function duplicateCurrentCampaign() {
  const campaign = getCurrentCampaign();
  if (!campaign) return;

  const duplicated = JSON.parse(JSON.stringify(campaign));
  duplicated.id = 'campaign-' + Date.now();
  duplicated.name = campaign.name + ' (Kopi)';
  duplicated.status = 'draft';
  duplicated.stats = { sent: 0, delivered: 0, opened: 0, clicked: 0, converted: 0 };
  duplicated.createdAt = new Date().toISOString();
  duplicated.sentAt = null;

  marketingCampaigns.unshift(duplicated);
  markMarketingChanged();
  renderCampaignsList();
  selectCampaign(duplicated.id);
  toast('Kampagne duplikeret', 'success');
}

// Send current campaign
function sendCurrentCampaign() {
  const campaign = getCurrentCampaign();
  if (!campaign) return;
  if (campaign.channels.length === 0) {
    toast('V√¶lg mindst √©n kanal', 'error');
    return;
  }

  // Create broadcast record
  const broadcast = {
    id: 'broadcast-' + Date.now(),
    campaignId: campaign.id,
    campaignName: campaign.name,
    channels: campaign.channels,
    sentAt: new Date().toISOString(),
    stats: {
      recipients: Math.floor(Math.random() * 500) + 100,
      delivered: 0,
      failed: 0
    },
    status: 'sending'
  };

  // Simulate sending
  broadcast.stats.delivered = Math.floor(broadcast.stats.recipients * 0.95);
  broadcast.stats.failed = broadcast.stats.recipients - broadcast.stats.delivered;
  broadcast.status = 'sent';

  // Update campaign stats
  campaign.stats.sent = (campaign.stats.sent || 0) + broadcast.stats.delivered;
  campaign.sentAt = broadcast.sentAt;

  marketingBroadcasts.unshift(broadcast);
  markMarketingChanged();
  renderCampaignsList();
  renderCampaignEditor();
  toast(`Kampagne sendt til ${broadcast.stats.delivered} modtagere`, 'success');
}

// Render Broadcasts List
// Track selected broadcasts for table
let selectedBroadcasts = [];

function renderBroadcastsList() {
  const container = document.getElementById('broadcasts-list');
  const emptyEl = document.getElementById('broadcasts-empty');
  if (!container) return;

  if (marketingBroadcasts.length === 0) {
    container.innerHTML = '';
    if (emptyEl) emptyEl.style.display = 'block';
    return;
  }

  if (emptyEl) emptyEl.style.display = 'none';

  const allSelected = selectedBroadcasts.length === marketingBroadcasts.length && marketingBroadcasts.length > 0;
  const someSelected = selectedBroadcasts.length > 0 && selectedBroadcasts.length < marketingBroadcasts.length;

  container.innerHTML = `
    <div class="table-container" style="overflow-x:auto">
      <table class="data-table" style="width:100%;border-collapse:collapse">
        <thead>
          <tr style="border-bottom:1px solid var(--border)">
            <th style="width:40px;padding:12px 8px;text-align:left">
              <input type="checkbox"
                id="select-all-broadcasts"
                onchange="toggleAllBroadcasts(this.checked)"
                ${allSelected ? 'checked' : ''}
                ${someSelected ? 'class="indeterminate"' : ''}>
            </th>
            <th style="padding:12px 8px;text-align:left;font-weight:500;font-size:13px">Titel</th>
            <th style="padding:12px 8px;text-align:left;font-weight:500;font-size:13px">Type</th>
            <th style="padding:12px 8px;text-align:left;font-weight:500;font-size:13px">Sendt</th>
            <th style="padding:12px 8px;text-align:left;font-weight:500;font-size:13px">Modtagere</th>
            <th style="padding:12px 8px;text-align:left;font-weight:500;font-size:13px">√Öbnet</th>
            <th style="padding:12px 8px;text-align:left;font-weight:500;font-size:13px">Klikket</th>
            <th style="padding:12px 8px;text-align:left;font-weight:500;font-size:13px">Status</th>
          </tr>
        </thead>
        <tbody>
          ${marketingBroadcasts.map(broadcast => {
            const isSelected = selectedBroadcasts.includes(broadcast.id);
            const recipients = broadcast.stats?.recipients || broadcast.stats?.delivered + broadcast.stats?.failed || 0;
            const opened = broadcast.stats?.opened || broadcast.stats?.delivered || 0;
            const clicked = broadcast.stats?.clicked || 0;
            const openRate = recipients > 0 ? Math.round((opened / recipients) * 100) : 0;
            const clickRate = recipients > 0 ? Math.round((clicked / recipients) * 100) : 0;

            // Determine type badges
            const typeBadges = broadcast.channels.map(ch => {
              const colors = {
                'email': 'background:var(--accent);color:white',
                'sms': 'background:var(--warning);color:white',
                'app': 'background:var(--success);color:white',
                'web': 'background:var(--info);color:white'
              };
              return `<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;${colors[ch] || 'background:var(--muted)'}">${ch.toUpperCase()}</span>`;
            }).join(' ');

            // Status badge
            const statusColors = {
              'completed': 'background:var(--success);color:white',
              'pending': 'background:var(--warning);color:white',
              'failed': 'background:var(--danger);color:white',
              'draft': 'background:var(--muted);color:white'
            };
            const statusText = {
              'completed': 'Sendt',
              'pending': 'Afventer',
              'failed': 'Fejlet',
              'draft': 'Kladde'
            };
            const status = broadcast.status || 'completed';

            return `
              <tr style="border-bottom:1px solid var(--border);${isSelected ? 'background:var(--accent-light, rgba(45, 212, 191, 0.1))' : ''}">
                <td style="padding:12px 8px">
                  <input type="checkbox"
                    onchange="toggleBroadcastSelection('${broadcast.id}')"
                    ${isSelected ? 'checked' : ''}>
                </td>
                <td style="padding:12px 8px">
                  <span style="font-weight:500;font-size:14px">${broadcast.campaignName}</span>
                </td>
                <td style="padding:12px 8px">
                  <div style="display:flex;gap:4px;flex-wrap:wrap">${typeBadges}</div>
                </td>
                <td style="padding:12px 8px;font-size:13px;color:var(--muted)">
                  ${new Date(broadcast.sentAt).toLocaleDateString('da-DK')}
                </td>
                <td style="padding:12px 8px;font-size:13px">
                  ${recipients.toLocaleString('da-DK')}
                </td>
                <td style="padding:12px 8px;font-size:13px">
                  ${openRate}%
                </td>
                <td style="padding:12px 8px;font-size:13px">
                  ${clickRate > 0 ? clickRate + '%' : '-'}
                </td>
                <td style="padding:12px 8px">
                  <span style="display:inline-block;padding:4px 10px;border-radius:4px;font-size:12px;${statusColors[status]}">${statusText[status]}</span>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;

  // Set indeterminate state for checkbox
  const selectAllCheckbox = document.getElementById('select-all-broadcasts');
  if (selectAllCheckbox && someSelected) {
    selectAllCheckbox.indeterminate = true;
  }
}

// Toggle single broadcast selection
function toggleBroadcastSelection(id) {
  if (selectedBroadcasts.includes(id)) {
    selectedBroadcasts = selectedBroadcasts.filter(item => item !== id);
  } else {
    selectedBroadcasts.push(id);
  }
  renderBroadcastsList();
}

// Toggle all broadcasts selection
function toggleAllBroadcasts(checked) {
  if (checked) {
    selectedBroadcasts = marketingBroadcasts.map(b => b.id);
  } else {
    selectedBroadcasts = [];
  }
  renderBroadcastsList();
}

// Render Segments List
function renderSegmentsList() {
  const container = document.getElementById('segments-grid');
  const emptyEl = document.getElementById('segments-empty');
  if (!container) return;

  if (marketingSegments.length === 0) {
    container.innerHTML = '';
    if (emptyEl) emptyEl.style.display = 'block';
    return;
  }

  if (emptyEl) emptyEl.style.display = 'none';

  container.innerHTML = marketingSegments.map(segment => `
    <div class="setting-card" style="padding:20px">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
        <div>
          <h3 style="margin:0;font-size:16px;font-weight:600">${segment.name}</h3>
          <p style="margin:4px 0 0;font-size:12px;color:var(--muted)">${segment.description || 'Ingen beskrivelse'}</p>
        </div>
        <button class="btn btn-sm btn-danger" onclick="deleteSegment('${segment.id}')">Slet</button>
      </div>
      <div style="display:flex;align-items:center;gap:8px;padding:12px;background:var(--bg3);border-radius:8px">
        <span style="font-size:24px;font-weight:600">${segment.customerCount}</span>
        <span style="font-size:12px;color:var(--muted)">kunder</span>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn btn-sm btn-secondary" style="flex:1" onclick="viewSegmentCustomers('${segment.id}')">Se kunder</button>
        <button class="btn btn-sm btn-primary" style="flex:1" onclick="sendToSegment('${segment.id}')">Send besked</button>
      </div>
    </div>
  `).join('');
}

// Add new segment
function addNewSegment() {
  const name = prompt('Segmentnavn:');
  if (!name) return;

  const newSegment = {
    id: 'segment-' + Date.now(),
    name: name,
    description: '',
    customerCount: 0,
    createdAt: new Date().toISOString()
  };

  marketingSegments.push(newSegment);
  markMarketingChanged();
  renderSegmentsList();
}

// Delete segment
function deleteSegment(segmentId) {
  const segment = marketingSegments.find(s => s.id === segmentId);
  if (!segment) return;
  if (!confirm(`Er du sikker p√• at du vil slette "${segment.name}"?`)) return;

  marketingSegments = marketingSegments.filter(s => s.id !== segmentId);
  markMarketingChanged();
  renderSegmentsList();
}

// View segment customers (placeholder)
function viewSegmentCustomers(segmentId) {
  toast('Kundevisning kommer snart', 'info');
}

// Send to segment (placeholder)
function sendToSegment(segmentId) {
  const segment = marketingSegments.find(s => s.id === segmentId);
  if (segment) {
    toast(`Sender til ${segment.customerCount} kunder i "${segment.name}"`, 'info');
  }
}

// Initialize Marketing on page load
function initMarketingPage() {
  loadMarketingData();
  switchMarketingTab('campaigns');
}

// =====================================================
// BLOG FUNCTIONS
// =====================================================

// Load blog posts
function loadBlogPosts() {
  const saved = localStorage.getItem('flow_blog_posts');
  blogPosts = saved ? JSON.parse(saved) : [];
  renderBlogList();
}

// Render blog list
function renderBlogList() {
  const tbody = document.getElementById('flow-blog-list');
  const emptyEl = document.getElementById('flow-blog-empty');

  if (!tbody) return;

  if (blogPosts.length === 0) {
    tbody.innerHTML = '';
    if (emptyEl) emptyEl.style.display = 'block';
    return;
  }

  if (emptyEl) emptyEl.style.display = 'none';

  tbody.innerHTML = blogPosts.map((post, index) => `
    <tr>
      <td style="font-weight:500">${post.title || 'Uden titel'}</td>
      <td><span class="flow-blog-status ${post.status}">${post.status === 'published' ? 'Publiceret' : 'Kladde'}</span></td>
      <td style="color:var(--muted)">${new Date(post.created_at).toLocaleDateString('da-DK')}</td>
      <td style="text-align:right">
        <button class="btn btn-sm btn-secondary" onclick="editBlogPost(${index})">Rediger</button>
        <button class="btn btn-sm" style="color:var(--danger)" onclick="deleteBlogPost(${index})">Slet</button>
      </td>
    </tr>
  `).join('');
}

// Create new blog post
function createNewBlogPost() {
  currentBlogPost = {
    title: '',
    slug: '',
    excerpt: '',
    content: '',
    status: 'draft',
    created_at: new Date().toISOString()
  };

  document.getElementById('blog-title').value = '';
  document.getElementById('blog-slug').value = '';
  document.getElementById('blog-excerpt').value = '';
  document.getElementById('blog-content').value = '';

  switchFlowCMSTab('blog-editor');
}

// Edit blog post
function editBlogPost(index) {
  currentBlogPost = { ...blogPosts[index], _index: index };

  document.getElementById('blog-title').value = currentBlogPost.title || '';
  document.getElementById('blog-slug').value = currentBlogPost.slug || '';
  document.getElementById('blog-excerpt').value = currentBlogPost.excerpt || '';
  document.getElementById('blog-content').value = currentBlogPost.content || '';

  switchFlowCMSTab('blog-editor');
}

// Save blog post
function saveBlogPost(status) {
  if (!currentBlogPost) return;

  currentBlogPost.title = document.getElementById('blog-title').value;
  currentBlogPost.slug = document.getElementById('blog-slug').value || generateSlug(currentBlogPost.title);
  currentBlogPost.excerpt = document.getElementById('blog-excerpt').value;
  currentBlogPost.content = document.getElementById('blog-content').value;
  currentBlogPost.status = status;
  currentBlogPost.updated_at = new Date().toISOString();

  if (status === 'published' && !currentBlogPost.published_at) {
    currentBlogPost.published_at = new Date().toISOString();
  }

  if (currentBlogPost._index !== undefined) {
    blogPosts[currentBlogPost._index] = currentBlogPost;
  } else {
    blogPosts.push(currentBlogPost);
  }

  localStorage.setItem('flow_blog_posts', JSON.stringify(blogPosts));

  const statusEl = document.getElementById('blog-save-status');
  if (statusEl) {
    statusEl.style.display = 'inline';
    setTimeout(() => statusEl.style.display = 'none', 3000);
  }

  toast(status === 'published' ? 'Blogindl√¶g publiceret!' : 'Kladde gemt', 'success');
  switchFlowCMSTab('blog');
}

// Delete blog post
function deleteBlogPost(index) {
  if (!confirm('Er du sikker p√• at du vil slette dette blogindl√¶g?')) return;

  blogPosts.splice(index, 1);
  localStorage.setItem('flow_blog_posts', JSON.stringify(blogPosts));
  renderBlogList();
  toast('Blogindl√¶g slettet', 'info');
}

// Generate URL slug from title
function generateSlug(title) {
  return title
    .toLowerCase()
    .replace(/√¶/g, 'ae')
    .replace(/√∏/g, 'oe')
    .replace(/√•/g, 'aa')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-|-$/g, '');
}

// =====================================================
// WORKFLOW FUNCTIONS
// =====================================================

// Load workflow configuration
function loadWorkflowConfig(type) {
  const saved = localStorage.getItem('flow_product_' + type);
  const config = saved ? JSON.parse(saved) : {};

  if (type === 'sms') {
    const welcomeEl = document.getElementById('sms-welcome-msg');
    const confirmEl = document.getElementById('sms-confirm-msg');
    const reactivateEl = document.getElementById('sms-reactivate-msg');
    const daysEl = document.getElementById('sms-reactivate-days');

    if (welcomeEl) welcomeEl.value = config.welcome || '';
    if (confirmEl) confirmEl.value = config.confirm || '';
    if (reactivateEl) reactivateEl.value = config.reactivate || '';
    if (daysEl) daysEl.value = config.reactivateDays || 14;
  }

  if (type === 'instagram') {
    const welcomeEl = document.getElementById('ig-welcome-msg');
    const storyEl = document.getElementById('ig-story-mention-msg');
    const enabledEl = document.getElementById('ig-auto-reply-enabled');

    if (welcomeEl) welcomeEl.value = config.welcome || '';
    if (storyEl) storyEl.value = config.storyMention || '';
    if (enabledEl) enabledEl.checked = config.autoReplyEnabled || false;
  }

  if (type === 'facebook') {
    const welcomeEl = document.getElementById('fb-welcome-msg');
    const offlineEl = document.getElementById('fb-offline-msg');
    const enabledEl = document.getElementById('fb-auto-reply-enabled');

    if (welcomeEl) welcomeEl.value = config.welcome || '';
    if (offlineEl) offlineEl.value = config.offline || '';
    if (enabledEl) enabledEl.checked = config.autoReplyEnabled || false;
  }
}

// Save product workflow
function saveProductWorkflow(type) {
  let config = {};

  if (type === 'sms') {
    config = {
      welcome: document.getElementById('sms-welcome-msg')?.value || '',
      confirm: document.getElementById('sms-confirm-msg')?.value || '',
      reactivate: document.getElementById('sms-reactivate-msg')?.value || '',
      reactivateDays: parseInt(document.getElementById('sms-reactivate-days')?.value) || 14
    };
  }

  if (type === 'instagram') {
    config = {
      welcome: document.getElementById('ig-welcome-msg')?.value || '',
      storyMention: document.getElementById('ig-story-mention-msg')?.value || '',
      autoReplyEnabled: document.getElementById('ig-auto-reply-enabled')?.checked || false
    };
  }

  if (type === 'facebook') {
    config = {
      welcome: document.getElementById('fb-welcome-msg')?.value || '',
      offline: document.getElementById('fb-offline-msg')?.value || '',
      autoReplyEnabled: document.getElementById('fb-auto-reply-enabled')?.checked || false
    };
  }

  localStorage.setItem('flow_product_' + type, JSON.stringify(config));

  const statusId = type === 'sms' ? 'sms-save-status' : type === 'instagram' ? 'ig-save-status' : 'fb-save-status';
  const statusEl = document.getElementById(statusId);
  if (statusEl) {
    statusEl.style.display = 'inline';
    setTimeout(() => statusEl.style.display = 'none', 3000);
  }

  toast(type.toUpperCase() + ' Workflow gemt', 'success');
}

// Save SEO settings
function saveSEOSettings() {
  const config = {
    defaultDescription: document.getElementById('seo-default-description')?.value || '',
    defaultOgImage: document.getElementById('seo-default-og-image')?.value || ''
  };

  localStorage.setItem('flow_seo_settings', JSON.stringify(config));

  const statusEl = document.getElementById('seo-save-status');
  if (statusEl) {
    statusEl.style.display = 'inline';
    setTimeout(() => statusEl.style.display = 'none', 3000);
  }

  toast('SEO indstillinger gemt', 'success');
}

// =====================================================
// END FLOW CMS FUNCTIONS
// =====================================================

// Switch Farver tab (Tilpasset/Forudindstillinger)
function switchFarverTab(tab) {
  document.querySelectorAll('#page-wb-farver .settings-tab').forEach(t => t.classList.remove('active'));
  const activeTab = document.querySelector(`#page-wb-farver .settings-tab[onclick*="'${tab}'"]`);
  if (activeTab) activeTab.classList.add('active');

  document.querySelectorAll('.farver-tab-content').forEach(c => {
    c.style.display = 'none';
    c.classList.remove('active');
  });
  const content = document.getElementById('farver-' + tab);
  if (content) {
    content.style.display = 'block';
    content.classList.add('active');
  }
}

// Switch Billeder tab (Logo/Hero/Galleri)
function switchBillederTab(tab) {
  document.querySelectorAll('#page-wb-billeder .settings-tab').forEach(t => t.classList.remove('active'));
  const activeTab = document.querySelector(`#page-wb-billeder .settings-tab[onclick*="'${tab}'"]`);
  if (activeTab) activeTab.classList.add('active');

  document.querySelectorAll('.billeder-tab-content').forEach(c => {
    c.style.display = 'none';
    c.classList.remove('active');
  });
  const content = document.getElementById('billeder-' + tab);
  if (content) {
    content.style.display = 'block';
    content.classList.add('active');
  }

  // Initialize gallery grid when galleri tab is selected
  if (tab === 'galleri') {
    initGalleryGrid();
  }
}

// Apply color theme preset
function applyColorTheme(theme) {
  const themes = {
    'pizza-red': { primary: '#E63946', secondary: '#F4A261', accent: '#F9C74F', bg: '#FAFAFA', text: '#264653' },
    'sushi-green': { primary: '#2D6A4F', secondary: '#40916C', accent: '#74C69D', bg: '#FAFAFA', text: '#1B4332' },
    'burger-orange': { primary: '#E76F51', secondary: '#F4A261', accent: '#E9C46A', bg: '#FAFAFA', text: '#264653' },
    'cafe-brown': { primary: '#6F4E37', secondary: '#A67B5B', accent: '#D4A373', bg: '#FAFAFA', text: '#3C2415' },
    'dark-mode': { primary: '#BB86FC', secondary: '#03DAC6', accent: '#CF6679', bg: '#121212', text: '#FFFFFF' }
  };

  const colors = themes[theme];
  if (!colors) return;

  document.getElementById('wb-color-primary').value = colors.primary;
  document.getElementById('wb-color-primary-text').value = colors.primary;
  document.getElementById('wb-color-secondary').value = colors.secondary;
  document.getElementById('wb-color-secondary-text').value = colors.secondary;
  document.getElementById('wb-color-accent').value = colors.accent;
  document.getElementById('wb-color-accent-text').value = colors.accent;
  if (document.getElementById('wb-color-bg')) {
    document.getElementById('wb-color-bg').value = colors.bg;
    document.getElementById('wb-color-bg-text').value = colors.bg;
  }

  updateWebBuilderPreview();
  switchFarverTab('tilpasset');
}

// Toggle Web Builder Preview Panel
let webBuilderPreviewVisible = false;
function toggleWebBuilderPreview() {
  webBuilderPreviewVisible = !webBuilderPreviewVisible;
  openWebBuilderPreviewFullscreen();
}

// Set all days open
function setAllDaysOpen() {
  document.querySelectorAll('#wb-hours-grid input[type="checkbox"]').forEach(cb => cb.checked = true);
  updateWebBuilderPreview();
}

// Set all days closed
function setAllDaysClosed() {
  document.querySelectorAll('#wb-hours-grid input[type="checkbox"]').forEach(cb => cb.checked = false);
  updateWebBuilderPreview();
}

// Legacy function for backwards compatibility
function switchWebBuilderTab(tab) {
  showWebBuilderPage(tab);
}

// Load Web Builder config from localStorage
function loadWebBuilderConfig() {
  const saved = localStorage.getItem('orderflow_webbuilder_config');
  if (saved) {
    try {
      webBuilderConfig = JSON.parse(saved);
    } catch (e) {
      webBuilderConfig = { ...defaultWebBuilderConfig };
    }
  } else {
    webBuilderConfig = { ...defaultWebBuilderConfig };
  }

  // Populate form fields
  populateWebBuilderForms();
}

// Populate form fields from config
function populateWebBuilderForms() {
  if (!webBuilderConfig) return;

  // Branding
  const nameEl = document.getElementById('wb-name');
  const sloganEl = document.getElementById('wb-slogan');
  const descEl = document.getElementById('wb-description');
  const logoEl = document.getElementById('wb-logo');

  if (nameEl) nameEl.value = webBuilderConfig.branding?.name || defaultWebBuilderConfig.branding.name;
  if (sloganEl) sloganEl.value = webBuilderConfig.branding?.slogan || defaultWebBuilderConfig.branding.slogan;
  if (descEl) descEl.value = webBuilderConfig.branding?.description || defaultWebBuilderConfig.branding.description;
  if (logoEl) logoEl.value = webBuilderConfig.branding?.logo || '';

  // Colors
  const colors = webBuilderConfig.branding?.colors || {};
  ['primary', 'secondary', 'accent', 'text'].forEach(c => {
    const colorEl = document.getElementById('wb-color-' + c);
    const textEl = document.getElementById('wb-color-' + c + '-text');
    if (colorEl) colorEl.value = colors[c] || defaultWebBuilderConfig.branding.colors[c];
    if (textEl) textEl.value = colors[c] || defaultWebBuilderConfig.branding.colors[c];
  });

  // Fonts
  const headingEl = document.getElementById('wb-font-heading');
  const bodyEl = document.getElementById('wb-font-body');
  if (headingEl) headingEl.value = webBuilderConfig.branding?.fonts?.heading || defaultWebBuilderConfig.branding.fonts.heading;
  if (bodyEl) bodyEl.value = webBuilderConfig.branding?.fonts?.body || defaultWebBuilderConfig.branding.fonts.body;

  // Images
  const heroEl = document.getElementById('wb-hero-image');
  const featuredEl = document.getElementById('wb-featured-image');
  if (heroEl) heroEl.value = webBuilderConfig.images?.hero || '';
  if (featuredEl) featuredEl.value = webBuilderConfig.images?.featured || '';

  // Hero Overlay
  const overlayColor = webBuilderConfig.images?.heroOverlay?.color || '#000000';
  const overlayOpacity = Math.round((webBuilderConfig.images?.heroOverlay?.opacity || 0.4) * 100);
  const overlayColorEl = document.getElementById('wb-hero-overlay-color');
  const overlayColorTextEl = document.getElementById('wb-hero-overlay-color-text');
  const overlayOpacityEl = document.getElementById('wb-hero-overlay-opacity');
  const overlayOpacityValueEl = document.getElementById('wb-hero-overlay-opacity-value');
  if (overlayColorEl) overlayColorEl.value = overlayColor;
  if (overlayColorTextEl) overlayColorTextEl.value = overlayColor;
  if (overlayOpacityEl) overlayOpacityEl.value = overlayOpacity;
  if (overlayOpacityValueEl) overlayOpacityValueEl.textContent = overlayOpacity + '%';

  // Menu
  const currencyEl = document.getElementById('wb-currency');
  const taxEl = document.getElementById('wb-tax-rate');
  if (currencyEl) currencyEl.value = webBuilderConfig.menu?.currency || defaultWebBuilderConfig.menu.currency;
  if (taxEl) taxEl.value = webBuilderConfig.menu?.taxRate || defaultWebBuilderConfig.menu.taxRate;

  // Contact
  const addressEl = document.getElementById('wb-address');
  const postalEl = document.getElementById('wb-postal');
  const cityEl = document.getElementById('wb-city');
  const phoneEl = document.getElementById('wb-phone');
  const emailEl = document.getElementById('wb-email');
  if (addressEl) addressEl.value = webBuilderConfig.contact?.address || '';
  if (postalEl) postalEl.value = webBuilderConfig.contact?.postalCode || '';
  if (cityEl) cityEl.value = webBuilderConfig.contact?.city || '';
  if (phoneEl) phoneEl.value = webBuilderConfig.contact?.phone || '';
  if (emailEl) emailEl.value = webBuilderConfig.contact?.email || '';

  // Delivery
  const deliveryEnabledEl = document.getElementById('wb-delivery-enabled');
  const feeEl = document.getElementById('wb-delivery-fee');
  const minOrderEl = document.getElementById('wb-min-order');
  const freeDeliveryEl = document.getElementById('wb-free-delivery');
  const deliveryTimeEl = document.getElementById('wb-delivery-time');
  if (deliveryEnabledEl) deliveryEnabledEl.checked = webBuilderConfig.delivery?.enabled !== false;
  if (feeEl) feeEl.value = webBuilderConfig.delivery?.fee || defaultWebBuilderConfig.delivery.fee;
  if (minOrderEl) minOrderEl.value = webBuilderConfig.delivery?.minimumOrder || defaultWebBuilderConfig.delivery.minimumOrder;
  if (freeDeliveryEl) freeDeliveryEl.value = webBuilderConfig.delivery?.freeDeliveryThreshold || defaultWebBuilderConfig.delivery.freeDeliveryThreshold;
  if (deliveryTimeEl) deliveryTimeEl.value = webBuilderConfig.delivery?.estimatedTime || defaultWebBuilderConfig.delivery.estimatedTime;

  // Features
  const feats = webBuilderConfig.features || {};
  const featOrderingEl = document.getElementById('wb-feat-ordering');
  const featLoyaltyEl = document.getElementById('wb-feat-loyalty');
  const featPickupEl = document.getElementById('wb-feat-pickup');
  const featDeliveryEl = document.getElementById('wb-feat-delivery');
  const featAccountsEl = document.getElementById('wb-feat-accounts');
  const featPushEl = document.getElementById('wb-feat-push');
  if (featOrderingEl) featOrderingEl.checked = feats.ordering !== false;
  if (featLoyaltyEl) featLoyaltyEl.checked = feats.loyalty !== false;
  if (featPickupEl) featPickupEl.checked = feats.pickup !== false;
  if (featDeliveryEl) featDeliveryEl.checked = feats.delivery !== false;
  if (featAccountsEl) featAccountsEl.checked = feats.customerAccounts === true;
  if (featPushEl) featPushEl.checked = feats.pushNotifications === true;

  // Social Media
  const fbEl = document.getElementById('wb-facebook');
  const igEl = document.getElementById('wb-instagram');
  const ttEl = document.getElementById('wb-tiktok');
  if (fbEl) fbEl.value = webBuilderConfig.contact?.socialMedia?.facebook || '';
  if (igEl) igEl.value = webBuilderConfig.contact?.socialMedia?.instagram || '';
  if (ttEl) ttEl.value = webBuilderConfig.contact?.socialMedia?.tiktok || '';

  // Initialize Billeder image previews
  setTimeout(() => {
    if (typeof initBillederPreviews === 'function') {
      initBillederPreviews();
    }
  }, 100);
}

// Render business hours grid
function renderBusinessHoursGrid() {
  const container = document.getElementById('wb-hours-grid');
  if (!container) return;

  const days = [
    { key: 'monday', label: 'Mandag' },
    { key: 'tuesday', label: 'Tirsdag' },
    { key: 'wednesday', label: 'Onsdag' },
    { key: 'thursday', label: 'Torsdag' },
    { key: 'friday', label: 'Fredag' },
    { key: 'saturday', label: 'L√∏rdag' },
    { key: 'sunday', label: 'S√∏ndag' }
  ];

  const hours = webBuilderConfig?.businessHours || defaultWebBuilderConfig.businessHours;

  container.innerHTML = days.map(day => {
    const h = hours[day.key] || { open: '11:00', close: '22:00', closed: false };
    return `
      <div style="display:grid;grid-template-columns:100px 1fr 1fr 80px;gap:12px;align-items:center;margin-bottom:12px">
        <span style="font-weight:500">${day.label}</span>
        <input type="time" class="input" id="wb-hours-${day.key}-open" value="${h.open}" ${h.closed ? 'disabled' : ''} onchange="updateWebBuilderPreview()">
        <input type="time" class="input" id="wb-hours-${day.key}-close" value="${h.close}" ${h.closed ? 'disabled' : ''} onchange="updateWebBuilderPreview()">
        <label style="display:flex;align-items:center;gap:6px;font-size:12px">
          <input type="checkbox" id="wb-hours-${day.key}-closed" ${h.closed ? 'checked' : ''} onchange="toggleDayClosed('${day.key}')">
          Lukket
        </label>
      </div>
    `;
  }).join('');
}

// Toggle day closed
function toggleDayClosed(day) {
  const closedEl = document.getElementById('wb-hours-' + day + '-closed');
  const openEl = document.getElementById('wb-hours-' + day + '-open');
  const closeEl = document.getElementById('wb-hours-' + day + '-close');

  if (closedEl && openEl && closeEl) {
    const isClosed = closedEl.checked;
    openEl.disabled = isClosed;
    closeEl.disabled = isClosed;
  }

  updateWebBuilderPreview();
}

// Sync color picker with text input
function syncColorInput(type) {
  const textEl = document.getElementById('wb-color-' + type + '-text');
  const colorEl = document.getElementById('wb-color-' + type);

  if (textEl && colorEl) {
    const value = textEl.value;
    if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
      colorEl.value = value;
      updateWebBuilderPreview();
    }
  }
}

// Hero Overlay color sync
function syncHeroOverlayColor() {
  const colorEl = document.getElementById('wb-hero-overlay-color');
  const textEl = document.getElementById('wb-hero-overlay-color-text');
  if (colorEl && textEl) textEl.value = colorEl.value;
}

function syncHeroOverlayColorText() {
  const textEl = document.getElementById('wb-hero-overlay-color-text');
  const colorEl = document.getElementById('wb-hero-overlay-color');
  if (textEl && colorEl && /^#[0-9A-Fa-f]{6}$/.test(textEl.value)) {
    colorEl.value = textEl.value;
    updateWebBuilderPreview();
  }
}

function updateHeroOverlayOpacity() {
  const slider = document.getElementById('wb-hero-overlay-opacity');
  const display = document.getElementById('wb-hero-overlay-opacity-value');
  if (slider && display) display.textContent = slider.value + '%';
}

// Gallery images from Web builder Galleri folder
const WEB_BUILDER_GALLERY_IMAGES = [
  'images/Web builder Galleri/photo-1513104890138-7c749659a591.jpeg',
  'images/Web builder Galleri/photo-1574071318508-1cdbab80d002.jpeg',
  'images/Web builder Galleri/photo-1565299624946-b28f40a0ae38.jpeg',
  'images/Web builder Galleri/photo-1563379926898-05f4575a45d8.jpeg',
  'images/Web builder Galleri/photo-1560023907-5f339617ea30.jpeg',
  'images/Web builder Galleri/photo-1571877227200-a0d98ea607e9.jpeg',
  'images/Web builder Galleri/photo-1612874742237-6526221588e3.jpeg',
  'images/Web builder Galleri/photo-1622483767028-3f66f32aef97.jpeg',
  'images/Web builder Galleri/photo-1628840042765-356cda07504e.jpeg',
  'images/Web builder Galleri/photo-1488477181946-6428a0291777.jpeg',
  'images/Web builder Galleri/087cb32951d67b24e3800e63cc8e221e8cf153e3.jpg',
  'images/Web builder Galleri/6b34ff795ebe5ab0649a25a5462d47f6daf8878b.jpg',
  'images/Web builder Galleri/3f614186573fe3272aad077f8ac3ae5728296c77.jpg',
  'images/Web builder Galleri/4eb224c0724cce65431e27f6cbf88341734c716d.jpg',
  'images/Web builder Galleri/37075d1fe31da04fb73fe1600d90d13398836d96.jpg',
  'images/Web builder Galleri/dd995904bc5b2a79b5f1211676f34425afc864d7.jpg',
  'images/Web builder Galleri/5f70ea179451103d83cc64257accbe7484234ee1.jpg',
  'images/Web builder Galleri/a4727c950fa3cd8633959f81de98178b0b890760.jpg',
  'images/Web builder Galleri/36a6d191948546e09f528cc212ff65a1d36cedd2.jpeg',
  'images/Web builder Galleri/e69a0b6a7fc0c45a510c176eaa705fe2c2107c94.jpg.webp'
];

let currentGalleryTarget = 'hero';

function setGalleryTarget(target) {
  currentGalleryTarget = target;
  const heroBtn = document.getElementById('gallery-target-hero');
  const logoBtn = document.getElementById('gallery-target-logo');
  if (heroBtn) {
    heroBtn.style.background = target === 'hero' ? 'var(--accent)' : 'var(--bg2)';
    heroBtn.style.color = target === 'hero' ? 'white' : 'var(--text)';
  }
  if (logoBtn) {
    logoBtn.style.background = target === 'logo' ? 'var(--accent)' : 'var(--bg2)';
    logoBtn.style.color = target === 'logo' ? 'white' : 'var(--text)';
  }
}

function initGalleryGrid() {
  const grid = document.getElementById('wb-gallery-grid');
  if (!grid) return;

  grid.innerHTML = WEB_BUILDER_GALLERY_IMAGES.map(img => `
    <div onclick="selectFromGallery('${img}')" style="cursor:pointer;border-radius:8px;overflow:hidden;aspect-ratio:1;position:relative;border:2px solid transparent;transition:border-color 0.2s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='transparent'">
      <img src="${img}" style="width:100%;height:100%;object-fit:cover" loading="lazy" onerror="this.parentElement.style.display='none'">
    </div>
  `).join('');
}

function selectFromGallery(imageUrl) {
  if (currentGalleryTarget === 'hero') {
    const heroEl = document.getElementById('wb-hero-image');
    if (heroEl) heroEl.value = imageUrl;
    if (typeof updateWbHeroPreview === 'function') updateWbHeroPreview();
  } else {
    const logoEl = document.getElementById('wb-logo');
    if (logoEl) logoEl.value = imageUrl;
    if (typeof updateWbLogoPreview === 'function') updateWbLogoPreview();
  }
  updateWebBuilderPreview();
  toast('Billede valgt!', 'success');
}

// Collect form data into config object
function collectWebBuilderFormData() {
  const config = { ...defaultWebBuilderConfig };

  // Branding
  config.branding = {
    name: document.getElementById('wb-name')?.value || '',
    slogan: document.getElementById('wb-slogan')?.value || '',
    description: document.getElementById('wb-description')?.value || '',
    logo: document.getElementById('wb-logo')?.value || '',
    colors: {
      primary: document.getElementById('wb-color-primary')?.value || '#D4380D',
      secondary: document.getElementById('wb-color-secondary')?.value || '#FFF7E6',
      accent: document.getElementById('wb-color-accent')?.value || '#FFA940',
      text: document.getElementById('wb-color-text')?.value || '#1A1A1A'
    },
    fonts: {
      heading: document.getElementById('wb-font-heading')?.value || 'Playfair Display',
      body: document.getElementById('wb-font-body')?.value || 'Inter'
    }
  };

  // Images
  config.images = {
    hero: document.getElementById('wb-hero-image')?.value || '',
    featured: document.getElementById('wb-featured-image')?.value || '',
    heroOverlay: {
      color: document.getElementById('wb-hero-overlay-color')?.value || '#000000',
      opacity: parseInt(document.getElementById('wb-hero-overlay-opacity')?.value || '40') / 100
    }
  };

  // Menu
  config.menu = {
    currency: document.getElementById('wb-currency')?.value || 'DKK',
    taxRate: parseInt(document.getElementById('wb-tax-rate')?.value) || 25
  };

  // Contact
  config.contact = {
    address: document.getElementById('wb-address')?.value || '',
    postalCode: document.getElementById('wb-postal')?.value || '',
    city: document.getElementById('wb-city')?.value || '',
    phone: document.getElementById('wb-phone')?.value || '',
    email: document.getElementById('wb-email')?.value || '',
    socialMedia: {
      facebook: document.getElementById('wb-facebook')?.value || '',
      instagram: document.getElementById('wb-instagram')?.value || '',
      tiktok: document.getElementById('wb-tiktok')?.value || ''
    }
  };

  // Business Hours
  const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
  config.businessHours = {};
  days.forEach(day => {
    config.businessHours[day] = {
      open: document.getElementById('wb-hours-' + day + '-open')?.value || '11:00',
      close: document.getElementById('wb-hours-' + day + '-close')?.value || '22:00',
      closed: document.getElementById('wb-hours-' + day + '-closed')?.checked || false
    };
  });

  // Delivery
  config.delivery = {
    enabled: document.getElementById('wb-delivery-enabled')?.checked || false,
    fee: parseInt(document.getElementById('wb-delivery-fee')?.value) || 35,
    minimumOrder: parseInt(document.getElementById('wb-min-order')?.value) || 150,
    freeDeliveryThreshold: parseInt(document.getElementById('wb-free-delivery')?.value) || 300,
    estimatedTime: parseInt(document.getElementById('wb-delivery-time')?.value) || 45
  };

  // Features
  config.features = {
    ordering: document.getElementById('wb-feat-ordering')?.checked || false,
    loyalty: document.getElementById('wb-feat-loyalty')?.checked || false,
    pickup: document.getElementById('wb-feat-pickup')?.checked || false,
    delivery: document.getElementById('wb-feat-delivery')?.checked || false,
    customerAccounts: document.getElementById('wb-feat-accounts')?.checked || false,
    pushNotifications: document.getElementById('wb-feat-push')?.checked || false
  };

  return config;
}

// Save Web Builder config
function saveWebBuilderConfig() {
  webBuilderConfig = collectWebBuilderFormData();
  localStorage.setItem('orderflow_webbuilder_config', JSON.stringify(webBuilderConfig));
  toast('Web Builder konfiguration gemt', 'success');
  updateWebBuilderPreview();

  // Vis "‚úì √Ündringer gemt" p√• alle aktive save-status spans
  document.querySelectorAll('.wb-save-status').forEach(status => {
    status.style.display = 'block';
    setTimeout(() => status.style.display = 'none', 3000);
  });
}

// Update Web Builder preview
function updateWebBuilderPreview() {
  const config = collectWebBuilderFormData();
  sendConfigToWebBuilderPreview(config);

  // Also update inline preview elements with the restaurant name
  const nameValue = document.getElementById('wb-name')?.value || 'Pizzeria Roma';
  const previewNameElements = [
    'wb-logo-preview-name',
    'wb-hero-preview-name'
  ];
  previewNameElements.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = nameValue;
  });
}

// Send config to preview iframe
function sendConfigToWebBuilderPreview(config) {
  // Collect all preview frames (by ID and by class)
  const frames = [];

  // Add frames by ID
  const frameIds = ['webbuilder-preview-frame', 'wb-fullscreen-preview-frame'];
  frameIds.forEach(id => {
    const frame = document.getElementById(id);
    if (frame) frames.push(frame);
  });

  // Add frames by class (for embedded previews in Web Builder pages)
  document.querySelectorAll('.webbuilder-preview-frame').forEach(frame => {
    if (!frames.includes(frame)) frames.push(frame);
  });

  // Send config to all found frames
  frames.forEach(frame => {
    if (frame?.contentWindow) {
      try {
        frame.contentWindow.postMessage({
          type: 'UPDATE_RESTAURANT_CONFIG',
          config: config
        }, '*');
      } catch (err) {
        console.warn('Error sending config to preview frame:', err);
      }
    }
  });
}

// Initialize Web Builder preview
function initWebBuilderPreview() {
  loadWebBuilderConfig();

  setTimeout(() => {
    updateWebBuilderPreview();
  }, 500);
}

// Open the full website in a new tab
function openFullWebsite() {
  window.open('./Website%20builder/dist/index.html', '_blank');
}

// Open Web Builder preview in fullscreen modal with device selector
function openWebBuilderPreviewFullscreen() {
  // Check if modal already exists
  let modal = document.getElementById('wb-preview-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'wb-preview-modal';
    modal.className = 'modal-overlay';
    modal.style.cssText = 'display:flex;align-items:center;justify-content:center;z-index:10000';
    modal.innerHTML = `
      <div class="modal" style="width:95vw;max-width:1400px;height:90vh;display:flex;flex-direction:column;padding:0;overflow:hidden">
        <div class="modal-header" style="flex-shrink:0;display:flex;justify-content:space-between;align-items:center;padding:16px 24px;border-bottom:1px solid var(--border)">
          <div style="display:flex;align-items:center;gap:16px">
            <h3 style="margin:0;font-size:16px">Forh√•ndsvisning</h3>
            <div class="wb-device-selector" style="display:flex;gap:4px;background:var(--bg2);border-radius:8px;padding:4px">
              <button class="wb-device-btn active" data-device="mobile" onclick="setWbPreviewDevice('mobile')" style="padding:8px 16px;border:none;background:var(--bg1);border-radius:6px;cursor:pointer;font-size:13px;font-weight:500">Mobil</button>
              <button class="wb-device-btn" data-device="tablet" onclick="setWbPreviewDevice('tablet')" style="padding:8px 16px;border:none;background:transparent;border-radius:6px;cursor:pointer;font-size:13px">Tablet</button>
              <button class="wb-device-btn" data-device="desktop" onclick="setWbPreviewDevice('desktop')" style="padding:8px 16px;border:none;background:transparent;border-radius:6px;cursor:pointer;font-size:13px">Desktop</button>
            </div>
          </div>
          <button class="modal-close" onclick="closeWbPreviewModal()" style="font-size:24px;background:none;border:none;cursor:pointer;color:var(--text)">&times;</button>
        </div>
        <div class="modal-body" style="flex:1;display:flex;align-items:center;justify-content:center;background:var(--bg2);padding:24px;overflow:auto">
          <div id="wb-preview-device-frame" class="wb-device-frame mobile" style="background:#000;border-radius:32px;padding:12px;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);transition:all 0.3s ease">
            <iframe
              id="wb-fullscreen-preview-frame"
              src="./Website%20builder/dist/index.html"
              style="width:100%;height:100%;border:none;border-radius:20px;background:#fff"
              onload="initFullscreenPreview()"
            ></iframe>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);

    // Add styles for device frames
    if (!document.getElementById('wb-device-styles')) {
      const style = document.createElement('style');
      style.id = 'wb-device-styles';
      style.textContent = `
        .wb-device-frame.mobile { width: 375px; height: 667px; }
        .wb-device-frame.tablet { width: 768px; height: 600px; border-radius: 24px; }
        .wb-device-frame.desktop { width: 100%; max-width: 1200px; height: 100%; border-radius: 12px; padding: 8px; }
        .wb-device-btn.active { background: var(--bg1) !important; font-weight: 500 !important; }
        .wb-device-btn:hover:not(.active) { background: rgba(255,255,255,0.5) !important; }
      `;
      document.head.appendChild(style);
    }
  }

  modal.style.display = 'flex';

  // Initialize preview after a short delay
  setTimeout(() => {
    initFullscreenPreview();
  }, 100);
}

// Set preview device size
function setWbPreviewDevice(device) {
  const frame = document.getElementById('wb-preview-device-frame');
  if (!frame) return;

  frame.className = 'wb-device-frame ' + device;

  // Update buttons
  document.querySelectorAll('.wb-device-btn').forEach(btn => {
    btn.classList.remove('active');
    btn.style.background = 'transparent';
    btn.style.fontWeight = 'normal';
  });
  const activeBtn = document.querySelector(`.wb-device-btn[data-device="${device}"]`);
  if (activeBtn) {
    activeBtn.classList.add('active');
    activeBtn.style.background = 'var(--bg1)';
    activeBtn.style.fontWeight = '500';
  }
}

// Close preview modal
function closeWbPreviewModal() {
  const modal = document.getElementById('wb-preview-modal');
  if (modal) modal.style.display = 'none';
}

// Initialize fullscreen preview
function initFullscreenPreview() {
  const iframe = document.getElementById('wb-fullscreen-preview-frame');
  if (iframe && iframe.contentWindow) {
    // Send current config to preview
    updateWebBuilderPreview();
  }
}

// Listen for messages from Web Builder preview
window.addEventListener('message', (event) => {
  if (event.data?.type === 'WEBBUILDER_READY') {
    updateWebBuilderPreview();
  }
});

// Update Logo preview when URL changes
function updateWbLogoPreview() {
  const logoUrl = document.getElementById('wb-logo')?.value || '';
  const previewImg = document.getElementById('wb-logo-preview');
  const previewCircle = document.getElementById('wb-logo-preview-circle');
  const brandingPreview = document.getElementById('wb-branding-logo-preview');
  const placeholder = document.getElementById('wb-logo-placeholder');
  const circlePlaceholder = document.getElementById('wb-logo-preview-circle-placeholder');
  const removeBtn = document.getElementById('wb-logo-remove-btn');
  const uploadArea = document.getElementById('wb-logo-upload-area');

  if (logoUrl && logoUrl.trim() !== '') {
    if (previewImg) previewImg.src = logoUrl;
    if (previewCircle) previewCircle.src = logoUrl;
    if (brandingPreview) brandingPreview.src = logoUrl;
    if (removeBtn) removeBtn.style.display = 'block';
  } else {
    if (previewImg) {
      previewImg.src = '';
      previewImg.style.display = 'none';
    }
    if (previewCircle) {
      previewCircle.src = '';
      previewCircle.style.display = 'none';
    }
    if (brandingPreview) {
      brandingPreview.src = '';
      brandingPreview.style.display = 'none';
    }
    if (placeholder) placeholder.style.display = 'flex';
    if (circlePlaceholder) circlePlaceholder.style.display = 'block';
    if (removeBtn) removeBtn.style.display = 'none';
    if (uploadArea) uploadArea.style.border = '2px dashed var(--border)';
  }

  // Update the restaurant name in preview
  const nameInput = document.getElementById('wb-name');
  const previewName = document.getElementById('wb-logo-preview-name');
  if (nameInput && previewName) {
    previewName.textContent = nameInput.value || 'Pizzeria Roma';
  }

  updateWebBuilderPreview();
}

// Clear Logo
function clearWbLogo() {
  const logoInput = document.getElementById('wb-logo');
  const fileInput = document.getElementById('wb-logo-file-input');
  if (logoInput) {
    logoInput.value = '';
    updateWbLogoPreview();
  }
  if (fileInput) {
    fileInput.value = '';
  }
}

// Handle logo file upload from file input
function handleLogoFileUpload(input) {
  if (input.files && input.files[0]) {
    const file = input.files[0];
    processLogoFile(file);
  }
}

// Handle logo file drop
function handleLogoFileDrop(event) {
  const files = event.dataTransfer.files;
  if (files && files[0]) {
    const file = files[0];
    // Check if it's an accepted image type
    const acceptedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml'];
    if (acceptedTypes.includes(file.type) || file.name.match(/\.(png|jpg|jpeg|svg)$/i)) {
      processLogoFile(file);
    } else {
      toast('Underst√∏tter kun PNG, JPG og SVG billeder', 'error');
    }
  }
}

// Process the logo file and convert to data URL
function processLogoFile(file) {
  // Check file size (max 5MB)
  if (file.size > 5 * 1024 * 1024) {
    toast('Filen er for stor. Maks 5MB', 'error');
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const dataUrl = e.target.result;
    const logoInput = document.getElementById('wb-logo');
    if (logoInput) {
      logoInput.value = dataUrl;
      updateWbLogoPreview();
      toast('Logo uploadet!', 'success');
    }
  };
  reader.onerror = function() {
    toast('Kunne ikke l√¶se filen', 'error');
  };
  reader.readAsDataURL(file);
}

// Update Hero preview when URL changes
function updateWbHeroPreview() {
  const heroUrl = document.getElementById('wb-hero-image')?.value || '';
  const previewImg = document.getElementById('wb-hero-preview');
  const previewDemo = document.getElementById('wb-hero-preview-demo');
  const placeholder = document.getElementById('wb-hero-placeholder');
  const demoPlaceholder = document.getElementById('wb-hero-preview-demo-placeholder');
  const removeBtn = document.getElementById('wb-hero-remove-btn');
  const uploadArea = document.getElementById('wb-hero-upload-area');

  if (heroUrl && heroUrl.trim() !== '') {
    if (previewImg) previewImg.src = heroUrl;
    if (previewDemo) previewDemo.src = heroUrl;
    if (removeBtn) removeBtn.style.display = 'block';
  } else {
    if (previewImg) {
      previewImg.src = '';
      previewImg.style.display = 'none';
    }
    if (previewDemo) {
      previewDemo.src = '';
      previewDemo.style.display = 'none';
    }
    if (placeholder) placeholder.style.display = 'flex';
    if (demoPlaceholder) demoPlaceholder.style.display = 'flex';
    if (removeBtn) removeBtn.style.display = 'none';
    if (uploadArea) uploadArea.style.border = '2px dashed var(--border)';
  }

  // Update the restaurant name in preview
  const nameInput = document.getElementById('wb-name');
  const previewName = document.getElementById('wb-hero-preview-name');
  if (nameInput && previewName) {
    previewName.textContent = nameInput.value || 'Pizzeria Roma';
  }

  updateWebBuilderPreview();
}

// Clear Hero
function clearWbHero() {
  const heroInput = document.getElementById('wb-hero-image');
  if (heroInput) {
    heroInput.value = '';
    updateWbHeroPreview();
  }
}

// Initialize Billeder previews on page load
function initBillederPreviews() {
  updateWbLogoPreview();
  updateWbHeroPreview();
}

// =====================================================
// COOKIE SAMTYKKE SETTINGS
// =====================================================

// Load cookie consent settings from localStorage
function loadCookieSettings() {
  const savedSettings = localStorage.getItem('cookieConsentSettings');
  if (savedSettings) {
    const settings = JSON.parse(savedSettings);

    // Banner texts
    const bannerTitle = document.getElementById('cookie-banner-title');
    const bannerDesc = document.getElementById('cookie-banner-desc');
    if (bannerTitle) bannerTitle.value = settings.bannerTitle || 'Vi bruger cookies';
    if (bannerDesc) bannerDesc.value = settings.bannerDesc || '';

    // Category descriptions
    const necessaryDesc = document.getElementById('cookie-necessary-desc');
    const functionalDesc = document.getElementById('cookie-functional-desc');
    const analyticsDesc = document.getElementById('cookie-analytics-desc');
    const marketingDesc = document.getElementById('cookie-marketing-desc');
    if (necessaryDesc) necessaryDesc.value = settings.necessaryDesc || '';
    if (functionalDesc) functionalDesc.value = settings.functionalDesc || '';
    if (analyticsDesc) analyticsDesc.value = settings.analyticsDesc || '';
    if (marketingDesc) marketingDesc.value = settings.marketingDesc || '';

    // Button texts
    const btnAccept = document.getElementById('cookie-btn-accept');
    const btnReject = document.getElementById('cookie-btn-reject');
    const btnSave = document.getElementById('cookie-btn-save');
    if (btnAccept) btnAccept.value = settings.btnAccept || 'Accepter alle';
    if (btnReject) btnReject.value = settings.btnReject || 'Kun n√∏dvendige';
    if (btnSave) btnSave.value = settings.btnSave || 'Gem mine valg';

    // Toggle settings
    const bannerActive = document.getElementById('cookie-banner-active');
    const showDetails = document.getElementById('cookie-show-details');
    if (bannerActive) bannerActive.checked = settings.bannerActive !== false;
    if (showDetails) showDetails.checked = settings.showDetails !== false;
  }
}

// Save cookie consent settings to localStorage
function saveCookieSettings() {
  const settings = {
    // Banner texts
    bannerTitle: document.getElementById('cookie-banner-title')?.value || 'Vi bruger cookies',
    bannerDesc: document.getElementById('cookie-banner-desc')?.value || '',

    // Category descriptions
    necessaryDesc: document.getElementById('cookie-necessary-desc')?.value || '',
    functionalDesc: document.getElementById('cookie-functional-desc')?.value || '',
    analyticsDesc: document.getElementById('cookie-analytics-desc')?.value || '',
    marketingDesc: document.getElementById('cookie-marketing-desc')?.value || '',

    // Button texts
    btnAccept: document.getElementById('cookie-btn-accept')?.value || 'Accepter alle',
    btnReject: document.getElementById('cookie-btn-reject')?.value || 'Kun n√∏dvendige',
    btnSave: document.getElementById('cookie-btn-save')?.value || 'Gem mine valg',

    // Toggle settings
    bannerActive: document.getElementById('cookie-banner-active')?.checked !== false,
    showDetails: document.getElementById('cookie-show-details')?.checked !== false,

    // Metadata
    lastUpdated: new Date().toISOString()
  };

  localStorage.setItem('cookieConsentSettings', JSON.stringify(settings));

  // Show success message
  const statusEl = document.getElementById('cookie-save-status');
  if (statusEl) {
    statusEl.style.display = 'inline';
    setTimeout(() => {
      statusEl.style.display = 'none';
    }, 3000);
  }

  toast('Cookie indstillinger gemt', 'success');
}

// ============================================
// LANDING PAGE CMS
// ============================================

// Default Landing Page Configuration
const defaultLandingPageConfig = {
  hero: {
    videoUrl: 'https://videos.pexels.com/video-files/5529601/5529601-uhd_1440_2732_25fps.mp4',
    headline: 'Din restaurant, din app',
    subheadline: 'OrderFlow giver dig en fuldt tilpasset mobil app og hjemmeside ‚Äì uden de h√∏je provisioner fra tredjepartsplatforme.',
    primaryButton: { text: 'Kom i gang gratis', url: '/priser.html' },
    secondaryButton: { text: 'Se hvordan det virker', url: '/how-it-works.html' }
  },
  tabs: [
    { id: 'tab1', number: '1', label: 'Online bestilling', heading: 'Online Bestilling', description: 'Modtag ordrer direkte fra din egen hjemmeside og app ‚Äì helt uden provision.', imageUrl: 'images/apple-iphone-16-pro-max-2024-medium.png', backgroundGradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
    { id: 'tab2', number: '2', label: 'Mobilapp', heading: 'Din Egen App', description: 'En branded app i din kundes lomme ‚Äì push-notifikationer, loyalitetsprogram og mere.', imageUrl: 'images/apple-iphone-16-pro-max-2024-medium.png', backgroundGradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
    { id: 'tab3', number: '3', label: 'Hjemmeside', heading: 'Smuk Hjemmeside', description: 'En moderne, mobilvenlig hjemmeside der konverterer bes√∏gende til kunder.', imageUrl: 'images/apple-iphone-16-pro-max-2024-medium.png', backgroundGradient: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' },
    { id: 'tab4', number: '4', label: 'Marketing', heading: 'Smart Marketing', description: 'Automatiserede kampagner, SMS og email marketing ‚Äì alt samlet √©t sted.', imageUrl: 'images/apple-iphone-16-pro-max-2024-medium.png', backgroundGradient: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)' }
  ],
  trusted: {
    heading: 'Betroet af 500+ restauranter i Danmark',
    cards: [
      { id: 'c1', imageUrl: 'images/restaurant1.jpg', name: 'Bella Italia', role: 'K√∏benhavn', backgroundGradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
      { id: 'c2', imageUrl: 'images/restaurant2.jpg', name: 'Sushi House', role: 'Aarhus', backgroundGradient: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' }
    ]
  },
  appleFeatures: {
    heading: 'Alt du beh√∏ver til at drive din restaurant online',
    subheading: 'Fra online bestilling til marketing automatisering ‚Äì OrderFlow samler alle dine v√¶rkt√∏jer √©t sted.',
    features: [
      { id: 'f1', badge: 'Bestilling', title: 'Direkte ordrer', description: '0% provision p√• alle ordrer' },
      { id: 'f2', badge: 'App', title: 'Branded app', description: 'Din egen app i App Store' },
      { id: 'f3', badge: 'Web', title: 'Hjemmeside', description: 'Moderne og hurtig' },
      { id: 'f4', badge: 'Marketing', title: 'Automatisering', description: 'SMS og email kampagner' },
      { id: 'f5', badge: 'Loyalty', title: 'Kundeloyalitet', description: 'Bel√∏n dine g√¶ster' },
      { id: 'f6', badge: 'Analytics', title: 'Indsigt', description: 'Data om dine kunder' }
    ]
  },
  bento: {
    heading: 'G√• i dybden med vores l√∏sninger',
    cards: [
      { id: 'b1', label: 'ONLINE BESTILLING', title: 'Modtag ordrer direkte ‚Äì uden provision', imageUrl: 'images/bento1.jpg', url: '/online-bestilling.html' },
      { id: 'b2', label: 'MOBIL APP', title: 'Din egen app til iOS og Android', imageUrl: 'images/bento2.jpg', url: '/restaurant-mobile-app.html' }
    ]
  },
  beliefs: {
    mainTitle: 'Why Flow?',
    subtitle: 'Et budskab fra vores grundl√¶gger',
    author: { imageUrl: 'images/founder.jpg', name: 'Martin Sarvio', role: 'CEO & Founder' },
    beliefs: [
      { id: 'bl1', heading: 'Ingen provisioner', text: 'Vi tror p√•, at restauranter b√∏r beholde deres fortjeneste ‚Äì ikke betale 30% til tredjeparter.' },
      { id: 'bl2', heading: 'Eget brand', text: 'Din restaurant, din app, din hjemmeside ‚Äì ikke skjult bag andres logo.' },
      { id: 'bl3', heading: 'Fuld kontrol', text: 'Du ejer dine kundedata og kan markedsf√∏re direkte til dem.' }
    ]
  },
  testimonials: [
    { id: 't1', quote: 'OrderFlow har transformeret vores online forretning. Vi sparer tusindvis hver m√•ned p√• provisioner.', avatarUrl: 'images/avatar1.jpg', name: 'Lars Jensen', role: 'Bella Italia, K√∏benhavn' },
    { id: 't2', quote: 'Vores kunder elsker appen. Push-notifikationer har √∏get vores genbestillinger med 40%.', avatarUrl: 'images/avatar2.jpg', name: 'Maria Hansen', role: 'Sushi House, Aarhus' }
  ],
  footer: {
    supportSection: { phone: '+45 70 70 70 70', email: 'support@orderflow.dk', logoUrl: 'images/logo.png' },
    bottomSection: { copyright: '¬© 2024 OrderFlow. Alle rettigheder forbeholdes.' },
    columns: [
      { id: 'col1', heading: 'Produkt', links: [{ id: 'l1', text: 'Online Bestilling', url: '/online-bestilling.html' }, { id: 'l2', text: 'Mobil App', url: '/restaurant-mobile-app.html' }] },
      { id: 'col2', heading: 'Ressourcer', links: [{ id: 'l3', text: 'Priser', url: '/priser.html' }, { id: 'l4', text: 'Kom i gang', url: '/how-it-works.html' }] }
    ]
  }
};

// Landing Page Config - loaded from localStorage or defaults
let landingPageConfig = null;

// Load Landing Page config
function loadLandingPageConfig() {
  const saved = localStorage.getItem('orderflow_landing_page');
  if (saved) {
    try {
      landingPageConfig = JSON.parse(saved);
    } catch (e) {
      console.error('Error loading landing page config:', e);
      landingPageConfig = JSON.parse(JSON.stringify(defaultLandingPageConfig));
    }
  } else {
    landingPageConfig = JSON.parse(JSON.stringify(defaultLandingPageConfig));
  }
}

// Save Landing Page config
function saveLandingPageConfig() {
  localStorage.setItem('orderflow_landing_page', JSON.stringify(landingPageConfig));

  // Show save status
  const statusIds = [
    'landing-save-status',
    'landing-tabs-save-status',
    'landing-trusted-save-status',
    'landing-features-save-status',
    'landing-bento-save-status',
    'landing-beliefs-save-status',
    'landing-testimonials-save-status',
    'landing-footer-save-status'
  ];

  statusIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.style.display = 'inline';
      setTimeout(() => { el.style.display = 'none'; }, 3000);
    }
  });

  toast('Landing Page gemt', 'success');
}

// Navigate to Landing Page CMS and switch to tab
function showLandingCMSTab(tab) {
  showPage('landing-cms');
  setTimeout(() => switchLandingCMSTab(tab), 50);
}

// Switch Landing CMS tab
function switchLandingCMSTab(tab) {
  // Load config if not loaded
  if (!landingPageConfig) loadLandingPageConfig();

  // Update tab buttons
  document.querySelectorAll('#page-landing-cms .settings-tab').forEach(btn => {
    btn.classList.remove('active');
    if (btn.textContent.toLowerCase().includes(tab.toLowerCase()) ||
        (tab === 'hero' && btn.textContent === 'Hero') ||
        (tab === 'tabs' && btn.textContent === 'Feature Tabs') ||
        (tab === 'trusted' && btn.textContent === 'Trusted By') ||
        (tab === 'features' && btn.textContent === 'Features') ||
        (tab === 'bento' && btn.textContent === 'Bento') ||
        (tab === 'beliefs' && btn.textContent === 'Beliefs') ||
        (tab === 'testimonials' && btn.textContent === 'Testimonials') ||
        (tab === 'footer' && btn.textContent === 'Footer')) {
      btn.classList.add('active');
    }
  });

  // Switch content
  document.querySelectorAll('#page-landing-cms .settings-tab-content').forEach(c => c.classList.remove('active'));
  const contentEl = document.getElementById('landing-cms-content-' + tab);
  if (contentEl) contentEl.classList.add('active');

  // Populate form fields
  populateLandingTab(tab);
}

// Populate form fields for a tab
function populateLandingTab(tab) {
  if (!landingPageConfig) loadLandingPageConfig();

  switch (tab) {
    case 'hero':
      setInputValue('landing-hero-video', landingPageConfig.hero.videoUrl);
      setInputValue('landing-hero-headline', landingPageConfig.hero.headline);
      setInputValue('landing-hero-subheadline', landingPageConfig.hero.subheadline);
      setInputValue('landing-hero-btn1-text', landingPageConfig.hero.primaryButton.text);
      setInputValue('landing-hero-btn1-url', landingPageConfig.hero.primaryButton.url);
      setInputValue('landing-hero-btn2-text', landingPageConfig.hero.secondaryButton.text);
      setInputValue('landing-hero-btn2-url', landingPageConfig.hero.secondaryButton.url);
      break;

    case 'tabs':
      renderLandingTabs();
      break;

    case 'trusted':
      setInputValue('landing-trusted-heading', landingPageConfig.trusted.heading);
      renderLandingTrustedCards();
      break;

    case 'features':
      setInputValue('landing-features-heading', landingPageConfig.appleFeatures.heading);
      setInputValue('landing-features-subheading', landingPageConfig.appleFeatures.subheading);
      renderLandingFeatureCards();
      break;

    case 'bento':
      setInputValue('landing-bento-heading', landingPageConfig.bento.heading);
      renderLandingBentoCards();
      break;

    case 'beliefs':
      setInputValue('landing-beliefs-title', landingPageConfig.beliefs.mainTitle);
      setInputValue('landing-beliefs-subtitle', landingPageConfig.beliefs.subtitle);
      setInputValue('landing-beliefs-author-name', landingPageConfig.beliefs.author.name);
      setInputValue('landing-beliefs-author-role', landingPageConfig.beliefs.author.role);
      setInputValue('landing-beliefs-author-image', landingPageConfig.beliefs.author.imageUrl);
      renderLandingBeliefs();
      break;

    case 'testimonials':
      renderLandingTestimonials();
      break;

    case 'footer':
      setInputValue('landing-footer-phone', landingPageConfig.footer.supportSection.phone);
      setInputValue('landing-footer-email', landingPageConfig.footer.supportSection.email);
      setInputValue('landing-footer-copyright', landingPageConfig.footer.bottomSection.copyright);
      renderLandingFooterColumns();
      break;
  }
}

// Helper to set input value
function setInputValue(id, value) {
  const el = document.getElementById(id);
  if (el) el.value = value || '';
}

// Update Landing Page config
function updateLandingConfig(section, path, value) {
  if (!landingPageConfig) loadLandingPageConfig();

  const parts = path.split('.');
  let obj = landingPageConfig[section];

  for (let i = 0; i < parts.length - 1; i++) {
    obj = obj[parts[i]];
  }
  obj[parts[parts.length - 1]] = value;
}

// Render Feature Tabs editor
function renderLandingTabs() {
  const container = document.getElementById('landing-tabs-container');
  if (!container) return;

  container.innerHTML = landingPageConfig.tabs.map((tab, i) => `
    <div class="setting-card" style="margin-bottom:16px">
      <div class="setting-title">Tab ${i + 1}: ${tab.label}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div class="form-group">
          <label class="form-label">Label</label>
          <input type="text" class="input" value="${tab.label}" oninput="updateLandingTab(${i}, 'label', this.value)">
        </div>
        <div class="form-group">
          <label class="form-label">Nummer</label>
          <input type="text" class="input" value="${tab.number}" oninput="updateLandingTab(${i}, 'number', this.value)">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Overskrift</label>
        <input type="text" class="input" value="${tab.heading}" oninput="updateLandingTab(${i}, 'heading', this.value)">
      </div>
      <div class="form-group">
        <label class="form-label">Beskrivelse</label>
        <textarea class="input" rows="2" oninput="updateLandingTab(${i}, 'description', this.value)">${tab.description}</textarea>
      </div>
      <div class="form-group">
        <label class="form-label">Billede URL</label>
        <input type="text" class="input" value="${tab.imageUrl}" oninput="updateLandingTab(${i}, 'imageUrl', this.value)">
      </div>
    </div>
  `).join('');
}

// Update a tab
function updateLandingTab(index, field, value) {
  if (!landingPageConfig) loadLandingPageConfig();
  landingPageConfig.tabs[index][field] = value;
}

// Render Trusted By cards
function renderLandingTrustedCards() {
  const container = document.getElementById('landing-trusted-cards-container');
  if (!container) return;

  container.innerHTML = landingPageConfig.trusted.cards.map((card, i) => `
    <div class="setting-card" style="margin-bottom:16px">
      <div class="setting-title" style="display:flex;justify-content:space-between;align-items:center">
        Kort ${i + 1}
        <button class="btn btn-danger btn-sm" onclick="removeLandingTrustedCard(${i})">Slet</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div class="form-group">
          <label class="form-label">Navn</label>
          <input type="text" class="input" value="${card.name}" oninput="updateLandingTrustedCard(${i}, 'name', this.value)">
        </div>
        <div class="form-group">
          <label class="form-label">Rolle/By</label>
          <input type="text" class="input" value="${card.role}" oninput="updateLandingTrustedCard(${i}, 'role', this.value)">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Billede URL</label>
        <input type="text" class="input" value="${card.imageUrl}" oninput="updateLandingTrustedCard(${i}, 'imageUrl', this.value)">
      </div>
    </div>
  `).join('');

  container.innerHTML += `<button class="btn btn-secondary" onclick="addLandingTrustedCard()">+ Tilf√∏j kort</button>`;
}

function updateLandingTrustedCard(index, field, value) {
  if (!landingPageConfig) loadLandingPageConfig();
  landingPageConfig.trusted.cards[index][field] = value;
}

function addLandingTrustedCard() {
  if (!landingPageConfig) loadLandingPageConfig();
  landingPageConfig.trusted.cards.push({
    id: 'c' + Date.now(),
    imageUrl: '',
    name: 'Ny restaurant',
    role: 'By',
    backgroundGradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
  });
  renderLandingTrustedCards();
}

function removeLandingTrustedCard(index) {
  if (!landingPageConfig) loadLandingPageConfig();
  landingPageConfig.trusted.cards.splice(index, 1);
  renderLandingTrustedCards();
}

// Render Feature cards
function renderLandingFeatureCards() {
  const container = document.getElementById('landing-features-cards-container');
  if (!container) return;

  container.innerHTML = landingPageConfig.appleFeatures.features.map((feat, i) => `
    <div class="setting-card" style="margin-bottom:16px">
      <div class="setting-title">Feature ${i + 1}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div class="form-group">
          <label class="form-label">Badge</label>
          <input type="text" class="input" value="${feat.badge}" oninput="updateLandingFeature(${i}, 'badge', this.value)">
        </div>
        <div class="form-group">
          <label class="form-label">Titel</label>
          <input type="text" class="input" value="${feat.title}" oninput="updateLandingFeature(${i}, 'title', this.value)">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Beskrivelse</label>
        <input type="text" class="input" value="${feat.description}" oninput="updateLandingFeature(${i}, 'description', this.value)">
      </div>
    </div>
  `).join('');
}

function updateLandingFeature(index, field, value) {
  if (!landingPageConfig) loadLandingPageConfig();
  landingPageConfig.appleFeatures.features[index][field] = value;
}

// Render Bento cards
function renderLandingBentoCards() {
  const container = document.getElementById('landing-bento-cards-container');
  if (!container) return;

  container.innerHTML = landingPageConfig.bento.cards.map((card, i) => `
    <div class="setting-card" style="margin-bottom:16px">
      <div class="setting-title">Bento Kort ${i + 1}</div>
      <div class="form-group">
        <label class="form-label">Label</label>
        <input type="text" class="input" value="${card.label}" oninput="updateLandingBento(${i}, 'label', this.value)">
      </div>
      <div class="form-group">
        <label class="form-label">Titel</label>
        <input type="text" class="input" value="${card.title}" oninput="updateLandingBento(${i}, 'title', this.value)">
      </div>
      <div class="form-group">
        <label class="form-label">Billede URL</label>
        <input type="text" class="input" value="${card.imageUrl}" oninput="updateLandingBento(${i}, 'imageUrl', this.value)">
      </div>
      <div class="form-group">
        <label class="form-label">Link URL</label>
        <input type="text" class="input" value="${card.url || ''}" oninput="updateLandingBento(${i}, 'url', this.value)">
      </div>
    </div>
  `).join('');
}

function updateLandingBento(index, field, value) {
  if (!landingPageConfig) loadLandingPageConfig();
  landingPageConfig.bento.cards[index][field] = value;
}

// Render Beliefs
function renderLandingBeliefs() {
  const container = document.getElementById('landing-beliefs-items-container');
  if (!container) return;

  container.innerHTML = landingPageConfig.beliefs.beliefs.map((belief, i) => `
    <div class="setting-card" style="margin-bottom:16px">
      <div class="setting-title">Belief ${i + 1}</div>
      <div class="form-group">
        <label class="form-label">Overskrift</label>
        <input type="text" class="input" value="${belief.heading}" oninput="updateLandingBelief(${i}, 'heading', this.value)">
      </div>
      <div class="form-group">
        <label class="form-label">Tekst</label>
        <textarea class="input" rows="2" oninput="updateLandingBelief(${i}, 'text', this.value)">${belief.text}</textarea>
      </div>
    </div>
  `).join('');
}

function updateLandingBelief(index, field, value) {
  if (!landingPageConfig) loadLandingPageConfig();
  landingPageConfig.beliefs.beliefs[index][field] = value;
}

// Render Testimonials
function renderLandingTestimonials() {
  const container = document.getElementById('landing-testimonials-container');
  if (!container) return;

  container.innerHTML = landingPageConfig.testimonials.map((test, i) => `
    <div class="setting-card" style="margin-bottom:16px">
      <div class="setting-title" style="display:flex;justify-content:space-between;align-items:center">
        Testimonial ${i + 1}
        <button class="btn btn-danger btn-sm" onclick="removeLandingTestimonial(${i})">Slet</button>
      </div>
      <div class="form-group">
        <label class="form-label">Citat</label>
        <textarea class="input" rows="3" oninput="updateLandingTestimonial(${i}, 'quote', this.value)">${test.quote}</textarea>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div class="form-group">
          <label class="form-label">Navn</label>
          <input type="text" class="input" value="${test.name}" oninput="updateLandingTestimonial(${i}, 'name', this.value)">
        </div>
        <div class="form-group">
          <label class="form-label">Rolle/Restaurant</label>
          <input type="text" class="input" value="${test.role}" oninput="updateLandingTestimonial(${i}, 'role', this.value)">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Avatar URL</label>
        <input type="text" class="input" value="${test.avatarUrl}" oninput="updateLandingTestimonial(${i}, 'avatarUrl', this.value)">
      </div>
    </div>
  `).join('');
}

function updateLandingTestimonial(index, field, value) {
  if (!landingPageConfig) loadLandingPageConfig();
  landingPageConfig.testimonials[index][field] = value;
}

function addLandingTestimonial() {
  if (!landingPageConfig) loadLandingPageConfig();
  landingPageConfig.testimonials.push({
    id: 't' + Date.now(),
    quote: 'Ny testimonial...',
    avatarUrl: '',
    name: 'Kundens navn',
    role: 'Restaurant, By'
  });
  renderLandingTestimonials();
}

function removeLandingTestimonial(index) {
  if (!landingPageConfig) loadLandingPageConfig();
  landingPageConfig.testimonials.splice(index, 1);
  renderLandingTestimonials();
}

// Render Footer columns
function renderLandingFooterColumns() {
  const container = document.getElementById('landing-footer-columns-container');
  if (!container) return;

  container.innerHTML = landingPageConfig.footer.columns.map((col, i) => `
    <div class="setting-card" style="margin-bottom:16px">
      <div class="setting-title">Kolonne ${i + 1}</div>
      <div class="form-group">
        <label class="form-label">Overskrift</label>
        <input type="text" class="input" value="${col.heading}" oninput="updateLandingFooterColumn(${i}, 'heading', this.value)">
      </div>
      <div class="form-group">
        <label class="form-label">Links (√©t pr. linje: tekst|url)</label>
        <textarea class="input" rows="4" oninput="updateLandingFooterLinks(${i}, this.value)">${col.links.map(l => l.text + '|' + l.url).join('\n')}</textarea>
      </div>
    </div>
  `).join('');
}

function updateLandingFooterColumn(index, field, value) {
  if (!landingPageConfig) loadLandingPageConfig();
  landingPageConfig.footer.columns[index][field] = value;
}

function updateLandingFooterLinks(colIndex, value) {
  if (!landingPageConfig) loadLandingPageConfig();
  const lines = value.split('\n').filter(l => l.trim());
  landingPageConfig.footer.columns[colIndex].links = lines.map((line, i) => {
    const parts = line.split('|');
    return {
      id: 'l' + Date.now() + i,
      text: parts[0] || '',
      url: parts[1] || '#'
    };
  });
}

// Open Landing Page preview
function openLandingPreview() {
  window.open('Website builder/dist/index.html', 'landingPreview', 'width=1200,height=800');
}
